<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

## 2026-01-23: Shopify Webhook Migration to Cloudflare

**Feature**: Shopify Flow webhook now writes to Cloudflare Workers (D1 + Google Sheets dual-write)

**Problem**: Google Apps Script webhook had rate limiting issues and slow cold starts

**Solution**:
- Migrated webhook from Google Apps Script to Cloudflare Workers
- Dual-write pattern: webhook writes to both D1 (SQLite) and Google Sheets for backwards compatibility
- Added secret token authentication for security
- Bag timer data now reads from D1 instead of Google Sheets (faster, no rate limits)

**Shopify Flow Changes**:
- Updated webhook URL to: `https://rogue-origin-api.roguefamilyfarms.workers.dev/api/production?action=webhook&secret=<token>`
- Flow fires to BOTH old Apps Script and new Cloudflare endpoint during transition

**Backend Changes** (`workers/src/handlers/production.js`):
- `inventoryWebhook()` - handles nested Shopify Flow JSON format
- Extracts size from `variant.weight` + `variant.weight_unit` or parses from variant title
- Writes to `inventory_adjustments` D1 table
- Secret token verification via header or query param

**D1 Data Source** (`getBagTimerData`):
- Now queries `inventory_adjustments` table in D1 instead of Google Sheets
- Faster queries, no rate limiting
- Supports blacklist for test/accidental bag scans

**Blacklist System**:
```javascript
const BLACKLISTED_BAGS = [
  // Range: accidentally scanned bags
  { start: new Date('2026-01-19T20:34:14Z'), end: new Date('2026-01-19T20:38:05Z') },
  // Exact: single test bag with 2s tolerance
  { exact: new Date('2026-01-23T19:45:35Z'), tolerance: 2000 },
];
```

**Environment Variables** (Cloudflare):
- `WEBHOOK_SECRET` - secret token for webhook authentication

**Status**: ✅ Deployed and verified (71 bags showing from D1)

---

## 2026-01-22: Pause State Sync Across Devices

**Feature**: Pause state now syncs across all scoreboards in real-time

**Problem**: When someone paused on one computer, other scoreboards didn't reflect the pause state

**Solution**:
- Backend: Added `getActivePause()` function to check pause log for active (unresumed) pauses
- Backend: Scoreboard response now includes `pause` object with state
- Frontend: Added `applyPauseState()` in timer.js to sync state from server
- Frontend: main.js calls `applyPauseState()` on every data load

**How It Works**:
1. When pause button clicked → logs to Google Sheets with pauseId
2. Backend checks pause log for rows without resume time (column D empty)
3. All scoreboards receive pause state via smart polling (5 second intervals)
4. `applyPauseState()` compares server state with local, applies if different

**Files Modified**:
- `workers/src/handlers/production.js` - `getActivePause()`, updated `scoreboard()`
- `src/js/scoreboard/timer.js` - `applyPauseState()`
- `src/js/scoreboard/main.js` - calls `applyPauseState()` in `loadData()`

**Status**: ✅ Deployed

---

## 2026-01-22: Timer Color States Simplified

**Change**: Removed 20% warning state - blue background now only for breaks/pause

**Timer Color States** (`timer.js`):
| Color | Background | Trigger |
|-------|------------|---------|
| **Green** | Dark green | Normal operation, timer running |
| **Yellow/Blue** | Animated blue | Breaks, before/after hours, manual pause |
| **Red** | Pulsing red | Overtime (past target cycle time) |
| **Neutral** | Default | No data/inactive |

**Removed**: Previously turned yellow/blue when <20% of target time remained (warning state)

**File**: `src/js/scoreboard/timer.js:328-334`

**Status**: ✅ Deployed

---

## 2026-01-20: Morning Report Enhancement

**Feature**: Morning report now includes all required data fields, weekdays only (Mon-Fri)

**Problem**: Report showed "0 crew", bags as "--", weekly data as "No weekly data available"

**Backend Changes** (`workers/src/handlers/production.js`):
- Added `isWeekday()` - PST timezone-aware weekday check (Mon-Fri)
- Added `getBagDataForDays()` - gets bag counts and cycle times for last 2 weekdays
- Added `getWeekData()` - aggregates weekly data (tops, smalls, avgRate, avgCrew, day names)
- Added `getCurrentOrderProgress()` - looks up current in-progress order
- Added `EEE` date format support for short weekday names (Mon, Tue, etc.)
- Crew count estimated from trimmer hours (trimmerHours / 7.5)
- **Weekend filtering**: All data filters out Sat/Sun (Mon-Fri schedule only)

**Data Now Returned**:
- `yesterday`: date, tops, smalls, rate, crew, bags, avgCycleTime, bestHour
- `dayBefore`: date, tops, smalls, rate, crew, bags, avgCycleTime
- `thisWeek`: tops, smalls, avgRate, avgCrew, days, daysCount
- `lastWeek`: tops, smalls, avgRate, avgCrew, days, daysCount
- `currentOrder`: id, customer, strain, targetKg, completedKg

**Status**: ✅ Deployed and verified

---

## 2026-01-20: "On Pace" Display

**Feature**: Shows "On pace" instead of "0 lbs of target" when exactly on target

**Problem**: When hitting target (3.4/3.4), displayed "0 lbs of target" - not meaningful

**Fix** (`render.js`, `i18n.js`):
- Added i18n translations: `onPace: 'On pace'` (EN), `onPace: 'Al ritmo'` (ES)
- Updated render.js to check if delta is within ±0.05 lbs
- When on pace: displays "On pace" in gold color

**Status**: ✅ Deployed and verified

---

## 2026-01-20: Break-Adjusted Cycle Times

**Feature**: Cycle times now subtract break periods for accurate working time

**Problem**: Bag #3 showed 117 min cycle time, but 30 min was lunch break. Actual work time was 87 min.

**Breaks Subtracted** (PST):
- 9:00 AM - 10 min morning break
- 12:00 PM - 30 min lunch
- 2:30 PM - 10 min afternoon break
- 4:20 PM - 10 min cleanup

**Backend Fix** (`workers/src/handlers/production.js`):
- Added `BREAKS` constant with break schedule
- Added `getBreakMinutesInWindow()` function
- Timezone-aware: breaks defined in PST, converted properly for UTC comparison
- Applied to `avgSecondsToday` and `cycleHistory` calculations

**Results**:
- Bag #3: 117→87 min (lunch subtracted)
- Bag #1: 90→80 min (9am break subtracted)
- Avg: 99→86 min
- All bags now show as "early" instead of "late"

**Status**: ✅ Deployed and verified

---

## 2026-01-20: Smart Polling Implementation

**Feature**: Scoreboard only fetches full data when backend data changes (reduces API calls ~90%)

**How It Works**:
- `main.js` polls `?action=version` every 5 seconds (tiny ~50 byte response)
- `api.js` tracks `lastKnownVersion` and compares with server version
- Full data fetch only triggers when version number changes
- Version increments on: webhook, logBag, logPause, logResume, setShiftStart

**Files Modified**:
- `api.js` - Added `checkVersion()` function with version tracking
- `main.js` - Changed `loadData()` polling to `checkForUpdates()` smart polling

**Backend** (workers/src/handlers/production.js):
- New D1 table: `data_version`
- New endpoint: `?action=version`
- `incrementDataVersion()` called on all data-changing actions

**Intervals**:
- Version check: 5 seconds
- Order queue: 30 seconds (separate backend, changes rarely)

**Status**: ✅ Deployed and verified working

---

## 2026-01-13: Timer Freeze Bug Fix

**Issue**: Bag timer counting backwards/incrementing during lunch breaks instead of freezing

**Root Cause**:
- When `debugOnBreak=true`, code in `timer.js:81` was skipping ALL scheduled break subtractions
- This caused elapsed time calculation to include break time that should be excluded
- Result: Timer appeared to increment during breaks

**Fix Applied**:
- Removed condition `if (!State || State.debugOnBreak !== true)` that was skipping break subtraction
- Changed to always subtract scheduled breaks, regardless of debug mode
- Debug break mode now only freezes `endTime` at break start, doesn't skip historical break calculations

**Files Modified**:
- `timer.js:79-100` - Always subtract completed breaks
- `state.js:368-380` - `testBreakMode()` helper function for testing

**Testing**:
```javascript
// Browser console command to test break freeze
testBreakMode(true);  // Freezes timer, turns yellow
testBreakMode(false); // Resumes timer
```

**Verification**:
- Diagnostic test confirms timer freezes correctly (39:50 → 39:50 over 6 seconds)
- Break start timestamp is cached and doesn't change during break
- Timer resumes normally when break ends

**Status**: ✅ Deployed and verified working

</claude-mem-context>