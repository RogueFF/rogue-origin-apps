<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

## 2026-01-20: Morning Report Enhancement

**Feature**: Morning report now includes all required data fields

**Problem**: Report showed "0 crew", bags as "--", weekly data as "No weekly data available"

**Backend Changes** (`workers/src/handlers/production.js`):
- Added `getBagDataForDays()` - gets bag counts and cycle times for yesterday/day before
- Added `getWeekData()` - aggregates weekly data (tops, smalls, avgRate, avgCrew, day names)
- Added `getCurrentOrderProgress()` - looks up current in-progress order
- Added `EEE` date format support for short weekday names (Mon, Tue, etc.)
- Crew count estimated from trimmer hours (trimmerHours / 7.5)

**Data Now Returned**:
- `yesterday`: date, tops, smalls, rate, crew, bags, avgCycleTime, bestHour
- `dayBefore`: date, tops, smalls, rate, crew, bags, avgCycleTime
- `thisWeek`: tops, smalls, avgRate, avgCrew, days, daysCount
- `lastWeek`: tops, smalls, avgRate, avgCrew, days, daysCount
- `currentOrder`: id, customer, strain, targetKg, completedKg

**Status**: ✅ Deployed and verified

---

## 2026-01-20: "On Pace" Display

**Feature**: Shows "On pace" instead of "0 lbs of target" when exactly on target

**Problem**: When hitting target (3.4/3.4), displayed "0 lbs of target" - not meaningful

**Fix** (`render.js`, `i18n.js`):
- Added i18n translations: `onPace: 'On pace'` (EN), `onPace: 'Al ritmo'` (ES)
- Updated render.js to check if delta is within ±0.05 lbs
- When on pace: displays "On pace" in gold color

**Status**: ✅ Deployed and verified

---

## 2026-01-20: Break-Adjusted Cycle Times

**Feature**: Cycle times now subtract break periods for accurate working time

**Problem**: Bag #3 showed 117 min cycle time, but 30 min was lunch break. Actual work time was 87 min.

**Breaks Subtracted** (PST):
- 9:00 AM - 10 min morning break
- 12:00 PM - 30 min lunch
- 2:30 PM - 10 min afternoon break
- 4:20 PM - 10 min cleanup

**Backend Fix** (`workers/src/handlers/production.js`):
- Added `BREAKS` constant with break schedule
- Added `getBreakMinutesInWindow()` function
- Timezone-aware: breaks defined in PST, converted properly for UTC comparison
- Applied to `avgSecondsToday` and `cycleHistory` calculations

**Results**:
- Bag #3: 117→87 min (lunch subtracted)
- Bag #1: 90→80 min (9am break subtracted)
- Avg: 99→86 min
- All bags now show as "early" instead of "late"

**Status**: ✅ Deployed and verified

---

## 2026-01-20: Smart Polling Implementation

**Feature**: Scoreboard only fetches full data when backend data changes (reduces API calls ~90%)

**How It Works**:
- `main.js` polls `?action=version` every 5 seconds (tiny ~50 byte response)
- `api.js` tracks `lastKnownVersion` and compares with server version
- Full data fetch only triggers when version number changes
- Version increments on: webhook, logBag, logPause, logResume, setShiftStart

**Files Modified**:
- `api.js` - Added `checkVersion()` function with version tracking
- `main.js` - Changed `loadData()` polling to `checkForUpdates()` smart polling

**Backend** (workers/src/handlers/production.js):
- New D1 table: `data_version`
- New endpoint: `?action=version`
- `incrementDataVersion()` called on all data-changing actions

**Intervals**:
- Version check: 5 seconds
- Order queue: 30 seconds (separate backend, changes rarely)

**Status**: ✅ Deployed and verified working

---

## 2026-01-13: Timer Freeze Bug Fix

**Issue**: Bag timer counting backwards/incrementing during lunch breaks instead of freezing

**Root Cause**:
- When `debugOnBreak=true`, code in `timer.js:81` was skipping ALL scheduled break subtractions
- This caused elapsed time calculation to include break time that should be excluded
- Result: Timer appeared to increment during breaks

**Fix Applied**:
- Removed condition `if (!State || State.debugOnBreak !== true)` that was skipping break subtraction
- Changed to always subtract scheduled breaks, regardless of debug mode
- Debug break mode now only freezes `endTime` at break start, doesn't skip historical break calculations

**Files Modified**:
- `timer.js:79-100` - Always subtract completed breaks
- `state.js:368-380` - `testBreakMode()` helper function for testing

**Testing**:
```javascript
// Browser console command to test break freeze
testBreakMode(true);  // Freezes timer, turns yellow
testBreakMode(false); // Resumes timer
```

**Verification**:
- Diagnostic test confirms timer freezes correctly (39:50 → 39:50 over 6 seconds)
- Break start timestamp is cached and doesn't change during break
- Timer resumes normally when break ends

**Status**: ✅ Deployed and verified working

</claude-mem-context>