<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="icon" type="image/png" href="/rogue-origin-apps/favicon.png">
  <link rel="manifest" href="/rogue-origin-apps/manifest.json">
  <meta name="theme-color" content="#668971">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RO Ops">
  <link rel="apple-touch-icon" href="/rogue-origin-apps/assets/icon-apple-touch.png">
  <title>Production Scoreboard</title>

  <!-- Performance: Resource Hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://script.google.com">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;600;700;900&display=optional" rel="stylesheet">

  <!-- Scripts: Lazy loaded by modules when needed -->
  <!-- Chart.js and Phosphor Icons are loaded on-demand by lazy-loader.js -->

  <!-- Scoreboard Modules -->
  <script defer src="../js/scoreboard/config.js?v=2"></script>
  <script defer src="../js/scoreboard/state.js?v=2"></script>
  <script defer src="../js/scoreboard/dom.js?v=2"></script>
  <script defer src="../js/scoreboard/i18n.js?v=3"></script>
  <script defer src="../js/scoreboard/api.js?v=3"></script>
  <script defer src="../js/scoreboard/timer.js?v=10"></script>
  <script defer src="../js/scoreboard/cycle-history.js?v=3"></script>
  <script defer src="../js/scoreboard/chart.js?v=2"></script>
  <script defer src="../js/scoreboard/render.js?v=3"></script>
  <script defer src="../js/scoreboard/shift-start.js?v=2"></script>
  <script defer src="../js/scoreboard/morning-report.js?v=3"></script>
  <script defer src="../js/scoreboard/scale.js?v=3"></script>
  <!-- Debug module: Lazy-loaded on demand (saves ~5KB) - see bottom of page -->
  <script defer src="../js/scoreboard/events.js?v=1"></script>
  <script defer src="../js/scoreboard/main.js?v=8"></script>
  <!-- Critical CSS: Loaded synchronously -->
  <link rel="stylesheet" href="../css/shared-base.css">
  
  <!-- Non-critical CSS: Deferred for faster initial render -->
  <link rel="preload" href="../css/scoreboard.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="../css/scoreboard.css"></noscript>
</head>
<body class="idle timer-neutral">
  <a href="#main-panel" class="skip-link">Skip to main content</a>
  <!-- Morning Report View -->
  <div id="morningReportContainer">
    <div class="mr-header">
      <div>
        <div class="mr-title">MORNING REPORT / REPORTE MATUTINO</div>
        <div class="mr-subtitle" id="mrDate">Loading...</div>
      </div>
      <button class="mr-back-btn">
        <i class="ph-duotone ph-arrow-left"></i>
        Back to Live / Volver en Vivo
      </button>
    </div>
    <div id="morningReportContent"></div>
  </div>

  <!-- Historical Date Banner (shows when viewing past data) -->
  <div id="historicalDateBanner" class="historical-date-banner" style="display:none;">
    <div class="historical-banner-content">
      <i class="ph-duotone ph-calendar-blank"></i>
      <span class="historical-banner-label">Viewing Historical Data:</span>
      <span id="historicalDateDisplay" class="historical-banner-date">â€”</span>
    </div>
    <button class="historical-banner-close" title="Back to live view">
      <i class="ph-duotone ph-x"></i>
      Back to Live
    </button>
  </div>

  <div class="strain-display">
    <div class="strain-label" id="strainLabel">Line 1 â€¢ Current Strain</div>
    <div class="strain-name" id="strainName">â€”</div>
    <div class="strain-rate-indicator" id="strainRateIndicator"></div>
  </div>

  <div class="time-display">
    <div class="time" id="clock">--:--</div>
    <div class="date" id="date">Loading...</div>
  </div>

  <!-- Time Controls (positioned below time-display) -->
  <div class="time-controls">
    <!-- Start Day Button (appears until shift start is set) -->
    <button id="startDayBtn" class="start-day-btn pulse-green" style="display:none;">
      <i class="ph-duotone ph-play-circle"></i>
      Start Day
    </button>
    <!-- Started Badge (appears after shift start is set) -->
    <div id="startedBadge" class="started-badge" style="display:none;">
      <i class="ph-duotone ph-clock"></i>
      Started: <span id="startTimeDisplay">â€”</span>
      <i id="badgeIcon" class="ph-duotone ph-pencil-simple"></i>
    </div>
  </div>

  <!-- Date Picker Input (hidden) -->
  <input type="date" id="historicalDatePicker" class="date-picker-hidden" aria-label="Select historical date to view past production data">
  <!-- Morning Report Button -->
  <button id="morningReportBtn">
    <i class="ph-duotone ph-chart-bar"></i>
    Morning Report / Reporte Matutino
  </button>

  <!-- Historical View Button -->
  <button id="historicalViewBtn" class="historical-view-btn">
    <i class="ph-duotone ph-clock-counter-clockwise"></i>
    Past Data
  </button>

  <!-- Order Queue Toggle Button -->
  <button id="orderQueueToggleBtn" class="order-queue-toggle-btn" title="Toggle Order Queue / Alternar Cola de Pedidos">
    <i class="ph-duotone ph-stack"></i>
    <span id="orderQueueToggleText">Orders</span>
  </button>

  <div class="lang-toggle">
    <button class="lang-btn active" id="btnEn">EN</button>
    <button class="lang-btn" id="btnEs">ES</button>
    <a href="https://docs.google.com/spreadsheets/d/1SyeueGF5NY3AXvUJYLTjuK01v3jCPIpbs9JQbrhrlHk/edit?gid=0#gid=0" target="_blank" class="lang-btn complaints-btn" title="Customer Complaints / Quejas de Clientes">
      <i class="ph-duotone ph-warning-circle"></i>
    </a>
  </div>
  <button class="help-btn">?</button>

  <div class="help-modal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="help-content">
      <div class="help-header">
        <div class="help-title" id="helpTitle"><i class="ph-duotone ph-chart-pie-slice" style="margin-right:8px"></i> Understanding the Scoreboard</div>
        <button class="help-close">âœ•</button>
      </div>
      <div class="help-grid">
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-package" style="margin-right:6px"></i> Last Hour (Completed)</div>
          <div class="help-item-desc" id="helpLastHour">Production from the last completed hour. Target adjusts for breaks.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-timer" style="margin-right:6px"></i> Current Hour</div>
          <div class="help-item-desc" id="helpCurrentHour">Current crew count and target for the hour in progress.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-trend-up" style="margin-right:6px"></i> Today's Progress</div>
          <div class="help-item-desc" id="helpToday">Total so far vs target. "Up 5.2" = 5.2 lbs ahead of target.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">ğŸ”® End of Day</div>
          <div class="help-item-desc" id="helpProjection">Projected final output if you maintain current pace.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">ğŸ¯ Target Rate</div>
          <div class="help-item-desc" id="helpTarget">Expected lbs/trimmer/hr based on this strain's 30-day history.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">â² Bag Timer</div>
          <div class="help-item-desc" id="helpTimer">Time since last 5kg bag. Tracks pace between completions.</div>
        </div>
      </div>
      <div class="help-colors">
        <div class="help-color"><div class="help-dot green"></div><span id="helpGreen">Green = Ahead (105%+)</span></div>
        <div class="help-color"><div class="help-dot yellow"></div><span id="helpYellow">Yellow = On Target (90-105%)</span></div>
        <div class="help-color"><div class="help-dot red"></div><span id="helpRed">Red = Behind (&lt;90%)</span></div>
      </div>
    </div>
  </div>
  
  <div id="main-panel" class="main-panel">
    <div class="scoreboard">
      <div class="status-badge">
        <span class="status-icon" id="statusIcon"><i class="ph-duotone ph-pause"></i></span>
        <span id="statusText">WAITING</span>
      </div>
      <div class="hour-cards">
        <div class="hour-card last-hour">
          <div class="hour-card-header" id="lastHourHeader">Last Hour</div>
          <div class="hour-card-timeslot" id="lastHourTimeslot">â€”</div>
          <div class="lbs-row">
            <span class="actual-lbs" id="lastHourLbs">â€”</span>
            <span class="separator">/</span>
            <span class="target-lbs" id="lastHourTarget">â€”</span>
          </div>
          <div class="lbs-unit" id="lbsUnit">lbs</div>
          <div class="percentage-display">
            <div class="percentage-value" id="lastHourPct">â€”%</div>
            <div class="percentage-label" id="ofTargetLabel">of target</div>
          </div>
        </div>
        <div class="hour-card current-hour" id="currentHourCard" style="display:none;">
          <div class="hour-card-header" id="currentHourHeader"><i class="ph-duotone ph-timer" style="margin-right:6px"></i> Current Hour</div>
          <div class="hour-card-timeslot" id="currentHourTimeslot">â€”</div>
          <div class="lbs-row">
            <span class="actual-lbs" id="currentHourTrimmers">â€”</span>
            <span class="lbs-unit" style="font-size:18px;margin-left:10px" id="trimmersSmallLabel">trimmers</span>
          </div>
          <div class="percentage-display">
            <div class="percentage-value" id="currentHourTargetLbs">â€”</div>
            <div class="percentage-label" id="lbsTargetLabel">lbs target</div>
          </div>
        </div>
      </div>
      
      <div class="daily-progress">
        <div class="daily-header" id="dailyHeader">Line 1 Today</div>
        <div class="daily-numbers">
          <span class="daily-actual" id="dailyActual">â€”</span>
          <span class="daily-sep">/</span>
          <span class="daily-target" id="dailyTarget">â€”</span>
          <span class="daily-unit">lbs</span>
          <span class="daily-delta" id="dailyDelta">â€”</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <span class="progress-hours" id="progressHours">0 hrs</span>
        </div>
        <div class="daily-projection">
          <span class="projection-label" id="projectionLabel">End of day:</span>
          <span class="projection-value" id="projectionValue">â€”</span>
          <span class="projection-goal" id="projectionGoal"></span>
          <span class="projection-delta" id="projectionDelta">â€”</span>
        </div>
      </div>

      <!-- Order Queue Section -->
      <div class="order-queue-section" id="orderQueueSection" style="display:none;">
        <!-- Current Order Pill -->
        <div class="order-pill" id="currentOrderPill">
          <div class="order-pill-header">
            <span class="order-icon">ğŸ¯</span>
            <span class="order-label" id="currentOrderLabel">WORKING ON</span>
            <span class="order-summary" id="currentOrderSummary">â€”</span>
            <span class="expand-icon">â–¼</span>
          </div>
          <div class="order-progress-bar-container" id="currentProgressBarContainer" style="display:none;">
            <div class="order-progress-bar">
              <div class="order-progress-fill" id="currentProgressFill" style="width:0%"></div>
            </div>
            <span class="order-progress-text" id="currentProgressText">0 / 0 kg</span>
          </div>

          <!-- Expanded Content (hidden by default) -->
          <div class="order-detail" id="currentOrderDetail"></div>
        </div>

        <!-- Next Order Pill -->
        <div class="order-pill next" id="nextOrderPill">
          <div class="order-pill-header">
            <span class="order-icon">â­</span>
            <span class="order-label" id="nextOrderLabel">UP NEXT</span>
            <span class="order-summary" id="nextOrderSummary">â€”</span>
            <span class="expand-icon">â–¼</span>
          </div>

          <!-- Expanded Content (hidden by default) -->
          <div class="order-detail" id="nextOrderDetail"></div>
        </div>
      </div>

      <div class="comparisons">
        <div class="comparison-pill" id="vsYesterdayPill" style="display:none"><span class="comparison-label" id="vsYesterdayLabel">vs Yesterday</span><span class="comparison-value" id="vsYesterdayValue">â€”</span></div>
        <div class="comparison-pill" id="vs7DayPill" style="display:none"><span class="comparison-label" id="vs7DayLabel">vs 7-Day Avg</span><span class="comparison-value" id="vs7DayValue">â€”</span></div>
        <div class="comparison-pill streak-pill" id="streakPill" style="display:none"><span class="streak-icon"><i class="ph-duotone ph-fire"></i></span><span class="streak-value" id="streakValue">0</span><span class="comparison-label" id="streakLabel">hr streak</span></div>
      </div>
      <div class="info-bar">
        <div class="info-section"><span class="info-icon"><i class="ph-duotone ph-users-three"></i></span><span><span id="crewCount">â€”</span> <span id="trimmersLabel">Trimmers</span></span></div>
        <div class="info-divider"></div>
        <div class="info-section"><span class="info-icon"><i class="ph-duotone ph-crosshair"></i></span><span><span id="targetRateLabel">Target:</span> <span id="targetRate">â€”</span> lbs/hr</span></div>
        <div class="info-divider" id="avgBestDivider"></div>
        <div id="avgBestContainer" class="avg-best-container">
          <div class="stat-group" id="avgGroup"><span class="label" id="avgTargetLabel">AVG</span><span class="value" id="avgPercentage">â€”</span></div>
          <div class="info-divider" id="bestDivider"></div>
          <div class="stat-group" id="bestGroup"><span class="label" id="bestHourLabel">BEST</span><span class="value" id="bestHour">â€”</span></div>
        </div>
        <button class="avg-best-toggle" id="avgBestToggle" title="Toggle AVG/BEST">
          <i class="ph-duotone ph-chart-bar"></i>
        </button>
      </div>
      
      <!-- Hourly Rate Chart - Bottom -->
      <div class="chart-container" id="chartContainer" style="display:none;">
        <div class="chart-header" id="chartHeader">Hourly Performance (lbs/trimmer)</div>
        <div class="chart-wrapper">
          <canvas id="hourlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="timer-panel neutral" id="timerPanel">
    <div class="drag-handle" id="dragHandle"></div>
    <div class="expand-hint" id="expandHint">â—€</div>
    <button class="fullscreen-toggle" id="fullscreenToggle"><i class="ph-duotone ph-arrows-out"></i></button>

    <!-- Scale Weight Display (circular ring like timer) - ABOVE bag timer -->
    <div class="scale-section" id="scaleSection">
      <div class="scale-header" id="scaleHeader">Live Scale</div>
      <div class="scale-display" id="scaleDisplay">
        <svg class="scale-ring" viewBox="0 0 220 220">
          <circle class="scale-ring-bg" cx="110" cy="110" r="95"/>
          <circle class="scale-ring-progress" id="scaleRing" cx="110" cy="110" r="95" stroke-dasharray="597" stroke-dashoffset="597"/>
        </svg>
        <div class="scale-center">
          <div class="scale-value" id="scaleWeight">â€”</div>
          <div class="scale-label" id="scaleWeightLabel">of 5.0 kg</div>
        </div>
        <div class="scale-status-dot" id="scaleStatusDot"></div>
      </div>
    </div>

    <div class="timer-header" id="timerHeader">5KG Bag Timer</div>
    <div class="timer-display" id="timerDisplay">
      <svg class="timer-ring" viewBox="0 0 220 220">
        <circle class="timer-ring-bg" cx="110" cy="110" r="95"/>
        <circle class="timer-ring-progress green" id="timerRing" cx="110" cy="110" r="95" stroke-dasharray="597" stroke-dashoffset="0"/>
      </svg>
      <div class="timer-center">
        <div class="timer-value green" id="timerValue">--:--</div>
        <div class="timer-label" id="timerLabel">remaining</div>
      </div>
    </div>
    <div class="timer-target">Target: <span id="timerTargetTime">--:--</span> â€¢ <span id="timerTrimmers">0</span> trimmers</div>
    <div class="timer-btn-row">
      <button class="manual-btn" id="manualBtn"><span class="icon"><i class="ph-duotone ph-package"></i></span><span id="manualBtnText">5KG Bag Complete</span></button>
      <button class="pause-btn" id="pauseBtn"><i class="ph-duotone ph-pause"></i></button>
    </div>
    <div class="timer-stats">
      <div class="timer-stat"><span class="timer-stat-label" id="bagsTodayLabel">Bags Today</span><span class="timer-stat-value" id="bagsToday">0</span></div>
      <div class="timer-stat"><span class="timer-stat-label" id="avgTodayLabel">Avg Today</span><span class="timer-stat-value" id="avgToday">--:--</span></div>
      <div class="timer-stat"><span class="timer-stat-label" id="vsTargetLabel">vs Target</span><span class="timer-stat-value" id="vsTarget">â€”</span></div>
    </div>

    <div class="cycle-history" id="cycleHistory">
      <div class="cycle-history-header">
        <span class="cycle-history-title" id="cycleHistoryTitle">Today's Cycles</span>
        <div class="cycle-history-nav">
          <button class="cycle-nav-btn" title="Previous view">â€¹</button>
          <span class="cycle-mode-label" id="cycleModeLabel">List</span>
          <button class="cycle-nav-btn" title="Next view">â€º</button>
          <button class="cycle-history-toggle" id="cycleToggle">Hide</button>
        </div>
      </div>
      <div class="cycle-content" id="cycleContent"></div>
    </div>
  </div>
  
  <!-- Celebration container -->
  <div class="celebration" id="celebration"></div>
  
  <!-- Pause Modal -->
  <div class="pause-modal-overlay" id="pauseModal">
    <div class="pause-modal">
      <div class="pause-modal-title"><i class="ph-duotone ph-pause-circle"></i> Pause Timer</div>
      <div class="pause-modal-subtitle">Select or enter the reason for pausing:</div>
      <div class="pause-modal-reasons">
        <button class="pause-reason-btn">ğŸ”§ Equipment issue</button>
        <button class="pause-reason-btn">ğŸ“¦ Material shortage</button>
        <button class="pause-reason-btn">ğŸ” Quality check</button>
        <button class="pause-reason-btn">ğŸ‘¥ Shift change</button>
        <button class="pause-reason-btn">ğŸ§¹ Cleaning</button>
      </div>
      <input type="text" class="pause-custom-input" id="pauseCustomReason" placeholder="Or type a custom reason...">
      <div class="pause-modal-buttons">
        <button class="pause-modal-btn cancel">Cancel</button>
        <button class="pause-modal-btn confirm" id="pauseConfirmBtn" disabled>Pause Timer</button>
      </div>
    </div>
  </div>
  
  <!-- Pause Banner -->
  <div class="pause-banner" id="pauseBanner">
    <i class="ph-duotone ph-pause-circle" style="font-size:24px;"></i>
    <span>PAUSED</span>
    <span class="pause-banner-time" id="pauseTime">0:00</span>
    <span class="pause-banner-reason" id="pauseReasonDisplay">â€”</span>
  </div>

  <!-- Debug Panel -->
  <div class="debug-indicator" id="debugIndicator">âš  Debug Mode Active</div>
  <div class="debug-panel" id="debugPanel">
    <div class="debug-header">ğŸ›  Timer Debug <button class="debug-close">âœ•</button></div>
    <div class="debug-controls">
      <div class="debug-label">Timer State:</div>
      <div class="debug-buttons">
        <button>ğŸŸ¢ Green</button>
        <button>ğŸŸ¡ Yellow</button>
        <button>ğŸ”´ Red/Overtime</button>
        <button>âš« Neutral</button>
      </div>
      <div class="debug-label">Simulate Time:</div>
      <div class="debug-buttons">
        <button>Just Started</button>
        <button>50%</button>
        <button>85% (Yellow)</button>
        <button>110% (Overtime)</button>
      </div>
      <div class="debug-label">Break Status:</div>
      <div class="debug-buttons">
        <button>Working</button>
        <button>On Break</button>
      </div>
      <div class="debug-label">Test Celebration:</div>
      <div class="debug-buttons">
        <button>ğŸº Early (Mariachi!)</button>
        <button>âœ“ On Time</button>
        <button>âš  Overtime</button>
        <button style="background:rgba(34,197,94,0.3);border-color:#22c55e;">ğŸ”Š Test Sound</button>
      </div>
      <div class="debug-divider"></div>
      <button class="debug-reset">â†» Reset to Live</button>
    </div>
    <div class="debug-hint">Press <kbd>D</kbd> to toggle this panel</div>
  </div>

  <!-- Start Day Modal -->
  <div id="startDayModal" class="modal-overlay" style="display:none;">
    <div class="modal-content start-day-modal">
      <h3 class="modal-title">
        <i class="ph-duotone ph-play-circle"></i>
        Set Shift Start Time
      </h3>
      <p class="modal-subtitle">What time did production begin today?</p>

      <div class="time-input-wrapper">
        <label for="startTimeInput">Start Time:</label>
        <input type="time" id="startTimeInput" class="time-input" />
      </div>

      <div class="impact-preview" id="impactPreview">
        <i class="ph-duotone ph-info"></i>
        <div class="impact-text">
          This will adjust daily goal by <span id="goalReduction">â€”</span>
          <div class="impact-details">
            <span id="originalGoal">200</span> lbs â†’ <span id="adjustedGoalPreview">â€”</span> lbs
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary">Cancel</button>
        <button class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>
  <script src="../js/sw-register.js" async></script>

  <!-- Debug Module: Lazy-loaded on first use (saves ~5KB on normal page loads) -->
  <script>
    (function() {
      let debugLoaded = false;
      let debugLoadPromise = null;

      // Lazy load debug module when 'D' key is pressed
      document.addEventListener('keydown', function(e) {
        if (e.key === 'd' || e.key === 'D') {
          // Don't trigger if typing in input field
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
          }

          // Lazy-load debug module on first use
          if (!debugLoaded && !debugLoadPromise) {
            console.log('[Debug] Loading debug module...');
            debugLoadPromise = new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = '../js/scoreboard/debug.js?v=2';
              script.onload = () => {
                debugLoaded = true;
                console.log('[Debug] Module loaded successfully');
                resolve();
                // Trigger toggleDebug after load
                if (window.toggleDebug) {
                  window.toggleDebug();
                }
              };
              script.onerror = () => {
                debugLoadPromise = null; // Allow retry
                reject(new Error('Failed to load debug.js'));
                console.error('[Debug] Failed to load debug module');
              };
              document.head.appendChild(script);
            });
          } else if (debugLoaded && window.toggleDebug) {
            // Module already loaded, just toggle
            window.toggleDebug();
          }
        }
      });
    })();
  </script>
</body>
</html>
