<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="icon" type="image/png" href="/rogue-origin-apps/favicon.png">
  <link rel="manifest" href="/rogue-origin-apps/manifest.json">
  <meta name="theme-color" content="#668971">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RO Ops">
  <link rel="apple-touch-icon" href="/rogue-origin-apps/assets/icon-apple-touch.png">
  <title>Production Scoreboard</title>

  <!-- Performance: Resource Hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://script.google.com">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;600;700;900&display=optional" rel="stylesheet">

  <!-- Scripts: Deferred for faster initial render -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script defer src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Scoreboard Modules -->
  <script defer src="../js/scoreboard/config.js?v=2"></script>
  <script defer src="../js/scoreboard/state.js?v=2"></script>
  <script defer src="../js/scoreboard/dom.js?v=2"></script>
  <script defer src="../js/scoreboard/i18n.js?v=3"></script>
  <script defer src="../js/scoreboard/api.js?v=3"></script>
  <script defer src="../js/scoreboard/timer.js?v=7"></script>
  <script defer src="../js/scoreboard/cycle-history.js?v=3"></script>
  <script defer src="../js/scoreboard/chart.js?v=2"></script>
  <script defer src="../js/scoreboard/render.js?v=3"></script>
  <script defer src="../js/scoreboard/shift-start.js?v=2"></script>
  <script defer src="../js/scoreboard/morning-report.js?v=3"></script>
  <script defer src="../js/scoreboard/scale.js?v=3"></script>
  <script defer src="../js/scoreboard/main.js?v=7"></script>
  <!-- Performance: CSS Preloading -->
  <link rel="stylesheet" href="../css/shared-base.css">
  <link rel="preload" href="../css/scoreboard.css" as="style">
  <link rel="stylesheet" href="../css/scoreboard.css">
</head>
<body class="idle timer-neutral">
  <!-- Morning Report View -->
  <div id="morningReportContainer">
    <div class="mr-header">
      <div>
        <div class="mr-title">MORNING REPORT / REPORTE MATUTINO</div>
        <div class="mr-subtitle" id="mrDate">Loading...</div>
      </div>
      <button class="mr-back-btn" onclick="toggleMorningReport()">
        <i class="ph-duotone ph-arrow-left"></i>
        Back to Live / Volver en Vivo
      </button>
    </div>
    <div id="morningReportContent"></div>
  </div>

  <div class="strain-display">
    <div class="strain-label" id="strainLabel">Line 1 ‚Ä¢ Current Strain</div>
    <div class="strain-name" id="strainName">‚Äî</div>
    <div class="strain-rate-indicator" id="strainRateIndicator"></div>
  </div>
  <div class="time-display">
    <div class="time" id="clock">--:--</div>
    <div class="date" id="date">Loading...</div>
    <!-- Start Day Button (appears until shift start is set) -->
    <button id="startDayBtn" class="start-day-btn pulse-green" onclick="startDayNow()" style="display:none;">
      <i class="ph-duotone ph-play-circle"></i>
      Start Day
    </button>
    <!-- Started Badge (appears after shift start is set) -->
    <div id="startedBadge" class="started-badge" onclick="editStartTime()" style="display:none;">
      <i class="ph-duotone ph-clock"></i>
      Started: <span id="startTimeDisplay">‚Äî</span>
      <i id="badgeIcon" class="ph-duotone ph-pencil-simple"></i>
    </div>
  </div>
  <!-- Morning Report Button -->
  <button id="morningReportBtn" onclick="toggleMorningReport()">
    <i class="ph-duotone ph-chart-bar"></i>
    Morning Report / Reporte Matutino
  </button>

  <div class="lang-toggle">
    <button class="lang-btn active" id="btnEn" onclick="setLanguage('en')">EN</button>
    <button class="lang-btn" id="btnEs" onclick="setLanguage('es')">ES</button>
    <a href="https://docs.google.com/spreadsheets/d/1SyeueGF5NY3AXvUJYLTjuK01v3jCPIpbs9JQbrhrlHk/edit?gid=0#gid=0" target="_blank" class="lang-btn complaints-btn" title="Customer Complaints / Quejas de Clientes">
      <i class="ph-duotone ph-warning-circle"></i>
    </a>
  </div>
  <button class="help-btn" onclick="toggleHelp()">?</button>

  <div class="help-modal" id="helpModal" onclick="if(event.target===this)toggleHelp()">
    <div class="help-content">
      <div class="help-header">
        <div class="help-title" id="helpTitle"><i class="ph-duotone ph-chart-pie-slice" style="margin-right:8px"></i> Understanding the Scoreboard</div>
        <button class="help-close" onclick="toggleHelp()">‚úï</button>
      </div>
      <div class="help-grid">
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-package" style="margin-right:6px"></i> Last Hour (Completed)</div>
          <div class="help-item-desc" id="helpLastHour">Production from the last completed hour. Target adjusts for breaks.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-timer" style="margin-right:6px"></i> Current Hour</div>
          <div class="help-item-desc" id="helpCurrentHour">Current crew count and target for the hour in progress.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-trend-up" style="margin-right:6px"></i> Today's Progress</div>
          <div class="help-item-desc" id="helpToday">Total so far vs target. "Up 5.2" = 5.2 lbs ahead of target.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">üîÆ End of Day</div>
          <div class="help-item-desc" id="helpProjection">Projected final output if you maintain current pace.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">üéØ Target Rate</div>
          <div class="help-item-desc" id="helpTarget">Expected lbs/trimmer/hr based on this strain's 30-day history.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">‚è≤ Bag Timer</div>
          <div class="help-item-desc" id="helpTimer">Time since last 5kg bag. Tracks pace between completions.</div>
        </div>
      </div>
      <div class="help-colors">
        <div class="help-color"><div class="help-dot green"></div><span id="helpGreen">Green = Ahead (105%+)</span></div>
        <div class="help-color"><div class="help-dot yellow"></div><span id="helpYellow">Yellow = On Target (90-105%)</span></div>
        <div class="help-color"><div class="help-dot red"></div><span id="helpRed">Red = Behind (&lt;90%)</span></div>
      </div>
    </div>
  </div>
  
  <div class="main-panel">
    <div class="scoreboard">
      <div class="status-badge">
        <span class="status-icon" id="statusIcon"><i class="ph-duotone ph-pause"></i></span>
        <span id="statusText">WAITING</span>
      </div>
      <div class="hour-cards">
        <div class="hour-card last-hour">
          <div class="hour-card-header" id="lastHourHeader">Last Hour</div>
          <div class="hour-card-timeslot" id="lastHourTimeslot">‚Äî</div>
          <div class="lbs-row">
            <span class="actual-lbs" id="lastHourLbs">‚Äî</span>
            <span class="separator">/</span>
            <span class="target-lbs" id="lastHourTarget">‚Äî</span>
          </div>
          <div class="lbs-unit" id="lbsUnit">lbs</div>
          <div class="percentage-display">
            <div class="percentage-value" id="lastHourPct">‚Äî%</div>
            <div class="percentage-label" id="ofTargetLabel">of target</div>
          </div>
        </div>
        <div class="hour-card current-hour" id="currentHourCard" style="display:none;">
          <div class="hour-card-header" id="currentHourHeader"><i class="ph-duotone ph-timer" style="margin-right:6px"></i> Current Hour</div>
          <div class="hour-card-timeslot" id="currentHourTimeslot">‚Äî</div>
          <div class="lbs-row">
            <span class="actual-lbs" id="currentHourTrimmers">‚Äî</span>
            <span class="lbs-unit" style="font-size:18px;margin-left:10px" id="trimmersSmallLabel">trimmers</span>
          </div>
          <div class="percentage-display">
            <div class="percentage-value" id="currentHourTargetLbs">‚Äî</div>
            <div class="percentage-label" id="lbsTargetLabel">lbs target</div>
          </div>
        </div>
      </div>
      
      <div class="daily-progress">
        <div class="daily-header" id="dailyHeader">Line 1 Today</div>
        <div class="daily-numbers">
          <span class="daily-actual" id="dailyActual">‚Äî</span>
          <span class="daily-sep">/</span>
          <span class="daily-target" id="dailyTarget">‚Äî</span>
          <span class="daily-unit">lbs</span>
          <span class="daily-delta" id="dailyDelta">‚Äî</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <span class="progress-hours" id="progressHours">0 hrs</span>
        </div>
        <div class="daily-projection">
          <span class="projection-label" id="projectionLabel">End of day:</span>
          <span class="projection-value" id="projectionValue">‚Äî</span>
          <span class="projection-goal" id="projectionGoal"></span>
          <span class="projection-delta" id="projectionDelta">‚Äî</span>
        </div>
      </div>

      <!-- Order Queue Section -->
      <div class="order-queue-section" id="orderQueueSection" style="display:none;">
        <!-- Current Order Pill -->
        <div class="order-pill" id="currentOrderPill" onclick="window.ScoreboardRender && window.ScoreboardRender.toggleOrderExpand('current')">
          <div class="order-pill-header">
            <span class="order-icon">üéØ</span>
            <span class="order-label" id="currentOrderLabel">WORKING ON</span>
            <span class="order-summary" id="currentOrderSummary">‚Äî</span>
            <span class="expand-icon">‚ñº</span>
          </div>
          <div class="order-progress-bar-container" id="currentProgressBarContainer" style="display:none;">
            <div class="order-progress-bar">
              <div class="order-progress-fill" id="currentProgressFill" style="width:0%"></div>
            </div>
            <span class="order-progress-text" id="currentProgressText">0 / 0 kg</span>
          </div>

          <!-- Expanded Content (hidden by default) -->
          <div class="order-detail" id="currentOrderDetail"></div>
        </div>

        <!-- Next Order Pill -->
        <div class="order-pill next" id="nextOrderPill" onclick="window.ScoreboardRender && window.ScoreboardRender.toggleOrderExpand('next')">
          <div class="order-pill-header">
            <span class="order-icon">‚è≠</span>
            <span class="order-label" id="nextOrderLabel">UP NEXT</span>
            <span class="order-summary" id="nextOrderSummary">‚Äî</span>
            <span class="expand-icon">‚ñº</span>
          </div>

          <!-- Expanded Content (hidden by default) -->
          <div class="order-detail" id="nextOrderDetail"></div>
        </div>
      </div>

      <div class="comparisons">
        <div class="comparison-pill" id="vsYesterdayPill" style="display:none"><span class="comparison-label" id="vsYesterdayLabel">vs Yesterday</span><span class="comparison-value" id="vsYesterdayValue">‚Äî</span></div>
        <div class="comparison-pill" id="vs7DayPill" style="display:none"><span class="comparison-label" id="vs7DayLabel">vs 7-Day Avg</span><span class="comparison-value" id="vs7DayValue">‚Äî</span></div>
        <div class="comparison-pill streak-pill" id="streakPill" style="display:none"><span class="streak-icon"><i class="ph-duotone ph-fire"></i></span><span class="streak-value" id="streakValue">0</span><span class="comparison-label" id="streakLabel">hr streak</span></div>
      </div>
      <div class="info-bar">
        <div class="info-section"><span class="info-icon"><i class="ph-duotone ph-users-three"></i></span><span><span id="crewCount">‚Äî</span> <span id="trimmersLabel">Trimmers</span></span></div>
        <div class="info-divider"></div>
        <div class="info-section"><span class="info-icon"><i class="ph-duotone ph-crosshair"></i></span><span><span id="targetRateLabel">Target:</span> <span id="targetRate">‚Äî</span> lbs/hr</span></div>
        <div class="info-divider" id="avgBestDivider"></div>
        <div id="avgBestContainer" class="avg-best-container" onclick="toggleAvgBest()">
          <div class="stat-group" id="avgGroup"><span class="label" id="avgTargetLabel">AVG</span><span class="value" id="avgPercentage">‚Äî</span></div>
          <div class="info-divider" id="bestDivider"></div>
          <div class="stat-group" id="bestGroup"><span class="label" id="bestHourLabel">BEST</span><span class="value" id="bestHour">‚Äî</span></div>
        </div>
        <button class="avg-best-toggle" id="avgBestToggle" onclick="toggleAvgBest()" title="Toggle AVG/BEST">
          <i class="ph-duotone ph-chart-bar"></i>
        </button>
      </div>
      
      <!-- Hourly Rate Chart - Bottom -->
      <div class="chart-container" id="chartContainer" style="display:none;">
        <div class="chart-header" id="chartHeader">Hourly Performance (lbs/trimmer)</div>
        <div class="chart-wrapper">
          <canvas id="hourlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="timer-panel neutral" id="timerPanel">
    <div class="drag-handle" id="dragHandle"></div>
    <div class="expand-hint" id="expandHint">‚óÄ</div>
    <button class="fullscreen-toggle" id="fullscreenToggle" onclick="toggleTimerFullscreen()"><i class="ph-duotone ph-arrows-out"></i></button>

    <!-- Scale Weight Display (circular ring like timer) - ABOVE bag timer -->
    <div class="scale-section" id="scaleSection">
      <div class="scale-header" id="scaleHeader">Live Scale</div>
      <div class="scale-display" id="scaleDisplay">
        <svg class="scale-ring" viewBox="0 0 220 220">
          <circle class="scale-ring-bg" cx="110" cy="110" r="95"/>
          <circle class="scale-ring-progress" id="scaleRing" cx="110" cy="110" r="95" stroke-dasharray="597" stroke-dashoffset="597"/>
        </svg>
        <div class="scale-center">
          <div class="scale-value" id="scaleWeight">‚Äî</div>
          <div class="scale-label" id="scaleWeightLabel">of 5.0 kg</div>
        </div>
        <div class="scale-status-dot" id="scaleStatusDot"></div>
      </div>
    </div>

    <div class="timer-header" id="timerHeader">5KG Bag Timer</div>
    <div class="timer-display" id="timerDisplay">
      <svg class="timer-ring" viewBox="0 0 220 220">
        <circle class="timer-ring-bg" cx="110" cy="110" r="95"/>
        <circle class="timer-ring-progress green" id="timerRing" cx="110" cy="110" r="95" stroke-dasharray="597" stroke-dashoffset="0"/>
      </svg>
      <div class="timer-center">
        <div class="timer-value green" id="timerValue">--:--</div>
        <div class="timer-label" id="timerLabel">remaining</div>
      </div>
    </div>
    <div class="timer-target">Target: <span id="timerTargetTime">--:--</span> ‚Ä¢ <span id="timerTrimmers">0</span> trimmers</div>
    <div class="timer-btn-row">
      <button class="manual-btn" id="manualBtn" onclick="logManualEntry()"><span class="icon"><i class="ph-duotone ph-package"></i></span><span id="manualBtnText">5KG Bag Complete</span></button>
      <button class="pause-btn" id="pauseBtn" onclick="handlePauseClick()"><i class="ph-duotone ph-pause"></i></button>
    </div>
    <div class="timer-stats">
      <div class="timer-stat"><span class="timer-stat-label" id="bagsTodayLabel">Bags Today</span><span class="timer-stat-value" id="bagsToday">0</span></div>
      <div class="timer-stat"><span class="timer-stat-label" id="avgTodayLabel">Avg Today</span><span class="timer-stat-value" id="avgToday">--:--</span></div>
      <div class="timer-stat"><span class="timer-stat-label" id="vsTargetLabel">vs Target</span><span class="timer-stat-value" id="vsTarget">‚Äî</span></div>
    </div>

    <div class="cycle-history" id="cycleHistory">
      <div class="cycle-history-header">
        <span class="cycle-history-title" id="cycleHistoryTitle">Today's Cycles</span>
        <div class="cycle-history-nav">
          <button class="cycle-nav-btn" onclick="prevCycleMode()" title="Previous view">‚Äπ</button>
          <span class="cycle-mode-label" id="cycleModeLabel">List</span>
          <button class="cycle-nav-btn" onclick="nextCycleMode()" title="Next view">‚Ä∫</button>
          <button class="cycle-history-toggle" id="cycleToggle" onclick="toggleCycleHistory()">Hide</button>
        </div>
      </div>
      <div class="cycle-content" id="cycleContent"></div>
    </div>
  </div>
  
  <!-- Celebration container -->
  <div class="celebration" id="celebration"></div>
  
  <!-- Pause Modal -->
  <div class="pause-modal-overlay" id="pauseModal">
    <div class="pause-modal">
      <div class="pause-modal-title"><i class="ph-duotone ph-pause-circle"></i> Pause Timer</div>
      <div class="pause-modal-subtitle">Select or enter the reason for pausing:</div>
      <div class="pause-modal-reasons">
        <button class="pause-reason-btn" onclick="selectPauseReason(this, 'Equipment issue')">üîß Equipment issue</button>
        <button class="pause-reason-btn" onclick="selectPauseReason(this, 'Material shortage')">üì¶ Material shortage</button>
        <button class="pause-reason-btn" onclick="selectPauseReason(this, 'Quality check')">üîç Quality check</button>
        <button class="pause-reason-btn" onclick="selectPauseReason(this, 'Shift change')">üë• Shift change</button>
        <button class="pause-reason-btn" onclick="selectPauseReason(this, 'Cleaning')">üßπ Cleaning</button>
      </div>
      <input type="text" class="pause-custom-input" id="pauseCustomReason" placeholder="Or type a custom reason..." oninput="onCustomReasonInput()">
      <div class="pause-modal-buttons">
        <button class="pause-modal-btn cancel" onclick="closePauseModal()">Cancel</button>
        <button class="pause-modal-btn confirm" id="pauseConfirmBtn" onclick="confirmPause()" disabled>Pause Timer</button>
      </div>
    </div>
  </div>
  
  <!-- Pause Banner -->
  <div class="pause-banner" id="pauseBanner">
    <i class="ph-duotone ph-pause-circle" style="font-size:24px;"></i>
    <span>PAUSED</span>
    <span class="pause-banner-time" id="pauseTime">0:00</span>
    <span class="pause-banner-reason" id="pauseReasonDisplay">‚Äî</span>
  </div>

  <!-- Debug Panel -->
  <div class="debug-indicator" id="debugIndicator">‚ö† Debug Mode Active</div>
  <div class="debug-panel" id="debugPanel">
    <div class="debug-header">üõ† Timer Debug <button class="debug-close" onclick="toggleDebug()">‚úï</button></div>
    <div class="debug-controls">
      <div class="debug-label">Timer State:</div>
      <div class="debug-buttons">
        <button onclick="setDebugState('green')">üü¢ Green</button>
        <button onclick="setDebugState('yellow')">üü° Yellow</button>
        <button onclick="setDebugState('red')">üî¥ Red/Overtime</button>
        <button onclick="setDebugState('neutral')">‚ö´ Neutral</button>
      </div>
      <div class="debug-label">Simulate Time:</div>
      <div class="debug-buttons">
        <button onclick="simulateTime(0)">Just Started</button>
        <button onclick="simulateTime(50)">50%</button>
        <button onclick="simulateTime(85)">85% (Yellow)</button>
        <button onclick="simulateTime(110)">110% (Overtime)</button>
      </div>
      <div class="debug-label">Break Status:</div>
      <div class="debug-buttons">
        <button onclick="simulateBreak(false)">Working</button>
        <button onclick="simulateBreak(true)">On Break</button>
      </div>
      <div class="debug-label">Test Celebration:</div>
      <div class="debug-buttons">
        <button onclick="addCycleToHistory(240, 300)">üé∫ Early (Mariachi!)</button>
        <button onclick="addCycleToHistory(295, 300)">‚úì On Time</button>
        <button onclick="addCycleToHistory(360, 300)">‚ö† Overtime</button>
        <button onclick="playMariachi()" style="background:rgba(34,197,94,0.3);border-color:#22c55e;">üîä Test Sound</button>
      </div>
      <div class="debug-divider"></div>
      <button class="debug-reset" onclick="resetDebug()">‚Üª Reset to Live</button>
    </div>
    <div class="debug-hint">Press <kbd>D</kbd> to toggle this panel</div>
  </div>

  <script>
    let data=null,timerData=null,currentLang='en',lastBagTimestamp=null,hourlyChart=null;

    // Interval registry for cleanup (prevents memory leaks on long-running displays)
    var intervalRegistry = [];
    function registerInterval(fn, delay) {
      var id = setInterval(fn, delay);
      intervalRegistry.push(id);
      return id;
    }
    window.addEventListener('beforeunload', function() {
      intervalRegistry.forEach(function(id) { clearInterval(id); });
      intervalRegistry = [];
    });

    // Toast notification system
    function showToast(message, type, duration) {
      type = type || 'info';
      duration = duration || 4000;
      var container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(function() {
        toast.classList.add('hiding');
        setTimeout(function() { toast.remove(); }, 300);
      }, duration);
    }

    // Pause state
    let isPaused = false;
    let pauseStartTime = null;
    let pauseReason = '';
    let pauseId = null;
    let pauseInterval = null;
    
    // Debug mode variables
    let debugMode = false;
    let debugState = null;
    let debugElapsedPercent = null;
    let debugOnBreak = null;
    
    // Cycle history
    let cycleHistory = [];
    let cycleHistoryCollapsed = false;
    let cycleDisplayMode = 0; // 0=donut, 1=sparkline, 2=chips, 3=cards, 4=list
    // Use config for cycle modes (cycleModes available from ScoreboardConfig after load)
    var cycleModes = (window.ScoreboardConfig && ScoreboardConfig.cycleModes) || ['Donut', 'Bars', 'Grid', 'Cards', 'List'];
    
    // Load cycle mode preference
    function loadCycleMode() {
      try {
        const saved = localStorage.getItem('cycleDisplayMode');
        if (saved !== null) cycleDisplayMode = parseInt(saved) || 0;
      } catch(e) {}
    }
    loadCycleMode();
    
    function saveCycleMode() {
      try { localStorage.setItem('cycleDisplayMode', cycleDisplayMode); } catch(e) {}
    }
    
    function nextCycleMode() {
      cycleDisplayMode = (cycleDisplayMode + 1) % cycleModes.length;
      saveCycleMode();
      renderCycleHistory();
    }
    
    function prevCycleMode() {
      cycleDisplayMode = (cycleDisplayMode - 1 + cycleModes.length) % cycleModes.length;
      saveCycleMode();
      renderCycleHistory();
    }
    
    // Load cycle history from localStorage
    function loadLocalCycleHistory() {
      try {
        const saved = localStorage.getItem('cycleHistory');
        const savedDate = localStorage.getItem('cycleHistoryDate');
        const savedVersion = localStorage.getItem('cycleHistoryVersion');
        const today = new Date().toDateString();
        const currentVersion = '2'; // Increment when data format changes
        
        // Only load if saved today AND version matches
        if (saved && savedDate === today && savedVersion === currentVersion) {
          const parsed = JSON.parse(saved);
          // Restore Date objects from ISO strings
          cycleHistory = parsed.map(c => ({
            ...c,
            timestamp: c.timestamp ? new Date(c.timestamp) : null
          }));
        } else {
          // Clear old/incompatible data
          localStorage.removeItem('cycleHistory');
          localStorage.removeItem('cycleHistoryDate');
          localStorage.removeItem('cycleHistoryVersion');
        }
      } catch(e) { console.log('Could not load cycle history'); }
    }
    
    // Save cycle history to localStorage
    function saveLocalCycleHistory() {
      try {
        localStorage.setItem('cycleHistory', JSON.stringify(cycleHistory));
        localStorage.setItem('cycleHistoryDate', new Date().toDateString());
        localStorage.setItem('cycleHistoryVersion', '2');
      } catch(e) { console.log('Could not save cycle history'); }
    }
    
    // Load on startup
    loadLocalCycleHistory();
    initAvgBestVisibility();

    // Sound effects using Web Audio API
    let audioContext = null;

    // Sounds disabled - no audio playback
    function playSuccessSound(isEarly) {
      // Audio functionality removed
      return;
    }
    
    // Audio functionality removed - all sound functions disabled
    function playMariachi() { return; }
    function playChime() { return; }
    function playChimeSynth() { return; }
    function playMariachiSynth() { return; }
    function playTrumpetNote() { return; }
    
    function toggleCycleHistory() {
      cycleHistoryCollapsed = !cycleHistoryCollapsed;
      const content = document.getElementById('cycleContent');
      const toggle = document.getElementById('cycleToggle');
      content.classList.toggle('collapsed', cycleHistoryCollapsed);
      toggle.textContent = cycleHistoryCollapsed ? 'Show' : 'Hide';
    }

    // Toggle AVG/BEST KPIs visibility
    window.toggleAvgBest = function() {
      const container = document.getElementById('avgBestContainer');
      const divider = document.getElementById('avgBestDivider');
      const isHidden = container.classList.toggle('hidden');
      if (divider) divider.classList.toggle('hidden', isHidden);
      try { localStorage.setItem('hideAvgBest', isHidden ? 'true' : 'false'); } catch(e) {}
    };

    // Initialize AVG/BEST visibility from localStorage
    function initAvgBestVisibility() {
      const hideAvgBest = localStorage.getItem('hideAvgBest') === 'true';
      if (hideAvgBest) {
        const container = document.getElementById('avgBestContainer');
        const divider = document.getElementById('avgBestDivider');
        if (container) container.classList.add('hidden');
        if (divider) divider.classList.add('hidden');
      }
    }

    function addCycleToHistory(cycleTimeSec, targetSec) {
      const delta = targetSec - cycleTimeSec;
      const deltaSec = Math.abs(delta);
      let status = 'on-time';
      if (delta > 10) status = 'early';
      else if (delta < -10) status = 'overtime';
      
      cycleHistory.unshift({
        num: cycleHistory.length + 1,
        time: cycleTimeSec,
        target: targetSec,
        delta: delta,
        status: status,
        timestamp: new Date()
      });
      
      saveLocalCycleHistory(); // Persist to localStorage
      renderCycleHistory();
      
      // Trigger celebration if early or on-time
      if (status === 'early' || status === 'on-time') {
        triggerCelebration(status === 'early');
      }
    }
    
    function renderCycleHistory() {
      const container = document.getElementById('cycleContent');
      const modeLabel = document.getElementById('cycleModeLabel');
      const bagsFromAPI = (timerData && timerData.bagsToday) || 0;
      
      if (modeLabel) modeLabel.textContent = cycleModes[cycleDisplayMode];
      
      // If we have no cycle history but API shows bags completed, show summary
      if (cycleHistory.length === 0 && bagsFromAPI > 0) {
        const avgSec = (timerData && timerData.avgSecondsToday) || 0;
        const targetSec = (timerData && timerData.targetSeconds) || 300;
        const delta = targetSec - avgSec;
        const status = delta > 10 ? 'early' : delta < -10 ? 'overtime' : 'on-time';
        
        container.innerHTML = `<div class="cycle-item ${status}" style="justify-content:center;gap:20px;">
          <span style="color:rgba(255,255,255,0.7);">${bagsFromAPI} bags completed today</span>
          <span class="cycle-item-delta ${status}">avg ${formatTime(avgSec)}</span>
        </div>
        <div style="text-align:center;color:rgba(255,255,255,0.4);padding:8px;font-size:11px;">Individual times shown as bags are completed</div>`;
        return;
      }
      
      if (cycleHistory.length === 0) {
        container.innerHTML = `<div style="text-align:center;color:rgba(255,255,255,0.4);padding:10px;font-size:12px;">${t[currentLang].noBags}</div>`;
        return;
      }
      
      // Render based on current mode
      switch(cycleDisplayMode) {
        case 0: renderCycleDonut(container); break;
        case 1: renderCycleSparkline(container); break;
        case 2: renderCycleChips(container); break;
        case 3: renderCycleCards(container); break;
        case 4: renderCycleList(container); break;
        default: renderCycleDonut(container);
      }
    }
    
    // Mode 0: Donut Summary
    function renderCycleDonut(container) {
      const early = cycleHistory.filter(c => c.status === 'early').length;
      const ontime = cycleHistory.filter(c => c.status === 'on-time').length;
      const late = cycleHistory.filter(c => c.status === 'overtime').length;
      const total = cycleHistory.length;
      const latest = cycleHistory.slice(0, 3);
      
      container.innerHTML = `
        <div class="cycle-donut">
          <div class="cycle-donut-ring">
            <canvas id="donutCanvas" width="90" height="90"></canvas>
            <div class="cycle-donut-center">
              <span class="cycle-donut-count">${total}</span>
              <span class="cycle-donut-label">bags</span>
            </div>
          </div>
          <div class="cycle-donut-stats">
            <div class="cycle-donut-stat">
              <span class="cycle-donut-stat-label"><span class="cycle-donut-stat-dot" style="background:#22c55e"></span> Early</span>
              <span class="cycle-donut-stat-value" style="color:#4ade80">${early}</span>
            </div>
            <div class="cycle-donut-stat">
              <span class="cycle-donut-stat-label"><span class="cycle-donut-stat-dot" style="background:#facc15"></span> On Time</span>
              <span class="cycle-donut-stat-value" style="color:#fde047">${ontime}</span>
            </div>
            <div class="cycle-donut-stat">
              <span class="cycle-donut-stat-label"><span class="cycle-donut-stat-dot" style="background:#ef4444"></span> Late</span>
              <span class="cycle-donut-stat-value" style="color:#f87171">${late}</span>
            </div>
          </div>
        </div>
        ${latest.length > 0 ? `
        <div class="cycle-donut-latest">
          <div class="cycle-donut-latest-label">Latest</div>
          <div class="cycle-donut-latest-items">
            ${latest.map((c, i) => {
              const trimmersLabel = c.trimmers ? `${c.trimmers}T` : '';
              let timeStr = '';
              if (c.timestamp) {
                try {
                  const ts = c.timestamp instanceof Date ? c.timestamp : new Date(c.timestamp);
                  if (!isNaN(ts.getTime())) {
                    timeStr = ts.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                  }
                } catch(e) {}
              }
              const targetStr = (c.target && c.target > 0) ? formatTime(c.target) : '';
              return `
              <div class="cycle-donut-latest-item" style="background:${c.status === 'early' ? 'rgba(34,197,94,0.2)' : c.status === 'overtime' ? 'rgba(239,68,68,0.2)' : 'rgba(250,204,21,0.2)'}">
                <div class="cycle-donut-latest-time" style="color:${c.status === 'early' ? '#4ade80' : c.status === 'overtime' ? '#f87171' : '#fde047'}">${formatTime(c.time)}</div>
                <div class="cycle-donut-latest-num">#${total - i} ${trimmersLabel ? `<span style="opacity:0.5">${trimmersLabel}</span>` : ''}</div>
                ${(timeStr || targetStr) ? `<div style="font-size:9px;color:rgba(255,255,255,0.4);margin-top:2px;">${timeStr}${targetStr ? ` ‚Ä¢ ${targetStr}` : ''}</div>` : ''}
              </div>
            `}).join('')}
          </div>
        </div>
        ` : ''}
      `;
      
      // Draw donut
      const canvas = document.getElementById('donutCanvas');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        const centerX = 45, centerY = 45, radius = 38, lineWidth = 12;
        ctx.clearRect(0, 0, 90, 90);
        
        // Draw segments
        let startAngle = -Math.PI / 2;
        const segments = [
          { count: early, color: '#22c55e' },
          { count: ontime, color: '#facc15' },
          { count: late, color: '#ef4444' }
        ];
        
        segments.forEach(seg => {
          if (seg.count > 0) {
            const sliceAngle = (seg.count / total) * 2 * Math.PI;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.strokeStyle = seg.color;
            ctx.lineWidth = lineWidth;
            ctx.stroke();
            startAngle += sliceAngle;
          }
        });
      }
    }
    
    // Mode 1: Sparkline Bars with per-bag target markers
    function renderCycleSparkline(container) {
      const reversed = [...cycleHistory].reverse();
      const maxTime = Math.max(...reversed.map(c => Math.max(c.time, c.target || 0)), 300);
      
      container.innerHTML = `
        <div class="cycle-sparkline">
          <div class="cycle-sparkline-bars">
            ${reversed.map((c, i) => {
              const height = (c.time / maxTime) * 100;
              const targetHeight = ((c.target || 300) / maxTime) * 100;
              const trimmersLabel = c.trimmers ? `${c.trimmers}T` : '';
              const targetLabel = (c.target && c.target > 0) ? formatTime(c.target) : '';
              let timeStr = '';
              if (c.timestamp) {
                try {
                  const ts = c.timestamp instanceof Date ? c.timestamp : new Date(c.timestamp);
                  if (!isNaN(ts.getTime())) {
                    timeStr = ts.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                  }
                } catch(e) {}
              }
              return `<div class="cycle-sparkline-bar ${c.status}" style="height:${height}%" title="#${i+1}: ${formatTime(c.time)}">
                <div class="cycle-sparkline-tooltip">
                  <div style="font-weight:700">#${i+1}: ${formatTime(c.time)}</div>
                  ${(timeStr || trimmersLabel) ? `<div style="opacity:0.7;font-size:10px;">${timeStr}${trimmersLabel ? ` ‚Ä¢ ${trimmersLabel}` : ''}</div>` : ''}
                  ${targetLabel ? `<div style="opacity:0.7;font-size:10px;">Target: ${targetLabel}</div>` : ''}
                </div>
                <div style="position:absolute;bottom:${targetHeight}%;left:-2px;right:-2px;height:2px;background:rgba(255,255,255,0.5);border-radius:1px;"></div>
              </div>`;
            }).join('')}
          </div>
          <div class="cycle-sparkline-labels">
            <span>Oldest</span>
            <span style="color:rgba(255,255,255,0.6)">‚Äî = target (varies by crew)</span>
            <span>Latest</span>
          </div>
        </div>
      `; 
    }
    
    // Mode 2: Color Chips Grid
    function renderCycleChips(container) {
      const reversed = [...cycleHistory].reverse();
      
      container.innerHTML = `
        <div class="cycle-chips">
          ${reversed.map((c, i) => {
            const trimmersLabel = c.trimmers ? `${c.trimmers}T` : '';
            const targetLabel = (c.target && c.target > 0) ? formatTime(c.target) : '';
            let timeStr = '';
            if (c.timestamp) {
              try {
                const ts = c.timestamp instanceof Date ? c.timestamp : new Date(c.timestamp);
                if (!isNaN(ts.getTime())) {
                  timeStr = ts.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                }
              } catch(e) {}
            }
            return `
            <div class="cycle-chip ${c.status}">
              ${i + 1}
              <div class="cycle-chip-tooltip">
                <div style="font-weight:700">${formatTime(c.time)}</div>
                <div style="opacity:0.7">${c.status === 'early' ? '‚úì early' : c.status === 'overtime' ? '‚úó late' : '‚Ä¢ on time'}</div>
                ${(timeStr || trimmersLabel) ? `<div style="opacity:0.6;font-size:10px;margin-top:2px;">${timeStr}${trimmersLabel ? ` ‚Ä¢ ${trimmersLabel}` : ''}</div>` : ''}
                ${targetLabel ? `<div style="opacity:0.6;font-size:10px;">Target: ${targetLabel}</div>` : ''}
              </div>
            </div>
          `}).join('')}
        </div>
        <div class="cycle-chips-legend">
          <div class="cycle-chips-legend-item"><span class="cycle-chips-legend-dot" style="background:#22c55e"></span> Early</div>
          <div class="cycle-chips-legend-item"><span class="cycle-chips-legend-dot" style="background:#facc15"></span> On Time</div>
          <div class="cycle-chips-legend-item"><span class="cycle-chips-legend-dot" style="background:#ef4444"></span> Late</div>
        </div>
      `;
    }
    
    // Mode 3: Horizontal Scroll Cards
    function renderCycleCards(container) {
      container.innerHTML = `
        <div class="cycle-cards">
          ${cycleHistory.map((c, i) => {
            const deltaSec = Math.abs(c.delta);
            const deltaStr = formatTime(deltaSec);
            const sign = c.delta > 10 ? '‚Üë' : c.delta < -10 ? '‚Üì' : '‚Ä¢';
            const trimmersLabel = c.trimmers ? `${c.trimmers}T` : '';
            // Handle timestamp - could be Date object or string
            let timeStr = '';
            if (c.timestamp) {
              try {
                const ts = c.timestamp instanceof Date ? c.timestamp : new Date(c.timestamp);
                if (!isNaN(ts.getTime())) {
                  timeStr = ts.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
                }
              } catch(e) {}
            }
            const targetStr = (c.target && c.target > 0) ? formatTime(c.target) : '';
            return `<div class="cycle-card ${c.status}">
              <div class="cycle-card-num">#${cycleHistory.length - i} ${trimmersLabel ? `<span style="opacity:0.5">${trimmersLabel}</span>` : ''}</div>
              <div class="cycle-card-time">${formatTime(c.time)}</div>
              <div class="cycle-card-delta">${sign}${deltaStr}</div>
              ${timeStr ? `<div class="cycle-card-meta">${timeStr}</div>` : ''}
              ${targetStr ? `<div class="cycle-card-meta">tgt ${targetStr}</div>` : ''}
            </div>`;
          }).join('')}
        </div>
      `;
    }
    
    // Mode 4: List (original) - now shows trimmers, timestamp, target
    function renderCycleList(container) {
      container.innerHTML = `<div class="cycle-list">
        ${cycleHistory.map((c, i) => {
          const deltaSec = Math.abs(c.delta);
          const deltaMin = Math.floor(deltaSec / 60);
          const deltaSecs = deltaSec % 60;
          const deltaStr = deltaMin > 0 ? `${deltaMin}:${deltaSecs.toString().padStart(2,'0')}` : `${deltaSecs}s`;
          const sign = c.delta > 10 ? '-' : c.delta < -10 ? '+' : '¬±';
          const label = c.delta > 10 ? (currentLang === 'es' ? 'antes' : 'early') : c.delta < -10 ? (currentLang === 'es' ? 'tarde' : 'late') : '';
          const trimmersInfo = c.trimmers ? `${c.trimmers}T` : '';
          // Handle timestamp
          let timeStr = '';
          if (c.timestamp) {
            try {
              const ts = c.timestamp instanceof Date ? c.timestamp : new Date(c.timestamp);
              if (!isNaN(ts.getTime())) {
                timeStr = ts.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
              }
            } catch(e) {}
          }
          const targetStr = (c.target && c.target > 0) ? formatTime(c.target) : '';
          
          return `<div class="cycle-item ${c.status}">
            <span class="cycle-item-num">#${cycleHistory.length - i}</span>
            ${timeStr ? `<span style="color:rgba(255,255,255,0.5);font-size:11px;min-width:55px;">${timeStr}</span>` : ''}
            <span class="cycle-item-time">${formatTime(c.time)}</span>
            <span style="color:rgba(255,255,255,0.4);font-size:10px;">${targetStr ? `/${targetStr}` : ''}${trimmersInfo ? ` ${trimmersInfo}` : ''}</span>
            <span class="cycle-item-delta ${c.status}">${sign}${deltaStr} ${label}</span>
          </div>`;
        }).join('')}
      </div>`;
    }
    
    function triggerCelebration(isEarly) {
      // Play sound
      playSuccessSound(isEarly);
      
      // Show celebration text
      const text = document.createElement('div');
      text.className = 'celebration-text';
      text.textContent = isEarly ? 'üé∫ ¬°ARRIBA!' : '‚úì ON TIME!';
      text.style.color = isEarly ? '#4ade80' : '#fde047';
      if (isEarly) text.style.fontSize = '64px';
      document.body.appendChild(text);
      setTimeout(() => text.remove(), 3000);
      
      // Create confetti - more for early finish!
      const celebration = document.getElementById('celebration');
      const colors = isEarly ? ['#22c55e', '#4ade80', '#86efac', '#fde047', '#ef4444', '#ffffff'] : ['#facc15', '#fde047', '#fef08a', '#22c55e'];
      const confettiCount = isEarly ? 100 : 50;
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.width = (Math.random() * 10 + 5) + 'px';
        confetti.style.height = (Math.random() * 10 + 5) + 'px';
        confetti.style.animation = `confettiFall ${Math.random() * 2 + 1.5}s ease-out forwards`;
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        celebration.appendChild(confetti);
      }
      
      // Clean up confetti
      setTimeout(() => {
        celebration.innerHTML = '';
      }, 4000);
    }
    
    function toggleDebug() {
      const panel = document.getElementById('debugPanel');
      panel.classList.toggle('active');
    }
    
    function setDebugState(state) {
      debugMode = true;
      debugState = state;
      debugElapsedPercent = null;
      document.body.classList.add('debug-active');
      renderTimer();
    }
    
    function simulateTime(percent) {
      debugMode = true;
      debugState = null;
      debugElapsedPercent = percent;
      document.body.classList.add('debug-active');
      renderTimer();
    }
    
    function simulateBreak(onBreak) {
      debugMode = true;
      debugOnBreak = onBreak;
      document.body.classList.add('debug-active');
      renderTimer();
    }
    
    function resetDebug() {
      debugMode = false;
      debugState = null;
      debugElapsedPercent = null;
      debugOnBreak = null;
      cycleHistory = [];
      try {
        localStorage.removeItem('cycleHistory');
        localStorage.removeItem('cycleHistoryDate');
      } catch(e) {}
      document.body.classList.remove('debug-active');
      renderTimer();
      renderCycleHistory();
    }
    
    // Keyboard shortcut to toggle debug panel
    document.addEventListener('keydown', function(e) {
      if (e.key === 'd' || e.key === 'D') {
        // Don't trigger if typing in an input
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          toggleDebug();
        }
      }
    });
    const t={en:{currentStrain:'Line 1 ‚Ä¢ Current Strain',lastHour:'Last Hour (Completed)',currentHour:'Current Hour',lbs:'lbs',trimmers:'trimmers',ofTarget:'vs target',lbsTarget:'lbs target',trimmersLabel:'Line 1 Trimmers',targetRate:'Target:',avgLbs:'AVG',bestLbs:'BEST',todaysProgress:'LINE 1 TODAY',endOfDay:'End of day:',lbsGoal:'lbs goal',upBy:'Up',downBy:'Down',vsYesterday:'vs Yesterday',vs7Day:'vs 7-Day Avg',hrStreak:'hr streak',hrs:'hrs',aheadOfTarget:'AHEAD OF TARGET',onTarget:'ON TARGET',behindTarget:'BEHIND TARGET',waiting:'WAITING FOR DATA',bagTimer:'5KG BAG TIMER',remaining:'remaining',overtime:'OVERTIME',bagComplete:'5KG Bag Complete',logged:'Logged!',bagsToday:'Bags Today',avgToday:'Avg Today',vsTargetTimer:'vs Target',strainRate:'Strain-specific rate',fallbackRate:'Using avg rate',helpTitle:'Understanding the Scoreboard',helpGreen:'Green = Ahead (105%+)',helpYellow:'Yellow = On Target (90-105%)',helpRed:'Red = Behind (<90%)',chartHeader:'HOURLY PERFORMANCE (LBS/TRIMMER)',onBreak:'ON BREAK',paused:'PAUSED',todaysCycles:"Today's Cycles",noBags:'No bags completed yet'},es:{currentStrain:'L√≠nea 1 ‚Ä¢ Variedad Actual',lastHour:'√öltima Hora (Completa)',currentHour:'Hora Actual',lbs:'lbs',trimmers:'triminadores',ofTarget:'vs meta',lbsTarget:'lbs meta',trimmersLabel:'Triminadores L1',targetRate:'Meta:',avgLbs:'PROM',bestLbs:'MEJOR',todaysProgress:'L√çNEA 1 HOY',endOfDay:'Fin del d√≠a:',lbsGoal:'lbs meta',upBy:'Arriba',downBy:'Abajo',vsYesterday:'vs Ayer',vs7Day:'vs Prom 7 D√≠as',hrStreak:'hrs seguidas',hrs:'hrs',aheadOfTarget:'ARRIBA DE LA META',onTarget:'EN LA META',behindTarget:'DEBAJO DE LA META',waiting:'ESPERANDO DATOS',bagTimer:'TEMPORIZADOR 5KG',remaining:'restante',overtime:'TIEMPO EXTRA',bagComplete:'Bolsa 5KG Lista',logged:'¬°Registrado!',bagsToday:'Bolsas Hoy',avgToday:'Prom Hoy',vsTargetTimer:'vs Meta',strainRate:'Tasa espec√≠fica',fallbackRate:'Usando tasa prom',helpTitle:'Entendiendo el Marcador',helpGreen:'Verde = Adelante (105%+)',helpYellow:'Amarillo = En Meta (90-105%)',helpRed:'Rojo = Atr√°s (<90%)',chartHeader:'RENDIMIENTO POR HORA (LBS/TRIMINADOR)',onBreak:'EN DESCANSO',paused:'PAUSADO',todaysCycles:'Ciclos de Hoy',noBags:'Sin bolsas completadas'}};
    
    // Break schedule and workday constants - use config if available
    var cfg = window.ScoreboardConfig;
    var BREAKS = (cfg && cfg.workday && cfg.workday.breaks) || [
      [9, 0, 9, 10],      // 9:00-9:10 AM break
      [12, 0, 12, 30],    // 12:00-12:30 PM lunch
      [14, 30, 14, 40],   // 2:30-2:40 PM break
      [16, 20, 16, 30]    // 4:20-4:30 PM cleanup/EOD
    ];
    var WORKDAY_START = (cfg && cfg.workday && cfg.workday.startMinutes) || 7 * 60;  // 7:00 AM in minutes
    var WORKDAY_END = (cfg && cfg.workday && cfg.workday.endMinutes) || 16 * 60 + 30;  // 4:30 PM in minutes
    
    function getWorkingSecondsSince(startTime) {
      if (!startTime) return 0;
      const now = new Date();
      
      // If different day, return 0 (timer resets daily)
      if (startTime.toDateString() !== now.toDateString()) {
        return 0;
      }
      
      let startMins = startTime.getHours() * 60 + startTime.getMinutes();
      const startSecs = startTime.getSeconds();
      let nowMins = now.getHours() * 60 + now.getMinutes();
      let nowSecs = now.getSeconds();
      
      // Before workday - no time elapsed
      if (nowMins < WORKDAY_START) return 0;
      
      // Cap at workday end
      if (nowMins >= WORKDAY_END) {
        nowMins = WORKDAY_END;
        nowSecs = 0;
      }
      
      // If start was before workday, adjust to workday start
      if (startMins < WORKDAY_START) {
        startMins = WORKDAY_START;
      }
      
      // Check if we're currently in a break - if so, cap nowMins/nowSecs to break start
      for (const [bStartH, bStartM, bEndH, bEndM] of BREAKS) {
        const breakStart = bStartH * 60 + bStartM;
        const breakEnd = bEndH * 60 + bEndM;
        if (nowMins >= breakStart && nowMins < breakEnd) {
          // We're in a break - freeze time at break start
          nowMins = breakStart;
          nowSecs = 0;
          break;
        }
      }
      
      // Calculate total seconds
      let totalSecs = (nowMins * 60 + nowSecs) - (startMins * 60 + startSecs);
      
      // Subtract any completed break time that overlaps our range
      for (const [bStartH, bStartM, bEndH, bEndM] of BREAKS) {
        const breakStartSecs = (bStartH * 60 + bStartM) * 60;
        const breakEndSecs = (bEndH * 60 + bEndM) * 60;
        const rangeStartSecs = startMins * 60 + startSecs;
        const rangeEndSecs = nowMins * 60 + nowSecs;
        
        if (breakEndSecs > rangeStartSecs && breakStartSecs < rangeEndSecs) {
          const overlapStart = Math.max(breakStartSecs, rangeStartSecs);
          const overlapEnd = Math.min(breakEndSecs, rangeEndSecs);
          if (overlapEnd > overlapStart) {
            totalSecs -= (overlapEnd - overlapStart);
          }
        }
      }
      
      return Math.max(0, totalSecs);
    }
    
    function isOnBreakOrAfterHours() {
      const now = new Date();
      const nowMins = now.getHours() * 60 + now.getMinutes();
      
      // Before workday
      if (nowMins < WORKDAY_START) return { onBreak: true, afterHours: true };
      
      // After workday end
      if (nowMins >= WORKDAY_END) return { onBreak: true, afterHours: true };
      
      // Check if currently in a break
      for (const [bStartH, bStartM, bEndH, bEndM] of BREAKS) {
        const breakStart = bStartH * 60 + bStartM;
        const breakEnd = bEndH * 60 + bEndM;
        if (nowMins >= breakStart && nowMins < breakEnd) {
          return { onBreak: true, afterHours: false };
        }
      }
      
      return { onBreak: false, afterHours: false };
    }
    
    function toggleHelp(){document.getElementById('helpModal').classList.toggle('active');document.getElementById('helpTitle').textContent=t[currentLang].helpTitle;document.getElementById('helpGreen').textContent=t[currentLang].helpGreen;document.getElementById('helpYellow').textContent=t[currentLang].helpYellow;document.getElementById('helpRed').textContent=t[currentLang].helpRed;}
    
    // API Configuration - use config module if available, fallback to Vercel Functions
    var API_URL = (window.ScoreboardConfig && ScoreboardConfig.API_URL) || 'https://rogue-origin-apps-master.vercel.app/api/production';
    
    // Detect environment: Apps Script (google.script.run available) or GitHub Pages (use fetch)
    var isAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
    
    // DISABLED: Initialization now handled by main.js module
    // document.addEventListener('DOMContentLoaded',function(){updateClock();registerInterval(updateClock,1000);loadData();registerInterval(loadData,15000);registerInterval(renderTimer,1000);renderCycleHistory();});
    function setLanguage(lang){currentLang=lang;document.getElementById('btnEn').classList.toggle('active',lang==='en');document.getElementById('btnEs').classList.toggle('active',lang==='es');document.getElementById('strainLabel').textContent=t[lang].currentStrain;document.getElementById('lastHourHeader').textContent=t[lang].lastHour;document.getElementById('currentHourHeader').textContent=t[lang].currentHour;document.getElementById('lbsUnit').textContent=t[lang].lbs;document.getElementById('trimmersSmallLabel').textContent=t[lang].trimmers;document.getElementById('ofTargetLabel').textContent=t[lang].ofTarget;document.getElementById('lbsTargetLabel').textContent=t[lang].lbsTarget;document.getElementById('trimmersLabel').textContent=t[lang].trimmersLabel;document.getElementById('targetRateLabel').textContent=t[lang].targetRate;document.getElementById('avgTargetLabel').textContent=t[lang].avgLbs;document.getElementById('bestHourLabel').textContent=t[lang].bestLbs;document.getElementById('dailyHeader').textContent=t[lang].todaysProgress;document.getElementById('vsYesterdayLabel').textContent=t[lang].vsYesterday;document.getElementById('vs7DayLabel').textContent=t[lang].vs7Day;document.getElementById('streakLabel').textContent=t[lang].hrStreak;document.getElementById('timerHeader').textContent=t[lang].bagTimer;document.getElementById('manualBtnText').textContent=t[lang].bagComplete;document.getElementById('bagsTodayLabel').textContent=t[lang].bagsToday;document.getElementById('avgTodayLabel').textContent=t[lang].avgToday;document.getElementById('vsTargetLabel').textContent=t[lang].vsTargetTimer;document.getElementById('chartHeader').textContent=t[lang].chartHeader;document.getElementById('cycleHistoryTitle').textContent=t[lang].todaysCycles;updateClock();renderScoreboard();renderTimer();renderCycleHistory();}
    function updateClock(){const now=new Date(),h=now.getHours()%12||12,m=now.getMinutes().toString().padStart(2,'0'),ap=now.getHours()>=12?'PM':'AM';document.getElementById('clock').textContent=`${h}:${m} ${ap}`;document.getElementById('date').textContent=now.toLocaleDateString(currentLang==='es'?'es-MX':'en-US',{weekday:'long',month:'short',day:'numeric'});}
    
    function loadData(){
      if (isAppsScript) {
        // Running inside Google Apps Script web app
        google.script.run
          .withSuccessHandler(function(r){
            data = r.scoreboard;
            timerData = r.timer;
            if (timerData && timerData.lastBagTime) lastBagTimestamp = new Date(timerData.lastBagTime);
            // Load cycle history from API if available
            if (timerData && timerData.cycleHistory && timerData.cycleHistory.length > 0) {
              loadCycleHistoryFromAPI(timerData.cycleHistory, timerData.targetSeconds || 300);
            }
            renderScoreboard();
            renderTimer();
            renderCycleHistory(); // Update cycle history display
          })
          .withFailureHandler(function(e){ console.error(e); showToast('Error loading data', 'error'); })
          .getScoreboardWithTimerData();
      } else {
        // Running on GitHub Pages - use fetch API (Vercel Functions)
        fetch(API_URL + '?action=scoreboard')
          .then(function(response) { return response.json(); })
          .then(function(raw) {
            var r = raw.data || raw; // Handle Vercel wrapper
            data = r.scoreboard;
            timerData = r.timer;
            if (timerData && timerData.lastBagTime) lastBagTimestamp = new Date(timerData.lastBagTime);
            // Load cycle history from API if available
            if (timerData && timerData.cycleHistory && timerData.cycleHistory.length > 0) {
              loadCycleHistoryFromAPI(timerData.cycleHistory, timerData.targetSeconds || 300);
            }
            renderScoreboard();
            renderTimer();
            renderCycleHistory(); // Update cycle history display
          })
          .catch(function(e) {
            console.error('Load error:', e);
            showToast('Error loading scoreboard data', 'error');
          });
      }
    }

    function loadCycleHistoryFromAPI(apiCycles, defaultTarget) {
      // Only load if we don't have local data or API has more entries
      // This prevents overwriting locally added cycles
      if (cycleHistory.length === 0 || apiCycles.length > cycleHistory.length) {
        cycleHistory = apiCycles.map((c, i) => {
          const cycleTime = c.cycleTime || c.time || c.seconds || 0;
          const target = c.target || c.targetSeconds || defaultTarget;
          const delta = target - cycleTime;
          let status = 'on-time';
          if (delta > 10) status = 'early';
          else if (delta < -10) status = 'overtime';
          
          return {
            num: i + 1,
            time: cycleTime,
            target: target,
            delta: delta,
            status: status,
            trimmers: c.trimmers || null,
            hour: c.hour || null,
            timestamp: c.timestamp ? new Date(c.timestamp) : new Date()
          };
        }).reverse(); // Most recent first
        
        saveLocalCycleHistory(); // Save to localStorage
        renderCycleHistory();
      }
    }
    
    function renderHourlyChart(hourlyRates, targetRate) {
      const container = document.getElementById('chartContainer');
      if (!hourlyRates || hourlyRates.length === 0) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      
      const labels = hourlyRates.map(h => {
        // Shorten time slot labels: "9:00 AM ‚Äì 10:00 AM" -> "9-10"
        const match = h.timeSlot.match(/(\d+):\d+\s*(AM|PM)\s*[‚Äì-]\s*(\d+):\d+/i);
        if (match) {
          let start = parseInt(match[1]);
          let end = parseInt(match[3]);
          return `${start}-${end}`;
        }
        return h.timeSlot;
      });
      
      const rates = hourlyRates.map(h => parseFloat(h.rate.toFixed(2)));
      const targets = hourlyRates.map(h => parseFloat(h.target.toFixed(2)));
      
      // Color bars based on performance - using brand colors
      const barColors = hourlyRates.map(h => {
        const pct = (h.rate / h.target) * 100;
        if (pct >= 105) return '#668971';  // Brand green
        if (pct >= 90) return '#e4aa4f';   // Brand gold
        return '#f87171';                   // Red
      });
      
      // Check both local variable and ScoreboardState for existing chart
      var existingChart = hourlyChart || (window.ScoreboardState && window.ScoreboardState.hourlyChart);
      if (existingChart) {
        existingChart.data.labels = labels;
        existingChart.data.datasets[0].data = rates;
        existingChart.data.datasets[0].backgroundColor = barColors;
        existingChart.data.datasets[1].data = targets;
        existingChart.update('none');
        return;
      }
      
      const ctx = document.getElementById('hourlyChart').getContext('2d');
      
      hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Actual',
              data: rates,
              backgroundColor: barColors,
              borderRadius: 4,
              barThickness: 32
            },
            {
              label: 'Target',
              data: targets,
              type: 'line',
              borderColor: 'rgba(228,170,79,0.6)',
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' lbs/hr';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(228,170,79,0.1)' },
              ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 12 } }
            }
          }
        }
      });

      // Also store in ScoreboardState for module compatibility
      if (window.ScoreboardState) {
        window.ScoreboardState.hourlyChart = hourlyChart;
      }
    }

    function renderScoreboard(){if(!data)return;const lastHourLbs=data.lastHourLbs||0,lastHourTarget=data.lastHourTarget||0,lastHourTrimmers=data.lastHourTrimmers||0,lastTimeSlot=data.lastTimeSlot||'‚Äî',currentHourTrimmers=data.currentHourTrimmers||0,currentHourTarget=data.currentHourTarget||0,currentTimeSlot=data.currentTimeSlot||'',targetRate=data.targetRate||0,strain=data.strain||'‚Äî',todayLbs=data.todayLbs||0,todayTarget=data.todayTarget||0,todayPct=data.todayPercentage||0,hoursLogged=data.hoursLogged||0,avgPct=data.avgPercentage||0,bestPct=data.bestPercentage||0,streak=data.streak||0,lastHourPct=lastHourTarget>0?(lastHourLbs/lastHourTarget)*100:0,lastHourDelta=lastHourLbs-lastHourTarget,statusPct=todayPct>0?todayPct:avgPct;let status='idle',statusIcon='‚è∏',statusKey='waiting';if(todayLbs>0||lastHourLbs>0){if(statusPct>=105){status='ahead';statusIcon='üî•';statusKey='aheadOfTarget';}else if(statusPct>=90){status='on-target';statusIcon='‚úì';statusKey='onTarget';}else if(statusPct>0){status='behind';statusIcon='‚ö†';statusKey='behindTarget';}}
    // Update status classes without overriding timer background
    document.body.classList.remove('ahead','on-target','behind','idle');
    document.body.classList.add(status);
    document.getElementById('statusIcon').textContent=statusIcon;document.getElementById('statusText').textContent=t[currentLang][statusKey];document.getElementById('lastHourLbs').textContent=lastHourLbs>0?lastHourLbs.toFixed(1):'‚Äî';document.getElementById('lastHourTarget').textContent=lastHourTarget>0?lastHourTarget.toFixed(1):'‚Äî';document.getElementById('lastHourTimeslot').textContent=lastTimeSlot;
    // Show lbs delta instead of percentage
    const lhp = document.getElementById('lastHourPct');
    if(lastHourTarget>0){const deltaAbs=Math.abs(lastHourDelta).toFixed(1);if(lastHourDelta>=0.05){lhp.textContent=`+${deltaAbs} lbs`;lhp.style.color='#7a9d87';}else if(lastHourDelta<=-0.05){lhp.textContent=`-${deltaAbs} lbs`;lhp.style.color='#f87171';}else{lhp.textContent=`0 lbs`;lhp.style.color='#e4aa4f';}}else{lhp.textContent='‚Äî';lhp.style.color='rgba(255,255,255,0.5)';}
    const chc=document.getElementById('currentHourCard');if(currentHourTrimmers>0){chc.style.display='block';document.getElementById('currentHourTrimmers').textContent=currentHourTrimmers;document.getElementById('currentHourTimeslot').textContent=currentTimeSlot;document.getElementById('currentHourTargetLbs').textContent=currentHourTarget>0?currentHourTarget.toFixed(1):'‚Äî';}else{chc.style.display='none';}
    
    // Render the hourly chart
    renderHourlyChart(data.hourlyRates, targetRate);
    
    document.getElementById('dailyActual').textContent=todayLbs>0?todayLbs.toFixed(1):'‚Äî';document.getElementById('dailyTarget').textContent=todayTarget>0?todayTarget.toFixed(1):'‚Äî';const todayDelta=data.todayDelta||0,dde=document.getElementById('dailyDelta');if(todayTarget>0){const da=Math.abs(todayDelta).toFixed(1);if(todayDelta>=0.1){dde.textContent=`‚Üë ${t[currentLang].upBy} ${da}`;dde.className='daily-delta positive';}else if(todayDelta<=-0.1){dde.textContent=`‚Üì ${t[currentLang].downBy} ${da}`;dde.className='daily-delta negative';}else{dde.textContent='= On pace';dde.className='daily-delta neutral';}}else{dde.textContent='‚Äî';dde.className='daily-delta neutral';}const effectiveHours=data.effectiveHours||hoursLogged;document.getElementById('progressHours').textContent=`${effectiveHours.toFixed(1)} ${t[currentLang].hrs}`;document.getElementById('progressFill').style.width=`${Math.min(100,todayPct||avgPct||0)}%`;const projectedTotal=data.projectedTotal||0,dailyGoal=data.dailyGoal||0,projectedDelta=data.projectedDelta||0;document.getElementById('projectionLabel').textContent=t[currentLang].endOfDay;document.getElementById('projectionValue').textContent=projectedTotal>0?projectedTotal.toFixed(1):'‚Äî';document.getElementById('projectionGoal').textContent=dailyGoal>0?`/ ${dailyGoal.toFixed(1)} ${t[currentLang].lbsGoal}`:'';const pde=document.getElementById('projectionDelta');if(dailyGoal>0&&projectedTotal>0){const pda=Math.abs(projectedDelta).toFixed(1);if(projectedDelta>=0.5){pde.textContent=`‚Üë +${pda}`;pde.className='projection-delta positive';}else if(projectedDelta<=-0.5){pde.textContent=`‚Üì -${pda}`;pde.className='projection-delta negative';}else{pde.textContent='= On pace';pde.className='projection-delta neutral';}}else{pde.textContent='‚Äî';pde.className='projection-delta neutral';}renderComparison('vsYesterday',data.vsYesterday);renderComparison('vs7Day',data.vs7Day);document.getElementById('streakPill').style.display=streak>=2?'flex':'none';document.getElementById('streakValue').textContent=streak;const displayTrimmers=currentHourTrimmers>0?currentHourTrimmers:lastHourTrimmers;document.getElementById('crewCount').textContent=displayTrimmers>0?displayTrimmers:'‚Äî';document.getElementById('targetRate').textContent=targetRate>0?targetRate.toFixed(2):'‚Äî';document.getElementById('strainName').textContent=strain||'‚Äî';const avgEl=document.getElementById('avgPercentage'),bestEl=document.getElementById('bestHour');
    if(data.avgDelta!==undefined&&data.avgDelta!==0){avgEl.textContent=(data.avgDelta>=0?'+':'')+data.avgDelta.toFixed(1);avgEl.style.color=data.avgDelta>=0.05?'#7a9d87':data.avgDelta<=-0.05?'#f87171':'#e4aa4f';}else if(data.avgDelta===0){avgEl.textContent='0';avgEl.style.color='#e4aa4f';}else{avgEl.textContent='‚Äî';avgEl.style.color='rgba(255,255,255,0.9)';}
    if(data.bestDelta!==undefined&&data.bestDelta!==0){bestEl.textContent=(data.bestDelta>=0?'+':'')+data.bestDelta.toFixed(1);bestEl.style.color=data.bestDelta>=0.05?'#7a9d87':data.bestDelta<=-0.05?'#f87171':'#e4aa4f';}else if(data.bestDelta===0){bestEl.textContent='0';bestEl.style.color='#e4aa4f';}else{bestEl.textContent='‚Äî';bestEl.style.color='rgba(255,255,255,0.9)';}
    const sri=document.getElementById('strainRateIndicator');if(data.usingStrainRate){sri.innerHTML=`<span style="font-size:12px;color:rgba(122,157,135,0.9)">${t[currentLang].strainRate}</span>`;}else if(strain&&strain!=='‚Äî'){sri.innerHTML=`<span style="font-size:12px;color:rgba(228,170,79,0.9)">${t[currentLang].fallbackRate}</span>`;}else{sri.innerHTML='';}}
    function renderTimer(){const targetSec=(timerData&&timerData.targetSeconds)||0,trimmers=(timerData&&timerData.currentTrimmers)||0,bagsToday=(timerData&&timerData.bagsToday)||0,avgSecToday=(timerData&&timerData.avgSecondsToday)||0;
      
      // Get break/after hours status (can be overridden by debug)
      let breakStatus = debugOnBreak !== null ? { onBreak: debugOnBreak, afterHours: false } : isOnBreakOrAfterHours();
      
      // Check if manually paused
      const isManuallyPaused = isPaused;
      
      // Calculate working time (excludes breaks)
      let elapsedSec=0;
      if(lastBagTimestamp && !isManuallyPaused)elapsedSec=getWorkingSecondsSince(lastBagTimestamp);
      else if(lastBagTimestamp && isManuallyPaused && pauseStartTime) {
        // Show elapsed time up until pause started
        elapsedSec = getWorkingSecondsSince(lastBagTimestamp) - Math.floor((new Date() - pauseStartTime) / 1000);
        if (elapsedSec < 0) elapsedSec = 0;
      }
      
      // Debug mode: simulate elapsed time as percentage of target
      const debugTargetSec = targetSec > 0 ? targetSec : 300; // Default 5 min for testing
      if (debugMode && debugElapsedPercent !== null) {
        elapsedSec = Math.round(debugTargetSec * (debugElapsedPercent / 100));
      }
      
      const effectiveTarget = debugMode ? debugTargetSec : targetSec;
      let remainingSec=effectiveTarget>0?effectiveTarget-elapsedSec:elapsedSec;
      const isOvertime=effectiveTarget>0&&remainingSec<0&&!breakStatus.onBreak&&!isManuallyPaused;
      const displaySec=Math.abs(effectiveTarget>0?remainingSec:elapsedSec);
      
      let colorClass='neutral';
      
      // Debug mode: direct state override
      if (debugMode && debugState) {
        colorClass = debugState;
      } else if (isManuallyPaused) {
        colorClass = 'yellow';
      } else if(effectiveTarget>0||elapsedSec>0){
        colorClass='green';
        if(breakStatus.onBreak){
          colorClass='yellow';
        }else if(effectiveTarget>0){
          if(isOvertime)colorClass='red';
          else if(remainingSec<effectiveTarget*0.2)colorClass='yellow';
        }
      }
      
      const tp=document.getElementById('timerPanel'),tv=document.getElementById('timerValue'),tl=document.getElementById('timerLabel'),tr=document.getElementById('timerRing'),td=document.getElementById('timerDisplay');
      
      // Update panel background color (preserve fullscreen and dragging classes)
      const isFs = tp.classList.contains('fullscreen');
      const isDr = tp.classList.contains('dragging');
      tp.className='timer-panel '+colorClass + (isFs ? ' fullscreen' : '') + (isDr ? ' dragging' : '');
      
      // Update body background based on timer status
      document.body.classList.remove('timer-green', 'timer-yellow', 'timer-red', 'timer-neutral');
      document.body.classList.add('timer-' + colorClass);
      
      // Show paused state during manual pause, breaks, or after hours
      if(isManuallyPaused){
        tv.textContent=formatTime(displaySec);
        tv.className='timer-value yellow';
        tl.textContent=currentLang==='es'?'PAUSADO':'PAUSED';
      }else if(breakStatus.onBreak && !debugMode){
        tv.textContent=breakStatus.afterHours?'--:--':formatTime(displaySec);
        tv.className='timer-value yellow';
        tl.textContent=breakStatus.afterHours?t[currentLang].paused:t[currentLang].onBreak;
      }else{
        const showTime = debugMode || effectiveTarget>0 || elapsedSec>0;
        tv.textContent=showTime?formatTime(displaySec):'--:--';
        tv.className='timer-value '+(colorClass==='neutral'?'':colorClass);
        const isOT = debugState === 'red' || isOvertime;
        tl.textContent=(effectiveTarget===0&&elapsedSec>0&&!debugMode)?(currentLang==='es'?'transcurrido':'elapsed'):isOT?t[currentLang].overtime:t[currentLang].remaining;
      }
      
      const circ=2*Math.PI*95;let prog=0;
      if(isManuallyPaused){
        // Keep ring at current position during manual pause
        prog=effectiveTarget>0&&elapsedSec>0?Math.min(1,elapsedSec/effectiveTarget):0;
      }else if(breakStatus.onBreak && !debugMode){
        // Keep ring at current position during breaks
        prog=effectiveTarget>0&&elapsedSec>0?Math.min(1,elapsedSec/effectiveTarget):0;
      }else if(effectiveTarget>0){
        const isOT = debugState === 'red' || isOvertime;
        prog=isOT?1:elapsedSec/effectiveTarget;
      }
      // Debug mode progress override
      if (debugMode && debugElapsedPercent !== null) {
        prog = Math.min(1, debugElapsedPercent / 100);
      } else if (debugMode && debugState === 'red') {
        prog = 1;
      } else if (debugMode && debugState === 'yellow') {
        prog = 0.85;
      } else if (debugMode && debugState === 'green') {
        prog = 0.4;
      }
      
      tr.style.strokeDashoffset=circ*(1-Math.min(1,prog));
      tr.className='timer-ring-progress '+(colorClass==='neutral'?'green':colorClass);
      const showOvertime = debugState === 'red' || (isOvertime && !breakStatus.onBreak && !isManuallyPaused);
      td.classList.toggle('overtime', showOvertime);
      
      document.getElementById('timerTargetTime').textContent=effectiveTarget>0?formatTime(effectiveTarget):'--:--';document.getElementById('timerTrimmers').textContent=trimmers||'‚Äî';document.getElementById('bagsToday').textContent=bagsToday;document.getElementById('avgToday').textContent=avgSecToday>0?formatTime(avgSecToday):'--:--';const vt=document.getElementById('vsTarget');if(avgSecToday>0&&effectiveTarget>0){const diff=effectiveTarget-avgSecToday,dm=Math.round(diff/60);if(dm>0){vt.textContent=`+${dm} min`;vt.className='timer-stat-value positive';}else if(dm<0){vt.textContent=`${dm} min`;vt.className='timer-stat-value negative';}else{vt.textContent='On pace';vt.className='timer-stat-value';}}else{vt.textContent='‚Äî';vt.className='timer-stat-value';}
      
      // Update button color to match timer state
      const btn = document.getElementById('manualBtn');
      btn.classList.remove('btn-green', 'btn-yellow', 'btn-red', 'btn-neutral');
      if (!btn.classList.contains('success')) {
        btn.classList.add('btn-' + colorClass);
      }
    }
    function formatTime(s){return`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;}
    function logManualEntry(){
      const btn=document.getElementById('manualBtn'),txt=document.getElementById('manualBtnText');
      
      // Calculate elapsed time before resetting
      const targetSec = (timerData && timerData.targetSeconds) || 300;
      let elapsedSec = 0;
      if (lastBagTimestamp) {
        elapsedSec = getWorkingSecondsSince(lastBagTimestamp);
      }
      
      // Add to cycle history if there was a valid cycle
      if (elapsedSec > 0) {
        addCycleToHistory(elapsedSec, targetSec);
      }
      
      // === IMMEDIATE RESET (don't wait for API) ===
      lastBagTimestamp = new Date();
      renderTimer(); // Reset timer display immediately
      
      // Visual feedback
      btn.disabled=true;
      btn.classList.add('success');
      btn.classList.remove('btn-green', 'btn-yellow', 'btn-red', 'btn-neutral');
      txt.textContent=t[currentLang].logged;
      
      // Re-enable button after short delay (for scanner to reset)
      setTimeout(function(){
        btn.disabled=false;
        btn.classList.remove('success');
        txt.textContent=t[currentLang].bagComplete;
      }, 1500);
      
      // === LOG TO API IN BACKGROUND ===
      if (isAppsScript) {
        // Running inside Google Apps Script web app
        google.script.run
          .withSuccessHandler(function(){
            // Refresh data in background
            setTimeout(loadData, 1000);
          })
          .withFailureHandler(function(e){
            console.error('API log failed:', e);
            showToast('Failed to log bag', 'warning');
          })
          .logManualBagCompletion();
      } else {
        // Running on GitHub Pages - use fetch API (Vercel Functions)
        fetch(API_URL + '?action=logBag', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ size: '5 kg.' })
        })
          .then(function(response) { return response.json(); })
          .then(function(raw) {
            var r = raw.data || raw; // Handle Vercel wrapper
            if (r.timestamp || raw.success) {
              setTimeout(loadData, 1000);
            }
          })
          .catch(function(e) {
            console.error('Log bag error:', e);
            showToast('Failed to log bag', 'warning');
          });
      }
    }

    // ========== PAUSE FUNCTIONALITY ==========
    function handlePauseClick() {
      if (isPaused) {
        // Resume
        resumeTimer();
      } else {
        // Show pause modal
        openPauseModal();
      }
    }
    
    function openPauseModal() {
      const modal = document.getElementById('pauseModal');
      const customInput = document.getElementById('pauseCustomReason');
      const confirmBtn = document.getElementById('pauseConfirmBtn');
      
      // Reset modal state
      document.querySelectorAll('.pause-reason-btn').forEach(btn => btn.classList.remove('selected'));
      customInput.value = '';
      confirmBtn.disabled = true;
      pauseReason = '';
      
      modal.classList.add('visible');
    }
    
    function closePauseModal() {
      document.getElementById('pauseModal').classList.remove('visible');
    }
    
    function selectPauseReason(btn, reason) {
      document.querySelectorAll('.pause-reason-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('pauseCustomReason').value = '';
      pauseReason = reason;
      document.getElementById('pauseConfirmBtn').disabled = false;
    }
    
    function onCustomReasonInput() {
      const customInput = document.getElementById('pauseCustomReason');
      const customReason = customInput.value.trim();
      
      if (customReason) {
        document.querySelectorAll('.pause-reason-btn').forEach(b => b.classList.remove('selected'));
        pauseReason = customReason;
        document.getElementById('pauseConfirmBtn').disabled = false;
      } else if (!pauseReason) {
        document.getElementById('pauseConfirmBtn').disabled = true;
      }
    }
    
    function confirmPause() {
      closePauseModal();
      startPause();
    }
    
    function startPause() {
      isPaused = true;
      pauseStartTime = new Date();
      
      // Update UI
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.classList.add('paused');
      pauseBtn.innerHTML = '<i class="ph-duotone ph-play"></i>';
      
      const banner = document.getElementById('pauseBanner');
      document.getElementById('pauseReasonDisplay').textContent = pauseReason;
      banner.classList.add('visible');
      
      // Start counting pause time
      updatePauseTimer();
      pauseInterval = setInterval(updatePauseTimer, 1000);
      
      // Log to Google Sheets
      logPauseToSheet();
    }
    
    function updatePauseTimer() {
      if (!pauseStartTime) return;
      const elapsed = Math.floor((new Date() - pauseStartTime) / 1000);
      document.getElementById('pauseTime').textContent = formatTime(elapsed);
    }
    
    function resumeTimer() {
      const pauseDuration = pauseStartTime ? Math.floor((new Date() - pauseStartTime) / 1000) : 0;
      
      isPaused = false;
      
      // Clear interval
      if (pauseInterval) {
        clearInterval(pauseInterval);
        pauseInterval = null;
      }
      
      // Update UI
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.classList.remove('paused');
      pauseBtn.innerHTML = '<i class="ph-duotone ph-pause"></i>';
      
      document.getElementById('pauseBanner').classList.remove('visible');
      
      // Adjust lastBagTimestamp to account for pause duration
      if (lastBagTimestamp && pauseDuration > 0) {
        lastBagTimestamp = new Date(lastBagTimestamp.getTime() + (pauseDuration * 1000));
      }
      
      // Log resume to Google Sheets
      logResumeToSheet(pauseDuration);
      
      // Reset pause state
      pauseStartTime = null;
      pauseReason = '';
    }
    
    function logPauseToSheet() {
      if (!API_URL) return;

      fetch(API_URL + '?action=logPause', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: pauseReason })
      })
      .then(response => response.json())
      .then(raw => {
        var result = raw.data || raw; // Handle Vercel wrapper
        if (result.pauseId || raw.success) {
          pauseId = result.pauseId;
          console.log('Pause logged:', result);
        }
      })
      .catch(err => console.error('Failed to log pause:', err));
    }

    function logResumeToSheet(duration) {
      if (!API_URL || !pauseId) return;

      fetch(API_URL + '?action=logResume', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pauseId: pauseId, duration: duration })
      })
      .then(response => response.json())
      .then(raw => {
        var result = raw.data || raw; // Handle Vercel wrapper
        console.log('Resume logged:', result);
        pauseId = null;
      })
      .catch(err => console.error('Failed to log resume:', err));
    }
    // ========== END PAUSE FUNCTIONALITY ==========
    
    function renderComparison(prefix,value){const pill=document.getElementById(prefix+'Pill'),ve=document.getElementById(prefix+'Value');if(value===null||value===undefined){pill.style.display='none';return;}pill.style.display='flex';const r=Math.round(value);ve.textContent=`${r>=0?'+':''}${r}%`;ve.classList.remove('positive','negative','neutral');ve.classList.add(r>2?'positive':r<-2?'negative':'neutral');}
    
    // Drag-to-expand timer panel functionality
    (function() {
      const timerPanel = document.getElementById('timerPanel');
      const dragHandle = document.getElementById('dragHandle');
      const expandHint = document.getElementById('expandHint');
      const fullscreenToggleBtn = document.getElementById('fullscreenToggle');
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let isFullscreen = false;
      const DRAG_THRESHOLD = 100; // pixels to drag before toggling
      
      function isVerticalMode() {
        return window.innerWidth <= 1024;
      }
      
      function updateHint() {
        if (isVerticalMode()) {
          expandHint.textContent = isFullscreen ? '‚ñº' : '‚ñ≤';
        } else {
          expandHint.textContent = isFullscreen ? '‚ñ∂' : '‚óÄ';
        }
        // Update fullscreen toggle button icon
        if (fullscreenToggleBtn) {
          fullscreenToggleBtn.innerHTML = isFullscreen 
            ? '<i class="ph-duotone ph-arrows-in"></i>' 
            : '<i class="ph-duotone ph-arrows-out"></i>';
        }
      }
      
      function toggleFullscreen(toFullscreen) {
        isFullscreen = toFullscreen;
        timerPanel.classList.toggle('fullscreen', isFullscreen);
        document.body.classList.toggle('timer-fullscreen', isFullscreen);
        updateHint();
        // Save preference
        try { localStorage.setItem('timerFullscreen', isFullscreen); } catch(e) {}
      }
      
      // Expose global toggle function for button
      window.toggleTimerFullscreen = function() {
        toggleFullscreen(!isFullscreen);
      };
      
      // Load saved preference
      try {
        const saved = localStorage.getItem('timerFullscreen');
        if (saved === 'true') {
          toggleFullscreen(true);
        }
      } catch(e) {}
      
      // Update hint on resize
      window.addEventListener('resize', updateHint);
      updateHint(); // Initial update
      
      // Mouse events
      dragHandle.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        timerPanel.classList.add('dragging');
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        timerPanel.classList.remove('dragging');
        
        if (isVerticalMode()) {
          // Vertical dragging (up/down)
          const deltaY = startY - e.clientY;
          if (!isFullscreen && deltaY > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaY < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        } else {
          // Horizontal dragging (left/right)
          const deltaX = startX - e.clientX;
          if (!isFullscreen && deltaX > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaX < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        }
      });
      
      // Touch events for mobile
      dragHandle.addEventListener('touchstart', function(e) {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        timerPanel.classList.add('dragging');
      }, { passive: true });
      
      document.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
      }, { passive: true });
      
      document.addEventListener('touchend', function(e) {
        if (!isDragging) return;
        isDragging = false;
        timerPanel.classList.remove('dragging');
        
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        
        if (isVerticalMode()) {
          const deltaY = startY - endY;
          if (!isFullscreen && deltaY > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaY < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        } else {
          const deltaX = startX - endX;
          if (!isFullscreen && deltaX > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaX < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        }
      });
      
      // Double-click/tap to toggle
      dragHandle.addEventListener('dblclick', function() {
        toggleFullscreen(!isFullscreen);
      });
    })();
  </script>

  <!-- Start Day Modal -->
  <div id="startDayModal" class="modal-overlay" style="display:none;">
    <div class="modal-content start-day-modal">
      <h3 class="modal-title">
        <i class="ph-duotone ph-play-circle"></i>
        Set Shift Start Time
      </h3>
      <p class="modal-subtitle">What time did production begin today?</p>

      <div class="time-input-wrapper">
        <label for="startTimeInput">Start Time:</label>
        <input type="time" id="startTimeInput" class="time-input" />
      </div>

      <div class="impact-preview" id="impactPreview">
        <i class="ph-duotone ph-info"></i>
        <div class="impact-text">
          This will adjust daily goal by <span id="goalReduction">‚Äî</span>
          <div class="impact-details">
            <span id="originalGoal">200</span> lbs ‚Üí <span id="adjustedGoalPreview">‚Äî</span> lbs
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button onclick="cancelStartTime()" class="btn-secondary">Cancel</button>
        <button onclick="confirmStartTime()" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>
  <script src="../js/sw-register.js" async></script>
</body>
</html>
