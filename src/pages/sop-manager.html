<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#668971">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RO Ops">
  <link rel="apple-touch-icon" href="/assets/icon-apple-touch.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SOP Manager">
  <title>SOP Manager - Rogue Origin</title>

  <!-- Performance: Resource Hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://script.google.com">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=optional" rel="stylesheet">

  <!-- Scripts: Deferred for faster initial render -->
  <script defer src="https://unpkg.com/@phosphor-icons/web"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Performance: CSS Preloading -->
  <link rel="stylesheet" href="../css/shared-base.css">
  <link rel="preload" href="../css/sop-manager.css" as="style">
  <link rel="stylesheet" href="../css/sop-manager.css">
</head>
<body>
  <main class="main">
    <header class="header">
      <div class="header-left">
        <img src="https://i.imgur.com/UYEbNiI.png" alt="Rogue Origin" class="header-logo">
        <span class="header-title">Standard Operating Procedures</span>
      </div>
      <div class="header-right">
        <button class="lang-switch" onclick="toggleAppLang()" title="Switch Language"><span id="appLangLabel">EN</span> <i class="ph-duotone ph-translate"></i></button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="ph-duotone ph-moon"></i><span>Dark</span></button>
        <button class="header-btn" onclick="openSettingsModal()"><i class="ph-duotone ph-gear"></i></button>
        <button class="header-btn" onclick="openRequestsModal()" id="requestsBtn"><i class="ph-duotone ph-clipboard-text"></i> Requests <span class="request-badge" id="requestBadge" style="display:none;">0</span></button>
        <button class="header-btn" onclick="refresh()"><i class="ph-duotone ph-arrows-clockwise"></i></button>
        <button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> New SOP</button>
      </div>
    </header>
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box"><i class="ph-duotone ph-magnifying-glass"></i><input type="text" id="searchInput" placeholder="Search SOPs..." oninput="filterSOPs()"></div>
        <select class="filter-select" id="statusFilter" onchange="filterSOPs()"><option value="">All SOPs</option><option value="published">Published</option><option value="draft">Drafts</option></select>
        <select class="filter-select" id="deptFilter" onchange="filterSOPs()"></select>
        <select class="filter-select" id="tagFilter" onchange="filterSOPs()"></select>
      </div>
      <div class="toolbar-right">
        <div class="view-toggle">
          <button class="active" onclick="setView('grid')" id="gridViewBtn"><i class="ph-duotone ph-squares-four"></i></button>
          <button onclick="setView('list')" id="listViewBtn"><i class="ph-duotone ph-list"></i></button>
        </div>
      </div>
    </div>
    <div class="content">
      <div class="stats-bar">
        <div class="stat-card"><div class="stat-card-label">Total</div><div class="stat-card-value gold" id="statTotal">0</div></div>
        <div class="stat-card"><div class="stat-card-label">Published</div><div class="stat-card-value green" id="statPublished">0</div></div>
        <div class="stat-card"><div class="stat-card-label">Drafts</div><div class="stat-card-value sungrown" id="statDrafts">0</div></div>
        <div class="stat-card" style="cursor:pointer;" onclick="openRequestsModal()"><div class="stat-card-label">Requests</div><div class="stat-card-value danger" id="statRequests">0</div></div>
        <div class="stat-card"><div class="stat-card-label">This Month</div><div class="stat-card-value indoor" id="statMonth">0</div></div>
      </div>
      <div id="loadingState" class="loading-state"><div class="spinner"></div><p>Loading SOPs from Google Sheets...</p></div>
      <div class="sop-grid" id="sopGrid" style="display:none;"></div>
      <div class="sop-list" id="sopList"><div class="sop-table"><table><thead><tr><th>Title</th><th>Department</th><th>Steps</th><th>Status</th><th>Updated</th><th>Actions</th></tr></thead><tbody id="sopTableBody"></tbody></table></div></div>
      <div class="empty-state" id="emptyState" style="display:none;"><i class="ph-duotone ph-files"></i><h3>No SOPs Found</h3><p>Create your first SOP to get started.</p><button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> Create SOP</button></div>
    </div>
  </main>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2 id="modalTitle"><i class="ph-duotone ph-file-text"></i> Create New SOP</h2>
        <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">SOP Title * <button type="button" class="ai-improve-btn" onclick="aiImproveTitle()" title="AI Improve"><i class="ph-duotone ph-sparkle"></i> Improve</button></label>
            <input type="text" class="form-input" id="sopTitle" placeholder="e.g., Trimming Machine Setup">
          </div>
          <div class="form-group">
            <label class="form-label">Department *</label>
            <div style="display:flex;gap:8px;">
              <select class="form-input" id="sopDept" style="flex:1;"></select>
              <button type="button" class="inline-add-btn" onclick="showInlineAdd('dept')" title="Add Department"><i class="ph-duotone ph-plus"></i></button>
            </div>
            <div class="inline-add-field" id="inlineAddDept" style="display:none;margin-top:8px;">
              <div style="display:flex;gap:8px;">
                <input type="text" class="form-input" id="newDeptInline" placeholder="New department..." style="flex:1;" onkeypress="if(event.key==='Enter'){addDeptInline();event.preventDefault();}">
                <button type="button" class="inline-add-btn save" onclick="addDeptInline()"><i class="ph-duotone ph-check"></i></button>
                <button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('dept')"><i class="ph-duotone ph-x"></i></button>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group" style="background:var(--bg);padding:14px;border-radius:10px;border:1px solid var(--border);">
          <label class="form-label" style="margin-bottom:10px;">Writing Language</label>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <div class="lang-toggle" id="editLangToggle">
              <button class="active" onclick="setEditLang('en')">English</button>
              <button onclick="setEditLang('es')">Español</button>
            </div>
            <button type="button" class="translate-btn" id="autoTranslateBtn" onclick="autoTranslateSOP()">
              <i class="ph-duotone ph-translate"></i> <span id="translateBtnText">Auto-translate to Español</span>
            </button>
            <span style="font-size:11px;color:var(--text-light);">Creates both language versions</span>
          </div>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Document Number</label>
            <input type="text" class="form-input" id="sopDocNum" placeholder="SOP-001">
          </div>
          <div class="form-group">
            <label class="form-label">Revision</label>
            <input type="text" class="form-input" id="sopRevision" value="1.0">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="sopStatus">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Description <button type="button" class="ai-improve-btn" onclick="aiImproveDescription()" title="AI Improve"><i class="ph-duotone ph-sparkle"></i> Improve</button></label>
          <textarea class="form-input" id="sopDesc" placeholder="Brief description..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div id="editTagsList" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;"></div>
          <div class="inline-add-field" id="inlineAddTag" style="display:none;margin-top:10px;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <input type="text" class="form-input" id="newTagInline" placeholder="New tag..." style="width:140px;" onkeypress="if(event.key==='Enter'){addTagInline();event.preventDefault();}">
              <div class="tag-color-picker-mini" id="inlineTagColors"></div>
              <button type="button" class="inline-add-btn save" onclick="addTagInline()"><i class="ph-duotone ph-check"></i></button>
              <button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('tag')"><i class="ph-duotone ph-x"></i></button>
            </div>
          </div>
        </div>
        <div class="steps-section">
          <div class="steps-header">
            <h3><i class="ph-duotone ph-list-numbers"></i> Steps</h3>
            <div style="display:flex;gap:8px;">
              <button class="ai-improve-btn" id="aiImproveAllBtn" onclick="aiImproveAllSteps()" style="padding:6px 12px;"><i class="ph-duotone ph-sparkle"></i> AI Improve All</button>
              <button class="header-btn" style="background:var(--bg);color:var(--text-muted);border:1px solid var(--border);" onclick="addStep()"><i class="ph-duotone ph-plus"></i> Add</button>
            </div>
          </div>
          <div class="steps-list" id="stepsList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('editModal')">Cancel</button>
        <button class="header-btn" onclick="saveSOP('draft')"><i class="ph-duotone ph-floppy-disk"></i> Save Draft</button>
        <button class="header-btn primary" onclick="saveSOP('published')"><i class="ph-duotone ph-check-circle"></i> Publish</button>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal" id="viewModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-eye"></i> View SOP</h2>
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="lang-toggle" id="viewLangToggle">
            <button class="active" onclick="setViewLang('en')">EN</button>
            <button onclick="setViewLang('es')">ES</button>
          </div>
          <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
        </div>
      </div>
      <div class="modal-body" id="viewModalBody"></div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('viewModal')">Close</button>
        <button class="header-btn" onclick="openModal('pdfModal')"><i class="ph-duotone ph-file-pdf"></i> PDF</button>
        <button class="header-btn primary" onclick="editCurrentSOP()"><i class="ph-duotone ph-pencil-simple"></i> Edit</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-qr-code"></i> QR Code</h2>
        <button class="modal-close" onclick="closeModal('qrModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="qr-modal-content">
          <img id="qrImage" width="200" height="200" style="display:block;margin:0 auto;border-radius:8px;">
          <p style="margin-top:16px;color:var(--text-muted);font-size:13px;">Scan to view this SOP</p>
          <div class="qr-url" id="qrUrl"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('qrModal')">Close</button>
        <button class="header-btn primary" onclick="downloadQR()"><i class="ph-duotone ph-download"></i> Download</button>
      </div>
    </div>
  </div>

  <!-- PDF Modal -->
  <div class="modal" id="pdfModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-file-pdf"></i> Export PDF</h2>
        <button class="modal-close" onclick="closeModal('pdfModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Layout</label>
          <div class="pdf-layout-options">
            <label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="text"><div class="pdf-layout-card"><div class="pdf-layout-preview"><div class="line"></div><div class="line"></div><div class="line short"></div></div><span>Text Only</span></div></label>
            <label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="2col" checked><div class="pdf-layout-card"><div class="pdf-layout-preview grid-preview cols-1"><div class="box"></div><div class="box"></div></div><span>2 Per Page</span></div></label>
            <label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="4col"><div class="pdf-layout-card"><div class="pdf-layout-preview grid-preview cols-2"><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div></div><span>4 Per Page</span></div></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Options</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="pdfIncludeQR" checked> Include QR Code</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="pdfBilingual"> Bilingual (EN + ES)</label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Language</label>
          <div style="display:flex;gap:8px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="radio" name="pdfLang" value="en" checked> English</label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="radio" name="pdfLang" value="es"> Español</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('pdfModal')">Cancel</button>
        <button class="header-btn primary" onclick="generatePDF()" id="generatePdfBtn"><i class="ph-duotone ph-file-pdf"></i> Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-gear"></i> Settings</h2>
        <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-sparkle"></i> AI Features</div>
          <div style="padding:12px;background:var(--green-dim);border-radius:8px;border-left:3px solid var(--green);margin-bottom:12px;">
            <i class="ph-duotone ph-check-circle" style="color:var(--green);"></i> <strong>AI Features Ready!</strong> API key is securely stored on the server.
          </div>
          <button class="header-btn primary" onclick="testApiConnection()" style="width:100%;"><i class="ph-duotone ph-plugs-connected"></i> Test Connection</button>
          <div id="apiKeyStatus" style="margin-top:10px;font-size:12px;padding:10px;background:var(--bg);border-radius:6px;"></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-buildings"></i> Departments</div>
          <div class="settings-list" id="settingsDeptList"></div>
          <div class="settings-add-form">
            <input type="text" id="newDeptInput" placeholder="New department..." onkeypress="if(event.key==='Enter')addDepartment()">
            <button class="settings-add-btn" onclick="addDepartment()"><i class="ph-duotone ph-plus"></i></button>
          </div>
          <div class="settings-note">At least one department required</div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-tag"></i> Tags</div>
          <div class="settings-list" id="settingsTagList"></div>
          <div class="settings-add-form">
            <input type="text" id="newTagInput" placeholder="New tag..." onkeypress="if(event.key==='Enter')addTag()">
            <div class="tag-color-picker">
              <div class="tag-color-option gold selected" data-color="gold" onclick="selectTagColor('gold')"></div>
              <div class="tag-color-option green" data-color="green" onclick="selectTagColor('green')"></div>
              <div class="tag-color-option sungrown" data-color="sungrown" onclick="selectTagColor('sungrown')"></div>
              <div class="tag-color-option greenhouse" data-color="greenhouse" onclick="selectTagColor('greenhouse')"></div>
              <div class="tag-color-option indoor" data-color="indoor" onclick="selectTagColor('indoor')"></div>
              <div class="tag-color-option danger" data-color="danger" onclick="selectTagColor('danger')"></div>
            </div>
            <button class="settings-add-btn" onclick="addTag()"><i class="ph-duotone ph-plus"></i></button>
          </div>
          <div class="settings-note">At least one tag required</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn primary" onclick="closeModal('settingsModal')"><i class="ph-duotone ph-check"></i> Done</button>
      </div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div class="modal" id="requestsModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-clipboard-text"></i> SOP Requests</h2>
        <button class="modal-close" onclick="closeModal('requestsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="requests-tabs">
          <button class="requests-tab active" onclick="setRequestTab('pending')" id="tabPending">Pending <span class="tab-count" id="pendingCount">0</span></button>
          <button class="requests-tab" onclick="setRequestTab('completed')" id="tabCompleted">Completed <span class="tab-count" id="completedCount">0</span></button>
        </div>
        <div class="add-request-form" id="addRequestForm">
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">New Request Title *</label>
            <input type="text" class="form-input" id="reqTitle" placeholder="e.g., Trimming Machine Cleaning Procedure">
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Department</label>
              <select class="form-input" id="reqDept"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Priority</label>
              <select class="form-input" id="reqPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Assign To</label>
              <input type="text" class="form-input" id="reqAssignee" placeholder="Name or leave blank">
            </div>
            <div class="form-group">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-input" id="reqDueDate">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">Notes / Description</label>
            <textarea class="form-input" id="reqNotes" placeholder="What should this SOP cover?" rows="2"></textarea>
          </div>
          <button class="header-btn primary" onclick="addRequest()" style="width:100%;"><i class="ph-duotone ph-plus"></i> Add Request</button>
        </div>
        <div class="request-list" id="requestList"></div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('requestsModal')">Close</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><i class="ph-duotone ph-check-circle"></i><span id="toastMsg"></span></div>

  <script>
    // =====================================================
    // API Configuration - Google Sheets Backend
    // =====================================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyyDNEHl78fewANzo_9j2zvMES_4HIFOdD8QbwE52kdhJOcWfwig7vcSV53cQal7bQj/exec';
    
    // =====================================================
    // State
    // =====================================================
    let sops = [];
    let sopRequests = [];
    let currentSopId = null;
    let editingSteps = [];
    let selectedTagColor = 'gold';
    let editLang = 'en';
    let viewLang = 'en';
    let currentRequestTab = 'pending';
    let appLang = 'en';
    let isLoading = false;
    
    let settings = {
      departments: [
        {name:'Production',icon:'ph-factory'},
        {name:'Packaging',icon:'ph-package'},
        {name:'Quality',icon:'ph-seal-check'},
        {name:'Maintenance',icon:'ph-wrench'}
      ],
      tags: [
        {name:'safety',color:'danger'},
        {name:'quality',color:'green'},
        {name:'critical',color:'gold'}
      ]
    };
    
    // =====================================================
    // Data Loading & Saving (API-based)
    // =====================================================
    
    async function loadData() {
      isLoading = true;
      showLoading();
      
      try {
        // Load SOPs
        const sopsResponse = await fetch(API_URL + '?action=getSOPs');
        const sopsResult = await sopsResponse.json();
        if (sopsResult.success) {
          sops = sopsResult.data || [];
        } else {
          console.error('Failed to load SOPs:', sopsResult.error);
          sops = [];
        }
        
        // Load Requests
        const reqResponse = await fetch(API_URL + '?action=getRequests');
        const reqResult = await reqResponse.json();
        if (reqResult.success) {
          sopRequests = reqResult.data || [];
        } else {
          sopRequests = [];
        }
        
        // Load Settings
        const settingsResponse = await fetch(API_URL + '?action=getSettings');
        const settingsResult = await settingsResponse.json();
        if (settingsResult.success && settingsResult.data) {
          if (settingsResult.data.departments) settings.departments = settingsResult.data.departments;
          if (settingsResult.data.tags) settings.tags = settingsResult.data.tags;
        }
        
      } catch (e) {
        console.error('Error loading data:', e);
        showToast('Error loading data: ' + e.message, 'error');
      }
      
      isLoading = false;
      hideLoading();
      renderSOPs();
      updateStats();
      updateDropdowns();
    }
    
    async function saveSOP(status) {
      const title = document.getElementById('sopTitle').value.trim();
      const dept = document.getElementById('sopDept').value;
      
      if (!title) { showToast('Enter title', 'error'); return; }
      if (!dept) { showToast('Select department', 'error'); return; }
      if (editingSteps.length === 0) { showToast('Add at least 1 step', 'error'); return; }
      
      const sopData = {
        id: currentSopId,
        title: title,
        title_es: window.sopTranslations?.title_es || '',
        dept: dept,
        docNum: document.getElementById('sopDocNum').value.trim() || generateDocNum(),
        revision: document.getElementById('sopRevision').value.trim() || '1.0',
        status: status,
        description: document.getElementById('sopDesc').value.trim(),
        desc_es: window.sopTranslations?.desc_es || '',
        tags: getSelectedTags(),
        steps: editingSteps.map(s => ({
          title: s.title || '',
          title_es: s.title_es || '',
          description: s.description || '',
          desc_es: s.desc_es || '',
          image: s.image || '',
          safety: s.safety || false,
          quality: s.quality || false
        }))
      };
      
      showLoading();
      
      try {
        const action = currentSopId ? 'updateSOP' : 'createSOP';
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: action, sop: sopData })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(status === 'published' ? 'Published!' : 'Saved!', 'success');
          closeModal('editModal');
          await loadData();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      } catch (e) {
        showToast('Error saving: ' + e.message, 'error');
      }
      
      hideLoading();
    }
    
    async function deleteSOP(id) {
      if (!confirm('Delete this SOP?')) return;
      
      showLoading();
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'deleteSOP', id: id })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('Deleted', 'success');
          await loadData();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      } catch (e) {
        showToast('Error deleting: ' + e.message, 'error');
      }
      
      hideLoading();
    }
    
    async function addRequest() {
      const title = document.getElementById('reqTitle').value.trim();
      if (!title) { showToast('Enter title', 'error'); return; }
      
      const reqData = {
        title: title,
        dept: document.getElementById('reqDept').value,
        priority: document.getElementById('reqPriority').value,
        assignee: document.getElementById('reqAssignee').value.trim(),
        dueDate: document.getElementById('reqDueDate').value,
        notes: document.getElementById('reqNotes').value.trim()
      };
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'createRequest', request: reqData })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('Request added', 'success');
          document.getElementById('reqTitle').value = '';
          document.getElementById('reqNotes').value = '';
          await loadData();
          renderRequests();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    
    async function completeRequest(id) {
      const req = sopRequests.find(r => r.id == id);
      if (!req) return;
      
      req.completed = true;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'updateRequest', request: req })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('Marked complete', 'success');
          await loadData();
          renderRequests();
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    
    async function deleteRequest(id) {
      if (!confirm('Delete this request?')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'deleteRequest', id: id })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('Deleted', 'success');
          await loadData();
          renderRequests();
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    
    // =====================================================
    // UI Rendering
    // =====================================================
    
    function showLoading() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('sopGrid').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }
    
    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }
    
    function renderSOPs() {
      const grid = document.getElementById('sopGrid');
      const tbody = document.getElementById('sopTableBody');
      const empty = document.getElementById('emptyState');
      
      const filtered = getFilteredSOPs();
      
      if (filtered.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      grid.style.display = 'grid';
      
      // Grid view
      grid.innerHTML = filtered.map(s => {
        const firstImg = s.steps && s.steps.length > 0 && s.steps[0].image ? s.steps[0].image : null;
        const tags = (s.tags || []).slice(0, 3).map(t => {
          const tagDef = settings.tags.find(x => x.name === t);
          const color = tagDef ? tagDef.color : 'gold';
          return '<span class="sop-tag ' + color + '">' + esc(t) + '</span>';
        }).join('');
        
        return '<div class="sop-card" onclick="viewSOP(' + s.id + ')">' +
          '<div class="sop-card-header">' +
            '<div><div class="sop-card-title">' + esc(s.title) + '</div>' +
            '<div class="sop-card-dept"><i class="ph-duotone ph-folder"></i> ' + esc(s.dept) + '</div></div>' +
            '<span class="sop-card-rev ' + (s.status === 'draft' ? 'draft' : '') + '">' + (s.status === 'draft' ? 'Draft' : 'v' + s.revision) + '</span>' +
          '</div>' +
          '<div class="sop-card-preview">' + 
            (firstImg ? '<img src="' + firstImg + '" onerror="this.outerHTML=\'<div class=sop-card-preview-empty><i class=ph-duotone\\ ph-image></i>No image</div>\'">' : '<div class="sop-card-preview-empty"><i class="ph-duotone ph-image"></i>No image</div>') +
          '</div>' +
          '<div class="sop-card-meta">' +
            '<div class="sop-card-steps"><i class="ph-duotone ph-list-numbers"></i> ' + (s.steps ? s.steps.length : 0) + ' steps</div>' +
            '<div class="sop-card-tags">' + tags + '</div>' +
          '</div>' +
          '<div class="sop-card-actions">' +
            '<button onclick="event.stopPropagation();viewSOP(' + s.id + ')"><i class="ph-duotone ph-eye"></i></button>' +
            '<button class="qr-btn" onclick="event.stopPropagation();showQR(' + s.id + ')"><i class="ph-duotone ph-qr-code"></i></button>' +
            '<button onclick="event.stopPropagation();editSOP(' + s.id + ')"><i class="ph-duotone ph-pencil-simple"></i></button>' +
            '<button class="del-btn" onclick="event.stopPropagation();deleteSOP(' + s.id + ')"><i class="ph-duotone ph-trash"></i></button>' +
          '</div>' +
        '</div>';
      }).join('');
      
      // Table view
      tbody.innerHTML = filtered.map(s => {
        return '<tr onclick="viewSOP(' + s.id + ')">' +
          '<td class="title-cell">' + esc(s.title) + '</td>' +
          '<td>' + esc(s.dept) + '</td>' +
          '<td>' + (s.steps ? s.steps.length : 0) + '</td>' +
          '<td><span class="sop-card-rev ' + (s.status === 'draft' ? 'draft' : '') + '">' + (s.status === 'draft' ? 'Draft' : 'Published') + '</span></td>' +
          '<td>' + fmtDate(s.updatedAt) + '</td>' +
          '<td class="actions-cell">' +
            '<button onclick="event.stopPropagation();editSOP(' + s.id + ')"><i class="ph-duotone ph-pencil-simple"></i></button>' +
            '<button onclick="event.stopPropagation();deleteSOP(' + s.id + ')"><i class="ph-duotone ph-trash"></i></button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function getFilteredSOPs() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const dept = document.getElementById('deptFilter').value;
      const tag = document.getElementById('tagFilter').value;
      
      return sops.filter(s => {
        if (search && !s.title.toLowerCase().includes(search) && !(s.description || '').toLowerCase().includes(search)) return false;
        if (status && s.status !== status) return false;
        if (dept && s.dept !== dept) return false;
        if (tag && !(s.tags || []).includes(tag)) return false;
        return true;
      });
    }
    
    function filterSOPs() {
      renderSOPs();
    }
    
    function updateStats() {
      document.getElementById('statTotal').textContent = sops.length;
      document.getElementById('statPublished').textContent = sops.filter(s => s.status === 'published').length;
      document.getElementById('statDrafts').textContent = sops.filter(s => s.status === 'draft').length;
      
      const pendingRequests = sopRequests.filter(r => !r.completed).length;
      document.getElementById('statRequests').textContent = pendingRequests;
      
      const badge = document.getElementById('requestBadge');
      if (pendingRequests > 0) {
        badge.textContent = pendingRequests;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
      
      const thisMonth = new Date();
      const monthStart = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
      document.getElementById('statMonth').textContent = sops.filter(s => new Date(s.createdAt || s.updatedAt) >= monthStart).length;
    }
    
    function updateDropdowns() {
      const deptFilter = document.getElementById('deptFilter');
      const sopDept = document.getElementById('sopDept');
      const reqDept = document.getElementById('reqDept');
      const tagFilter = document.getElementById('tagFilter');
      
      deptFilter.innerHTML = '<option value="">All Departments</option>' + settings.departments.map(d => '<option value="' + d.name + '">' + d.name + '</option>').join('');
      sopDept.innerHTML = '<option value="">Select department...</option>' + settings.departments.map(d => '<option value="' + d.name + '">' + d.name + '</option>').join('');
      reqDept.innerHTML = '<option value="">Any</option>' + settings.departments.map(d => '<option value="' + d.name + '">' + d.name + '</option>').join('');
      tagFilter.innerHTML = '<option value="">All Tags</option>' + settings.tags.map(t => '<option value="' + t.name + '">' + t.name.charAt(0).toUpperCase() + t.name.slice(1) + '</option>').join('');
      
      renderEditTags();
    }
    
    function renderEditTags() {
      const list = document.getElementById('editTagsList');
      list.innerHTML = settings.tags.map(t => 
        '<div class="tag-item"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="tag_' + t.name + '"><span class="sop-tag ' + t.color + '">' + t.name + '</span></label></div>'
      ).join('') + '<button type="button" class="add-tag-btn" onclick="showInlineAdd(\'tag\')"><i class="ph-duotone ph-plus"></i> Add</button>';
      renderInlineTagColors();
    }
    
    function getSelectedTags() {
      return settings.tags.filter(t => {
        const cb = document.getElementById('tag_' + t.name);
        return cb && cb.checked;
      }).map(t => t.name);
    }
    
    function renderRequests() {
      const list = document.getElementById('requestList');
      const pending = sopRequests.filter(r => !r.completed);
      const completed = sopRequests.filter(r => r.completed);
      
      document.getElementById('pendingCount').textContent = pending.length;
      document.getElementById('completedCount').textContent = completed.length;
      
      const reqs = currentRequestTab === 'pending' ? pending : completed;
      
      if (reqs.length === 0) {
        list.innerHTML = '<div class="request-empty"><i class="ph-duotone ph-clipboard"></i><p>' + (currentRequestTab === 'pending' ? 'No pending requests' : 'No completed requests') + '</p></div>';
        return;
      }
      
      list.innerHTML = reqs.map(r => {
        const isOverdue = r.dueDate && new Date(r.dueDate) < new Date() && !r.completed;
        return '<div class="request-item ' + (r.completed ? 'completed' : '') + '">' +
          '<div class="request-item-header">' +
            '<div class="request-item-title">' + esc(r.title) + '</div>' +
            '<span class="request-item-priority ' + r.priority + '">' + r.priority + '</span>' +
          '</div>' +
          (r.notes ? '<div class="request-item-desc">' + esc(r.notes) + '</div>' : '') +
          '<div class="request-item-meta">' +
            (r.dept ? '<span><i class="ph-duotone ph-folder"></i>' + esc(r.dept) + '</span>' : '') +
            (r.assignee ? '<span><i class="ph-duotone ph-user"></i>' + esc(r.assignee) + '</span>' : '') +
            (r.dueDate ? '<span' + (isOverdue ? ' style="color:var(--danger)"' : '') + '><i class="ph-duotone ph-calendar"></i>' + r.dueDate + (isOverdue ? ' OVERDUE' : '') + '</span>' : '') +
            '<span><i class="ph-duotone ph-clock"></i>Created ' + fmtDate(r.createdAt) + '</span>' +
          '</div>' +
          '<div class="request-item-actions">' +
            (!r.completed ? '<button class="request-action-create" onclick="createSOPFromRequest(' + r.id + ')"><i class="ph-duotone ph-file-plus"></i> Create SOP</button>' : '') +
            (!r.completed ? '<button class="request-action-complete" onclick="completeRequest(' + r.id + ')"><i class="ph-duotone ph-check"></i> Done</button>' : '') +
            '<button class="request-action-delete" onclick="deleteRequest(' + r.id + ')"><i class="ph-duotone ph-trash"></i></button>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    // =====================================================
    // Modal Management
    // =====================================================
    
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }
    
    function openCreateModal() {
      currentSopId = null;
      editingSteps = [{ title: '', description: '', image: '', safety: false, quality: false }];
      window.sopTranslations = {};
      
      document.getElementById('modalTitle').innerHTML = '<i class="ph-duotone ph-file-text"></i> Create New SOP';
      document.getElementById('sopTitle').value = '';
      document.getElementById('sopDept').value = '';
      document.getElementById('sopDocNum').value = '';
      document.getElementById('sopRevision').value = '1.0';
      document.getElementById('sopStatus').value = 'draft';
      document.getElementById('sopDesc').value = '';
      
      settings.tags.forEach(t => {
        const cb = document.getElementById('tag_' + t.name);
        if (cb) cb.checked = false;
      });
      
      renderSteps();
      openModal('editModal');
    }
    
    function editSOP(id) {
      const s = sops.find(x => x.id == id);
      if (!s) return;
      
      currentSopId = id;
      editingSteps = (s.steps || []).map(st => ({ ...st }));
      if (editingSteps.length === 0) {
        editingSteps = [{ title: '', description: '', image: '', safety: false, quality: false }];
      }
      
      window.sopTranslations = {
        title_es: s.title_es || '',
        desc_es: s.desc_es || ''
      };
      
      document.getElementById('modalTitle').innerHTML = '<i class="ph-duotone ph-pencil-simple"></i> Edit SOP';
      document.getElementById('sopTitle').value = s.title;
      document.getElementById('sopDept').value = s.dept;
      document.getElementById('sopDocNum').value = s.docNum || '';
      document.getElementById('sopRevision').value = s.revision || '1.0';
      document.getElementById('sopStatus').value = s.status || 'draft';
      document.getElementById('sopDesc').value = s.description || '';
      
      settings.tags.forEach(t => {
        const cb = document.getElementById('tag_' + t.name);
        if (cb) cb.checked = (s.tags || []).includes(t.name);
      });
      
      renderSteps();
      openModal('editModal');
    }
    
    function editCurrentSOP() {
      closeModal('viewModal');
      editSOP(currentSopId);
    }
    
    function viewSOP(id) {
      const s = sops.find(x => x.id == id);
      if (!s) return;
      
      currentSopId = id;
      viewLang = 'en';
      document.querySelectorAll('#viewLangToggle button').forEach(b => b.classList.toggle('active', b.textContent === 'EN'));
      renderViewSOP(s);
      openModal('viewModal');
    }
    
    function renderViewSOP(s) {
      if (!s) return;
      const lang = viewLang;
      const title = s['title_' + lang] || s.title;
      const desc = s['desc_' + lang] || s.description;
      const u = window.location.origin + window.location.pathname + '?view=' + s.id;
      
      const stepsHtml = (s.steps || []).map((st, i) => {
        const stepTitle = st['title_' + lang] || st.title;
        const stepDesc = st['desc_' + lang] || st.description;
        return '<div class="view-step"><div class="view-step-number">' + (i + 1) + '</div><div class="view-step-content"><div class="view-step-title">' + esc(stepTitle) + (st.safety ? ' <i class="ph-duotone ph-warning icon safety"></i>' : '') + (st.quality ? ' <i class="ph-duotone ph-seal-check icon quality"></i>' : '') + '</div><div class="view-step-desc">' + esc(stepDesc) + '</div></div>' + (st.image ? '<div class="view-step-image"><img src="' + st.image + '"></div>' : '') + '</div>';
      }).join('');
      
      document.getElementById('viewModalBody').innerHTML = 
        '<div class="view-sop-header"><div><div class="view-sop-title">' + esc(title) + '</div>' +
        '<div class="view-sop-meta">' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-folder"></i> ' + s.dept + '</div>' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-hash"></i> ' + (s.docNum || 'N/A') + '</div>' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-git-branch"></i> Rev ' + (s.revision || '1.0') + '</div>' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-calendar"></i> ' + fmtDate(s.updatedAt) + '</div>' +
        '</div>' +
        (desc ? '<p style="margin-top:12px;color:var(--text-muted)">' + esc(desc) + '</p>' : '') +
        '</div>' +
        '<div class="view-sop-qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=78x78&data=' + encodeURIComponent(u) + '" width="78" height="78"></div></div>' +
        stepsHtml;
    }
    
    function showQR(id) {
      const s = sops.find(x => x.id == id);
      if (!s) return;
      
      currentSopId = id;
      const u = window.location.origin + window.location.pathname + '?view=' + id;
      document.getElementById('qrImage').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(u);
      document.getElementById('qrUrl').textContent = u;
      openModal('qrModal');
    }
    
    function downloadQR() {
      const img = document.getElementById('qrImage');
      const a = document.createElement('a');
      a.href = img.src;
      a.download = 'sop-qr-' + currentSopId + '.png';
      a.click();
    }
    
    function openRequestsModal() {
      renderRequests();
      openModal('requestsModal');
    }
    
    function openSettingsModal() {
      renderSettingsDepts();
      renderSettingsTags();
      openModal('settingsModal');
    }
    
    function setRequestTab(tab) {
      currentRequestTab = tab;
      document.getElementById('tabPending').classList.toggle('active', tab === 'pending');
      document.getElementById('tabCompleted').classList.toggle('active', tab === 'completed');
      document.getElementById('addRequestForm').style.display = tab === 'pending' ? 'block' : 'none';
      renderRequests();
    }
    
    function createSOPFromRequest(id) {
      const req = sopRequests.find(r => r.id == id);
      if (!req) return;
      
      closeModal('requestsModal');
      openCreateModal();
      
      document.getElementById('sopTitle').value = req.title;
      if (req.dept) document.getElementById('sopDept').value = req.dept;
    }
    
    // =====================================================
    // Steps Management
    // =====================================================
    
    function renderSteps() {
      const list = document.getElementById('stepsList');
      list.innerHTML = editingSteps.map((s, i) => 
        '<div class="step-item" data-index="' + i + '">' +
          '<div class="step-number">' + (i + 1) + '</div>' +
          '<div class="step-content">' +
            '<input type="text" class="step-title-input" placeholder="Step title..." value="' + esc(s.title) + '" onchange="updateStep(' + i + ',\'title\',this.value)">' +
            '<textarea class="step-desc-input" placeholder="Description..." onchange="updateStep(' + i + ',\'description\',this.value)">' + esc(s.description) + '</textarea>' +
            '<div class="step-icons">' +
              '<button type="button" class="step-icon-btn safety ' + (s.safety ? 'active' : '') + '" onclick="toggleStepFlag(' + i + ',\'safety\')" title="Safety Warning"><i class="ph-duotone ph-warning"></i></button>' +
              '<button type="button" class="step-icon-btn quality ' + (s.quality ? 'active' : '') + '" onclick="toggleStepFlag(' + i + ',\'quality\')" title="Quality Checkpoint"><i class="ph-duotone ph-seal-check"></i></button>' +
            '</div>' +
          '</div>' +
          '<div class="step-image">' +
            '<div class="step-image-preview ' + (s.image ? 'has-image' : '') + '" onclick="promptStepImage(' + i + ')">' +
              (s.image ? '<img src="' + s.image + '">' : '<div class="placeholder"><i class="ph-duotone ph-image"></i>Add image</div>') +
            '</div>' +
          '</div>' +
          '<div class="step-actions">' +
            '<button type="button" class="step-ai-btn" onclick="aiImproveStep(' + i + ')" title="AI Improve"><i class="ph-duotone ph-sparkle"></i></button>' +
            '<button type="button" class="step-action-btn" onclick="moveStep(' + i + ',-1)" title="Move Up"><i class="ph-duotone ph-caret-up"></i></button>' +
            '<button type="button" class="step-action-btn" onclick="moveStep(' + i + ',1)" title="Move Down"><i class="ph-duotone ph-caret-down"></i></button>' +
            '<button type="button" class="step-action-btn delete" onclick="removeStep(' + i + ')" title="Delete"><i class="ph-duotone ph-trash"></i></button>' +
          '</div>' +
        '</div>'
      ).join('');
    }
    
    function addStep() {
      editingSteps.push({ title: '', description: '', image: '', safety: false, quality: false });
      renderSteps();
    }
    
    function removeStep(i) {
      if (editingSteps.length === 1) {
        showToast('Need at least 1 step', 'error');
        return;
      }
      editingSteps.splice(i, 1);
      renderSteps();
    }
    
    function updateStep(i, field, value) {
      editingSteps[i][field] = value;
    }
    
    function toggleStepFlag(i, flag) {
      editingSteps[i][flag] = !editingSteps[i][flag];
      renderSteps();
    }
    
    function moveStep(i, dir) {
      const newIndex = i + dir;
      if (newIndex < 0 || newIndex >= editingSteps.length) return;
      [editingSteps[i], editingSteps[newIndex]] = [editingSteps[newIndex], editingSteps[i]];
      renderSteps();
    }
    
    function promptStepImage(i) {
      const url = prompt('Enter image URL:', editingSteps[i].image || '');
      if (url !== null) {
        editingSteps[i].image = url;
        renderSteps();
      }
    }
    
    // =====================================================
    // Settings Management
    // =====================================================
    
    function renderSettingsDepts() {
      document.getElementById('settingsDeptList').innerHTML = settings.departments.map(d => 
        '<div class="settings-item"><i class="ph-duotone ' + (d.icon || 'ph-folder') + '"></i><span>' + d.name + '</span><button class="item-delete" onclick="deleteDepartment(\'' + d.name + '\')"><i class="ph-duotone ph-x"></i></button></div>'
      ).join('');
    }
    
    function renderSettingsTags() {
      document.getElementById('settingsTagList').innerHTML = settings.tags.map(t => 
        '<div class="settings-item"><span class="sop-tag ' + t.color + '">' + t.name + '</span><button class="item-delete" onclick="deleteTag(\'' + t.name + '\')"><i class="ph-duotone ph-x"></i></button></div>'
      ).join('');
    }
    
    function addDepartment() {
      const input = document.getElementById('newDeptInput');
      const name = input.value.trim();
      if (!name) return;
      if (settings.departments.find(d => d.name.toLowerCase() === name.toLowerCase())) {
        showToast('Already exists', 'error');
        return;
      }
      settings.departments.push({ name: name, icon: 'ph-folder' });
      saveSettingsToServer();
      renderSettingsDepts();
      updateDropdowns();
      input.value = '';
      showToast('Added', 'success');
    }
    
    function deleteDepartment(name) {
      if (settings.departments.length <= 1) {
        showToast('Need at least 1', 'error');
        return;
      }
      settings.departments = settings.departments.filter(d => d.name !== name);
      saveSettingsToServer();
      renderSettingsDepts();
      updateDropdowns();
      showToast('Deleted', 'success');
    }
    
    function selectTagColor(color) {
      selectedTagColor = color;
      document.querySelectorAll('.tag-color-option').forEach(e => e.classList.toggle('selected', e.dataset.color === color));
    }
    
    function addTag() {
      const input = document.getElementById('newTagInput');
      const name = input.value.trim().toLowerCase();
      if (!name) return;
      if (settings.tags.find(t => t.name === name)) {
        showToast('Already exists', 'error');
        return;
      }
      settings.tags.push({ name: name, color: selectedTagColor });
      saveSettingsToServer();
      renderSettingsTags();
      updateDropdowns();
      input.value = '';
      showToast('Added', 'success');
    }
    
    function deleteTag(name) {
      if (settings.tags.length <= 1) {
        showToast('Need at least 1', 'error');
        return;
      }
      settings.tags = settings.tags.filter(t => t.name !== name);
      saveSettingsToServer();
      renderSettingsTags();
      updateDropdowns();
      showToast('Deleted', 'success');
    }
    
    async function saveSettingsToServer() {
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'saveSettings', settings: settings })
        });
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }
    
    function showInlineAdd(type) {
      document.getElementById('inlineAdd' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'block';
    }
    
    function hideInlineAdd(type) {
      document.getElementById('inlineAdd' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'none';
    }
    
    function addDeptInline() {
      const input = document.getElementById('newDeptInline');
      const name = input.value.trim();
      if (!name) return;
      if (settings.departments.find(d => d.name.toLowerCase() === name.toLowerCase())) {
        showToast('Already exists', 'error');
        return;
      }
      settings.departments.push({ name: name, icon: 'ph-folder' });
      saveSettingsToServer();
      updateDropdowns();
      document.getElementById('sopDept').value = name;
      input.value = '';
      hideInlineAdd('dept');
      showToast('Added', 'success');
    }
    
    function renderInlineTagColors() {
      const container = document.getElementById('inlineTagColors');
      if (!container) return;
      const colors = ['gold', 'green', 'sungrown', 'greenhouse', 'indoor', 'danger'];
      container.innerHTML = colors.map(c => 
        '<div class="color-dot ' + (c === selectedTagColor ? 'selected' : '') + '" style="background:var(--' + c + ')" onclick="selectInlineTagColor(\'' + c + '\')"></div>'
      ).join('');
    }
    
    function selectInlineTagColor(color) {
      selectedTagColor = color;
      renderInlineTagColors();
    }
    
    function addTagInline() {
      const input = document.getElementById('newTagInline');
      const name = input.value.trim().toLowerCase();
      if (!name) return;
      if (settings.tags.find(t => t.name === name)) {
        showToast('Already exists', 'error');
        return;
      }
      settings.tags.push({ name: name, color: selectedTagColor });
      saveSettingsToServer();
      updateDropdowns();
      input.value = '';
      hideInlineAdd('tag');
      showToast('Added', 'success');
    }
    
    // =====================================================
    // AI Features
    // =====================================================
    
    async function callAI(prompt) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'anthropic',
            body: {
              model: 'claude-3-5-haiku-20241022',
              max_tokens: 500,
              messages: [{ role: 'user', content: prompt }]
            }
          })
        });
        
        const data = await response.json();
        if (data.content && data.content[0]) {
          return data.content[0].text.trim();
        }
        return null;
      } catch (e) {
        console.error('AI error:', e);
        return null;
      }
    }
    
    async function aiImproveTitle() {
      const input = document.getElementById('sopTitle');
      const current = input.value.trim();
      if (!current) { showToast('Enter text first', 'error'); return; }
      
      const btn = document.querySelector('[onclick="aiImproveTitle()"]');
      btn.disabled = true;
      btn.classList.add('loading');
      
      const improved = await callAI('Improve this SOP title to be clearer, more professional, and action-oriented. Keep it concise (under 10 words). Only return the improved title, nothing else:\n\n' + current);
      
      if (improved) {
        input.value = improved;
        showToast('Title improved!', 'success');
      } else {
        showToast('AI unavailable', 'error');
      }
      
      btn.disabled = false;
      btn.classList.remove('loading');
    }
    
    async function aiImproveDescription() {
      const input = document.getElementById('sopDesc');
      const current = input.value.trim();
      if (!current) { showToast('Enter text first', 'error'); return; }
      
      const btn = document.querySelector('[onclick="aiImproveDescription()"]');
      btn.disabled = true;
      btn.classList.add('loading');
      
      const improved = await callAI('Improve this SOP description to be clearer and more professional. Keep it brief (2-3 sentences max). Only return the improved description:\n\n' + current);
      
      if (improved) {
        input.value = improved;
        showToast('Description improved!', 'success');
      } else {
        showToast('AI unavailable', 'error');
      }
      
      btn.disabled = false;
      btn.classList.remove('loading');
    }
    
    async function aiImproveStep(i) {
      const step = editingSteps[i];
      if (!step.title && !step.description) {
        showToast('Enter text first', 'error');
        return;
      }
      
      const btn = document.querySelectorAll('.step-ai-btn')[i];
      btn.disabled = true;
      
      const improved = await callAI('Improve this SOP step. Make the title action-oriented and clear. Make the description specific with measurable details where possible. Return as JSON: {"title": "...", "description": "..."}\n\nCurrent title: ' + (step.title || 'None') + '\nCurrent description: ' + (step.description || 'None'));
      
      if (improved) {
        try {
          const parsed = JSON.parse(improved);
          if (parsed.title) editingSteps[i].title = parsed.title;
          if (parsed.description) editingSteps[i].description = parsed.description;
          renderSteps();
          showToast('Step improved!', 'success');
        } catch (e) {
          showToast('AI response error', 'error');
        }
      } else {
        showToast('AI unavailable', 'error');
      }
      
      btn.disabled = false;
    }
    
    async function aiImproveAllSteps() {
      const btn = document.getElementById('aiImproveAllBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      
      for (let i = 0; i < editingSteps.length; i++) {
        if (editingSteps[i].title || editingSteps[i].description) {
          await aiImproveStep(i);
        }
      }
      
      btn.disabled = false;
      btn.classList.remove('loading');
      showToast('All steps improved!', 'success');
    }
    
    async function testApiConnection() {
      const status = document.getElementById('apiKeyStatus');
      status.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite"></i> Testing...';
      
      try {
        const response = await fetch(API_URL + '?action=test');
        const result = await response.json();
        
        if (result.success) {
          status.innerHTML = '<i class="ph-duotone ph-check-circle" style="color:var(--green)"></i> Connection successful!';
        } else {
          status.innerHTML = '<i class="ph-duotone ph-x-circle" style="color:var(--danger)"></i> ' + result.error;
        }
      } catch (e) {
        status.innerHTML = '<i class="ph-duotone ph-x-circle" style="color:var(--danger)"></i> Connection failed: ' + e.message;
      }
    }
    
    // =====================================================
    // Translation
    // =====================================================
    
    async function translateText(text, from, to) {
      if (!text || text.trim() === '') return '';
      
      const fromLang = from === 'en' ? 'English' : 'Spanish';
      const toLang = to === 'en' ? 'English' : 'Spanish';
      
      const translated = await callAI('Translate the following text from ' + fromLang + ' to ' + toLang + '. This is for a cannabis production facility SOP. Only return the translation:\n\n' + text);
      return translated || text;
    }
    
    function setEditLang(lang) {
      editLang = lang;
      document.querySelectorAll('#editLangToggle button').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(lang === 'en' ? 'eng' : 'esp')));
      document.getElementById('translateBtnText').textContent = lang === 'en' ? 'Auto-translate to Español' : 'Auto-traducir a English';
    }
    
    async function autoTranslateSOP() {
      const btn = document.getElementById('autoTranslateBtn');
      const btnText = document.getElementById('translateBtnText');
      const origText = btnText.textContent;
      btn.disabled = true;
      btnText.textContent = 'Translating...';
      
      const fromLang = editLang;
      const toLang = editLang === 'en' ? 'es' : 'en';
      
      try {
        const title = document.getElementById('sopTitle').value;
        const desc = document.getElementById('sopDesc').value;
        
        const [transTitle, transDesc] = await Promise.all([
          translateText(title, fromLang, toLang),
          translateText(desc, fromLang, toLang)
        ]);
        
        for (let i = 0; i < editingSteps.length; i++) {
          const step = editingSteps[i];
          if (step.title) {
            step['title_' + toLang] = await translateText(step.title, fromLang, toLang);
            step['title_' + fromLang] = step.title;
          }
          if (step.description) {
            step['desc_' + toLang] = await translateText(step.description, fromLang, toLang);
            step['desc_' + fromLang] = step.description;
          }
        }
        
        window.sopTranslations = {
          ['title_' + fromLang]: title,
          ['title_' + toLang]: transTitle,
          ['desc_' + fromLang]: desc,
          ['desc_' + toLang]: transDesc
        };
        
        showToast('Translated! (' + fromLang.toUpperCase() + ' → ' + toLang.toUpperCase() + ')', 'success');
      } catch (e) {
        console.error('Translation failed:', e);
        showToast('Translation failed', 'error');
      }
      
      btn.disabled = false;
      btnText.textContent = origText;
    }
    
    async function setViewLang(lang) {
      viewLang = lang;
      document.querySelectorAll('#viewLangToggle button').forEach(b => b.classList.toggle('active', b.textContent === lang.toUpperCase()));
      const s = sops.find(x => x.id === currentSopId);
      if (!s) return;
      
      if (lang === 'es' && !s.title_es) {
        const esBtn = document.querySelector('#viewLangToggle button:last-child');
        esBtn.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite"></i>';
        esBtn.disabled = true;
        
        try {
          showToast('Translating...', 'success');
          s.title_es = await translateText(s.title, 'en', 'es');
          if (s.description) s.desc_es = await translateText(s.description, 'en', 'es');
          for (let step of (s.steps || [])) {
            if (step.title && !step.title_es) step.title_es = await translateText(step.title, 'en', 'es');
            if (step.description && !step.desc_es) step.desc_es = await translateText(step.description, 'en', 'es');
          }
          showToast('Translation complete!', 'success');
        } catch (e) {
          console.error('Translation error:', e);
          showToast('Translation failed', 'error');
        }
        
        esBtn.innerHTML = 'ES';
        esBtn.disabled = false;
      }
      
      renderViewSOP(s);
    }
    
    // =====================================================
    // PDF Generation
    // =====================================================
    
    function generatePDF() {
      const s = sops.find(x => x.id === currentSopId);
      if (!s) return;
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const lang = document.querySelector('input[name="pdfLang"]:checked').value;
      const title = s['title_' + lang] || s.title;
      const desc = s['desc_' + lang] || s.description;
      
      doc.setFontSize(20);
      doc.setTextColor(45, 58, 46);
      doc.text(title, 20, 25);
      
      doc.setFontSize(10);
      doc.setTextColor(90, 107, 95);
      doc.text('Department: ' + s.dept + '  |  Doc #: ' + (s.docNum || 'N/A') + '  |  Rev: ' + (s.revision || '1.0'), 20, 35);
      
      if (desc) {
        doc.setFontSize(11);
        doc.text(doc.splitTextToSize(desc, 170), 20, 45);
      }
      
      let y = desc ? 60 : 45;
      
      (s.steps || []).forEach((step, i) => {
        if (y > 250) {
          doc.addPage();
          y = 20;
        }
        
        const stepTitle = step['title_' + lang] || step.title;
        const stepDesc = step['desc_' + lang] || step.description;
        
        doc.setFontSize(12);
        doc.setTextColor(102, 137, 113);
        doc.text((i + 1) + '. ' + stepTitle, 20, y);
        
        if (stepDesc) {
          doc.setFontSize(10);
          doc.setTextColor(90, 107, 95);
          const lines = doc.splitTextToSize(stepDesc, 170);
          doc.text(lines, 25, y + 7);
          y += 7 + (lines.length * 5);
        }
        
        y += 10;
      });
      
      if (document.getElementById('pdfIncludeQR').checked) {
        const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=' + encodeURIComponent(window.location.origin + window.location.pathname + '?view=' + s.id);
        // Note: Would need to convert QR to base64 for proper embedding
      }
      
      doc.save('SOP-' + (s.docNum || s.id) + '.pdf');
      closeModal('pdfModal');
      showToast('PDF generated!', 'success');
    }
    
    // =====================================================
    // Utilities
    // =====================================================
    
    function setView(v) {
      document.getElementById('gridViewBtn').classList.toggle('active', v === 'grid');
      document.getElementById('listViewBtn').classList.toggle('active', v === 'list');
      document.getElementById('sopGrid').classList.toggle('hidden', v !== 'grid');
      document.getElementById('sopList').classList.toggle('active', v === 'list');
    }
    
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('sopDarkMode', document.body.classList.contains('dark-mode'));
    }
    
    function toggleAppLang() {
      appLang = appLang === 'en' ? 'es' : 'en';
      document.getElementById('appLangLabel').textContent = appLang.toUpperCase();
      localStorage.setItem('sopAppLang', appLang);
    }
    
    function refresh() {
      showToast('Refreshing...', 'success');
      loadData();
    }
    
    function generateDocNum() {
      return 'SOP-' + String(sops.length + 1).padStart(3, '0');
    }
    
    function fmtDate(d) {
      if (!d) return 'N/A';
      const date = new Date(d);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function esc(s) {
      if (!s) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function showToast(msg, type) {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      toast.className = 'toast show ' + type;
      toastMsg.textContent = msg;
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
    
    // =====================================================
    // Initialize
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load preferences
      if (localStorage.getItem('sopDarkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
      if (localStorage.getItem('sopAppLang')) {
        appLang = localStorage.getItem('sopAppLang');
        document.getElementById('appLangLabel').textContent = appLang.toUpperCase();
      }
      
      // Load data from API
      loadData();
      
      // Check for view parameter
      const urlParams = new URLSearchParams(window.location.search);
      const viewId = urlParams.get('view');
      if (viewId) {
        setTimeout(() => viewSOP(parseInt(viewId)), 1000);
      }
    });
  </script>
</body>
</html>
