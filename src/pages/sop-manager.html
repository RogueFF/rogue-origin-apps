<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/png" href="/rogue-origin-apps/favicon.png">
  <link rel="manifest" href="/rogue-origin-apps/manifest.json">
  <meta name="theme-color" content="#668971">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RO Ops">
  <link rel="apple-touch-icon" href="/rogue-origin-apps/assets/icon-apple-touch.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SOP Manager">
  <title>SOP Manager - Rogue Origin</title>

  <!-- Performance: Resource Hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://rogue-origin-apps-master.vercel.app">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=optional" rel="stylesheet">

  <!-- Scripts: Lazy loaded when needed -->
  <!-- Phosphor Icons and jsPDF are loaded on-demand -->
  
  <!-- Critical CSS: Loaded synchronously -->
  <link rel="stylesheet" href="../css/shared-base.css">
  
  <!-- Non-critical CSS: Deferred for faster initial render -->
  <link rel="preload" href="../css/sop-manager.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="../css/sop-manager.css"></noscript>
</head>
<body>
  <a href="#sop-list-container" class="skip-link">Skip to main content</a>
  <main class="main">
    <header class="header">
      <div class="header-left">
        <img src="../assets/ro-logo-square.png" alt="Rogue Origin" class="header-logo">
        <span class="header-title">Standard Operating Procedures</span>
      </div>
      <div class="header-right">
        <button class="lang-switch" onclick="toggleAppLang()" title="Switch Language"><span id="appLangLabel">EN</span> <i class="ph-duotone ph-translate"></i></button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="ph-duotone ph-moon"></i><span>Dark</span></button>
        <button class="header-btn" onclick="openSettingsModal()"><i class="ph-duotone ph-gear"></i></button>
        <button class="header-btn" onclick="openRequestsModal()" id="requestsBtn"><i class="ph-duotone ph-clipboard-text"></i> Requests <span class="request-badge" id="requestBadge" style="display:none;">0</span></button>
        <button class="header-btn" onclick="refresh()"><i class="ph-duotone ph-arrows-clockwise"></i></button>
        <button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> New SOP</button>
      </div>
    </header>
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box"><i class="ph-duotone ph-magnifying-glass"></i><input type="text" id="searchInput" placeholder="Search SOPs..." data-i18n-placeholder="searchPlaceholder" oninput="filterSOPs()"></div>
        <select class="filter-select" id="statusFilter" onchange="filterSOPs()"><option value="" data-i18n="allSOPs">All SOPs</option><option value="published" data-i18n="published">Published</option><option value="draft" data-i18n="drafts">Drafts</option></select>
        <select class="filter-select" id="deptFilter" onchange="filterSOPs()"></select>
        <select class="filter-select" id="tagFilter" onchange="filterSOPs()"></select>
      </div>
      <div class="toolbar-right">
        <div class="view-toggle">
          <button class="active" onclick="setView('grid')" id="gridViewBtn"><i class="ph-duotone ph-squares-four"></i></button>
          <button onclick="setView('list')" id="listViewBtn"><i class="ph-duotone ph-list"></i></button>
        </div>
      </div>
    </div>
    <div class="content">
      <div class="stats-bar">
        <div class="stat-card"><div class="stat-card-label" data-i18n="total">Total</div><div class="stat-card-value gold" id="statTotal">0</div></div>
        <div class="stat-card"><div class="stat-card-label" data-i18n="published">Published</div><div class="stat-card-value green" id="statPublished">0</div></div>
        <div class="stat-card"><div class="stat-card-label" data-i18n="drafts">Drafts</div><div class="stat-card-value sungrown" id="statDrafts">0</div></div>
        <div class="stat-card" style="cursor:pointer;" onclick="openRequestsModal()"><div class="stat-card-label" data-i18n="requests">Requests</div><div class="stat-card-value danger" id="statRequests">0</div></div>
        <div class="stat-card"><div class="stat-card-label" data-i18n="thisMonth">This Month</div><div class="stat-card-value indoor" id="statMonth">0</div></div>
      </div>
      <div id="loadingState" class="loading-state"><div class="spinner"></div><p data-i18n="loading">Loading SOPs from Google Sheets...</p></div>
      <div class="sop-grid" id="sopGrid" style="display:none;"></div>
      <div class="sop-list" id="sopList"><div class="sop-table"><table><thead><tr><th data-i18n="sopTitle">Title</th><th data-i18n="department">Department</th><th data-i18n="steps">Steps</th><th data-i18n="status">Status</th><th data-i18n="updated">Updated</th><th data-i18n="actions">Actions</th></tr></thead><tbody id="sopTableBody"></tbody></table></div></div>
      <div class="empty-state" id="emptyState" style="display:none;"><i class="ph-duotone ph-files"></i><h3 data-i18n="noSOPs">No SOPs Found</h3><p data-i18n="createFirst">Create your first SOP to get started.</p><button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> <span data-i18n="createSOP">Create SOP</span></button></div>
    </div>
  </main>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2 id="modalTitle"><i class="ph-duotone ph-file-text"></i> Create New SOP</h2>
        <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Tutorial Walkthrough Banner -->
        <div class="tutorial-banner" id="tutorialBanner" style="display:none;">
          <div class="tutorial-header">
            <span class="tutorial-step-label" id="tutorialStepLabel">Step 1 of 12</span>
          </div>
          <div class="tutorial-hint" id="tutorialHint">Choose which language you're writing in</div>
          <div class="tutorial-actions">
            <button type="button" class="tutorial-btn skip" id="tutorialSkipBtn" onclick="tutorialSkip()">Skip</button>
            <button type="button" class="tutorial-btn next" id="tutorialNextBtn" onclick="tutorialNext()">Next <i class="ph-bold ph-arrow-right"></i></button>
          </div>
          <div class="tutorial-progress">
            <div class="tutorial-progress-fill" id="tutorialProgressFill"></div>
          </div>
        </div>
        <!-- Tutorial Overlay - frosts background during tutorial -->
        <div class="tutorial-overlay" id="tutorialOverlay" style="display:none;"></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">SOP Title * <button type="button" class="ai-improve-btn" onclick="aiImproveTitle()" title="AI Improve"><i class="ph-duotone ph-sparkle"></i> Improve</button></label>
            <input type="text" class="form-input" id="sopTitle" placeholder="e.g., Trimming Machine Setup">
          </div>
          <div class="form-group">
            <label class="form-label">Department *</label>
            <div style="display:flex;gap:8px;">
              <select class="form-input" id="sopDept" style="flex:1;"></select>
              <button type="button" class="inline-add-btn" onclick="showInlineAdd('dept')" title="Add Department"><i class="ph-duotone ph-plus"></i></button>
            </div>
            <div class="inline-add-field" id="inlineAddDept" style="display:none;margin-top:8px;">
              <div style="display:flex;gap:8px;">
                <input type="text" class="form-input" id="newDeptInline" placeholder="New department..." style="flex:1;" onkeypress="if(event.key==='Enter'){addDeptInline();event.preventDefault();}">
                <button type="button" class="inline-add-btn save" onclick="addDeptInline()"><i class="ph-duotone ph-check"></i></button>
                <button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('dept')"><i class="ph-duotone ph-x"></i></button>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group" style="background:var(--bg);padding:14px;border-radius:10px;border:1px solid var(--border);">
          <label class="form-label" style="margin-bottom:10px;">Writing Language</label>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <div class="lang-toggle" id="editLangToggle">
              <button class="active" onclick="setEditLang('en')">English</button>
              <button onclick="setEditLang('es')">Espa√±ol</button>
            </div>
            <button type="button" class="translate-btn" id="autoTranslateBtn" onclick="autoTranslateSOP()">
              <i class="ph-duotone ph-translate"></i> <span id="translateBtnText">Auto-translate to Espa√±ol</span>
            </button>
            <span style="font-size:11px;color:var(--text-light);">Creates both language versions</span>
          </div>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label">Document Number</label>
            <input type="text" class="form-input" id="sopDocNum" placeholder="SOP-001">
          </div>
          <div class="form-group">
            <label class="form-label">Revision</label>
            <input type="text" class="form-input" id="sopRevision" value="1.0">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="sopStatus">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Description <button type="button" class="ai-improve-btn" onclick="aiImproveDescription()" title="AI Improve"><i class="ph-duotone ph-sparkle"></i> Improve</button></label>
          <textarea class="form-input" id="sopDesc" placeholder="Brief description..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div id="editTagsList" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;"></div>
          <div class="inline-add-field" id="inlineAddTag" style="display:none;margin-top:10px;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <input type="text" class="form-input" id="newTagInline" placeholder="New tag..." style="width:140px;" onkeypress="if(event.key==='Enter'){addTagInline();event.preventDefault();}">
              <div class="tag-color-picker-mini" id="inlineTagColors"></div>
              <button type="button" class="inline-add-btn save" onclick="addTagInline()"><i class="ph-duotone ph-check"></i></button>
              <button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('tag')"><i class="ph-duotone ph-x"></i></button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" data-i18n="linkedSops">Linked SOPs</label>
          <div id="editLinkedSopsList" class="linked-sops-section"></div>
          <button type="button" class="header-btn" onclick="openLinkSopModal('header')" style="margin-top:8px;">
            <i class="ph-duotone ph-link"></i> <span data-i18n="linkSop">Link SOP</span>
          </button>
        </div>
        <div class="steps-section">
          <div class="steps-header">
            <h3><i class="ph-duotone ph-list-numbers"></i> Steps</h3>
            <div style="display:flex;gap:8px;">
              <button class="ai-improve-btn" id="aiImproveAllBtn" onclick="aiImproveAllSteps()" style="padding:6px 12px;"><i class="ph-duotone ph-sparkle"></i> AI Improve All</button>
              <button class="header-btn" style="background:var(--bg);color:var(--text-muted);border:1px solid var(--border);" onclick="addStep()"><i class="ph-duotone ph-plus"></i> Add</button>
            </div>
          </div>
          <div class="steps-list" id="stepsList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('editModal')">Cancel</button>
        <button class="header-btn" onclick="saveSOP('draft')"><i class="ph-duotone ph-floppy-disk"></i> Save Draft</button>
        <button class="header-btn primary" onclick="saveSOP('published')"><i class="ph-duotone ph-check-circle"></i> Publish</button>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal" id="viewModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-eye"></i> View SOP</h2>
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="lang-toggle" id="viewLangToggle">
            <button class="active" onclick="setViewLang('en')">EN</button>
            <button onclick="setViewLang('es')">ES</button>
          </div>
          <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
        </div>
      </div>
      <div class="modal-body" id="viewModalBody"></div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('viewModal')">Close</button>
        <button class="header-btn" onclick="openModal('pdfModal')"><i class="ph-duotone ph-file-pdf"></i> PDF</button>
        <button class="header-btn primary" onclick="editCurrentSOP()"><i class="ph-duotone ph-pencil-simple"></i> Edit</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-qr-code"></i> QR Code</h2>
        <button class="modal-close" onclick="closeModal('qrModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="qr-modal-content">
          <img id="qrImage" width="200" height="200" style="display:block;margin:0 auto;border-radius:8px;">
          <p style="margin-top:16px;color:var(--text-muted);font-size:13px;">Scan to view this SOP</p>
          <div class="qr-url" id="qrUrl"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('qrModal')">Close</button>
        <button class="header-btn primary" onclick="downloadQR()"><i class="ph-duotone ph-download"></i> Download</button>
      </div>
    </div>
  </div>

  <!-- Link SOP Modal -->
  <div class="modal" id="linkSopModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-link"></i> <span data-i18n="linkSop">Link SOP</span></h2>
        <button class="modal-close" onclick="closeLinkSopModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" data-i18n="searchSops">Search SOPs</label>
          <input type="text" id="linkSopSearch" class="form-input" placeholder="Search..." oninput="filterLinkSops()">
        </div>
        <div id="linkSopList" class="link-sop-list"></div>
        <div class="form-group" style="margin-top:16px;">
          <label class="form-label" data-i18n="relationship">Relationship</label>
          <select id="linkLabelSelect" class="form-input" onchange="toggleCustomLabel()">
            <option value="Required before">Required before</option>
            <option value="See also">See also</option>
            <option value="Related">Related</option>
            <option value="Follow procedure">Follow procedure</option>
            <option value="__custom__">Other...</option>
          </select>
        </div>
        <div id="customLabelGroup" class="form-group" style="display:none;margin-top:8px;">
          <input type="text" id="customLabelEn" class="form-input" placeholder="Label (English)" style="margin-bottom:6px;">
          <input type="text" id="customLabelEs" class="form-input" placeholder="Label (Espa√±ol)">
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeLinkSopModal()" data-i18n="cancel">Cancel</button>
        <button class="header-btn primary" onclick="confirmLinkSop()" data-i18n="addLink">Add Link</button>
      </div>
    </div>
  </div>

  <!-- SOP Preview Popup -->
  <div id="sopPreviewPopup" class="sop-preview-popup" style="display:none;">
    <div class="sop-preview-header">
      <span id="previewTitle"></span>
      <span id="previewDocNum"></span>
    </div>
    <div class="sop-preview-meta" id="previewMeta"></div>
    <div class="sop-preview-desc" id="previewDesc"></div>
    <button class="sop-preview-open" onclick="openPreviewedSop()">Open Full SOP</button>
    <button class="sop-preview-close" onclick="closePreviewPopup()">&times;</button>
  </div>

  <!-- PDF Modal -->
  <div class="modal" id="pdfModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-file-pdf"></i> Export PDF</h2>
        <button class="modal-close" onclick="closeModal('pdfModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Layout</label>
          <div class="pdf-layout-options">
            <label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="text"><div class="pdf-layout-card"><div class="pdf-layout-preview"><div class="line"></div><div class="line"></div><div class="line short"></div></div><span>Text Only</span></div></label>
            <label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="2col" checked><div class="pdf-layout-card"><div class="pdf-layout-preview grid-preview cols-1"><div class="box"></div><div class="box"></div></div><span>2 Per Page</span></div></label>
            <label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="4col"><div class="pdf-layout-card"><div class="pdf-layout-preview grid-preview cols-2"><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div></div><span>4 Per Page</span></div></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Options</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="pdfIncludeQR" checked> Include QR Code</label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="pdfBilingual"> Bilingual (EN + ES)</label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Language</label>
          <div style="display:flex;gap:8px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="radio" name="pdfLang" value="en" checked> English</label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="radio" name="pdfLang" value="es"> Espa√±ol</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('pdfModal')">Cancel</button>
        <button class="header-btn primary" onclick="generatePDF()" id="generatePdfBtn"><i class="ph-duotone ph-file-pdf"></i> Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-gear"></i> Settings</h2>
        <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-sparkle"></i> AI Features</div>
          <div style="padding:12px;background:var(--green-dim);border-radius:8px;border-left:3px solid var(--green);margin-bottom:12px;">
            <i class="ph-duotone ph-check-circle" style="color:var(--green);"></i> <strong>AI Features Ready!</strong> API key is securely stored on the server.
          </div>
          <button class="header-btn primary" onclick="testApiConnection()" style="width:100%;"><i class="ph-duotone ph-plugs-connected"></i> Test Connection</button>
          <div id="apiKeyStatus" style="margin-top:10px;font-size:12px;padding:10px;background:var(--bg);border-radius:6px;"></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-buildings"></i> Departments</div>
          <div class="settings-list" id="settingsDeptList"></div>
          <div class="settings-add-form">
            <input type="text" id="newDeptInput" placeholder="New department..." onkeypress="if(event.key==='Enter')addDepartment()">
            <button class="settings-add-btn" onclick="addDepartment()"><i class="ph-duotone ph-plus"></i></button>
          </div>
          <div class="settings-note">At least one department required</div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-tag"></i> Tags</div>
          <div class="settings-list" id="settingsTagList"></div>
          <div class="settings-add-form">
            <input type="text" id="newTagInput" placeholder="New tag..." onkeypress="if(event.key==='Enter')addTag()">
            <div class="tag-color-picker">
              <div class="tag-color-option gold selected" data-color="gold" onclick="selectTagColor('gold')"></div>
              <div class="tag-color-option green" data-color="green" onclick="selectTagColor('green')"></div>
              <div class="tag-color-option sungrown" data-color="sungrown" onclick="selectTagColor('sungrown')"></div>
              <div class="tag-color-option greenhouse" data-color="greenhouse" onclick="selectTagColor('greenhouse')"></div>
              <div class="tag-color-option indoor" data-color="indoor" onclick="selectTagColor('indoor')"></div>
              <div class="tag-color-option danger" data-color="danger" onclick="selectTagColor('danger')"></div>
            </div>
            <button class="settings-add-btn" onclick="addTag()"><i class="ph-duotone ph-plus"></i></button>
          </div>
          <div class="settings-note">At least one tag required</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn primary" onclick="closeModal('settingsModal')"><i class="ph-duotone ph-check"></i> Done</button>
      </div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div class="modal" id="requestsModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-clipboard-text"></i> SOP Requests</h2>
        <button class="modal-close" onclick="closeModal('requestsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="requests-tabs">
          <button class="requests-tab active" onclick="setRequestTab('pending')" id="tabPending">Pending <span class="tab-count" id="pendingCount">0</span></button>
          <button class="requests-tab" onclick="setRequestTab('completed')" id="tabCompleted">Completed <span class="tab-count" id="completedCount">0</span></button>
        </div>
        <div class="add-request-form" id="addRequestForm">
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">New Request Title *</label>
            <input type="text" class="form-input" id="reqTitle" placeholder="e.g., Trimming Machine Cleaning Procedure">
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Department</label>
              <select class="form-input" id="reqDept"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Priority</label>
              <select class="form-input" id="reqPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Assign To</label>
              <input type="text" class="form-input" id="reqAssignee" placeholder="Name or leave blank">
            </div>
            <div class="form-group">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-input" id="reqDueDate">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">Notes / Description</label>
            <textarea class="form-input" id="reqNotes" placeholder="What should this SOP cover?" rows="2"></textarea>
          </div>
          <button class="header-btn primary" onclick="addRequest()" style="width:100%;"><i class="ph-duotone ph-plus"></i> Add Request</button>
        </div>
        <div class="request-list" id="requestList"></div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('requestsModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Media Upload Modal -->
  <div class="modal" id="mediaModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-image"></i> <span data-i18n="addMedia">Add Media</span></h2>
        <button class="modal-close" onclick="closeModal('mediaModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="media-options">
          <button class="media-option" onclick="captureFromCamera('image')">
            <i class="ph-duotone ph-camera"></i>
            <span data-i18n="takePhoto">Take Photo</span>
          </button>
          <button class="media-option" onclick="selectFromLibrary('image')">
            <i class="ph-duotone ph-images"></i>
            <span data-i18n="photoLibrary">Photo Library</span>
          </button>
          <button class="media-option" onclick="captureFromCamera('video')">
            <i class="ph-duotone ph-video-camera"></i>
            <span data-i18n="recordVideo">Record Video</span>
          </button>
          <button class="media-option" onclick="selectFromLibrary('video')">
            <i class="ph-duotone ph-film-strip"></i>
            <span data-i18n="videoLibrary">Video Library</span>
          </button>
          <button class="media-option url-option" onclick="enterMediaUrl()">
            <i class="ph-duotone ph-link"></i>
            <span data-i18n="pasteUrl">Paste URL</span>
          </button>
        </div>
        <div class="media-url-input" id="mediaUrlInput" style="display:none;">
          <input type="text" class="form-input" id="mediaUrlField" placeholder="https://youtube.com/... or image URL">
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="header-btn" onclick="cancelMediaUrl()"><span data-i18n="cancel">Cancel</span></button>
            <button class="header-btn primary" onclick="confirmMediaUrl()"><i class="ph-duotone ph-check"></i> <span data-i18n="confirm">Confirm</span></button>
          </div>
        </div>
        <div class="media-preview" id="mediaPreview" style="display:none;">
          <div id="mediaPreviewContent"></div>
          <div class="media-preview-actions">
            <button class="header-btn" onclick="cancelMediaPreview()"><span data-i18n="cancel">Cancel</span></button>
            <button class="header-btn primary" onclick="confirmMediaUpload()"><i class="ph-duotone ph-check"></i> <span data-i18n="useThis">Use This</span></button>
          </div>
        </div>
        <p class="media-note" id="mediaSizeNote" style="display:none;"><i class="ph-duotone ph-info"></i> <span data-i18n="videoNote">Videos must be uploaded to YouTube or Google Drive. Paste the sharing link.</span></p>
      </div>
    </div>
  </div>

  <!-- Hidden file inputs for media capture -->
  <input type="file" id="cameraImageInput" accept="image/*" capture="environment" style="display:none;" onchange="handleMediaCapture(this, 'image')">
  <input type="file" id="libraryImageInput" accept="image/*" style="display:none;" onchange="handleMediaCapture(this, 'image')">
  <input type="file" id="cameraVideoInput" accept="video/*" capture="environment" style="display:none;" onchange="handleMediaCapture(this, 'video')">
  <input type="file" id="libraryVideoInput" accept="video/*" style="display:none;" onchange="handleMediaCapture(this, 'video')">

  <!-- Image Annotation Editor Modal -->
  <div class="modal" id="annotationModal">
    <div class="modal-box wide annotation-modal">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-pencil-circle"></i> <span data-i18n="editImage">Edit Image</span></h2>
        <button class="modal-close" onclick="closeAnnotationEditor()">&times;</button>
      </div>
      <div class="modal-body annotation-body">
        <!-- Toolbar -->
        <div class="annotation-toolbar">
          <div class="tool-group">
            <button class="tool-btn active" data-tool="arrow" title="Arrow">
              <i class="ph-duotone ph-arrow-up-right"></i>
            </button>
            <button class="tool-btn" data-tool="circle" title="Circle">
              <i class="ph-duotone ph-circle"></i>
            </button>
            <button class="tool-btn" data-tool="rect" title="Rectangle">
              <i class="ph-duotone ph-rectangle"></i>
            </button>
            <button class="tool-btn" data-tool="freehand" title="Freehand">
              <i class="ph-duotone ph-scribble"></i>
            </button>
            <button class="tool-btn" data-tool="text" title="Text">
              <i class="ph-duotone ph-text-t"></i>
            </button>
            <button class="tool-btn" data-tool="symbol" title="Symbol">
              <i class="ph-duotone ph-warning-circle"></i>
            </button>
          </div>
          <div class="tool-divider"></div>
          <div class="tool-group colors">
            <button class="color-btn active" data-color="#e53935" title="Red" style="background:#e53935;"></button>
            <button class="color-btn" data-color="#fdd835" title="Yellow" style="background:#fdd835;"></button>
            <button class="color-btn" data-color="#43a047" title="Green" style="background:#43a047;"></button>
            <button class="color-btn" data-color="#1e88e5" title="Blue" style="background:#1e88e5;"></button>
          </div>
          <div class="tool-divider"></div>
          <div class="tool-group actions">
            <button class="tool-btn action-btn" onclick="annotationUndo()" title="Undo">
              <i class="ph-duotone ph-arrow-counter-clockwise"></i>
            </button>
            <button class="tool-btn action-btn" onclick="annotationRedo()" title="Redo">
              <i class="ph-duotone ph-arrow-clockwise"></i>
            </button>
          </div>
        </div>

        <!-- Symbol picker (hidden by default) -->
        <div class="symbol-picker" id="symbolPicker" style="display:none;">
          <button class="symbol-btn" data-symbol="‚ö†Ô∏è" title="Caution">‚ö†Ô∏è</button>
          <button class="symbol-btn" data-symbol="üö´" title="Prohibited">üö´</button>
          <button class="symbol-btn" data-symbol="‚úì" title="Check">‚úì</button>
          <button class="symbol-btn" data-symbol="‚ùå" title="Wrong">‚ùå</button>
          <button class="symbol-btn" data-symbol="‚û°Ô∏è" title="Arrow">‚û°Ô∏è</button>
          <button class="symbol-btn" data-symbol="üëÜ" title="Point">üëÜ</button>
          <button class="symbol-btn" data-symbol="üîç" title="Inspect">üîç</button>
        </div>

        <!-- Canvas container -->
        <div class="canvas-container" id="canvasContainer">
          <canvas id="annotationCanvas"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeAnnotationEditor()"><span data-i18n="cancel">Cancel</span></button>
        <button class="header-btn primary" onclick="saveAnnotation()"><i class="ph-duotone ph-check"></i> <span data-i18n="saveImage">Save Image</span></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><i class="ph-duotone ph-check-circle"></i><span id="toastMsg"></span></div>

  <script>
    // =====================================================
    // API Configuration
    // Cloudflare Workers (100K free requests/day, no cold starts)
    const API_BASE = 'https://rogue-origin-api.roguefamilyfarms.workers.dev/api';
    // Vercel Functions (backup - rate limited)
    // const API_BASE = 'https://rogue-origin-apps-master.vercel.app/api';
    // =====================================================
    const API_URL = API_BASE + '/sop';
    
    // =====================================================
    // State
    // =====================================================
    let sops = [];
    let sopRequests = [];
    let currentSopId = null;
    let editingSteps = [];
    let selectedTagColor = 'gold';
    let editLang = 'en';
    let viewLang = 'en';

    // SOP linking state
    let editingLinkedSops = [];        // Header-level links being edited
    let linkingContext = null;         // 'header' or step index
    let selectedLinkSopId = null;      // Selected SOP in link modal
    let sopViewStack = [];             // For back navigation
    let previewingSopId = null;        // Currently previewed SOP

    let currentRequestTab = 'pending';
    let appLang = 'en';
    let isLoading = false;
    
    let settings = {
      departments: [
        {name:'Production',icon:'ph-factory'},
        {name:'Packaging',icon:'ph-package'},
        {name:'Quality',icon:'ph-seal-check'},
        {name:'Maintenance',icon:'ph-wrench'}
      ],
      tags: [
        {name:'safety',color:'danger'},
        {name:'quality',color:'green'},
        {name:'critical',color:'gold'}
      ]
    };

    // Media upload state
    let currentMediaStepIndex = null;
    let pendingMediaData = null;
    let pendingMediaType = null;

    // Annotation editor state
    let annotationCanvas = null;
    let annotationCtx = null;
    let annotationImage = null;
    let annotationStepIndex = null;
    let annotationTool = 'arrow';
    let annotationColor = '#e53935';
    let annotationSymbol = '‚ö†Ô∏è';
    let isDrawing = false;
    let drawStart = { x: 0, y: 0 };
    let drawHistory = [];
    let redoHistory = [];
    let freehandPoints = [];

    // Tutorial walkthrough state
    let tutorialActive = false;
    let tutorialStep = 0;
    const TUTORIAL_TOTAL_STEPS = 13;
    const tutorialSteps = [
      { field: 'editLangToggle', type: 'toggle', canSkip: false },
      { field: 'sopTitle', type: 'input', canSkip: false },
      { field: 'sopDept', type: 'select', canSkip: false },
      { field: 'sopDocNum', type: 'input', canSkip: true },
      { field: 'sopRevision', type: 'input', canSkip: true },
      { field: 'sopStatus', type: 'select', canSkip: false },
      { field: 'sopDesc', type: 'textarea', canSkip: true },
      { field: 'editTagsList', type: 'tags', canSkip: true },
      { field: 'editLinkedSopsList', type: 'linkedSops', canSkip: true },
      { field: 'addStepBtn', type: 'button', canSkip: false },
      { field: 'stepTitle', type: 'stepInput', canSkip: false },
      { field: 'stepDesc', type: 'stepTextarea', canSkip: false },
      { field: 'stepMedia', type: 'stepMedia', canSkip: true }
    ];

    // Translation strings
    const translations = {
      en: {
        addMedia: 'Add Media',
        takePhoto: 'Take Photo',
        photoLibrary: 'Photo Library',
        recordVideo: 'Record Video',
        videoLibrary: 'Video Library',
        pasteUrl: 'Paste URL',
        cancel: 'Cancel',
        confirm: 'Confirm',
        useThis: 'Use This',
        videoNote: 'Large videos should be uploaded to YouTube or Google Drive. Paste the sharing link.',
        searchPlaceholder: 'Search SOPs...',
        allSOPs: 'All SOPs',
        published: 'Published',
        drafts: 'Drafts',
        allDepts: 'All Departments',
        allTags: 'All Tags',
        total: 'Total',
        requests: 'Requests',
        thisMonth: 'This Month',
        noSOPs: 'No SOPs Found',
        createFirst: 'Create your first SOP to get started.',
        createSOP: 'Create New SOP',
        editSOP: 'Edit SOP',
        viewSOP: 'View SOP',
        sopTitle: 'SOP Title',
        department: 'Department',
        steps: 'Steps',
        status: 'Status',
        updated: 'Updated',
        actions: 'Actions',
        save: 'Save',
        saveDraft: 'Save Draft',
        publish: 'Publish',
        delete: 'Delete',
        close: 'Close',
        edit: 'Edit',
        loading: 'Loading SOPs from Google Sheets...',
        refreshing: 'Refreshing...',
        saved: 'Saved!',
        deleted: 'Deleted',
        error: 'Error',
        addStep: 'Add Step',
        stepTitle: 'Step title...',
        stepDesc: 'Description...',
        addImage: 'Add image',
        addVideo: 'Add video',
        compressing: 'Compressing...',
        processing: 'Processing...',
        editImage: 'Edit Image',
        saveImage: 'Save Image',
        annotationSaved: 'Image saved!',
        // Tutorial walkthrough hints
        tutorialStep: 'Step',
        tutorialOf: 'of',
        tutorialSkip: 'Skip',
        tutorialNext: 'Next',
        tutorialGotIt: 'Got it!',
        tutorialComplete: 'Tutorial Complete! You\'re ready to create SOPs.',
        tutorialHint1: 'Choose which language you\'re writing in',
        tutorialHint2: 'Enter a clear, descriptive title for this procedure',
        tutorialHint3: 'Select which department this SOP belongs to',
        tutorialHint4: 'Optional: Enter a document number (e.g., SOP-001)',
        tutorialHint5: 'Version number - leave as 1.0 for new SOPs',
        tutorialHint6: 'Draft = work in progress, Published = ready for use',
        tutorialHint7: 'Brief summary of what this procedure covers',
        tutorialHint8: 'Optional: Add tags to help organize and find this SOP',
        tutorialHint9: 'Optional: Link related SOPs that should be referenced',
        tutorialHint10: 'Click "Add" to create your first step',
        tutorialHint11: 'Enter a short title for this step',
        tutorialHint12: 'Describe what to do in this step',
        tutorialHint13: 'Optional: Add a photo or video to illustrate this step',
        // SOP linking
        linkSop: 'Link SOP',
        searchSops: 'Search SOPs',
        relationship: 'Relationship',
        addLink: 'Add Link',
        linkedSops: 'Linked SOPs',
        noLinkedSops: 'No linked SOPs',
        backTo: 'Back to'
      },
      es: {
        addMedia: 'Agregar Media',
        takePhoto: 'Tomar Foto',
        photoLibrary: 'Galer√≠a de Fotos',
        recordVideo: 'Grabar Video',
        videoLibrary: 'Galer√≠a de Videos',
        pasteUrl: 'Pegar URL',
        cancel: 'Cancelar',
        confirm: 'Confirmar',
        useThis: 'Usar Este',
        videoNote: 'Los videos grandes deben subirse a YouTube o Google Drive. Pegue el enlace compartido.',
        searchPlaceholder: 'Buscar SOPs...',
        allSOPs: 'Todos los SOPs',
        published: 'Publicados',
        drafts: 'Borradores',
        allDepts: 'Todos los Departamentos',
        allTags: 'Todas las Etiquetas',
        total: 'Total',
        requests: 'Solicitudes',
        thisMonth: 'Este Mes',
        noSOPs: 'No se Encontraron SOPs',
        createFirst: 'Cree su primer SOP para comenzar.',
        createSOP: 'Crear Nuevo SOP',
        editSOP: 'Editar SOP',
        viewSOP: 'Ver SOP',
        sopTitle: 'T√≠tulo del SOP',
        department: 'Departamento',
        steps: 'Pasos',
        status: 'Estado',
        updated: 'Actualizado',
        actions: 'Acciones',
        save: 'Guardar',
        saveDraft: 'Guardar Borrador',
        publish: 'Publicar',
        delete: 'Eliminar',
        close: 'Cerrar',
        edit: 'Editar',
        loading: 'Cargando SOPs desde Google Sheets...',
        refreshing: 'Actualizando...',
        saved: '¬°Guardado!',
        deleted: 'Eliminado',
        error: 'Error',
        addStep: 'Agregar Paso',
        stepTitle: 'T√≠tulo del paso...',
        stepDesc: 'Descripci√≥n...',
        addImage: 'Agregar imagen',
        addVideo: 'Agregar video',
        compressing: 'Comprimiendo...',
        processing: 'Procesando...',
        editImage: 'Editar Imagen',
        saveImage: 'Guardar Imagen',
        annotationSaved: '¬°Imagen guardada!',
        // Tutorial walkthrough hints
        tutorialStep: 'Paso',
        tutorialOf: 'de',
        tutorialSkip: 'Saltar',
        tutorialNext: 'Siguiente',
        tutorialGotIt: '¬°Entendido!',
        tutorialComplete: '¬°Tutorial Completo! Ya puedes crear SOPs.',
        tutorialHint1: 'Elige en qu√© idioma vas a escribir',
        tutorialHint2: 'Ingresa un t√≠tulo claro y descriptivo para este procedimiento',
        tutorialHint3: 'Selecciona a qu√© departamento pertenece este SOP',
        tutorialHint4: 'Opcional: Ingresa un n√∫mero de documento (ej. SOP-001)',
        tutorialHint5: 'N√∫mero de versi√≥n - deja 1.0 para SOPs nuevos',
        tutorialHint6: 'Borrador = en progreso, Publicado = listo para usar',
        tutorialHint7: 'Breve resumen de lo que cubre este procedimiento',
        tutorialHint8: 'Opcional: Agrega etiquetas para organizar y encontrar este SOP',
        tutorialHint9: 'Opcional: Vincula SOPs relacionados que deben referenciarse',
        tutorialHint10: 'Haz clic en "Agregar" para crear tu primer paso',
        tutorialHint11: 'Ingresa un t√≠tulo corto para este paso',
        tutorialHint12: 'Describe qu√© hacer en este paso',
        tutorialHint13: 'Opcional: Agrega una foto o video para ilustrar este paso',
        // SOP linking
        linkSop: 'Vincular SOP',
        searchSops: 'Buscar SOPs',
        relationship: 'Relaci√≥n',
        addLink: 'Agregar V√≠nculo',
        linkedSops: 'SOPs Vinculados',
        noLinkedSops: 'Sin SOPs vinculados',
        backTo: 'Volver a'
      }
    };

    // SOP link relationship labels (bilingual)
    const LINK_LABELS = [
      { en: 'Required before', es: 'Requerido antes' },
      { en: 'See also', es: 'Ver tambi√©n' },
      { en: 'Related', es: 'Relacionado' },
      { en: 'Follow procedure', es: 'Seguir procedimiento' }
    ];

    function t(key) {
      return translations[appLang]?.[key] || translations.en[key] || key;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[appLang]?.[key]) {
          el.textContent = translations[appLang][key];
        }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[appLang]?.[key]) {
          el.placeholder = translations[appLang][key];
        }
      });
    }

    // =====================================================
    // Media Upload Functions
    // =====================================================

    function openMediaModal(stepIndex) {
      currentMediaStepIndex = stepIndex;
      pendingMediaData = null;
      pendingMediaType = null;
      document.getElementById('mediaUrlInput').style.display = 'none';
      document.getElementById('mediaPreview').style.display = 'none';
      document.getElementById('mediaSizeNote').style.display = 'none';
      document.querySelector('.media-options').style.display = 'grid';
      openModal('mediaModal');
    }

    function captureFromCamera(type) {
      if (type === 'image') {
        document.getElementById('cameraImageInput').click();
      } else {
        document.getElementById('cameraVideoInput').click();
        document.getElementById('mediaSizeNote').style.display = 'flex';
      }
    }

    function selectFromLibrary(type) {
      if (type === 'image') {
        document.getElementById('libraryImageInput').click();
      } else {
        document.getElementById('libraryVideoInput').click();
        document.getElementById('mediaSizeNote').style.display = 'flex';
      }
    }

    function enterMediaUrl() {
      document.querySelector('.media-options').style.display = 'none';
      document.getElementById('mediaUrlInput').style.display = 'block';
      document.getElementById('mediaUrlField').value = '';
      document.getElementById('mediaUrlField').focus();
    }

    function cancelMediaUrl() {
      document.getElementById('mediaUrlInput').style.display = 'none';
      document.querySelector('.media-options').style.display = 'grid';
    }

    function confirmMediaUrl() {
      const url = document.getElementById('mediaUrlField').value.trim();
      if (!url) {
        showToast(t('error') + ': Enter URL', 'error');
        return;
      }

      const mediaType = detectMediaType(url);
      editingSteps[currentMediaStepIndex].media = url;
      editingSteps[currentMediaStepIndex].mediaType = mediaType;
      // Keep backwards compatibility with image field
      if (mediaType === 'image') {
        editingSteps[currentMediaStepIndex].image = url;
      }

      renderSteps();
      closeModal('mediaModal');
      showToast('Media added!', 'success');
    }

    function detectMediaType(url) {
      if (!url) return null;
      const lower = url.toLowerCase();
      if (lower.includes('youtube.com') || lower.includes('youtu.be')) return 'youtube';
      if (lower.includes('drive.google.com')) return 'gdrive';
      if (lower.includes('vimeo.com')) return 'vimeo';
      if (lower.match(/\.(mp4|webm|mov|avi|mkv)(\?|$)/i)) return 'video';
      if (lower.startsWith('data:video/')) return 'video';
      if (lower.startsWith('data:image/')) return 'image';
      return 'image'; // default to image
    }

    async function handleMediaCapture(input, type) {
      const file = input.files?.[0];
      if (!file) return;

      try {
        if (type === 'image') {
          showToast(t('compressing'), 'success');
          const compressed = await compressImage(file, 400, 0.6);
          showMediaPreview(compressed, 'image');
        } else {
          // For video, check size
          if (file.size > 5 * 1024 * 1024) { // 5MB limit for embedded video
            showToast('Video too large. Upload to YouTube/Drive and paste URL.', 'error');
            document.getElementById('mediaSizeNote').style.display = 'flex';
            return;
          }
          showToast(t('processing'), 'success');
          const dataUrl = await fileToDataUrl(file);
          showMediaPreview(dataUrl, 'video');
        }
      } catch (e) {
        console.error('Media processing error:', e);
        showToast(t('error') + ': ' + e.message, 'error');
      }

      // Reset input
      input.value = '';
    }

    function showMediaPreview(dataUrl, type) {
      pendingMediaData = dataUrl;
      pendingMediaType = type;

      document.querySelector('.media-options').style.display = 'none';
      document.getElementById('mediaUrlInput').style.display = 'none';

      const previewContent = document.getElementById('mediaPreviewContent');
      if (type === 'image') {
        previewContent.innerHTML = '<img src="' + dataUrl + '" alt="Preview">';
      } else {
        previewContent.innerHTML = '<video src="' + dataUrl + '" controls playsinline style="max-height:200px;"></video>';
      }

      document.getElementById('mediaPreview').style.display = 'block';
    }

    function cancelMediaPreview() {
      pendingMediaData = null;
      pendingMediaType = null;
      document.getElementById('mediaPreview').style.display = 'none';
      document.querySelector('.media-options').style.display = 'grid';
    }

    function confirmMediaUpload() {
      if (!pendingMediaData || currentMediaStepIndex === null) return;

      editingSteps[currentMediaStepIndex].media = pendingMediaData;
      editingSteps[currentMediaStepIndex].mediaType = pendingMediaType;
      // Backwards compatibility
      if (pendingMediaType === 'image') {
        editingSteps[currentMediaStepIndex].image = pendingMediaData;
      }

      renderSteps();
      closeModal('mediaModal');
      showToast('Media added!', 'success');

      pendingMediaData = null;
      pendingMediaType = null;
    }

    // Image compression using canvas
    async function compressImage(file, maxSize, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Calculate new dimensions
            if (width > height) {
              if (width > maxSize) {
                height = Math.round((height * maxSize) / width);
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round((width * maxSize) / height);
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to JPEG with compression
            const dataUrl = canvas.toDataURL('image/jpeg', quality);

            // Check size - if still too large, compress more
            if (dataUrl.length > 45000) { // ~33KB actual after base64
              const lowerQuality = canvas.toDataURL('image/jpeg', 0.4);
              resolve(lowerQuality);
            } else {
              resolve(dataUrl);
            }
          };
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    // Get YouTube embed URL
    function getYouTubeEmbedUrl(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = url.match(regExp);
      if (match && match[2].length === 11) {
        return 'https://www.youtube.com/embed/' + match[2];
      }
      return null;
    }

    // =====================================================
    // Image Annotation Editor
    // =====================================================

    function openAnnotationEditor(stepIndex) {
      const step = editingSteps[stepIndex];
      const imageUrl = step?.media || step?.image || '';
      if (!imageUrl || !imageUrl.startsWith('data:image')) {
        showToast(appLang === 'es' ? 'No hay imagen para editar' : 'No image to edit', 'error');
        return;
      }

      annotationStepIndex = stepIndex;
      annotationTool = 'arrow';
      annotationColor = '#e53935';
      annotationSymbol = '‚ö†Ô∏è';
      drawHistory = [];
      redoHistory = [];
      freehandPoints = [];

      // Reset toolbar state
      document.querySelectorAll('#annotationModal .tool-btn[data-tool]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === 'arrow');
      });
      document.querySelectorAll('#annotationModal .color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.color === '#e53935');
      });
      document.getElementById('symbolPicker').style.display = 'none';

      openModal('annotationModal');

      // Initialize canvas after modal is visible
      setTimeout(() => initAnnotationCanvas(imageUrl), 100);
    }

    function closeAnnotationEditor() {
      closeModal('annotationModal');
      annotationStepIndex = null;
      annotationImage = null;
      drawHistory = [];
      redoHistory = [];
    }

    function initAnnotationCanvas(imageSrc) {
      annotationCanvas = document.getElementById('annotationCanvas');
      annotationCtx = annotationCanvas.getContext('2d');

      annotationImage = new Image();
      annotationImage.onload = function() {
        // Calculate size to fit container while maintaining aspect ratio
        const container = document.getElementById('canvasContainer');
        const maxW = container.clientWidth - 20;
        const maxH = container.clientHeight - 20;

        let w = annotationImage.width;
        let h = annotationImage.height;

        // Scale down if needed
        if (w > maxW) {
          h = h * (maxW / w);
          w = maxW;
        }
        if (h > maxH) {
          w = w * (maxH / h);
          h = maxH;
        }

        annotationCanvas.width = w;
        annotationCanvas.height = h;

        // Draw the image
        annotationCtx.drawImage(annotationImage, 0, 0, w, h);

        // Save initial state to history
        saveToHistory();
      };
      annotationImage.src = imageSrc;

      // Add event listeners
      setupAnnotationEvents();
    }

    function setupAnnotationEvents() {
      // Remove old listeners by replacing element
      const oldCanvas = annotationCanvas;
      const newCanvas = oldCanvas.cloneNode(true);
      oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
      annotationCanvas = newCanvas;
      annotationCtx = annotationCanvas.getContext('2d');

      // Mouse events
      annotationCanvas.addEventListener('mousedown', handleDrawStart);
      annotationCanvas.addEventListener('mousemove', handleDrawMove);
      annotationCanvas.addEventListener('mouseup', handleDrawEnd);
      annotationCanvas.addEventListener('mouseleave', handleDrawEnd);

      // Touch events (iPad)
      annotationCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
      annotationCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
      annotationCanvas.addEventListener('touchend', handleTouchEnd, { passive: false });

      // Tool buttons
      document.querySelectorAll('#annotationModal .tool-btn[data-tool]').forEach(btn => {
        btn.onclick = () => selectTool(btn.dataset.tool);
      });

      // Color buttons
      document.querySelectorAll('#annotationModal .color-btn').forEach(btn => {
        btn.onclick = () => selectColor(btn.dataset.color);
      });

      // Symbol buttons
      document.querySelectorAll('#annotationModal .symbol-btn').forEach(btn => {
        btn.onclick = () => selectSymbol(btn.dataset.symbol);
      });
    }

    function selectTool(tool) {
      annotationTool = tool;
      document.querySelectorAll('#annotationModal .tool-btn[data-tool]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });

      // Show/hide symbol picker
      document.getElementById('symbolPicker').style.display = tool === 'symbol' ? 'flex' : 'none';

      // Change cursor
      if (tool === 'text' || tool === 'symbol') {
        annotationCanvas.style.cursor = 'crosshair';
      } else {
        annotationCanvas.style.cursor = 'crosshair';
      }
    }

    function selectColor(color) {
      annotationColor = color;
      document.querySelectorAll('#annotationModal .color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.color === color);
      });
    }

    function selectSymbol(symbol) {
      annotationSymbol = symbol;
      document.querySelectorAll('#annotationModal .symbol-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.symbol === symbol);
      });
    }

    function getCanvasCoords(e) {
      const rect = annotationCanvas.getBoundingClientRect();
      const scaleX = annotationCanvas.width / rect.width;
      const scaleY = annotationCanvas.height / rect.height;
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }

    function handleTouchStart(e) {
      e.preventDefault();
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        handleDrawStart({ clientX: touch.clientX, clientY: touch.clientY });
      }
    }

    function handleTouchMove(e) {
      e.preventDefault();
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        handleDrawMove({ clientX: touch.clientX, clientY: touch.clientY });
      }
    }

    function handleTouchEnd(e) {
      e.preventDefault();
      handleDrawEnd();
    }

    function handleDrawStart(e) {
      if (annotationTool === 'text') {
        handleTextInput(e);
        return;
      }
      if (annotationTool === 'symbol') {
        handleSymbolPlace(e);
        return;
      }

      isDrawing = true;
      drawStart = getCanvasCoords(e);
      freehandPoints = [drawStart];

      if (annotationTool === 'freehand') {
        annotationCtx.beginPath();
        annotationCtx.moveTo(drawStart.x, drawStart.y);
        annotationCtx.strokeStyle = annotationColor;
        annotationCtx.lineWidth = 3;
        annotationCtx.lineCap = 'round';
        annotationCtx.lineJoin = 'round';
      }
    }

    function handleDrawMove(e) {
      if (!isDrawing) return;

      const pos = getCanvasCoords(e);

      if (annotationTool === 'freehand') {
        // Draw freehand line
        annotationCtx.lineTo(pos.x, pos.y);
        annotationCtx.stroke();
        freehandPoints.push(pos);
      } else {
        // Preview shape - redraw from history
        redrawFromHistory();
        drawShape(drawStart, pos, true);
      }
    }

    function handleDrawEnd() {
      if (!isDrawing) return;
      isDrawing = false;

      if (annotationTool === 'freehand') {
        annotationCtx.closePath();
      }

      // Save current state
      saveToHistory();
      redoHistory = [];
    }

    function drawShape(start, end, isPreview = false) {
      annotationCtx.save();
      annotationCtx.strokeStyle = annotationColor;
      annotationCtx.fillStyle = annotationColor;
      annotationCtx.lineWidth = 3;
      annotationCtx.lineCap = 'round';
      annotationCtx.lineJoin = 'round';

      switch (annotationTool) {
        case 'arrow':
          drawArrow(start, end);
          break;
        case 'circle':
          drawCircle(start, end);
          break;
        case 'rect':
          drawRect(start, end);
          break;
      }

      annotationCtx.restore();
    }

    function drawArrow(start, end) {
      const headLen = 15;
      const dx = end.x - start.x;
      const dy = end.y - start.y;
      const angle = Math.atan2(dy, dx);

      // Draw line
      annotationCtx.beginPath();
      annotationCtx.moveTo(start.x, start.y);
      annotationCtx.lineTo(end.x, end.y);
      annotationCtx.stroke();

      // Draw arrowhead
      annotationCtx.beginPath();
      annotationCtx.moveTo(end.x, end.y);
      annotationCtx.lineTo(
        end.x - headLen * Math.cos(angle - Math.PI / 6),
        end.y - headLen * Math.sin(angle - Math.PI / 6)
      );
      annotationCtx.lineTo(
        end.x - headLen * Math.cos(angle + Math.PI / 6),
        end.y - headLen * Math.sin(angle + Math.PI / 6)
      );
      annotationCtx.closePath();
      annotationCtx.fill();
    }

    function drawCircle(start, end) {
      const rx = Math.abs(end.x - start.x) / 2;
      const ry = Math.abs(end.y - start.y) / 2;
      const cx = Math.min(start.x, end.x) + rx;
      const cy = Math.min(start.y, end.y) + ry;

      annotationCtx.beginPath();
      annotationCtx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
      annotationCtx.stroke();
    }

    function drawRect(start, end) {
      const x = Math.min(start.x, end.x);
      const y = Math.min(start.y, end.y);
      const w = Math.abs(end.x - start.x);
      const h = Math.abs(end.y - start.y);

      annotationCtx.strokeRect(x, y, w, h);
    }

    function handleTextInput(e) {
      const pos = getCanvasCoords(e);
      const text = prompt(appLang === 'es' ? 'Ingrese texto:' : 'Enter text:');
      if (!text) return;

      annotationCtx.save();
      annotationCtx.font = 'bold 18px sans-serif';
      annotationCtx.fillStyle = annotationColor;

      // Add background for readability
      const metrics = annotationCtx.measureText(text);
      const padding = 4;
      annotationCtx.fillStyle = 'rgba(255,255,255,0.85)';
      annotationCtx.fillRect(
        pos.x - padding,
        pos.y - 16 - padding,
        metrics.width + padding * 2,
        20 + padding * 2
      );

      annotationCtx.fillStyle = annotationColor;
      annotationCtx.fillText(text, pos.x, pos.y);
      annotationCtx.restore();

      saveToHistory();
      redoHistory = [];
    }

    function handleSymbolPlace(e) {
      const pos = getCanvasCoords(e);

      annotationCtx.save();
      annotationCtx.font = '32px serif';
      annotationCtx.textAlign = 'center';
      annotationCtx.textBaseline = 'middle';
      annotationCtx.fillText(annotationSymbol, pos.x, pos.y);
      annotationCtx.restore();

      saveToHistory();
      redoHistory = [];
    }

    function saveToHistory() {
      const imageData = annotationCanvas.toDataURL('image/png');
      drawHistory.push(imageData);
      // Limit history to prevent memory issues
      if (drawHistory.length > 30) {
        drawHistory.shift();
      }
    }

    function redrawFromHistory() {
      if (drawHistory.length === 0) return;

      const img = new Image();
      img.onload = function() {
        annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
        annotationCtx.drawImage(img, 0, 0);
      };
      img.src = drawHistory[drawHistory.length - 1];
    }

    function annotationUndo() {
      if (drawHistory.length <= 1) return; // Keep at least the original

      const current = drawHistory.pop();
      redoHistory.push(current);

      const previous = drawHistory[drawHistory.length - 1];
      const img = new Image();
      img.onload = function() {
        annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
        annotationCtx.drawImage(img, 0, 0);
      };
      img.src = previous;
    }

    function annotationRedo() {
      if (redoHistory.length === 0) return;

      const next = redoHistory.pop();
      drawHistory.push(next);

      const img = new Image();
      img.onload = function() {
        annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
        annotationCtx.drawImage(img, 0, 0);
      };
      img.src = next;
    }

    function saveAnnotation() {
      if (annotationStepIndex === null) return;

      // Get flattened image as JPEG
      const dataUrl = annotationCanvas.toDataURL('image/jpeg', 0.85);

      // Update step image - use media field if it exists, otherwise image
      if (editingSteps[annotationStepIndex].media) {
        editingSteps[annotationStepIndex].media = dataUrl;
      } else {
        editingSteps[annotationStepIndex].image = dataUrl;
      }

      // Re-render steps
      renderSteps();

      // Close modal
      closeAnnotationEditor();

      showToast(t('annotationSaved'), 'success');
    }

    // =====================================================
    // Tutorial Walkthrough Functions
    // =====================================================

    function startTutorial() {
      tutorialActive = true;
      tutorialStep = 0;
      document.getElementById('tutorialBanner').style.display = 'block';
      document.getElementById('tutorialOverlay').style.display = 'block';
      updateTutorialUI();
      highlightCurrentField();
      setupTutorialListeners();
    }

    function endTutorial() {
      tutorialActive = false;
      document.getElementById('tutorialBanner').style.display = 'none';
      document.getElementById('tutorialOverlay').style.display = 'none';
      clearTutorialHighlight();
      removeTutorialListeners();
    }

    function updateTutorialUI() {
      const stepLabel = document.getElementById('tutorialStepLabel');
      const hint = document.getElementById('tutorialHint');
      const skipBtn = document.getElementById('tutorialSkipBtn');
      const nextBtn = document.getElementById('tutorialNextBtn');
      const progressFill = document.getElementById('tutorialProgressFill');
      const banner = document.getElementById('tutorialBanner');

      // Check if tutorial is complete
      if (tutorialStep >= TUTORIAL_TOTAL_STEPS) {
        banner.classList.add('complete');
        stepLabel.style.display = 'none';
        hint.innerHTML = '<div class="tutorial-complete-icon">üéâ</div>' + t('tutorialComplete');
        skipBtn.style.display = 'none';
        nextBtn.textContent = t('tutorialGotIt');
        nextBtn.onclick = endTutorial;
        progressFill.style.width = '100%';
        // Hide overlay and highlights on completion
        document.getElementById('tutorialOverlay').style.display = 'none';
        clearTutorialHighlight();
        return;
      }

      banner.classList.remove('complete');
      stepLabel.style.display = 'block';

      // Use the language selected in step 1 for subsequent hints
      const currentLang = tutorialStep === 0 ? appLang : (document.querySelector('#editLangToggle .active')?.textContent === 'Espa√±ol' ? 'es' : 'en');
      const hintKey = 'tutorialHint' + (tutorialStep + 1);

      stepLabel.textContent = t('tutorialStep') + ' ' + (tutorialStep + 1) + ' ' + t('tutorialOf') + ' ' + TUTORIAL_TOTAL_STEPS;
      hint.textContent = translations[currentLang]?.[hintKey] || translations.en[hintKey];

      // Show/hide skip button based on whether field can be skipped
      const currentStepConfig = tutorialSteps[tutorialStep];
      skipBtn.style.display = currentStepConfig.canSkip ? 'flex' : 'none';
      skipBtn.textContent = t('tutorialSkip');

      nextBtn.innerHTML = t('tutorialNext') + ' <i class="ph-bold ph-arrow-right"></i>';
      nextBtn.onclick = tutorialNext;

      // Update progress bar
      progressFill.style.width = ((tutorialStep / TUTORIAL_TOTAL_STEPS) * 100) + '%';
    }

    function highlightCurrentField() {
      clearTutorialHighlight();

      if (tutorialStep >= TUTORIAL_TOTAL_STEPS) return;

      const stepConfig = tutorialSteps[tutorialStep];
      let element = null;

      switch (stepConfig.field) {
        case 'editLangToggle':
          element = document.getElementById('editLangToggle');
          break;
        case 'sopTitle':
        case 'sopDocNum':
        case 'sopRevision':
        case 'sopDesc':
          element = document.getElementById(stepConfig.field);
          break;
        case 'sopDept':
        case 'sopStatus':
          element = document.getElementById(stepConfig.field);
          break;
        case 'editTagsList':
          element = document.getElementById('editTagsList')?.closest('.form-group');
          break;
        case 'editLinkedSopsList':
          element = document.getElementById('editLinkedSopsList')?.closest('.form-group');
          break;
        case 'addStepBtn':
          element = document.querySelector('.steps-header .header-btn');
          break;
        case 'stepTitle':
          element = document.querySelector('.step-item:first-child .step-title-input');
          break;
        case 'stepDesc':
          element = document.querySelector('.step-item:first-child .step-desc-input');
          break;
        case 'stepMedia':
          element = document.querySelector('.step-item:first-child .step-image-preview');
          break;
      }

      if (element) {
        if (stepConfig.type === 'toggle' || stepConfig.type === 'tags' || stepConfig.type === 'linkedSops') {
          element.classList.add('tutorial-highlight-group');
        } else {
          element.classList.add('tutorial-highlight');
        }

        // Lift parent form-group above overlay for context
        const parentGroup = element.closest('.form-group') || element.closest('.form-row') || element.closest('.steps-section');
        if (parentGroup) {
          parentGroup.classList.add('tutorial-highlight-parent');
        }

        // Scroll element into view
        setTimeout(() => {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }
    }

    function clearTutorialHighlight() {
      document.querySelectorAll('.tutorial-highlight, .tutorial-highlight-group, .tutorial-highlight-parent').forEach(el => {
        el.classList.remove('tutorial-highlight', 'tutorial-highlight-group', 'tutorial-highlight-parent');
      });
    }

    function tutorialNext() {
      if (tutorialStep < TUTORIAL_TOTAL_STEPS) {
        tutorialStep++;
        updateTutorialUI();
        highlightCurrentField();
      }
    }

    function tutorialSkip() {
      tutorialNext();
    }

    function setupTutorialListeners() {
      // No auto-advance - users must click Next/Skip to proceed
      // We only set up observer to track when steps are added for re-highlighting
      setupStepObserver();
    }

    function removeTutorialListeners() {
      // Cleanup if needed
    }

    function setupStepObserver() {
      const stepsList = document.getElementById('stepsList');
      if (!stepsList) return;

      const observer = new MutationObserver((mutations) => {
        if (!tutorialActive) return;

        // When on "Add Step" step and a step is added, re-highlight the new step's title
        if (tutorialStep === 8) {
          const stepItems = stepsList.querySelectorAll('.step-item');
          if (stepItems.length > 0) {
            // Step was added - update highlight to show on step title
            setTimeout(() => {
              highlightCurrentField();
            }, 100);
          }
        }
      });

      observer.observe(stepsList, { childList: true, subtree: true });
    }

    // =====================================================
    // Data Loading & Saving (API-based)
    // =====================================================
    
    async function loadData() {
      isLoading = true;
      showLoading();
      
      try {
        // Load SOPs
        const sopsResponse = await fetch(API_URL + '?action=getSOPs');
        const sopsRaw = await sopsResponse.json();
        const sopsResult = sopsRaw.data || sopsRaw; // Handle Vercel wrapper
        if (sopsResult.success) {
          sops = sopsResult.sops || [];
        } else {
          console.error('Failed to load SOPs:', sopsResult.error);
          sops = [];
        }

        // Load Requests
        const reqResponse = await fetch(API_URL + '?action=getRequests');
        const reqRaw = await reqResponse.json();
        const reqResult = reqRaw.data || reqRaw; // Handle Vercel wrapper
        if (reqResult.success) {
          sopRequests = reqResult.requests || [];
        } else {
          sopRequests = [];
        }

        // Load Settings
        const settingsResponse = await fetch(API_URL + '?action=getSettings');
        const settingsRaw = await settingsResponse.json();
        const settingsResult = settingsRaw.data || settingsRaw; // Handle Vercel wrapper
        if (settingsResult.success && settingsResult.settings) {
          if (settingsResult.settings.departments) settings.departments = settingsResult.settings.departments;
          if (settingsResult.settings.tags) settings.tags = settingsResult.settings.tags;
        }
        
      } catch (e) {
        console.error('Error loading data:', e);
        showToast('Error loading data: ' + e.message, 'error');
      }
      
      isLoading = false;
      hideLoading();
      renderSOPs();
      updateStats();
      updateDropdowns();
    }
    
    async function saveSOP(status) {
      const title = document.getElementById('sopTitle').value.trim();
      const dept = document.getElementById('sopDept').value;
      
      if (!title) { showToast('Enter title', 'error'); return; }
      if (!dept) { showToast('Select department', 'error'); return; }
      if (editingSteps.length === 0) { showToast('Add at least 1 step', 'error'); return; }
      
      const description = document.getElementById('sopDesc').value.trim();

      // Track which language the SOP was written in
      const sourceLang = editLang;

      // Store content in the appropriate language field based on editLang
      const sopData = {
        id: currentSopId,
        title: title,
        title_en: sourceLang === 'en' ? title : (window.sopTranslations?.title_en || ''),
        title_es: sourceLang === 'es' ? title : (window.sopTranslations?.title_es || ''),
        sourceLang: sourceLang,
        dept: dept,
        docNum: document.getElementById('sopDocNum').value.trim() || generateDocNum(),
        revision: document.getElementById('sopRevision').value.trim() || '1.0',
        status: status,
        description: description,
        desc_en: sourceLang === 'en' ? description : (window.sopTranslations?.desc_en || ''),
        desc_es: sourceLang === 'es' ? description : (window.sopTranslations?.desc_es || ''),
        tags: getSelectedTags(),
        linkedSops: editingLinkedSops,
        steps: editingSteps.map(s => ({
          title: s.title || '',
          title_en: sourceLang === 'en' ? (s.title || '') : (s.title_en || ''),
          title_es: sourceLang === 'es' ? (s.title || '') : (s.title_es || ''),
          description: s.description || '',
          desc_en: sourceLang === 'en' ? (s.description || '') : (s.desc_en || ''),
          desc_es: sourceLang === 'es' ? (s.description || '') : (s.desc_es || ''),
          image: s.image || '',
          media: s.media || s.image || '',
          mediaType: s.mediaType || detectMediaType(s.media || s.image || ''),
          safety: s.safety || false,
          quality: s.quality || false,
          refs: s.refs || []
        }))
      };
      
      showLoading();
      
      try {
        const action = currentSopId ? 'updateSOP' : 'createSOP';
        const response = await fetch(API_URL + '?action=' + action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sop: sopData })
        });

        const raw = await response.json();
        const result = raw.data || raw; // Handle Vercel wrapper

        if (result.success) {
          showToast(status === 'published' ? 'Published!' : 'Saved!', 'success');
          closeModal('editModal');
          await loadData();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      } catch (e) {
        showToast('Error saving: ' + e.message, 'error');
      }
      
      hideLoading();
    }
    
    async function deleteSOP(id) {
      if (!confirm('Delete this SOP?')) return;
      
      showLoading();
      
      try {
        const response = await fetch(API_URL + '?action=deleteSOP', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        });

        const raw = await response.json();
        const result = raw.data || raw; // Handle Vercel wrapper

        if (result.success) {
          showToast('Deleted', 'success');
          await loadData();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      } catch (e) {
        showToast('Error deleting: ' + e.message, 'error');
      }
      
      hideLoading();
    }
    
    async function addRequest() {
      const title = document.getElementById('reqTitle').value.trim();
      if (!title) { showToast('Enter title', 'error'); return; }
      
      const reqData = {
        title: title,
        dept: document.getElementById('reqDept').value,
        priority: document.getElementById('reqPriority').value,
        assignee: document.getElementById('reqAssignee').value.trim(),
        dueDate: document.getElementById('reqDueDate').value,
        notes: document.getElementById('reqNotes').value.trim()
      };
      
      try {
        const response = await fetch(API_URL + '?action=createRequest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ request: reqData })
        });

        const raw = await response.json();
        const result = raw.data || raw; // Handle Vercel wrapper

        if (result.success) {
          showToast('Request added', 'success');
          document.getElementById('reqTitle').value = '';
          document.getElementById('reqNotes').value = '';
          await loadData();
          renderRequests();
        } else {
          showToast('Error: ' + result.error, 'error');
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    
    async function completeRequest(id) {
      const req = sopRequests.find(r => r.id == id);
      if (!req) return;
      
      req.completed = true;
      
      try {
        const response = await fetch(API_URL + '?action=updateRequest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ request: req })
        });

        const raw = await response.json();
        const result = raw.data || raw; // Handle Vercel wrapper

        if (result.success) {
          showToast('Marked complete', 'success');
          await loadData();
          renderRequests();
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    
    async function deleteRequest(id) {
      if (!confirm('Delete this request?')) return;
      
      try {
        const response = await fetch(API_URL + '?action=deleteRequest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        });

        const raw = await response.json();
        const result = raw.data || raw; // Handle Vercel wrapper

        if (result.success) {
          showToast('Deleted', 'success');
          await loadData();
          renderRequests();
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }
    
    // =====================================================
    // UI Rendering
    // =====================================================
    
    function showLoading() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('sopGrid').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }
    
    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }
    
    function renderSOPs() {
      const grid = document.getElementById('sopGrid');
      const tbody = document.getElementById('sopTableBody');
      const empty = document.getElementById('emptyState');
      
      const filtered = getFilteredSOPs();
      
      if (filtered.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      grid.style.display = 'grid';
      
      // Grid view
      grid.innerHTML = filtered.map(s => {
        const firstImg = s.steps && s.steps.length > 0 && s.steps[0].image ? s.steps[0].image : null;
        const tags = (s.tags || []).slice(0, 3).map(t => {
          const tagDef = settings.tags.find(x => x.name === t);
          const color = tagDef ? tagDef.color : 'gold';
          return '<span class="sop-tag ' + color + '">' + esc(t) + '</span>';
        }).join('');
        
        return '<div class="sop-card" onclick="viewSOP(\'' + s.id + '\')">' +
          '<div class="sop-card-header">' +
            '<div><div class="sop-card-title">' + esc(s.title) + '</div>' +
            '<div class="sop-card-dept"><i class="ph-duotone ph-folder"></i> ' + esc(s.dept) + '</div></div>' +
            '<span class="sop-card-rev ' + (s.status === 'draft' ? 'draft' : '') + '">' + (s.status === 'draft' ? 'Draft' : 'v' + s.revision) + '</span>' +
          '</div>' +
          '<div class="sop-card-preview">' +
            (firstImg ? '<img src="' + esc(firstImg) + '" onerror="this.outerHTML=\'<div class=sop-card-preview-empty><i class=ph-duotone\\ ph-image></i>No image</div>\'">' : '<div class="sop-card-preview-empty"><i class="ph-duotone ph-image"></i>No image</div>') +
          '</div>' +
          '<div class="sop-card-meta">' +
            '<div class="sop-card-steps"><i class="ph-duotone ph-list-numbers"></i> ' + (s.steps ? s.steps.length : 0) + ' steps</div>' +
            '<div class="sop-card-tags">' + tags + '</div>' +
          '</div>' +
          '<div class="sop-card-actions">' +
            '<button onclick="event.stopPropagation();viewSOP(\'' + s.id + '\')"><i class="ph-duotone ph-eye"></i></button>' +
            '<button class="qr-btn" onclick="event.stopPropagation();showQR(\'' + s.id + '\')"><i class="ph-duotone ph-qr-code"></i></button>' +
            '<button onclick="event.stopPropagation();editSOP(\'' + s.id + '\')"><i class="ph-duotone ph-pencil-simple"></i></button>' +
            '<button class="del-btn" onclick="event.stopPropagation();deleteSOP(\'' + s.id + '\')"><i class="ph-duotone ph-trash"></i></button>' +
          '</div>' +
        '</div>';
      }).join('');
      
      // Table view
      tbody.innerHTML = filtered.map(s => {
        return '<tr onclick="viewSOP(\'' + s.id + '\')">' +
          '<td class="title-cell">' + esc(s.title) + '</td>' +
          '<td>' + esc(s.dept) + '</td>' +
          '<td>' + (s.steps ? s.steps.length : 0) + '</td>' +
          '<td><span class="sop-card-rev ' + (s.status === 'draft' ? 'draft' : '') + '">' + (s.status === 'draft' ? 'Draft' : 'Published') + '</span></td>' +
          '<td>' + fmtDate(s.updatedAt) + '</td>' +
          '<td class="actions-cell">' +
            '<button onclick="event.stopPropagation();editSOP(\'' + s.id + '\')"><i class="ph-duotone ph-pencil-simple"></i></button>' +
            '<button onclick="event.stopPropagation();deleteSOP(\'' + s.id + '\')"><i class="ph-duotone ph-trash"></i></button>' +
          '</td>' +
        '</tr>';
      }).join('');
    }
    
    function getFilteredSOPs() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const dept = document.getElementById('deptFilter').value;
      const tag = document.getElementById('tagFilter').value;
      
      return sops.filter(s => {
        if (search && !s.title.toLowerCase().includes(search) && !(s.description || '').toLowerCase().includes(search)) return false;
        if (status && s.status !== status) return false;
        if (dept && s.dept !== dept) return false;
        if (tag && !(s.tags || []).includes(tag)) return false;
        return true;
      });
    }
    
    function filterSOPs() {
      renderSOPs();
    }
    
    function updateStats() {
      document.getElementById('statTotal').textContent = sops.length;
      document.getElementById('statPublished').textContent = sops.filter(s => s.status === 'published').length;
      document.getElementById('statDrafts').textContent = sops.filter(s => s.status === 'draft').length;
      
      const pendingRequests = sopRequests.filter(r => !r.completed).length;
      document.getElementById('statRequests').textContent = pendingRequests;
      
      const badge = document.getElementById('requestBadge');
      if (pendingRequests > 0) {
        badge.textContent = pendingRequests;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
      
      const thisMonth = new Date();
      const monthStart = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
      document.getElementById('statMonth').textContent = sops.filter(s => new Date(s.createdAt || s.updatedAt) >= monthStart).length;
    }
    
    function updateDropdowns() {
      const deptFilter = document.getElementById('deptFilter');
      const sopDept = document.getElementById('sopDept');
      const reqDept = document.getElementById('reqDept');
      const tagFilter = document.getElementById('tagFilter');
      
      deptFilter.innerHTML = '<option value="">All Departments</option>' + settings.departments.map(d => '<option value="' + esc(d.name) + '">' + esc(d.name) + '</option>').join('');
      sopDept.innerHTML = '<option value="">Select department...</option>' + settings.departments.map(d => '<option value="' + esc(d.name) + '">' + esc(d.name) + '</option>').join('');
      reqDept.innerHTML = '<option value="">Any</option>' + settings.departments.map(d => '<option value="' + esc(d.name) + '">' + esc(d.name) + '</option>').join('');
      tagFilter.innerHTML = '<option value="">All Tags</option>' + settings.tags.map(t => '<option value="' + esc(t.name) + '">' + esc(t.name.charAt(0).toUpperCase() + t.name.slice(1)) + '</option>').join('');
      
      renderEditTags();
    }
    
    function renderEditTags() {
      const list = document.getElementById('editTagsList');
      list.innerHTML = settings.tags.map(t =>
        '<div class="tag-item"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="tag_' + esc(t.name) + '"><span class="sop-tag ' + esc(t.color) + '">' + esc(t.name) + '</span></label></div>'
      ).join('') + '<button type="button" class="add-tag-btn" onclick="showInlineAdd(\'tag\')"><i class="ph-duotone ph-plus"></i> Add</button>';
      renderInlineTagColors();
    }
    
    function getSelectedTags() {
      return settings.tags.filter(t => {
        const cb = document.getElementById('tag_' + t.name);
        return cb && cb.checked;
      }).map(t => t.name);
    }
    
    function renderRequests() {
      const list = document.getElementById('requestList');
      const pending = sopRequests.filter(r => !r.completed);
      const completed = sopRequests.filter(r => r.completed);
      
      document.getElementById('pendingCount').textContent = pending.length;
      document.getElementById('completedCount').textContent = completed.length;
      
      const reqs = currentRequestTab === 'pending' ? pending : completed;
      
      if (reqs.length === 0) {
        list.innerHTML = '<div class="request-empty"><i class="ph-duotone ph-clipboard"></i><p>' + (currentRequestTab === 'pending' ? 'No pending requests' : 'No completed requests') + '</p></div>';
        return;
      }
      
      list.innerHTML = reqs.map(r => {
        const isOverdue = r.dueDate && new Date(r.dueDate) < new Date() && !r.completed;
        return '<div class="request-item ' + (r.completed ? 'completed' : '') + '">' +
          '<div class="request-item-header">' +
            '<div class="request-item-title">' + esc(r.title) + '</div>' +
            '<span class="request-item-priority ' + r.priority + '">' + r.priority + '</span>' +
          '</div>' +
          (r.notes ? '<div class="request-item-desc">' + esc(r.notes) + '</div>' : '') +
          '<div class="request-item-meta">' +
            (r.dept ? '<span><i class="ph-duotone ph-folder"></i>' + esc(r.dept) + '</span>' : '') +
            (r.assignee ? '<span><i class="ph-duotone ph-user"></i>' + esc(r.assignee) + '</span>' : '') +
            (r.dueDate ? '<span' + (isOverdue ? ' style="color:var(--danger)"' : '') + '><i class="ph-duotone ph-calendar"></i>' + r.dueDate + (isOverdue ? ' OVERDUE' : '') + '</span>' : '') +
            '<span><i class="ph-duotone ph-clock"></i>Created ' + fmtDate(r.createdAt) + '</span>' +
          '</div>' +
          '<div class="request-item-actions">' +
            (!r.completed ? '<button class="request-action-create" onclick="createSOPFromRequest(\'' + r.id + '\')"><i class="ph-duotone ph-file-plus"></i> Create SOP</button>' : '') +
            (!r.completed ? '<button class="request-action-complete" onclick="completeRequest(\'' + r.id + '\')"><i class="ph-duotone ph-check"></i> Done</button>' : '') +
            '<button class="request-action-delete" onclick="deleteRequest(\'' + r.id + '\')"><i class="ph-duotone ph-trash"></i></button>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    // =====================================================
    // Modal Management
    // =====================================================
    
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      // End tutorial if closing edit modal
      if (id === 'editModal' && tutorialActive) {
        endTutorial();
      }
      // Reset view stack when closing view modal
      if (id === 'viewModal') {
        sopViewStack = [];
      }
    }
    
    function openCreateModal() {
      currentSopId = null;
      // Start with empty steps for tutorial - user will click "Add" to create first step
      editingSteps = [];
      editingLinkedSops = [];
      window.sopTranslations = {};

      document.getElementById('modalTitle').innerHTML = '<i class="ph-duotone ph-file-text"></i> Create New SOP';
      document.getElementById('sopTitle').value = '';
      document.getElementById('sopDept').value = '';
      document.getElementById('sopDocNum').value = '';
      document.getElementById('sopRevision').value = '1.0';
      document.getElementById('sopStatus').value = 'draft';
      document.getElementById('sopDesc').value = '';

      settings.tags.forEach(t => {
        const cb = document.getElementById('tag_' + t.name);
        if (cb) cb.checked = false;
      });

      renderSteps();
      renderEditLinkedSops();
      openModal('editModal');

      // Start tutorial walkthrough
      setTimeout(() => startTutorial(), 300);
    }
    
    function editSOP(id) {
      const s = sops.find(x => x.id == id);
      if (!s) return;

      currentSopId = id;
      editingSteps = (s.steps || []).map(st => ({ ...st }));
      if (editingSteps.length === 0) {
        editingSteps = [{ title: '', description: '', image: '', safety: false, quality: false }];
      }
      editingLinkedSops = (s.linkedSops || []).map(l => ({ ...l }));

      window.sopTranslations = {
        title_es: s.title_es || '',
        desc_es: s.desc_es || ''
      };

      document.getElementById('modalTitle').innerHTML = '<i class="ph-duotone ph-pencil-simple"></i> Edit SOP';
      document.getElementById('sopTitle').value = s.title;
      document.getElementById('sopDept').value = s.dept;
      document.getElementById('sopDocNum').value = s.docNum || '';
      document.getElementById('sopRevision').value = s.revision || '1.0';
      document.getElementById('sopStatus').value = s.status || 'draft';
      document.getElementById('sopDesc').value = s.description || '';

      settings.tags.forEach(t => {
        const cb = document.getElementById('tag_' + t.name);
        if (cb) cb.checked = (s.tags || []).includes(t.name);
      });

      renderSteps();
      renderEditLinkedSops();
      openModal('editModal');
    }
    
    function editCurrentSOP() {
      closeModal('viewModal');
      editSOP(currentSopId);
    }
    
    async function viewSOP(id) {
      const s = sops.find(x => x.id == id);
      if (!s) return;

      currentSopId = id;
      sopViewStack = [];  // Reset view stack when opening fresh
      openModal('viewModal');
      // Use setViewLang to trigger auto-translation if needed
      await setViewLang('en');
    }

    // =====================================================
    // SOP Linking Functions
    // =====================================================

    function openLinkSopModal(context) {
      // context: 'header' or step index (number)
      linkingContext = context;
      selectedLinkSopId = null;
      document.getElementById('linkSopSearch').value = '';
      document.getElementById('linkLabelSelect').value = 'Required before';
      document.getElementById('customLabelGroup').style.display = 'none';
      document.getElementById('customLabelEn').value = '';
      document.getElementById('customLabelEs').value = '';
      renderLinkSopList();
      openModal('linkSopModal');
    }

    function closeLinkSopModal() {
      closeModal('linkSopModal');
      linkingContext = null;
      selectedLinkSopId = null;
    }

    function filterLinkSops() {
      renderLinkSopList();
    }

    function renderLinkSopList() {
      const search = document.getElementById('linkSopSearch').value.toLowerCase();
      const list = document.getElementById('linkSopList');

      // Filter out current SOP and already linked SOPs
      const alreadyLinked = linkingContext === 'header'
        ? editingLinkedSops.map(l => l.sopId)
        : (editingSteps[linkingContext]?.refs || []).map(r => r.sopId);

      const available = sops.filter(s =>
        s.id != currentSopId &&
        !alreadyLinked.includes(String(s.id)) &&
        !alreadyLinked.includes(s.id) &&
        (s.title.toLowerCase().includes(search) || (s.docNum || '').toLowerCase().includes(search))
      );

      if (available.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">No SOPs available</div>';
        return;
      }

      list.innerHTML = available.map(s =>
        '<label class="link-sop-item' + (selectedLinkSopId == s.id ? ' selected' : '') + '">' +
          '<input type="radio" name="linkSop" value="' + s.id + '" onchange="selectLinkSop(\'' + s.id + '\')"' + (selectedLinkSopId == s.id ? ' checked' : '') + '>' +
          '<div>' +
            '<div class="link-sop-item-title">' + esc(s.title) + '</div>' +
            '<div class="link-sop-item-meta">' + (s.docNum || 'No ID') + ' ‚Ä¢ ' + s.dept + ' ‚Ä¢ ' + (s.steps?.length || 0) + ' steps</div>' +
          '</div>' +
        '</label>'
      ).join('');
    }

    function selectLinkSop(id) {
      selectedLinkSopId = id;
      renderLinkSopList();
    }

    function toggleCustomLabel() {
      const select = document.getElementById('linkLabelSelect');
      const customGroup = document.getElementById('customLabelGroup');
      customGroup.style.display = select.value === '__custom__' ? 'block' : 'none';
    }

    function confirmLinkSop() {
      if (!selectedLinkSopId) {
        showToast('Select an SOP', 'error');
        return;
      }

      const select = document.getElementById('linkLabelSelect');
      let labelEn, labelEs;

      if (select.value === '__custom__') {
        labelEn = document.getElementById('customLabelEn').value.trim();
        labelEs = document.getElementById('customLabelEs').value.trim();
        if (!labelEn) {
          showToast('Enter English label', 'error');
          return;
        }
        if (!labelEs) labelEs = labelEn; // Fallback
      } else {
        const preset = LINK_LABELS.find(l => l.en === select.value);
        labelEn = preset.en;
        labelEs = preset.es;
      }

      const link = { sopId: selectedLinkSopId, label: labelEn, label_es: labelEs };

      if (linkingContext === 'header') {
        editingLinkedSops.push(link);
        renderEditLinkedSops();
      } else {
        // Step-level link
        if (!editingSteps[linkingContext].refs) {
          editingSteps[linkingContext].refs = [];
        }
        editingSteps[linkingContext].refs.push(link);
        renderSteps();
      }

      closeLinkSopModal();
    }

    function removeLinkedSop(index) {
      editingLinkedSops.splice(index, 1);
      renderEditLinkedSops();
    }

    function removeStepRef(stepIndex, refIndex) {
      editingSteps[stepIndex].refs.splice(refIndex, 1);
      renderSteps();
    }

    function getSopById(id) {
      return sops.find(s => s.id == id);
    }

    function renderEditLinkedSops() {
      const container = document.getElementById('editLinkedSopsList');
      if (!container) return;

      if (editingLinkedSops.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">' + t('noLinkedSops') + '</div>';
        return;
      }

      // Group by label
      const groups = {};
      editingLinkedSops.forEach((link, i) => {
        const label = appLang === 'es' ? (link.label_es || link.label) : link.label;
        if (!groups[label]) groups[label] = [];
        groups[label].push({ ...link, index: i });
      });

      container.innerHTML = Object.entries(groups).map(([label, links]) =>
        '<div class="linked-sops-group">' +
          '<div class="linked-sops-label">' + esc(label) + ':</div>' +
          '<div class="linked-sops-chips">' +
            links.map(link => {
              const s = getSopById(link.sopId);
              const title = s ? (s['title_' + appLang] || s.title) : '[Deleted SOP]';
              return '<span class="sop-link-chip">' +
                '<i class="ph-duotone ph-file-text"></i> ' + esc(title) +
                ' <span class="remove-link" onclick="removeLinkedSop(' + link.index + ')">&times;</span>' +
              '</span>';
            }).join('') +
          '</div>' +
        '</div>'
      ).join('');
    }

    // =====================================================
    // SOP Preview Popup Functions
    // =====================================================

    function showSopPreview(sopId, event) {
      event.stopPropagation();
      const s = getSopById(sopId);
      if (!s) return;

      previewingSopId = sopId;
      const lang = viewLang;

      document.getElementById('previewTitle').textContent = s['title_' + lang] || s.title;
      document.getElementById('previewDocNum').textContent = s.docNum || '';
      document.getElementById('previewMeta').textContent = s.dept + ' ‚Ä¢ ' + (s.steps?.length || 0) + ' steps ‚Ä¢ ' + (s.status || 'draft');
      document.getElementById('previewDesc').textContent = s['desc_' + lang] || s.description || 'No description';

      const popup = document.getElementById('sopPreviewPopup');
      popup.style.display = 'block';

      // Position popup
      const rect = event.target.getBoundingClientRect();

      // Center on mobile, near element on desktop
      if (window.innerWidth < 600) {
        popup.style.left = '50%';
        popup.style.top = '50%';
        popup.style.transform = 'translate(-50%, -50%)';
      } else {
        popup.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
        popup.style.top = (rect.bottom + 10) + 'px';
        popup.style.transform = 'none';
      }
    }

    function closePreviewPopup() {
      document.getElementById('sopPreviewPopup').style.display = 'none';
      previewingSopId = null;
    }

    function openPreviewedSop() {
      if (!previewingSopId) return;
      closePreviewPopup();

      // Save current SOP to stack for back navigation
      if (currentSopId) {
        sopViewStack.push({
          sopId: currentSopId,
          scrollTop: document.getElementById('viewModalBody')?.scrollTop || 0
        });
      }

      // Open the previewed SOP
      const s = getSopById(previewingSopId);
      if (s) {
        currentSopId = previewingSopId;
        renderViewSOP(s);
      }
    }

    function goBackSop() {
      if (sopViewStack.length === 0) return;

      const prev = sopViewStack.pop();
      const s = getSopById(prev.sopId);
      if (s) {
        currentSopId = prev.sopId;
        renderViewSOP(s);
        // Restore scroll position
        setTimeout(() => {
          const body = document.getElementById('viewModalBody');
          if (body) body.scrollTop = prev.scrollTop;
        }, 50);
      }
    }

    // Close preview on click outside
    document.addEventListener('click', function(e) {
      const popup = document.getElementById('sopPreviewPopup');
      if (popup && popup.style.display === 'block' && !popup.contains(e.target) && !e.target.closest('.sop-link-chip')) {
        closePreviewPopup();
      }
    });

    function renderViewSOP(s) {
      if (!s) return;
      const lang = viewLang;
      const title = s['title_' + lang] || s.title;
      const desc = s['desc_' + lang] || s.description;
      const u = window.location.origin + window.location.pathname + '?view=' + s.id;

      // Render linked SOPs section
      let linkedHtml = '';
      if (s.linkedSops && s.linkedSops.length > 0) {
        const groups = {};
        s.linkedSops.forEach(link => {
          const label = lang === 'es' ? (link.label_es || link.label) : link.label;
          if (!groups[label]) groups[label] = [];
          groups[label].push(link);
        });

        linkedHtml = '<div class="linked-sops-section" style="margin-top:16px;">' +
          Object.entries(groups).map(([label, links]) =>
            '<div class="linked-sops-group">' +
              '<div class="linked-sops-label"><i class="ph-duotone ph-link"></i> ' + esc(label) + ':</div>' +
              '<div class="linked-sops-chips">' +
                links.map(link => {
                  const linked = getSopById(link.sopId);
                  if (!linked) return '<span class="sop-link-chip" style="opacity:0.5;">[Deleted SOP]</span>';
                  const linkTitle = linked['title_' + lang] || linked.title;
                  return '<span class="sop-link-chip" onclick="showSopPreview(\'' + link.sopId + '\', event)">' +
                    '<i class="ph-duotone ph-file-text"></i> ' + esc(linkTitle) +
                  '</span>';
                }).join('') +
              '</div>' +
            '</div>'
          ).join('') +
        '</div>';
      }

      // Back button if we came from another SOP
      const backBtn = sopViewStack.length > 0
        ? '<button class="view-back-btn" onclick="goBackSop()"><i class="ph-duotone ph-arrow-left"></i> ' + t('backTo') + ' "' + esc(getSopById(sopViewStack[sopViewStack.length-1].sopId)?.title || 'Previous') + '"</button>'
        : '';

      const stepsHtml = (s.steps || []).map((st, i) => {
        const stepTitle = st['title_' + lang] || st.title;
        const stepDesc = st['desc_' + lang] || st.description;
        const mediaUrl = st.media || st.image || '';
        const mediaType = st.mediaType || detectMediaType(mediaUrl);
        const isVideo = mediaType === 'video' || mediaType === 'youtube' || mediaType === 'gdrive' || mediaType === 'vimeo';

        let mediaHtml = '';
        if (mediaUrl) {
          if (isVideo) {
            if (mediaType === 'youtube') {
              const embedUrl = getYouTubeEmbedUrl(mediaUrl);
              mediaHtml = '<div class="view-step-video"><iframe src="' + embedUrl + '?rel=0" allowfullscreen></iframe></div>';
            } else {
              mediaHtml = '<div class="view-step-video"><video src="' + mediaUrl + '" controls playsinline></video></div>';
            }
          } else {
            mediaHtml = '<div class="view-step-image"><img src="' + mediaUrl + '"></div>';
          }
        }

        // Step refs in view mode
        let stepRefsHtml = '';
        if (st.refs && st.refs.length > 0) {
          stepRefsHtml = '<div class="step-refs" style="margin-top:8px;">' +
            st.refs.map(ref => {
              const linked = getSopById(ref.sopId);
              if (!linked) return '';
              const refTitle = linked['title_' + lang] || linked.title;
              return '<span class="sop-link-chip step-ref-chip" onclick="showSopPreview(\'' + ref.sopId + '\', event)">' +
                '<i class="ph-duotone ph-link"></i> ' + esc(refTitle) +
              '</span>';
            }).join('') +
          '</div>';
        }

        return '<div class="view-step">' +
          '<div class="view-step-number">' + (i + 1) + '</div>' +
          '<div class="view-step-content">' +
            '<div class="view-step-title">' + esc(stepTitle) +
              (st.safety ? ' <i class="ph-duotone ph-warning icon safety"></i>' : '') +
              (st.quality ? ' <i class="ph-duotone ph-seal-check icon quality"></i>' : '') +
            '</div>' +
            '<div class="view-step-desc">' + esc(stepDesc) + '</div>' +
            stepRefsHtml +
          '</div>' +
          mediaHtml +
        '</div>';
      }).join('');

      document.getElementById('viewModalBody').innerHTML =
        backBtn +
        '<div class="view-sop-header"><div><div class="view-sop-title">' + esc(title) + '</div>' +
        '<div class="view-sop-meta">' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-folder"></i> ' + esc(s.dept) + '</div>' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-hash"></i> ' + esc(s.docNum || 'N/A') + '</div>' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-git-branch"></i> Rev ' + esc(s.revision || '1.0') + '</div>' +
          '<div class="view-sop-meta-item"><i class="ph-duotone ph-calendar"></i> ' + fmtDate(s.updatedAt) + '</div>' +
        '</div>' +
        (desc ? '<p style="margin-top:12px;color:var(--text-muted)">' + esc(desc) + '</p>' : '') +
        linkedHtml +
        '</div>' +
        '<div class="view-sop-qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=78x78&data=' + encodeURIComponent(u) + '" width="78" height="78"></div></div>' +
        stepsHtml;
    }
    
    function showQR(id) {
      const s = sops.find(x => x.id == id);
      if (!s) return;
      
      currentSopId = id;
      const u = window.location.origin + window.location.pathname + '?view=' + id;
      document.getElementById('qrImage').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(u);
      document.getElementById('qrUrl').textContent = u;
      openModal('qrModal');
    }
    
    function downloadQR() {
      const img = document.getElementById('qrImage');
      const a = document.createElement('a');
      a.href = img.src;
      a.download = 'sop-qr-' + currentSopId + '.png';
      a.click();
    }
    
    function openRequestsModal() {
      renderRequests();
      openModal('requestsModal');
    }
    
    function openSettingsModal() {
      renderSettingsDepts();
      renderSettingsTags();
      openModal('settingsModal');
    }
    
    function setRequestTab(tab) {
      currentRequestTab = tab;
      document.getElementById('tabPending').classList.toggle('active', tab === 'pending');
      document.getElementById('tabCompleted').classList.toggle('active', tab === 'completed');
      document.getElementById('addRequestForm').style.display = tab === 'pending' ? 'block' : 'none';
      renderRequests();
    }
    
    function createSOPFromRequest(id) {
      const req = sopRequests.find(r => r.id == id);
      if (!req) return;
      
      closeModal('requestsModal');
      openCreateModal();
      
      document.getElementById('sopTitle').value = req.title;
      if (req.dept) document.getElementById('sopDept').value = req.dept;
    }
    
    // =====================================================
    // Steps Management
    // =====================================================
    
    function renderSteps() {
      const list = document.getElementById('stepsList');
      list.innerHTML = editingSteps.map((s, i) => {
        // Determine media source (prefer new media field, fallback to image)
        const mediaUrl = s.media || s.image || '';
        const mediaType = s.mediaType || detectMediaType(mediaUrl);
        const hasMedia = !!mediaUrl;
        const isVideo = mediaType === 'video' || mediaType === 'youtube' || mediaType === 'gdrive' || mediaType === 'vimeo';

        let mediaPreviewHtml = '';
        if (hasMedia) {
          if (isVideo) {
            if (mediaType === 'youtube') {
              const embedUrl = getYouTubeEmbedUrl(mediaUrl);
              mediaPreviewHtml = '<div class="step-media-preview" style="position:relative;width:100%;height:100%;">' +
                '<img src="https://img.youtube.com/vi/' + (mediaUrl.match(/(?:youtu\.be\/|v=)([^&]+)/)?.[1] || '') + '/mqdefault.jpg" style="width:100%;height:100%;object-fit:cover;">' +
                '<div class="video-play-overlay"><i class="ph-duotone ph-youtube-logo"></i></div>' +
                '<span class="media-type-badge"><i class="ph-duotone ph-youtube-logo"></i></span>' +
              '</div>';
            } else {
              mediaPreviewHtml = '<div class="step-media-preview" style="position:relative;width:100%;height:100%;">' +
                '<video src="' + esc(mediaUrl) + '" style="width:100%;height:100%;object-fit:cover;" muted playsinline></video>' +
                '<div class="video-play-overlay"><i class="ph-duotone ph-play"></i></div>' +
                '<span class="media-type-badge"><i class="ph-duotone ph-video-camera"></i></span>' +
              '</div>';
            }
          } else {
            // Check if it's a base64 image (editable) vs URL image (not editable)
            const isBase64Image = mediaUrl.startsWith('data:image');
            mediaPreviewHtml = '<img src="' + esc(mediaUrl) + '">';
            if (isBase64Image) {
              mediaPreviewHtml += '<button type="button" class="step-image-edit-btn" onclick="event.stopPropagation(); openAnnotationEditor(' + i + ')" title="Edit Image"><i class="ph-duotone ph-pencil-simple"></i></button>';
            }
          }
        } else {
          mediaPreviewHtml = '<div class="placeholder"><i class="ph-duotone ph-image"></i>' + t('addImage') + '/' + t('addVideo').split(' ')[1] + '</div>';
        }

        return '<div class="step-item" data-index="' + i + '">' +
          '<div class="step-number">' + (i + 1) + '</div>' +
          '<div class="step-content">' +
            '<input type="text" class="step-title-input" placeholder="' + t('stepTitle') + '" value="' + esc(s.title) + '" onchange="updateStep(' + i + ',\'title\',this.value)">' +
            '<textarea class="step-desc-input" placeholder="' + t('stepDesc') + '" onchange="updateStep(' + i + ',\'description\',this.value)">' + esc(s.description) + '</textarea>' +
            '<div class="step-icons">' +
              '<button type="button" class="step-icon-btn safety ' + (s.safety ? 'active' : '') + '" onclick="toggleStepFlag(' + i + ',\'safety\')" title="Safety Warning"><i class="ph-duotone ph-warning"></i></button>' +
              '<button type="button" class="step-icon-btn quality ' + (s.quality ? 'active' : '') + '" onclick="toggleStepFlag(' + i + ',\'quality\')" title="Quality Checkpoint"><i class="ph-duotone ph-seal-check"></i></button>' +
              (hasMedia ? '<button type="button" class="step-icon-btn" onclick="clearStepMedia(' + i + ')" title="Remove media"><i class="ph-duotone ph-trash"></i></button>' : '') +
            '</div>' +
            '<div class="step-refs">' +
              (s.refs || []).map((ref, ri) => {
                const linked = getSopById(ref.sopId);
                const refTitle = linked ? (linked.title) : '[Deleted]';
                return '<span class="sop-link-chip step-ref-chip">' +
                  '<i class="ph-duotone ph-link"></i> ' + esc(refTitle) +
                  ' <span class="remove-link" onclick="event.stopPropagation();removeStepRef(' + i + ',' + ri + ')">&times;</span>' +
                '</span>';
              }).join('') +
              '<button type="button" class="sop-link-chip step-ref-chip" onclick="openLinkSopModal(' + i + ')" style="background:transparent;border-style:dashed;">' +
                '<i class="ph-duotone ph-plus"></i> Link' +
              '</button>' +
            '</div>' +
          '</div>' +
          '<div class="step-image">' +
            '<div class="step-image-preview ' + (hasMedia ? 'has-image' : '') + '" onclick="openMediaModal(' + i + ')">' +
              mediaPreviewHtml +
            '</div>' +
          '</div>' +
          '<div class="step-actions">' +
            '<button type="button" class="step-ai-btn" onclick="aiImproveStep(' + i + ')" title="AI Improve"><i class="ph-duotone ph-sparkle"></i></button>' +
            '<button type="button" class="step-action-btn" onclick="moveStep(' + i + ',-1)" title="Move Up"><i class="ph-duotone ph-caret-up"></i></button>' +
            '<button type="button" class="step-action-btn" onclick="moveStep(' + i + ',1)" title="Move Down"><i class="ph-duotone ph-caret-down"></i></button>' +
            '<button type="button" class="step-action-btn delete" onclick="removeStep(' + i + ')" title="Delete"><i class="ph-duotone ph-trash"></i></button>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function clearStepMedia(i) {
      editingSteps[i].media = '';
      editingSteps[i].mediaType = null;
      editingSteps[i].image = '';
      renderSteps();
    }
    
    function addStep() {
      editingSteps.push({ title: '', description: '', image: '', safety: false, quality: false });
      renderSteps();
    }
    
    function removeStep(i) {
      if (editingSteps.length === 1) {
        showToast('Need at least 1 step', 'error');
        return;
      }
      editingSteps.splice(i, 1);
      renderSteps();
    }
    
    function updateStep(i, field, value) {
      editingSteps[i][field] = value;
    }
    
    function toggleStepFlag(i, flag) {
      editingSteps[i][flag] = !editingSteps[i][flag];
      renderSteps();
    }
    
    function moveStep(i, dir) {
      const newIndex = i + dir;
      if (newIndex < 0 || newIndex >= editingSteps.length) return;
      [editingSteps[i], editingSteps[newIndex]] = [editingSteps[newIndex], editingSteps[i]];
      renderSteps();
    }
    
    function promptStepImage(i) {
      // Legacy function - now opens the media modal
      openMediaModal(i);
    }
    
    // =====================================================
    // Settings Management
    // =====================================================
    
    function renderSettingsDepts() {
      document.getElementById('settingsDeptList').innerHTML = settings.departments.map(d =>
        '<div class="settings-item"><i class="ph-duotone ' + esc(d.icon || 'ph-folder') + '"></i><span>' + esc(d.name) + '</span><button class="item-delete" onclick="deleteDepartment(\'' + esc(d.name) + '\')"><i class="ph-duotone ph-x"></i></button></div>'
      ).join('');
    }

    function renderSettingsTags() {
      document.getElementById('settingsTagList').innerHTML = settings.tags.map(t =>
        '<div class="settings-item"><span class="sop-tag ' + esc(t.color) + '">' + esc(t.name) + '</span><button class="item-delete" onclick="deleteTag(\'' + esc(t.name) + '\')"><i class="ph-duotone ph-x"></i></button></div>'
      ).join('');
    }
    
    function addDepartment() {
      const input = document.getElementById('newDeptInput');
      const name = input.value.trim();
      if (!name) return;
      if (settings.departments.find(d => d.name.toLowerCase() === name.toLowerCase())) {
        showToast('Already exists', 'error');
        return;
      }
      settings.departments.push({ name: name, icon: 'ph-folder' });
      saveSettingsToServer();
      renderSettingsDepts();
      updateDropdowns();
      input.value = '';
      showToast('Added', 'success');
    }
    
    function deleteDepartment(name) {
      if (settings.departments.length <= 1) {
        showToast('Need at least 1', 'error');
        return;
      }
      settings.departments = settings.departments.filter(d => d.name !== name);
      saveSettingsToServer();
      renderSettingsDepts();
      updateDropdowns();
      showToast('Deleted', 'success');
    }
    
    function selectTagColor(color) {
      selectedTagColor = color;
      document.querySelectorAll('.tag-color-option').forEach(e => e.classList.toggle('selected', e.dataset.color === color));
    }
    
    function addTag() {
      const input = document.getElementById('newTagInput');
      const name = input.value.trim().toLowerCase();
      if (!name) return;
      if (settings.tags.find(t => t.name === name)) {
        showToast('Already exists', 'error');
        return;
      }
      settings.tags.push({ name: name, color: selectedTagColor });
      saveSettingsToServer();
      renderSettingsTags();
      updateDropdowns();
      input.value = '';
      showToast('Added', 'success');
    }
    
    function deleteTag(name) {
      if (settings.tags.length <= 1) {
        showToast('Need at least 1', 'error');
        return;
      }
      settings.tags = settings.tags.filter(t => t.name !== name);
      saveSettingsToServer();
      renderSettingsTags();
      updateDropdowns();
      showToast('Deleted', 'success');
    }
    
    async function saveSettingsToServer() {
      try {
        await fetch(API_URL + '?action=saveSettings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ settings: settings })
        });
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }
    
    function showInlineAdd(type) {
      document.getElementById('inlineAdd' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'block';
    }
    
    function hideInlineAdd(type) {
      document.getElementById('inlineAdd' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'none';
    }
    
    function addDeptInline() {
      const input = document.getElementById('newDeptInline');
      const name = input.value.trim();
      if (!name) return;
      if (settings.departments.find(d => d.name.toLowerCase() === name.toLowerCase())) {
        showToast('Already exists', 'error');
        return;
      }
      settings.departments.push({ name: name, icon: 'ph-folder' });
      saveSettingsToServer();
      updateDropdowns();
      document.getElementById('sopDept').value = name;
      input.value = '';
      hideInlineAdd('dept');
      showToast('Added', 'success');
    }
    
    function renderInlineTagColors() {
      const container = document.getElementById('inlineTagColors');
      if (!container) return;
      const colors = ['gold', 'green', 'sungrown', 'greenhouse', 'indoor', 'danger'];
      container.innerHTML = colors.map(c => 
        '<div class="color-dot ' + (c === selectedTagColor ? 'selected' : '') + '" style="background:var(--' + c + ')" onclick="selectInlineTagColor(\'' + c + '\')"></div>'
      ).join('');
    }
    
    function selectInlineTagColor(color) {
      selectedTagColor = color;
      renderInlineTagColors();
    }
    
    function addTagInline() {
      const input = document.getElementById('newTagInline');
      const name = input.value.trim().toLowerCase();
      if (!name) return;
      if (settings.tags.find(t => t.name === name)) {
        showToast('Already exists', 'error');
        return;
      }
      settings.tags.push({ name: name, color: selectedTagColor });
      saveSettingsToServer();
      updateDropdowns();
      input.value = '';
      hideInlineAdd('tag');
      showToast('Added', 'success');
    }
    
    // =====================================================
    // AI Features
    // =====================================================
    
    async function callAI(prompt) {
      try {
        const response = await fetch(API_URL + '?action=anthropic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-3-5-haiku-20241022',
            max_tokens: 500,
            messages: [{ role: 'user', content: prompt }]
          })
        });

        const raw = await response.json();
        const data = raw.data || raw; // Handle Vercel wrapper
        if (data.content && data.content[0]) {
          return data.content[0].text.trim();
        }
        return null;
      } catch (e) {
        console.error('AI error:', e);
        return null;
      }
    }
    
    // Detect if text is likely Spanish based on common words
    function detectLanguage(text) {
      if (!text) return 'en';
      const spanishWords = /\b(el|la|los|las|de|del|en|con|para|por|que|una?|es|son|est√°|est√°n|como|m√°s|pero|este|esta|hacer|tiene|debe|usar|verificar|asegurar|colocar|realizar|procedimiento|equipo|seguridad|calidad|paso|pasos|m√°quina|producto|material|revisar|limpiar|preparar|ajustar)\b/gi;
      const matches = text.match(spanishWords) || [];
      return matches.length >= 2 ? 'es' : 'en';
    }

    function getLanguageInstruction(text) {
      const lang = detectLanguage(text);
      if (lang === 'es') {
        return 'IMPORTANT: The input text is in Spanish. You MUST respond in Spanish. ';
      }
      return '';
    }

    async function aiImproveTitle() {
      const input = document.getElementById('sopTitle');
      const current = input.value.trim();
      if (!current) { showToast('Enter text first', 'error'); return; }

      const btn = document.querySelector('[onclick="aiImproveTitle()"]');
      btn.disabled = true;
      btn.classList.add('loading');

      const langInstruction = getLanguageInstruction(current);
      const improved = await callAI(langInstruction + 'Improve this SOP title to be clearer, more professional, and action-oriented. Keep it concise (under 10 words). Only return the improved title, nothing else:\n\n' + current);

      if (improved) {
        input.value = improved;
        showToast('Title improved!', 'success');
      } else {
        showToast('AI unavailable', 'error');
      }

      btn.disabled = false;
      btn.classList.remove('loading');
    }

    async function aiImproveDescription() {
      const input = document.getElementById('sopDesc');
      const current = input.value.trim();
      if (!current) { showToast('Enter text first', 'error'); return; }

      const btn = document.querySelector('[onclick="aiImproveDescription()"]');
      btn.disabled = true;
      btn.classList.add('loading');

      const langInstruction = getLanguageInstruction(current);
      const improved = await callAI(langInstruction + 'Improve this SOP description to be clearer and more professional. Keep it brief (2-3 sentences max). Only return the improved description:\n\n' + current);

      if (improved) {
        input.value = improved;
        showToast('Description improved!', 'success');
      } else {
        showToast('AI unavailable', 'error');
      }

      btn.disabled = false;
      btn.classList.remove('loading');
    }

    async function aiImproveStep(i) {
      const step = editingSteps[i];
      if (!step.title && !step.description) {
        showToast('Enter text first', 'error');
        return;
      }

      const btn = document.querySelectorAll('.step-ai-btn')[i];
      btn.disabled = true;

      const combinedText = (step.title || '') + ' ' + (step.description || '');
      const langInstruction = getLanguageInstruction(combinedText);
      const improved = await callAI(langInstruction + 'Improve this SOP step. Make the title action-oriented and clear. Make the description specific with measurable details where possible. Return as JSON: {"title": "...", "description": "..."}\n\nCurrent title: ' + (step.title || 'None') + '\nCurrent description: ' + (step.description || 'None'));

      if (improved) {
        try {
          const parsed = JSON.parse(improved);
          if (parsed.title) editingSteps[i].title = parsed.title;
          if (parsed.description) editingSteps[i].description = parsed.description;
          renderSteps();
          showToast('Step improved!', 'success');
        } catch (e) {
          showToast('AI response error', 'error');
        }
      } else {
        showToast('AI unavailable', 'error');
      }

      btn.disabled = false;
    }
    
    async function aiImproveAllSteps() {
      const btn = document.getElementById('aiImproveAllBtn');
      btn.disabled = true;
      btn.classList.add('loading');
      
      for (let i = 0; i < editingSteps.length; i++) {
        if (editingSteps[i].title || editingSteps[i].description) {
          await aiImproveStep(i);
        }
      }
      
      btn.disabled = false;
      btn.classList.remove('loading');
      showToast('All steps improved!', 'success');
    }
    
    async function testApiConnection() {
      const status = document.getElementById('apiKeyStatus');
      status.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite"></i> Testing...';

      try {
        const response = await fetch(API_URL + '?action=test');
        const raw = await response.json();
        const result = raw.data || raw; // Handle Vercel wrapper

        if (result.ok || result.success) {
          status.innerHTML = '<i class="ph-duotone ph-check-circle" style="color:var(--green)"></i> Connection successful!';
        } else {
          status.innerHTML = '<i class="ph-duotone ph-x-circle" style="color:var(--danger)"></i> ' + result.error;
        }
      } catch (e) {
        status.innerHTML = '<i class="ph-duotone ph-x-circle" style="color:var(--danger)"></i> Connection failed: ' + e.message;
      }
    }
    
    // =====================================================
    // Translation
    // =====================================================
    
    async function translateText(text, from, to) {
      if (!text || text.trim() === '') return '';
      
      const fromLang = from === 'en' ? 'English' : 'Spanish';
      const toLang = to === 'en' ? 'English' : 'Spanish';
      
      const translated = await callAI('Translate the following text from ' + fromLang + ' to ' + toLang + '. This is for a cannabis production facility SOP. Only return the translation:\n\n' + text);
      return translated || text;
    }
    
    function setEditLang(lang) {
      editLang = lang;
      document.querySelectorAll('#editLangToggle button').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(lang === 'en' ? 'eng' : 'esp')));
      document.getElementById('translateBtnText').textContent = lang === 'en' ? 'Auto-translate to Espa√±ol' : 'Auto-traducir a English';
    }
    
    async function autoTranslateSOP() {
      const btn = document.getElementById('autoTranslateBtn');
      const btnText = document.getElementById('translateBtnText');
      const origText = btnText.textContent;
      btn.disabled = true;
      btnText.textContent = 'Translating...';
      
      const fromLang = editLang;
      const toLang = editLang === 'en' ? 'es' : 'en';
      
      try {
        const title = document.getElementById('sopTitle').value;
        const desc = document.getElementById('sopDesc').value;
        
        const [transTitle, transDesc] = await Promise.all([
          translateText(title, fromLang, toLang),
          translateText(desc, fromLang, toLang)
        ]);
        
        for (let i = 0; i < editingSteps.length; i++) {
          const step = editingSteps[i];
          if (step.title) {
            step['title_' + toLang] = await translateText(step.title, fromLang, toLang);
            step['title_' + fromLang] = step.title;
          }
          if (step.description) {
            step['desc_' + toLang] = await translateText(step.description, fromLang, toLang);
            step['desc_' + fromLang] = step.description;
          }
        }
        
        window.sopTranslations = {
          ['title_' + fromLang]: title,
          ['title_' + toLang]: transTitle,
          ['desc_' + fromLang]: desc,
          ['desc_' + toLang]: transDesc
        };
        
        showToast('Translated! (' + fromLang.toUpperCase() + ' ‚Üí ' + toLang.toUpperCase() + ')', 'success');
      } catch (e) {
        console.error('Translation failed:', e);
        showToast('Translation failed', 'error');
      }
      
      btn.disabled = false;
      btnText.textContent = origText;
    }
    
    async function setViewLang(lang) {
      viewLang = lang;
      document.querySelectorAll('#viewLangToggle button').forEach(b => b.classList.toggle('active', b.textContent === lang.toUpperCase()));
      const s = sops.find(x => x.id == currentSopId);
      if (!s) return;

      // Auto-translate to Spanish if needed
      if (lang === 'es' && !s.title_es) {
        const esBtn = document.querySelector('#viewLangToggle button:last-child');
        esBtn.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite"></i>';
        esBtn.disabled = true;

        try {
          showToast('Translating to Spanish...', 'success');
          // Use title_en if available, otherwise fall back to base title
          const sourceTitle = s.title_en || s.title;
          const sourceDesc = s.desc_en || s.description;
          s.title_es = await translateText(sourceTitle, 'en', 'es');
          if (sourceDesc) s.desc_es = await translateText(sourceDesc, 'en', 'es');
          for (let step of (s.steps || [])) {
            const stepSourceTitle = step.title_en || step.title;
            const stepSourceDesc = step.desc_en || step.description;
            if (stepSourceTitle && !step.title_es) step.title_es = await translateText(stepSourceTitle, 'en', 'es');
            if (stepSourceDesc && !step.desc_es) step.desc_es = await translateText(stepSourceDesc, 'en', 'es');
          }
          showToast('Translation complete!', 'success');
        } catch (e) {
          console.error('Translation error:', e);
          showToast('Translation failed', 'error');
        }

        esBtn.innerHTML = 'ES';
        esBtn.disabled = false;
      }

      // Auto-translate to English if needed (for SOPs written in Spanish)
      if (lang === 'en' && !s.title_en) {
        // Helper to detect Spanish text (for legacy SOPs without sourceLang)
        const looksLikeSpanish = (text) => {
          if (!text) return false;
          // Common Spanish words
          const spanishWords = /\b(el|la|los|las|de|del|para|por|con|que|una|uno|es|est√°|est√°n|son|al|en|y|o|su|sus)\b/i;
          // Spanish-specific characters
          const spanishChars = /[√°√©√≠√≥√∫√º√±¬ø¬°]/i;
          return spanishWords.test(text) || spanishChars.test(text);
        };

        // Check if content appears to be in Spanish
        const needsEnglish = s.sourceLang === 'es' ||
          (s.title_es && s.title_es === s.title) ||
          looksLikeSpanish(s.title) ||
          looksLikeSpanish(s.description) ||
          (s.steps || []).some(st => looksLikeSpanish(st.title) || looksLikeSpanish(st.description));

        if (needsEnglish) {
          const enBtn = document.querySelector('#viewLangToggle button:first-child');
          enBtn.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite"></i>';
          enBtn.disabled = true;

          try {
            showToast('Translating to English...', 'success');
            // Use title_es if available, otherwise fall back to base title (which is in Spanish)
            const sourceTitle = s.title_es || s.title;
            const sourceDesc = s.desc_es || s.description;
            s.title_en = await translateText(sourceTitle, 'es', 'en');
            if (sourceDesc) s.desc_en = await translateText(sourceDesc, 'es', 'en');
            for (let step of (s.steps || [])) {
              const stepSourceTitle = step.title_es || step.title;
              const stepSourceDesc = step.desc_es || step.description;
              if (stepSourceTitle && !step.title_en) step.title_en = await translateText(stepSourceTitle, 'es', 'en');
              if (stepSourceDesc && !step.desc_en) step.desc_en = await translateText(stepSourceDesc, 'es', 'en');
            }
            showToast('Translation complete!', 'success');
          } catch (e) {
            console.error('Translation error:', e);
            showToast('Translation failed', 'error');
          }

          enBtn.innerHTML = 'EN';
          enBtn.disabled = false;
        }
      }

      renderViewSOP(s);
    }
    
    // =====================================================
    // PDF Generation
    // =====================================================

    async function fetchQRAsBase64(data, size = 80) {
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=' + size + 'x' + size + '&data=' + encodeURIComponent(data);
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => resolve(null);
          reader.readAsDataURL(blob);
        });
      } catch (e) {
        console.error('Failed to fetch QR:', e);
        return null;
      }
    }

    async function generatePDF() {
      const s = sops.find(x => x.id == currentSopId);
      if (!s) return;

      const btn = document.getElementById('generatePdfBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite"></i> Generating...';

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const lang = document.querySelector('input[name="pdfLang"]:checked').value;
      const includeQR = document.getElementById('pdfIncludeQR').checked;
      const title = s['title_' + lang] || s.title;
      const desc = s['desc_' + lang] || s.description;
      const sopViewUrl = window.location.origin + window.location.pathname + '?view=' + s.id;

      // Fetch main QR code
      let mainQRBase64 = null;
      if (includeQR) {
        mainQRBase64 = await fetchQRAsBase64(sopViewUrl, 60);
      }

      // Header with title and QR
      doc.setFontSize(18);
      doc.setTextColor(45, 58, 46);
      const titleLines = doc.splitTextToSize(title, includeQR && mainQRBase64 ? 140 : 170);
      doc.text(titleLines, 20, 22);

      // Add main QR code in top right
      if (mainQRBase64) {
        try {
          doc.addImage(mainQRBase64, 'PNG', 160, 10, 30, 30);
          doc.setFontSize(6);
          doc.setTextColor(120, 120, 120);
          doc.text('Scan to view', 167, 43);
        } catch (e) {
          console.error('Failed to add QR to PDF:', e);
        }
      }

      const titleHeight = titleLines.length * 7;
      doc.setFontSize(9);
      doc.setTextColor(90, 107, 95);
      doc.text('Department: ' + s.dept + '  |  Doc #: ' + (s.docNum || 'N/A') + '  |  Rev: ' + (s.revision || '1.0'), 20, 22 + titleHeight + 2);

      let y = 22 + titleHeight + 8;

      if (desc) {
        doc.setFontSize(10);
        doc.setTextColor(70, 70, 70);
        const descLines = doc.splitTextToSize(desc, 170);
        doc.text(descLines, 20, y);
        y += descLines.length * 5 + 8;
      }

      // Draw a separator line
      doc.setDrawColor(200, 200, 200);
      doc.line(20, y, 190, y);
      y += 8;

      // Steps
      for (let i = 0; i < (s.steps || []).length; i++) {
        const step = s.steps[i];
        if (y > 250) {
          doc.addPage();
          y = 20;
        }

        const stepTitle = step['title_' + lang] || step.title;
        const stepDesc = step['desc_' + lang] || step.description;
        const mediaUrl = step.media || step.image || '';
        const mediaType = step.mediaType || detectMediaType(mediaUrl);
        const isVideo = mediaType === 'video' || mediaType === 'youtube' || mediaType === 'gdrive' || mediaType === 'vimeo';
        const hasVideoQR = isVideo && mediaUrl && includeQR;

        // Step number circle (simulated with filled circle)
        doc.setFillColor(102, 137, 113);
        doc.circle(25, y - 2, 4, 'F');
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text(String(i + 1), 23.5, y);

        // Step title
        doc.setFontSize(12);
        doc.setTextColor(45, 58, 46);
        doc.setFont(undefined, 'bold');
        const stepTitleMaxWidth = hasVideoQR ? 130 : 155;
        const stepTitleLines = doc.splitTextToSize(stepTitle, stepTitleMaxWidth);
        doc.text(stepTitleLines, 33, y);
        doc.setFont(undefined, 'normal');

        // Safety/Quality indicators
        let iconX = 33 + doc.getTextWidth(stepTitleLines[0]) + 3;
        if (step.safety) {
          doc.setTextColor(196, 92, 74);
          doc.setFontSize(8);
          doc.text('‚ö† SAFETY', iconX, y);
          iconX += 25;
        }
        if (step.quality) {
          doc.setTextColor(102, 137, 113);
          doc.setFontSize(8);
          doc.text('‚úì QC', iconX, y);
        }

        y += stepTitleLines.length * 5 + 2;

        // Step description
        if (stepDesc) {
          doc.setFontSize(10);
          doc.setTextColor(80, 80, 80);
          const descMaxWidth = hasVideoQR ? 125 : 155;
          const lines = doc.splitTextToSize(stepDesc, descMaxWidth);
          doc.text(lines, 33, y);
          y += lines.length * 5;
        }

        // Video QR code (placed on the right side of the step)
        if (hasVideoQR) {
          const videoQR = await fetchQRAsBase64(mediaUrl, 50);
          if (videoQR) {
            try {
              const qrY = y - (stepTitleLines.length * 5 + (stepDesc ? 10 : 0));
              doc.addImage(videoQR, 'PNG', 165, qrY - 5, 25, 25);
              doc.setFontSize(6);
              doc.setTextColor(150, 150, 150);
              doc.text('Watch video', 168, qrY + 22);
            } catch (e) {
              console.error('Failed to add video QR:', e);
            }
          }
        }

        y += 12;
      }

      // Footer
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('Generated: ' + new Date().toLocaleDateString() + ' | Rogue Origin SOP Manager', 20, 285);

      doc.save('SOP-' + (s.docNum || s.id) + '.pdf');
      closeModal('pdfModal');
      showToast('PDF generated!', 'success');

      btn.disabled = false;
      btn.innerHTML = '<i class="ph-duotone ph-file-pdf"></i> Generate PDF';
    }
    
    // =====================================================
    // Utilities
    // =====================================================
    
    function setView(v) {
      document.getElementById('gridViewBtn').classList.toggle('active', v === 'grid');
      document.getElementById('listViewBtn').classList.toggle('active', v === 'list');
      document.getElementById('sopGrid').classList.toggle('hidden', v !== 'grid');
      document.getElementById('sopList').classList.toggle('active', v === 'list');
    }
    
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('sopDarkMode', document.body.classList.contains('dark-mode'));
    }
    
    function toggleAppLang() {
      appLang = appLang === 'en' ? 'es' : 'en';
      document.getElementById('appLangLabel').textContent = appLang.toUpperCase();
      localStorage.setItem('sopAppLang', appLang);
      applyTranslations();
      renderSteps(); // Re-render steps with new language placeholders
    }
    
    function refresh() {
      showToast('Refreshing...', 'success');
      loadData();
    }
    
    function generateDocNum() {
      return 'SOP-' + String(sops.length + 1).padStart(3, '0');
    }
    
    function fmtDate(d) {
      if (!d) return 'N/A';
      const date = new Date(d);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function esc(s) {
      if (!s) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function showToast(msg, type) {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      toast.className = 'toast show ' + type;
      toastMsg.textContent = msg;
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
    
    // =====================================================
    // Initialize
    // =====================================================
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load preferences
      if (localStorage.getItem('sopDarkMode') === 'true') {
        document.body.classList.add('dark-mode');
      }
      if (localStorage.getItem('sopAppLang')) {
        appLang = localStorage.getItem('sopAppLang');
        document.getElementById('appLangLabel').textContent = appLang.toUpperCase();
      }

      // Apply translations based on saved language preference
      applyTranslations();

      // Load data from API
      loadData();

      // Check for view parameter
      const urlParams = new URLSearchParams(window.location.search);
      const viewId = urlParams.get('view');
      if (viewId) {
        setTimeout(() => viewSOP(parseInt(viewId)), 1000);
      }
    });
  </script>
  <script src="../js/sw-register.js" async></script>
</body>
</html>
