<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Supersack Tracker — Rogue Origin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #141816;
      --bg-warm: #1a1f16;
      --card: rgba(26, 30, 27, 0.85);
      --card-border: rgba(102, 137, 113, 0.15);
      --glass: rgba(255, 255, 255, 0.05);
      --text: #e8e4dc;
      --text-dim: rgba(232,228,220,0.55);
      --text-faint: rgba(232,228,220,0.25);
      --green: #668971;
      --green-dim: rgba(102, 137, 113, 0.15);
      --green-glow: rgba(102, 137, 113, 0.25);
      --gold: #e4aa4f;
      --gold-dim: rgba(228, 170, 79, 0.15);
      --gold-text: #e4aa4f;
      --red: #c45c4a;
      --cyan: #e4aa4f;
      --blue: #62758d;
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --shadow: 0 4px 8px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
      --font-display: 'DM Serif Display', serif;
      --font-ui: 'Outfit', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(102, 137, 113, 0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(228, 170, 79, 0.04) 0%, transparent 60%);
    }

    /* Header */
    .header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(26, 30, 27, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .header h1 {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 400;
      letter-spacing: 0.01em;
      color: var(--text);
    }
    .header h1 span { color: var(--gold); }
    .header-date {
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-weight: 400;
    }

    /* Main */
    .main { padding: 16px 20px; max-width: 480px; margin: 0 auto; }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }
    .card-title {
      font-family: var(--font-ui);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--green);
      margin-bottom: 12px;
    }

    /* Date picker */
    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .date-input {
      background: var(--bg-warm);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 14px;
      padding: 10px 12px;
      flex: 1;
      outline: none;
      transition: border-color 0.2s;
    }
    .date-input:focus { border-color: var(--green); box-shadow: 0 0 0 2px var(--green-dim); }
    .today-btn {
      background: var(--green-dim);
      border: 1px solid rgba(102, 137, 113, 0.3);
      border-radius: var(--radius-sm);
      color: var(--green);
      font-family: var(--font-ui);
      font-size: 12px;
      font-weight: 600;
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .today-btn:active { background: rgba(102, 137, 113, 0.25); transform: scale(0.97); }

    /* Supersack counter */
    .counter-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin: 8px 0;
    }
    .counter-btn {
      width: 52px;
      height: 52px;
      border-radius: var(--radius);
      border: 1.5px solid var(--green);
      background: var(--green-dim);
      color: var(--green);
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 150ms;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .counter-btn:active {
      background: var(--green);
      color: var(--bg);
      transform: scale(0.95);
    }
    .counter-value {
      font-size: 48px;
      font-weight: 700;
      min-width: 80px;
      text-align: center;
      font-family: var(--font-mono);
      color: var(--text);
    }
    .counter-label {
      text-align: center;
      font-size: 11px;
      font-family: var(--font-ui);
      color: var(--text-dim);
      margin-top: 4px;
    }
    .counter-weight {
      text-align: center;
      font-size: 13px;
      color: var(--green);
      font-family: var(--font-mono);
      margin-top: 2px;
    }

    /* Weight inputs */
    .input-group { margin-bottom: 14px; }
    .input-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 6px;
      display: block;
      font-family: var(--font-ui);
    }
    .weight-input {
      width: 100%;
      background: var(--bg-warm);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 18px;
      font-family: var(--font-mono);
      padding: 10px 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .weight-input:focus { border-color: var(--gold); box-shadow: 0 0 0 2px var(--gold-dim); }
    .input-unit {
      font-size: 12px;
      color: var(--text-faint);
      margin-top: 4px;
      font-family: var(--font-ui);
    }

    /* Auto-pulled data */
    .auto-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 0;
      border-bottom: 1px solid rgba(102, 137, 113, 0.08);
    }
    .auto-row:last-child { border-bottom: none; }
    .auto-label { font-size: 13px; color: var(--text-dim); font-family: var(--font-ui); }
    .auto-value {
      font-size: 15px;
      font-weight: 600;
      font-family: var(--font-mono);
    }
    .auto-value.loading { color: var(--text-faint); }

    /* Breakdown bar */
    .breakdown-bar {
      height: 32px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      display: flex;
      margin: 14px 0;
      background: var(--bg-warm);
      border: 1px solid var(--card-border);
    }
    .breakdown-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--bg);
      transition: width 300ms ease;
      min-width: 0;
      overflow: hidden;
    }

    .breakdown-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      color: var(--text-dim);
      font-family: var(--font-ui);
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 3px;
    }

    /* Submit */
    .submit-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: var(--radius);
      background: linear-gradient(135deg, #e4aa4f, #d49a3f);
      color: #1a1f16;
      font-family: var(--font-ui);
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 150ms;
      letter-spacing: 0.03em;
      box-shadow: 0 4px 12px rgba(228, 170, 79, 0.3);
      text-transform: uppercase;
    }
    .submit-btn:hover { box-shadow: 0 6px 20px rgba(228, 170, 79, 0.4); }
    .submit-btn:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(228, 170, 79, 0.3); }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }
    .submit-btn.saving { background: linear-gradient(135deg, var(--green), #5a7a64); color: var(--text); }
    .submit-btn.error { background: linear-gradient(135deg, var(--red), #a04a3a); color: var(--text); }

    /* Status */
    .status-msg {
      text-align: center;
      font-size: 11px;
      font-family: var(--font-ui);
      margin-top: 10px;
      min-height: 16px;
    }
    .status-msg.success { color: var(--green); }
    .status-msg.error { color: var(--red); }

    /* Config */
    .config-toggle {
      background: none;
      border: none;
      color: var(--text-faint);
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
    }
    .config-panel { display: none; padding: 12px 0 0; }
    .config-panel.open { display: block; }
    .config-select {
      width: 100%;
      background: var(--bg-warm);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 12px;
      font-family: var(--font-ui);
      padding: 8px 10px;
      outline: none;
      margin-bottom: 8px;
      appearance: none;
    }
    .config-label {
      font-size: 10px;
      color: var(--text-faint);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 4px;
      display: block;
      font-family: var(--font-ui);
    }
    .config-save-btn {
      background: var(--green-dim);
      border: 1px solid rgba(102, 137, 113, 0.3);
      border-radius: var(--radius-sm);
      color: var(--green);
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-ui);
      padding: 8px 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 4px;
    }

    /* Strain counter rows */
    .strain-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 8px; border-bottom: 1px solid rgba(102, 137, 113, 0.08);
      border-radius: var(--radius-sm);
      margin: 0 -8px;
      transition: background 0.15s;
    }
    .strain-row:hover { background: rgba(102, 137, 113, 0.06); }
    .strain-row:last-child { border-bottom: none; }
    .strain-name {
      flex: 1; font-size: 13px; font-weight: 600; color: var(--text);
      font-family: var(--font-ui);
      line-height: 1.3;
    }
    .strain-name .sack-inventory {
      font-size: 11px; font-weight: 400; color: var(--text-faint);
    }
    .strain-counter {
      display: flex; align-items: center; gap: 6px; flex-shrink: 0;
    }
    .strain-counter .mini-btn {
      width: 40px; height: 40px; border-radius: var(--radius-sm);
      border: 1.5px solid rgba(102, 137, 113, 0.35); background: var(--green-dim);
      color: var(--green); font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      font-family: var(--font-ui);
    }
    .strain-counter .mini-btn:hover { background: rgba(102, 137, 113, 0.25); border-color: var(--green); }
    .strain-counter .mini-btn:active { transform: scale(0.9); background: var(--green); color: var(--bg); }
    .strain-counter input {
      width: 52px; text-align: center; font-size: 18px; font-weight: 700;
      background: var(--bg-warm); border: 1px solid var(--card-border);
      border-radius: var(--radius-sm); color: var(--gold-text); padding: 5px 0;
      font-family: var(--font-mono);
    }
    .strain-production {
      font-size: 11px; color: var(--text-faint); margin-top: 2px;
      font-family: var(--font-ui);
    }
    .strain-production span { margin-right: 8px; }

    /* Per-strain avg section */
    .avg-strain-section { margin-bottom: 12px; }
    .avg-strain-section:last-child { margin-bottom: 0; }
    .avg-strain-title {
      font-size: 12px; font-weight: 700; color: var(--gold);
      font-family: var(--font-ui);
      margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
    }

    /* Custom strain picker */
    .strain-picker-btn {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; padding: 12px 14px; font-size: 14px; font-weight: 600;
      border-radius: var(--radius); cursor: pointer; transition: all 0.2s;
      background: var(--green-dim);
      border: 1px solid rgba(102, 137, 113, 0.3); color: var(--green);
      font-family: var(--font-ui);
      box-sizing: border-box;
    }
    .strain-picker-btn:hover, .strain-picker.open .strain-picker-btn {
      border-color: var(--green); background: rgba(102, 137, 113, 0.2);
      box-shadow: 0 0 12px rgba(102, 137, 113, 0.15);
    }
    .strain-picker-arrow { font-size: 12px; opacity: 0.6; transition: transform 0.2s; }
    .strain-picker.open .strain-picker-arrow { transform: rotate(180deg); }
    .strain-picker-menu {
      display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      background: #1e2420; border: 1px solid rgba(102, 137, 113, 0.3);
      border-radius: var(--radius); overflow: hidden; z-index: 100;
      box-shadow: var(--shadow-lg);
      max-height: 240px; overflow-y: auto;
    }
    .strain-picker.open .strain-picker-menu { display: block; }
    .strain-picker-item {
      padding: 11px 14px; cursor: pointer; font-size: 13px;
      color: var(--text-dim); transition: all 0.15s;
      font-family: var(--font-ui);
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid rgba(102, 137, 113, 0.06);
    }
    .strain-picker-item:last-child { border-bottom: none; }
    .strain-picker-item:hover { background: var(--green-dim); color: var(--green); }
    .strain-picker-item.selected { background: rgba(102, 137, 113, 0.2); color: var(--green); font-weight: 600; }
    .strain-picker-item .sack-count { font-size: 12px; opacity: 0.5; font-weight: 400; }
    .strain-picker-item.selected .sack-count { opacity: 0.8; }
    .strain-picker-menu::-webkit-scrollbar { width: 4px; }
    .strain-picker-menu::-webkit-scrollbar-thumb { background: rgba(102, 137, 113, 0.4); border-radius: 2px; }

    /* Hide number input spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Color scheme for dark inputs */
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }

    /* Mobile optimizations */
    @media (max-width: 400px) {
      .main { padding: 12px 14px; }
      .card { padding: 14px; }
      .header { padding: 12px 14px; }
      .header h1 { font-size: 17px; }
      .counter-btn { width: 46px; height: 46px; font-size: 22px; }
      .counter-value { font-size: 40px; min-width: 70px; }
      .counter-row { gap: 12px; }
      .strain-name { font-size: 12px; }
      .strain-counter input { width: 44px; font-size: 16px; }
      .strain-counter .mini-btn { width: 34px; height: 34px; font-size: 18px; }
      .auto-label { font-size: 12px; }
      .auto-value { font-size: 14px; }
      .weight-input { font-size: 16px; padding: 12px; }
      .submit-btn { padding: 14px; font-size: 14px; }
      .breakdown-legend { gap: 6px; }
      .legend-item { font-size: 9px; }
    }

    /* Prevent iOS zoom on input focus (font-size must be >= 16px) */
    @media (max-width: 768px) {
      .weight-input, .date-input, input[type="number"] { font-size: 16px; }
      .strain-counter input { font-size: 16px; }
    }

    /* Safe area for notched phones */
    .main { padding-bottom: max(20px, env(safe-area-inset-bottom)); }

    /* Touch feedback for all interactive elements */
    @media (hover: none) {
      .counter-btn:active, .mini-btn:active, .today-btn:active, .submit-btn:active {
        transform: scale(0.93);
      }
      .strain-row:active { background: rgba(102, 137, 113, 0.08); }
    }
  </style>
</head>
<body>

<div class="header">
  <h1><span>◆</span> <span data-i18n="title">Supersack Tracker</span></h1>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="header-date" id="header-date"></span>
    <button id="lang-toggle" style="background:var(--gold-dim);border:1px solid rgba(228,170,79,0.3);border-radius:6px;color:var(--gold);font-size:11px;font-weight:700;padding:4px 10px;cursor:pointer;font-family:var(--font-ui)">ES</button>
  </div>
</div>

<div class="main">
  <!-- Date -->
  <div class="date-row">
    <input type="date" class="date-input" id="date-input">
    <button class="today-btn" id="today-btn">Today</button>
  </div>

  <!-- Supersack Count — per strain -->
  <div class="card">
    <div class="card-title" data-i18n="supersacksOpened">Supersacks Opened</div>
    <div id="strain-counters">
      <div style="color:var(--text-faint);font-size:13px;text-align:center;padding:12px;font-family:var(--font-ui)">Loading strains...</div>
    </div>
    <div style="margin-top:8px;text-align:center">
      <span class="counter-weight" id="raw-weight">0 lbs raw total</span>
    </div>
  </div>

  <!-- Manual Inputs -->
  <div class="card">
    <div class="card-title" data-i18n="waterSpiderEntry">Water Spider Entry</div>
    <div class="input-group">
      <label class="input-label" data-i18n="biomass">Biomass (trim)</label>
      <input type="number" class="weight-input" id="biomass-input" placeholder="0.0" min="0" step="0.1" inputmode="decimal">
      <div class="input-unit">lbs</div>
    </div>
    <div class="input-group">
      <label class="input-label" data-i18n="premiumTrim">Premium #1 Trim</label>
      <input type="number" class="weight-input" id="trim-input" placeholder="0.0" min="0" step="0.1" inputmode="decimal">
      <div class="input-unit">lbs</div>
    </div>
  </div>

  <!-- Submit -->
  <button class="submit-btn" id="submit-btn" data-i18n="submit">Submit & Update Pools</button>
  <div class="status-msg" id="status-msg"></div>

  <!-- Auto-Pulled Production -->
  <div class="card">
    <div class="card-title" data-i18n="productionData">Production Data (auto-pulled)</div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="tops">Tops</span>
      <span class="auto-value loading" id="tops-value">loading...</span>
    </div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="smalls">Smalls</span>
      <span class="auto-value loading" id="smalls-value">loading...</span>
    </div>
  </div>

  <!-- Breakdown -->
  <div class="card">
    <div class="card-title" data-i18n="materialBalance">Material Balance</div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="rawInput">Raw Input</span>
      <span class="auto-value" id="total-raw">0 lbs</span>
    </div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="tops">Tops</span>
      <span class="auto-value" style="color:var(--green)" id="bd-tops">0 lbs</span>
    </div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="smalls">Smalls</span>
      <span class="auto-value" style="color:var(--cyan)" id="bd-smalls">0 lbs</span>
    </div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="biomass">Biomass</span>
      <span class="auto-value" style="color:var(--gold)" id="bd-biomass">0 lbs</span>
    </div>
    <div class="auto-row">
      <span class="auto-label" data-i18n="premiumTrim">Premium #1 Trim</span>
      <span class="auto-value" style="color:var(--blue)" id="bd-trim">0 lbs</span>
    </div>
    <div class="auto-row" style="border-top:1px solid rgba(102,137,113,0.12);padding-top:10px;margin-top:4px">
      <span class="auto-label" style="font-weight:600" data-i18n="waste">Waste (sticks + mold)</span>
      <span class="auto-value" style="color:var(--red)" id="bd-waste">0 lbs</span>
    </div>

    <div class="breakdown-bar" id="breakdown-bar"></div>
    <div class="breakdown-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Tops</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div>Smalls</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div>Biomass</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>Trim</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>Waste</div>
    </div>
  </div>

  <!-- Per Strain Averages -->
  <div class="card" id="avg-card" style="display:none">
    <div class="card-title">Per Supersack Average</div>
    <div id="avg-body"></div>
  </div>

  <!-- Projected Remaining Yield -->
  <div class="card" id="yield-card" style="display:none">
    <div class="card-title">Remaining Raw Goods → Projected Yield</div>
    <div id="yield-body"></div>
  </div>

  <!-- Hidden config elements for biomass/trim (auto-set, no UI needed) -->
  <select id="cfg-biomass" style="display:none"></select>
  <select id="cfg-trim" style="display:none"></select>
</div>

<script>
(function() {
  'use strict';

  // i18n
  const LANG = { en: {
    title: 'Supersack Tracker', supersacksOpened: 'Supersacks Opened',
    waterSpiderEntry: 'Water Spider Entry', biomass: 'Biomass (trim)',
    premiumTrim: 'Premium #1 Trim', productionData: 'Production Data (auto-pulled)',
    tops: 'Tops', smalls: 'Smalls', materialBalance: 'Material Balance',
    rawInput: 'Raw Input', waste: 'Waste (sticks + mold)',
    submit: 'Submit & Update Pools', poolMapping: 'Pool Product Mapping',
    saving: 'Saving...', saved: '✓ Saved', poolsUpdated: 'Pools updated + data saved',
    enterCount: 'Enter supersack count first', loading: 'loading...',
    mappingSaved: 'Mapping saved', today: 'Today',
  }, es: {
    title: 'Rastreador de Supersacos', supersacksOpened: 'Supersacos Abiertos',
    waterSpiderEntry: 'Entrada del Water Spider', biomass: 'Biomasa (recorte)',
    premiumTrim: 'Recorte Premium #1', productionData: 'Datos de Producción (automático)',
    tops: 'Tops', smalls: 'Smalls', materialBalance: 'Balance de Materiales',
    rawInput: 'Entrada Bruta', waste: 'Desperdicio (palos + moho)',
    submit: 'Enviar y Actualizar Pools', poolMapping: 'Mapeo de Productos Pool',
    saving: 'Guardando...', saved: '✓ Guardado', poolsUpdated: 'Pools actualizados + datos guardados',
    enterCount: 'Ingrese la cantidad de supersacos primero', loading: 'cargando...',
    mappingSaved: 'Mapeo guardado', today: 'Hoy',
  }};
  let currentLang = localStorage.getItem('supersack-lang') || 'en';

  function applyLang() {
    const t = LANG[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (t[key]) el.textContent = t[key];
    });
    document.getElementById('lang-toggle').textContent = currentLang === 'en' ? 'ES' : 'EN';
    document.getElementById('today-btn').textContent = t.today;
  }

  document.getElementById('lang-toggle').addEventListener('click', () => {
    currentLang = currentLang === 'en' ? 'es' : 'en';
    localStorage.setItem('supersack-lang', currentLang);
    applyLang();
  });

  const POOL_API = 'https://rogue-origin-api.roguefamilyfarms.workers.dev/api/pool';
  const PROD_API = 'https://rogue-origin-api.roguefamilyfarms.workers.dev/api/production';
  const MC_API = 'https://mission-control-api.roguefamilyfarms.workers.dev/api';
  const LBS_TO_GRAMS = 453.592;
  const SACK_WEIGHT = 37;

  // State
  let strainData = {}; // { strainTitle: { sacks, tops, smalls, productId, inventoryItemId, locationId, poolValue } }
  let topsLbs = 0;
  let smallsLbs = 0;
  let poolProducts = [];
  let config = JSON.parse(localStorage.getItem('supersack-config') || '{}');

  // Elements
  const dateInput = document.getElementById('date-input');
  const headerDate = document.getElementById('header-date');
  const rawWeightEl = document.getElementById('raw-weight');
  const biomassInput = document.getElementById('biomass-input');
  const trimInput = document.getElementById('trim-input');
  const topsEl = document.getElementById('tops-value');
  const smallsEl = document.getElementById('smalls-value');
  const submitBtn = document.getElementById('submit-btn');
  const statusMsg = document.getElementById('status-msg');

  function todayStr() { return new Date().toLocaleDateString('en-CA'); }

  function initDate() {
    dateInput.value = todayStr();
    updateHeaderDate();
  }

  function updateHeaderDate() {
    const d = new Date(dateInput.value + 'T12:00:00');
    headerDate.textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  }

  dateInput.addEventListener('change', () => { updateHeaderDate(); loadAll(); });
  document.getElementById('today-btn').addEventListener('click', () => {
    dateInput.value = todayStr(); updateHeaderDate(); loadAll();
  });

  biomassInput.addEventListener('input', recalc);
  trimInput.addEventListener('input', recalc);

  // Total sack count across all strains
  function totalSacks() {
    return Object.values(strainData).reduce((sum, s) => sum + (s.sacks || 0), 0);
  }

  // Build per-strain counter rows
  function renderStrainCounters() {
    const container = document.getElementById('strain-counters');
    const strains = Object.keys(strainData);

    if (strains.length === 0) {
      container.innerHTML = '<div style="color:var(--text-faint);font-size:13px;text-align:center;padding:12px;font-family:var(--font-ui)">No strains today</div>';
      return;
    }

    container.innerHTML = strains.map(name => {
      const s = strainData[name];
      const shortName = name.replace(/^\d{4} - /, '').replace(/ \/ Sungrown$/, '');
      return `
        <div class="strain-row" data-strain="${name}">
          <div class="strain-name">
            ${shortName}
            <div class="strain-production">
              <span style="color:var(--text-faint)">${s.poolValue || 0} sacks remaining</span>
            </div>
          </div>
          <div class="strain-counter">
            <button class="mini-btn" onclick="window._strainDec('${name}')">−</button>
            <input type="number" value="${s.sacks}" min="0" inputmode="numeric"
              onchange="window._strainSet('${name}', this.value)"
              onclick="this.select()">
            <button class="mini-btn" onclick="window._strainInc('${name}')">+</button>
          </div>
        </div>`;
    }).join('');
  }

  // Strain counter controls (exposed to window for inline handlers)
  window._strainInc = (name) => { strainData[name].sacks++; renderStrainCounters(); recalc(); };
  window._strainDec = (name) => { if (strainData[name].sacks > 0) strainData[name].sacks--; renderStrainCounters(); recalc(); };
  window._strainSet = (name, val) => { strainData[name].sacks = Math.max(0, parseInt(val) || 0); renderStrainCounters(); recalc(); };

  // Recalculate totals + per-strain averages
  function recalc() {
    const sackCount = totalSacks();
    const raw = sackCount * SACK_WEIGHT;
    const biomass = parseFloat(biomassInput.value) || 0;
    const trim = parseFloat(trimInput.value) || 0;

    // Totals from all strains
    topsLbs = Object.values(strainData).reduce((sum, s) => sum + s.tops, 0);
    smallsLbs = Object.values(strainData).reduce((sum, s) => sum + s.smalls, 0);
    const waste = Math.max(0, raw - topsLbs - smallsLbs - biomass - trim);

    rawWeightEl.textContent = raw.toFixed(1) + ' lbs raw total';
    topsEl.textContent = topsLbs.toFixed(1) + ' lbs';
    topsEl.classList.remove('loading');
    smallsEl.textContent = smallsLbs.toFixed(1) + ' lbs';
    smallsEl.classList.remove('loading');

    document.getElementById('total-raw').textContent = raw.toFixed(1) + ' lbs';
    document.getElementById('bd-tops').textContent = topsLbs.toFixed(1) + ' lbs';
    document.getElementById('bd-smalls').textContent = smallsLbs.toFixed(1) + ' lbs';
    document.getElementById('bd-biomass').textContent = biomass.toFixed(1) + ' lbs';
    document.getElementById('bd-trim').textContent = trim.toFixed(1) + ' lbs';
    document.getElementById('bd-waste').textContent = waste.toFixed(1) + ' lbs';

    // Breakdown bar
    const bar = document.getElementById('breakdown-bar');
    if (raw === 0) { bar.innerHTML = ''; } else {
      const segments = [
        { val: topsLbs, color: 'var(--green)' }, { val: smallsLbs, color: 'var(--cyan)' },
        { val: biomass, color: 'var(--gold)' }, { val: trim, color: 'var(--blue)' },
        { val: waste, color: 'var(--red)' },
      ];
      bar.innerHTML = segments.map(s => {
        const pct = (s.val / raw) * 100;
        return pct < 1 ? '' : `<div class="breakdown-segment" style="width:${pct}%;background:${s.color}">${pct >= 8 ? Math.round(pct) + '%' : ''}</div>`;
      }).join('');
    }

    // Per-strain averages
    const avgCard = document.getElementById('avg-card');
    const avgBody = document.getElementById('avg-body');
    const strainsWithSacks = Object.entries(strainData).filter(([, s]) => s.sacks > 0);

    if (strainsWithSacks.length > 0) {
      avgCard.style.display = '';
      avgBody.innerHTML = strainsWithSacks.map(([name, s]) => {
        const shortName = name.replace(/^\d{4} - /, '').replace(/ \/ Sungrown$/, '');
        const n = s.sacks;
        const strainWaste = Math.max(0, (n * SACK_WEIGHT) - s.tops - s.smalls);
        // Proportional biomass/trim based on sack ratio
        const ratio = n / sackCount;
        const strainBio = biomass * ratio;
        const strainTrim = trim * ratio;
        return `
          <div class="avg-strain-section">
            <div class="avg-strain-title">${shortName} (${n} sacks)</div>
            <div class="auto-row"><span class="auto-label">Tops</span><span class="auto-value" style="color:var(--green)">${(s.tops / n).toFixed(2)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Smalls</span><span class="auto-value" style="color:var(--cyan)">${(s.smalls / n).toFixed(2)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Biomass</span><span class="auto-value" style="color:var(--gold)">${(strainBio / n).toFixed(2)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Trim</span><span class="auto-value" style="color:var(--blue)">${(strainTrim / n).toFixed(2)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Waste</span><span class="auto-value" style="color:var(--red)">${(strainWaste / n).toFixed(2)} lbs</span></div>
          </div>`;
      }).join('');
    } else {
      avgCard.style.display = 'none';
    }

    // Projected remaining yield
    const yieldCard = document.getElementById('yield-card');
    const yieldBody = document.getElementById('yield-body');
    if (strainsWithSacks.length > 0) {
      yieldCard.style.display = '';
      let totalRemTops = 0, totalRemSmalls = 0, totalRemBio = 0, totalRemTrim = 0, totalRemWaste = 0, totalRemSacks = 0;

      const sections = strainsWithSacks.map(([name, s]) => {
        const shortName = name.replace(/^\d{4} - /, '').replace(/ \/ Sungrown$/, '');
        const n = s.sacks;
        const remaining = (s.poolValue || 0) - n; // sacks left after today
        if (remaining <= 0) return '';

        const avgTops = s.tops / n;
        const avgSmalls = s.smalls / n;
        const ratio = n / sackCount;
        const avgBio = (biomass * ratio) / n;
        const avgTrim = (trim * ratio) / n;
        const avgWaste = Math.max(0, SACK_WEIGHT - avgTops - avgSmalls - avgBio - avgTrim);

        const remTops = remaining * avgTops;
        const remSmalls = remaining * avgSmalls;
        const remBio = remaining * avgBio;
        const remTrim = remaining * avgTrim;
        const remWaste = remaining * avgWaste;
        totalRemTops += remTops; totalRemSmalls += remSmalls;
        totalRemBio += remBio; totalRemTrim += remTrim;
        totalRemWaste += remWaste; totalRemSacks += remaining;

        return `
          <div class="avg-strain-section">
            <div class="avg-strain-title">${shortName} — ${remaining.toLocaleString()} sacks remaining</div>
            <div class="auto-row"><span class="auto-label">Tops</span><span class="auto-value" style="color:var(--green)">${remTops.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Smalls</span><span class="auto-value" style="color:var(--cyan)">${remSmalls.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Biomass</span><span class="auto-value" style="color:var(--gold)">${remBio.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Trim</span><span class="auto-value" style="color:var(--blue)">${remTrim.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Waste</span><span class="auto-value" style="color:var(--red)">${remWaste.toFixed(0)} lbs</span></div>
          </div>`;
      }).filter(Boolean);

      // Grand total if multiple strains
      if (totalRemSacks > 0) {
        const totalHtml = (sections.length > 1 ? `
          <div class="avg-strain-section" style="border-top:1px solid rgba(102,137,113,0.15);padding-top:12px;margin-top:4px">
            <div class="avg-strain-title" style="color:var(--text)">ALL STRAINS — ${totalRemSacks.toLocaleString()} sacks</div>
            <div class="auto-row"><span class="auto-label">Tops</span><span class="auto-value" style="color:var(--green)">${totalRemTops.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Smalls</span><span class="auto-value" style="color:var(--cyan)">${totalRemSmalls.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Biomass</span><span class="auto-value" style="color:var(--gold)">${totalRemBio.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Trim</span><span class="auto-value" style="color:var(--blue)">${totalRemTrim.toFixed(0)} lbs</span></div>
            <div class="auto-row"><span class="auto-label">Waste</span><span class="auto-value" style="color:var(--red)">${totalRemWaste.toFixed(0)} lbs</span></div>
          </div>` : '');
        yieldBody.innerHTML = sections.join('') + totalHtml;
      }
    } else {
      yieldCard.style.display = 'none';
    }
  }

  // Fetch scoreboard (per-strain production) + supersack variants + pool products in parallel
  async function loadAll() {
    const date = dateInput.value;
    topsEl.textContent = 'loading...'; topsEl.classList.add('loading');
    smallsEl.textContent = 'loading...'; smallsEl.classList.add('loading');

    const [scoreboardRes, supersackRes, smallsPoolRes, topsPoolRes] = await Promise.allSettled([
      fetch(`${PROD_API}?action=scoreboard`).then(r => r.json()),
      fetch(`${POOL_API}?action=get_supersack_variants`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}',
      }).then(r => r.json()),
      fetch(`${POOL_API}?action=list_products`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{"poolType":"smalls"}',
      }).then(r => r.json()),
      fetch(`${POOL_API}?action=list_products`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{"poolType":"tops"}',
      }).then(r => r.json()),
    ]);

    // Build per-strain production from scoreboard hourly rates
    const perStrainProd = {}; // { strainTitle: { tops, smalls } }
    if (scoreboardRes.status === 'fulfilled') {
      const sb = scoreboardRes.value.scoreboard || {};
      (sb.hourlyRates || []).forEach(h => {
        const strain = h.strain || sb.strain;
        if (!strain) return;
        if (!perStrainProd[strain]) perStrainProd[strain] = { tops: 0, smalls: 0 };
        perStrainProd[strain].tops += (h.lbs || 0);
        perStrainProd[strain].smalls += (h.smalls || 0);
      });
      // If no per-hour strains, use current strain with dashboard totals
      if (Object.keys(perStrainProd).length === 0 && sb.strain) {
        perStrainProd[sb.strain] = { tops: sb.todayLbs || 0, smalls: 0 };
      }
    }

    // Supersack variants (Shopify inventory)
    const supersackMap = {}; // { title: variant }
    poolProducts = [];
    if (supersackRes.status === 'fulfilled') {
      (supersackRes.value.variants || []).forEach(v => {
        supersackMap[v.title] = v;
        poolProducts.push({
          id: v.id, title: v.title, poolValue: (v.quantity || 0),
          _unit: 'sacks', _inventoryItemId: v.inventoryItemId,
          _locationId: v.locationId, _poolType: 'supersack',
        });
      });
    }

    // Pool products (biomass/trim)
    for (const res of [smallsPoolRes, topsPoolRes]) {
      if (res.status === 'fulfilled') {
        const poolType = res === smallsPoolRes ? 'smalls' : 'tops';
        (res.value.products || []).forEach(p => {
          if (!poolProducts.find(x => x.id === p.id)) {
            p._poolType = poolType; p._unit = 'g';
            poolProducts.push(p);
          }
        });
      }
    }

    // Build strainData — merge production with supersack variants
    const oldSacks = {}; // Preserve user-entered sack counts
    Object.entries(strainData).forEach(([name, s]) => { if (s.sacks > 0) oldSacks[name] = s.sacks; });

    strainData = {};
    for (const [strain, prod] of Object.entries(perStrainProd)) {
      const variant = supersackMap[strain];
      strainData[strain] = {
        sacks: oldSacks[strain] || 0,
        tops: prod.tops,
        smalls: prod.smalls,
        productId: variant?.id || null,
        inventoryItemId: variant?.inventoryItemId || null,
        locationId: variant?.locationId || null,
        poolValue: variant?.quantity || 0,
      };
    }

    // Auto-set biomass/trim
    config.biomass = poolProducts.find(p => /CBD Biomass.*Trim/i.test(p.title))?.id || null;
    config.trim = poolProducts.find(p => /Premium CBD Flower Trim/i.test(p.title))?.id || null;

    renderStrainCounters();
    recalc();
  }

  async function updatePool(productId, operation, amount, note, isSupersack) {
    if (!productId) return { success: false, error: 'No product mapped' };
    try {
      const product = poolProducts.find(p => p.id === productId);
      let resp;
      if (isSupersack || product?._poolType === 'supersack') {
        resp = await fetch(`${POOL_API}?action=update_supersack_inventory`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            variantId: productId,
            inventoryItemId: product?._inventoryItemId,
            locationId: product?._locationId,
            operation, quantity: amount, note,
          }),
        });
      } else {
        resp = await fetch(`${POOL_API}?action=update_pool`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId, operation,
            amount: Math.round(amount * LBS_TO_GRAMS * 10) / 10,
            note, poolType: product?._poolType || 'smalls',
          }),
        });
      }
      return await resp.json();
    } catch (e) {
      return { success: false, error: e.message };
    }
  }

  // Submit — per-strain supersack updates
  submitBtn.addEventListener('click', async () => {
    const sackCount = totalSacks();
    if (sackCount === 0) { setStatus('Enter supersack count first', 'error'); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    submitBtn.classList.add('saving');

    const biomass = parseFloat(biomassInput.value) || 0;
    const trim = parseFloat(trimInput.value) || 0;
    const date = dateInput.value;
    let poolErrors = [];

    // 1. Subtract supersacks per strain
    for (const [name, s] of Object.entries(strainData)) {
      if (s.sacks > 0 && s.productId) {
        const r = await updatePool(s.productId, 'subtract', s.sacks, `${s.sacks} supersacks ${name} (${date})`, true);
        if (!r.success) poolErrors.push(`${name}: ${r.error || 'failed'}`);
      }
    }

    // 2. Add biomass to pool
    if (config.biomass && biomass > 0) {
      const r = await updatePool(config.biomass, 'add', biomass, `Biomass entry (${date})`);
      if (!r.success) poolErrors.push('Biomass: ' + (r.error || 'failed'));
    }

    // 3. Add trim to pool
    if (config.trim && trim > 0) {
      const r = await updatePool(config.trim, 'add', trim, `Trim entry (${date})`);
      if (!r.success) poolErrors.push('Trim: ' + (r.error || 'failed'));
    }

    // 4. Save summary to D1
    try {
      await fetch(`${MC_API}/supersack/submit`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date, supersack_count: sackCount, biomass_lbs: biomass,
          trim_lbs: trim, tops_lbs: topsLbs, smalls_lbs: smallsLbs,
          waste_lbs: Math.max(0, (sackCount * SACK_WEIGHT) - topsLbs - smallsLbs - biomass - trim),
          strains: Object.fromEntries(Object.entries(strainData).map(([k, v]) => [k, v.sacks])),
        }),
      });
    } catch {}

    submitBtn.disabled = false;
    submitBtn.classList.remove('saving');

    if (poolErrors.length > 0) {
      submitBtn.classList.add('error');
      setStatus('Pool errors: ' + poolErrors.join('; '), 'error');
      setTimeout(() => submitBtn.classList.remove('error'), 2000);
    } else {
      submitBtn.textContent = '✓ Saved';
      setStatus('Pools updated + data saved', 'success');
      setTimeout(() => { submitBtn.textContent = 'Submit & Update Pools'; }, 2000);
    }
  });

  function setStatus(msg, type) {
    statusMsg.textContent = msg;
    statusMsg.className = 'status-msg ' + (type || '');
    if (type === 'success') setTimeout(() => { statusMsg.textContent = ''; }, 4000);
  }

  // Init
  initDate();
  applyLang();
  loadAll();
})();
</script>
</body>
</html>
