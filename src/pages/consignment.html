<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="icon" type="image/png" href="/rogue-origin-apps/favicon.png">
  <meta name="theme-color" content="#141816">
  <title>Consignment - Rogue Origin</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=optional" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/duotone/style.css">

  <link rel="stylesheet" href="../css/shared-base.css">
  <link rel="stylesheet" href="../css/consignment.css?v=17">
</head>
<body class="auth-required">
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Authentication Overlay -->
  <div id="auth-overlay">
    <div class="login-container">
      <i class="ph-duotone ph-lock login-lock-icon"></i>
      <span class="login-eyebrow">Consignment</span>
      <h2>Welcome Back</h2>
      <p>Enter your password to continue</p>
      <form id="login-form">
        <input
          type="password"
          id="password-input"
          class="login-input"
          placeholder="Enter password"
          autocomplete="current-password"
          required
        >
        <button type="submit" class="login-btn" id="login-btn">
          Unlock
        </button>
        <div class="login-error" id="login-error"></div>
      </form>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <div class="sidebar-toggle" onclick="toggleSidebar()" role="button" tabindex="0" aria-label="Collapse sidebar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/></svg>
      <span class="sidebar-toggle-label">Collapse</span>
    </div>
    <div class="brand">
      <img src="/rogue-origin-apps/favicon.png" alt="Rogue Origin" width="32" height="32">
      <h1>Rogue Origin</h1>
    </div>
    <nav>
      <div class="nav-item" onclick="window.location.href='index.html'" role="button" tabindex="0" aria-label="Navigate to Dashboard"><span class="icon"><i class="ph-duotone ph-chart-pie-slice"></i></span><span>Dashboard</span></div>
      <div class="nav-item" onclick="window.location.href='kanban.html'" role="button" tabindex="0" aria-label="Navigate to Supply Kanban"><span class="icon"><i class="ph-duotone ph-package"></i></span><span>Supply Kanban</span></div>
      <div class="nav-item" onclick="window.location.href='scoreboard.html'" role="button" tabindex="0" aria-label="Navigate to Scoreboard"><span class="icon"><i class="ph-duotone ph-gauge"></i></span><span>Scoreboard</span></div>
      <div class="nav-item" onclick="window.location.href='barcode.html'" role="button" tabindex="0" aria-label="Navigate to Barcode Printer"><span class="icon"><i class="ph-duotone ph-barcode"></i></span><span>Barcode Printer</span></div>
      <div class="nav-item" onclick="window.location.href='sop-manager.html'" role="button" tabindex="0" aria-label="Navigate to SOP Manager"><span class="icon"><i class="ph-duotone ph-book-open-text"></i></span><span>SOP Manager</span></div>
      <div class="nav-item" onclick="window.location.href='orders.html'" role="button" tabindex="0" aria-label="Navigate to Orders"><span class="icon"><i class="ph-duotone ph-clipboard-text"></i></span><span>Orders</span></div>
      <div class="nav-item active" aria-current="page"><span class="icon"><i class="ph-duotone ph-handshake"></i></span><span>Consignment</span></div>
      <div class="nav-item" onclick="window.location.href='hourly-entry.html'" role="button" tabindex="0" aria-label="Navigate to Floor Manager"><span class="icon"><i class="ph-duotone ph-user-gear"></i></span><span>Floor Manager</span></div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">RO</div>
        <div>
          <div class="user-name">Rogue Origin</div>
          <div class="user-role">Administrator</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main" id="main-content">
    <!-- Premium Header -->
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Open menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="header-brand">
          <img src="/rogue-origin-apps/favicon.png" alt="Rogue Origin" class="header-logo" width="36" height="36">
          <span class="header-brand-text">Consignment</span>
        </div>
      </div>
      <div class="header-right">
        <div class="header-time" style="display: none;">
          <div class="time" id="clock">--:--</div>
          <div class="date" id="dateDisplay">Loading...</div>
        </div>
        <button class="theme-toggle" id="btn-dark-mode" title="Toggle theme" aria-label="Toggle dark mode theme">
          <span id="themeIcon">ðŸŒ™</span>
          <span id="themeLabel">Dark</span>
        </button>
        <button id="btn-refresh" class="header-btn primary">
          <i class="ph-duotone ph-arrows-clockwise"></i> Refresh
        </button>
      </div>
    </header>

    <!-- Quick Actions (Hero Position) -->
    <section class="quick-actions-section card-section">
      <h3 class="section-title">Quick Actions</h3>
      <div class="quick-actions">
        <button id="btn-new-intake" class="quick-action-card intake">
          <div class="quick-action-icon">
            <i class="ph-duotone ph-download-simple"></i>
          </div>
          <div class="quick-action-label">New Intake</div>
          <div class="quick-action-hint">Record received product</div>
        </button>
        <button id="btn-inventory-count" class="quick-action-card sale">
          <div class="quick-action-icon">
            <i class="ph-duotone ph-clipboard-text"></i>
          </div>
          <div class="quick-action-label">Inventory Count</div>
          <div class="quick-action-hint">Update what's on the shelf</div>
        </button>
        <button id="btn-record-payment" class="quick-action-card payment">
          <div class="quick-action-icon">
            <i class="ph-duotone ph-money"></i>
          </div>
          <div class="quick-action-label">Record Payment</div>
          <div class="quick-action-hint">Pay partner balance</div>
        </button>
      </div>
    </section>

    <!-- Consignment Partners -->
    <section class="partners-section card-section">
      <div class="section-header">
        <h3 class="section-title">Consignment Partners</h3>
        <button id="btn-add-partner" class="add-partner-btn"><i class="ph-duotone ph-plus"></i> Add Partner</button>
      </div>
      <div id="partner-cards" class="partner-cards">
        <div class="empty-state">
          <i class="ph-duotone ph-handshake empty-state-icon"></i>
          <p class="empty-state-text">Loading partners...</p>
        </div>
      </div>
    </section>

    <!-- Partner Detail Panel -->
    <div id="partner-detail" class="partner-detail"></div>

    <!-- Activity Feed -->
    <section class="activity-section card-section">
      <div class="section-header">
        <h3 class="section-title">Recent Activity</h3>
        <div class="filter-bar">
          <select id="activity-filter" class="partner-select" aria-label="Filter by partner">
            <option value="">All Partners</option>
          </select>
        </div>
      </div>
      <div id="activity-feed" class="activity-feed">
        <div class="empty-state">
          <i class="ph-duotone ph-activity empty-state-icon"></i>
          <p class="empty-state-text">No activity yet</p>
          <p class="empty-state-hint">Activity will appear here as you record intakes, sales, and payments</p>
        </div>
      </div>
    </section>
  </main>

  <!-- â•â•â• MODALS â•â•â• -->

  <!-- Intake Modal -->
  <div id="intake-modal" class="modal-overlay" role="dialog" aria-label="New Intake">
    <div class="modal modal-wide">
      <h2><i class="ph-duotone ph-download-simple"></i> New Intake</h2>
      <button class="modal-close" aria-label="Close">&times;</button>
      <form id="intake-form">
        <div class="form-row">
          <div class="form-group flex-1">
            <label for="intake-partner">Partner</label>
            <select id="intake-partner" class="partner-select" required></select>
          </div>
          <div class="form-group">
            <label for="intake-date">Date</label>
            <input type="date" id="intake-date" required>
          </div>
        </div>
        
        <div class="line-items-header">
          <span class="li-col-strain">Strain</span>
          <span class="li-col-type">Type</span>
          <span class="li-col-weight">Weight (lbs)</span>
          <span class="li-col-price">Price/lb ($)</span>
          <span class="li-col-remove"></span>
        </div>
        
        <div id="intake-lines" class="line-items">
          <!-- Line items inserted here by JS -->
        </div>
        
        <button type="button" id="btn-add-line" class="add-line-btn">
          <i class="ph-duotone ph-plus-circle"></i> Add Line
        </button>
        
        <div class="form-group">
          <label for="intake-notes">Notes (optional)</label>
          <textarea id="intake-notes" rows="2"></textarea>
        </div>
        <button type="submit" class="submit-btn intake">Record Intake</button>
      </form>
    </div>
  </div>

  <!-- Inventory Count Modal -->
  <div id="count-modal" class="modal-overlay" role="dialog" aria-label="Inventory Count">
    <div class="modal">
      <h2><i class="ph-duotone ph-clipboard-text"></i> Inventory Count</h2>
      <button class="modal-close" aria-label="Close">&times;</button>
      <form id="count-form">
        <div class="form-group">
          <label for="count-partner">Partner</label>
          <select id="count-partner" class="partner-select" required></select>
        </div>
        <div class="form-group">
          <label for="count-strain">Strain</label>
          <select id="count-strain" class="strain-select" required></select>
        </div>
        <div class="form-group">
          <label>Type</label>
          <div class="toggle-group">
            <button type="button" class="toggle-option active" data-value="tops">Tops</button>
            <button type="button" class="toggle-option" data-value="smalls">Smalls</button>
          </div>
        </div>
        <div id="count-expected-display" class="count-expected" style="display:none;">
          <div class="count-expected-label">Expected on hand</div>
          <div class="count-expected-value" id="count-expected-value">â€”</div>
        </div>
        <div class="form-group">
          <label for="count-weight">Actual weight on shelf (lbs)</label>
          <input type="number" id="count-weight" step="0.1" min="0" required>
          <span id="count-diff" class="field-hint"></span>
        </div>
        <div class="form-group">
          <label for="count-date">Date</label>
          <input type="date" id="count-date" required>
        </div>
        <div class="form-group">
          <label for="count-notes">Notes (optional)</label>
          <textarea id="count-notes" rows="2"></textarea>
        </div>
        <button type="submit" class="submit-btn sale">Submit Count</button>
      </form>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="payment-modal" class="modal-overlay" role="dialog" aria-label="Record Payment">
    <div class="modal">
      <h2><i class="ph-duotone ph-money"></i> Record Payment</h2>
      <button class="modal-close" aria-label="Close">&times;</button>
      <form id="payment-form">
        <div class="form-group">
          <label for="payment-partner">Partner</label>
          <select id="payment-partner" class="partner-select" required></select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="payment-amount">Amount ($)</label>
            <input type="number" id="payment-amount" step="0.01" min="0.01" required>
          </div>
          <div class="form-group">
            <label for="payment-method">Method</label>
            <select id="payment-method">
              <option value="check">Check</option>
              <option value="cash">Cash</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="payment-ref">Reference # (optional)</label>
          <input type="text" id="payment-ref" placeholder="Check number, etc.">
        </div>
        <div class="form-group">
          <label for="payment-date">Date</label>
          <input type="date" id="payment-date" required>
        </div>
        <div class="form-group">
          <label for="payment-notes">Notes (optional)</label>
          <textarea id="payment-notes" rows="2"></textarea>
        </div>
        <button type="submit" class="submit-btn payment">Record Payment</button>
      </form>
    </div>
  </div>

  <!-- Partner Modal -->
  <div id="partner-modal" class="modal-overlay" role="dialog" aria-label="Add Partner">
    <div class="modal">
      <h2><i class="ph-duotone ph-user-plus"></i> Add Partner</h2>
      <button class="modal-close" aria-label="Close">&times;</button>
      <form id="partner-form">
        <div class="form-group">
          <label for="partner-name">Farm Name</label>
          <input type="text" id="partner-name" required placeholder="e.g. Mountain Creek Farm">
        </div>
        <div class="form-group">
          <label for="partner-contact">Contact Name (optional)</label>
          <input type="text" id="partner-contact">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="partner-email">Email (optional)</label>
            <input type="email" id="partner-email">
          </div>
          <div class="form-group">
            <label for="partner-phone">Phone (optional)</label>
            <input type="tel" id="partner-phone">
          </div>
        </div>
        <div class="form-group">
          <label for="partner-notes">Notes (optional)</label>
          <textarea id="partner-notes" rows="2"></textarea>
        </div>
        <button type="submit" class="submit-btn intake">Add Partner</button>
      </form>
    </div>
  </div>

  <!-- Auth Script -->
  <script>
    const AUTH_API_URL = 'https://rogue-origin-api.roguefamilyfarms.workers.dev/api/orders';
    const AUTH_KEY = 'ro_consignment_auth';

    (function checkAuth() {
      const session = localStorage.getItem(AUTH_KEY);
      if (session) {
        try {
          const { timestamp, expiresIn } = JSON.parse(session);
          if (Date.now() - timestamp < expiresIn) {
            unlockPage();
            return;
          }
        } catch (e) {}
      }
      document.getElementById('password-input').focus();
    })();

    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const passwordInput = document.getElementById('password-input');
      const enteredPassword = passwordInput.value;
      const errorEl = document.getElementById('login-error');
      const loginBtn = document.getElementById('login-btn');

      errorEl.classList.remove('visible');
      if (!enteredPassword) {
        errorEl.textContent = 'Please enter a password';
        errorEl.classList.add('visible');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Validating...';

      try {
        const url = AUTH_API_URL + '?action=validatePassword&password=' + encodeURIComponent(enteredPassword);
        const response = await fetch(url);
        const raw = await response.json();
        const result = raw.data || raw;

        if (response.ok && result.success) {
          localStorage.setItem(AUTH_KEY, JSON.stringify({
            sessionToken: result.sessionToken,
            timestamp: Date.now(),
            expiresIn: result.expiresIn
          }));
          localStorage.setItem('ro_api_password', enteredPassword);
          unlockPage();
          passwordInput.value = '';
        } else {
          errorEl.textContent = result.error || result.message || 'Invalid password';
          errorEl.classList.add('visible');
          passwordInput.value = '';
          passwordInput.focus();
        }
      } catch (error) {
        errorEl.textContent = 'Connection error. Please try again.';
        errorEl.classList.add('visible');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Unlock';
      }
    });

    function unlockPage() {
      document.body.classList.remove('auth-required');
      document.getElementById('auth-overlay').classList.add('hidden');
    }
  </script>

  <!-- Sidebar Script -->
  <script>
    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      sb.classList.toggle('collapsed');
      document.querySelector('.main').classList.toggle('sidebar-collapsed');
    }
  </script>

  <!-- App (handles theme toggle, clock, all functionality) -->
  <script type="module" src="../js/consignment/main.js?v=10"></script>
</body>
</html>
