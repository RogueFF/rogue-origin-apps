<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="icon" type="image/png" href="/rogue-origin-apps/favicon.png">
  <meta name="theme-color" content="#668971">
  <title>Complaints - Rogue Origin</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=optional" rel="stylesheet">
  <!-- Phosphor Icons -->
  <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/duotone/style.css">
  <!-- Styles -->
  <link rel="stylesheet" href="../css/shared-base.css">
  <link rel="stylesheet" href="../css/complaints.css?v=1">
</head>
<body class="auth-required">
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Auth Overlay -->
  <div id="auth-overlay" class="auth-overlay">
    <div class="auth-box">
      <img src="/rogue-origin-apps/favicon.png" alt="Rogue Origin" class="auth-logo">
      <h1 class="auth-title" data-i18n="auth_title">Complaints Access</h1>
      <form id="auth-form" class="auth-form">
        <input
          type="password"
          id="password-input"
          class="auth-input"
          placeholder="Password"
          required
          autocomplete="current-password"
        >
        <button type="submit" class="auth-button" data-i18n="auth_unlock">Unlock</button>
        <div id="auth-error" class="auth-error"></div>
      </form>
    </div>
  </div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar" role="navigation" aria-label="Main navigation">
      <div class="sidebar-header">
        <img src="/rogue-origin-apps/favicon.png" alt="Rogue Origin" class="sidebar-logo">
        <span class="sidebar-brand">Rogue Origin</span>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item">
          <i class="ph-duotone ph-chart-pie-slice"></i>
          <span data-i18n="nav_dashboard">Dashboard</span>
        </a>
        <a href="kanban.html" class="nav-item">
          <i class="ph-duotone ph-package"></i>
          <span data-i18n="nav_kanban">Supply Kanban</span>
        </a>
        <a href="scoreboard.html" class="nav-item">
          <i class="ph-duotone ph-gauge"></i>
          <span data-i18n="nav_scoreboard">Scoreboard</span>
        </a>
        <a href="barcode.html" class="nav-item">
          <i class="ph-duotone ph-barcode"></i>
          <span data-i18n="nav_barcode">Barcode</span>
        </a>
        <a href="sop-manager.html" class="nav-item">
          <i class="ph-duotone ph-book-open-text"></i>
          <span data-i18n="nav_sop">SOP Manager</span>
        </a>
        <a href="orders.html" class="nav-item">
          <i class="ph-duotone ph-clipboard-text"></i>
          <span data-i18n="nav_orders">Orders</span>
        </a>
        <a href="consignment.html" class="nav-item">
          <i class="ph-duotone ph-handshake"></i>
          <span data-i18n="nav_consignment">Consignment</span>
        </a>
        <a href="complaints.html" class="nav-item active" aria-current="page">
          <i class="ph-duotone ph-warning-diamond"></i>
          <span data-i18n="nav_complaints">Complaints</span>
        </a>
        <a href="hourly-entry.html" class="nav-item">
          <i class="ph-duotone ph-user-gear"></i>
          <span data-i18n="nav_floor">Floor Manager</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="sidebar-avatar" style="width:36px;height:36px;background:var(--ro-green);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px;flex-shrink:0">RO</div>
        <div class="sidebar-user">
          <div class="sidebar-user-name">Rogue Origin</div>
          <div class="sidebar-user-role">Operations Hub</div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main" id="main-content">
      <!-- Header -->
      <header class="header">
        <button id="menu-btn" class="menu-btn" aria-label="Toggle menu">
          <i class="ph-duotone ph-list"></i>
        </button>
        <div class="header-brand">
          <img src="/rogue-origin-apps/favicon.png" alt="Rogue Origin" class="header-logo">
          <h1 class="header-title" data-i18n="page_title">Complaints</h1>
        </div>
        <div class="header-actions">
          <button id="lang-toggle" class="icon-btn" aria-label="Toggle language" title="EN / ES">
            <i class="ph-duotone ph-translate"></i>
          </button>
          <button id="dark-mode-toggle" class="icon-btn" aria-label="Toggle dark mode">
            <i class="ph-duotone ph-moon"></i>
          </button>
          <button id="refresh-btn" class="icon-btn primary" aria-label="Refresh">
            <i class="ph-duotone ph-arrows-clockwise"></i>
          </button>
        </div>
      </header>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab" data-tab="new">
          <i class="ph-duotone ph-plus"></i>
          <span data-i18n="tab_new">New</span>
        </button>
        <button class="tab active" data-tab="history">
          <i class="ph-duotone ph-clock-counter-clockwise"></i>
          <span data-i18n="tab_history">History</span>
        </button>
      </div>

      <!-- New Complaint Tab -->
      <div id="tab-new" class="tab-content">
        <form id="complaint-form" class="complaint-form">
          <div class="form-row">
            <div class="form-group">
              <label for="complaint-date" class="form-label" data-i18n="form_date">Date</label>
              <input type="date" id="complaint-date" class="form-input" required>
            </div>
            <div class="form-group">
              <label for="complaint-customer" class="form-label" data-i18n="form_customer">Customer</label>
              <input type="text" id="complaint-customer" class="form-input" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="complaint-invoice" class="form-label" data-i18n="form_invoice">Invoice #</label>
              <input type="text" id="complaint-invoice" class="form-input">
            </div>
            <div class="form-group">
              <label for="complaint-status" class="form-label" data-i18n="form_status">Status</label>
              <select id="complaint-status" class="form-select" required>
                <option value="Open" data-i18n="status_open">Open</option>
                <option value="In Progress" data-i18n="status_progress">In Progress</option>
                <option value="Resolved" data-i18n="status_resolved">Resolved</option>
              </select>
            </div>
          </div>
          <div class="form-row full">
            <div class="form-group">
              <label for="complaint-text" class="form-label" data-i18n="form_complaint">Complaint</label>
              <textarea id="complaint-text" class="form-textarea" rows="3" required></textarea>
            </div>
          </div>
          <div class="form-row full">
            <div class="form-group">
              <label for="complaint-resolution" class="form-label" data-i18n="form_resolution">Resolution</label>
              <textarea id="complaint-resolution" class="form-textarea" rows="2"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="complaint-reporter" class="form-label" data-i18n="form_reporter">Reported By</label>
              <input type="text" id="complaint-reporter" class="form-input">
            </div>
            <div class="form-group">
              <label for="complaint-notes" class="form-label" data-i18n="form_notes">Notes</label>
              <input type="text" id="complaint-notes" class="form-input">
            </div>
          </div>
          <button type="submit" class="form-submit">
            <i class="ph-duotone ph-floppy-disk"></i>
            <span data-i18n="btn_save">Save Complaint</span>
          </button>
        </form>
      </div>

      <!-- History Tab -->
      <div id="tab-history" class="tab-content active">
        <!-- Stats -->
        <div class="stats">
          <div class="stat-card">
            <div class="stat-label" data-i18n="stat_total">Total</div>
            <div class="stat-value" id="stat-total">0</div>
          </div>
          <div class="stat-card status-open">
            <div class="stat-label" data-i18n="stat_open">Open</div>
            <div class="stat-value" id="stat-open">0</div>
          </div>
          <div class="stat-card status-resolved">
            <div class="stat-label" data-i18n="stat_resolved">Resolved</div>
            <div class="stat-value" id="stat-resolved">0</div>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <div class="search-box">
            <i class="ph-duotone ph-magnifying-glass search-icon"></i>
            <input
              type="text"
              id="search-input"
              class="search-input"
              placeholder="Search..."
              aria-label="Search complaints"
            >
          </div>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="" data-i18n="filter_all">All</button>
            <button class="filter-btn" data-filter="Open" data-i18n="filter_open">Open</button>
            <button class="filter-btn" data-filter="In Progress" data-i18n="filter_progress">In Progress</button>
            <button class="filter-btn" data-filter="Resolved" data-i18n="filter_resolved">Resolved</button>
          </div>
        </div>

        <!-- Complaints List -->
        <div id="complaints-list" class="complaints-list">
          <div class="loading">
            <i class="ph-duotone ph-spinner"></i>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal" class="modal-overlay" role="dialog" aria-label="Complaint details">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()" aria-label="Close">
        <i class="ph-duotone ph-x"></i>
      </button>
      <div class="modal-header">
        <h2 class="modal-title" id="modal-customer">Customer Name</h2>
        <div class="modal-subtitle" id="modal-date">Date</div>
      </div>
      <div class="detail-grid" id="detail-content">
        <!-- Populated dynamically -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="editComplaint()" id="edit-btn">
          <i class="ph-duotone ph-pencil"></i>
          <span data-i18n="btn_edit">Edit</span>
        </button>
        <button class="btn btn-danger" onclick="confirmDelete()" id="delete-btn">
          <i class="ph-duotone ph-trash"></i>
          <span data-i18n="btn_delete">Delete</span>
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          <i class="ph-duotone ph-x"></i>
          <span data-i18n="btn_close">Close</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <i class="ph-duotone ph-check-circle"></i>
    <span class="toast-message" id="toast-message">Success</span>
  </div>

  <script>
    // Constants & State
    const API = 'https://rogue-origin-api.roguefamilyfarms.workers.dev/api/complaints';
    let complaints = [];
    let currentFilter = '';
    let currentSearch = '';
    let lang = localStorage.getItem('ro-lang') || 'en';
    let currentComplaint = null;

    // Translations
    const labels = {
      en: {
        auth_title: 'Complaints Access',
        auth_unlock: 'Unlock',
        page_title: 'Complaints',
        nav_dashboard: 'Dashboard',
        nav_kanban: 'Supply Kanban',
        nav_scoreboard: 'Scoreboard',
        nav_barcode: 'Barcode',
        nav_sop: 'SOP Manager',
        nav_orders: 'Orders',
        nav_consignment: 'Consignment',
        nav_complaints: 'Complaints',
        nav_floor: 'Floor Manager',
        tab_new: 'New',
        tab_history: 'History',
        form_date: 'Date',
        form_customer: 'Customer',
        form_invoice: 'Invoice #',
        form_status: 'Status',
        form_complaint: 'Complaint',
        form_resolution: 'Resolution',
        form_reporter: 'Reported By',
        form_notes: 'Notes',
        status_open: 'Open',
        status_progress: 'In Progress',
        status_resolved: 'Resolved',
        btn_save: 'Save Complaint',
        btn_edit: 'Edit',
        btn_delete: 'Delete',
        btn_close: 'Close',
        btn_cancel: 'Cancel',
        stat_total: 'Total',
        stat_open: 'Open',
        stat_resolved: 'Resolved',
        filter_all: 'All',
        filter_open: 'Open',
        filter_progress: 'In Progress',
        filter_resolved: 'Resolved',
        search_placeholder: 'Search...',
        toast_saved: 'Complaint saved successfully',
        toast_deleted: 'Complaint deleted',
        toast_error: 'Error: ',
        empty_state: 'No complaints yet',
        confirm_delete: 'Delete this complaint?'
      },
      es: {
        auth_title: 'Acceso a Quejas',
        auth_unlock: 'Desbloquear',
        page_title: 'Quejas',
        nav_dashboard: 'Panel',
        nav_kanban: 'Kanban',
        nav_scoreboard: 'Marcador',
        nav_barcode: 'Código de Barras',
        nav_sop: 'Gestor SOP',
        nav_orders: 'Órdenes',
        nav_consignment: 'Consignación',
        nav_complaints: 'Quejas',
        nav_floor: 'Gestor de Piso',
        tab_new: 'Nuevo',
        tab_history: 'Historial',
        form_date: 'Fecha',
        form_customer: 'Cliente',
        form_invoice: 'Factura #',
        form_status: 'Estado',
        form_complaint: 'Queja',
        form_resolution: 'Resolución',
        form_reporter: 'Reportado Por',
        form_notes: 'Notas',
        status_open: 'Abierto',
        status_progress: 'En Progreso',
        status_resolved: 'Resuelto',
        btn_save: 'Guardar Queja',
        btn_edit: 'Editar',
        btn_delete: 'Eliminar',
        btn_close: 'Cerrar',
        btn_cancel: 'Cancelar',
        stat_total: 'Total',
        stat_open: 'Abiertos',
        stat_resolved: 'Resueltos',
        filter_all: 'Todos',
        filter_open: 'Abierto',
        filter_progress: 'En Progreso',
        filter_resolved: 'Resuelto',
        search_placeholder: 'Buscar...',
        toast_saved: 'Queja guardada exitosamente',
        toast_deleted: 'Queja eliminada',
        toast_error: 'Error: ',
        empty_state: 'Sin quejas aún',
        confirm_delete: '¿Eliminar esta queja?'
      }
    };

    const t = (key) => labels[lang][key] || key;

    // Utility Functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getPassword() {
      return localStorage.getItem('ro-auth-token') || '';
    }

    // API Functions
    async function apiGet(action, params = {}) {
      const qs = new URLSearchParams({ action, ...params });
      const res = await fetch(`${API}?${qs}`);
      const raw = await res.json();
      return raw.data || raw;
    }

    async function apiPost(action, data) {
      const res = await fetch(`${API}?action=${action}`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ ...data, password: getPassword() })
      });
      const raw = await res.json();
      if (raw.success === false) throw new Error(raw.error || 'Request failed');
      return raw;
    }

    // Core Functions
    async function loadComplaints() {
      try {
        const data = await apiGet('complaints');
        complaints = Array.isArray(data) ? data : [];
        renderComplaints();
      } catch (err) {
        console.error('Load error:', err);
        showToast(t('toast_error') + err.message, 'error');
      }
    }

    async function loadStats() {
      try {
        const stats = await apiGet('stats');
        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-open').textContent = stats.open || 0;
        document.getElementById('stat-resolved').textContent = stats.resolved || 0;
      } catch (err) {
        console.error('Stats error:', err);
      }
    }

    function renderComplaints() {
      const container = document.getElementById('complaints-list');

      let filtered = complaints;

      // Apply status filter
      if (currentFilter) {
        filtered = filtered.filter(c => c.status === currentFilter);
      }

      // Apply search
      if (currentSearch) {
        const term = currentSearch.toLowerCase();
        filtered = filtered.filter(c =>
          (c.customer && c.customer.toLowerCase().includes(term)) ||
          (c.complaint && c.complaint.toLowerCase().includes(term)) ||
          (c.invoice_number && c.invoice_number.toLowerCase().includes(term))
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="ph-duotone ph-warning-diamond"></i>
            <p>${t('empty_state')}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(renderCard).join('');
    }

    function renderCard(c) {
      const statusClass = c.status === 'Open' ? 'status-open' :
                         c.status === 'Resolved' ? 'status-resolved' :
                         'status-progress';
      const statusText = t('status_' + c.status.toLowerCase().replace(' ', '_'));

      return `
        <div class="complaint-card ${statusClass}"
             onclick="openDetail(${c.id})"
             onkeydown="if(event.key==='Enter') openDetail(${c.id})"
             role="button"
             tabindex="0">
          <div class="card-header">
            <span class="card-customer">${escapeHtml(c.customer)}</span>
            <span class="card-badge ${statusClass}">${statusText}</span>
          </div>
          <div class="card-meta">
            <span class="card-date">
              <i class="ph-duotone ph-calendar"></i> ${c.complaint_date}
            </span>
            ${c.invoice_number ? `
              <span class="card-invoice">
                <i class="ph-duotone ph-hash"></i> ${escapeHtml(c.invoice_number)}
              </span>
            ` : ''}
          </div>
          <div class="card-complaint">
            ${escapeHtml(c.complaint).substring(0, 120)}${c.complaint.length > 120 ? '...' : ''}
          </div>
        </div>
      `;
    }

    async function saveComplaint(e) {
      e.preventDefault();

      const data = {
        complaint_date: document.getElementById('complaint-date').value,
        customer: document.getElementById('complaint-customer').value,
        invoice_number: document.getElementById('complaint-invoice').value,
        status: document.getElementById('complaint-status').value,
        complaint: document.getElementById('complaint-text').value,
        resolution: document.getElementById('complaint-resolution').value,
        reported_by: document.getElementById('complaint-reporter').value,
        notes: document.getElementById('complaint-notes').value
      };

      try {
        await apiPost('save', data);
        showToast(t('toast_saved'), 'success');
        document.getElementById('complaint-form').reset();
        document.getElementById('complaint-date').valueAsDate = new Date();
        await Promise.all([loadComplaints(), loadStats()]);
        switchTab('history');
      } catch (err) {
        console.error('Save error:', err);
        showToast(t('toast_error') + err.message, 'error');
      }
    }

    async function deleteComplaint(id) {
      try {
        await apiPost('delete', { id });
        showToast(t('toast_deleted'), 'success');
        closeModal();
        await Promise.all([loadComplaints(), loadStats()]);
      } catch (err) {
        console.error('Delete error:', err);
        showToast(t('toast_error') + err.message, 'error');
      }
    }

    function openDetail(id) {
      const complaint = complaints.find(c => c.id === id);
      if (!complaint) return;

      currentComplaint = complaint;

      document.getElementById('modal-customer').textContent = complaint.customer;
      document.getElementById('modal-date').textContent = complaint.complaint_date;

      const statusText = t('status_' + complaint.status.toLowerCase().replace(' ', '_'));

      document.getElementById('detail-content').innerHTML = `
        <div class="detail-field">
          <div class="detail-label">${t('form_invoice')}</div>
          <div class="detail-value">${escapeHtml(complaint.invoice_number) || '\u2014'}</div>
        </div>
        <div class="detail-field">
          <div class="detail-label">${t('form_status')}</div>
          <div class="detail-value">${statusText}</div>
        </div>
        <div class="detail-field">
          <div class="detail-label">${t('form_complaint')}</div>
          <div class="detail-value">${escapeHtml(complaint.complaint)}</div>
        </div>
        <div class="detail-field">
          <div class="detail-label">${t('form_resolution')}</div>
          <div class="detail-value">${escapeHtml(complaint.resolution) || '\u2014'}</div>
        </div>
        <div class="detail-field">
          <div class="detail-label">${t('form_reporter')}</div>
          <div class="detail-value">${escapeHtml(complaint.reported_by) || '\u2014'}</div>
        </div>
        <div class="detail-field">
          <div class="detail-label">${t('form_notes')}</div>
          <div class="detail-value">${escapeHtml(complaint.notes) || '\u2014'}</div>
        </div>
        ${complaint.resolved_date ? `
          <div class="detail-field">
            <div class="detail-label">Resolved Date</div>
            <div class="detail-value">${complaint.resolved_date}</div>
          </div>
        ` : ''}
      `;

      document.getElementById('detail-modal').classList.add('active');
    }

    function editComplaint() {
      if (!currentComplaint) return;

      // Switch to new tab and populate form
      document.getElementById('complaint-date').value = currentComplaint.complaint_date;
      document.getElementById('complaint-customer').value = currentComplaint.customer;
      document.getElementById('complaint-invoice').value = currentComplaint.invoice_number || '';
      document.getElementById('complaint-status').value = currentComplaint.status;
      document.getElementById('complaint-text').value = currentComplaint.complaint;
      document.getElementById('complaint-resolution').value = currentComplaint.resolution || '';
      document.getElementById('complaint-reporter').value = currentComplaint.reported_by || '';
      document.getElementById('complaint-notes').value = currentComplaint.notes || '';

      // Update form to edit mode
      document.getElementById('complaint-form').onsubmit = async (e) => {
        e.preventDefault();

        const data = {
          id: currentComplaint.id,
          complaint_date: document.getElementById('complaint-date').value,
          customer: document.getElementById('complaint-customer').value,
          invoice_number: document.getElementById('complaint-invoice').value,
          status: document.getElementById('complaint-status').value,
          complaint: document.getElementById('complaint-text').value,
          resolution: document.getElementById('complaint-resolution').value,
          reported_by: document.getElementById('complaint-reporter').value,
          notes: document.getElementById('complaint-notes').value
        };

        try {
          await apiPost('save', data);
          showToast(t('toast_saved'), 'success');
          document.getElementById('complaint-form').reset();
          document.getElementById('complaint-form').onsubmit = saveComplaint;
          document.getElementById('complaint-date').valueAsDate = new Date();
          await Promise.all([loadComplaints(), loadStats()]);
          switchTab('history');
        } catch (err) {
          console.error('Update error:', err);
          showToast(t('toast_error') + err.message, 'error');
        }
      };

      closeModal();
      switchTab('new');
    }

    function confirmDelete() {
      if (!currentComplaint) return;
      if (confirm(t('confirm_delete'))) {
        deleteComplaint(currentComplaint.id);
      }
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
      currentComplaint = null;
    }

    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = toast.querySelector('i');

      toast.className = `toast ${type}`;
      icon.className = type === 'success' ? 'ph-duotone ph-check-circle' : 'ph-duotone ph-x-circle';
      document.getElementById('toast-message').textContent = msg;

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });
      document.querySelectorAll('.tab-content').forEach(tc => {
        tc.classList.toggle('active', tc.id === `tab-${tab}`);
      });
    }

    function filterByStatus(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === status);
      });
      renderComplaints();
    }

    function searchComplaints(term) {
      currentSearch = term;
      renderComplaints();
    }

    function updateUI() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (el.tagName === 'OPTION') {
          el.textContent = t(key);
        } else {
          el.textContent = t(key);
        }
      });

      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.placeholder = t('search_placeholder');
      }
    }

    function toggleLang() {
      lang = lang === 'en' ? 'es' : 'en';
      localStorage.setItem('ro-lang', lang);
      updateUI();
      renderComplaints();
    }

    function toggleDarkMode() {
      const html = document.documentElement;
      const body = document.body;
      const icon = document.querySelector('#dark-mode-toggle i');

      if (html.getAttribute('data-theme') === 'dark') {
        html.setAttribute('data-theme', 'light');
        body.classList.remove('dark-mode');
        icon.className = 'ph-duotone ph-moon';
        localStorage.setItem('ro-theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        body.classList.add('dark-mode');
        icon.className = 'ph-duotone ph-sun';
        localStorage.setItem('ro-theme', 'dark');
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // Auth Functions
    function checkAuth() {
      const token = getPassword();
      if (token) {
        document.getElementById('auth-overlay').style.display = 'none';
        init();
      }
    }

    function handleLogin(e) {
      e.preventDefault();
      const pw = document.getElementById('password-input').value;
      localStorage.setItem('ro-auth-token', pw);
      document.getElementById('auth-overlay').style.display = 'none';
      init();
    }

    // Init
    async function init() {
      // Restore theme
      const savedTheme = localStorage.getItem('ro-theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.body.classList.add('dark-mode');
        document.querySelector('#dark-mode-toggle i').className = 'ph-duotone ph-sun';
      }

      updateUI();
      await Promise.all([loadComplaints(), loadStats()]);

      // Set today's date on form
      document.getElementById('complaint-date').valueAsDate = new Date();
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();

      // Auth form
      document.getElementById('auth-form').addEventListener('submit', handleLogin);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Form submit
      document.getElementById('complaint-form').addEventListener('submit', saveComplaint);

      // Search with debounce
      let searchTimeout;
      document.getElementById('search-input').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchComplaints(e.target.value), 300);
      });

      // Filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => filterByStatus(btn.dataset.filter));
      });

      // Header buttons
      document.getElementById('lang-toggle').addEventListener('click', toggleLang);
      document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
      document.getElementById('refresh-btn').addEventListener('click', () => {
        loadComplaints();
        loadStats();
      });
      document.getElementById('menu-btn').addEventListener('click', toggleSidebar);

      // Modal close on overlay click
      document.getElementById('detail-modal').addEventListener('click', (e) => {
        if (e.target.id === 'detail-modal') closeModal();
      });

      // Modal close on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });
    });
  </script>
</body>
</html>
