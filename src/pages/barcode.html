<!DOCTYPE html>
<html>
<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/rogue-origin-apps/favicon.png">
  <link rel="manifest" href="/rogue-origin-apps/manifest.json">
  <meta name="theme-color" content="#668971">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RO Ops">
  <link rel="apple-touch-icon" href="/rogue-origin-apps/assets/icon-apple-touch.png">
  <title>Rogue Origin - Label Printer</title>

  <!-- Performance: Resource Hints -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://barcode.tec-it.com">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Scripts: Deferred for faster initial render -->
  <script defer src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Performance: CSS Preloading -->
  <link rel="stylesheet" href="../css/shared-base.css">
  <link rel="preload" href="../css/barcode.css" as="style">
  <link rel="stylesheet" href="../css/barcode.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <img src="../assets/ro-logo-horizontal.png" alt="Rogue Origin" class="logo">
      <div class="subtitle"><i class="ph-duotone ph-tag" style="margin-right:6px"></i> <span data-i18n="labelPrinter">Label Printer</span></div>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
        <button id="langBtn" class="outline" onclick="toggleLang()" aria-label="Toggle language" style="padding:8px 12px;font-size:12px"><i class="ph ph-translate"></i> <span id="langText">Espa√±ol</span></button>
        <button id="darkModeBtn" class="outline" onclick="toggleDarkMode()" aria-label="Toggle dark mode" style="padding:8px 12px;font-size:12px"><i class="ph ph-moon"></i></button>
      </div>
    </div>
    
    <div id="message" class="message"></div>
    
    <!-- Cultivar Selector -->
    <div class="cultivar-selector">
      <div class="cultivar-label"><i class="ph-duotone ph-plant" style="margin-right:6px"></i> <span data-i18n="selectCultivar">Select Cultivar</span></div>
      <select id="cultivarSelect" class="cultivar-dropdown" onchange="selectCultivar()" aria-label="Select cultivar">
        <option value="" data-i18n="chooseCultivar">-- Choose Cultivar --</option>
      </select>
    </div>
    
    <!-- Current Cultivar -->
    <div id="currentCultivar" class="current-cultivar">
      <h2 id="cultivarName">Lifter</h2>
      <p data-i18n="clickSizeToPrint">Click a size below to print</p>
    </div>
    
    <!-- Last Printed -->
    <div id="lastPrinted" class="last-printed">
      <span class="last-printed-label"><i class="ph ph-check-circle"></i> <span data-i18n="lastPrinted">Last Printed</span>:</span>
      <span id="lastPrintedValue" class="last-printed-value"></span>
      <br>
      <button class="print-again-btn" onclick="printLastAgain()" aria-label="Print again"><i class="ph ph-printer" style="margin-right:6px"></i> <span data-i18n="printAgain">Print Again</span></button>
    </div>
    
    <!-- Product Sections -->
    <div id="productSections" class="product-sections" style="display: none;">
      <div class="product-section tops">
        <div class="section-header tops"><i class="ph-duotone ph-package" style="margin-right:6px"></i> <span data-i18n="tops">Tops</span></div>
        <div id="topsButtons" class="size-buttons"></div>
      </div>
      <div class="product-section smalls">
        <div class="section-header smalls"><i class="ph-duotone ph-package" style="margin-right:6px"></i> <span data-i18n="smalls">Smalls</span></div>
        <div id="smallsButtons" class="size-buttons"></div>
      </div>
    </div>
    
    <!-- No Cultivar -->
    <div id="noCultivar" class="no-cultivar">
      <h3><i class="ph ph-hand-pointing" style="margin-right:8px"></i> <span data-i18n="selectACultivar">Select a Cultivar</span></h3>
      <p data-i18n="chooseCultivarHint">Choose which cultivar you're bagging to see available sizes</p>
    </div>

    <!-- Search -->
    <div class="search-section">
      <input type="text" id="searchBox" class="search-input" placeholder="Search for any product..." onkeyup="handleSearch()" data-i18n-placeholder="searchPlaceholder" aria-label="Search products">
      <div class="search-hint" data-i18n="searchHint">Type product name, SKU, or barcode</div>
    </div>
    
    <!-- Search Results -->
    <div id="searchResults" class="quick-print-section"></div>
    
    <!-- Toolbar -->
    <div class="toolbar">
      <button onclick="showAddModal()" aria-label="Add product"><i class="ph-duotone ph-plus" style="margin-right:6px"></i> <span data-i18n="addProduct">Add Product</span></button>
      <button class="secondary" onclick="showImportModal()" aria-label="Import"><i class="ph ph-download-simple" style="margin-right:6px"></i> <span data-i18n="import">Import</span></button>
      <button class="secondary" onclick="exportToCSV()" aria-label="Export"><i class="ph ph-upload-simple" style="margin-right:6px"></i> <span data-i18n="export">Export</span></button>
      <button class="gold" onclick="showPrintHelp()" aria-label="Print setup"><i class="ph ph-question" style="margin-right:6px"></i> <span data-i18n="printSetup">Print Setup</span></button>
      <button class="outline" onclick="loadProducts()" aria-label="Refresh"><i class="ph ph-arrow-clockwise" style="margin-right:6px"></i> <span data-i18n="refresh">Refresh</span></button>
    </div>

    <div id="loading" class="loading" data-i18n="loadingProducts">Loading Products...</div>
  </div>
  
  <!-- Modals -->
  <div id="productModal" class="modal" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-content">
      <h2 id="modalTitle" data-i18n="addProduct">Add Product</h2>
      <div class="form-group">
        <label data-i18n="productName">Product Name:</label>
        <input type="text" id="productHeader" placeholder="e.g., Lifter Tops 1 LB" maxlength="25" aria-label="Product name">
      </div>
      <div class="form-group">
        <label>SKU:</label>
        <input type="text" id="productSKU" placeholder="e.g., LIFT-TOPS-1LB" aria-label="SKU">
      </div>
      <div class="form-group">
        <label data-i18n="barcode">Barcode:</label>
        <input type="text" id="productBarcode" placeholder="e.g., 1234567890" aria-label="Barcode">
      </div>
      <div class="modal-buttons">
        <button class="outline" onclick="closeModal()" data-i18n="cancel">Cancel</button>
        <button onclick="saveProduct()" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <div id="importModal" class="modal" role="dialog" aria-labelledby="importModalTitle">
    <div class="modal-content">
      <h2 id="importModalTitle" data-i18n="importCSV">Import CSV</h2>
      <div class="form-group">
        <label data-i18n="pasteCSV">Paste CSV data (Header,SKU,Barcode):</label>
        <textarea id="csvText" rows="10" aria-label="CSV data"></textarea>
      </div>
      <div class="modal-buttons">
        <button class="outline" onclick="closeImportModal()" data-i18n="cancel">Cancel</button>
        <button onclick="importCSV()" data-i18n="import">Import</button>
      </div>
    </div>
  </div>

  <div id="printHelpModal" class="modal" role="dialog" aria-labelledby="printHelpTitle">
    <div class="modal-content">
      <h2 id="printHelpTitle"><i class="ph ph-printer" style="margin-right:8px"></i> <span data-i18n="printSetup">Print Setup</span></h2>
      <p style="margin-bottom: 15px; color: var(--text-muted);" data-i18n="configPrinter">Configure your Bixolon printer:</p>
      <ul style="margin: 0 0 15px 20px; color: var(--text);">
        <li><span data-i18n="paperSize">Paper size</span>: <strong style="color: var(--ro-gold);">1.65" √ó 0.5"</strong></li>
        <li><span data-i18n="margins">Margins</span>: <strong style="color: var(--ro-gold);"><span data-i18n="none">None</span></strong></li>
        <li><span data-i18n="headersFooters">Headers/Footers</span>: <strong style="color: var(--ro-gold);"><span data-i18n="off">Off</span></strong></li>
      </ul>
      <div class="modal-buttons">
        <button onclick="document.getElementById('printHelpModal').style.display='none'" data-i18n="gotIt">Got it!</button>
      </div>
    </div>
  </div>

  <script>
    var products = [];
    var selectedCultivar = '';
    var lastPrintedProduct = null;
    var sizeOrder = ['1 OZ', '1/4 LB', '1/2 LB', '1 LB', '10 LB', '5KG', '10KG'];
    var currentLang = 'en';
    var searchDebounceTimer = null;

    // Translations - English and Spanish
    var translations = {
      en: {
        labelPrinter: 'Label Printer',
        selectCultivar: 'Select Cultivar',
        chooseCultivar: '-- Choose Cultivar --',
        clickSizeToPrint: 'Click a size below to print',
        lastPrinted: 'Last Printed',
        printAgain: 'Print Again',
        tops: 'Tops',
        smalls: 'Smalls',
        selectACultivar: 'Select a Cultivar',
        chooseCultivarHint: 'Choose which cultivar you\'re bagging to see available sizes',
        searchPlaceholder: 'Search for any product...',
        searchHint: 'Type product name, SKU, or barcode',
        addProduct: 'Add Product',
        import: 'Import',
        export: 'Export',
        printSetup: 'Print Setup',
        refresh: 'Refresh',
        loadingProducts: 'Loading Products...',
        productName: 'Product Name:',
        barcode: 'Barcode:',
        cancel: 'Cancel',
        save: 'Save',
        importCSV: 'Import CSV',
        pasteCSV: 'Paste CSV data (Header,SKU,Barcode):',
        configPrinter: 'Configure your Bixolon printer:',
        paperSize: 'Paper size',
        margins: 'Margins',
        headersFooters: 'Headers/Footers',
        none: 'None',
        off: 'Off',
        gotIt: 'Got it!',
        loaded: 'Loaded',
        products: 'products',
        printing: 'Printing',
        error: 'Error',
        fillAllFields: 'Please fill all fields',
        pasteCSVData: 'Paste CSV data',
        results: 'Results',
        noResults: 'No results found'
      },
      es: {
        labelPrinter: 'Impresora de Etiquetas',
        selectCultivar: 'Seleccionar Cultivar',
        chooseCultivar: '-- Elegir Cultivar --',
        clickSizeToPrint: 'Haga clic en un tama√±o para imprimir',
        lastPrinted: '√öltima Impresi√≥n',
        printAgain: 'Imprimir de Nuevo',
        tops: 'Cogollos',
        smalls: 'Peque√±os',
        selectACultivar: 'Seleccionar un Cultivar',
        chooseCultivarHint: 'Elija qu√© cultivar est√° empacando para ver los tama√±os disponibles',
        searchPlaceholder: 'üîç Buscar cualquier producto...',
        searchHint: 'Escriba nombre del producto, SKU o c√≥digo de barras',
        addProduct: 'Agregar Producto',
        import: 'Importar',
        export: 'Exportar',
        printSetup: 'Configuraci√≥n de Impresi√≥n',
        refresh: 'Actualizar',
        loadingProducts: 'Cargando Productos...',
        productName: 'Nombre del Producto:',
        barcode: 'C√≥digo de Barras:',
        cancel: 'Cancelar',
        save: 'Guardar',
        importCSV: 'Importar CSV',
        pasteCSV: 'Pegue los datos CSV (Encabezado,SKU,C√≥digo):',
        configPrinter: 'Configure su impresora Bixolon:',
        paperSize: 'Tama√±o de papel',
        margins: 'M√°rgenes',
        headersFooters: 'Encabezados/Pies',
        none: 'Ninguno',
        off: 'Apagado',
        gotIt: '¬°Entendido!',
        loaded: 'Cargados',
        products: 'productos',
        printing: 'Imprimiendo',
        error: 'Error',
        fillAllFields: 'Por favor complete todos los campos',
        pasteCSVData: 'Pegue los datos CSV',
        results: 'Resultados',
        noResults: 'No se encontraron resultados'
      }
    };

    function t(key) {
      return translations[currentLang][key] || translations['en'][key] || key;
    }

    function updateAllText() {
      // Update all data-i18n elements
      document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      // Update all data-i18n-placeholder elements
      document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });
      // Update language button
      var langBtn = document.getElementById('langBtn');
      var langText = document.getElementById('langText');
      if (langText) langText.textContent = currentLang === 'en' ? 'Espa√±ol' : 'English';
    }

    function toggleLang() {
      currentLang = currentLang === 'en' ? 'es' : 'en';
      try { localStorage.setItem('barcodeLang', currentLang); } catch(e) {}
      updateAllText();
      // Rebuild cultivar dropdown with new language
      populateCultivarDropdown();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      var isDark = document.body.classList.contains('dark-mode');
      try { localStorage.setItem('barcodeDarkMode', isDark ? 'true' : 'false'); } catch(e) {}
      
      if (btn) btn.textContent = isDark ? '‚òÄÔ∏è' : '<i class="ph ph-moon"></i>';
    }

    function initSettings() {
      // Load language preference
      try {
        var savedLang = localStorage.getItem('barcodeLang');
        if (savedLang) currentLang = savedLang;
        var savedDark = localStorage.getItem('barcodeDarkMode');
        if (savedDark === 'true') {
          document.body.classList.add('dark-mode');
          
          
          if (btn) {
            var icon = btn.querySelector('i');
            if (icon) icon.className = 'ph ph-sun';
          }
        }
      } catch(e) {}
      updateAllText();
    }

    // API Configuration for GitHub Pages - will be updated after deployment
    var API_URL = 'https://script.google.com/macros/s/AKfycbw7E0oVCTPQfEi6tSDpL_FVk2XrgE6jsoM7I8Ei62VUO_L9tU1bKyH7OwkWOxSG5TGYmw/exec';

    // Detect environment: Apps Script or GitHub Pages
    var isAppsScript = typeof google !== 'undefined' && google.script && google.script.run;

    window.onload = function() { initSettings(); loadProducts(); };
    
    function loadProducts() {
      document.getElementById('loading').style.display = 'block';
      
      if (isAppsScript) {
        google.script.run
          .withSuccessHandler(function(data) {
            products = data || [];
            populateCultivarDropdown();
            document.getElementById('loading').style.display = 'none';
            showMessage('Loaded ' + products.length + ' products', 'success');
          })
          .withFailureHandler(function(error) {
            document.getElementById('loading').style.display = 'none';
            showMessage('Error: ' + error.message, 'error');
          })
          .getProducts();
      } else {
        fetch(API_URL + '?action=products')
          .then(function(response) { return response.json(); })
          .then(function(data) {
            products = data.products || [];
            populateCultivarDropdown();
            document.getElementById('loading').style.display = 'none';
            showMessage('Loaded ' + products.length + ' products', 'success');
          })
          .catch(function(error) {
            document.getElementById('loading').style.display = 'none';
            showMessage('Error: ' + error.message, 'error');
          });
      }
    }
    
    function parseProductName(name) {
      var parts = (name || '').trim().split(' ');
      var size = null;
      var type = null;
      var cultivar = null;
      
      if (parts.length > 0) {
        var lastPart = parts[parts.length - 1].toUpperCase();
        if (/^\d+KG$/.test(lastPart)) {
          size = lastPart;
          parts = parts.slice(0, -1);
        }
      }
      
      if (!size) {
        for (var i = parts.length - 1; i >= 0; i--) {
          var potential = parts.slice(i).join(' ').toUpperCase();
          if (/^(1|1\/2|1\/4|5|10)\s*(OZ|LB)$/i.test(potential)) {
            size = potential;
            parts = parts.slice(0, i);
            break;
          }
        }
      }
      
      if (parts.length > 0) {
        var lastWord = parts[parts.length - 1];
        if (/^(Tops|Smalls|Trim|Shake|Flower)$/i.test(lastWord)) {
          type = lastWord.charAt(0).toUpperCase() + lastWord.slice(1).toLowerCase();
          parts = parts.slice(0, -1);
        }
      }
      
      cultivar = parts.join(' ');
      return { cultivar: cultivar, type: type, size: size };
    }
    
    function populateCultivarDropdown() {
      var cultivars = {};
      products.forEach(function(p) {
        var parsed = parseProductName(p.header);
        if (parsed.cultivar) {
          cultivars[parsed.cultivar] = (cultivars[parsed.cultivar] || 0) + 1;
        }
      });
      
      var select = document.getElementById('cultivarSelect');
      select.innerHTML = '<option value="">-- Choose Cultivar (' + Object.keys(cultivars).length + ') --</option>';
      
      Object.keys(cultivars).sort().forEach(function(c) {
        var opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c + ' (' + cultivars[c] + ')';
        select.appendChild(opt);
      });
    }
    
    function selectCultivar() {
      selectedCultivar = document.getElementById('cultivarSelect').value;
      
      if (!selectedCultivar) {
        document.getElementById('currentCultivar').classList.remove('show');
        document.getElementById('productSections').style.display = 'none';
        document.getElementById('noCultivar').style.display = 'block';
        return;
      }
      
      document.getElementById('cultivarName').innerHTML = '<i class="ph-duotone ph-plant" style="margin-right:6px"></i> ' + selectedCultivar;
      document.getElementById('currentCultivar').classList.add('show');
      document.getElementById('productSections').style.display = 'grid';
      document.getElementById('noCultivar').style.display = 'none';
      
      buildSizeButtons();
    }
    
    function buildSizeButtons() {
      var topsContainer = document.getElementById('topsButtons');
      var smallsContainer = document.getElementById('smallsButtons');
      topsContainer.innerHTML = '';
      smallsContainer.innerHTML = '';
      
      var cultivarProducts = products.filter(function(p) {
        var parsed = parseProductName(p.header);
        return parsed.cultivar === selectedCultivar;
      });
      
      var tops = {};
      var smalls = {};
      
      cultivarProducts.forEach(function(p) {
        var parsed = parseProductName(p.header);
        if (parsed.type === 'Tops') {
          tops[parsed.size] = p;
        } else if (parsed.type === 'Smalls') {
          smalls[parsed.size] = p;
        }
      });
      
      sizeOrder.forEach(function(size) {
        var btn = document.createElement('button');
        btn.className = 'size-btn tops';
        btn.textContent = size;
        if (tops[size]) {
          btn.onclick = function() { printProduct(tops[size]); };
        } else {
          btn.className += ' disabled';
        }
        topsContainer.appendChild(btn);
      });
      
      sizeOrder.forEach(function(size) {
        var btn = document.createElement('button');
        btn.className = 'size-btn smalls';
        btn.textContent = size;
        if (smalls[size]) {
          btn.onclick = function() { printProduct(smalls[size]); };
        } else {
          btn.className += ' disabled';
        }
        smallsContainer.appendChild(btn);
      });
    }
    
    function printProduct(product) {
      lastPrintedProduct = product;
      document.getElementById('lastPrintedValue').textContent = product.header;
      document.getElementById('lastPrinted').classList.add('show');
      printBarcode(product.barcode, product.header);
    }
    
    function printLastAgain() {
      if (lastPrintedProduct) {
        printBarcode(lastPrintedProduct.barcode, lastPrintedProduct.header);
      }
    }
    
    function handleSearch() {
      // Debounce search input - wait 300ms after user stops typing
      if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(performSearch, 300);
    }

    function performSearch() {
      var search = document.getElementById('searchBox').value.toLowerCase().trim();
      var resultsDiv = document.getElementById('searchResults');

      if (!search) {
        resultsDiv.classList.remove('show');
        return;
      }

      var filtered = products.filter(function(p) {
        return (p.header && p.header.toLowerCase().indexOf(search) >= 0) ||
               (p.sku && p.sku.toLowerCase().indexOf(search) >= 0) ||
               (p.barcode && String(p.barcode).indexOf(search) >= 0);
      });

      if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div class="quick-print-title">' + t('noResults') + '</div>';
        resultsDiv.classList.add('show');
        return;
      }

      var html = '<div class="quick-print-title"><i class="ph ph-magnifying-glass" style="margin-right:6px"></i> ' + t('results') + ' (' + filtered.length + ')</div>';
      html += '<div class="quick-print-grid">';

      filtered.slice(0, 20).forEach(function(p) {
        html += '<div class="quick-print-card" onclick="printProduct(products.find(function(x){return x.barcode===\'' + p.barcode + '\'}))">';
        html += '<div class="quick-print-name">' + escapeHtml(p.header) + '</div>';
        html += '<div class="quick-print-barcode">' + escapeHtml(p.barcode) + '</div>';
        html += '</div>';
      });

      html += '</div>';
      resultsDiv.innerHTML = html;
      resultsDiv.classList.add('show');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    function printBarcode(barcode, name) {
      var barcodeUrl = 'https://barcode.tec-it.com/barcode.ashx?data=' + encodeURIComponent(barcode) + 
                       '&code=Code128&dpi=203&modulewidth=fit&height=35&hidetext=1';
      
      var iframe = document.getElementById('printFrame');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'printFrame';
        iframe.style.cssText = 'position:fixed;right:0;bottom:0;width:0;height:0;border:none;';
        document.body.appendChild(iframe);
      }
      
      var doc = iframe.contentWindow.document;
      doc.open();
      doc.write('<!DOCTYPE html><html><head><style>');
      doc.write('@page { size: 1.65in 0.5in; margin: 0 0.15in !important; }');
      doc.write('@media print { html, body { width: 1.35in !important; height: 0.5in !important; margin: 0 !important; padding: 0 !important; overflow: hidden; } }');
      doc.write('body { margin: 0; padding: 0; font-family: Arial; }');
      doc.write('.label { width: 1.35in; height: 0.5in; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1px; }');
      doc.write('.name { font-size: 6pt; font-weight: bold; margin-bottom: 1px; }');
      doc.write('.barcode { width: 1.3in; height: 0.35in; }');
      doc.write('</style></head><body>');
      doc.write('<div class="label">');
      doc.write('<div class="name">' + name.substring(0, 25) + '</div>');
      doc.write('<img class="barcode" src="' + barcodeUrl + '">');
      doc.write('</div>  <script src="../js/sw-register.js" async><\/script>
</body></html>');
      doc.close();
      
      var img = doc.querySelector('img');
      img.onload = function() {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
      };
      
      if (img.complete) {
        setTimeout(function() {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        }, 100);
      }
      
      showMessage('Printing: ' + name, 'success');
    }
    
    var currentEditRow = null;
    
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Product';
      document.getElementById('productHeader').value = '';
      document.getElementById('productSKU').value = '';
      document.getElementById('productBarcode').value = '';
      currentEditRow = null;
      document.getElementById('productModal').style.display = 'block';
    }
    
    function closeModal() { document.getElementById('productModal').style.display = 'none'; }
    function showImportModal() { document.getElementById('importModal').style.display = 'block'; }
    function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
    function showPrintHelp() { document.getElementById('printHelpModal').style.display = 'block'; }
    
    function saveProduct() {
      var h = document.getElementById('productHeader').value.trim();
      var s = document.getElementById('productSKU').value.trim();
      var b = document.getElementById('productBarcode').value.trim();
      if (!h || !s || !b) { alert('Please fill all fields'); return; }
      
      function handleResult(r) {
        showMessage(r.message, r.success ? 'success' : 'error');
        if (r.success) { loadProducts(); closeModal(); }
      }
      
      if (isAppsScript) {
        google.script.run.withSuccessHandler(handleResult).addProduct(h, s, b);
      } else {
        fetch(API_URL + '?action=add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ header: h, sku: s, barcode: b })
        })
          .then(function(response) { return response.json(); })
          .then(handleResult)
          .catch(function(e) { showMessage('Error: ' + e.message, 'error'); });
      }
    }
    
    function importCSV() {
      var csv = document.getElementById('csvText').value.trim();
      if (!csv) { alert('Paste CSV data'); return; }
      
      function handleResult(r) {
        showMessage(r.message, r.success ? 'success' : 'error');
        if (r.success) { loadProducts(); closeImportModal(); }
      }
      
      if (isAppsScript) {
        google.script.run.withSuccessHandler(handleResult).importCSV(csv);
      } else {
        fetch(API_URL + '?action=import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ csv: csv })
        })
          .then(function(response) { return response.json(); })
          .then(handleResult)
          .catch(function(e) { showMessage('Error: ' + e.message, 'error'); });
      }
    }
    
    function exportToCSV() {
      var csv = 'Header,SKU,Barcode\n';
      products.forEach(function(p) {
        csv += '"' + (p.header||'') + '","' + (p.sku||'') + '","' + (p.barcode||'') + '"\n';
      });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
      a.download = 'products.csv';
      a.click();
    }
    
    function showMessage(text, type) {
      var m = document.getElementById('message');
      m.textContent = text;
      m.className = 'message ' + type;
      m.style.display = 'block';
      setTimeout(function() { m.style.display = 'none'; }, 3000);
    }
    
    window.onclick = function(e) {
      if (e.target.className && e.target.className.indexOf('modal') >= 0) e.target.style.display = 'none';
    };
  </script>
  <script src="../js/sw-register.js" async></script>
</body>
</html>
