<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management - Rogue Origin</title>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    :root {
      --gold: #e4aa4f;
      --gold-light: #f0cb60;
      --gold-dim: rgba(228,170,79,0.15);
      --green: #668971;
      --green-dark: #4a6b54;
      --green-dim: rgba(102,137,113,0.15);
      --bg: #faf8f5;
      --bg-card: #ffffff;
      --border: #e8e4de;
      --text: #2d3a2e;
      --text-muted: #8a9a8e;
      --danger: #c45c4a;
      --success: #5a9a6e;
      --warning: #d4a03c;
    }

    body.dark-mode {
      --bg: #1a1a1a;
      --bg-card: #2d2d2d;
      --border: #444444;
      --text: #e0e0e0;
      --text-muted: #888888;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
    .brand h1 { font-size: 20px; font-weight: 600; }
    .brand p { color: var(--green); font-size: 12px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }

    /* Unit Toggle */
    .unit-toggle {
      display: flex;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 3px;
      position: relative;
    }
    .unit-toggle button {
      padding: 6px 14px;
      border: none;
      background: transparent;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }
    .unit-toggle button.active {
      background: var(--green);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(102, 137, 113, 0.3);
    }

    /* Buttons */
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:active::before {
      width: 300px;
      height: 300px;
    }
    .btn-primary { background: var(--green); color: #fff; }
    .btn-primary:hover { background: var(--green-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 137, 113, 0.3); }
    .btn-primary:active { transform: translateY(0); }
    .btn-secondary { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
    .btn-secondary:hover { border-color: var(--green); transform: translateY(-1px); }
    .btn-gold { background: var(--gold); color: #fff; }
    .btn-gold:hover { background: #d99a3f; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(228, 170, 79, 0.3); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    /* Main Layout */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      animation: fadeIn 0.4s ease-out;
    }

    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideUp 0.4s ease-out backwards;
    }
    .stat-card:nth-child(1) { animation-delay: 0.05s; }
    .stat-card:nth-child(2) { animation-delay: 0.1s; }
    .stat-card:nth-child(3) { animation-delay: 0.15s; }
    .stat-card:nth-child(4) { animation-delay: 0.2s; }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .stat-card .label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--green);
      transition: all 0.3s ease;
    }
    .stat-card .value.updating {
      animation: pulse 0.4s ease;
    }

    /* Orders Table */
    .orders-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      animation: slideUp 0.4s ease-out 0.25s backwards;
    }
    .section-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .section-header h2 { font-size: 16px; font-weight: 600; }
    .filters { display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      transition: all 0.2s ease;
    }
    .filter-input:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 3px var(--green-dim);
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    tr { transition: all 0.2s ease; }
    tr:hover { background: var(--green-dim); }
    tr:last-child td { border-bottom: none; }

    /* Status Badges */
    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      animation: fadeIn 0.3s ease;
    }
    .status-pending { background: var(--gold-dim); color: var(--gold); }
    .status-processing { background: rgba(100, 149, 237, 0.15); color: #6495ED; }
    .status-ready { background: var(--green-dim); color: var(--green); }
    .status-shipped { background: rgba(138, 154, 142, 0.15); color: var(--text-muted); }
    .status-completed { background: rgba(90, 154, 110, 0.2); color: var(--success); }

    /* Progress Bar */
    .progress-bar { width: 100px; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), var(--gold));
      border-radius: 4px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
      backdrop-filter: blur(0px);
    }
    .modal-overlay.open {
      display: flex;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-overlay.open .modal {
      transform: scale(1);
      opacity: 1;
      animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 18px; font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .modal-close:hover {
      background: var(--border);
      transform: rotate(90deg);
    }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

    /* Form */
    .form-group {
      margin-bottom: 20px;
      animation: slideInLeft 0.3s ease-out backwards;
    }
    .form-group:nth-child(1) { animation-delay: 0.05s; }
    .form-group:nth-child(2) { animation-delay: 0.1s; }
    .form-group:nth-child(3) { animation-delay: 0.15s; }
    .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
      transition: all 0.2s ease;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 3px var(--green-dim);
      transform: translateY(-1px);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    /* Customer Select */
    .customer-select-container { position: relative; }
    .add-customer-link {
      font-size: 12px;
      color: var(--green);
      cursor: pointer;
      text-decoration: underline;
      margin-top: 6px;
      display: inline-block;
      transition: all 0.2s ease;
    }
    .add-customer-link:hover { color: var(--green-dark); transform: translateX(2px); }

    /* Pallets Section */
    .pallets-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    .pallets-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pallets-header h4 { font-size: 14px; font-weight: 600; }
    .pallet-card {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transition: all 0.2s ease;
    }
    .pallet-card:hover {
      border-color: var(--green);
      box-shadow: 0 4px 12px rgba(102, 137, 113, 0.1);
    }
    .pallet-card.removing {
      animation: slideOutRight 0.3s ease forwards;
    }
    .pallet-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pallet-card-header h5 { font-size: 13px; font-weight: 600; color: var(--green); }
    .pallet-remove {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .pallet-remove:hover { background: rgba(196, 92, 74, 0.1); transform: scale(1.1); }

    /* Strain Row */
    .strain-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 10px;
      margin-bottom: 10px;
      align-items: start;
      animation: slideInDown 0.3s ease;
    }
    .strain-row.removing {
      animation: slideOutUp 0.3s ease forwards;
    }
    .strain-row select, .strain-row input {
      padding: 8px 10px;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    .strain-row select:focus, .strain-row input:focus {
      transform: scale(1.02);
    }
    .strain-remove {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 16px;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .strain-remove:hover { background: rgba(196, 92, 74, 0.1); transform: scale(1.1); }
    .add-strain-btn { margin-top: 8px; }

    /* Pallet Total */
    .pallet-total {
      background: var(--green-dim);
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .pallet-total.updating {
      animation: pulse 0.4s ease;
    }
    .pallet-total-label { color: var(--text-muted); }
    .pallet-total-value { color: var(--green); font-size: 16px; }

    /* Order Totals */
    .order-totals {
      background: var(--gold-dim);
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      animation: slideUp 0.4s ease-out 0.2s backwards;
    }
    .order-totals h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--gold); }
    .totals-grid { display: grid; gap: 8px; }
    .totals-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      transition: all 0.3s ease;
    }
    .totals-row.final { border-top: 2px solid var(--gold); padding-top: 8px; margin-top: 8px; font-size: 16px; font-weight: 700; }
    .totals-label { color: var(--text-muted); }
    .totals-value {
      font-weight: 600;
      color: var(--text);
      transition: all 0.3s ease;
    }
    .totals-value.updating {
      animation: pulse 0.4s ease;
    }
    .totals-value.currency { color: var(--gold); }

    /* Order Detail */
    .order-detail { padding: 24px; }
    .order-detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .order-title { font-size: 24px; font-weight: 700; }
    .order-meta { display: flex; gap: 20px; margin-top: 8px; flex-wrap: wrap; }
    .order-meta span { font-size: 13px; color: var(--text-muted); }
    .order-progress { margin: 24px 0; padding: 20px; background: var(--bg); border-radius: 12px; }
    .order-progress-bar { height: 12px; background: var(--border); border-radius: 6px; overflow: hidden; margin: 12px 0; }
    .order-progress-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--gold)); border-radius: 6px; }
    .order-progress-stats { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); }

    /* Responsive */
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .strain-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .strain-row select, .strain-row input {
        width: 100%;
      }
      th, td { padding: 10px 12px; font-size: 13px; }
      .hide-mobile { display: none; }
      .modal { width: 95%; max-height: 95vh; }
      .btn { min-height: 44px; } /* Better touch target */
      .unit-toggle button { min-height: 36px; min-width: 48px; }
    }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: var(--text-muted); }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      animation: fadeIn 0.4s ease;
    }
    .empty-state i { font-size: 64px; color: var(--text-muted); margin-bottom: 16px; }
    .empty-state h3 { font-size: 18px; margin-bottom: 8px; }
    .empty-state p { color: var(--text-muted); margin-bottom: 20px; }

    /* Customer Link */
    .customer-link { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--green-dim); border-radius: 8px; margin-top: 20px; }
    .customer-link input { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; font-family: monospace; }

    /* Toast */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 10000; display: flex; flex-direction: column; gap: 8px; }
    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: toastSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 360px;
    }
    .toast.error { background: var(--danger); }
    .toast.success { background: var(--success); }
    .toast.warning { background: var(--warning); color: #1a1a1a; }
    .toast.info { background: var(--green); }
    .toast.hiding { animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes slideOutRight {
      to {
        opacity: 0;
        transform: translateX(100px);
        height: 0;
        margin: 0;
        padding: 0;
      }
    }
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes slideOutUp {
      to {
        opacity: 0;
        transform: translateY(-20px);
        height: 0;
        margin: 0;
      }
    }
    @keyframes modalSlideUp {
      from {
        transform: scale(0.9) translateY(20px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes toastSlideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes toastSlideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <img src="https://rogueff.github.io/rogue-origin-apps/assets/ro-logo.png" alt="RO" class="logo" onerror="this.style.display='none'">
        <div>
          <h1>Order Management</h1>
          <p>Wholesale Order Tracking</p>
        </div>
      </div>
      <div class="header-actions">
        <!-- Unit Toggle -->
        <div class="unit-toggle">
          <button id="unitKg" class="active" onclick="setUnit('kg')">kg</button>
          <button id="unitLbs" onclick="setUnit('lbs')">lbs</button>
        </div>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">
          <i class="ph ph-arrow-left"></i> Back
        </button>
        <button class="btn btn-secondary" onclick="toggleDarkMode()">
          <i class="ph ph-moon"></i>
        </button>
        <button class="btn btn-primary" onclick="openNewOrderModal()">
          <i class="ph ph-plus"></i> New Order
        </button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="label">Active Orders</div>
        <div class="value" id="statActiveOrders">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Pending</div>
        <div class="value" id="statPendingKg">-</div>
      </div>
      <div class="stat-card">
        <div class="label">In Progress</div>
        <div class="value" id="statProgressKg">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Ready to Ship</div>
        <div class="value" id="statReadyKg">-</div>
      </div>
    </div>

    <!-- Orders List -->
    <div class="orders-section" id="ordersSection">
      <div class="section-header">
        <h2>All Orders</h2>
        <div class="filters">
          <select class="filter-input" id="filterStatus" onchange="filterOrders()">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="ready">Ready to Ship</option>
            <option value="shipped">Shipped</option>
            <option value="completed">Completed</option>
          </select>
          <input type="text" class="filter-input" id="filterSearch" placeholder="Search customer..." onkeyup="filterOrders()">
        </div>
      </div>
      <div id="ordersTableContainer">
        <div class="loading">
          <div class="spinner"></div>
          Loading orders...
        </div>
      </div>
    </div>
  </main>

  <!-- New/Edit Order Modal -->
  <div class="modal-overlay" id="orderModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">New Order</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="orderForm">
          <input type="hidden" id="orderId">

          <!-- Customer Selection -->
          <div class="customer-select-container">
            <div class="form-group">
              <label>Customer *</label>
              <select id="customerSelect" onchange="handleCustomerChange()">
                <option value="">Select a customer...</option>
              </select>
              <a class="add-customer-link" onclick="openNewCustomerModal()">
                <i class="ph ph-plus"></i> Add New Customer
              </a>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Status</label>
              <select id="orderStatus">
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="ready">Ready to Ship</option>
                <option value="shipped">Shipped</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" id="dueDate">
            </div>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea id="orderNotes" placeholder="Special instructions, documentation requirements, etc."></textarea>
          </div>

          <!-- Pallets -->
          <div class="pallets-section">
            <div class="pallets-header">
              <h4><i class="ph ph-package"></i> Pallets</h4>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addPallet()">
                <i class="ph ph-plus"></i> Add Pallet
              </button>
            </div>
            <div id="palletsContainer"></div>
            <p class="form-hint">Each pallet can contain multiple cultivars with individual weights and pricing.</p>
          </div>

          <!-- Order Totals -->
          <div class="order-totals">
            <h4><i class="ph ph-calculator"></i> Order Summary</h4>
            <div class="totals-grid">
              <div class="totals-row">
                <span class="totals-label">Total Weight:</span>
                <span class="totals-value" id="totalWeight">0 kg</span>
              </div>
              <div class="totals-row">
                <span class="totals-label">Total Pallets:</span>
                <span class="totals-value" id="totalPallets">0</span>
              </div>
              <div class="totals-row final">
                <span class="totals-label">Total Price:</span>
                <span class="totals-value currency" id="totalPrice">$0.00</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveOrder()">Save Order</button>
      </div>
    </div>
  </div>

  <!-- New Customer Modal -->
  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header">
        <h3>New Customer</h3>
        <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" id="customerCompanyName" required placeholder="e.g., Hamburg GmbH">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Contact Name</label>
              <input type="text" id="customerContactName" placeholder="e.g., John Smith">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="customerEmail" placeholder="contact@company.com">
            </div>
          </div>
          <div class="form-group">
            <label>Street Address</label>
            <input type="text" id="customerStreet" placeholder="123 Main St">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="customerCity">
            </div>
            <div class="form-group">
              <label>State/Province</label>
              <input type="text" id="customerState">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Postal Code</label>
              <input type="text" id="customerZip">
            </div>
            <div class="form-group">
              <label>Country *</label>
              <input type="text" id="customerCountry" required placeholder="e.g., Germany">
            </div>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="customerPhone">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
      </div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3>Order Details</h3>
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="modal-body" id="orderDetailContent">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>

<script>
(function() {
  // Configuration
  const API_URL = 'https://script.google.com/macros/s/AKfycbxDAHSFl9cedGS49L3Lf5ztqy-SSToYigyA30ZtsdpmWNAR9H61X_Mm48JOOTGqqr-Z/exec';
  const LBS_PER_KG = 2.20462;

  // State
  let orders = [];
  let customers = [];
  let cultivars = [];
  let pricing = {};
  let palletCounter = 0;
  let strainCounter = 0;
  let currentUnit = 'kg'; // kg or lbs

  // Unit conversion
  function convertWeight(kg, toUnit) {
    if (toUnit === 'lbs') return kg * LBS_PER_KG;
    return kg;
  }

  function getUnitLabel() {
    return currentUnit;
  }

  function formatWeight(kg, decimals = 1, preferredUnit = null) {
    const unit = preferredUnit || currentUnit;
    const value = convertWeight(kg, unit);
    return value.toFixed(decimals) + ' ' + unit;
  }

  window.setUnit = function(unit) {
    currentUnit = unit;
    localStorage.setItem('ro_unit', unit);

    // Update UI
    document.getElementById('unitKg').classList.toggle('active', unit === 'kg');
    document.getElementById('unitLbs').classList.toggle('active', unit === 'lbs');

    // Refresh displays
    renderOrders();
    updateStats();

    // Update form if open
    if (document.getElementById('orderModal').classList.contains('open')) {
      recalculateOrderTotals();
    }
  };

  // Toast notification
  function showToast(message, type, duration) {
    type = type || 'info';
    duration = duration || 4000;
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container';
      document.body.appendChild(container);
    }
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(function() {
      toast.classList.add('hiding');
      setTimeout(function() { toast.remove(); }, 300);
    }, duration);
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async function() {
    initDarkMode();
    initUnit();
    await loadInitialData();
  });

  function initDarkMode() {
    if (localStorage.getItem('ro_dark_mode') === 'true') {
      document.body.classList.add('dark-mode');
    }
  }

  function initUnit() {
    const savedUnit = localStorage.getItem('ro_unit') || 'kg';
    setUnit(savedUnit);
  }

  window.toggleDarkMode = function() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('ro_dark_mode', document.body.classList.contains('dark-mode'));
  };

  // Load initial data
  async function loadInitialData() {
    try {
      await Promise.all([
        loadOrders(),
        loadCustomers(),
        loadCultivars(),
        loadPricing()
      ]);
    } catch (error) {
      console.error('Failed to load initial data:', error);
      showToast('Using demo data', 'warning');
      loadDemoData();
    }
  }

  async function loadCustomers() {
    try {
      const response = await fetch(`${API_URL}?action=getCustomers`);
      const data = await response.json();
      customers = data.customers || getDemoCustomers();
      populateCustomerDropdown();
    } catch (error) {
      customers = getDemoCustomers();
      populateCustomerDropdown();
    }
  }

  async function loadCultivars() {
    try {
      const response = await fetch(`${API_URL}?action=getCultivars`);
      const data = await response.json();
      cultivars = data.cultivars || getDemoCultivars();
    } catch (error) {
      cultivars = getDemoCultivars();
    }
  }

  async function loadPricing() {
    try {
      const response = await fetch(`${API_URL}?action=getPricing`);
      const data = await response.json();
      if (data.pricing) {
        pricing = {};
        data.pricing.forEach(p => {
          pricing[p.cultivar] = p.pricePerKg;
        });
      } else {
        pricing = getDemoPricing();
      }
    } catch (error) {
      pricing = getDemoPricing();
    }
  }

  async function loadOrders() {
    try {
      const response = await fetch(`${API_URL}?action=getOrders`);
      const data = await response.json();
      orders = data.orders || getDemoOrders();
      renderOrders();
      updateStats();
    } catch (error) {
      orders = getDemoOrders();
      renderOrders();
      updateStats();
    }
  }

  // Demo data
  function getDemoCustomers() {
    return [
      {
        id: 'CUST-001',
        companyName: 'Hamburg GmbH',
        contactName: 'Klaus Mueller',
        email: 'klaus@hamburg-hemp.de',
        address: { street: 'Hauptstrasse 123', city: 'Hamburg', state: 'HH', zip: '20095', country: 'Germany' },
        phone: '+49 40 1234567'
      },
      {
        id: 'CUST-002',
        companyName: 'Denver Distributors',
        contactName: 'Mike Johnson',
        email: 'mike@denverhemp.com',
        address: { street: '456 Broadway', city: 'Denver', state: 'CO', zip: '80202', country: 'USA' },
        phone: '+1 303-555-0123'
      }
    ];
  }

  function getDemoCultivars() {
    return ['Sour Lifter', 'Lifter', 'Cherry Wine', 'Elektra', 'Hawaiian Haze', 'Special Sauce', 'Suver Haze'];
  }

  function getDemoPricing() {
    return { 'Sour Lifter': 150, 'Lifter': 140, 'Cherry Wine': 160, 'Elektra': 145, 'Hawaiian Haze': 135, 'Special Sauce': 130, 'Suver Haze': 140 };
  }

  function getDemoOrders() {
    return [
      {
        id: 'ORD-001',
        customerId: 'CUST-001',
        customer: 'Hamburg GmbH',
        address: { street: 'Hauptstrasse 123', city: 'Hamburg', state: 'HH', zip: '20095', country: 'Germany' },
        items: [
          { cultivar: 'Sour Lifter', quantityKg: 630, pricePerKg: 150, total: 94500 },
          { cultivar: 'Lifter', quantityKg: 300, pricePerKg: 140, total: 42000 },
          { cultivar: 'Cherry Wine', quantityKg: 320, pricePerKg: 160, total: 51200 },
          { cultivar: 'Hawaiian Haze', quantityKg: 250, pricePerKg: 135, total: 33750 }
        ],
        totalKg: 1500,
        completedKg: 630,
        totalPrice: 221450,
        currency: 'USD',
        unit: 'kg',
        status: 'processing',
        pallets: [
          { id: 'P001', strains: [{ cultivar: 'Sour Lifter', weightKg: 250, pricePerKg: 150 }, { cultivar: 'Lifter', weightKg: 50, pricePerKg: 140 }], totalKg: 300, status: 'completed' },
          { id: 'P002', strains: [{ cultivar: 'Sour Lifter', weightKg: 280, pricePerKg: 150 }], totalKg: 280, status: 'completed' },
          { id: 'P003', strains: [{ cultivar: 'Cherry Wine', weightKg: 200, pricePerKg: 160 }, { cultivar: 'Lifter', weightKg: 120, pricePerKg: 140 }], totalKg: 320, status: 'processing' },
          { id: 'P004', strains: [{ cultivar: 'Hawaiian Haze', weightKg: 250, pricePerKg: 135 }], totalKg: 250, status: 'pending' },
          { id: 'P005', strains: [{ cultivar: 'Sour Lifter', weightKg: 100, pricePerKg: 150 }, { cultivar: 'Lifter', weightKg: 130, pricePerKg: 140 }, { cultivar: 'Cherry Wine', weightKg: 120, pricePerKg: 160 }], totalKg: 350, status: 'pending' }
        ],
        createdDate: '2025-12-15',
        dueDate: '2026-02-01',
        notes: 'International freight - EU documentation required'
      },
      {
        id: 'ORD-002',
        customerId: 'CUST-002',
        customer: 'Denver Distributors',
        address: { street: '456 Broadway', city: 'Denver', state: 'CO', zip: '80202', country: 'USA' },
        items: [
          { cultivar: 'Lifter', quantityKg: 100, pricePerKg: 140, total: 14000 },
          { cultivar: 'Suver Haze', quantityKg: 100, pricePerKg: 140, total: 14000 }
        ],
        totalKg: 200,
        completedKg: 200,
        totalPrice: 28000,
        currency: 'USD',
        unit: 'lbs',
        status: 'ready',
        pallets: [
          { id: 'P006', strains: [{ cultivar: 'Lifter', weightKg: 100, pricePerKg: 140 }, { cultivar: 'Suver Haze', weightKg: 100, pricePerKg: 140 }], totalKg: 200, status: 'completed' }
        ],
        createdDate: '2025-12-28',
        dueDate: '2026-01-10',
        notes: 'Domestic shipping'
      }
    ];
  }

  function loadDemoData() {
    customers = getDemoCustomers();
    cultivars = getDemoCultivars();
    pricing = getDemoPricing();
    orders = getDemoOrders();
    populateCustomerDropdown();
    renderOrders();
    updateStats();
  }

  function populateCustomerDropdown() {
    const select = document.getElementById('customerSelect');
    select.innerHTML = '<option value="">Select a customer...</option>';
    customers.forEach(customer => {
      const option = document.createElement('option');
      option.value = customer.id;
      option.textContent = customer.companyName;
      select.appendChild(option);
    });
  }

  window.handleCustomerChange = function() {};

  // Customer modal
  window.openNewCustomerModal = function() {
    document.getElementById('customerForm').reset();
    document.getElementById('customerModal').classList.add('open');
  };

  window.closeCustomerModal = function() {
    document.getElementById('customerModal').classList.remove('open');
  };

  window.saveCustomer = async function() {
    const companyName = document.getElementById('customerCompanyName').value.trim();
    const country = document.getElementById('customerCountry').value.trim();

    if (!companyName || !country) {
      showToast('Company name and country are required', 'error');
      return;
    }

    const customer = {
      id: 'CUST-' + String(customers.length + 1).padStart(3, '0'),
      companyName: companyName,
      contactName: document.getElementById('customerContactName').value.trim(),
      email: document.getElementById('customerEmail').value.trim(),
      address: {
        street: document.getElementById('customerStreet').value.trim(),
        city: document.getElementById('customerCity').value.trim(),
        state: document.getElementById('customerState').value.trim(),
        zip: document.getElementById('customerZip').value.trim(),
        country: country
      },
      phone: document.getElementById('customerPhone').value.trim()
    };

    try {
      const response = await fetch(`${API_URL}?action=saveCustomer`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(customer)
      });
      const result = await response.json();
      if (result.success || result.customer) {
        customers.push(customer);
        populateCustomerDropdown();
        document.getElementById('customerSelect').value = customer.id;
        closeCustomerModal();
        showToast('Customer added successfully', 'success');
      }
    } catch (error) {
      customers.push(customer);
      populateCustomerDropdown();
      document.getElementById('customerSelect').value = customer.id;
      closeCustomerModal();
      showToast('Customer added locally', 'warning');
    }
  };

  // Pallet management
  window.addPallet = function() {
    palletCounter++;
    const container = document.getElementById('palletsContainer');
    const palletDiv = document.createElement('div');
    palletDiv.className = 'pallet-card';
    palletDiv.id = `pallet-${palletCounter}`;
    palletDiv.innerHTML = `
      <div class="pallet-card-header">
        <h5>Pallet ${palletCounter}</h5>
        <button type="button" class="pallet-remove" onclick="removePallet(${palletCounter})">
          <i class="ph ph-trash"></i>
        </button>
      </div>
      <div id="pallet-${palletCounter}-strains"></div>
      <button type="button" class="btn btn-sm btn-secondary add-strain-btn" onclick="addStrain(${palletCounter})">
        <i class="ph ph-plus"></i> Add Cultivar
      </button>
      <div class="pallet-total">
        <span class="pallet-total-label">Pallet Total:</span>
        <span class="pallet-total-value" id="pallet-${palletCounter}-total">0 kg | $0.00</span>
      </div>
    `;
    container.appendChild(palletDiv);
    addStrain(palletCounter);
  };

  window.removePallet = function(palletId) {
    const el = document.getElementById(`pallet-${palletId}`);
    if (el) {
      el.classList.add('removing');
      setTimeout(() => {
        el.remove();
        recalculateOrderTotals();
      }, 300);
    }
  };

  window.addStrain = function(palletId) {
    strainCounter++;
    const container = document.getElementById(`pallet-${palletId}-strains`);
    const strainDiv = document.createElement('div');
    strainDiv.className = 'strain-row';
    strainDiv.id = `strain-${strainCounter}`;
    strainDiv.innerHTML = `
      <select class="strain-cultivar" onchange="handleStrainChange(${strainCounter}, ${palletId})">
        <option value="">Select cultivar...</option>
        ${cultivars.map(c => `<option value="${c}">${c}</option>`).join('')}
      </select>
      <input type="number" class="strain-weight" placeholder="Weight (${currentUnit})" step="0.1" min="0" onchange="recalculatePalletTotal(${palletId})">
      <input type="number" class="strain-price" placeholder="$/kg" step="0.01" min="0" onchange="recalculatePalletTotal(${palletId})">
      <button type="button" class="strain-remove" onclick="removeStrain(${strainCounter}, ${palletId})">
        <i class="ph ph-x"></i>
      </button>
    `;
    container.appendChild(strainDiv);
  };

  window.removeStrain = function(strainId, palletId) {
    const el = document.getElementById(`strain-${strainId}`);
    if (el) {
      el.classList.add('removing');
      setTimeout(() => {
        el.remove();
        recalculatePalletTotal(palletId);
      }, 300);
    }
  };

  window.handleStrainChange = function(strainId, palletId) {
    const strainEl = document.getElementById(`strain-${strainId}`);
    const cultivar = strainEl.querySelector('.strain-cultivar').value;
    const priceInput = strainEl.querySelector('.strain-price');

    if (cultivar && pricing[cultivar]) {
      priceInput.value = pricing[cultivar];
    }

    recalculatePalletTotal(palletId);
  };

  window.recalculatePalletTotal = function(palletId) {
    const palletEl = document.getElementById(`pallet-${palletId}`);
    if (!palletEl) return;

    const strainRows = palletEl.querySelectorAll('.strain-row');
    let totalKg = 0;
    let totalPrice = 0;

    strainRows.forEach(row => {
      let weightInput = parseFloat(row.querySelector('.strain-weight').value) || 0;
      // Convert to kg if currently in lbs
      if (currentUnit === 'lbs') {
        weightInput = weightInput / LBS_PER_KG;
      }
      const price = parseFloat(row.querySelector('.strain-price').value) || 0;
      totalKg += weightInput;
      totalPrice += weightInput * price;
    });

    const totalEl = document.getElementById(`pallet-${palletId}-total`);
    totalEl.classList.add('updating');
    totalEl.textContent = `${formatWeight(totalKg)} | $${totalPrice.toFixed(2)}`;
    setTimeout(() => totalEl.classList.remove('updating'), 400);

    recalculateOrderTotals();
  };

  window.recalculateOrderTotals = function() {
    const pallets = document.querySelectorAll('.pallet-card');
    let totalKg = 0;
    let totalPrice = 0;
    let totalPallets = pallets.length;

    pallets.forEach(pallet => {
      const strainRows = pallet.querySelectorAll('.strain-row');
      strainRows.forEach(row => {
        let weight = parseFloat(row.querySelector('.strain-weight').value) || 0;
        if (currentUnit === 'lbs') {
          weight = weight / LBS_PER_KG;
        }
        const price = parseFloat(row.querySelector('.strain-price').value) || 0;
        totalKg += weight;
        totalPrice += weight * price;
      });
    });

    const weightEl = document.getElementById('totalWeight');
    const palletsEl = document.getElementById('totalPallets');
    const priceEl = document.getElementById('totalPrice');

    [weightEl, palletsEl, priceEl].forEach(el => el.classList.add('updating'));

    weightEl.textContent = formatWeight(totalKg);
    palletsEl.textContent = totalPallets;
    priceEl.textContent = `$${totalPrice.toFixed(2)}`;

    setTimeout(() => {
      [weightEl, palletsEl, priceEl].forEach(el => el.classList.remove('updating'));
    }, 400);
  };

  // Render orders
  function renderOrders() {
    const container = document.getElementById('ordersTableContainer');
    if (orders.length === 0) {
      renderEmptyState();
      return;
    }

    const filteredOrders = getFilteredOrders();

    container.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Total</th>
            <th>Progress</th>
            <th>Status</th>
            <th class="hide-mobile">Due Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${filteredOrders.map(order => `
            <tr>
              <td><strong>${order.id}</strong> <span style="font-size: 10px; color: var(--text-muted);">${order.unit || 'kg'}</span></td>
              <td>${order.customer}</td>
              <td>${formatWeight(order.totalKg, 1, order.unit)}</td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${getProgress(order)}%"></div>
                </div>
                <span style="font-size: 11px; color: var(--text-muted)">${getProgress(order)}%</span>
              </td>
              <td><span class="status status-${order.status}">${formatStatus(order.status)}</span></td>
              <td class="hide-mobile">${formatDate(order.dueDate)}</td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="viewOrder('${order.id}')" title="View Details">
                  <i class="ph ph-eye"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="editOrder('${order.id}')" title="Edit">
                  <i class="ph ph-pencil"></i>
                </button>
                <button class="btn btn-sm btn-secondary" onclick="copyCustomerLink('${order.id}')" title="Copy Link">
                  <i class="ph ph-link"></i>
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderEmptyState() {
    document.getElementById('ordersTableContainer').innerHTML = `
      <div class="empty-state">
        <i class="ph ph-package"></i>
        <h3>No Orders Yet</h3>
        <p>Create your first wholesale order to get started.</p>
        <button class="btn btn-primary" onclick="openNewOrderModal()">
          <i class="ph ph-plus"></i> Create Order
        </button>
      </div>
    `;
  }

  window.filterOrders = function() {
    renderOrders();
  };

  function getFilteredOrders() {
    const statusFilter = document.getElementById('filterStatus').value;
    const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

    return orders.filter(order => {
      const matchesStatus = !statusFilter || order.status === statusFilter;
      const matchesSearch = !searchFilter || order.customer.toLowerCase().includes(searchFilter);
      return matchesStatus && matchesSearch;
    });
  }

  function updateStats() {
    const active = orders.filter(o => !['completed', 'shipped'].includes(o.status));
    const pending = orders.filter(o => o.status === 'pending');
    const processing = orders.filter(o => o.status === 'processing');
    const ready = orders.filter(o => o.status === 'ready');

    const statEls = [
      document.getElementById('statActiveOrders'),
      document.getElementById('statPendingKg'),
      document.getElementById('statProgressKg'),
      document.getElementById('statReadyKg')
    ];

    statEls.forEach(el => el.classList.add('updating'));

    document.getElementById('statActiveOrders').textContent = active.length;
    document.getElementById('statPendingKg').textContent = formatWeight(pending.reduce((sum, o) => sum + o.totalKg, 0), 0);
    document.getElementById('statProgressKg').textContent = formatWeight(processing.reduce((sum, o) => sum + (o.totalKg - (o.completedKg || 0)), 0), 0);
    document.getElementById('statReadyKg').textContent = formatWeight(ready.reduce((sum, o) => sum + o.totalKg, 0), 0);

    setTimeout(() => {
      statEls.forEach(el => el.classList.remove('updating'));
    }, 400);
  }

  function getProgress(order) {
    if (!order.completedKg) return 0;
    return Math.round((order.completedKg / order.totalKg) * 100);
  }

  function formatStatus(status) {
    const labels = { pending: 'Pending', processing: 'Processing', ready: 'Ready to Ship', shipped: 'Shipped', completed: 'Completed' };
    return labels[status] || status;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  // Modal functions
  window.openNewOrderModal = function() {
    document.getElementById('modalTitle').textContent = 'New Order';
    document.getElementById('orderForm').reset();
    document.getElementById('orderId').value = '';
    document.getElementById('palletsContainer').innerHTML = '';
    palletCounter = 0;
    strainCounter = 0;
    addPallet();
    document.getElementById('orderModal').classList.add('open');
  };

  window.editOrder = function(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    // Set the form unit to match the order's native unit
    const orderUnit = order.unit || 'kg';
    if (currentUnit !== orderUnit) {
      setUnit(orderUnit);
    }

    document.getElementById('modalTitle').textContent = 'Edit Order';
    document.getElementById('orderId').value = order.id;
    document.getElementById('customerSelect').value = order.customerId || '';
    document.getElementById('orderStatus').value = order.status;
    document.getElementById('dueDate').value = order.dueDate || '';
    document.getElementById('orderNotes').value = order.notes || '';

    document.getElementById('palletsContainer').innerHTML = '';
    palletCounter = 0;
    strainCounter = 0;

    if (order.pallets && order.pallets.length > 0) {
      order.pallets.forEach((pallet, index) => {
        addPallet();
        const currentPalletId = palletCounter;
        const strainsContainer = document.getElementById(`pallet-${currentPalletId}-strains`);
        strainsContainer.innerHTML = '';

        pallet.strains.forEach(strain => {
          addStrain(currentPalletId);
          const currentStrainId = strainCounter;
          const strainEl = document.getElementById(`strain-${currentStrainId}`);
          strainEl.querySelector('.strain-cultivar').value = strain.cultivar;
          // Convert weight to order's unit for display
          strainEl.querySelector('.strain-weight').value = convertWeight(strain.weightKg, orderUnit).toFixed(1);
          strainEl.querySelector('.strain-price').value = strain.pricePerKg;
        });

        recalculatePalletTotal(currentPalletId);
      });
    } else {
      addPallet();
    }

    document.getElementById('orderModal').classList.add('open');
  };

  window.closeModal = function() {
    document.getElementById('orderModal').classList.remove('open');
  };

  window.saveOrder = async function() {
    const orderId = document.getElementById('orderId').value;
    const customerId = document.getElementById('customerSelect').value;
    const status = document.getElementById('orderStatus').value;
    const dueDate = document.getElementById('dueDate').value;
    const notes = document.getElementById('orderNotes').value.trim();

    if (!customerId) {
      showToast('Please select a customer', 'error');
      return;
    }

    const customer = customers.find(c => c.id === customerId);
    if (!customer) {
      showToast('Customer not found', 'error');
      return;
    }

    const pallets = [];
    const itemsMap = {};
    let totalKg = 0;
    let totalPrice = 0;
    let completedKg = 0;

    document.querySelectorAll('.pallet-card').forEach((palletEl, index) => {
      const strains = [];
      let palletTotalKg = 0;

      palletEl.querySelectorAll('.strain-row').forEach(strainEl => {
        const cultivar = strainEl.querySelector('.strain-cultivar').value;
        let weightKg = parseFloat(strainEl.querySelector('.strain-weight').value) || 0;

        // Convert to kg if input was in lbs
        if (currentUnit === 'lbs') {
          weightKg = weightKg / LBS_PER_KG;
        }

        const pricePerKg = parseFloat(strainEl.querySelector('.strain-price').value) || 0;

        if (cultivar && weightKg > 0) {
          strains.push({ cultivar, weightKg, pricePerKg });
          palletTotalKg += weightKg;

          if (!itemsMap[cultivar]) {
            itemsMap[cultivar] = { cultivar, quantityKg: 0, pricePerKg, total: 0 };
          }
          itemsMap[cultivar].quantityKg += weightKg;
          itemsMap[cultivar].total += weightKg * pricePerKg;

          totalKg += weightKg;
          totalPrice += weightKg * pricePerKg;
        }
      });

      if (strains.length > 0) {
        const palletStatus = orderId ?
          (orders.find(o => o.id === orderId)?.pallets?.[index]?.status || 'pending') :
          'pending';

        pallets.push({
          id: `P${String(index + 1).padStart(3, '0')}`,
          strains,
          totalKg: palletTotalKg,
          status: palletStatus
        });

        if (palletStatus === 'completed') {
          completedKg += palletTotalKg;
        }
      }
    });

    if (pallets.length === 0) {
      showToast('Please add at least one pallet with cultivars', 'error');
      return;
    }

    const items = Object.values(itemsMap);

    const order = {
      id: orderId || `ORD-${String(orders.length + 1).padStart(3, '0')}`,
      customerId: customer.id,
      customer: customer.companyName,
      address: customer.address,
      items,
      totalKg,
      completedKg,
      totalPrice,
      currency: 'USD',
      unit: currentUnit, // Save the unit this order was created/edited in
      status,
      pallets,
      documents: orderId ? orders.find(o => o.id === orderId)?.documents || [] : [],
      createdDate: orderId ? orders.find(o => o.id === orderId)?.createdDate : new Date().toISOString().split('T')[0],
      dueDate,
      notes
    };

    try {
      const response = await fetch(`${API_URL}?action=saveOrder`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(order)
      });
      const result = await response.json();

      if (result.success || result.order) {
        if (orderId) {
          const index = orders.findIndex(o => o.id === orderId);
          if (index >= 0) orders[index] = order;
        } else {
          orders.push(order);
        }
        showToast('Order saved successfully', 'success');
      }
    } catch (error) {
      if (orderId) {
        const index = orders.findIndex(o => o.id === orderId);
        if (index >= 0) orders[index] = order;
      } else {
        orders.push(order);
      }
      showToast('Order saved locally', 'warning');
    }

    closeModal();
    renderOrders();
    updateStats();
  };

  window.viewOrder = function(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    const progress = getProgress(order);
    const customerLink = `${window.location.origin}/rogue-origin-apps/order.html?id=${btoa(order.id)}`;

    document.getElementById('orderDetailContent').innerHTML = `
      <div class="order-detail">
        <div class="order-detail-header">
          <div>
            <div class="order-title">${order.customer}</div>
            <div class="order-meta">
              <span><i class="ph ph-hash"></i> ${order.id}</span>
              <span><i class="ph ph-calendar"></i> Created ${formatDate(order.createdDate)}</span>
              <span><i class="ph ph-clock"></i> Due ${formatDate(order.dueDate)}</span>
            </div>
          </div>
          <span class="status status-${order.status}">${formatStatus(order.status)}</span>
        </div>

        <div class="order-progress">
          <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <strong style="font-size: 24px;">${progress}% Complete</strong>
            <span style="color: var(--text-muted);">${formatWeight(order.completedKg || 0, 1, order.unit)} / ${formatWeight(order.totalKg, 1, order.unit)}</span>
          </div>
          <div class="order-progress-bar">
            <div class="order-progress-fill" style="width: ${progress}%"></div>
          </div>
          <div class="order-progress-stats">
            <span>Remaining: ${formatWeight(order.totalKg - (order.completedKg || 0), 1, order.unit)}</span>
            <span>${order.pallets?.filter(p => p.status === 'completed').length || 0} / ${order.pallets?.length || 0} pallets done</span>
          </div>
        </div>

        ${order.notes ? `<div style="margin-bottom: 20px; padding: 12px; background: var(--gold-dim); border-radius: 8px; font-size: 13px;"><strong>Notes:</strong> ${order.notes}</div>` : ''}

        <h4 style="margin-bottom: 12px;">Order Items (by Cultivar)</h4>
        <table style="margin-bottom: 24px;">
          <thead>
            <tr>
              <th>Cultivar</th>
              <th>Quantity</th>
              <th>Price/kg</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${(order.items || []).map(item => `
              <tr>
                <td><strong>${item.cultivar}</strong></td>
                <td>${formatWeight(item.quantityKg, 1, order.unit)}</td>
                <td>$${item.pricePerKg}/kg</td>
                <td>$${item.total.toFixed(2)}</td>
              </tr>
            `).join('')}
            <tr style="background: var(--gold-dim); font-weight: 700;">
              <td colspan="2">Total</td>
              <td>${formatWeight(order.totalKg, 1, order.unit)}</td>
              <td>$${order.totalPrice.toFixed(2)}</td>
            </tr>
          </tbody>
        </table>

        <h4 style="margin-bottom: 12px;">Pallets</h4>
        <table>
          <thead>
            <tr>
              <th>Pallet ID</th>
              <th>Cultivars</th>
              <th>Weight</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${(order.pallets || []).map(pallet => `
              <tr>
                <td><strong>${pallet.id}</strong></td>
                <td>${pallet.strains.map(s => s.cultivar).join(', ')}</td>
                <td>${formatWeight(pallet.totalKg, 1, order.unit)}</td>
                <td><span class="status status-${pallet.status}">${formatStatus(pallet.status)}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <div class="customer-link">
          <span><i class="ph ph-link"></i></span>
          <input type="text" value="${customerLink}" readonly id="customerLinkInput">
          <button class="btn btn-sm btn-primary" onclick="copyLink()">Copy Link</button>
        </div>
        <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Share this link with the customer to track their order.</p>
      </div>
    `;

    document.getElementById('detailModal').classList.add('open');
  };

  window.closeDetailModal = function() {
    document.getElementById('detailModal').classList.remove('open');
  };

  window.copyLink = function() {
    const input = document.getElementById('customerLinkInput');
    input.select();
    document.execCommand('copy');
    showToast('Link copied!', 'success');
  };

  window.copyCustomerLink = function(orderId) {
    const customerLink = `${window.location.origin}/rogue-origin-apps/order.html?id=${btoa(orderId)}`;
    navigator.clipboard.writeText(customerLink).then(() => {
      showToast('Link copied!', 'success');
    });
  };

})();
</script>
</body>
</html>
