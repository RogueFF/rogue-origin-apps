<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wholesale Orders - Rogue Origin</title>

  <!-- Fonts: DM Serif Display, JetBrains Mono, Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- jsPDF for document generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ========================================
       CSS VARIABLES - THEME SYSTEM
       ======================================== */
    :root {
      /* Typography */
      --font-display: 'DM Serif Display', serif;
      --font-mono: 'JetBrains Mono', monospace;
      --font-ui: 'Outfit', sans-serif;

      /* Brand Colors */
      --ro-green: #668971;
      --ro-gold: #e4aa4f;
      --success: #668971;
      --warning: #e4aa4f;
      --danger: #c45c4a;
      --info: #62758d;

      /* Light Theme (default) */
      --bg: #faf8f5;
      --bg-card: #ffffff;
      --glass: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(102,137,113,0.15);
      --border: rgba(102,137,113,0.2);
      --border-light: rgba(102,137,113,0.1);
      --text: #2d3a32;
      --text-secondary: #5a6b5f;
      --text-muted: #8a9a8e;

      /* Spacing */
      --space-xs: 8px;
      --space-sm: 16px;
      --space-md: 24px;
      --space-lg: 40px;

      /* Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;

      /* Shadows */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
      --shadow-elevated:
        0 2px 4px rgba(0, 0, 0, 0.04),
        0 8px 16px rgba(0, 0, 0, 0.08);
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --bg-card: #2d2d2d;
      --glass: rgba(45, 45, 45, 0.6);
      --glass-border: rgba(102,137,113,0.25);
      --border: rgba(102,137,113,0.3);
      --border-light: rgba(102,137,113,0.15);
      --text: #f0f0f0;
      --text-secondary: #b8b8b8;
      --text-muted: #888888;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.5);
    }

    /* ========================================
       RESET & BASE STYLES
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      position: relative;
      min-height: 100vh;
    }

    /* Hemp fiber pattern background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23668971' fill-opacity='0.12' fill-rule='evenodd'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.6;
      pointer-events: none;
      z-index: 0;
    }

    [data-theme="dark"] body::before {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23668971' fill-opacity='0.08' fill-rule='evenodd'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.35;
    }

    /* ========================================
       LAYOUT
       ======================================== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-md);
      position: relative;
      z-index: 1;
    }

    /* ========================================
       HEADER
       ======================================== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .header h1 {
      font-family: var(--font-display);
      font-size: 36px;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .header-actions {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }

    /* ========================================
       STATS BAR
       ======================================== */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-sm) var(--space-md);
      box-shadow: var(--shadow-sm);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .stat-value {
      font-family: var(--font-mono);
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
    }

    .stat-value.success { color: var(--success); }
    .stat-value.warning { color: var(--warning); }
    .stat-value.danger { color: var(--danger); }

    /* ========================================
       BUTTONS
       ======================================== */
    .btn {
      font-family: var(--font-ui);
      font-size: 14px;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--ro-green);
      color: white;
    }

    .btn-primary:hover {
      background: #4a6b54;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border-light);
    }

    .btn-gold {
      background: var(--ro-gold);
      color: white;
    }

    .btn-gold:hover {
      background: #d4993f;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .btn-icon:hover {
      background: var(--border-light);
      color: var(--text);
      transform: scale(1.1);
    }

    /* ========================================
       ORDERS TABLE
       ======================================== */
    .orders-table-container {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
    }

    .orders-table thead {
      background: var(--border-light);
    }

    .orders-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .orders-table td {
      padding: 16px;
      border-top: 1px solid var(--border-light);
      font-size: 14px;
    }

    .orders-table tbody tr {
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .orders-table tbody tr:hover {
      background: var(--border-light);
    }

    .order-id {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--ro-green);
    }

    .order-amount {
      font-family: var(--font-mono);
      font-weight: 600;
    }

    .order-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      text-transform: capitalize;
    }

    .order-status.pending {
      background: rgba(98, 117, 141, 0.15);
      color: var(--info);
    }

    .order-status.partial {
      background: rgba(228, 170, 79, 0.15);
      color: var(--warning);
    }

    .order-status.fulfilled {
      background: rgba(102, 137, 113, 0.15);
      color: var(--success);
    }

    /* Progress bar in table */
    .progress-cell {
      min-width: 120px;
    }

    .progress-mini {
      height: 6px;
      background: var(--border-light);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-mini-fill {
      height: 100%;
      background: var(--ro-green);
      transition: width 0.3s ease;
    }

    /* ========================================
       MODAL
       ======================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-large {
      max-width: 900px;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: var(--font-display);
      font-size: 24px;
      color: var(--text);
    }

    .modal-body {
      padding: var(--space-md);
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: var(--space-md);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }

    /* ========================================
       FORM ELEMENTS
       ======================================== */
    .form-group {
      margin-bottom: var(--space-sm);
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-family: var(--font-ui);
      font-size: 14px;
      background: var(--bg-card);
      color: var(--text);
      transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--ro-green);
      box-shadow: 0 0 0 3px rgba(102, 137, 113, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-sm);
    }

    /* ========================================
       DETAIL PANEL (Slide-in from right)
       ======================================== */
    .detail-panel {
      position: fixed;
      right: 0;
      top: 0;
      height: 100vh;
      width: 600px;
      background: var(--bg-card);
      box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }

    .detail-panel.active {
      transform: translateX(0);
    }

    .detail-panel-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-panel-title {
      font-family: var(--font-display);
      font-size: 24px;
    }

    .detail-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-md);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: var(--space-md);
    }

    .tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--ro-green);
      border-bottom-color: var(--ro-green);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Progress bars */
    .progress-row {
      margin-bottom: var(--space-md);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .progress-label-text {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .progress-label-value {
      font-family: var(--font-mono);
      color: var(--text);
      font-weight: 600;
    }

    .progress-bar {
      height: 12px;
      background: var(--border-light);
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--ro-green);
      transition: width 0.3s ease;
    }

    .progress-bar-fill.warning {
      background: var(--warning);
    }

    .progress-bar-fill.danger {
      background: var(--danger);
    }

    /* Lists */
    .list-item {
      padding: var(--space-sm);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      background: var(--bg);
    }

    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .list-item-title {
      font-weight: 600;
      font-family: var(--font-mono);
      color: var(--ro-green);
    }

    .list-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .list-item-body {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .empty-state {
      text-align: center;
      padding: var(--space-lg);
      color: var(--text-muted);
    }

    /* ========================================
       LINE ITEMS TABLE
       ======================================== */
    .line-items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--space-sm);
      font-size: 13px;
    }

    .line-items-table th {
      text-align: left;
      padding: 8px;
      background: var(--border-light);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .line-items-table td {
      padding: 8px;
      border-top: 1px solid var(--border-light);
    }

    .line-items-table input,
    .line-items-table select {
      padding: 6px 10px;
      font-size: 13px;
    }

    .line-item-remove {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 4px;
    }

    /* ========================================
       FINANCIAL SUMMARY
       ======================================== */
    .financial-summary {
      background: var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
      margin-top: var(--space-md);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
    }

    .summary-row.total {
      border-top: 2px solid var(--border);
      padding-top: 12px;
      margin-top: 8px;
      font-weight: 600;
      font-size: 16px;
    }

    .summary-label {
      color: var(--text-secondary);
    }

    .summary-value {
      font-family: var(--font-mono);
      color: var(--text);
    }

    /* ========================================
       THEME TOGGLE
       ======================================== */
    .theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--border-light);
    }

    /* ========================================
       TOAST NOTIFICATIONS
       ======================================== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      font-family: var(--font-ui);
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      min-width: 300px;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: all;
      animation: slideInRight 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .toast.success {
      border-left: 4px solid var(--ro-green);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--ro-gold);
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      color: var(--ro-green);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast.warning .toast-icon {
      color: var(--ro-gold);
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }

    .toast-close:hover {
      background: var(--border-light);
      color: var(--text);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.removing {
      animation: slideOutRight 0.3s ease forwards;
    }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .detail-panel {
        width: 100%;
      }

      .modal {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
      }

      .orders-table {
        font-size: 12px;
      }

      .orders-table th,
      .orders-table td {
        padding: 8px;
      }

      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
      }

      .toast {
        min-width: auto;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Notifications Container -->
  <div class="toast-container" id="toast-container"></div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Wholesale Orders</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openNewOrderModal()">
          <i class="ph ph-plus"></i> New Order
        </button>
        <button class="btn btn-secondary" onclick="openNewCustomerModal()">
          <i class="ph ph-user-plus"></i> New Customer
        </button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
          <i class="ph ph-moon" id="theme-icon"></i>
        </button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Total Commitment</div>
        <div class="stat-value" id="stat-commitment">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fulfilled</div>
        <div class="stat-value success" id="stat-fulfilled">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Paid</div>
        <div class="stat-value success" id="stat-paid">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Outstanding</div>
        <div class="stat-value warning" id="stat-outstanding">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Balance Due</div>
        <div class="stat-value danger" id="stat-balance">$0</div>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="orders-table-container">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Commitment</th>
            <th>Fulfilled</th>
            <th>Progress</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="orders-table-body">
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
              No orders yet. Create your first order above.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- New Customer Modal -->
  <div class="modal-overlay" id="customer-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">New Customer</div>
        <button class="icon-btn btn-secondary" onclick="closeCustomerModal()">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="customer-form">
          <div class="form-group">
            <label class="form-label">Company Name *</label>
            <input type="text" class="form-input" id="customer-company" required>
          </div>
          <div class="form-group">
            <label class="form-label">Contact Name *</label>
            <input type="text" class="form-input" id="customer-contact" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="customer-email">
            </div>
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" id="customer-phone">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Ship To Address</label>
            <textarea class="form-textarea" id="customer-ship-address" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Bill To Address (leave blank if same as Ship To)</label>
            <textarea class="form-textarea" id="customer-bill-address" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Country</label>
            <input type="text" class="form-input" id="customer-country" value="USA" list="countries-list" autocomplete="off">
            <datalist id="countries-list">
              <option value="USA">United States</option>
              <option value="Canada">Canada</option>
              <option value="Mexico">Mexico</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Germany">Germany</option>
              <option value="France">France</option>
              <option value="Italy">Italy</option>
              <option value="Spain">Spain</option>
              <option value="Netherlands">Netherlands</option>
              <option value="Belgium">Belgium</option>
              <option value="Switzerland">Switzerland</option>
              <option value="Austria">Austria</option>
              <option value="Japan">Japan</option>
              <option value="South Korea">South Korea</option>
              <option value="Australia">Australia</option>
              <option value="New Zealand">New Zealand</option>
            </datalist>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCustomerModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
      </div>
    </div>
  </div>

  <!-- New Master Order Modal -->
  <div class="modal-overlay" id="order-modal">
    <div class="modal modal-large">
      <div class="modal-header">
        <div class="modal-title">New Master Order</div>
        <button class="icon-btn btn-secondary" onclick="closeOrderModal()">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="order-form">
          <div class="form-group">
            <label class="form-label">Customer *</label>
            <select class="form-select" id="order-customer" required onchange="populateCustomerInfo()">
              <option value="">Select a customer...</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Commitment Amount * ($)</label>
              <input type="number" class="form-input" id="order-commitment" step="0.01" required>
            </div>
            <div class="form-group">
              <label class="form-label">Currency</label>
              <select class="form-select" id="order-currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">PO Number</label>
              <input type="text" class="form-input" id="order-po">
            </div>
            <div class="form-group">
              <label class="form-label">Terms</label>
              <select class="form-select" id="order-terms">
                <option value="DAP">DAP (Delivered at Place)</option>
                <option value="FOB">FOB (Free on Board)</option>
                <option value="EXW">EXW (Ex Works)</option>
              </select>
            </div>
          </div>

          <h4 style="margin: 24px 0 12px; font-family: var(--font-display);">Ship To</h4>
          <div class="form-group">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-input" id="order-ship-contact">
          </div>
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" class="form-input" id="order-ship-company">
          </div>
          <div class="form-group">
            <label class="form-label">Address</label>
            <textarea class="form-textarea" id="order-ship-address" rows="3"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" id="order-ship-phone">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="order-ship-email">
            </div>
          </div>

          <h4 style="margin: 24px 0 12px; font-family: var(--font-display);">Sold To</h4>
          <div style="margin-bottom: 12px;">
            <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="order-sold-same" onchange="copySoldToFromShipTo()">
              <span>Same as Ship To</span>
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">Contact Name</label>
            <input type="text" class="form-input" id="order-sold-contact">
          </div>
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" class="form-input" id="order-sold-company">
          </div>
          <div class="form-group">
            <label class="form-label">Address</label>
            <textarea class="form-textarea" id="order-sold-address" rows="3"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-input" id="order-sold-phone">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="order-sold-email">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="order-notes" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeOrderModal()">Cancel</button>
        <button class="btn btn-primary" id="order-submit-btn" onclick="saveMasterOrder()">Create Order</button>
      </div>
    </div>
  </div>

  <!-- Order Detail Panel -->
  <div class="detail-panel" id="detail-panel">
    <div class="detail-panel-header">
      <div>
        <div class="detail-panel-title" id="detail-order-id">MO-2026-001</div>
        <div style="font-size: 14px; color: var(--text-muted);" id="detail-customer-name">Company A</div>
      </div>
      <button class="icon-btn btn-secondary" onclick="closeDetailPanel()">
        <i class="ph ph-x"></i>
      </button>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('summary')">Summary</button>
      <button class="tab" onclick="switchTab('shipments')">Shipments</button>
      <button class="tab" onclick="switchTab('payments')">Payments</button>
      <button class="tab" onclick="switchTab('documents')">Documents</button>
    </div>

    <div class="detail-panel-body">
      <!-- Summary Tab -->
      <div class="tab-content active" id="tab-summary">
        <div class="progress-row">
          <div class="progress-label">
            <span class="progress-label-text">Commitment</span>
            <span class="progress-label-value" id="summary-commitment">$56,000</span>
          </div>
        </div>

        <div class="progress-row">
          <div class="progress-label">
            <span class="progress-label-text">Fulfilled</span>
            <span class="progress-label-value" id="summary-fulfilled">$0 (0%)</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="summary-fulfilled-bar" style="width: 0%"></div>
          </div>
        </div>

        <div class="progress-row">
          <div class="progress-label">
            <span class="progress-label-text">Paid</span>
            <span class="progress-label-value" id="summary-paid">$0 (0%)</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="summary-paid-bar" style="width: 0%"></div>
          </div>
        </div>

        <div class="financial-summary">
          <div class="summary-row">
            <span class="summary-label">Outstanding (Commitment - Fulfilled)</span>
            <span class="summary-value" id="summary-outstanding">$56,000</span>
          </div>
          <div class="summary-row total">
            <span class="summary-label">Balance Due (Fulfilled - Paid)</span>
            <span class="summary-value" id="summary-balance">$0</span>
          </div>
        </div>
      </div>

      <!-- Shipments Tab -->
      <div class="tab-content" id="tab-shipments">
        <button class="btn btn-primary btn-sm" style="margin-bottom: 16px;" onclick="openNewShipmentModal()">
          <i class="ph ph-plus"></i> Add Shipment
        </button>
        <div id="shipments-list">
          <div class="empty-state">No shipments yet</div>
        </div>
      </div>

      <!-- Payments Tab -->
      <div class="tab-content" id="tab-payments">
        <button class="btn btn-primary btn-sm" style="margin-bottom: 16px;" onclick="openNewPaymentModal()">
          <i class="ph ph-plus"></i> Add Payment
        </button>
        <div id="payments-list">
          <div class="empty-state">No payments yet</div>
        </div>
      </div>

      <!-- Documents Tab -->
      <div class="tab-content" id="tab-documents">
        <div class="empty-state">Documents will appear here after shipments are created</div>
      </div>
    </div>
  </div>

  <!-- Shipment Modal -->
  <div class="modal-overlay" id="shipment-modal">
    <div class="modal modal-large">
      <div class="modal-header">
        <div class="modal-title">New Shipment</div>
        <button class="icon-btn btn-secondary" onclick="closeShipmentModal()">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="shipment-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Shipment Date</label>
              <input type="date" class="form-input" id="shipment-date" required>
            </div>
            <div class="form-group">
              <label class="form-label">Carrier</label>
              <input type="text" class="form-input" id="shipment-carrier">
            </div>
          </div>

          <h4 style="margin: 20px 0 12px; font-family: var(--font-display);">Dimensions</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Length (in)</label>
              <input type="number" class="form-input" id="shipment-length" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Width (in)</label>
              <input type="number" class="form-input" id="shipment-width" step="0.1">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Height (in)</label>
              <input type="number" class="form-input" id="shipment-height" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Weight (kg)</label>
              <input type="number" class="form-input" id="shipment-weight" step="0.1">
            </div>
          </div>

          <h4 style="margin: 20px 0 12px; font-family: var(--font-display);">Line Items</h4>
          <table class="line-items-table" id="line-items-table">
            <thead>
              <tr>
                <th>Strain</th>
                <th>Type</th>
                <th>Qty (kg)</th>
                <th>$/Unit</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="line-items-body">
              <tr>
                <td>
                  <input type="text" class="form-input" placeholder="Type or select strain" list="strains-list">
                </td>
                <td>
                  <select class="form-select">
                    <option value="tops">Tops</option>
                    <option value="smalls">Smalls</option>
                  </select>
                </td>
                <td>
                  <input type="number" class="form-input" step="0.01" placeholder="5">
                </td>
                <td>
                  <input type="number" class="form-input" step="0.01" placeholder="350">
                </td>
                <td>
                  <span class="line-item-total">$0.00</span>
                </td>
                <td>
                  <button type="button" class="line-item-remove" onclick="removeLineItem(this)">
                    <i class="ph ph-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn btn-secondary btn-sm" onclick="addLineItem()">
            <i class="ph ph-plus"></i> Add Line Item
          </button>

          <div class="financial-summary">
            <div class="summary-row">
              <span class="summary-label">Subtotal</span>
              <span class="summary-value" id="shipment-subtotal">$0.00</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Discount</span>
              <input type="number" class="form-input" id="shipment-discount" step="0.01" value="0" style="width: 120px; text-align: right;" oninput="calculateShipmentTotal()">
            </div>
            <div class="summary-row">
              <span class="summary-label">Freight</span>
              <input type="number" class="form-input" id="shipment-freight" step="0.01" value="0" style="width: 120px; text-align: right;" oninput="calculateShipmentTotal()">
            </div>
            <div class="summary-row total">
              <span class="summary-label">Total</span>
              <span class="summary-value" id="shipment-total">$0.00</span>
            </div>
          </div>

          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label">Tracking Number</label>
            <input type="text" class="form-input" id="shipment-tracking">
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="shipment-notes" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeShipmentModal()">Cancel</button>
        <button class="btn btn-gold" onclick="saveShipmentAndGenerateDocs()">
          <i class="ph ph-file-pdf"></i> Save & Generate Docs
        </button>
        <button class="btn btn-primary" onclick="saveShipment()">Save Shipment</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal-overlay" id="payment-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Record Payment</div>
        <button class="icon-btn btn-secondary" onclick="closePaymentModal()">
          <i class="ph ph-x"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="payment-form">
          <div class="form-group">
            <label class="form-label">Amount * ($)</label>
            <input type="number" class="form-input" id="payment-amount" step="0.01" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Date *</label>
              <input type="date" class="form-input" id="payment-date" required>
            </div>
            <div class="form-group">
              <label class="form-label">Method</label>
              <select class="form-select" id="payment-method">
                <option value="Wire">Wire Transfer</option>
                <option value="Check">Check</option>
                <option value="ACH">ACH</option>
                <option value="Card">Credit Card</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Reference / Check Number</label>
            <input type="text" class="form-input" id="payment-reference">
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="payment-notes" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
        <button class="btn btn-primary" onclick="savePayment()">Record Payment</button>
      </div>
    </div>
  </div>

  <!-- Strains Datalist (dynamically populated) -->
  <datalist id="strains-list">
    <option value="Lifter">
    <option value="Cherry Wine">
    <option value="Bubba Kush">
    <option value="Hawaiian Haze">
    <option value="Elektra">
    <option value="Suver Haze">
    <option value="Sour Space Candy">
    <option value="Special Sauce">
  </datalist>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbxU5dBd5GU1RZeJ-UyNFf1Z8n3jCdIZ0VM6nXVj6_A7Pu2VbbxYWXMiDhkkgB3_8L9MyQ/exec';
    const isAppsScript = typeof google !== 'undefined' && google.script;

    // State
    let customers = [];
    let orders = [];
    let currentOrderID = null;
    let editingOrderID = null;

    // ========================================
    // INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      initTheme();
      setTodayDates();
      await loadInitialData();
    });

    function setTodayDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('shipment-date').value = today;
      document.getElementById('payment-date').value = today;
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('theme-icon');
      icon.className = theme === 'light' ? 'ph ph-moon' : 'ph ph-sun';
    }

    // ========================================
    // DATA LOADING
    // ========================================
    async function loadInitialData() {
      try {
        await Promise.all([
          loadCustomers(),
          loadOrders()
        ]);
        updateStats();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data. Check console for details.', 'error');
      }
    }

    async function loadCustomers() {
      const result = await apiCall('getCustomers');
      if (result.success) {
        customers = result.customers || [];
        populateCustomerDropdown();
      }
    }

    async function loadOrders() {
      const result = await apiCall('getMasterOrders');
      if (result.success) {
        orders = result.orders || [];
        renderOrdersTable();
      }
    }

    function populateCustomerDropdown() {
      const select = document.getElementById('order-customer');
      select.innerHTML = '<option value="">Select a customer...</option>';
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.companyName;
        option.dataset.customer = JSON.stringify(customer);
        select.appendChild(option);
      });
    }

    function populateCustomerInfo() {
      const select = document.getElementById('order-customer');
      const selected = select.options[select.selectedIndex];
      if (!selected || !selected.dataset.customer) return;

      const customer = JSON.parse(selected.dataset.customer);

      // Ship To
      document.getElementById('order-ship-contact').value = customer.contactName || '';
      document.getElementById('order-ship-company').value = customer.companyName || '';
      document.getElementById('order-ship-address').value = customer.shipToAddress || '';
      document.getElementById('order-ship-phone').value = customer.phone || '';
      document.getElementById('order-ship-email').value = customer.email || '';

      // Sold To (same as ship to initially)
      copySoldToFromShipTo();
    }

    function copySoldToFromShipTo() {
      if (document.getElementById('order-sold-same').checked) {
        document.getElementById('order-sold-contact').value = document.getElementById('order-ship-contact').value;
        document.getElementById('order-sold-company').value = document.getElementById('order-ship-company').value;
        document.getElementById('order-sold-address').value = document.getElementById('order-ship-address').value;
        document.getElementById('order-sold-phone').value = document.getElementById('order-ship-phone').value;
        document.getElementById('order-sold-email').value = document.getElementById('order-ship-email').value;
      }
    }

    // ========================================
    // ORDERS TABLE
    // ========================================
    function renderOrdersTable() {
      const tbody = document.getElementById('orders-table-body');

      if (orders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
              No orders yet. Create your first order above.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = orders.map(order => {
        const fulfillPct = order.commitmentAmount > 0
          ? Math.round((order.fulfilled || 0) / order.commitmentAmount * 100)
          : 0;

        return `
          <tr onclick="openDetailPanel('${order.id}')">
            <td class="order-id">${order.id}</td>
            <td>${order.customerName || 'Unknown'}</td>
            <td class="order-amount">$${formatNumber(order.commitmentAmount)}</td>
            <td class="order-amount">$${formatNumber(order.fulfilled || 0)}</td>
            <td class="progress-cell">
              ${fulfillPct}%
              <div class="progress-mini">
                <div class="progress-mini-fill" style="width: ${fulfillPct}%"></div>
              </div>
            </td>
            <td><span class="order-status ${order.status}">${order.status}</span></td>
            <td onclick="event.stopPropagation()" style="white-space: nowrap;">
              <button class="btn-icon" onclick="editOrder('${order.id}')" title="Edit Order">
                <i class="ph ph-pencil-simple"></i>
              </button>
              <button class="btn-icon" onclick="deleteOrder('${order.id}')" title="Delete Order" style="color: var(--danger);">
                <i class="ph ph-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ========================================
    // STATS
    // ========================================
    function updateStats() {
      let totalCommitment = 0;
      let totalFulfilled = 0;
      let totalPaid = 0;

      orders.forEach(order => {
        totalCommitment += order.commitmentAmount || 0;
        totalFulfilled += order.fulfilled || 0;
        totalPaid += order.paid || 0;
      });

      const outstanding = totalCommitment - totalFulfilled;
      const balance = totalFulfilled - totalPaid;

      document.getElementById('stat-commitment').textContent = '$' + formatNumber(totalCommitment);
      document.getElementById('stat-fulfilled').textContent = '$' + formatNumber(totalFulfilled);
      document.getElementById('stat-paid').textContent = '$' + formatNumber(totalPaid);
      document.getElementById('stat-outstanding').textContent = '$' + formatNumber(outstanding);
      document.getElementById('stat-balance').textContent = '$' + formatNumber(balance);
    }

    // ========================================
    // MODALS
    // ========================================
    function openNewCustomerModal() {
      document.getElementById('customer-form').reset();
      document.getElementById('customer-modal').classList.add('active');
    }

    function closeCustomerModal() {
      document.getElementById('customer-modal').classList.remove('active');
    }

    function openNewOrderModal() {
      editingOrderID = null;
      document.getElementById('order-form').reset();
      document.getElementById('order-currency').value = 'USD';
      document.getElementById('order-terms').value = 'DAP';
      document.getElementById('order-submit-btn').textContent = 'Create Order';
      document.getElementById('order-modal').classList.add('active');
    }

    function closeOrderModal() {
      document.getElementById('order-modal').classList.remove('active');
      editingOrderID = null;
    }

    function editOrder(orderID) {
      const order = orders.find(o => o.id === orderID);
      if (!order) return;

      editingOrderID = orderID;

      // Populate customer dropdown
      const customerSelect = document.getElementById('order-customer');
      for (let i = 0; i < customerSelect.options.length; i++) {
        const opt = customerSelect.options[i];
        if (opt.dataset.customer) {
          const cust = JSON.parse(opt.dataset.customer);
          if (cust.id === order.customerID) {
            customerSelect.selectedIndex = i;
            break;
          }
        }
      }

      // Populate form fields
      document.getElementById('order-commitment').value = order.commitmentAmount || '';
      document.getElementById('order-currency').value = order.currency || 'USD';
      document.getElementById('order-po').value = order.poNumber || '';
      document.getElementById('order-terms').value = order.terms || 'DAP';

      document.getElementById('order-ship-contact').value = order.shipTo_Contact || '';
      document.getElementById('order-ship-company').value = order.shipTo_Company || '';
      document.getElementById('order-ship-address').value = order.shipTo_Address || '';
      document.getElementById('order-ship-phone').value = order.shipTo_Phone || '';
      document.getElementById('order-ship-email').value = order.shipTo_Email || '';

      document.getElementById('order-sold-contact').value = order.soldTo_Contact || '';
      document.getElementById('order-sold-company').value = order.soldTo_Company || '';
      document.getElementById('order-sold-address').value = order.soldTo_Address || '';
      document.getElementById('order-sold-phone').value = order.soldTo_Phone || '';
      document.getElementById('order-sold-email').value = order.soldTo_Email || '';

      document.getElementById('order-notes').value = order.notes || '';

      // Update button text and open modal
      document.getElementById('order-submit-btn').textContent = 'Update Order';
      document.getElementById('order-modal').classList.add('active');
    }

    async function deleteOrder(orderID) {
      if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
        return;
      }

      const result = await apiCall('deleteMasterOrder', { orderID }, 'POST');
      if (result.success) {
        // Remove from local array instead of reloading everything
        orders = orders.filter(o => o.id !== orderID);
        renderOrdersTable();
        updateStats();
        // Close detail panel if it's open for this order
        if (currentOrderID === orderID) {
          closeDetailPanel();
        }
        showToast('Order deleted successfully!');
      } else {
        showToast('Error deleting order: ' + result.error, 'error');
      }
    }

    function openNewShipmentModal() {
      document.getElementById('shipment-form').reset();
      setTodayDates();
      // Clear editing state
      delete document.getElementById('shipment-modal').dataset.editingShipmentId;
      // Reset line items
      const tbody = document.getElementById('line-items-body');
      tbody.innerHTML = `
        <tr>
          <td><input type="text" class="form-input" placeholder="Lifter" list="strains-list"></td>
          <td>
            <select class="form-select">
              <option value="tops">Tops</option>
              <option value="smalls">Smalls</option>
            </select>
          </td>
          <td><input type="number" class="form-input" step="0.01" placeholder="5" oninput="calculateLineTotal(this)"></td>
          <td><input type="number" class="form-input" step="0.01" placeholder="350" oninput="calculateLineTotal(this)"></td>
          <td><span class="line-item-total">$0.00</span></td>
          <td>
            <button type="button" class="line-item-remove" onclick="removeLineItem(this)">
              <i class="ph ph-trash"></i>
            </button>
          </td>
        </tr>
      `;
      calculateShipmentTotal();
      document.getElementById('shipment-modal').classList.add('active');
    }

    function closeShipmentModal() {
      document.getElementById('shipment-modal').classList.remove('active');
      // Clear editing state
      delete document.getElementById('shipment-modal').dataset.editingShipmentId;
    }

    async function editShipment(shipmentId) {
      // Get shipment data
      const shipmentsResponse = await apiCall('getShipments', { orderID: currentOrderID });
      if (!shipmentsResponse || !shipmentsResponse.success) {
        showToast('Could not load shipment data', 'error');
        return;
      }

      const shipment = shipmentsResponse.shipments.find(s => s.id === shipmentId);
      if (!shipment) {
        showToast('Shipment not found', 'error');
        return;
      }

      // Populate form
      document.getElementById('shipment-date').value = shipment.shipmentDate ? shipment.shipmentDate.split('T')[0] : '';
      document.getElementById('shipment-carrier').value = shipment.carrier || '';
      document.getElementById('shipment-tracking').value = shipment.trackingNumber || '';
      document.getElementById('shipment-notes').value = shipment.notes || '';

      // Populate dimensions
      const dims = shipment.dimensions || {};
      document.getElementById('shipment-length').value = dims.length || '';
      document.getElementById('shipment-width').value = dims.width || '';
      document.getElementById('shipment-height').value = dims.height || '';
      document.getElementById('shipment-weight').value = dims.weight || '';

      // Populate line items
      const tbody = document.getElementById('line-items-body');
      const lineItems = shipment.lineItems || [];

      if (lineItems.length > 0) {
        tbody.innerHTML = lineItems.map(item => `
          <tr>
            <td><input type="text" class="form-input" value="${item.strain || ''}" placeholder="Strain name" list="strains-list"></td>
            <td>
              <select class="form-select">
                <option value="tops" ${item.type === 'tops' ? 'selected' : ''}>Tops</option>
                <option value="smalls" ${item.type === 'smalls' ? 'selected' : ''}>Smalls</option>
              </select>
            </td>
            <td><input type="number" class="form-input" step="0.01" value="${item.quantity || 0}" oninput="calculateLineTotal(this)"></td>
            <td><input type="number" class="form-input" step="0.01" value="${item.unitPrice || 0}" oninput="calculateLineTotal(this)"></td>
            <td><span class="line-item-total">$${formatNumber(item.quantity * item.unitPrice)}</span></td>
            <td>
              <button type="button" class="line-item-remove" onclick="removeLineItem(this)">
                <i class="ph ph-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      // Populate totals
      document.getElementById('shipment-discount').value = shipment.discount || 0;
      document.getElementById('shipment-freight').value = shipment.freightCost || 0;
      calculateShipmentTotal();

      // Store shipment ID for update
      document.getElementById('shipment-modal').dataset.editingShipmentId = shipmentId;

      // Open modal
      document.getElementById('shipment-modal').classList.add('active');
    }

    async function deleteShipment(shipmentId) {
      if (!confirm('Are you sure you want to delete this shipment? This action cannot be undone.')) {
        return;
      }

      const result = await apiCall('deleteShipment', { shipmentID: shipmentId }, 'POST');
      if (result.success) {
        // Refresh detail panel
        await openDetailPanel(currentOrderID);
        showToast('Shipment deleted successfully!');
      } else {
        showToast('Error deleting shipment: ' + result.error, 'error');
      }
    }

    function openNewPaymentModal() {
      document.getElementById('payment-form').reset();
      setTodayDates();
      document.getElementById('payment-modal').classList.add('active');
    }

    function closePaymentModal() {
      document.getElementById('payment-modal').classList.remove('active');
    }

    // ========================================
    // DETAIL PANEL
    // ========================================
    async function openDetailPanel(orderID) {
      currentOrderID = orderID;
      const order = orders.find(o => o.id === orderID);
      if (!order) return;

      // Update header
      document.getElementById('detail-order-id').textContent = order.id;
      document.getElementById('detail-customer-name').textContent = order.customerName;

      // Load financials
      const financials = await apiCall('getOrderFinancials', { orderID });
      if (financials.success) {
        updateSummaryTab(financials);

        // Update local orders array with latest financials
        const orderIndex = orders.findIndex(o => o.id === orderID);
        if (orderIndex !== -1) {
          orders[orderIndex].fulfilled = financials.fulfilled;
          orders[orderIndex].paid = financials.paid;
        }
        renderOrdersTable();
        updateStats();
      }

      // Load shipments
      const shipments = await apiCall('getShipments', { orderID });
      if (shipments.success) {
        renderShipments(shipments.shipments || []);
      }

      // Load payments
      const payments = await apiCall('getPayments', { orderID });
      if (payments.success) {
        renderPayments(payments.payments || []);
      }

      // Show panel
      document.getElementById('detail-panel').classList.add('active');
      switchTab('summary');
    }

    function closeDetailPanel() {
      document.getElementById('detail-panel').classList.remove('active');
      currentOrderID = null;
    }

    function switchTab(tabName) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');

      // Update content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    function updateSummaryTab(financials) {
      const { commitment, fulfilled, paid, outstanding, balance } = financials;
      const fulfillPct = commitment > 0 ? Math.round((fulfilled / commitment) * 100) : 0;
      const paidPct = fulfilled > 0 ? Math.round((paid / fulfilled) * 100) : 0;

      document.getElementById('summary-commitment').textContent = '$' + formatNumber(commitment);
      document.getElementById('summary-fulfilled').textContent = `$${formatNumber(fulfilled)} (${fulfillPct}%)`;
      document.getElementById('summary-fulfilled-bar').style.width = fulfillPct + '%';
      document.getElementById('summary-paid').textContent = `$${formatNumber(paid)} (${paidPct}%)`;
      document.getElementById('summary-paid-bar').style.width = paidPct + '%';
      document.getElementById('summary-outstanding').textContent = '$' + formatNumber(outstanding);
      document.getElementById('summary-balance').textContent = '$' + formatNumber(balance);
    }

    function renderShipments(shipments) {
      const container = document.getElementById('shipments-list');
      if (shipments.length === 0) {
        container.innerHTML = '<div class="empty-state">No shipments yet</div>';
        return;
      }

      container.innerHTML = shipments.map(shipment => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">${shipment.invoiceNumber}</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="list-item-meta">${formatDate(shipment.shipmentDate)}</span>
              <button class="btn-icon" onclick="editShipment('${shipment.id}')" title="Edit Shipment">
                <i class="ph ph-pencil-simple"></i>
              </button>
              <button class="btn-icon" onclick="deleteShipment('${shipment.id}')" title="Delete Shipment" style="color: var(--danger);">
                <i class="ph ph-trash"></i>
              </button>
            </div>
          </div>
          <div class="list-item-body">
            <strong>$${formatNumber(shipment.totalAmount)}</strong> 
            ${shipment.lineItems ? shipment.lineItems.length : 0} items 
            ${shipment.carrier || 'No carrier'}
          </div>
        </div>
      `).join('');
    }

    function renderPayments(payments) {
      const container = document.getElementById('payments-list');
      if (payments.length === 0) {
        container.innerHTML = '<div class="empty-state">No payments yet</div>';
        return;
      }

      container.innerHTML = payments.map(payment => `
        <div class="list-item">
          <div class="list-item-header">
            <span class="list-item-title">$${formatNumber(payment.amount)}</span>
            <span class="list-item-meta">${formatDate(payment.paymentDate)}</span>
          </div>
          <div class="list-item-body">
            ${payment.method}  ${payment.reference || 'No reference'}
          </div>
        </div>
      `).join('');
    }

    // ========================================
    // LINE ITEMS
    // ========================================
    function addLineItem() {
      const tbody = document.getElementById('line-items-body');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" class="form-input" placeholder="Strain name"></td>
        <td>
          <select class="form-select">
            <option value="tops">Tops</option>
            <option value="smalls">Smalls</option>
          </select>
        </td>
        <td><input type="number" class="form-input" step="0.01" placeholder="0" oninput="calculateLineTotal(this)"></td>
        <td><input type="number" class="form-input" step="0.01" placeholder="0" oninput="calculateLineTotal(this)"></td>
        <td><span class="line-item-total">$0.00</span></td>
        <td>
          <button type="button" class="line-item-remove" onclick="removeLineItem(this)">
            <i class="ph ph-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    }

    function removeLineItem(btn) {
      const tbody = btn.closest('tbody');
      if (tbody.children.length > 1) {
        btn.closest('tr').remove();
        calculateShipmentTotal();
      }
    }

    function calculateLineTotal(input) {
      const row = input.closest('tr');
      const qty = parseFloat(row.children[2].querySelector('input').value) || 0;
      const price = parseFloat(row.children[3].querySelector('input').value) || 0;
      const total = qty * price;
      row.children[4].querySelector('.line-item-total').textContent = '$' + formatNumber(total);
      calculateShipmentTotal();
    }

    function calculateShipmentTotal() {
      let subtotal = 0;
      document.querySelectorAll('.line-item-total').forEach(el => {
        subtotal += parseFloat(el.textContent.replace(/[$,]/g, '')) || 0;
      });

      const discount = parseFloat(document.getElementById('shipment-discount').value) || 0;
      const freight = parseFloat(document.getElementById('shipment-freight').value) || 0;
      const total = subtotal - discount + freight;

      document.getElementById('shipment-subtotal').textContent = '$' + formatNumber(subtotal);
      document.getElementById('shipment-total').textContent = '$' + formatNumber(total);
    }

    // ========================================
    // SAVE FUNCTIONS
    // ========================================
    async function saveCustomer() {
      const customerData = {
        companyName: document.getElementById('customer-company').value,
        contactName: document.getElementById('customer-contact').value,
        email: document.getElementById('customer-email').value,
        phone: document.getElementById('customer-phone').value,
        shipToAddress: document.getElementById('customer-ship-address').value,
        billToAddress: document.getElementById('customer-bill-address').value || document.getElementById('customer-ship-address').value,
        country: document.getElementById('customer-country').value
      };

      if (!customerData.companyName || !customerData.contactName) {
        showToast('Company Name and Contact Name are required', 'warning');
        return;
      }

      const result = await apiCall('saveCustomer', customerData, 'POST');
      if (result.success) {
        closeCustomerModal();
        await loadCustomers();
        showToast('Customer saved successfully!');
      } else {
        showToast('Error saving customer: ' + result.error, 'error');
      }
    }

    async function saveMasterOrder() {
      const select = document.getElementById('order-customer');
      const selectedCustomer = select.options[select.selectedIndex];

      if (!selectedCustomer || !selectedCustomer.dataset.customer) {
        showToast('Please select a customer', 'warning');
        return;
      }

      const customer = JSON.parse(selectedCustomer.dataset.customer);
      const orderData = {
        customerID: customer.id,
        customerName: customer.companyName,
        commitmentAmount: parseFloat(document.getElementById('order-commitment').value) || 0,
        currency: document.getElementById('order-currency').value,
        poNumber: document.getElementById('order-po').value,
        terms: document.getElementById('order-terms').value,
        shipTo_Contact: document.getElementById('order-ship-contact').value,
        shipTo_Company: document.getElementById('order-ship-company').value,
        shipTo_Address: document.getElementById('order-ship-address').value,
        shipTo_Phone: document.getElementById('order-ship-phone').value,
        shipTo_Email: document.getElementById('order-ship-email').value,
        soldTo_Contact: document.getElementById('order-sold-contact').value,
        soldTo_Company: document.getElementById('order-sold-company').value,
        soldTo_Address: document.getElementById('order-sold-address').value,
        soldTo_Phone: document.getElementById('order-sold-phone').value,
        soldTo_Email: document.getElementById('order-sold-email').value,
        notes: document.getElementById('order-notes').value
      };

      // If editing, add the order ID
      if (editingOrderID) {
        orderData.id = editingOrderID;
      } else {
        orderData.createdDate = new Date().toISOString();
      }

      if (orderData.commitmentAmount <= 0) {
        showToast('Commitment amount must be greater than 0', 'warning');
        return;
      }

      const result = await apiCall('saveMasterOrder', orderData, 'POST');
      if (result.success) {
        closeOrderModal();

        // Update local array instead of reloading everything
        if (editingOrderID) {
          const index = orders.findIndex(o => o.id === editingOrderID);
          if (index !== -1) {
            orders[index] = { ...orders[index], ...orderData };
          }
        } else {
          // Add new order to array
          const newOrder = { ...orderData, id: result.order.id, status: 'pending', fulfilled: 0, paid: 0 };
          orders.push(newOrder);
        }

        renderOrdersTable();
        updateStats();

        // Refresh detail panel if it's open for this order
        if (editingOrderID && currentOrderID === editingOrderID) {
          await openDetailPanel(editingOrderID);
        }
        showToast(editingOrderID ? 'Order updated successfully!' : 'Order created successfully!');
      } else {
        showToast('Error ' + (editingOrderID ? 'updating' : 'creating') + ' order: ' + result.error, 'error');
      }
    }

    async function saveShipment() {
      const lineItems = collectLineItems();
      if (lineItems.length === 0) {
        showToast('Please add at least one line item', 'warning');
        return false;
      }

      const dimensions = {
        length: parseFloat(document.getElementById('shipment-length').value) || 0,
        width: parseFloat(document.getElementById('shipment-width').value) || 0,
        height: parseFloat(document.getElementById('shipment-height').value) || 0,
        weight: parseFloat(document.getElementById('shipment-weight').value) || 0
      };

      const subtotal = parseFloat(document.getElementById('shipment-subtotal').textContent.replace(/[$,]/g, '')) || 0;
      const discount = parseFloat(document.getElementById('shipment-discount').value) || 0;
      const freight = parseFloat(document.getElementById('shipment-freight').value) || 0;
      const total = parseFloat(document.getElementById('shipment-total').textContent.replace(/[$,]/g, '')) || 0;

      const editingShipmentId = document.getElementById('shipment-modal').dataset.editingShipmentId;

      const shipmentData = {
        orderID: currentOrderID,
        shipmentDate: document.getElementById('shipment-date').value,
        carrier: document.getElementById('shipment-carrier').value,
        dimensions,
        lineItems,
        subTotal: subtotal,
        discount,
        freightCost: freight,
        totalAmount: total,
        trackingNumber: document.getElementById('shipment-tracking').value,
        notes: document.getElementById('shipment-notes').value
      };

      // If editing, include the shipment ID
      if (editingShipmentId) {
        shipmentData.id = editingShipmentId;
      }

      const result = await apiCall('saveShipment', shipmentData, 'POST');
      if (result.success) {
        closeShipmentModal();
        // Refresh detail panel (which will also update local orders array)
        await openDetailPanel(currentOrderID);
        showToast(editingShipmentId ? 'Shipment updated successfully!' : 'Shipment saved successfully!');
        return true;
      } else {
        showToast('Error saving shipment: ' + result.error, 'error');
        return false;
      }
    }

    async function savePayment() {
      const amount = parseFloat(document.getElementById('payment-amount').value);
      if (!amount || amount <= 0) {
        showToast('Please enter a valid payment amount', 'warning');
        return;
      }

      const paymentData = {
        orderID: currentOrderID,
        amount,
        paymentDate: document.getElementById('payment-date').value,
        method: document.getElementById('payment-method').value,
        reference: document.getElementById('payment-reference').value,
        notes: document.getElementById('payment-notes').value,
        recordedBy: 'User',
        recordedDate: new Date().toISOString()
      };

      const result = await apiCall('savePayment', paymentData, 'POST');
      if (result.success) {
        closePaymentModal();
        // Refresh detail panel (which will also update local orders array)
        await openDetailPanel(currentOrderID);
        showToast('Payment recorded successfully!');
      } else {
        showToast('Error recording payment: ' + result.error, 'error');
      }
    }

    function collectLineItems() {
      const rows = document.querySelectorAll('#line-items-body tr');
      const items = [];

      rows.forEach(row => {
        const strain = row.children[0].querySelector('input').value.trim();
        const type = row.children[1].querySelector('select').value;
        const qty = parseFloat(row.children[2].querySelector('input').value) || 0;
        const price = parseFloat(row.children[3].querySelector('input').value) || 0;

        if (strain && qty > 0 && price > 0) {
          items.push({
            strain,
            type,
            quantity: qty,
            unitPrice: price,
            totalValue: qty * price,
            countryOfOrigin: 'USA'
          });
        }
      });

      return items;
    }

    function generateCommercialInvoice(shipment, order) {
      if (!shipment || !order) {
        throw new Error('Missing shipment or order data');
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Colors
      const gold = [228, 170, 79];
      const darkGreen = [74, 107, 84];
      const black = [0, 0, 0];
      const gray = [128, 128, 128];

      // Header - Commercial Invoice title
      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...black);
      doc.text('COMMERCIAL INVOICE', 20, 20);

      // Rogue Origin logo placeholder (gold box)
      doc.setFillColor(...gold);
      doc.rect(160, 15, 35, 10, 'F');
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255);
      doc.text('ROGUE ORIGIN', 162, 21);

      // From Section
      doc.setFontSize(9);
      doc.setTextColor(...black);
      doc.setFont('helvetica', 'bold');
      doc.text('FROM:', 20, 35);
      doc.setFont('helvetica', 'normal');
      doc.text('Jacob Fisher', 20, 40);
      doc.text('Rogue Origin', 20, 45);
      doc.text('13003 Hwy 62', 20, 50);
      doc.text('Eagle Point, Oregon 97524', 20, 55);
      doc.text('United States', 20, 60);
      doc.text('Jacob@RogueOrigin.com', 20, 65);

      // Metadata Section
      const metaX = 120;
      let metaY = 35;
      doc.setFont('helvetica', 'bold');
      doc.text('Waybill #:', metaX, metaY);
      doc.setFont('helvetica', 'normal');
      doc.text(shipment.trackingNumber || 'N/A', metaX + 25, metaY);
      metaY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Date:', metaX, metaY);
      doc.setFont('helvetica', 'normal');
      doc.text(new Date(shipment.shipmentDate).toLocaleDateString('en-US'), metaX + 25, metaY);
      metaY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Invoice #:', metaX, metaY);
      doc.setFont('helvetica', 'normal');
      doc.text(shipment.invoiceNumber || 'N/A', metaX + 25, metaY);
      metaY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('PO #:', metaX, metaY);
      doc.setFont('helvetica', 'normal');
      doc.text(order.poNumber || 'N/A', metaX + 25, metaY);
      metaY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Terms:', metaX, metaY);
      doc.setFont('helvetica', 'normal');
      doc.text(order.terms || 'DAP', metaX + 25, metaY);
      metaY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Reason:', metaX, metaY);
      doc.setFont('helvetica', 'normal');
      doc.text('Sold', metaX + 25, metaY);

      // Ship To / Sold To boxes
      const boxY = 75;
      const boxHeight = 30;

      // Ship To box
      doc.setDrawColor(200);
      doc.rect(20, boxY, 85, boxHeight);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.text('SHIP TO:', 22, boxY + 5);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(order.shipTo_Contact || '', 22, boxY + 10);
      doc.text(order.shipTo_Company || '', 22, boxY + 14);
      const shipAddressLines = (order.shipTo_Address || '').split('\n');
      shipAddressLines.forEach((line, i) => {
        doc.text(line, 22, boxY + 18 + (i * 4));
      });

      // Sold To box
      doc.rect(110, boxY, 85, boxHeight);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.text('SOLD TO:', 112, boxY + 5);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(order.soldTo_Contact || '', 112, boxY + 10);
      doc.text(order.soldTo_Company || '', 112, boxY + 14);
      const soldAddressLines = (order.soldTo_Address || '').split('\n');
      soldAddressLines.forEach((line, i) => {
        doc.text(line, 112, boxY + 18 + (i * 4));
      });

      // Line Items Table
      const tableStartY = boxY + boxHeight + 10;
      const lineItems = shipment.lineItems || [];
      const tableData = lineItems.map(item => {
        const qty = item.quantity || 0;
        const unitPrice = item.unitPrice || 0;
        const total = qty * unitPrice;
        return [
          qty.toString(),
          'kg',
          `CBD Hemp Flower | ${item.strain}`,
          'US',
          qty.toFixed(2) + ' kg',
          '$' + unitPrice.toFixed(2),
          '$' + total.toFixed(2),
          order.currency || 'USD'
        ];
      });

      doc.autoTable({
        startY: tableStartY,
        head: [['Units', 'U/M', 'Description', 'C/O', 'Unit Weight', 'Unit Value', 'Total Value', 'Currency']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: darkGreen, fontSize: 8 },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
          0: { cellWidth: 15 },
          1: { cellWidth: 15 },
          2: { cellWidth: 60 },
          3: { cellWidth: 15 },
          4: { cellWidth: 20 },
          5: { cellWidth: 20 },
          6: { cellWidth: 20 },
          7: { cellWidth: 15 }
        }
      });

      // Financial Summary (right side)
      let summaryY = doc.lastAutoTable.finalY + 10;
      const summaryX = 140;
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text('Invoice Line Total:', summaryX, summaryY);
      doc.setFont('helvetica', 'normal');
      doc.text('$' + formatNumber(shipment.subTotal), 180, summaryY, { align: 'right' });
      summaryY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Discount:', summaryX, summaryY);
      doc.setFont('helvetica', 'normal');
      doc.text('$' + formatNumber(shipment.discount || 0), 180, summaryY, { align: 'right' });
      summaryY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Sub-Total:', summaryX, summaryY);
      doc.setFont('helvetica', 'normal');
      doc.text('$' + formatNumber(shipment.subTotal - (shipment.discount || 0)), 180, summaryY, { align: 'right' });
      summaryY += 5;
      doc.setFont('helvetica', 'bold');
      doc.text('Freight:', summaryX, summaryY);
      doc.setFont('helvetica', 'normal');
      doc.text('$' + formatNumber(shipment.freightCost || 0), 180, summaryY, { align: 'right' });
      summaryY += 5;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.text('TOTAL INVOICE AMOUNT:', summaryX, summaryY);
      doc.setFont('helvetica', 'bold');
      doc.text('$' + formatNumber(shipment.totalAmount), 180, summaryY, { align: 'right' });
      summaryY += 7;
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.text('Package Count: ' + lineItems.length, summaryX, summaryY);
      summaryY += 5;
      const totalWeight = lineItems.reduce((sum, item) => sum + (item.quantity || 0), 0);
      doc.text('Total Weight: ' + totalWeight.toFixed(2) + ' kg', summaryX, summaryY);

      // Declaration (left side)
      const declarationY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(8);
      doc.setFont('helvetica', 'italic');
      doc.text('I declare that all information contained in this invoice is true and correct.', 20, declarationY);
      doc.setFont('helvetica', 'normal');
      doc.text('Date: ' + new Date().toLocaleDateString('en-US'), 20, declarationY + 10);
      doc.text('Shipper: Jacob Fisher', 20, declarationY + 15);
      doc.text('Signature: ___________________', 20, declarationY + 20);

      // Save
      doc.save(`Commercial_Invoice_${shipment.invoiceNumber}.pdf`);
    }

    function generateBillOfLading(shipment, order) {
      if (!shipment || !order) {
        throw new Error('Missing shipment or order data');
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const gold = [228, 170, 79];
      const darkGreen = [74, 107, 84];

      // Header
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('BILL OF LADING', 20, 20);

      // BOL Number and Date
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('BOL #: ' + (shipment.id || 'N/A'), 20, 30);
      doc.text('Date: ' + new Date(shipment.shipmentDate).toLocaleDateString('en-US'), 20, 35);

      // Shipper
      doc.setFont('helvetica', 'bold');
      doc.text('SHIPPER:', 20, 45);
      doc.setFont('helvetica', 'normal');
      doc.text('Rogue Origin', 20, 50);
      doc.text('13003 Hwy 62', 20, 55);
      doc.text('Eagle Point, Oregon 97524', 20, 60);
      doc.text('Jacob@RogueOrigin.com', 20, 65);

      // Consignee
      doc.setFont('helvetica', 'bold');
      doc.text('CONSIGNEE:', 110, 45);
      doc.setFont('helvetica', 'normal');
      doc.text(order.shipTo_Company || '', 110, 50);
      doc.text(order.shipTo_Contact || '', 110, 55);
      doc.text(order.shipTo_Address || '', 110, 60);

      // Carrier Info
      doc.setFont('helvetica', 'bold');
      doc.text('CARRIER:', 20, 80);
      doc.setFont('helvetica', 'normal');
      doc.text(shipment.carrier || 'N/A', 20, 85);
      doc.setFont('helvetica', 'bold');
      doc.text('TRACKING #:', 110, 80);
      doc.setFont('helvetica', 'normal');
      doc.text(shipment.trackingNumber || 'N/A', 110, 85);

      // Commodity Description
      const lineItems = shipment.lineItems || [];
      const commodityY = 100;
      doc.setFont('helvetica', 'bold');
      doc.text('COMMODITY DESCRIPTION:', 20, commodityY);

      let itemY = commodityY + 7;
      lineItems.forEach(item => {
        doc.setFont('helvetica', 'normal');
        doc.text(`${item.quantity} kg CBD Hemp Flower - ${item.strain} (${item.type})`, 20, itemY);
        itemY += 5;
      });

      // Package Details
      const dims = shipment.dimensions || {};
      const packageY = itemY + 10;
      doc.setFont('helvetica', 'bold');
      doc.text('PACKAGE DETAILS:', 20, packageY);
      doc.setFont('helvetica', 'normal');
      doc.text(`Dimensions: ${dims.length || 0}" L x ${dims.width || 0}" W x ${dims.height || 0}" H`, 20, packageY + 7);
      doc.text(`Gross Weight: ${dims.weight || 0} kg`, 20, packageY + 14);
      doc.text(`Package Count: ${lineItems.length}`, 20, packageY + 21);

      // Shipper signature block
      const sigY = packageY + 40;
      doc.setFont('helvetica', 'bold');
      doc.text('SHIPPER SIGNATURE:', 20, sigY);
      doc.setFont('helvetica', 'normal');
      doc.text('_____________________________', 20, sigY + 10);
      doc.text('Date: _____________________', 20, sigY + 20);

      // Carrier signature block
      doc.setFont('helvetica', 'bold');
      doc.text('CARRIER SIGNATURE:', 110, sigY);
      doc.setFont('helvetica', 'normal');
      doc.text('_____________________________', 110, sigY + 10);
      doc.text('Date: _____________________', 110, sigY + 20);

      // Save
      doc.save(`BOL_${shipment.id || 'shipment'}.pdf`);
    }

    async function saveShipmentAndGenerateDocs() {
      const shipmentResult = await saveShipment();
      if (!shipmentResult) return; // Save failed

      // Get the current order
      const order = orders.find(o => o.id === currentOrderID);
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }

      // Get the latest shipment data (just saved)
      const shipmentsResponse = await apiCall('getShipments', { orderID: currentOrderID });
      if (!shipmentsResponse || !shipmentsResponse.success || !shipmentsResponse.shipments || shipmentsResponse.shipments.length === 0) {
        showToast('Could not load shipment data for PDF generation', 'error');
        return;
      }

      const latestShipment = shipmentsResponse.shipments[shipmentsResponse.shipments.length - 1];

      // Validate shipment data
      if (!latestShipment) {
        console.error('No shipment found in response:', shipmentsResponse);
        showToast('Shipment saved but could not retrieve for PDF generation', 'error');
        return;
      }

      console.log('Generating PDFs for shipment:', latestShipment);

      // Generate PDFs
      try {
        generateCommercialInvoice(latestShipment, order);
        generateBillOfLading(latestShipment, order);
        showToast('Shipment saved and documents generated successfully!');
      } catch (error) {
        console.error('PDF generation error:', error);
        console.error('Shipment data:', latestShipment);
        console.error('Order data:', order);
        showToast('Shipment saved but PDF generation failed: ' + error.message, 'error');
      }
    }

    // ========================================
    // API CALLS
    // ========================================
    async function apiCall(action, params = {}, method = 'GET') {
      if (isAppsScript) {
        // Apps Script mode
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)[action](params);
        });
      } else {
        // GitHub Pages mode
        if (method === 'GET') {
          const queryString = new URLSearchParams({ action, ...params }).toString();
          const response = await fetch(`${API_URL}?${queryString}`);
          return await response.json();
        } else {
          const response = await fetch(`${API_URL}?action=${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(params)
          });
          return await response.json();
        }
      }
    }

    // ========================================
    // UTILITIES
    // ========================================
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      // Icon based on type
      let icon = '';
      if (type === 'success') {
        icon = '<i class="ph ph-check-circle toast-icon"></i>';
      } else if (type === 'error') {
        icon = '<i class="ph ph-x-circle toast-icon"></i>';
      } else if (type === 'warning') {
        icon = '<i class="ph ph-warning-circle toast-icon"></i>';
      }

      toast.innerHTML = `
        ${icon}
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="ph ph-x"></i>
        </button>
      `;

      container.appendChild(toast);

      // Auto remove after 4 seconds
      setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    function formatNumber(num) {
      return parseFloat(num || 0).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
  </script>
</body>
</html>
