<!DOCTYPE html>
<html>
<head>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production Scoreboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    
    :root {
      /* Rogue Origin Brand Colors */
      --gold: #e4aa4f;
      --gold-light: #f0cb60;
      --green: #668971;
      --green-bright: #7a9d87;
      --sungrown: #bf8e4e;
      --greenhouse: #8f9263;
      --indoor: #62758d;
      
      /* Status Colors */
      --status-green: #4ade80;
      --status-yellow: #fde047;
      --status-red: #f87171;
      --status-gray: #94a3b8;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', system-ui, sans-serif; overflow: hidden; }
    body { display: flex; transition: background 0.5s ease; }
    
    /* Dynamic Status Backgrounds - kept but refined */
    body.ahead { background: linear-gradient(145deg, #0d2818 0%, #1a4d2e 50%, #0d2818 100%); }
    body.on-target { background: linear-gradient(145deg, #2d2a0d 0%, #4d4a1a 50%, #2d2a0d 100%); }
    body.behind { background: linear-gradient(145deg, #2d0d0d 0%, #4d1a1a 50%, #2d0d0d 100%); }
    body.idle { background: linear-gradient(145deg, #1a1f16 0%, #2d3a2e 50%, #1a1f16 100%); }
    
    /* Vivid Timer-based Backgrounds */
    body.timer-green { background: linear-gradient(145deg, #052e16 0%, #14532d 50%, #052e16 100%); }
    body.timer-yellow { background: linear-gradient(145deg, #422006 0%, #713f12 50%, #422006 100%); }
    body.timer-red { background: linear-gradient(145deg, #450a0a 0%, #7f1d1d 50%, #450a0a 100%); animation: redBackgroundPulse 1.5s ease-in-out infinite; }
    body.timer-neutral { background: linear-gradient(145deg, #1a1f16 0%, #2d3a2e 50%, #1a1f16 100%); }
    
    @keyframes redBackgroundPulse { 
      0%, 100% { background: linear-gradient(145deg, #450a0a 0%, #7f1d1d 50%, #450a0a 100%); } 
      50% { background: linear-gradient(145deg, #5c1010 0%, #991b1b 50%, #5c1010 100%); } 
    }
    
    .main-panel { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 30px; height: 100vh; overflow: hidden; }
    
    .timer-panel { width: 380px; min-width: 380px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; border-left: 2px solid rgba(228,170,79,0.2); height: 100vh; transition: background 0.5s ease, width 0.4s ease, min-width 0.4s ease; position: relative; }
    .timer-panel.fullscreen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      width: 100vw; 
      min-width: 100vw; 
      height: 100vh; 
      border-left: none; 
      z-index: 100; 
    }
    body.timer-fullscreen .main-panel { display: none; }
    body.timer-fullscreen .time-display { right: 20px; z-index: 101; }
    body.timer-fullscreen .help-btn { right: 20px; z-index: 101; }
    body.timer-fullscreen .strain-display { z-index: 101; }
    body.timer-fullscreen .lang-toggle { z-index: 101; }
    
    /* Vivid Timer Panel Backgrounds */
    .timer-panel.green { background: linear-gradient(180deg, rgba(34, 197, 94, 0.5) 0%, rgba(22, 163, 74, 0.3) 100%); border-left-color: rgba(34, 197, 94, 0.5); box-shadow: inset 0 0 30px rgba(34, 197, 94, 0.2); }
    .timer-panel.yellow { background: linear-gradient(180deg, rgba(250, 204, 21, 0.5) 0%, rgba(234, 179, 8, 0.3) 100%); border-left-color: rgba(250, 204, 21, 0.5); box-shadow: inset 0 0 30px rgba(250, 204, 21, 0.2); }
    .timer-panel.red { background: linear-gradient(180deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.3) 100%); border-left-color: rgba(239, 68, 68, 0.5); box-shadow: inset 0 0 30px rgba(239, 68, 68, 0.2); }
    .timer-panel.neutral { background: rgba(0,0,0,0.4); }
    
    /* Drag Handle */
    .drag-handle { position: absolute; left: 0; top: 0; bottom: 0; width: 24px; cursor: ew-resize; display: flex; align-items: center; justify-content: center; opacity: 0.5; transition: opacity 0.2s, background 0.2s; z-index: 10; }
    .drag-handle:hover { opacity: 1; background: rgba(228,170,79,0.1); }
    .drag-handle::before { content: ''; width: 4px; height: 50px; background: rgba(228,170,79,0.4); border-radius: 2px; transition: background 0.2s; }
    .drag-handle:hover::before { background: var(--gold); }
    .timer-panel.fullscreen .drag-handle { left: auto; right: 0; border-left: 2px solid rgba(228,170,79,0.2); }
    .timer-panel.dragging { transition: none; }
    
    /* Expand hint arrow */
    .expand-hint { position: absolute; left: 6px; top: 50%; transform: translateY(-50%); color: rgba(228,170,79,0.6); font-size: 16px; pointer-events: none; transition: opacity 0.3s, left 0.3s, right 0.3s; z-index: 11; }
    .timer-panel.fullscreen .expand-hint { left: auto; right: 6px; }
    .drag-handle:hover ~ .expand-hint { opacity: 0; }
    
    /* Fullscreen timer enhancements */
    .timer-panel.fullscreen .timer-display { width: 300px; height: 300px; margin-bottom: 25px; }
    .timer-panel.fullscreen .timer-value { font-size: 72px; }
    .timer-panel.fullscreen .timer-header { font-size: 22px; margin-bottom: 25px; }
    .timer-panel.fullscreen .timer-target { font-size: 18px; margin-bottom: 25px; }
    .timer-panel.fullscreen .manual-btn { font-size: 22px; padding: 20px 40px; margin-bottom: 25px; }
    .timer-panel.fullscreen .timer-stats { flex-direction: row; gap: 20px; justify-content: center; }
    .timer-panel.fullscreen .timer-stat { padding: 14px 24px; }
    .timer-panel.fullscreen .timer-stat-label { font-size: 15px; }
    .timer-panel.fullscreen .timer-stat-value { font-size: 20px; }
    .timer-panel.fullscreen .timer-ring-bg, .timer-panel.fullscreen .timer-ring-progress { stroke-width: 14; }
    
    /* Debug Panel */
    .debug-panel { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); border: 2px solid var(--gold); border-radius: 16px; padding: 16px 20px; z-index: 2000; min-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .debug-panel.active { display: block; }
    .debug-header { display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: 700; color: var(--gold); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(228,170,79,0.3); }
    .debug-close { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 18px; cursor: pointer; padding: 0 4px; }
    .debug-close:hover { color: #f87171; }
    .debug-controls { display: flex; flex-direction: column; gap: 10px; }
    .debug-label { font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
    .debug-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
    .debug-buttons button { padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .debug-buttons button:hover { background: rgba(228,170,79,0.3); border-color: var(--gold); }
    .debug-divider { height: 1px; background: rgba(228,170,79,0.2); margin: 8px 0; }
    .debug-reset { width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 8px; color: #f87171; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .debug-reset:hover { background: rgba(239, 68, 68, 0.3); }
    .debug-hint { margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.4); text-align: center; }
    .debug-hint kbd { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    .debug-indicator { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.9); color: white; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; z-index: 2001; }
    body.debug-active .debug-indicator { display: block; }
    .timer-panel.green { background: linear-gradient(180deg, rgba(102, 137, 113, 0.4) 0%, rgba(102, 137, 113, 0.2) 100%); }
    .timer-panel.yellow { background: linear-gradient(180deg, rgba(228, 170, 79, 0.4) 0%, rgba(228, 170, 79, 0.2) 100%); }
    .timer-panel.red { background: linear-gradient(180deg, rgba(239, 68, 68, 0.3) 0%, rgba(185, 28, 28, 0.2) 100%); }
    .timer-panel.neutral { background: rgba(0,0,0,0.4); }
    
    .scoreboard { text-align: center; width: 100%; max-width: 1400px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; }
    
    /* Status Badge - uses brand gold border */
    .status-badge { display: inline-flex; align-items: center; gap: 16px; padding: 12px 36px; border-radius: 60px; font-size: 28px; font-weight: 700; text-transform: uppercase; letter-spacing: 3px; }
    body.ahead .status-badge { background: rgba(102, 137, 113, 0.3); color: var(--status-green); border: 3px solid var(--status-green); }
    body.on-target .status-badge { background: rgba(228, 170, 79, 0.3); color: var(--gold-light); border: 3px solid var(--gold); }
    body.behind .status-badge { background: rgba(239, 68, 68, 0.2); color: var(--status-red); border: 3px solid var(--status-red); }
    body.idle .status-badge { background: rgba(148, 163, 184, 0.2); color: var(--status-gray); border: 3px solid var(--status-gray); }
    .status-icon { font-size: 32px; display: flex; align-items: center; justify-content: center; }
    
    /* Hour Cards - refined with brand accents */
    .hour-cards { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; }
    .hour-card { background: rgba(0,0,0,0.4); border-radius: 20px; padding: 16px 40px; min-width: 320px; border: 2px solid rgba(228,170,79,0.15); }
    .hour-card.last-hour { border: 3px solid rgba(228,170,79,0.3); }
    .hour-card.current-hour { border: 3px solid rgba(102, 137, 113, 0.6); background: rgba(102, 137, 113, 0.15); animation: currentHourPulse 2s ease-in-out infinite; }
    .hour-card-header { font-size: 14px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
    .hour-card.current-hour .hour-card-header { color: var(--green-bright); }
    .hour-card-timeslot { font-size: 16px; color: rgba(255,255,255,0.4); margin-bottom: 8px; }
    .lbs-row { display: flex; align-items: baseline; justify-content: center; gap: 10px; margin-bottom: 4px; }
    .actual-lbs { font-size: 72px; font-weight: 900; line-height: 1; color: #ffffff; text-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .hour-card.current-hour .actual-lbs { color: var(--green-bright); font-size: 60px; }
    .separator { font-size: 42px; font-weight: 300; color: rgba(255,255,255,0.4); }
    .target-lbs { font-size: 42px; font-weight: 700; color: rgba(255,255,255,0.5); }
    .lbs-unit { font-size: 16px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 2px; }
    .percentage-display { margin: 4px 0; }
    .percentage-value { font-size: 36px; font-weight: 900; }
    .hour-card.current-hour .percentage-value { color: var(--green-bright); }
    .percentage-label { font-size: 13px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; }
    
    /* Chart Container - brand styling */
    .chart-container {
      background: rgba(0,0,0,0.4);
      border-radius: 16px;
      padding: 14px 20px;
      margin: 0 auto;
      width: 100%;
      max-width: 850px;
      display: block;
      border: 1px solid rgba(228,170,79,0.15);
    }
    .chart-header {
      font-size: 12px;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
      text-align: left;
    }
    .chart-wrapper {
      height: 120px;
      position: relative;
    }
    
    /* Daily Progress - brand accent */
    .daily-progress { background: rgba(0,0,0,0.4); border-radius: 20px; padding: 16px 40px; display: inline-block; min-width: 520px; border: 2px solid rgba(228,170,79,0.2); }
    .daily-header { font-size: 13px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
    .daily-numbers { display: flex; align-items: baseline; justify-content: center; gap: 10px; margin-bottom: 8px; }
    .daily-actual { font-size: 48px; font-weight: 800; color: #fff; }
    .daily-sep { font-size: 32px; color: rgba(255,255,255,0.4); }
    .daily-target { font-size: 32px; font-weight: 600; color: rgba(255,255,255,0.5); }
    .daily-unit { font-size: 18px; color: rgba(255,255,255,0.5); margin-left: 6px; }
    .daily-delta { font-size: 22px; font-weight: 700; margin-left: 14px; padding: 5px 14px; border-radius: 20px; }
    .daily-delta.positive { background: rgba(102, 137, 113, 0.3); color: var(--status-green); }
    .daily-delta.negative { background: rgba(248, 113, 113, 0.2); color: var(--status-red); }
    .daily-delta.neutral { background: rgba(228, 170, 79, 0.2); color: var(--gold-light); }
    
    /* Progress Bar - brand colors */
    .progress-bar-container { display: flex; align-items: center; gap: 12px; }
    .progress-bar { flex: 1; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease; }
    body.ahead .progress-fill { background: var(--green); }
    body.on-target .progress-fill { background: var(--gold); }
    body.behind .progress-fill { background: var(--status-red); }
    body.idle .progress-fill { background: var(--status-gray); }
    .progress-hours { font-size: 16px; color: rgba(255,255,255,0.5); min-width: 70px; }
    
    .daily-projection { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(228,170,79,0.2); display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .projection-label { font-size: 13px; color: rgba(255,255,255,0.5); text-transform: uppercase; }
    .projection-value { font-size: 28px; font-weight: 800; color: #fff; }
    .projection-goal { font-size: 18px; color: rgba(255,255,255,0.5); }
    .projection-delta { font-size: 18px; font-weight: 700; padding: 4px 12px; border-radius: 12px; }
    .projection-delta.positive { background: rgba(102, 137, 113, 0.3); color: var(--status-green); }
    .projection-delta.negative { background: rgba(248, 113, 113, 0.2); color: var(--status-red); }
    .projection-delta.neutral { background: rgba(228, 170, 79, 0.2); color: var(--gold-light); }
    
    /* Comparison Pills - brand styling */
    .comparisons { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
    .comparison-pill { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(0,0,0,0.4); border-radius: 20px; font-size: 16px; font-weight: 600; border: 1px solid rgba(228,170,79,0.15); }
    .comparison-label { color: rgba(255,255,255,0.5); }
    .comparison-value { font-weight: 700; padding: 3px 8px; border-radius: 10px; }
    .comparison-value.positive { background: rgba(102, 137, 113, 0.3); color: var(--status-green); }
    .comparison-value.negative { background: rgba(248, 113, 113, 0.2); color: var(--status-red); }
    .comparison-value.neutral { background: rgba(228, 170, 79, 0.2); color: var(--gold-light); }
    .streak-pill { background: rgba(228, 170, 79, 0.2); border: 2px solid rgba(228, 170, 79, 0.4); }
    .streak-icon { font-size: 18px; }
    .streak-value { color: var(--gold); font-weight: 700; }
    
    /* Info Bar - brand styling */
    .info-bar { display: inline-flex; align-items: center; background: rgba(0,0,0,0.4); border-radius: 30px; padding: 8px 14px; gap: 6px; flex-wrap: wrap; justify-content: center; border: 1px solid rgba(228,170,79,0.15); }
    .info-section { display: flex; align-items: center; gap: 6px; padding: 6px 12px; color: rgba(255,255,255,0.8); font-size: 18px; font-weight: 600; }
    .info-divider { width: 2px; height: 28px; background: rgba(228,170,79,0.3); }
    .info-icon { font-size: 22px; }
    .stat-group { display: flex; flex-direction: column; align-items: center; padding: 0 12px; }
    .stat-group .label { font-size: 11px; color: var(--gold); text-transform: uppercase; }
    .stat-group .value { font-size: 22px; font-weight: 700; }
    
    /* Time/Strain Display - brand colors */
    .time-display { position: fixed; top: 20px; right: 420px; text-align: right; }
    .time-display .time { font-size: 42px; font-weight: 700; color: rgba(255,255,255,0.9); }
    .time-display .date { font-size: 16px; color: var(--gold); }
    .strain-display { position: fixed; top: 20px; left: 25px; }
    .strain-label { font-size: 12px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
    .strain-name { font-size: 28px; font-weight: 700; color: rgba(255,255,255,0.9); max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .strain-rate-indicator { margin-top: 3px; }
    
    /* Language Toggle - brand styling */
    .lang-toggle { position: fixed; bottom: 20px; left: 25px; display: flex; gap: 6px; }
    .lang-btn { padding: 6px 14px; border: 2px solid rgba(228,170,79,0.3); background: rgba(0,0,0,0.4); color: rgba(255,255,255,0.6); font-size: 14px; font-weight: 600; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
    .lang-btn:hover { border-color: var(--gold); }
    .lang-btn.active { background: var(--gold); border-color: var(--gold); color: #1a1f16; }
    
    /* Help Button - brand styling */
    .help-btn { position: fixed; bottom: 20px; right: 420px; width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.4); border: 2px solid rgba(228,170,79,0.3); color: var(--gold); font-size: 24px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    .help-btn:hover { background: var(--gold); border-color: var(--gold); color: #1a1f16; }
    
    /* Help Modal - brand styling */
    .help-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 40px; }
    .help-modal.active { display: flex; }
    .help-content { background: linear-gradient(145deg, #1a1f16 0%, #2d3a2e 100%); border-radius: 24px; padding: 40px; max-width: 900px; max-height: 85vh; overflow-y: auto; border: 2px solid var(--gold); }
    .help-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(228,170,79,0.3); }
    .help-title { font-size: 28px; font-weight: 700; color: #fff; }
    .help-close { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.3); border: 2px solid rgba(228,170,79,0.3); color: var(--gold); font-size: 22px; cursor: pointer; transition: all 0.2s; }
    .help-close:hover { background: rgba(248, 113, 113, 0.2); border-color: var(--status-red); color: var(--status-red); }
    .help-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .help-item { background: rgba(0,0,0,0.3); border-radius: 14px; padding: 18px; border: 1px solid rgba(228,170,79,0.1); }
    .help-item-title { font-size: 15px; font-weight: 700; color: var(--gold); margin-bottom: 6px; }
    .help-item-desc { font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.5; }
    .help-colors { display: flex; gap: 15px; margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; }
    .help-color { display: flex; align-items: center; gap: 6px; font-size: 14px; color: rgba(255,255,255,0.7); }
    .help-dot { width: 14px; height: 14px; border-radius: 50%; }
    .help-dot.green { background: var(--green); }
    .help-dot.yellow { background: var(--gold); }
    .help-dot.red { background: var(--status-red); }
    
    /* Timer Panel Elements - brand styling */
    .timer-header { font-size: 16px; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 15px; }
    .timer-display { position: relative; width: 220px; height: 220px; margin-bottom: 15px; }
    .timer-ring { width: 100%; height: 100%; transform: rotate(-90deg); }
    .timer-ring-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 12; }
    .timer-ring-progress { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.3s ease; }
    .timer-ring-progress.green { stroke: #22c55e; filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.6)); }
    .timer-ring-progress.yellow { stroke: #facc15; filter: drop-shadow(0 0 8px rgba(250, 204, 21, 0.6)); }
    .timer-ring-progress.red { stroke: #ef4444; filter: drop-shadow(0 0 12px rgba(239, 68, 68, 0.8)); }
    .timer-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .timer-value { font-size: 48px; font-weight: 900; color: #fff; line-height: 1; font-variant-numeric: tabular-nums; }
    .timer-value.green { color: #4ade80; text-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
    .timer-value.yellow { color: #fde047; text-shadow: 0 0 20px rgba(250, 204, 21, 0.5); }
    .timer-value.red { color: #f87171; text-shadow: 0 0 20px rgba(239, 68, 68, 0.5); animation: urgentPulse 0.8s ease-in-out infinite; }
    .timer-label { font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 6px; }
    .timer-target { font-size: 14px; color: rgba(255,255,255,0.4); margin-bottom: 15px; }
    .timer-target span { color: var(--gold); font-weight: 600; }
    
    /* Manual Button - vivid styling with state colors */
    .manual-btn { width: 100%; padding: 16px 24px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 16px; color: white; font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }
    .manual-btn:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5); }
    .manual-btn:active { transform: scale(0.98); }
    .manual-btn .icon { font-size: 22px; }
    .manual-btn.success { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); box-shadow: 0 4px 12px rgba(250, 204, 21, 0.4); color: #1a1f16; }
    .manual-btn.btn-green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }
    .manual-btn.btn-yellow { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); box-shadow: 0 4px 12px rgba(250, 204, 21, 0.4); color: #1a1f16; }
    .manual-btn.btn-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); animation: btnPulse 0.8s ease-in-out infinite; }
    .manual-btn.btn-neutral { background: linear-gradient(135deg, #64748b 0%, #475569 100%); box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4); }
    @keyframes btnPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    
    /* Cycle History */
    .cycle-history { width: 100%; max-width: 400px; margin-top: 10px; }
    .cycle-history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .cycle-history-title { font-size: 12px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
    .cycle-history-toggle { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
    .cycle-history-toggle:hover { background: rgba(255,255,255,0.1); color: var(--gold); }
    .cycle-list { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
    .cycle-list.collapsed { max-height: 0; overflow: hidden; }
    .cycle-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid; font-size: 13px; }
    .cycle-item.early { border-left-color: #22c55e; }
    .cycle-item.on-time { border-left-color: #facc15; }
    .cycle-item.overtime { border-left-color: #ef4444; }
    .cycle-item-num { color: rgba(255,255,255,0.5); min-width: 30px; }
    .cycle-item-time { color: #fff; font-weight: 600; font-variant-numeric: tabular-nums; }
    .cycle-item-delta { font-weight: 700; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
    .cycle-item-delta.early { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .cycle-item-delta.on-time { background: rgba(250, 204, 21, 0.2); color: #fde047; }
    .cycle-item-delta.overtime { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .timer-panel.fullscreen .cycle-history { max-width: 500px; }
    .timer-panel.fullscreen .cycle-list { max-height: 250px; }
    .timer-panel.fullscreen .cycle-item { padding: 10px 16px; font-size: 15px; }
    
    /* Celebration Animation */
    .celebration { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3000; }
    .confetti { position: absolute; width: 10px; height: 10px; opacity: 0; }
    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    .celebration-text { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; font-weight: 900; color: #4ade80; text-shadow: 0 0 30px rgba(34, 197, 94, 0.8); opacity: 0; animation: celebrateText 2s ease-out forwards; z-index: 3001; pointer-events: none; }
    @keyframes celebrateText {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      40% { transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
    }
    
    /* Timer Stats - brand styling */
    .timer-stats { width: 100%; display: flex; flex-direction: column; gap: 8px; }
    .timer-stat { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid rgba(228,170,79,0.1); }
    .timer-stat-label { font-size: 13px; color: var(--gold); }
    .timer-stat-value { font-size: 16px; font-weight: 700; color: rgba(255,255,255,0.9); }
    .timer-stat-value.positive { color: #4ade80; }
    .timer-stat-value.negative { color: #f87171; }
    
    /* Animations */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @keyframes urgentPulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.85; transform: scale(1.02); } }
    @keyframes currentHourPulse { 0%, 100% { border-color: rgba(102, 137, 113, 0.6); } 50% { border-color: rgba(102, 137, 113, 0.9); } }
    body.ahead .status-badge { animation: pulse 2s ease-in-out infinite; }
    body.behind .status-badge { animation: pulse 1.5s ease-in-out infinite; }
    .timer-display.overtime .timer-ring-progress { animation: overtimePulse 0.8s ease-in-out infinite; }
    .timer-display.overtime { animation: overtimeGlow 0.8s ease-in-out infinite; }
    @keyframes overtimePulse { 0%, 100% { opacity: 1; stroke-width: 12; } 50% { opacity: 0.7; stroke-width: 14; } }
    @keyframes overtimeGlow { 0%, 100% { filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.3)); } 50% { filter: drop-shadow(0 0 25px rgba(239, 68, 68, 0.6)); } }
    
    /* ============================================
       RESPONSIVE STYLES
       ============================================ */
    
    /* Large screens (< 1400px) - Slightly reduce sizes */
    @media (max-width: 1400px) {
      .timer-panel { width: 340px; min-width: 340px; padding: 20px; }
      .time-display { right: 380px; }
      .help-btn { right: 380px; }
      .actual-lbs { font-size: 60px; }
      .hour-card { padding: 14px 30px; min-width: 280px; }
      .daily-progress { min-width: 450px; padding: 14px 30px; }
      .daily-actual { font-size: 42px; }
      .strain-name { font-size: 24px; max-width: 300px; }
      .time-display .time { font-size: 36px; }
      .chart-container { max-width: 700px; }
    }
    
    /* Medium screens (< 1200px) - More compact */
    @media (max-width: 1200px) {
      .timer-panel { width: 300px; min-width: 300px; padding: 15px; }
      .time-display { right: 340px; }
      .help-btn { right: 340px; }
      .main-panel { padding: 15px 20px; }
      .scoreboard { gap: 10px; }
      .actual-lbs { font-size: 52px; }
      .hour-card.current-hour .actual-lbs { font-size: 48px; }
      .separator { font-size: 32px; }
      .target-lbs { font-size: 32px; }
      .hour-card { padding: 12px 24px; min-width: 250px; }
      .daily-progress { min-width: 400px; padding: 12px 24px; }
      .daily-actual { font-size: 36px; }
      .daily-target { font-size: 26px; }
      .projection-value { font-size: 24px; }
      .timer-display { width: 180px; height: 180px; }
      .timer-value { font-size: 40px; }
      .strain-name { font-size: 22px; max-width: 250px; }
      .time-display .time { font-size: 32px; }
      .info-section { font-size: 16px; padding: 4px 10px; }
      .stat-group .value { font-size: 18px; }
      .chart-container { max-width: 600px; }
      .chart-wrapper { height: 100px; }
    }
    
    /* Tablets / Small laptops (< 1024px) - Stack layout */
    @media (max-width: 1024px) {
      html, body { overflow: auto; height: auto; min-height: 100vh; }
      body { flex-direction: column; }
      .main-panel { height: auto; min-height: auto; padding: 80px 20px 20px; order: 1; }
      .timer-panel { width: 100%; min-width: 100%; height: auto; border-left: none; border-top: 2px solid rgba(228,170,79,0.2); padding: 20px; order: 2; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 20px; position: relative; }
      .timer-panel.fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; height: 100vh; flex-direction: column; flex-wrap: nowrap; z-index: 100; }
      body.timer-fullscreen { overflow: hidden; }
      body.timer-fullscreen .main-panel { display: none; }
      .drag-handle { width: 100%; height: 24px; top: 0; left: 0; right: 0; bottom: auto; cursor: ns-resize; }
      .drag-handle::before { width: 50px; height: 4px; }
      .timer-panel.fullscreen .drag-handle { top: auto; bottom: 0; }
      .expand-hint { top: 6px; left: 50%; transform: translateX(-50%); }
      .timer-panel.fullscreen .expand-hint { top: auto; bottom: 6px; left: 50%; right: auto; transform: translateX(-50%); }
      .time-display { right: 20px; top: 15px; }
      .help-btn { right: 20px; bottom: auto; top: 70px; }
      .strain-display { top: 15px; }
      .strain-name { font-size: 20px; max-width: 200px; }
      .time-display .time { font-size: 28px; }
      .timer-header { display: none; }
      .timer-panel.fullscreen .timer-header { display: block; }
      .timer-display { width: 160px; height: 160px; margin-bottom: 0; }
      .timer-value { font-size: 36px; }
      .timer-target { margin-bottom: 0; }
      .manual-btn { width: auto; padding: 14px 30px; margin-bottom: 0; }
      .timer-stats { width: auto; flex-direction: row; gap: 10px; }
      .timer-stat { padding: 8px 12px; }
      .hour-cards { gap: 15px; }
      .hour-card { min-width: 220px; padding: 12px 20px; }
      .actual-lbs { font-size: 48px; }
      .daily-progress { min-width: 350px; }
      .chart-container { max-width: 500px; }
      .cycle-history { max-width: 100%; order: 10; }
      .timer-panel.fullscreen .cycle-history { max-width: 500px; }
    }
    
    /* Small tablets (< 768px) */
    @media (max-width: 768px) {
      .main-panel { padding: 70px 15px 15px; }
      .scoreboard { gap: 8px; }
      .strain-display { left: 15px; }
      .strain-name { font-size: 16px; max-width: 150px; }
      .strain-label { font-size: 10px; }
      .time-display { right: 15px; }
      .time-display .time { font-size: 24px; }
      .time-display .date { font-size: 12px; }
      .hour-cards { gap: 10px; }
      .hour-card { min-width: 180px; padding: 10px 16px; border-radius: 14px; }
      .hour-card-header { font-size: 11px; letter-spacing: 1px; }
      .hour-card-timeslot { font-size: 12px; }
      .actual-lbs { font-size: 40px; }
      .hour-card.current-hour .actual-lbs { font-size: 36px; }
      .separator { font-size: 26px; }
      .target-lbs { font-size: 26px; }
      .lbs-unit { font-size: 12px; }
      .percentage-value { font-size: 28px; }
      .daily-progress { min-width: auto; width: 100%; max-width: 350px; padding: 12px 16px; }
      .daily-header { font-size: 11px; }
      .daily-actual { font-size: 32px; }
      .daily-target { font-size: 22px; }
      .daily-delta { font-size: 16px; padding: 4px 10px; }
      .projection-value { font-size: 22px; }
      .projection-goal { font-size: 14px; }
      .projection-delta { font-size: 14px; }
      .comparisons { gap: 8px; }
      .comparison-pill { padding: 6px 10px; font-size: 13px; }
      .info-bar { padding: 6px 10px; gap: 4px; }
      .info-section { font-size: 14px; padding: 4px 8px; gap: 4px; }
      .info-icon { font-size: 18px; }
      .info-divider { height: 20px; }
      .stat-group .label { font-size: 9px; }
      .stat-group .value { font-size: 16px; }
      .timer-panel { padding: 15px; gap: 15px; }
      .timer-display { width: 140px; height: 140px; }
      .timer-value { font-size: 32px; }
      .timer-target { font-size: 12px; }
      .manual-btn { padding: 12px 24px; font-size: 16px; }
      .timer-stats { gap: 8px; }
      .timer-stat { padding: 6px 10px; }
      .timer-stat-label { font-size: 11px; }
      .timer-stat-value { font-size: 14px; }
      .chart-container { max-width: 100%; padding: 10px 14px; }
      .chart-header { font-size: 10px; }
      .chart-wrapper { height: 80px; }
      .lang-toggle { left: 15px; bottom: 15px; }
      .lang-btn { padding: 4px 10px; font-size: 12px; }
      .help-btn { width: 36px; height: 36px; font-size: 18px; top: 60px; }
    }
    
    /* Mobile phones (< 480px) */
    @media (max-width: 480px) {
      .main-panel { padding: 60px 10px 10px; }
      .scoreboard { gap: 6px; }
      .strain-display { left: 10px; top: 10px; }
      .strain-name { font-size: 14px; max-width: 120px; }
      .time-display { right: 10px; top: 10px; }
      .time-display .time { font-size: 20px; }
      .hour-cards { flex-direction: column; align-items: center; gap: 8px; }
      .hour-card { width: 100%; max-width: 280px; min-width: auto; padding: 10px 14px; }
      .actual-lbs { font-size: 36px; }
      .hour-card.current-hour .actual-lbs { font-size: 32px; }
      .separator { font-size: 22px; }
      .target-lbs { font-size: 22px; }
      .percentage-value { font-size: 24px; }
      .daily-progress { padding: 10px 14px; }
      .daily-actual { font-size: 28px; }
      .daily-target { font-size: 20px; }
      .daily-delta { font-size: 14px; margin-left: 8px; }
      .progress-hours { font-size: 12px; min-width: 50px; }
      .daily-projection { gap: 6px; }
      .projection-label { font-size: 11px; }
      .projection-value { font-size: 20px; }
      .comparisons { flex-direction: column; align-items: center; }
      .info-bar { flex-direction: column; gap: 6px; padding: 8px; }
      .info-divider { width: 80%; height: 1px; }
      .info-section { width: 100%; justify-content: center; }
      .timer-panel { flex-direction: column; align-items: center; padding: 15px 10px; }
      .timer-display { width: 120px; height: 120px; }
      .timer-value { font-size: 28px; }
      .timer-stats { flex-direction: column; width: 100%; max-width: 280px; }
      .manual-btn { width: 100%; max-width: 280px; }
      .chart-container { display: none; } /* Hide chart on mobile */
      .help-btn { top: 50px; right: 10px; width: 32px; height: 32px; font-size: 16px; }
      .lang-toggle { left: 10px; bottom: 10px; }
      .lang-btn { padding: 3px 8px; font-size: 11px; }
      .help-content { padding: 20px; }
      .help-grid { grid-template-columns: 1fr; }
      .help-colors { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body class="idle timer-neutral">
  <div class="strain-display">
    <div class="strain-label" id="strainLabel">Line 1 ‚Ä¢ Current Strain</div>
    <div class="strain-name" id="strainName">‚Äî</div>
    <div class="strain-rate-indicator" id="strainRateIndicator"></div>
  </div>
  <div class="time-display">
    <div class="time" id="clock">--:--</div>
    <div class="date" id="date">Loading...</div>
  </div>
  <div class="lang-toggle">
    <button class="lang-btn active" id="btnEn" onclick="setLanguage('en')">EN</button>
    <button class="lang-btn" id="btnEs" onclick="setLanguage('es')">ES</button>
  </div>
  <button class="help-btn" onclick="toggleHelp()">?</button>
  
  <div class="help-modal" id="helpModal" onclick="if(event.target===this)toggleHelp()">
    <div class="help-content">
      <div class="help-header">
        <div class="help-title" id="helpTitle"><i class="ph-duotone ph-chart-pie-slice" style="margin-right:8px"></i> Understanding the Scoreboard</div>
        <button class="help-close" onclick="toggleHelp()">‚úï</button>
      </div>
      <div class="help-grid">
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-package" style="margin-right:6px"></i> Last Hour (Completed)</div>
          <div class="help-item-desc" id="helpLastHour">Production from the last completed hour. Target adjusts for breaks.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-timer" style="margin-right:6px"></i> Current Hour</div>
          <div class="help-item-desc" id="helpCurrentHour">Current crew count and target for the hour in progress.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title"><i class="ph-duotone ph-trend-up" style="margin-right:6px"></i> Today's Progress</div>
          <div class="help-item-desc" id="helpToday">Total so far vs target. "Up 5.2" = 5.2 lbs ahead of target.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">üîÆ End of Day</div>
          <div class="help-item-desc" id="helpProjection">Projected final output if you maintain current pace.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">üéØ Target Rate</div>
          <div class="help-item-desc" id="helpTarget">Expected lbs/trimmer/hr based on this strain's 30-day history.</div>
        </div>
        <div class="help-item">
          <div class="help-item-title">‚è≤ Bag Timer</div>
          <div class="help-item-desc" id="helpTimer">Time since last 5kg bag. Tracks pace between completions.</div>
        </div>
      </div>
      <div class="help-colors">
        <div class="help-color"><div class="help-dot green"></div><span id="helpGreen">Green = Ahead (105%+)</span></div>
        <div class="help-color"><div class="help-dot yellow"></div><span id="helpYellow">Yellow = On Target (90-105%)</span></div>
        <div class="help-color"><div class="help-dot red"></div><span id="helpRed">Red = Behind (&lt;90%)</span></div>
      </div>
    </div>
  </div>
  
  <div class="main-panel">
    <div class="scoreboard">
      <div class="status-badge">
        <span class="status-icon" id="statusIcon"><i class="ph-duotone ph-pause"></i></span>
        <span id="statusText">WAITING</span>
      </div>
      <div class="hour-cards">
        <div class="hour-card last-hour">
          <div class="hour-card-header" id="lastHourHeader">Last Hour</div>
          <div class="hour-card-timeslot" id="lastHourTimeslot">‚Äî</div>
          <div class="lbs-row">
            <span class="actual-lbs" id="lastHourLbs">‚Äî</span>
            <span class="separator">/</span>
            <span class="target-lbs" id="lastHourTarget">‚Äî</span>
          </div>
          <div class="lbs-unit" id="lbsUnit">lbs</div>
          <div class="percentage-display">
            <div class="percentage-value" id="lastHourPct">‚Äî%</div>
            <div class="percentage-label" id="ofTargetLabel">of target</div>
          </div>
        </div>
        <div class="hour-card current-hour" id="currentHourCard" style="display:none;">
          <div class="hour-card-header" id="currentHourHeader"><i class="ph-duotone ph-timer" style="margin-right:6px"></i> Current Hour</div>
          <div class="hour-card-timeslot" id="currentHourTimeslot">‚Äî</div>
          <div class="lbs-row">
            <span class="actual-lbs" id="currentHourTrimmers">‚Äî</span>
            <span class="lbs-unit" style="font-size:18px;margin-left:10px" id="trimmersSmallLabel">trimmers</span>
          </div>
          <div class="percentage-display">
            <div class="percentage-value" id="currentHourTargetLbs">‚Äî</div>
            <div class="percentage-label" id="lbsTargetLabel">lbs target</div>
          </div>
        </div>
      </div>
      
      <div class="daily-progress">
        <div class="daily-header" id="dailyHeader">Line 1 Today</div>
        <div class="daily-numbers">
          <span class="daily-actual" id="dailyActual">‚Äî</span>
          <span class="daily-sep">/</span>
          <span class="daily-target" id="dailyTarget">‚Äî</span>
          <span class="daily-unit">lbs</span>
          <span class="daily-delta" id="dailyDelta">‚Äî</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <span class="progress-hours" id="progressHours">0 hrs</span>
        </div>
        <div class="daily-projection">
          <span class="projection-label" id="projectionLabel">End of day:</span>
          <span class="projection-value" id="projectionValue">‚Äî</span>
          <span class="projection-goal" id="projectionGoal"></span>
          <span class="projection-delta" id="projectionDelta">‚Äî</span>
        </div>
      </div>
      <div class="comparisons">
        <div class="comparison-pill" id="vsYesterdayPill" style="display:none"><span class="comparison-label" id="vsYesterdayLabel">vs Yesterday</span><span class="comparison-value" id="vsYesterdayValue">‚Äî</span></div>
        <div class="comparison-pill" id="vs7DayPill" style="display:none"><span class="comparison-label" id="vs7DayLabel">vs 7-Day Avg</span><span class="comparison-value" id="vs7DayValue">‚Äî</span></div>
        <div class="comparison-pill streak-pill" id="streakPill" style="display:none"><span class="streak-icon"><i class="ph-duotone ph-fire"></i></span><span class="streak-value" id="streakValue">0</span><span class="comparison-label" id="streakLabel">hr streak</span></div>
      </div>
      <div class="info-bar">
        <div class="info-section"><span class="info-icon"><i class="ph-duotone ph-users-three"></i></span><span><span id="crewCount">‚Äî</span> <span id="trimmersLabel">Trimmers</span></span></div>
        <div class="info-divider"></div>
        <div class="info-section"><span class="info-icon"><i class="ph-duotone ph-crosshair"></i></span><span><span id="targetRateLabel">Target:</span> <span id="targetRate">‚Äî</span> lbs/hr</span></div>
        <div class="info-divider"></div>
        <div class="stat-group"><span class="label" id="avgTargetLabel">AVG</span><span class="value" id="avgPercentage">‚Äî</span></div>
        <div class="info-divider"></div>
        <div class="stat-group"><span class="label" id="bestHourLabel">BEST</span><span class="value" id="bestHour">‚Äî</span></div>
      </div>
      
      <!-- Hourly Rate Chart - Bottom -->
      <div class="chart-container" id="chartContainer" style="display:none;">
        <div class="chart-header" id="chartHeader">Hourly Performance (lbs/trimmer)</div>
        <div class="chart-wrapper">
          <canvas id="hourlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="timer-panel neutral" id="timerPanel">
    <div class="drag-handle" id="dragHandle"></div>
    <div class="expand-hint" id="expandHint">‚óÄ</div>
    <div class="timer-header" id="timerHeader">5KG Bag Timer</div>
    <div class="timer-display" id="timerDisplay">
      <svg class="timer-ring" viewBox="0 0 220 220">
        <circle class="timer-ring-bg" cx="110" cy="110" r="95"/>
        <circle class="timer-ring-progress green" id="timerRing" cx="110" cy="110" r="95" stroke-dasharray="597" stroke-dashoffset="0"/>
      </svg>
      <div class="timer-center">
        <div class="timer-value green" id="timerValue">--:--</div>
        <div class="timer-label" id="timerLabel">remaining</div>
      </div>
    </div>
    <div class="timer-target">Target: <span id="timerTargetTime">--:--</span> ‚Ä¢ <span id="timerTrimmers">0</span> trimmers</div>
    <button class="manual-btn" id="manualBtn" onclick="logManualEntry()"><span class="icon"><i class="ph-duotone ph-package"></i></span><span id="manualBtnText">5KG Bag Complete</span></button>
    <div class="timer-stats">
      <div class="timer-stat"><span class="timer-stat-label" id="bagsTodayLabel">Bags Today</span><span class="timer-stat-value" id="bagsToday">0</span></div>
      <div class="timer-stat"><span class="timer-stat-label" id="avgTodayLabel">Avg Today</span><span class="timer-stat-value" id="avgToday">--:--</span></div>
      <div class="timer-stat"><span class="timer-stat-label" id="vsTargetLabel">vs Target</span><span class="timer-stat-value" id="vsTarget">‚Äî</span></div>
    </div>
    
    <div class="cycle-history" id="cycleHistory">
      <div class="cycle-history-header">
        <span class="cycle-history-title" id="cycleHistoryTitle">Today's Cycles</span>
        <button class="cycle-history-toggle" id="cycleToggle" onclick="toggleCycleHistory()">Hide</button>
      </div>
      <div class="cycle-list" id="cycleList"></div>
    </div>
  </div>
  
  <!-- Celebration container -->
  <div class="celebration" id="celebration"></div>

  <!-- Debug Panel -->
  <div class="debug-indicator" id="debugIndicator">‚ö† Debug Mode Active</div>
  <div class="debug-panel" id="debugPanel">
    <div class="debug-header">üõ† Timer Debug <button class="debug-close" onclick="toggleDebug()">‚úï</button></div>
    <div class="debug-controls">
      <div class="debug-label">Timer State:</div>
      <div class="debug-buttons">
        <button onclick="setDebugState('green')">üü¢ Green</button>
        <button onclick="setDebugState('yellow')">üü° Yellow</button>
        <button onclick="setDebugState('red')">üî¥ Red/Overtime</button>
        <button onclick="setDebugState('neutral')">‚ö´ Neutral</button>
      </div>
      <div class="debug-label">Simulate Time:</div>
      <div class="debug-buttons">
        <button onclick="simulateTime(0)">Just Started</button>
        <button onclick="simulateTime(50)">50%</button>
        <button onclick="simulateTime(85)">85% (Yellow)</button>
        <button onclick="simulateTime(110)">110% (Overtime)</button>
      </div>
      <div class="debug-label">Break Status:</div>
      <div class="debug-buttons">
        <button onclick="simulateBreak(false)">Working</button>
        <button onclick="simulateBreak(true)">On Break</button>
      </div>
      <div class="debug-label">Test Celebration:</div>
      <div class="debug-buttons">
        <button onclick="addCycleToHistory(240, 300)">üéâ Early Finish</button>
        <button onclick="addCycleToHistory(295, 300)">‚úì On Time</button>
        <button onclick="addCycleToHistory(360, 300)">‚ö† Overtime</button>
      </div>
      <div class="debug-divider"></div>
      <button class="debug-reset" onclick="resetDebug()">‚Üª Reset to Live</button>
    </div>
    <div class="debug-hint">Press <kbd>D</kbd> to toggle this panel</div>
  </div>

  <script>
    let data=null,timerData=null,currentLang='en',lastBagTimestamp=null,hourlyChart=null;
    
    // Debug mode variables
    let debugMode = false;
    let debugState = null;
    let debugElapsedPercent = null;
    let debugOnBreak = null;
    
    // Cycle history
    let cycleHistory = [];
    let cycleHistoryCollapsed = false;
    
    // Sound effects using Web Audio API
    let audioContext = null;
    function playSuccessSound(isEarly) {
      try {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        const now = audioContext.currentTime;
        
        // Create oscillators for a pleasant chime
        const frequencies = isEarly ? [523.25, 659.25, 783.99, 1046.50] : [523.25, 659.25, 783.99]; // C5, E5, G5, (C6 for early)
        
        frequencies.forEach((freq, i) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.value = freq;
          osc.type = 'sine';
          
          const startTime = now + (i * 0.1);
          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
          
          osc.start(startTime);
          osc.stop(startTime + 0.6);
        });
        
        // Add a bonus flourish for early finish
        if (isEarly) {
          setTimeout(() => {
            [1318.51, 1567.98, 2093.00].forEach((freq, i) => { // E6, G6, C7
              const osc = audioContext.createOscillator();
              const gain = audioContext.createGain();
              osc.connect(gain);
              gain.connect(audioContext.destination);
              osc.frequency.value = freq;
              osc.type = 'sine';
              const startTime = audioContext.currentTime + (i * 0.08);
              gain.gain.setValueAtTime(0, startTime);
              gain.gain.linearRampToValueAtTime(0.2, startTime + 0.03);
              gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
              osc.start(startTime);
              osc.stop(startTime + 0.4);
            });
          }, 400);
        }
      } catch(e) { console.log('Audio not supported'); }
    }
    
    function toggleCycleHistory() {
      cycleHistoryCollapsed = !cycleHistoryCollapsed;
      const list = document.getElementById('cycleList');
      const toggle = document.getElementById('cycleToggle');
      list.classList.toggle('collapsed', cycleHistoryCollapsed);
      toggle.textContent = cycleHistoryCollapsed ? 'Show' : 'Hide';
    }
    
    function addCycleToHistory(cycleTimeSec, targetSec) {
      const delta = targetSec - cycleTimeSec;
      const deltaSec = Math.abs(delta);
      let status = 'on-time';
      if (delta > 10) status = 'early';
      else if (delta < -10) status = 'overtime';
      
      cycleHistory.unshift({
        num: cycleHistory.length + 1,
        time: cycleTimeSec,
        target: targetSec,
        delta: delta,
        status: status,
        timestamp: new Date()
      });
      
      renderCycleHistory();
      
      // Trigger celebration if early or on-time
      if (status === 'early' || status === 'on-time') {
        triggerCelebration(status === 'early');
      }
    }
    
    function renderCycleHistory() {
      const list = document.getElementById('cycleList');
      if (cycleHistory.length === 0) {
        list.innerHTML = `<div style="text-align:center;color:rgba(255,255,255,0.4);padding:10px;font-size:12px;">${t[currentLang].noBags}</div>`;
        return;
      }
      
      list.innerHTML = cycleHistory.map((c, i) => {
        const deltaSec = Math.abs(c.delta);
        const deltaMin = Math.floor(deltaSec / 60);
        const deltaSecs = deltaSec % 60;
        const deltaStr = deltaMin > 0 ? `${deltaMin}:${deltaSecs.toString().padStart(2,'0')}` : `${deltaSecs}s`;
        const sign = c.delta > 10 ? '-' : c.delta < -10 ? '+' : '¬±';
        const label = c.delta > 10 ? (currentLang === 'es' ? 'antes' : 'early') : c.delta < -10 ? (currentLang === 'es' ? 'tarde' : 'late') : '';
        
        return `<div class="cycle-item ${c.status}">
          <span class="cycle-item-num">#${cycleHistory.length - i}</span>
          <span class="cycle-item-time">${formatTime(c.time)}</span>
          <span class="cycle-item-delta ${c.status}">${sign}${deltaStr} ${label}</span>
        </div>`;
      }).join('');
    }
    
    function triggerCelebration(isEarly) {
      // Play sound
      playSuccessSound(isEarly);
      
      // Show celebration text
      const text = document.createElement('div');
      text.className = 'celebration-text';
      text.textContent = isEarly ? 'üéâ EARLY!' : '‚úì ON TIME!';
      text.style.color = isEarly ? '#4ade80' : '#fde047';
      document.body.appendChild(text);
      setTimeout(() => text.remove(), 2000);
      
      // Create confetti
      const celebration = document.getElementById('celebration');
      const colors = isEarly ? ['#22c55e', '#4ade80', '#86efac', '#fde047'] : ['#facc15', '#fde047', '#fef08a', '#22c55e'];
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.width = (Math.random() * 10 + 5) + 'px';
        confetti.style.height = (Math.random() * 10 + 5) + 'px';
        confetti.style.animation = `confettiFall ${Math.random() * 2 + 1.5}s ease-out forwards`;
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        celebration.appendChild(confetti);
      }
      
      // Clean up confetti
      setTimeout(() => {
        celebration.innerHTML = '';
      }, 3500);
    }
    
    function toggleDebug() {
      const panel = document.getElementById('debugPanel');
      panel.classList.toggle('active');
    }
    
    function setDebugState(state) {
      debugMode = true;
      debugState = state;
      debugElapsedPercent = null;
      document.body.classList.add('debug-active');
      renderTimer();
    }
    
    function simulateTime(percent) {
      debugMode = true;
      debugState = null;
      debugElapsedPercent = percent;
      document.body.classList.add('debug-active');
      renderTimer();
    }
    
    function simulateBreak(onBreak) {
      debugMode = true;
      debugOnBreak = onBreak;
      document.body.classList.add('debug-active');
      renderTimer();
    }
    
    function resetDebug() {
      debugMode = false;
      debugState = null;
      debugElapsedPercent = null;
      debugOnBreak = null;
      cycleHistory = [];
      document.body.classList.remove('debug-active');
      renderTimer();
      renderCycleHistory();
    }
    
    // Keyboard shortcut to toggle debug panel
    document.addEventListener('keydown', function(e) {
      if (e.key === 'd' || e.key === 'D') {
        // Don't trigger if typing in an input
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          toggleDebug();
        }
      }
    });
    const t={en:{currentStrain:'Line 1 ‚Ä¢ Current Strain',lastHour:'Last Hour (Completed)',currentHour:'Current Hour',lbs:'lbs',trimmers:'trimmers',ofTarget:'vs target',lbsTarget:'lbs target',trimmersLabel:'Line 1 Trimmers',targetRate:'Target:',avgLbs:'AVG',bestLbs:'BEST',todaysProgress:'LINE 1 TODAY',endOfDay:'End of day:',lbsGoal:'lbs goal',upBy:'Up',downBy:'Down',vsYesterday:'vs Yesterday',vs7Day:'vs 7-Day Avg',hrStreak:'hr streak',hrs:'hrs',aheadOfTarget:'AHEAD OF TARGET',onTarget:'ON TARGET',behindTarget:'BEHIND TARGET',waiting:'WAITING FOR DATA',bagTimer:'5KG BAG TIMER',remaining:'remaining',overtime:'OVERTIME',bagComplete:'5KG Bag Complete',logged:'Logged!',bagsToday:'Bags Today',avgToday:'Avg Today',vsTargetTimer:'vs Target',strainRate:'Strain-specific rate',fallbackRate:'Using avg rate',helpTitle:'Understanding the Scoreboard',helpGreen:'Green = Ahead (105%+)',helpYellow:'Yellow = On Target (90-105%)',helpRed:'Red = Behind (<90%)',chartHeader:'HOURLY PERFORMANCE (LBS/TRIMMER)',onBreak:'ON BREAK',paused:'PAUSED',todaysCycles:"Today's Cycles",noBags:'No bags completed yet'},es:{currentStrain:'L√≠nea 1 ‚Ä¢ Variedad Actual',lastHour:'√öltima Hora (Completa)',currentHour:'Hora Actual',lbs:'lbs',trimmers:'triminadores',ofTarget:'vs meta',lbsTarget:'lbs meta',trimmersLabel:'Triminadores L1',targetRate:'Meta:',avgLbs:'PROM',bestLbs:'MEJOR',todaysProgress:'L√çNEA 1 HOY',endOfDay:'Fin del d√≠a:',lbsGoal:'lbs meta',upBy:'Arriba',downBy:'Abajo',vsYesterday:'vs Ayer',vs7Day:'vs Prom 7 D√≠as',hrStreak:'hrs seguidas',hrs:'hrs',aheadOfTarget:'ARRIBA DE LA META',onTarget:'EN LA META',behindTarget:'DEBAJO DE LA META',waiting:'ESPERANDO DATOS',bagTimer:'TEMPORIZADOR 5KG',remaining:'restante',overtime:'TIEMPO EXTRA',bagComplete:'Bolsa 5KG Lista',logged:'¬°Registrado!',bagsToday:'Bolsas Hoy',avgToday:'Prom Hoy',vsTargetTimer:'vs Meta',strainRate:'Tasa espec√≠fica',fallbackRate:'Usando tasa prom',helpTitle:'Entendiendo el Marcador',helpGreen:'Verde = Adelante (105%+)',helpYellow:'Amarillo = En Meta (90-105%)',helpRed:'Rojo = Atr√°s (<90%)',chartHeader:'RENDIMIENTO POR HORA (LBS/TRIMINADOR)',onBreak:'EN DESCANSO',paused:'PAUSADO',todaysCycles:'Ciclos de Hoy',noBags:'Sin bolsas completadas'}};
    
    // Break schedule: [startHour, startMin, endHour, endMin]
    const BREAKS = [
      [9, 0, 9, 10],      // 9:00-9:10 AM break
      [12, 0, 12, 30],    // 12:00-12:30 PM lunch
      [14, 30, 14, 40],   // 2:30-2:40 PM break
      [16, 20, 16, 30]    // 4:20-4:30 PM cleanup/EOD
    ];
    const WORKDAY_START = 7 * 60;  // 7:00 AM in minutes
    const WORKDAY_END = 16 * 60 + 30;  // 4:30 PM in minutes
    
    function getWorkingSecondsSince(startTime) {
      if (!startTime) return 0;
      const now = new Date();
      
      // If different day, return 0 (timer resets daily)
      if (startTime.toDateString() !== now.toDateString()) {
        return 0;
      }
      
      let startMins = startTime.getHours() * 60 + startTime.getMinutes();
      const startSecs = startTime.getSeconds();
      let nowMins = now.getHours() * 60 + now.getMinutes();
      let nowSecs = now.getSeconds();
      
      // Before workday - no time elapsed
      if (nowMins < WORKDAY_START) return 0;
      
      // Cap at workday end
      if (nowMins >= WORKDAY_END) {
        nowMins = WORKDAY_END;
        nowSecs = 0;
      }
      
      // If start was before workday, adjust to workday start
      if (startMins < WORKDAY_START) {
        startMins = WORKDAY_START;
      }
      
      // Check if we're currently in a break - if so, cap nowMins/nowSecs to break start
      for (const [bStartH, bStartM, bEndH, bEndM] of BREAKS) {
        const breakStart = bStartH * 60 + bStartM;
        const breakEnd = bEndH * 60 + bEndM;
        if (nowMins >= breakStart && nowMins < breakEnd) {
          // We're in a break - freeze time at break start
          nowMins = breakStart;
          nowSecs = 0;
          break;
        }
      }
      
      // Calculate total seconds
      let totalSecs = (nowMins * 60 + nowSecs) - (startMins * 60 + startSecs);
      
      // Subtract any completed break time that overlaps our range
      for (const [bStartH, bStartM, bEndH, bEndM] of BREAKS) {
        const breakStartSecs = (bStartH * 60 + bStartM) * 60;
        const breakEndSecs = (bEndH * 60 + bEndM) * 60;
        const rangeStartSecs = startMins * 60 + startSecs;
        const rangeEndSecs = nowMins * 60 + nowSecs;
        
        if (breakEndSecs > rangeStartSecs && breakStartSecs < rangeEndSecs) {
          const overlapStart = Math.max(breakStartSecs, rangeStartSecs);
          const overlapEnd = Math.min(breakEndSecs, rangeEndSecs);
          if (overlapEnd > overlapStart) {
            totalSecs -= (overlapEnd - overlapStart);
          }
        }
      }
      
      return Math.max(0, totalSecs);
    }
    
    function isOnBreakOrAfterHours() {
      const now = new Date();
      const nowMins = now.getHours() * 60 + now.getMinutes();
      
      // Before workday
      if (nowMins < WORKDAY_START) return { onBreak: true, afterHours: true };
      
      // After workday end
      if (nowMins >= WORKDAY_END) return { onBreak: true, afterHours: true };
      
      // Check if currently in a break
      for (const [bStartH, bStartM, bEndH, bEndM] of BREAKS) {
        const breakStart = bStartH * 60 + bStartM;
        const breakEnd = bEndH * 60 + bEndM;
        if (nowMins >= breakStart && nowMins < breakEnd) {
          return { onBreak: true, afterHours: false };
        }
      }
      
      return { onBreak: false, afterHours: false };
    }
    
    function toggleHelp(){document.getElementById('helpModal').classList.toggle('active');document.getElementById('helpTitle').textContent=t[currentLang].helpTitle;document.getElementById('helpGreen').textContent=t[currentLang].helpGreen;document.getElementById('helpYellow').textContent=t[currentLang].helpYellow;document.getElementById('helpRed').textContent=t[currentLang].helpRed;}
    
    // API Configuration for GitHub Pages
    var API_URL = 'https://script.google.com/macros/s/AKfycbxDAHSFl9cedGS49L3Lf5ztqy-SSToYigyA30ZtsdpmWNAR9H61X_Mm48JOOTGqqr-Z/exec';
    
    // Detect environment: Apps Script (google.script.run available) or GitHub Pages (use fetch)
    var isAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
    
    document.addEventListener('DOMContentLoaded',function(){updateClock();setInterval(updateClock,1000);loadData();setInterval(loadData,15000);setInterval(renderTimer,1000);renderCycleHistory();});
    function setLanguage(lang){currentLang=lang;document.getElementById('btnEn').classList.toggle('active',lang==='en');document.getElementById('btnEs').classList.toggle('active',lang==='es');document.getElementById('strainLabel').textContent=t[lang].currentStrain;document.getElementById('lastHourHeader').textContent=t[lang].lastHour;document.getElementById('currentHourHeader').textContent=t[lang].currentHour;document.getElementById('lbsUnit').textContent=t[lang].lbs;document.getElementById('trimmersSmallLabel').textContent=t[lang].trimmers;document.getElementById('ofTargetLabel').textContent=t[lang].ofTarget;document.getElementById('lbsTargetLabel').textContent=t[lang].lbsTarget;document.getElementById('trimmersLabel').textContent=t[lang].trimmersLabel;document.getElementById('targetRateLabel').textContent=t[lang].targetRate;document.getElementById('avgTargetLabel').textContent=t[lang].avgLbs;document.getElementById('bestHourLabel').textContent=t[lang].bestLbs;document.getElementById('dailyHeader').textContent=t[lang].todaysProgress;document.getElementById('vsYesterdayLabel').textContent=t[lang].vsYesterday;document.getElementById('vs7DayLabel').textContent=t[lang].vs7Day;document.getElementById('streakLabel').textContent=t[lang].hrStreak;document.getElementById('timerHeader').textContent=t[lang].bagTimer;document.getElementById('manualBtnText').textContent=t[lang].bagComplete;document.getElementById('bagsTodayLabel').textContent=t[lang].bagsToday;document.getElementById('avgTodayLabel').textContent=t[lang].avgToday;document.getElementById('vsTargetLabel').textContent=t[lang].vsTargetTimer;document.getElementById('chartHeader').textContent=t[lang].chartHeader;document.getElementById('cycleHistoryTitle').textContent=t[lang].todaysCycles;updateClock();renderScoreboard();renderTimer();renderCycleHistory();}
    function updateClock(){const now=new Date(),h=now.getHours()%12||12,m=now.getMinutes().toString().padStart(2,'0'),ap=now.getHours()>=12?'PM':'AM';document.getElementById('clock').textContent=`${h}:${m} ${ap}`;document.getElementById('date').textContent=now.toLocaleDateString(currentLang==='es'?'es-MX':'en-US',{weekday:'long',month:'short',day:'numeric'});}
    
    function loadData(){
      if (isAppsScript) {
        // Running inside Google Apps Script web app
        google.script.run
          .withSuccessHandler(function(r){
            data = r.scoreboard;
            timerData = r.timer;
            if (timerData && timerData.lastBagTime) lastBagTimestamp = new Date(timerData.lastBagTime);
            renderScoreboard();
            renderTimer();
          })
          .withFailureHandler(function(e){ console.error(e); })
          .getScoreboardWithTimerData();
      } else {
        // Running on GitHub Pages - use fetch API
        fetch(API_URL + '?action=scoreboard')
          .then(function(response) { return response.json(); })
          .then(function(r) {
            data = r.scoreboard;
            timerData = r.timer;
            if (timerData && timerData.lastBagTime) lastBagTimestamp = new Date(timerData.lastBagTime);
            renderScoreboard();
            renderTimer();
          })
          .catch(function(e) {
            console.error('Load error:', e);
          });
      }
    }
    
    function renderHourlyChart(hourlyRates, targetRate) {
      const container = document.getElementById('chartContainer');
      if (!hourlyRates || hourlyRates.length === 0) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      
      const labels = hourlyRates.map(h => {
        // Shorten time slot labels: "9:00 AM ‚Äì 10:00 AM" -> "9-10"
        const match = h.timeSlot.match(/(\d+):\d+\s*(AM|PM)\s*[‚Äì-]\s*(\d+):\d+/i);
        if (match) {
          let start = parseInt(match[1]);
          let end = parseInt(match[3]);
          return `${start}-${end}`;
        }
        return h.timeSlot;
      });
      
      const rates = hourlyRates.map(h => parseFloat(h.rate.toFixed(2)));
      const targets = hourlyRates.map(h => parseFloat(h.target.toFixed(2)));
      
      // Color bars based on performance - using brand colors
      const barColors = hourlyRates.map(h => {
        const pct = (h.rate / h.target) * 100;
        if (pct >= 105) return '#668971';  // Brand green
        if (pct >= 90) return '#e4aa4f';   // Brand gold
        return '#f87171';                   // Red
      });
      
      // If chart exists, update data instead of recreating
      if (hourlyChart) {
        hourlyChart.data.labels = labels;
        hourlyChart.data.datasets[0].data = rates;
        hourlyChart.data.datasets[0].backgroundColor = barColors;
        hourlyChart.data.datasets[1].data = targets;
        hourlyChart.update('none');
        return;
      }
      
      const ctx = document.getElementById('hourlyChart').getContext('2d');
      
      hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Actual',
              data: rates,
              backgroundColor: barColors,
              borderRadius: 4,
              barThickness: 32
            },
            {
              label: 'Target',
              data: targets,
              type: 'line',
              borderColor: 'rgba(228,170,79,0.6)',
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' lbs/hr';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(228,170,79,0.1)' },
              ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 12 } }
            }
          }
        }
      });
    }
    
    function renderScoreboard(){if(!data)return;const lastHourLbs=data.lastHourLbs||0,lastHourTarget=data.lastHourTarget||0,lastHourTrimmers=data.lastHourTrimmers||0,lastTimeSlot=data.lastTimeSlot||'‚Äî',currentHourTrimmers=data.currentHourTrimmers||0,currentHourTarget=data.currentHourTarget||0,currentTimeSlot=data.currentTimeSlot||'',targetRate=data.targetRate||0,strain=data.strain||'‚Äî',todayLbs=data.todayLbs||0,todayTarget=data.todayTarget||0,todayPct=data.todayPercentage||0,hoursLogged=data.hoursLogged||0,avgPct=data.avgPercentage||0,bestPct=data.bestPercentage||0,streak=data.streak||0,lastHourPct=lastHourTarget>0?(lastHourLbs/lastHourTarget)*100:0,lastHourDelta=lastHourLbs-lastHourTarget,statusPct=todayPct>0?todayPct:avgPct;let status='idle',statusIcon='‚è∏',statusKey='waiting';if(todayLbs>0||lastHourLbs>0){if(statusPct>=105){status='ahead';statusIcon='üî•';statusKey='aheadOfTarget';}else if(statusPct>=90){status='on-target';statusIcon='‚úì';statusKey='onTarget';}else if(statusPct>0){status='behind';statusIcon='‚ö†';statusKey='behindTarget';}}
    // Update status classes without overriding timer background
    document.body.classList.remove('ahead','on-target','behind','idle');
    document.body.classList.add(status);
    document.getElementById('statusIcon').textContent=statusIcon;document.getElementById('statusText').textContent=t[currentLang][statusKey];document.getElementById('lastHourLbs').textContent=lastHourLbs>0?lastHourLbs.toFixed(1):'‚Äî';document.getElementById('lastHourTarget').textContent=lastHourTarget>0?lastHourTarget.toFixed(1):'‚Äî';document.getElementById('lastHourTimeslot').textContent=lastTimeSlot;
    // Show lbs delta instead of percentage
    const lhp = document.getElementById('lastHourPct');
    if(lastHourTarget>0){const deltaAbs=Math.abs(lastHourDelta).toFixed(1);if(lastHourDelta>=0.05){lhp.textContent=`+${deltaAbs} lbs`;lhp.style.color='#7a9d87';}else if(lastHourDelta<=-0.05){lhp.textContent=`-${deltaAbs} lbs`;lhp.style.color='#f87171';}else{lhp.textContent=`0 lbs`;lhp.style.color='#e4aa4f';}}else{lhp.textContent='‚Äî';lhp.style.color='rgba(255,255,255,0.5)';}
    const chc=document.getElementById('currentHourCard');if(currentHourTrimmers>0){chc.style.display='block';document.getElementById('currentHourTrimmers').textContent=currentHourTrimmers;document.getElementById('currentHourTimeslot').textContent=currentTimeSlot;document.getElementById('currentHourTargetLbs').textContent=currentHourTarget>0?currentHourTarget.toFixed(1):'‚Äî';}else{chc.style.display='none';}
    
    // Render the hourly chart
    renderHourlyChart(data.hourlyRates, targetRate);
    
    document.getElementById('dailyActual').textContent=todayLbs>0?todayLbs.toFixed(1):'‚Äî';document.getElementById('dailyTarget').textContent=todayTarget>0?todayTarget.toFixed(1):'‚Äî';const todayDelta=data.todayDelta||0,dde=document.getElementById('dailyDelta');if(todayTarget>0){const da=Math.abs(todayDelta).toFixed(1);if(todayDelta>=0.1){dde.textContent=`‚Üë ${t[currentLang].upBy} ${da}`;dde.className='daily-delta positive';}else if(todayDelta<=-0.1){dde.textContent=`‚Üì ${t[currentLang].downBy} ${da}`;dde.className='daily-delta negative';}else{dde.textContent='= On pace';dde.className='daily-delta neutral';}}else{dde.textContent='‚Äî';dde.className='daily-delta neutral';}const effectiveHours=data.effectiveHours||hoursLogged;document.getElementById('progressHours').textContent=`${effectiveHours.toFixed(1)} ${t[currentLang].hrs}`;document.getElementById('progressFill').style.width=`${Math.min(100,todayPct||avgPct||0)}%`;const projectedTotal=data.projectedTotal||0,dailyGoal=data.dailyGoal||0,projectedDelta=data.projectedDelta||0;document.getElementById('projectionLabel').textContent=t[currentLang].endOfDay;document.getElementById('projectionValue').textContent=projectedTotal>0?projectedTotal.toFixed(1):'‚Äî';document.getElementById('projectionGoal').textContent=dailyGoal>0?`/ ${dailyGoal.toFixed(1)} ${t[currentLang].lbsGoal}`:'';const pde=document.getElementById('projectionDelta');if(dailyGoal>0&&projectedTotal>0){const pda=Math.abs(projectedDelta).toFixed(1);if(projectedDelta>=0.5){pde.textContent=`‚Üë +${pda}`;pde.className='projection-delta positive';}else if(projectedDelta<=-0.5){pde.textContent=`‚Üì -${pda}`;pde.className='projection-delta negative';}else{pde.textContent='= On pace';pde.className='projection-delta neutral';}}else{pde.textContent='‚Äî';pde.className='projection-delta neutral';}renderComparison('vsYesterday',data.vsYesterday);renderComparison('vs7Day',data.vs7Day);document.getElementById('streakPill').style.display=streak>=2?'flex':'none';document.getElementById('streakValue').textContent=streak;const displayTrimmers=currentHourTrimmers>0?currentHourTrimmers:lastHourTrimmers;document.getElementById('crewCount').textContent=displayTrimmers>0?displayTrimmers:'‚Äî';document.getElementById('targetRate').textContent=targetRate>0?targetRate.toFixed(2):'‚Äî';document.getElementById('strainName').textContent=strain||'‚Äî';const avgEl=document.getElementById('avgPercentage'),bestEl=document.getElementById('bestHour');
    if(data.avgDelta!==undefined&&data.avgDelta!==0){avgEl.textContent=(data.avgDelta>=0?'+':'')+data.avgDelta.toFixed(1);avgEl.style.color=data.avgDelta>=0.05?'#7a9d87':data.avgDelta<=-0.05?'#f87171':'#e4aa4f';}else if(data.avgDelta===0){avgEl.textContent='0';avgEl.style.color='#e4aa4f';}else{avgEl.textContent='‚Äî';avgEl.style.color='rgba(255,255,255,0.9)';}
    if(data.bestDelta!==undefined&&data.bestDelta!==0){bestEl.textContent=(data.bestDelta>=0?'+':'')+data.bestDelta.toFixed(1);bestEl.style.color=data.bestDelta>=0.05?'#7a9d87':data.bestDelta<=-0.05?'#f87171':'#e4aa4f';}else if(data.bestDelta===0){bestEl.textContent='0';bestEl.style.color='#e4aa4f';}else{bestEl.textContent='‚Äî';bestEl.style.color='rgba(255,255,255,0.9)';}
    const sri=document.getElementById('strainRateIndicator');if(data.usingStrainRate){sri.innerHTML=`<span style="font-size:12px;color:rgba(122,157,135,0.9)">${t[currentLang].strainRate}</span>`;}else if(strain&&strain!=='‚Äî'){sri.innerHTML=`<span style="font-size:12px;color:rgba(228,170,79,0.9)">${t[currentLang].fallbackRate}</span>`;}else{sri.innerHTML='';}}
    function renderTimer(){const targetSec=(timerData&&timerData.targetSeconds)||0,trimmers=(timerData&&timerData.currentTrimmers)||0,bagsToday=(timerData&&timerData.bagsToday)||0,avgSecToday=(timerData&&timerData.avgSecondsToday)||0;
      
      // Get break/after hours status (can be overridden by debug)
      let breakStatus = debugOnBreak !== null ? { onBreak: debugOnBreak, afterHours: false } : isOnBreakOrAfterHours();
      
      // Calculate working time (excludes breaks)
      let elapsedSec=0;
      if(lastBagTimestamp)elapsedSec=getWorkingSecondsSince(lastBagTimestamp);
      
      // Debug mode: simulate elapsed time as percentage of target
      const debugTargetSec = targetSec > 0 ? targetSec : 300; // Default 5 min for testing
      if (debugMode && debugElapsedPercent !== null) {
        elapsedSec = Math.round(debugTargetSec * (debugElapsedPercent / 100));
      }
      
      const effectiveTarget = debugMode ? debugTargetSec : targetSec;
      let remainingSec=effectiveTarget>0?effectiveTarget-elapsedSec:elapsedSec;
      const isOvertime=effectiveTarget>0&&remainingSec<0&&!breakStatus.onBreak;
      const displaySec=Math.abs(effectiveTarget>0?remainingSec:elapsedSec);
      
      let colorClass='neutral';
      
      // Debug mode: direct state override
      if (debugMode && debugState) {
        colorClass = debugState;
      } else if(effectiveTarget>0||elapsedSec>0){
        colorClass='green';
        if(breakStatus.onBreak){
          colorClass='yellow';
        }else if(effectiveTarget>0){
          if(isOvertime)colorClass='red';
          else if(remainingSec<effectiveTarget*0.2)colorClass='yellow';
        }
      }
      
      const tp=document.getElementById('timerPanel'),tv=document.getElementById('timerValue'),tl=document.getElementById('timerLabel'),tr=document.getElementById('timerRing'),td=document.getElementById('timerDisplay');
      
      // Update panel background color (preserve fullscreen and dragging classes)
      const isFs = tp.classList.contains('fullscreen');
      const isDr = tp.classList.contains('dragging');
      tp.className='timer-panel '+colorClass + (isFs ? ' fullscreen' : '') + (isDr ? ' dragging' : '');
      
      // Update body background based on timer status
      document.body.classList.remove('timer-green', 'timer-yellow', 'timer-red', 'timer-neutral');
      document.body.classList.add('timer-' + colorClass);
      
      // Show paused state during breaks/after hours
      if(breakStatus.onBreak && !debugMode){
        tv.textContent=breakStatus.afterHours?'--:--':formatTime(displaySec);
        tv.className='timer-value yellow';
        tl.textContent=breakStatus.afterHours?t[currentLang].paused:t[currentLang].onBreak;
      }else{
        const showTime = debugMode || effectiveTarget>0 || elapsedSec>0;
        tv.textContent=showTime?formatTime(displaySec):'--:--';
        tv.className='timer-value '+(colorClass==='neutral'?'':colorClass);
        const isOT = debugState === 'red' || isOvertime;
        tl.textContent=(effectiveTarget===0&&elapsedSec>0&&!debugMode)?(currentLang==='es'?'transcurrido':'elapsed'):isOT?t[currentLang].overtime:t[currentLang].remaining;
      }
      
      const circ=2*Math.PI*95;let prog=0;
      if(breakStatus.onBreak && !debugMode){
        // Keep ring at current position during breaks
        prog=effectiveTarget>0&&elapsedSec>0?Math.min(1,elapsedSec/effectiveTarget):0;
      }else if(effectiveTarget>0){
        const isOT = debugState === 'red' || isOvertime;
        prog=isOT?1:elapsedSec/effectiveTarget;
      }
      // Debug mode progress override
      if (debugMode && debugElapsedPercent !== null) {
        prog = Math.min(1, debugElapsedPercent / 100);
      } else if (debugMode && debugState === 'red') {
        prog = 1;
      } else if (debugMode && debugState === 'yellow') {
        prog = 0.85;
      } else if (debugMode && debugState === 'green') {
        prog = 0.4;
      }
      
      tr.style.strokeDashoffset=circ*(1-Math.min(1,prog));
      tr.className='timer-ring-progress '+(colorClass==='neutral'?'green':colorClass);
      const showOvertime = debugState === 'red' || (isOvertime && !breakStatus.onBreak);
      td.classList.toggle('overtime', showOvertime);
      
      document.getElementById('timerTargetTime').textContent=effectiveTarget>0?formatTime(effectiveTarget):'--:--';document.getElementById('timerTrimmers').textContent=trimmers||'‚Äî';document.getElementById('bagsToday').textContent=bagsToday;document.getElementById('avgToday').textContent=avgSecToday>0?formatTime(avgSecToday):'--:--';const vt=document.getElementById('vsTarget');if(avgSecToday>0&&effectiveTarget>0){const diff=effectiveTarget-avgSecToday,dm=Math.round(diff/60);if(dm>0){vt.textContent=`+${dm} min`;vt.className='timer-stat-value positive';}else if(dm<0){vt.textContent=`${dm} min`;vt.className='timer-stat-value negative';}else{vt.textContent='On pace';vt.className='timer-stat-value';}}else{vt.textContent='‚Äî';vt.className='timer-stat-value';}
      
      // Update button color to match timer state
      const btn = document.getElementById('manualBtn');
      btn.classList.remove('btn-green', 'btn-yellow', 'btn-red', 'btn-neutral');
      if (!btn.classList.contains('success')) {
        btn.classList.add('btn-' + colorClass);
      }
    }
    function formatTime(s){return`${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;}
    function logManualEntry(){
      const btn=document.getElementById('manualBtn'),txt=document.getElementById('manualBtnText');
      
      // Calculate elapsed time before resetting
      const targetSec = (timerData && timerData.targetSeconds) || 300;
      let elapsedSec = 0;
      if (lastBagTimestamp) {
        elapsedSec = getWorkingSecondsSince(lastBagTimestamp);
      }
      
      // Add to cycle history if there was a valid cycle
      if (elapsedSec > 0) {
        addCycleToHistory(elapsedSec, targetSec);
      }
      
      btn.disabled=true;
      btn.classList.add('success');
      btn.classList.remove('btn-green', 'btn-yellow', 'btn-red', 'btn-neutral');
      txt.textContent=t[currentLang].logged;
      
      if (isAppsScript) {
        // Running inside Google Apps Script web app
        google.script.run
          .withSuccessHandler(function(){
            lastBagTimestamp = new Date();
            renderTimer();
            setTimeout(loadData, 1000);
            setTimeout(function(){
              btn.disabled=false;
              btn.classList.remove('success');
              txt.textContent=t[currentLang].bagComplete;
            }, 2000);
          })
          .withFailureHandler(function(e){
            console.error(e);
            btn.disabled=false;
            btn.classList.remove('success');
            txt.textContent=t[currentLang].bagComplete;
          })
          .logManualBagCompletion();
      } else {
        // Running on GitHub Pages - use fetch API
        fetch(API_URL + '?action=logBag', { method: 'POST' })
          .then(function(response) { return response.json(); })
          .then(function(r) {
            if (r.success) {
              lastBagTimestamp = new Date();
              renderTimer();
              setTimeout(loadData, 1000);
            }
            setTimeout(function(){
              btn.disabled=false;
              btn.classList.remove('success');
              txt.textContent=t[currentLang].bagComplete;
            }, 2000);
          })
          .catch(function(e) {
            console.error('Log bag error:', e);
            btn.disabled=false;
            btn.classList.remove('success');
            txt.textContent=t[currentLang].bagComplete;
          });
      }
    }
    function renderComparison(prefix,value){const pill=document.getElementById(prefix+'Pill'),ve=document.getElementById(prefix+'Value');if(value===null||value===undefined){pill.style.display='none';return;}pill.style.display='flex';const r=Math.round(value);ve.textContent=`${r>=0?'+':''}${r}%`;ve.classList.remove('positive','negative','neutral');ve.classList.add(r>2?'positive':r<-2?'negative':'neutral');}
    
    // Drag-to-expand timer panel functionality
    (function() {
      const timerPanel = document.getElementById('timerPanel');
      const dragHandle = document.getElementById('dragHandle');
      const expandHint = document.getElementById('expandHint');
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let isFullscreen = false;
      const DRAG_THRESHOLD = 100; // pixels to drag before toggling
      
      function isVerticalMode() {
        return window.innerWidth <= 1024;
      }
      
      function updateHint() {
        if (isVerticalMode()) {
          expandHint.textContent = isFullscreen ? '‚ñº' : '‚ñ≤';
        } else {
          expandHint.textContent = isFullscreen ? '‚ñ∂' : '‚óÄ';
        }
      }
      
      function toggleFullscreen(toFullscreen) {
        isFullscreen = toFullscreen;
        timerPanel.classList.toggle('fullscreen', isFullscreen);
        document.body.classList.toggle('timer-fullscreen', isFullscreen);
        updateHint();
        // Save preference
        try { localStorage.setItem('timerFullscreen', isFullscreen); } catch(e) {}
      }
      
      // Load saved preference
      try {
        const saved = localStorage.getItem('timerFullscreen');
        if (saved === 'true') {
          toggleFullscreen(true);
        }
      } catch(e) {}
      
      // Update hint on resize
      window.addEventListener('resize', updateHint);
      updateHint();
      
      // Mouse events
      dragHandle.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        timerPanel.classList.add('dragging');
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        timerPanel.classList.remove('dragging');
        
        if (isVerticalMode()) {
          // Vertical dragging (up/down)
          const deltaY = startY - e.clientY;
          if (!isFullscreen && deltaY > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaY < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        } else {
          // Horizontal dragging (left/right)
          const deltaX = startX - e.clientX;
          if (!isFullscreen && deltaX > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaX < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        }
      });
      
      // Touch events for mobile
      dragHandle.addEventListener('touchstart', function(e) {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        timerPanel.classList.add('dragging');
      }, { passive: true });
      
      document.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
      }, { passive: true });
      
      document.addEventListener('touchend', function(e) {
        if (!isDragging) return;
        isDragging = false;
        timerPanel.classList.remove('dragging');
        
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        
        if (isVerticalMode()) {
          const deltaY = startY - endY;
          if (!isFullscreen && deltaY > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaY < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        } else {
          const deltaX = startX - endX;
          if (!isFullscreen && deltaX > DRAG_THRESHOLD) {
            toggleFullscreen(true);
          } else if (isFullscreen && deltaX < -DRAG_THRESHOLD) {
            toggleFullscreen(false);
          }
        }
      });
      
      // Double-click/tap to toggle
      dragHandle.addEventListener('dblclick', function() {
        toggleFullscreen(!isFullscreen);
      });
    })();
  </script>
</body>
</html>
