<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SOP Manager">
  <title>SOP Manager - Rogue Origin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --gold: #e4aa4f;
      --gold-light: #f0cb60;
      --gold-dim: rgba(228,170,79,0.12);
      --green: #668971;
      --green-light: #7a9d86;
      --green-dim: rgba(102,137,113,0.12);
      --green-dark: #4a6b54;
      --sungrown: #bf8e4e;
      --sungrown-dim: rgba(191,142,78,0.12);
      --greenhouse: #8f9263;
      --greenhouse-dim: rgba(143,146,99,0.12);
      --indoor: #62758d;
      --indoor-dim: rgba(98,117,141,0.12);
      --danger: #c45c4a;
      --danger-dim: rgba(196,92,74,0.12);
      --bg: #faf8f4;
      --bg-warm: #f3efe7;
      --bg-card: #ffffff;
      --bg-dark: #2d3a2e;
      --border: #e4ddd0;
      --border-light: rgba(102,137,113,0.15);
      --text: #2d3a2e;
      --text-muted: #5a6b5f;
      --text-light: #94a397;
      --header-bg: #2d3a2e;
      --header-text: #faf8f4;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    
    body.dark-mode {
      --bg: #1a1f16;
      --bg-warm: #22291e;
      --bg-card: #252b22;
      --border: rgba(228,170,79,0.2);
      --border-light: rgba(228,170,79,0.1);
      --text: #e8e4dc;
      --text-muted: #a8b5a9;
      --text-light: #6b7a6f;
      --gold-dim: rgba(228,170,79,0.18);
      --green-dim: rgba(102,137,113,0.18);
      --header-bg: #12160f;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-tap-highlight-color: transparent;
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }
    
    .main { min-height: 100vh; min-height: 100dvh; display: flex; flex-direction: column; position: relative; z-index: 1; }

    /* ===== HEADER - Mobile First ===== */
    .header { 
      background: var(--header-bg); 
      padding: 12px 16px; 
      padding-top: calc(12px + var(--safe-top));
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      border-bottom: 3px solid var(--gold);
      position: sticky; 
      top: 0; 
      z-index: 40;
      gap: 12px;
    }
    .header-left { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
    .header-logo { height: 32px; flex-shrink: 0; }
    .header-title { 
      font-size: 14px; 
      font-weight: 600; 
      color: var(--header-text); 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    
    /* Mobile menu button */
    .mobile-menu-btn {
      display: flex;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--header-text);
      width: 40px;
      height: 40px;
      border-radius: 8px;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
    }
    .mobile-menu-btn:active { background: rgba(255,255,255,0.2); }
    
    /* Primary action always visible */
    .header-btn-primary {
      background: var(--gold);
      color: var(--header-bg);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .header-btn-primary:active { background: var(--gold-light); }
    
    /* Desktop header buttons - hidden on mobile */
    .header-btn { 
      background: rgba(255,255,255,0.08); 
      color: var(--header-text); 
      border: 1px solid rgba(255,255,255,0.15); 
      padding: 8px 14px; 
      border-radius: 8px; 
      font-weight: 500; 
      font-size: 13px; 
      cursor: pointer; 
      display: none; 
      align-items: center; 
      gap: 6px; 
      transition: all 0.2s; 
    }
    .header-btn:hover { background: rgba(255,255,255,0.15); }
    .header-btn.primary { background: var(--gold); color: var(--header-bg); border-color: var(--gold); font-weight: 600; }
    
    /* Mobile dropdown menu */
    .mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      left: 0;
      background: var(--header-bg);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 16px 16px;
      flex-direction: column;
      gap: 8px;
      z-index: 50;
    }
    .mobile-menu.active { display: flex; }
    .mobile-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--header-text);
      font-size: 15px;
      cursor: pointer;
    }
    .mobile-menu-item:active { background: rgba(255,255,255,0.15); }
    .mobile-menu-item i { font-size: 20px; width: 24px; text-align: center; }
    .mobile-menu-item .request-badge { margin-left: auto; }
    .mobile-menu-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }
    
    /* Overlay when menu open */
    .menu-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 35;
    }
    .menu-overlay.active { display: block; }

    /* ===== TOOLBAR ===== */
    .toolbar { 
      background: var(--bg-card); 
      padding: 12px 16px; 
      border-bottom: 1px solid var(--border); 
      display: flex; 
      flex-direction: column;
      gap: 10px;
    }
    .toolbar-row { display: flex; gap: 8px; align-items: center; }
    .search-box { position: relative; flex: 1; }
    .search-box input { 
      width: 100%;
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 12px 12px 12px 40px; 
      color: var(--text); 
      font-size: 16px; /* Prevents iOS zoom */
    }
    .search-box input:focus { outline: none; border-color: var(--green); background: var(--bg-card); }
    .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 18px; }
    
    .filter-row { display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; }
    .filter-row::-webkit-scrollbar { display: none; }
    .filter-select { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px 12px; 
      color: var(--text); 
      font-size: 14px; 
      cursor: pointer;
      min-width: 120px;
      flex-shrink: 0;
    }
    
    .view-toggle { display: flex; background: var(--bg); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
    .view-toggle button { 
      padding: 8px 12px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      background: transparent; 
      color: var(--text-muted);
      font-size: 16px;
    }
    .view-toggle button.active { background: var(--green); color: #fff; }

    /* ===== CONTENT ===== */
    .content { padding: 16px; flex: 1; background: var(--bg); padding-bottom: calc(16px + var(--safe-bottom)); }
    
    /* Stats Bar - Horizontal scroll on mobile */
    .stats-bar { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 16px; 
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
      scroll-snap-type: x mandatory;
    }
    .stats-bar::-webkit-scrollbar { display: none; }
    .stat-card { 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 14px 16px; 
      min-width: 100px;
      flex-shrink: 0;
      scroll-snap-align: start;
      border-top: 3px solid var(--border);
    }
    .stat-card:nth-child(1) { border-top-color: var(--gold); }
    .stat-card:nth-child(2) { border-top-color: var(--green); }
    .stat-card:nth-child(3) { border-top-color: var(--sungrown); }
    .stat-card:nth-child(4) { border-top-color: var(--danger); }
    .stat-card:nth-child(5) { border-top-color: var(--indoor); }
    .stat-card-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 4px; font-weight: 600; }
    .stat-card-value { font-size: 26px; font-weight: 700; }
    .stat-card-value.gold { color: var(--gold); }
    .stat-card-value.danger { color: var(--danger); }
    .stat-card-value.green { color: var(--green); }
    .stat-card-value.sungrown { color: var(--sungrown); }
    .stat-card-value.indoor { color: var(--indoor); }

    /* SOP Grid - Single column on mobile */
    .sop-grid { display: flex; flex-direction: column; gap: 12px; }
    
    .sop-card { 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      overflow: hidden; 
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      transition: transform 0.15s;
    }
    .sop-card:active { transform: scale(0.98); }
    
    .sop-card-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; background: linear-gradient(to bottom, var(--bg-card), var(--bg)); }
    .sop-card-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; line-height: 1.3; color: var(--text); }
    .sop-card-dept { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
    .sop-card-rev { background: var(--green); color: #fff; font-size: 10px; font-weight: 600; padding: 4px 10px; border-radius: 6px; white-space: nowrap; flex-shrink: 0; }
    .sop-card-rev.draft { background: var(--gold); color: var(--header-bg); }
    
    .sop-card-preview { height: 80px; background: var(--bg-warm); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sop-card-preview img { width: 100%; height: 100%; object-fit: cover; }
    .sop-card-preview-empty { color: var(--text-light); display: flex; flex-direction: column; align-items: center; gap: 2px; font-size: 11px; }
    .sop-card-preview-empty i { font-size: 24px; opacity: 0.5; }
    
    .sop-card-meta { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
    .sop-card-steps { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 5px; font-weight: 500; }
    .sop-card-tags { display: flex; gap: 4px; flex-wrap: wrap; }
    .sop-tag { background: var(--gold-dim); color: var(--gold); font-size: 9px; font-weight: 700; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
    .sop-tag.danger { background: var(--danger-dim); color: var(--danger); }
    .sop-tag.green { background: var(--green-dim); color: var(--green); }
    .sop-tag.sungrown { background: var(--sungrown-dim); color: var(--sungrown); }
    .sop-tag.greenhouse { background: var(--greenhouse-dim); color: var(--greenhouse); }
    .sop-tag.indoor, .sop-tag.blue { background: var(--indoor-dim); color: var(--indoor); }
    
    .sop-card-actions { display: flex; border-top: 1px solid var(--border); background: var(--bg-card); }
    .sop-card-actions button { 
      flex: 1; 
      background: transparent; 
      border: none; 
      border-right: 1px solid var(--border); 
      padding: 14px; 
      cursor: pointer; 
      color: var(--text-muted);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sop-card-actions button:last-child { border-right: none; }
    .sop-card-actions button:active { background: var(--green-dim); color: var(--green); }
    .sop-card-actions button.qr-btn:active { background: var(--gold-dim); color: var(--gold); }
    .sop-card-actions button.del-btn:active { background: var(--danger-dim); color: var(--danger); }

    /* List View */
    .sop-list { display: none; }
    .sop-list.active { display: block; }
    .sop-grid.hidden { display: none; }
    
    /* Mobile list view - simplified cards instead of table */
    .sop-table { display: none; }
    .sop-list-mobile { display: flex; flex-direction: column; gap: 8px; }
    .sop-list-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .sop-list-item:active { background: var(--bg); }
    .sop-list-info { flex: 1; min-width: 0; }
    .sop-list-title { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sop-list-meta { font-size: 12px; color: var(--text-muted); }
    .sop-list-badge { font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: var(--green); color: #fff; }
    .sop-list-badge.draft { background: var(--gold); color: var(--header-bg); }

    /* Empty State */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state i { font-size: 48px; margin-bottom: 12px; color: var(--green); opacity: 0.4; }
    .empty-state h3 { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
    .empty-state p { margin-bottom: 16px; font-size: 14px; }

    /* ===== MODALS - Full screen on mobile ===== */
    .modal { 
      position: fixed; 
      inset: 0; 
      background: rgba(26,31,22,0.6); 
      display: none; 
      align-items: flex-end; /* Slide up from bottom on mobile */
      justify-content: center; 
      z-index: 100; 
      backdrop-filter: blur(4px);
    }
    .modal.active { display: flex; }
    
    .modal-box { 
      background: var(--bg-card); 
      width: 100%; 
      max-height: 95vh;
      max-height: 95dvh;
      border-radius: 20px 20px 0 0;
      overflow: hidden; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 -4px 30px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .modal-header { 
      padding: 16px 20px; 
      border-bottom: 1px solid var(--border); 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: var(--header-bg);
      flex-shrink: 0;
    }
    .modal-header h2 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--header-text); }
    .modal-close { 
      background: rgba(255,255,255,0.1); 
      border: none; 
      color: var(--header-text); 
      font-size: 24px; 
      cursor: pointer; 
      width: 40px;
      height: 40px;
      border-radius: 8px; 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:active { background: rgba(255,255,255,0.2); }
    
    .modal-body { 
      padding: 20px; 
      overflow-y: auto; 
      flex: 1; 
      background: var(--bg-card);
      -webkit-overflow-scrolling: touch;
    }
    .modal-footer { 
      padding: 16px 20px; 
      padding-bottom: calc(16px + var(--safe-bottom));
      border-top: 1px solid var(--border); 
      display: flex; 
      gap: 10px; 
      background: var(--bg);
      flex-shrink: 0;
    }
    .modal-footer .btn { 
      flex: 1;
      padding: 14px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .modal-footer .btn-secondary {
      background: var(--bg-card);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .modal-footer .btn-primary {
      background: var(--green);
      color: #fff;
      border: none;
    }
    .modal-footer .btn-primary:active { background: var(--green-dark); }

    /* Form Elements */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input { 
      width: 100%; 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 14px; 
      color: var(--text); 
      font-size: 16px; /* Prevents iOS zoom */
    }
    .form-input:focus { outline: none; border-color: var(--green); background: var(--bg-card); }
    textarea.form-input { min-height: 80px; resize: vertical; font-family: inherit; }
    
    .form-row { display: flex; flex-direction: column; gap: 16px; }

    /* ===== STEPS - Mobile optimized ===== */
    .steps-section { margin-top: 20px; }
    .steps-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .steps-header h3 { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .steps-list { display: flex; flex-direction: column; gap: 12px; }
    
    .step-item { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .step-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .step-number { 
      width: 32px; 
      height: 32px; 
      background: var(--green); 
      color: #fff; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 700; 
      font-size: 14px; 
      flex-shrink: 0; 
    }
    .step-item-header .step-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    
    .step-content { display: flex; flex-direction: column; gap: 10px; }
    .step-title-input { 
      width: 100%; 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 12px; 
      color: var(--text); 
      font-size: 16px; 
      font-weight: 600;
    }
    .step-title-input:focus { outline: none; border-color: var(--green); }
    .step-desc-input { 
      width: 100%; 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 12px; 
      color: var(--text); 
      font-size: 16px; 
      min-height: 60px; 
      resize: vertical; 
      font-family: inherit; 
    }
    .step-desc-input:focus { outline: none; border-color: var(--green); }
    
    /* Step image - full width on mobile */
    .step-image { width: 100%; }
    .step-image-preview { 
      width: 100%; 
      min-height: 120px; 
      background: var(--bg-card); 
      border: 2px dashed var(--border); 
      border-radius: 10px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      overflow: hidden; 
      position: relative;
    }
    .step-image-preview.has-image { border-style: solid; }
    .step-image-preview img { width: 100%; height: 100%; object-fit: cover; min-height: 120px; }
    .step-image-preview .placeholder { 
      color: var(--text-light); 
      font-size: 12px; 
      text-align: center; 
      padding: 20px;
    }
    .step-image-preview .placeholder i { font-size: 32px; display: block; margin-bottom: 6px; }
    
    .step-image-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .step-image-btn {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .step-image-btn:active { background: var(--green-dim); color: var(--green); border-color: var(--green); }
    .step-image-btn i { font-size: 18px; }
    
    .step-icons { display: flex; gap: 8px; }
    .step-icon-btn { 
      width: 44px; 
      height: 44px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      background: var(--bg-card); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 18px; 
      color: var(--text-muted); 
    }
    .step-icon-btn.active { background: var(--gold); color: #fff; border-color: var(--gold); }
    .step-icon-btn.safety.active { background: var(--danger); border-color: var(--danger); }
    .step-icon-btn.quality.active { background: var(--green); border-color: var(--green); }
    
    .step-action-btn { 
      width: 36px; 
      height: 36px; 
      border: none; 
      border-radius: 8px; 
      background: var(--bg-card); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: var(--text-muted); 
      font-size: 16px; 
    }
    .step-action-btn:active { background: var(--border); }
    .step-action-btn.delete:active { background: var(--danger-dim); color: var(--danger); }

    /* Add step button */
    .add-step-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: 12px;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    .add-step-btn:active { border-color: var(--green); color: var(--green); background: var(--green-dim); }

    /* ===== QR Modal ===== */
    .qr-modal-content { text-align: center; padding: 20px 0; }
    .qr-modal-content img { border-radius: 12px; border: 1px solid var(--border); }
    .qr-url { background: var(--bg); padding: 12px; border-radius: 8px; font-size: 11px; color: var(--text-muted); word-break: break-all; margin-top: 16px; }

    /* ===== View Modal ===== */
    .view-sop-header { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .view-sop-title { font-size: 20px; font-weight: 700; margin-bottom: 10px; color: var(--text); line-height: 1.3; }
    .view-sop-meta { display: flex; gap: 12px; flex-wrap: wrap; }
    .view-sop-meta-item { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
    
    .view-step { 
      display: flex; 
      flex-direction: column;
      gap: 12px;
      padding: 16px; 
      background: var(--bg); 
      border-radius: 12px; 
      margin-bottom: 12px; 
      border-left: 4px solid var(--green); 
    }
    .view-step-header { display: flex; align-items: center; gap: 12px; }
    .view-step-number { width: 36px; height: 36px; background: var(--green); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 15px; flex-shrink: 0; }
    .view-step-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 6px; color: var(--text); flex: 1; }
    .view-step-title .icon.safety { color: var(--danger); }
    .view-step-title .icon.quality { color: var(--green); }
    .view-step-desc { font-size: 14px; color: var(--text-muted); line-height: 1.5; }
    .view-step-image { width: 100%; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
    .view-step-image img { width: 100%; height: auto; display: block; }

    /* ===== Settings Modal ===== */
    .settings-section { margin-bottom: 24px; }
    .settings-section-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .settings-section-title i { color: var(--green); font-size: 18px; }
    .settings-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .settings-item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px 12px; 
      font-size: 13px; 
    }
    .settings-item .item-delete { 
      background: none; 
      border: none; 
      color: var(--text-light); 
      cursor: pointer; 
      padding: 4px; 
      border-radius: 4px; 
      font-size: 16px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-item .item-delete:active { color: var(--danger); background: var(--danger-dim); }
    .settings-add-form { display: flex; gap: 8px; margin-top: 10px; }
    .settings-add-form input { flex: 1; font-size: 16px; }
    .settings-add-btn { 
      background: var(--green); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      width: 44px;
      height: 44px;
      font-size: 20px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    .settings-add-btn:active { background: var(--green-dark); }
    .settings-note { font-size: 11px; color: var(--text-light); margin-top: 8px; }
    .tag-color-picker { display: flex; gap: 6px; align-items: center; }
    .tag-color-option { width: 28px; height: 28px; border-radius: 6px; border: 2px solid transparent; cursor: pointer; }
    .tag-color-option.selected { border-color: var(--text); box-shadow: 0 0 0 2px var(--bg-card); }

    /* ===== Requests Modal ===== */
    .requests-tabs { display: flex; gap: 4px; margin-bottom: 16px; background: var(--bg); padding: 4px; border-radius: 10px; }
    .requests-tab { 
      flex: 1; 
      padding: 12px; 
      border: none; 
      background: transparent; 
      color: var(--text-muted); 
      font-size: 14px; 
      font-weight: 500; 
      border-radius: 8px; 
      cursor: pointer; 
    }
    .requests-tab.active { background: var(--bg-card); color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .requests-tab .tab-count { 
      background: var(--gold-dim); 
      color: var(--gold); 
      padding: 2px 8px; 
      border-radius: 10px; 
      font-size: 11px; 
      margin-left: 6px; 
    }
    .requests-tab.active .tab-count { background: var(--gold); color: #fff; }
    
    .request-list { display: flex; flex-direction: column; gap: 10px; }
    .request-item { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 14px; 
    }
    .request-item.completed { opacity: 0.6; }
    .request-item-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
    .request-item-title { font-weight: 600; color: var(--text); font-size: 14px; flex: 1; }
    .request-item-priority { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; }
    .request-item-priority.high { background: var(--danger-dim); color: var(--danger); }
    .request-item-priority.medium { background: var(--gold-dim); color: var(--gold); }
    .request-item-priority.low { background: var(--green-dim); color: var(--green); }
    .request-item-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; line-height: 1.4; }
    .request-item-meta { display: flex; gap: 12px; font-size: 11px; color: var(--text-light); flex-wrap: wrap; }
    .request-item-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .request-item-actions button { 
      flex: 1;
      padding: 10px; 
      font-size: 12px; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      gap: 4px; 
    }
    .request-action-create { background: var(--green); color: #fff; }
    .request-action-complete { background: var(--gold-dim); color: var(--gold); }
    .request-action-delete { background: var(--danger-dim); color: var(--danger); }
    
    .request-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .request-empty i { font-size: 40px; margin-bottom: 10px; opacity: 0.3; }
    .request-empty p { font-size: 14px; }
    
    .add-request-form { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }

    /* ===== PDF Modal ===== */
    .pdf-layout-options { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
    .pdf-layout-option { cursor: pointer; flex: 1; min-width: 90px; }
    .pdf-layout-option input { display: none; }
    .pdf-layout-card { 
      padding: 12px; 
      border: 2px solid var(--border); 
      border-radius: 10px; 
      text-align: center; 
      background: var(--bg-card); 
    }
    .pdf-layout-option input:checked + .pdf-layout-card { border-color: var(--green); background: var(--green-dim); }
    .pdf-layout-preview { height: 40px; background: var(--bg); border-radius: 4px; margin-bottom: 6px; padding: 6px; display: flex; flex-direction: column; justify-content: center; gap: 2px; }
    .pdf-layout-preview .line { height: 3px; background: var(--border); border-radius: 2px; }
    .pdf-layout-preview .line.short { width: 60%; }
    .pdf-layout-card span { font-size: 11px; color: var(--text-muted); font-weight: 500; }

    /* Language toggle for view modal */
    .lang-toggle { display: flex; background: rgba(255,255,255,0.1); border-radius: 6px; padding: 2px; }
    .lang-toggle button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: transparent; color: var(--header-text); font-size: 12px; font-weight: 600; }
    .lang-toggle button.active { background: var(--green); color: #fff; }

    /* Translation button */
    .translate-btn { 
      background: var(--sungrown-dim); 
      border: 1px solid var(--sungrown); 
      color: var(--sungrown); 
      padding: 10px 14px; 
      border-radius: 8px; 
      font-size: 13px; 
      font-weight: 600; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 6px;
      width: 100%;
      justify-content: center;
      margin-top: 8px;
    }
    .translate-btn:active { background: var(--sungrown); color: #fff; }

    /* AI Improve buttons */
    .ai-improve-btn { 
      background: linear-gradient(135deg, var(--gold) 0%, var(--sungrown) 100%); 
      color: #fff; 
      border: none; 
      padding: 6px 10px; 
      border-radius: 6px; 
      font-size: 11px; 
      font-weight: 600; 
      cursor: pointer; 
      display: inline-flex; 
      align-items: center; 
      gap: 4px; 
    }

    /* Inline add fields */
    .inline-add-btn { 
      width: 44px; 
      height: 44px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      background: var(--bg); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: var(--text-muted); 
      font-size: 18px; 
    }
    .inline-add-btn:active { border-color: var(--green); color: var(--green); background: var(--green-dim); }
    .inline-add-btn.save { background: var(--green); color: #fff; border-color: var(--green); }
    .inline-add-btn.cancel:active { border-color: var(--danger); color: var(--danger); background: var(--danger-dim); }

    /* Request badge */
    .request-badge { 
      background: var(--danger); 
      color: #fff; 
      font-size: 10px; 
      font-weight: 700; 
      padding: 2px 6px; 
      border-radius: 10px; 
    }

    /* Toast */
    .toast { 
      position: fixed; 
      bottom: calc(24px + var(--safe-bottom)); 
      left: 16px;
      right: 16px;
      padding: 14px 20px; 
      border-radius: 12px; 
      color: #fff; 
      font-size: 14px; 
      z-index: 200; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.25); 
      display: none; 
      align-items: center; 
      gap: 10px; 
    }
    .toast.show { display: flex; animation: slideIn 0.3s ease; }
    .toast.success { background: var(--green); }
    .toast.error { background: var(--danger); }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* ===== DESKTOP STYLES ===== */
    @media (min-width: 768px) {
      .header { padding: 14px 24px; }
      .header-logo { height: 38px; }
      .header-title { font-size: 18px; }
      
      /* Show desktop buttons, hide mobile menu */
      .mobile-menu-btn { display: none; }
      .header-btn-primary { display: none; }
      .header-btn { display: flex; }
      .mobile-menu { display: none !important; }
      .menu-overlay { display: none !important; }
      
      .toolbar { flex-direction: row; justify-content: space-between; padding: 14px 24px; }
      .toolbar-row { flex: 1; }
      .filter-row { overflow: visible; }
      
      .content { padding: 24px; }
      
      /* Stats bar - no scroll */
      .stats-bar { overflow: visible; flex-wrap: wrap; }
      .stat-card { min-width: 130px; max-width: 180px; padding: 18px 22px; }
      .stat-card-value { font-size: 32px; }
      
      /* Grid layout for cards */
      .sop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
      .sop-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(45,58,46,0.12); border-color: var(--green); }
      .sop-card:active { transform: translateY(-3px); }
      
      /* Table view for list */
      .sop-list-mobile { display: none; }
      .sop-table { display: block; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
      .sop-table table { width: 100%; border-collapse: collapse; }
      .sop-table th { text-align: left; padding: 14px 18px; background: var(--bg); font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); font-weight: 700; border-bottom: 1px solid var(--border); }
      .sop-table td { padding: 14px 18px; border-bottom: 1px solid var(--border); font-size: 13px; }
      .sop-table tr:last-child td { border-bottom: none; }
      .sop-table tr:hover { background: var(--bg); cursor: pointer; }
      .sop-table .title-cell { font-weight: 600; color: var(--green); }
      .sop-table .actions-cell { display: flex; gap: 6px; }
      .sop-table .actions-cell button { background: var(--bg); border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 14px; }
      .sop-table .actions-cell button:hover { border-color: var(--green); color: var(--green); background: var(--green-dim); }
      
      /* Modal - centered, not full screen */
      .modal { align-items: center; padding: 20px; }
      .modal-box { 
        max-width: 900px; 
        max-height: 90vh; 
        border-radius: 16px; 
        animation: fadeIn 0.2s ease;
      }
      .modal-box.wide { max-width: 1100px; }
      .modal-box.small { max-width: 500px; }
      @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      
      .modal-footer { padding-bottom: 16px; }
      .modal-footer .btn { flex: none; min-width: 120px; }
      
      .form-row { flex-direction: row; }
      
      /* Steps side-by-side layout */
      .step-item { flex-direction: row; gap: 16px; align-items: flex-start; }
      .step-item-header { flex-direction: column; align-items: center; width: auto; }
      .step-item-header .step-actions { flex-direction: column; margin-left: 0; margin-top: 8px; }
      .step-content { flex: 1; }
      .step-image { width: 160px; flex-shrink: 0; }
      .step-image-actions { flex-direction: column; }
      .step-image-btn { justify-content: flex-start; }
      
      /* View modal step layout */
      .view-step { flex-direction: row; align-items: flex-start; }
      .view-step-header { flex-direction: column; width: auto; }
      .view-step-content { flex: 1; }
      .view-step-image { width: 180px; flex-shrink: 0; }
      
      .toast { left: auto; right: 24px; width: auto; max-width: 400px; }
    }

    @media (min-width: 1024px) {
      .sop-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="menu-overlay" id="menuOverlay" onclick="closeMobileMenu()"></div>
  
  <main class="main">
    <header class="header">
      <div class="header-left">
        <img src="https://i.imgur.com/UYEbNiI.png" alt="Rogue Origin" class="header-logo">
        <span class="header-title">SOPs</span>
      </div>
      <div class="header-right">
        <!-- Mobile: hamburger + add button -->
        <button class="header-btn-primary" onclick="openCreateModal()" title="New SOP"><i class="ph-bold ph-plus"></i></button>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()" id="menuBtn"><i class="ph-bold ph-list"></i></button>
        
        <!-- Desktop buttons (hidden on mobile) -->
        <button class="header-btn" onclick="toggleAppLang()"><span id="appLangLabel">EN</span> <i class="ph-duotone ph-translate"></i></button>
        <button class="header-btn" onclick="toggleDarkMode()"><i class="ph-duotone ph-moon"></i> Dark</button>
        <button class="header-btn" onclick="openSettingsModal()"><i class="ph-duotone ph-gear"></i></button>
        <button class="header-btn" onclick="openRequestsModal()" id="requestsBtn"><i class="ph-duotone ph-clipboard-text"></i> Requests <span class="request-badge" id="requestBadge" style="display:none;">0</span></button>
        <button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> New SOP</button>
      </div>
      
      <!-- Mobile dropdown menu -->
      <nav class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-item" onclick="openRequestsModal(); closeMobileMenu();">
          <i class="ph-duotone ph-clipboard-text"></i>
          <span>Requests</span>
          <span class="request-badge" id="requestBadgeMobile" style="display:none;">0</span>
        </div>
        <div class="mobile-menu-item" onclick="openSettingsModal(); closeMobileMenu();">
          <i class="ph-duotone ph-gear"></i>
          <span>Settings</span>
        </div>
        <div class="mobile-menu-divider"></div>
        <div class="mobile-menu-item" onclick="toggleAppLang(); closeMobileMenu();">
          <i class="ph-duotone ph-translate"></i>
          <span id="langMenuLabel">Español</span>
        </div>
        <div class="mobile-menu-item" onclick="toggleDarkMode(); closeMobileMenu();">
          <i class="ph-duotone ph-moon"></i>
          <span id="darkModeLabel">Dark Mode</span>
        </div>
      </nav>
    </header>
    
    <div class="toolbar">
      <div class="toolbar-row">
        <div class="search-box">
          <i class="ph-duotone ph-magnifying-glass"></i>
          <input type="text" id="searchInput" placeholder="Search SOPs..." oninput="filterSOPs()">
        </div>
        <div class="view-toggle">
          <button class="active" onclick="setView('grid')" id="gridViewBtn"><i class="ph-duotone ph-squares-four"></i></button>
          <button onclick="setView('list')" id="listViewBtn"><i class="ph-duotone ph-list"></i></button>
        </div>
      </div>
      <div class="filter-row">
        <select class="filter-select" id="statusFilter" onchange="filterSOPs()">
          <option value="">All SOPs</option>
          <option value="published">Published</option>
          <option value="draft">Drafts</option>
        </select>
        <select class="filter-select" id="deptFilter" onchange="filterSOPs()"></select>
        <select class="filter-select" id="tagFilter" onchange="filterSOPs()"></select>
      </div>
    </div>
    
    <div class="content">
      <div class="stats-bar">
        <div class="stat-card"><div class="stat-card-label">Total</div><div class="stat-card-value gold" id="statTotal">0</div></div>
        <div class="stat-card"><div class="stat-card-label">Published</div><div class="stat-card-value green" id="statPublished">0</div></div>
        <div class="stat-card"><div class="stat-card-label">Drafts</div><div class="stat-card-value sungrown" id="statDrafts">0</div></div>
        <div class="stat-card" onclick="openRequestsModal()"><div class="stat-card-label">Requests</div><div class="stat-card-value danger" id="statRequests">0</div></div>
        <div class="stat-card"><div class="stat-card-label">This Month</div><div class="stat-card-value indoor" id="statMonth">0</div></div>
      </div>
      
      <div class="sop-grid" id="sopGrid"></div>
      
      <div class="sop-list" id="sopList">
        <div class="sop-list-mobile" id="sopListMobile"></div>
        <div class="sop-table"><table><thead><tr><th>Title</th><th>Department</th><th>Steps</th><th>Status</th><th>Updated</th><th>Actions</th></tr></thead><tbody id="sopTableBody"></tbody></table></div>
      </div>
      
      <div class="empty-state" id="emptyState" style="display:none;">
        <i class="ph-duotone ph-files"></i>
        <h3>No SOPs Found</h3>
        <p>Create your first SOP to get started.</p>
        <button class="btn btn-primary" onclick="openCreateModal()" style="background:var(--green);color:#fff;border:none;padding:14px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
          <i class="ph-duotone ph-plus"></i> Create SOP
        </button>
      </div>
    </div>
  </main>

  <!-- Edit/Create Modal -->
  <div class="modal" id="editModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2 id="modalTitle"><i class="ph-duotone ph-file-text"></i> Create New SOP</h2>
        <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">SOP Title *</label>
          <input type="text" class="form-input" id="sopTitle" placeholder="e.g., Trimming Machine Setup">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Department *</label>
            <div style="display:flex;gap:8px;">
              <select class="form-input" id="sopDept" style="flex:1;"></select>
              <button type="button" class="inline-add-btn" onclick="showInlineAdd('dept')" title="Add"><i class="ph-bold ph-plus"></i></button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-input" id="sopStatus">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
        </div>
        
        <div class="inline-add-field" id="inlineAddDept" style="display:none;margin-bottom:16px;">
          <div style="display:flex;gap:8px;">
            <input type="text" class="form-input" id="newDeptInline" placeholder="New department..." style="flex:1;">
            <button type="button" class="inline-add-btn save" onclick="addDeptInline()"><i class="ph-bold ph-check"></i></button>
            <button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('dept')"><i class="ph-bold ph-x"></i></button>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Document Number</label>
            <input type="text" class="form-input" id="sopDocNum" placeholder="SOP-001">
          </div>
          <div class="form-group">
            <label class="form-label">Revision</label>
            <input type="text" class="form-input" id="sopRevision" value="1.0">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="sopDesc" placeholder="Brief description..."></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div id="editTagsList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>
        
        <button class="translate-btn" onclick="autoTranslateSOP()" id="autoTranslateBtn">
          <i class="ph-duotone ph-translate"></i>
          <span id="translateBtnText">Auto-translate to Español</span>
        </button>
        
        <div class="steps-section">
          <div class="steps-header">
            <h3><i class="ph-duotone ph-list-numbers"></i> Steps</h3>
          </div>
          <div class="steps-list" id="stepsList"></div>
          <button class="add-step-btn" onclick="addStep()">
            <i class="ph-duotone ph-plus"></i> Add Step
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
        <button class="btn btn-secondary" onclick="saveSOP('draft')"><i class="ph-duotone ph-floppy-disk"></i> Draft</button>
        <button class="btn btn-primary" onclick="saveSOP('published')"><i class="ph-duotone ph-check-circle"></i> Publish</button>
      </div>
    </div>
  </div>

  <!-- View Modal -->
  <div class="modal" id="viewModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-eye"></i> View SOP</h2>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="lang-toggle" id="viewLangToggle">
            <button class="active" onclick="setViewLang('en')">EN</button>
            <button onclick="setViewLang('es')">ES</button>
          </div>
          <button class="modal-close" onclick="closeModal('viewModal')">&times;</button>
        </div>
      </div>
      <div class="modal-body" id="viewModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('viewModal')">Close</button>
        <button class="btn btn-secondary" onclick="openModal('pdfModal')"><i class="ph-duotone ph-file-pdf"></i> PDF</button>
        <button class="btn btn-primary" onclick="editCurrentSOP()"><i class="ph-duotone ph-pencil-simple"></i> Edit</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-qr-code"></i> QR Code</h2>
        <button class="modal-close" onclick="closeModal('qrModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="qr-modal-content">
          <img id="qrImage" width="200" height="200">
          <p style="margin-top:16px;color:var(--text-muted);font-size:13px;">Scan to view this SOP</p>
          <div class="qr-url" id="qrUrl"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('qrModal')">Close</button>
        <button class="btn btn-primary" onclick="downloadQR()"><i class="ph-duotone ph-download"></i> Download</button>
      </div>
    </div>
  </div>

  <!-- PDF Modal -->
  <div class="modal" id="pdfModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-file-pdf"></i> Export PDF</h2>
        <button class="modal-close" onclick="closeModal('pdfModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Layout</label>
          <div class="pdf-layout-options">
            <label class="pdf-layout-option">
              <input type="radio" name="pdfLayout" value="text">
              <div class="pdf-layout-card">
                <div class="pdf-layout-preview"><div class="line"></div><div class="line"></div><div class="line short"></div></div>
                <span>Text Only</span>
              </div>
            </label>
            <label class="pdf-layout-option">
              <input type="radio" name="pdfLayout" value="2col" checked>
              <div class="pdf-layout-card">
                <div class="pdf-layout-preview"><div class="line"></div><div class="line short"></div></div>
                <span>2 Per Page</span>
              </div>
            </label>
            <label class="pdf-layout-option">
              <input type="radio" name="pdfLayout" value="4col">
              <div class="pdf-layout-card">
                <div class="pdf-layout-preview"><div class="line short"></div><div class="line short"></div></div>
                <span>4 Per Page</span>
              </div>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Options</label>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <label style="display:flex;align-items:center;gap:8px;font-size:14px;">
              <input type="checkbox" id="pdfIncludeQR" checked> Include QR Code
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:14px;">
              <input type="checkbox" id="pdfBilingual"> Bilingual (EN + ES)
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Language</label>
          <div style="display:flex;gap:16px;">
            <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
              <input type="radio" name="pdfLang" value="en" checked> English
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
              <input type="radio" name="pdfLang" value="es"> Español
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('pdfModal')">Cancel</button>
        <button class="btn btn-primary" onclick="generatePDF()"><i class="ph-duotone ph-file-pdf"></i> Generate</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-gear"></i> Settings</h2>
        <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-buildings"></i> Departments</div>
          <div class="settings-list" id="settingsDeptList"></div>
          <div class="settings-add-form">
            <input type="text" class="form-input" id="newDeptInput" placeholder="New department...">
            <button class="settings-add-btn" onclick="addDepartment()"><i class="ph-bold ph-plus"></i></button>
          </div>
          <div class="settings-note">At least one department required</div>
        </div>
        
        <div class="settings-section">
          <div class="settings-section-title"><i class="ph-duotone ph-tag"></i> Tags</div>
          <div class="settings-list" id="settingsTagList"></div>
          <div class="settings-add-form">
            <input type="text" class="form-input" id="newTagInput" placeholder="New tag...">
            <div class="tag-color-picker">
              <div class="tag-color-option gold selected" style="background:var(--gold)" data-color="gold" onclick="selectTagColor('gold')"></div>
              <div class="tag-color-option green" style="background:var(--green)" data-color="green" onclick="selectTagColor('green')"></div>
              <div class="tag-color-option sungrown" style="background:var(--sungrown)" data-color="sungrown" onclick="selectTagColor('sungrown')"></div>
              <div class="tag-color-option indoor" style="background:var(--indoor)" data-color="indoor" onclick="selectTagColor('indoor')"></div>
              <div class="tag-color-option danger" style="background:var(--danger)" data-color="danger" onclick="selectTagColor('danger')"></div>
            </div>
            <button class="settings-add-btn" onclick="addTag()"><i class="ph-bold ph-plus"></i></button>
          </div>
          <div class="settings-note">At least one tag required</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeModal('settingsModal')"><i class="ph-duotone ph-check"></i> Done</button>
      </div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div class="modal" id="requestsModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-clipboard-text"></i> SOP Requests</h2>
        <button class="modal-close" onclick="closeModal('requestsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="requests-tabs">
          <button class="requests-tab active" onclick="setRequestTab('pending')" id="tabPending">Pending <span class="tab-count" id="pendingCount">0</span></button>
          <button class="requests-tab" onclick="setRequestTab('completed')" id="tabCompleted">Done <span class="tab-count" id="completedCount">0</span></button>
        </div>
        
        <div class="add-request-form" id="addRequestForm">
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">New Request</label>
            <input type="text" class="form-input" id="reqTitle" placeholder="What SOP is needed?">
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Department</label>
              <select class="form-input" id="reqDept"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Priority</label>
              <select class="form-input" id="reqPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" onclick="addRequest()" style="width:100%;background:var(--green);color:#fff;border:none;padding:14px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
            <i class="ph-duotone ph-plus"></i> Add Request
          </button>
        </div>
        
        <div class="request-list" id="requestList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('requestsModal')">Close</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><i class="ph-duotone ph-check-circle"></i><span id="toastMsg"></span></div>

  <script>
    // ===== DATA =====
    let sops = [];
    let currentSopId = null;
    let editingSteps = [];
    let selectedTagColor = 'gold';
    let settings = {
      departments: [
        { name: 'Production', icon: 'ph-factory' },
        { name: 'Packaging', icon: 'ph-package' },
        { name: 'Quality', icon: 'ph-seal-check' },
        { name: 'Maintenance', icon: 'ph-wrench' }
      ],
      tags: [
        { name: 'safety', color: 'danger' },
        { name: 'quality', color: 'green' },
        { name: 'critical', color: 'gold' }
      ]
    };
    let viewLang = 'en';
    let appLang = 'en';
    let sopRequests = [];
    let currentRequestTab = 'pending';

    // ===== MOBILE MENU =====
    function toggleMobileMenu() {
      const menu = document.getElementById('mobileMenu');
      const overlay = document.getElementById('menuOverlay');
      const isOpen = menu.classList.contains('active');
      menu.classList.toggle('active', !isOpen);
      overlay.classList.toggle('active', !isOpen);
    }
    
    function closeMobileMenu() {
      document.getElementById('mobileMenu').classList.remove('active');
      document.getElementById('menuOverlay').classList.remove('active');
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      loadFromStorage();
      renderSOPs();
      updateStats();
      updateDropdowns();
      
      if (localStorage.getItem('sopDarkMode') === 'true') {
        document.body.classList.add('dark-mode');
        updateDarkModeLabel();
      }
      
      const v = new URLSearchParams(window.location.search).get('view');
      if (v) setTimeout(() => viewSOP(parseInt(v)), 500);
    });

    // ===== STORAGE =====
    function loadFromStorage() {
      const s = localStorage.getItem('rogueOriginSOPs');
      if (s) sops = JSON.parse(s);
      else {
        sops = [
          { id: 1, title: 'Trimming Machine Daily Startup', dept: 'Production', docNum: 'SOP-PRD-001', revision: '2.1', status: 'published', description: 'Standard procedure for starting the trimming machine.', tags: ['safety', 'critical'], steps: [{ title: 'Safety Check', description: 'Verify all safety guards.', image: '', safety: true, quality: false }, { title: 'Power On', description: 'Turn on main power.', image: '', safety: false, quality: false }], createdAt: '2024-12-01', updatedAt: '2024-12-20' },
          { id: 2, title: 'Package Sealing Procedure', dept: 'Packaging', docNum: 'SOP-PKG-003', revision: '1.0', status: 'published', description: 'Proper sealing for shipping.', tags: ['quality'], steps: [{ title: 'Prepare Package', description: 'Check weight.', image: '', safety: false, quality: true }], createdAt: '2024-12-10', updatedAt: '2024-12-15' },
          { id: 3, title: 'Daily Equipment Cleaning', dept: 'Maintenance', docNum: 'SOP-MNT-002', revision: '1.2', status: 'draft', description: 'End of day cleaning.', tags: ['safety'], steps: [{ title: 'Power Down', description: 'Turn off equipment.', image: '', safety: true, quality: false }], createdAt: '2024-12-05', updatedAt: '2024-12-22' }
        ];
        saveToStorage();
      }
      const r = localStorage.getItem('rogueOriginSOPRequests');
      if (r) sopRequests = JSON.parse(r);
      updateRequestBadge();
    }
    
    function saveToStorage() {
      localStorage.setItem('rogueOriginSOPs', JSON.stringify(sops));
      localStorage.setItem('rogueOriginSOPRequests', JSON.stringify(sopRequests));
    }
    
    function loadSettings() {
      const s = localStorage.getItem('sopSettings');
      if (s) {
        const p = JSON.parse(s);
        if (p.departments) settings.departments = p.departments;
        if (p.tags) settings.tags = p.tags;
      }
    }
    
    function saveSettings() {
      localStorage.setItem('sopSettings', JSON.stringify(settings));
      updateDropdowns();
    }

    // ===== RENDER =====
    function renderSOPs() {
      const se = document.getElementById('searchInput').value.toLowerCase();
      const st = document.getElementById('statusFilter').value;
      const de = document.getElementById('deptFilter').value;
      const ta = document.getElementById('tagFilter').value;
      
      let f = sops.filter(s => {
        const ms = s.title.toLowerCase().includes(se) || s.description.toLowerCase().includes(se) || s.docNum.toLowerCase().includes(se);
        return ms && (!st || s.status === st) && (!de || s.dept === de) && (!ta || s.tags.includes(ta));
      });
      
      const g = document.getElementById('sopGrid');
      const lm = document.getElementById('sopListMobile');
      const lt = document.getElementById('sopTableBody');
      
      if (f.length === 0) {
        g.innerHTML = '';
        lm.innerHTML = '';
        lt.innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
      } else {
        document.getElementById('emptyState').style.display = 'none';
        
        // Grid view
        g.innerHTML = f.map(s => {
          const th = s.tags.map(t => {
            const tc = settings.tags.find(x => x.name === t) || { color: 'gold' };
            return '<span class="sop-tag ' + tc.color + '">' + t + '</span>';
          }).join('');
          return `<div class="sop-card" onclick="viewSOP(${s.id})">
            <div class="sop-card-header">
              <div>
                <div class="sop-card-title">${esc(s.title)}</div>
                <div class="sop-card-dept"><i class="ph-duotone ph-folder"></i> ${s.dept}</div>
              </div>
              <div class="sop-card-rev ${s.status === 'draft' ? 'draft' : ''}">${s.status === 'draft' ? 'DRAFT' : 'v' + s.revision}</div>
            </div>
            <div class="sop-card-preview">${s.steps[0]?.image ? '<img src="' + s.steps[0].image + '">' : '<div class="sop-card-preview-empty"><i class="ph-duotone ph-image"></i>' + s.steps.length + ' steps</div>'}</div>
            <div class="sop-card-meta">
              <div class="sop-card-steps"><i class="ph-duotone ph-list-numbers"></i> ${s.steps.length}</div>
              <div class="sop-card-tags">${th}</div>
            </div>
            <div class="sop-card-actions" onclick="event.stopPropagation()">
              <button onclick="viewSOP(${s.id})"><i class="ph-duotone ph-eye"></i></button>
              <button onclick="editSOP(${s.id})"><i class="ph-duotone ph-pencil-simple"></i></button>
              <button class="qr-btn" onclick="showQR(${s.id})"><i class="ph-duotone ph-qr-code"></i></button>
              <button class="del-btn" onclick="deleteSOP(${s.id})"><i class="ph-duotone ph-trash"></i></button>
            </div>
          </div>`;
        }).join('');
        
        // Mobile list view
        lm.innerHTML = f.map(s => `
          <div class="sop-list-item" onclick="viewSOP(${s.id})">
            <div class="sop-list-info">
              <div class="sop-list-title">${esc(s.title)}</div>
              <div class="sop-list-meta">${s.dept} • ${s.steps.length} steps</div>
            </div>
            <div class="sop-list-badge ${s.status === 'draft' ? 'draft' : ''}">${s.status === 'draft' ? 'Draft' : 'v' + s.revision}</div>
          </div>
        `).join('');
        
        // Desktop table view
        lt.innerHTML = f.map(s => `
          <tr onclick="viewSOP(${s.id})">
            <td class="title-cell">${esc(s.title)}</td>
            <td>${s.dept}</td>
            <td>${s.steps.length}</td>
            <td>${s.status === 'draft' ? '<span style="color:var(--gold)">Draft</span>' : '<span style="color:var(--green)">Published</span>'}</td>
            <td>${fmtDate(s.updatedAt)}</td>
            <td class="actions-cell" onclick="event.stopPropagation()">
              <button onclick="editSOP(${s.id})"><i class="ph-duotone ph-pencil-simple"></i></button>
              <button onclick="showQR(${s.id})"><i class="ph-duotone ph-qr-code"></i></button>
              <button onclick="deleteSOP(${s.id})"><i class="ph-duotone ph-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }
    }
    
    function updateStats() {
      const t = sops.length;
      const p = sops.filter(s => s.status === 'published').length;
      const d = t - p;
      const m = sops.filter(s => {
        const x = new Date(s.updatedAt);
        const n = new Date();
        return x.getMonth() === n.getMonth() && x.getFullYear() === n.getFullYear();
      }).length;
      const r = sopRequests.filter(x => !x.completed).length;
      
      document.getElementById('statTotal').textContent = t;
      document.getElementById('statPublished').textContent = p;
      document.getElementById('statDrafts').textContent = d;
      document.getElementById('statMonth').textContent = m;
      document.getElementById('statRequests').textContent = r;
    }
    
    function updateDropdowns() {
      document.getElementById('deptFilter').innerHTML = '<option value="">All Depts</option>' + settings.departments.map(d => '<option value="' + d.name + '">' + d.name + '</option>').join('');
      document.getElementById('sopDept').innerHTML = '<option value="">Select...</option>' + settings.departments.map(d => '<option value="' + d.name + '">' + d.name + '</option>').join('');
      document.getElementById('tagFilter').innerHTML = '<option value="">All Tags</option>' + settings.tags.map(t => '<option value="' + t.name + '">' + t.name + '</option>').join('');
      document.getElementById('reqDept').innerHTML = settings.departments.map(d => '<option value="' + d.name + '">' + d.name + '</option>').join('');
      renderEditTags();
    }
    
    function renderEditTags() {
      document.getElementById('editTagsList').innerHTML = settings.tags.map(t => 
        '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="tag_' + t.name + '"><span class="sop-tag ' + t.color + '">' + t.name + '</span></label>'
      ).join('');
    }

    // ===== VIEW TOGGLE =====
    function setView(v) {
      document.getElementById('gridViewBtn').classList.toggle('active', v === 'grid');
      document.getElementById('listViewBtn').classList.toggle('active', v === 'list');
      document.getElementById('sopGrid').classList.toggle('hidden', v === 'list');
      document.getElementById('sopList').classList.toggle('active', v === 'list');
    }
    
    function filterSOPs() { renderSOPs(); }

    // ===== MODALS =====
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    function openCreateModal() {
      currentSopId = null;
      editingSteps = [{ title: '', description: '', image: '', safety: false, quality: false }];
      document.getElementById('modalTitle').innerHTML = '<i class="ph-duotone ph-file-text"></i> Create New SOP';
      document.getElementById('sopTitle').value = '';
      document.getElementById('sopDept').value = '';
      document.getElementById('sopDocNum').value = 'SOP-' + String(sops.length + 1).padStart(3, '0');
      document.getElementById('sopRevision').value = '1.0';
      document.getElementById('sopStatus').value = 'draft';
      document.getElementById('sopDesc').value = '';
      settings.tags.forEach(t => {
        const c = document.getElementById('tag_' + t.name);
        if (c) c.checked = false;
      });
      renderSteps();
      openModal('editModal');
    }
    
    function editSOP(id) {
      const s = sops.find(x => x.id === id);
      if (!s) return;
      currentSopId = id;
      editingSteps = JSON.parse(JSON.stringify(s.steps));
      document.getElementById('modalTitle').innerHTML = '<i class="ph-duotone ph-pencil-simple"></i> Edit SOP';
      document.getElementById('sopTitle').value = s.title;
      document.getElementById('sopDept').value = s.dept;
      document.getElementById('sopDocNum').value = s.docNum;
      document.getElementById('sopRevision').value = s.revision;
      document.getElementById('sopStatus').value = s.status;
      document.getElementById('sopDesc').value = s.description;
      settings.tags.forEach(t => {
        const c = document.getElementById('tag_' + t.name);
        if (c) c.checked = s.tags.includes(t.name);
      });
      renderSteps();
      openModal('editModal');
    }
    
    function viewSOP(id) {
      const s = sops.find(x => x.id === id);
      if (!s) return;
      currentSopId = id;
      viewLang = 'en';
      document.querySelectorAll('#viewLangToggle button').forEach(b => b.classList.toggle('active', b.textContent === 'EN'));
      renderViewSOP(s);
      openModal('viewModal');
    }
    
    function renderViewSOP(s) {
      if (!s) return;
      const title = s['title_' + viewLang] || s.title;
      const desc = s['desc_' + viewLang] || s.description;
      
      const stepsHtml = s.steps.map((st, i) => {
        const stepTitle = st['title_' + viewLang] || st.title;
        const stepDesc = st['desc_' + viewLang] || st.description;
        return `<div class="view-step">
          <div class="view-step-header">
            <div class="view-step-number">${i + 1}</div>
            <div class="view-step-title">${esc(stepTitle)}${st.safety ? ' <i class="ph-duotone ph-warning icon safety"></i>' : ''}${st.quality ? ' <i class="ph-duotone ph-seal-check icon quality"></i>' : ''}</div>
          </div>
          <div class="view-step-desc">${esc(stepDesc)}</div>
          ${st.image ? '<div class="view-step-image"><img src="' + st.image + '"></div>' : ''}
        </div>`;
      }).join('');
      
      document.getElementById('viewModalBody').innerHTML = `
        <div class="view-sop-header">
          <div class="view-sop-title">${esc(title)}</div>
          <div class="view-sop-meta">
            <div class="view-sop-meta-item"><i class="ph-duotone ph-folder"></i> ${s.dept}</div>
            <div class="view-sop-meta-item"><i class="ph-duotone ph-hash"></i> ${s.docNum}</div>
            <div class="view-sop-meta-item"><i class="ph-duotone ph-git-branch"></i> Rev ${s.revision}</div>
            <div class="view-sop-meta-item"><i class="ph-duotone ph-calendar"></i> ${fmtDate(s.updatedAt)}</div>
          </div>
          ${desc ? '<p style="margin-top:12px;color:var(--text-muted)">' + esc(desc) + '</p>' : ''}
        </div>
        ${stepsHtml}
      `;
    }
    
    function setViewLang(lang) {
      viewLang = lang;
      document.querySelectorAll('#viewLangToggle button').forEach(b => b.classList.toggle('active', b.textContent === lang.toUpperCase()));
      const s = sops.find(x => x.id === currentSopId);
      if (s) renderViewSOP(s);
    }
    
    function editCurrentSOP() {
      closeModal('viewModal');
      editSOP(currentSopId);
    }

    // ===== STEPS =====
    function renderSteps() {
      document.getElementById('stepsList').innerHTML = editingSteps.map((s, i) => `
        <div class="step-item">
          <div class="step-item-header">
            <div class="step-number">${i + 1}</div>
            <div class="step-actions">
              <button class="step-action-btn" onclick="moveStep(${i}, -1)"><i class="ph-bold ph-caret-up"></i></button>
              <button class="step-action-btn" onclick="moveStep(${i}, 1)"><i class="ph-bold ph-caret-down"></i></button>
              <button class="step-action-btn delete" onclick="removeStep(${i})"><i class="ph-bold ph-trash"></i></button>
            </div>
          </div>
          <div class="step-content">
            <input type="text" class="step-title-input" placeholder="Step title..." value="${esc(s.title)}" onchange="updateStep(${i}, 'title', this.value)">
            <textarea class="step-desc-input" placeholder="Description..." onchange="updateStep(${i}, 'description', this.value)">${esc(s.description)}</textarea>
            <div class="step-icons">
              <button class="step-icon-btn safety ${s.safety ? 'active' : ''}" onclick="toggleIcon(${i}, 'safety')"><i class="ph-duotone ph-warning"></i></button>
              <button class="step-icon-btn quality ${s.quality ? 'active' : ''}" onclick="toggleIcon(${i}, 'quality')"><i class="ph-duotone ph-seal-check"></i></button>
            </div>
          </div>
          <div class="step-image">
            <div class="step-image-preview ${s.image ? 'has-image' : ''}">
              ${s.image ? '<img src="' + s.image + '">' : '<div class="placeholder"><i class="ph-duotone ph-camera"></i>Tap to add photo</div>'}
            </div>
            <div class="step-image-actions">
              <button class="step-image-btn" onclick="triggerCamera(${i})"><i class="ph-duotone ph-camera"></i> Camera</button>
              <button class="step-image-btn" onclick="triggerGallery(${i})"><i class="ph-duotone ph-image"></i> Gallery</button>
              ${s.image ? '<button class="step-image-btn" onclick="clearStepImage(' + i + ')"><i class="ph-duotone ph-x"></i></button>' : ''}
            </div>
            <input type="file" id="cam${i}" accept="image/*" capture="environment" style="display:none" onchange="handleImg(${i}, this)">
            <input type="file" id="gal${i}" accept="image/*" style="display:none" onchange="handleImg(${i}, this)">
          </div>
        </div>
      `).join('');
    }
    
    function addStep() {
      editingSteps.push({ title: '', description: '', image: '', safety: false, quality: false });
      renderSteps();
      // Scroll to new step
      setTimeout(() => {
        const steps = document.querySelectorAll('.step-item');
        if (steps.length) steps[steps.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
    
    function removeStep(i) {
      if (editingSteps.length <= 1) { showToast('Need at least 1 step', 'error'); return; }
      editingSteps.splice(i, 1);
      renderSteps();
    }
    
    function moveStep(i, dir) {
      const ni = i + dir;
      if (ni < 0 || ni >= editingSteps.length) return;
      [editingSteps[i], editingSteps[ni]] = [editingSteps[ni], editingSteps[i]];
      renderSteps();
    }
    
    function updateStep(i, field, value) { editingSteps[i][field] = value; }
    function toggleIcon(i, type) { editingSteps[i][type] = !editingSteps[i][type]; renderSteps(); }
    
    function triggerCamera(i) { document.getElementById('cam' + i).click(); }
    function triggerGallery(i) { document.getElementById('gal' + i).click(); }
    
    function handleImg(i, inp) {
      const f = inp.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = e => { editingSteps[i].image = e.target.result; renderSteps(); };
      r.readAsDataURL(f);
    }
    
    function clearStepImage(i) { editingSteps[i].image = ''; renderSteps(); }

    // ===== SAVE =====
    function saveSOP(status) {
      const title = document.getElementById('sopTitle').value.trim();
      const dept = document.getElementById('sopDept').value;
      if (!title) { showToast('Enter title', 'error'); return; }
      if (!dept) { showToast('Select department', 'error'); return; }
      if (editingSteps.length === 0 || !editingSteps[0].title) { showToast('Add at least one step', 'error'); return; }
      
      const tags = settings.tags.filter(t => document.getElementById('tag_' + t.name)?.checked).map(t => t.name);
      const now = new Date().toISOString().split('T')[0];
      
      const sop = {
        id: currentSopId || Date.now(),
        title,
        dept,
        docNum: document.getElementById('sopDocNum').value || 'SOP-' + String(sops.length + 1).padStart(3, '0'),
        revision: document.getElementById('sopRevision').value || '1.0',
        status,
        description: document.getElementById('sopDesc').value,
        tags,
        steps: editingSteps,
        createdAt: currentSopId ? sops.find(s => s.id === currentSopId)?.createdAt || now : now,
        updatedAt: now
      };
      
      if (currentSopId) {
        const idx = sops.findIndex(s => s.id === currentSopId);
        if (idx !== -1) sops[idx] = sop;
      } else {
        sops.push(sop);
      }
      
      saveToStorage();
      renderSOPs();
      updateStats();
      closeModal('editModal');
      showToast(status === 'published' ? 'Published!' : 'Saved!', 'success');
    }
    
    function deleteSOP(id) {
      if (!confirm('Delete this SOP?')) return;
      sops = sops.filter(s => s.id !== id);
      saveToStorage();
      renderSOPs();
      updateStats();
      showToast('Deleted', 'success');
    }

    // ===== QR =====
    function showQR(id) {
      const s = sops.find(x => x.id === id);
      if (!s) return;
      currentSopId = id;
      const url = 'https://rogueff.github.io/rogue-origin-apps/sop-manager.html?view=' + id;
      document.getElementById('qrImage').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(url);
      document.getElementById('qrUrl').textContent = url;
      openModal('qrModal');
    }
    
    function downloadQR() {
      const img = document.getElementById('qrImage');
      const a = document.createElement('a');
      a.href = img.src;
      a.download = 'sop-qr-' + currentSopId + '.png';
      a.click();
    }

    // ===== PDF =====
    function generatePDF() {
      const s = sops.find(x => x.id === currentSopId);
      if (!s) return;
      showToast('Generating PDF...', 'success');
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.setTextColor(45, 58, 46);
      doc.text(s.title, 20, 30);
      
      doc.setFontSize(12);
      doc.setTextColor(90, 107, 95);
      doc.text(s.dept + ' | ' + s.docNum + ' | Rev ' + s.revision, 20, 40);
      
      if (s.description) {
        doc.setFontSize(11);
        doc.text(doc.splitTextToSize(s.description, 170), 20, 50);
      }
      
      let y = s.description ? 65 : 50;
      s.steps.forEach((step, i) => {
        if (y > 260) { doc.addPage(); y = 20; }
        doc.setFontSize(12);
        doc.setTextColor(102, 137, 113);
        doc.text((i + 1) + '. ' + step.title, 20, y);
        y += 8;
        if (step.description) {
          doc.setFontSize(10);
          doc.setTextColor(90, 107, 95);
          const lines = doc.splitTextToSize(step.description, 170);
          doc.text(lines, 25, y);
          y += lines.length * 5 + 5;
        }
        y += 5;
      });
      
      doc.save(s.docNum + '.pdf');
      closeModal('pdfModal');
    }

    // ===== SETTINGS =====
    function openSettingsModal() {
      renderSettingsDepts();
      renderSettingsTags();
      openModal('settingsModal');
    }
    
    function renderSettingsDepts() {
      document.getElementById('settingsDeptList').innerHTML = settings.departments.map(d => 
        '<div class="settings-item"><i class="ph-duotone ' + (d.icon || 'ph-folder') + '"></i><span>' + d.name + '</span><button class="item-delete" onclick="deleteDepartment(\'' + d.name + '\')"><i class="ph-bold ph-x"></i></button></div>'
      ).join('');
    }
    
    function renderSettingsTags() {
      document.getElementById('settingsTagList').innerHTML = settings.tags.map(t => 
        '<div class="settings-item"><span class="sop-tag ' + t.color + '">' + t.name + '</span><button class="item-delete" onclick="deleteTag(\'' + t.name + '\')"><i class="ph-bold ph-x"></i></button></div>'
      ).join('');
    }
    
    function addDepartment() {
      const i = document.getElementById('newDeptInput');
      const n = i.value.trim();
      if (!n) return;
      if (settings.departments.find(d => d.name.toLowerCase() === n.toLowerCase())) { showToast('Exists', 'error'); return; }
      settings.departments.push({ name: n, icon: 'ph-folder' });
      saveSettings();
      renderSettingsDepts();
      i.value = '';
      showToast('Added', 'success');
    }
    
    function deleteDepartment(n) {
      if (settings.departments.length <= 1) { showToast('Need at least 1', 'error'); return; }
      settings.departments = settings.departments.filter(d => d.name !== n);
      saveSettings();
      renderSettingsDepts();
    }
    
    function selectTagColor(c) {
      selectedTagColor = c;
      document.querySelectorAll('.tag-color-option').forEach(e => e.classList.toggle('selected', e.dataset.color === c));
    }
    
    function addTag() {
      const i = document.getElementById('newTagInput');
      const n = i.value.trim().toLowerCase();
      if (!n) return;
      if (settings.tags.find(t => t.name === n)) { showToast('Exists', 'error'); return; }
      settings.tags.push({ name: n, color: selectedTagColor });
      saveSettings();
      renderSettingsTags();
      renderEditTags();
      i.value = '';
      showToast('Added', 'success');
    }
    
    function deleteTag(n) {
      if (settings.tags.length <= 1) { showToast('Need at least 1', 'error'); return; }
      settings.tags = settings.tags.filter(t => t.name !== n);
      saveSettings();
      renderSettingsTags();
      renderEditTags();
    }
    
    // Inline add
    function showInlineAdd(type) {
      document.getElementById('inlineAdd' + (type === 'dept' ? 'Dept' : 'Tag')).style.display = 'block';
    }
    function hideInlineAdd(type) {
      document.getElementById('inlineAdd' + (type === 'dept' ? 'Dept' : 'Tag')).style.display = 'none';
      document.getElementById('new' + (type === 'dept' ? 'Dept' : 'Tag') + 'Inline').value = '';
    }
    function addDeptInline() {
      const i = document.getElementById('newDeptInline');
      const n = i.value.trim();
      if (!n) return;
      if (settings.departments.find(d => d.name.toLowerCase() === n.toLowerCase())) { showToast('Exists', 'error'); return; }
      settings.departments.push({ name: n, icon: 'ph-folder' });
      saveSettings();
      document.getElementById('sopDept').value = n;
      hideInlineAdd('dept');
      showToast('Added', 'success');
    }

    // ===== REQUESTS =====
    function openRequestsModal() {
      renderRequests();
      openModal('requestsModal');
    }
    
    function setRequestTab(tab) {
      currentRequestTab = tab;
      document.getElementById('tabPending').classList.toggle('active', tab === 'pending');
      document.getElementById('tabCompleted').classList.toggle('active', tab === 'completed');
      document.getElementById('addRequestForm').style.display = tab === 'pending' ? 'block' : 'none';
      renderRequests();
    }
    
    function renderRequests() {
      const pending = sopRequests.filter(r => !r.completed);
      const completed = sopRequests.filter(r => r.completed);
      const list = currentRequestTab === 'pending' ? pending : completed;
      
      document.getElementById('pendingCount').textContent = pending.length;
      document.getElementById('completedCount').textContent = completed.length;
      
      if (list.length === 0) {
        document.getElementById('requestList').innerHTML = '<div class="request-empty"><i class="ph-duotone ph-clipboard"></i><p>' + (currentRequestTab === 'pending' ? 'No pending requests' : 'No completed requests') + '</p></div>';
        return;
      }
      
      document.getElementById('requestList').innerHTML = list.map(r => `
        <div class="request-item ${r.completed ? 'completed' : ''}">
          <div class="request-item-header">
            <div class="request-item-title">${esc(r.title)}</div>
            <div class="request-item-priority ${r.priority}">${r.priority}</div>
          </div>
          ${r.notes ? '<div class="request-item-desc">' + esc(r.notes) + '</div>' : ''}
          <div class="request-item-meta">
            <span><i class="ph-duotone ph-folder"></i> ${r.dept}</span>
            <span><i class="ph-duotone ph-calendar"></i> ${fmtDate(r.createdAt)}</span>
          </div>
          <div class="request-item-actions">
            ${!r.completed ? `
              <button class="request-action-create" onclick="createFromRequest(${r.id})"><i class="ph-duotone ph-plus"></i> Create</button>
              <button class="request-action-complete" onclick="completeRequest(${r.id})"><i class="ph-duotone ph-check"></i> Done</button>
            ` : ''}
            <button class="request-action-delete" onclick="deleteRequest(${r.id})"><i class="ph-duotone ph-trash"></i></button>
          </div>
        </div>
      `).join('');
    }
    
    function addRequest() {
      const title = document.getElementById('reqTitle').value.trim();
      if (!title) { showToast('Enter title', 'error'); return; }
      sopRequests.push({
        id: Date.now(),
        title,
        dept: document.getElementById('reqDept').value,
        priority: document.getElementById('reqPriority').value,
        notes: '',
        createdAt: new Date().toISOString().split('T')[0],
        completed: false
      });
      saveToStorage();
      document.getElementById('reqTitle').value = '';
      renderRequests();
      updateStats();
      updateRequestBadge();
      showToast('Request added', 'success');
    }
    
    function completeRequest(id) {
      const r = sopRequests.find(x => x.id === id);
      if (r) r.completed = true;
      saveToStorage();
      renderRequests();
      updateStats();
      updateRequestBadge();
    }
    
    function deleteRequest(id) {
      sopRequests = sopRequests.filter(r => r.id !== id);
      saveToStorage();
      renderRequests();
      updateStats();
      updateRequestBadge();
    }
    
    function createFromRequest(id) {
      const r = sopRequests.find(x => x.id === id);
      if (!r) return;
      closeModal('requestsModal');
      openCreateModal();
      document.getElementById('sopTitle').value = r.title;
      document.getElementById('sopDept').value = r.dept;
    }
    
    function updateRequestBadge() {
      const count = sopRequests.filter(r => !r.completed).length;
      const badges = [document.getElementById('requestBadge'), document.getElementById('requestBadgeMobile')];
      badges.forEach(b => {
        if (b) {
          b.textContent = count;
          b.style.display = count > 0 ? 'inline' : 'none';
        }
      });
    }

    // ===== TRANSLATION =====
    async function translateText(text, from, to) {
      if (!text || text.trim() === '') return '';
      try {
        const langPair = from + '|' + to;
        const response = await fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=' + langPair);
        const data = await response.json();
        if (data.responseStatus === 200 && data.responseData) {
          return data.responseData.translatedText;
        }
        return text;
      } catch (e) {
        return text;
      }
    }
    
    async function autoTranslateSOP() {
      const btn = document.getElementById('autoTranslateBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="ph-duotone ph-spinner"></i> Translating...';
      
      try {
        const title = document.getElementById('sopTitle').value;
        const desc = document.getElementById('sopDesc').value;
        
        // Translate main content
        window.sopTranslations = {
          title_en: title,
          title_es: await translateText(title, 'en', 'es'),
          desc_en: desc,
          desc_es: await translateText(desc, 'en', 'es')
        };
        
        // Translate steps
        for (let step of editingSteps) {
          if (step.title) {
            step.title_en = step.title;
            step.title_es = await translateText(step.title, 'en', 'es');
          }
          if (step.description) {
            step.desc_en = step.description;
            step.desc_es = await translateText(step.description, 'en', 'es');
          }
        }
        
        showToast('Translated!', 'success');
      } catch (e) {
        showToast('Translation failed', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '<i class="ph-duotone ph-translate"></i><span>Auto-translate to Español</span>';
    }

    // ===== DARK MODE & LANG =====
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('sopDarkMode', document.body.classList.contains('dark-mode'));
      updateDarkModeLabel();
    }
    
    function updateDarkModeLabel() {
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('darkModeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }
    
    function toggleAppLang() {
      appLang = appLang === 'en' ? 'es' : 'en';
      document.getElementById('appLangLabel').textContent = appLang.toUpperCase();
      document.getElementById('langMenuLabel').textContent = appLang === 'en' ? 'Español' : 'English';
    }

    // ===== UTILS =====
    function esc(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function fmtDate(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function showToast(msg, type) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMsg').textContent = msg;
      toast.className = 'toast show ' + type;
      toast.querySelector('i').className = type === 'success' ? 'ph-duotone ph-check-circle' : 'ph-duotone ph-warning-circle';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
