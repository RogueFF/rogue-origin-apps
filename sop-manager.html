<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SOP Manager">
  <title>SOP Manager - Rogue Origin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      /* Brand Colors - from Style Sheet */
      --gold: #e4aa4f;
      --gold-light: #f0cb60;
      --gold-dim: rgba(228,170,79,0.12);
      --green: #668971;
      --green-light: #7a9d86;
      --green-dim: rgba(102,137,113,0.12);
      --green-dark: #4a6b54;
      
      /* Secondary Brand Colors */
      --sungrown: #bf8e4e;
      --sungrown-dim: rgba(191,142,78,0.12);
      --greenhouse: #8f9263;
      --greenhouse-dim: rgba(143,146,99,0.12);
      --indoor: #62758d;
      --indoor-dim: rgba(98,117,141,0.12);
      
      /* Semantic */
      --danger: #c45c4a;
      --danger-dim: rgba(196,92,74,0.12);
      
      /* Light Mode - Warm Brand Feel */
      --bg: #faf8f4;
      --bg-warm: #f3efe7;
      --bg-card: #ffffff;
      --bg-dark: #2d3a2e;
      --border: #e4ddd0;
      --border-light: rgba(102,137,113,0.15);
      --text: #2d3a2e;
      --text-muted: #5a6b5f;
      --text-light: #94a397;
      
      /* Header */
      --header-bg: #2d3a2e;
      --header-text: #faf8f4;
    }
    
    body.dark-mode {
      --bg: #1a1f16;
      --bg-warm: #22291e;
      --bg-card: #252b22;
      --border: rgba(228,170,79,0.2);
      --border-light: rgba(228,170,79,0.1);
      --text: #e8e4dc;
      --text-muted: #a8b5a9;
      --text-light: #6b7a6f;
      --gold-dim: rgba(228,170,79,0.18);
      --green-dim: rgba(102,137,113,0.18);
      --sungrown-dim: rgba(191,142,78,0.18);
      --greenhouse-dim: rgba(143,146,99,0.18);
      --indoor-dim: rgba(98,117,141,0.18);
      --header-bg: #12160f;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    
    /* Subtle texture overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
    }
    
    .main { min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }

    /* Header - Dark brand header */
    .header { 
      background: var(--header-bg); 
      padding: 14px 24px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      border-bottom: 3px solid var(--gold);
      position: sticky; 
      top: 0; 
      z-index: 40;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-logo { height: 38px; }
    .header-title { font-size: 18px; font-weight: 600; color: var(--header-text); letter-spacing: -0.3px; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    .header-btn { 
      background: rgba(255,255,255,0.08); 
      color: var(--header-text); 
      border: 1px solid rgba(255,255,255,0.15); 
      padding: 8px 14px; 
      border-radius: 8px; 
      font-weight: 500; 
      font-size: 13px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      transition: all 0.2s; 
    }
    .header-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.25); }
    .header-btn.primary { background: var(--gold); color: var(--header-bg); border-color: var(--gold); font-weight: 600; }
    .header-btn.primary:hover { background: var(--gold-light); }
    
    .dark-mode-toggle { 
      background: rgba(255,255,255,0.08); 
      border: 1px solid rgba(255,255,255,0.15); 
      border-radius: 8px; 
      padding: 8px 12px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      font-size: 13px; 
      color: var(--header-text); 
    }
    .dark-mode-toggle:hover { background: rgba(255,255,255,0.15); }
    body.dark-mode .dark-mode-toggle { background: var(--gold-dim); border-color: var(--gold); color: var(--gold); }

    /* Toolbar */
    .toolbar { 
      background: var(--bg-card); 
      padding: 14px 24px; 
      border-bottom: 1px solid var(--border); 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .toolbar-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .toolbar-right { display: flex; align-items: center; gap: 8px; }
    
    .search-box { position: relative; width: 240px; }
    .search-box input { 
      width: 100%;
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px 12px 10px 38px; 
      color: var(--text); 
      font-size: 13px; 
    }
    .search-box input:focus { outline: none; border-color: var(--green); background: var(--bg-card); }
    .search-box input::placeholder { color: var(--text-light); }
    .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
    
    .filter-select { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px 12px; 
      color: var(--text); 
      font-size: 13px; 
      cursor: pointer;
      min-width: 130px;
    }
    .filter-select:focus { outline: none; border-color: var(--green); }
    
    .view-toggle { display: flex; background: var(--bg); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
    .view-toggle button { 
      padding: 7px 12px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      background: transparent; 
      color: var(--text-muted);
      font-size: 16px;
    }
    .view-toggle button.active { background: var(--green); color: #fff; }

    /* Content */
    .content { padding: 24px; flex: 1; background: var(--bg); }
    
    /* Stats Bar */
    .stats-bar { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
    .stat-card { 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 18px 22px; 
      min-width: 130px;
      flex: 1;
      max-width: 180px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      border-top: 3px solid var(--border);
    }
    .stat-card:nth-child(1) { border-top-color: var(--gold); }
    .stat-card:nth-child(2) { border-top-color: var(--green); }
    .stat-card:nth-child(3) { border-top-color: var(--sungrown); }
    .stat-card:nth-child(4) { border-top-color: var(--indoor); }
    .stat-card-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-light); margin-bottom: 6px; font-weight: 600; }
    .stat-card-value { font-size: 32px; font-weight: 700; }
    .stat-card-value.gold { color: var(--gold); }
    .stat-card-value.danger { color: var(--danger); }
    .stat-card-value.green { color: var(--green); }
    .stat-card-value.sungrown { color: var(--sungrown); }
    .stat-card-value.indoor { color: var(--indoor); }

    /* SOP Grid */
    .sop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    
    .sop-card { 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      overflow: hidden; 
      transition: all 0.2s;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .sop-card:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 24px rgba(45,58,46,0.12); 
      border-color: var(--green); 
    }
    
    .sop-card-header { padding: 16px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; background: linear-gradient(to bottom, var(--bg-card), var(--bg)); }
    .sop-card-title { font-size: 15px; font-weight: 600; margin-bottom: 5px; line-height: 1.3; color: var(--text); }
    .sop-card-dept { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
    .sop-card-rev { background: var(--green); color: #fff; font-size: 10px; font-weight: 600; padding: 4px 10px; border-radius: 6px; white-space: nowrap; }
    .sop-card-rev.draft { background: var(--gold); color: var(--header-bg); }
    
    .sop-card-preview { height: 100px; background: var(--bg-warm); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sop-card-preview img { width: 100%; height: 100%; object-fit: cover; }
    .sop-card-preview-empty { color: var(--text-light); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 12px; }
    .sop-card-preview-empty i { font-size: 28px; opacity: 0.5; }
    
    .sop-card-meta { padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
    .sop-card-steps { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 5px; font-weight: 500; }
    .sop-card-tags { display: flex; gap: 5px; flex-wrap: wrap; }
    .sop-tag { background: var(--gold-dim); color: var(--gold); font-size: 9px; font-weight: 700; padding: 3px 7px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
    .sop-tag.danger { background: var(--danger-dim); color: var(--danger); }
    .sop-tag.green { background: var(--green-dim); color: var(--green); }
    .sop-tag.sungrown { background: var(--sungrown-dim); color: var(--sungrown); }
    .sop-tag.greenhouse { background: var(--greenhouse-dim); color: var(--greenhouse); }
    .sop-tag.indoor, .sop-tag.blue { background: var(--indoor-dim); color: var(--indoor); }
    .sop-tag.purple { background: rgba(139,92,246,0.12); color: #8b5cf6; }
    
    .sop-card-actions { display: flex; border-top: 1px solid var(--border); background: var(--bg-card); }
    .sop-card-actions button { 
      flex: 1; 
      background: transparent; 
      border: none; 
      border-right: 1px solid var(--border); 
      padding: 12px; 
      cursor: pointer; 
      color: var(--text-muted);
      transition: all 0.15s;
      font-size: 15px;
    }
    .sop-card-actions button:last-child { border-right: none; }
    .sop-card-actions button:hover { background: var(--green-dim); color: var(--green); }
    .sop-card-actions button.qr-btn:hover { background: var(--gold-dim); color: var(--gold); }
    .sop-card-actions button.del-btn:hover { background: var(--danger-dim); color: var(--danger); }

    /* List View */
    .sop-list { display: none; }
    .sop-list.active { display: block; }
    .sop-grid.hidden { display: none; }
    
    .sop-table { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .sop-table table { width: 100%; border-collapse: collapse; }
    .sop-table th { text-align: left; padding: 14px 18px; background: var(--bg); font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); font-weight: 700; border-bottom: 1px solid var(--border); }
    .sop-table td { padding: 14px 18px; border-bottom: 1px solid var(--border); font-size: 13px; }
    .sop-table tr:last-child td { border-bottom: none; }
    .sop-table tr:hover { background: var(--bg); cursor: pointer; }
    .sop-table .title-cell { font-weight: 600; color: var(--green); }
    .sop-table .actions-cell { display: flex; gap: 6px; }
    .sop-table .actions-cell button { background: var(--bg); border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 14px; }
    .sop-table .actions-cell button:hover { border-color: var(--green); color: var(--green); background: var(--green-dim); }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state i { font-size: 64px; margin-bottom: 16px; color: var(--green); opacity: 0.4; }
    .empty-state h3 { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
    .empty-state p { margin-bottom: 20px; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(26,31,22,0.6); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100; backdrop-filter: blur(4px); }
    .modal.active { display: flex; }
    
    .modal-box { background: var(--bg-card); border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-box.wide { max-width: 1100px; }
    .modal-box.small { max-width: 500px; }
    
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--header-bg); }
    .modal-header h2 { font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--header-text); }
    .modal-close { background: rgba(255,255,255,0.1); border: none; color: var(--header-text); font-size: 20px; cursor: pointer; padding: 6px 10px; border-radius: 6px; line-height: 1; }
    .modal-close:hover { background: rgba(255,255,255,0.2); }
    
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; background: var(--bg-card); }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg); }
    
    .modal-footer .header-btn { 
      background: var(--bg-card); 
      color: var(--text-muted); 
      border: 1px solid var(--border); 
    }
    .modal-footer .header-btn:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }
    .modal-footer .header-btn.primary { background: var(--green); color: #fff; border-color: var(--green); }
    .modal-footer .header-btn.primary:hover { background: var(--green-dark); }

    /* Inline Add Controls */
    .inline-add-btn { width: 38px; height: 38px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 16px; flex-shrink: 0; }
    .inline-add-btn:hover { border-color: var(--green); color: var(--green); background: var(--green-dim); }
    .inline-add-btn.save { background: var(--green); color: #fff; border-color: var(--green); }
    .inline-add-btn.save:hover { background: var(--green-dark); }
    .inline-add-btn.cancel { background: var(--bg); }
    .inline-add-btn.cancel:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-dim); }
    .inline-add-btn[title*="Delete"] { color: var(--text-light); }
    .inline-add-btn[title*="Delete"]:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-dim); }
    .tag-color-picker-mini { display: flex; gap: 4px; }
    .tag-color-picker-mini .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .tag-color-picker-mini .color-dot:hover { transform: scale(1.15); }
    .tag-color-picker-mini .color-dot.selected { border-color: var(--text); }
    .tag-item { display: flex; align-items: center; gap: 4px; }
    .tag-item .tag-delete { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 12px; padding: 2px; border-radius: 3px; opacity: 0.6; }
    .tag-item .tag-delete:hover { color: var(--danger); opacity: 1; }
    .add-tag-btn { background: var(--bg); border: 1px dashed var(--border); border-radius: 6px; padding: 3px 10px; font-size: 11px; color: var(--text-light); cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .add-tag-btn:hover { border-color: var(--green); color: var(--green); border-style: solid; }

    /* Form */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text); font-size: 14px; }
    .form-input:focus { outline: none; border-color: var(--green); background: var(--bg-card); }
    textarea.form-input { min-height: 80px; resize: vertical; font-family: inherit; }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

    /* Steps */
    .steps-section { margin-top: 24px; }
    .steps-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .steps-header h3 { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .steps-list { display: flex; flex-direction: column; gap: 12px; }
    
    .step-item { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; display: flex; gap: 16px; }
    .step-item:hover { border-color: var(--green); }
    .step-number { width: 32px; height: 32px; background: var(--green); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; }
    .step-content { flex: 1; min-width: 0; }
    .step-title-input { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: var(--text); font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .step-title-input:focus { outline: none; border-color: var(--green); }
    .step-desc-input { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: var(--text); font-size: 13px; min-height: 50px; resize: vertical; font-family: inherit; }
    .step-desc-input:focus { outline: none; border-color: var(--green); }
    
    .step-image { width: 140px; flex-shrink: 0; }
    .step-image-preview { width: 100%; height: 120px; background: var(--bg-card); border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; }
    .step-image-preview:hover { border-color: var(--gold); background: var(--gold-dim); }
    .step-image-preview.has-image { border-style: solid; }
    .step-image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .step-image-preview .placeholder { color: var(--text-light); font-size: 10px; text-align: center; }
    .step-image-preview .placeholder i { font-size: 20px; display: block; margin-bottom: 4px; }
    
    .step-icons { display: flex; gap: 6px; margin-top: 8px; }
    .step-icon-btn { width: 30px; height: 30px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--text-muted); }
    .step-icon-btn:hover { border-color: var(--gold); color: var(--gold); }
    .step-icon-btn.active { background: var(--gold); color: #fff; border-color: var(--gold); }
    .step-icon-btn.safety.active { background: var(--danger); border-color: var(--danger); }
    .step-icon-btn.quality.active { background: var(--green); border-color: var(--green); }
    
    .step-actions { display: flex; flex-direction: column; gap: 4px; }
    .step-action-btn { width: 30px; height: 30px; border: none; border-radius: 6px; background: var(--bg-card); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 14px; }
    .step-action-btn:hover { background: var(--border); }
    .step-action-btn.delete:hover { background: var(--danger-dim); color: var(--danger); }

    /* QR Modal */
    .qr-modal-content { text-align: center; padding: 20px; }
    .qr-url { background: var(--bg); padding: 12px; border-radius: 8px; font-size: 11px; color: var(--text-muted); word-break: break-all; margin-top: 16px; }

    /* View Modal */
    .view-sop-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .view-sop-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
    .view-sop-meta { display: flex; gap: 16px; flex-wrap: wrap; }
    .view-sop-meta-item { font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
    .view-sop-qr { width: 90px; height: 90px; background: #fff; border-radius: 8px; padding: 6px; flex-shrink: 0; border: 1px solid var(--border); }
    
    .view-step { display: flex; gap: 16px; padding: 18px; background: var(--bg); border-radius: 10px; margin-bottom: 12px; border-left: 4px solid var(--green); }
    .view-step-number { width: 40px; height: 40px; background: var(--green); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; flex-shrink: 0; }
    .view-step-content { flex: 1; }
    .view-step-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .view-step-title .icon.safety { color: var(--danger); }
    .view-step-title .icon.quality { color: var(--green); }
    .view-step-desc { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
    .view-step-image { width: 160px; height: 100px; border-radius: 8px; overflow: hidden; flex-shrink: 0; border: 2px solid var(--border); }
    .view-step-image img { width: 100%; height: 100%; object-fit: cover; }

    /* Settings */
    .settings-section { margin-bottom: 28px; }
    .settings-section-title { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .settings-section-title i { color: var(--green); font-size: 18px; }
    .settings-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .settings-item { display: flex; align-items: center; gap: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 13px; }
    .settings-item:hover { border-color: var(--green); }
    .settings-item .item-delete { background: none; border: none; color: var(--text-light); cursor: pointer; padding: 2px; border-radius: 4px; font-size: 14px; }
    .settings-item .item-delete:hover { color: var(--danger); background: var(--danger-dim); }
    .settings-add-form { display: flex; gap: 8px; margin-top: 12px; }
    .settings-add-form input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 13px; color: var(--text); }
    .settings-add-form input:focus { outline: none; border-color: var(--green); }
    .settings-add-btn { background: var(--green); color: white; border: none; border-radius: 8px; padding: 10px 14px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .settings-add-btn:hover { background: var(--green-dark); }
    .settings-note { font-size: 11px; color: var(--text-light); margin-top: 8px; }
    .tag-color-picker { display: flex; gap: 6px; align-items: center; }
    .tag-color-option { width: 24px; height: 24px; border-radius: 6px; border: 2px solid transparent; cursor: pointer; }
    .tag-color-option:hover { transform: scale(1.1); }
    .tag-color-option.selected { border-color: var(--text); box-shadow: 0 0 0 2px var(--bg-card); }
    .tag-color-option.gold { background: var(--gold); }
    .tag-color-option.green { background: var(--green); }
    .tag-color-option.danger { background: var(--danger); }
    .tag-color-option.sungrown { background: var(--sungrown); }
    .tag-color-option.greenhouse { background: var(--greenhouse); }
    .tag-color-option.indoor { background: var(--indoor); }

    /* Translation */
    .lang-toggle { display: flex; background: var(--bg); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
    .lang-toggle button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 600; }
    .lang-toggle button.active { background: var(--green); color: #fff; }
    .lang-toggle button:hover:not(.active) { background: var(--bg-warm); }
    .translate-btn { background: var(--sungrown-dim); border: 1px solid var(--sungrown); color: var(--sungrown); padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .translate-btn:hover { background: var(--sungrown); color: #fff; }
    .translate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .translation-notice { background: var(--sungrown-dim); border: 1px solid var(--sungrown); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--sungrown); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .pdf-layout-options { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .pdf-layout-option { cursor: pointer; }
    .pdf-layout-option input { display: none; }
    .pdf-layout-card { width: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 10px; text-align: center; transition: all 0.2s; background: var(--bg-card); }
    .pdf-layout-card:hover { border-color: var(--green); }
    .pdf-layout-option input:checked + .pdf-layout-card { border-color: var(--green); background: var(--green-dim); }
    .pdf-layout-preview { height: 50px; background: var(--bg); border-radius: 4px; margin-bottom: 8px; padding: 6px; display: flex; flex-direction: column; justify-content: center; gap: 3px; }
    .pdf-layout-preview .line { height: 4px; background: var(--border); border-radius: 2px; }
    .pdf-layout-preview .line.short { width: 60%; }
    .pdf-layout-preview.grid-preview { display: grid; gap: 4px; align-content: center; }
    .pdf-layout-preview.grid-preview.cols-1 { grid-template-columns: 1fr; }
    .pdf-layout-preview.grid-preview.cols-2 { grid-template-columns: 1fr 1fr; }
    .pdf-layout-preview .box { background: var(--green); opacity: 0.3; border-radius: 2px; min-height: 16px; }
    .pdf-layout-card span { font-size: 11px; color: var(--text-muted); font-weight: 500; }
    .lang-badge { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: var(--indoor-dim); color: var(--indoor); text-transform: uppercase; }

    /* Request Badge */
    .request-badge { background: var(--danger); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 10px; margin-left: 4px; }
    
    /* AI Generate Modal */
    .ai-gen-checkbox { display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s; }
    .ai-gen-checkbox:hover { border-color:var(--gold);background:var(--gold-dim); }
    .ai-gen-checkbox input { width:18px;height:18px;accent-color:var(--gold); }
    .ai-gen-checkbox input:checked + span { color:var(--gold);font-weight:500; }
    .ai-gen-checkbox span { display:flex;align-items:center;gap:8px;font-size:13px; }
    .ai-gen-checkbox span i { font-size:16px; }
    .ai-gen-spinner { width:50px;height:50px;border:4px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .ai-gen-result { background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px;transition:all 0.2s; }
    .ai-gen-result:hover { border-color:var(--gold); }
    .ai-gen-result.selected { border-color:var(--green);background:var(--green-dim); }
    .ai-gen-result-header { display:flex;align-items:flex-start;gap:12px; }
    .ai-gen-result-header input { width:20px;height:20px;accent-color:var(--green);flex-shrink:0;margin-top:2px; }
    .ai-gen-result-title { font-weight:600;margin-bottom:4px; }
    .ai-gen-result-meta { font-size:12px;color:var(--text-muted); }
    .ai-gen-result-steps { font-size:11px;color:var(--text-light);margin-top:8px;padding-top:8px;border-top:1px solid var(--border); }
    
    /* AI Improve Button */
    .ai-improve-btn { background: linear-gradient(135deg, var(--gold) 0%, var(--sungrown) 100%); color: #fff; border: none; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; margin-left: 8px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; }
    .ai-improve-btn:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(228,170,79,0.4); }
    .ai-improve-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .ai-improve-btn.loading { animation: pulse 1s infinite; }
    .ai-improve-btn i { font-size: 12px; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    .step-ai-btn { background: linear-gradient(135deg, var(--gold) 0%, var(--sungrown) 100%); color: #fff; border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .step-ai-btn:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(228,170,79,0.4); }
    .step-ai-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .step-ai-btn i { font-size: 14px; }
    
    .settings-api-key { background: var(--bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
    
    /* Language Switch */
    .lang-switch { background: var(--gold); color: #fff; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .lang-switch:hover { background: var(--gold-light); transform: scale(1.05); }
    .lang-switch i { font-size: 16px; }
    
    /* Requests Modal */
    .requests-tabs { display: flex; gap: 4px; margin-bottom: 16px; background: var(--bg); padding: 4px; border-radius: 10px; }
    .requests-tab { flex: 1; padding: 10px 16px; border: none; background: transparent; color: var(--text-muted); font-size: 13px; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .requests-tab:hover { background: var(--bg-card); }
    .requests-tab.active { background: var(--bg-card); color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .requests-tab .tab-count { background: var(--gold-dim); color: var(--gold); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 6px; }
    .requests-tab.active .tab-count { background: var(--gold); color: #fff; }
    
    .request-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
    .request-item { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 14px; transition: all 0.2s; }
    .request-item:hover { border-color: var(--green); }
    .request-item.completed { opacity: 0.6; }
    .request-item-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 8px; }
    .request-item-title { font-weight: 600; color: var(--text); font-size: 14px; flex: 1; }
    .request-item-priority { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; }
    .request-item-priority.high { background: var(--danger-dim); color: var(--danger); }
    .request-item-priority.medium { background: var(--gold-dim); color: var(--gold); }
    .request-item-priority.low { background: var(--green-dim); color: var(--green); }
    .request-item-desc { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; line-height: 1.5; }
    .request-item-meta { display: flex; gap: 16px; font-size: 11px; color: var(--text-light); flex-wrap: wrap; align-items: center; }
    .request-item-meta i { margin-right: 4px; }
    .request-item-actions { display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    .request-item-actions button { padding: 6px 12px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
    .request-action-create { background: var(--green); color: #fff; }
    .request-action-create:hover { background: var(--green-dark); }
    .request-action-complete { background: var(--gold-dim); color: var(--gold); }
    .request-action-complete:hover { background: var(--gold); color: #fff; }
    .request-action-delete { background: var(--danger-dim); color: var(--danger); }
    .request-action-delete:hover { background: var(--danger); color: #fff; }
    .request-action-edit { background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); }
    .request-action-edit:hover { border-color: var(--green); color: var(--green); }
    
    .request-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .request-empty i { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
    .request-empty p { font-size: 14px; }
    
    .add-request-form { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .add-request-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .add-request-form .form-input { font-size: 13px; padding: 10px 12px; }
    .add-request-form .form-label { font-size: 11px; margin-bottom: 4px; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; border-radius: 10px; color: #fff; font-size: 14px; z-index: 200; box-shadow: 0 4px 20px rgba(0,0,0,0.25); display: none; align-items: center; gap: 10px; }
    .toast.show { display: flex; animation: slideIn 0.3s ease; }
    .toast.success { background: var(--green); }
    .toast.error { background: var(--danger); }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .sop-grid { grid-template-columns: 1fr; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .step-item { flex-direction: column; }
      .step-image { width: 100%; }
      .toolbar-left { width: 100%; }
      .search-box { width: 100%; }
    }
    
    /* iPad Optimization (768px - 1024px) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .sop-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .header { padding: 16px 20px; }
      .header-title { font-size: 16px; }
      .content { padding: 20px; }
      .stats-bar { gap: 12px; }
      .stat-card { padding: 14px 16px; }
      .toolbar { padding: 14px 20px; gap: 12px; flex-wrap: wrap; }
      .modal-box { max-height: 90vh; }
      .modal-box.wide { width: 95%; max-width: 800px; }
      .form-input, .filter-select { font-size: 16px !important; padding: 14px 16px; } /* Prevents iOS zoom */
      .step-item { gap: 12px; }
      .step-content { flex: 1; }
      .step-title-input, .step-desc-input { font-size: 16px !important; padding: 14px; }
      .step-image { width: 140px; min-height: 140px; }
      .step-image-preview { min-height: 120px; }
      .step-actions { flex-direction: column; gap: 8px; }
      .step-action-btn, .step-ai-btn { width: 44px; height: 44px; } /* Larger touch targets */
      .step-icon-btn { width: 44px; height: 44px; }
      .header-btn { padding: 12px 18px; font-size: 14px; }
      .header-btn.primary { padding: 12px 20px; }
      .inline-add-btn { width: 44px; height: 44px; }
      .modal-close { width: 44px; height: 44px; font-size: 28px; }
      .sop-card-actions button { width: 44px; height: 44px; }
    }
    
    /* iPad Pro and larger tablets */
    @media (min-width: 1024px) and (max-width: 1366px) {
      .sop-grid { grid-template-columns: repeat(3, 1fr); }
      .modal-box.wide { width: 90%; max-width: 900px; }
    }
    
    /* Touch device optimizations */
    @media (pointer: coarse) {
      .header-btn, .inline-add-btn, .step-action-btn, .step-ai-btn, .step-icon-btn, 
      .sop-card-actions button, .settings-add-btn, .request-item-actions button {
        min-height: 44px;
        min-width: 44px;
      }
      .sop-card { cursor: pointer; }
      .sop-card:active { transform: scale(0.98); }
      .step-image-preview:active { opacity: 0.8; }
      .form-input:focus, .filter-select:focus { font-size: 16px; } /* Prevent zoom on iOS */
    }
    
    /* Camera button styles */
    .step-image-actions { display: flex; flex-direction: row; gap: 4px; position: absolute; bottom: 6px; left: 6px; right: 6px; flex-wrap: wrap; justify-content: center; }
    .step-image-btn { background: rgba(0,0,0,0.7); color: #fff; border: none; padding: 6px 10px; border-radius: 6px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap; transition: all 0.2s; backdrop-filter: blur(4px); position: relative; }
    .step-image-btn:hover, .step-image-btn:active { background: var(--green); }
    .step-image-btn i { font-size: 12px; }
    .step-image-preview { position: relative; overflow: hidden; }
    .step-image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .step-image-preview .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 100px; color: var(--text-light); cursor: pointer; }
    .step-image-preview .placeholder i { font-size: 28px; margin-bottom: 4px; }
    
    /* Custom tooltips */
    [data-tooltip] { position: relative; }
    [data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-dark); color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 11px; white-space: nowrap; z-index: 100; margin-bottom: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    [data-tooltip]:hover::before { content: ''; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--bg-dark); margin-bottom: -6px; z-index: 100; }
    
    /* Landscape mode adjustments for iPad */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .modal-box { max-height: 85vh; }
      .modal-body { max-height: 60vh; overflow-y: auto; }
      .steps-list { max-height: 40vh; overflow-y: auto; }
    }
  </style>
</head>
<body>
  <main class="main">
    <header class="header">
      <div class="header-left">
        <img src="https://i.imgur.com/UYEbNiI.png" alt="Rogue Origin" class="header-logo">
        <span class="header-title">Standard Operating Procedures</span>
      </div>
      <div class="header-right">
        <button class="lang-switch" onclick="toggleAppLang()" title="Switch Language"><span id="appLangLabel">EN</span> <i class="ph-duotone ph-translate"></i></button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()"><i class="ph-duotone ph-moon"></i><span data-i18n="dark">Dark</span></button>
        <button class="header-btn" onclick="openSettingsModal()"><i class="ph-duotone ph-gear"></i></button>
        <button class="header-btn" onclick="openRequestsModal()" id="requestsBtn"><i class="ph-duotone ph-clipboard-text"></i> <span data-i18n="requests">Requests</span> <span class="request-badge" id="requestBadge" style="display:none;">0</span></button>
        <button class="header-btn" onclick="openAIGenerateModal()" style="background:linear-gradient(135deg,rgba(228,170,79,0.15),rgba(102,137,113,0.15));border-color:var(--gold);"><i class="ph-duotone ph-robot"></i> <span>AI Generate</span></button>
        <button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> <span data-i18n="newSop">New SOP</span></button>
      </div>
    </header>
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box"><i class="ph-duotone ph-magnifying-glass"></i><input type="text" id="searchInput" placeholder="Search SOPs..." oninput="filterSOPs()"></div>
        <select class="filter-select" id="statusFilter" onchange="filterSOPs()"><option value="">All SOPs</option><option value="published">Published</option><option value="draft">Drafts</option></select>
        <select class="filter-select" id="deptFilter" onchange="filterSOPs()"></select>
        <select class="filter-select" id="tagFilter" onchange="filterSOPs()"></select>
      </div>
      <div class="toolbar-right">
        <div class="view-toggle">
          <button class="active" onclick="setView('grid')" id="gridViewBtn"><i class="ph-duotone ph-squares-four"></i></button>
          <button onclick="setView('list')" id="listViewBtn"><i class="ph-duotone ph-list"></i></button>
        </div>
      </div>
    </div>
    <div class="content">
      <div class="stats-bar">
        <div class="stat-card"><div class="stat-card-label">Total</div><div class="stat-card-value gold" id="statTotal">0</div></div>
        <div class="stat-card"><div class="stat-card-label">Published</div><div class="stat-card-value green" id="statPublished">0</div></div>
        <div class="stat-card"><div class="stat-card-label">Drafts</div><div class="stat-card-value sungrown" id="statDrafts">0</div></div>
        <div class="stat-card" style="cursor:pointer;" onclick="openRequestsModal()"><div class="stat-card-label">Requests</div><div class="stat-card-value danger" id="statRequests">0</div></div>
        <div class="stat-card"><div class="stat-card-label">This Month</div><div class="stat-card-value indoor" id="statMonth">0</div></div>
      </div>
      <div class="sop-grid" id="sopGrid"></div>
      <div class="sop-list" id="sopList"><div class="sop-table"><table><thead><tr><th>Title</th><th>Department</th><th>Steps</th><th>Status</th><th>Updated</th><th>Actions</th></tr></thead><tbody id="sopTableBody"></tbody></table></div></div>
      <div class="empty-state" id="emptyState" style="display:none;"><i class="ph-duotone ph-files"></i><h3>No SOPs Found</h3><p>Create your first SOP to get started.</p><button class="header-btn primary" onclick="openCreateModal()"><i class="ph-duotone ph-plus"></i> Create SOP</button></div>
    </div>
  </main>
  <div class="modal" id="editModal"><div class="modal-box wide"><div class="modal-header"><h2 id="modalTitle"><i class="ph-duotone ph-file-text"></i> Create New SOP</h2><button class="modal-close" onclick="closeModal('editModal')">&times;</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label class="form-label">SOP Title * <button type="button" class="ai-improve-btn" onclick="aiImproveTitle()" title="AI Improve"><i class="ph-duotone ph-sparkle"></i> Improve</button></label><input type="text" class="form-input" id="sopTitle" placeholder="e.g., Trimming Machine Setup"></div><div class="form-group"><label class="form-label">Department *</label><div style="display:flex;gap:8px;"><select class="form-input" id="sopDept" style="flex:1;"></select><button type="button" class="inline-add-btn" onclick="showInlineAdd('dept')" title="Add Department"><i class="ph-duotone ph-plus"></i></button><button type="button" class="inline-add-btn" onclick="deleteCurrentDept()" title="Delete Selected Department"><i class="ph-duotone ph-trash"></i></button></div><div class="inline-add-field" id="inlineAddDept" style="display:none;margin-top:8px;"><div style="display:flex;gap:8px;"><input type="text" class="form-input" id="newDeptInline" placeholder="New department..." style="flex:1;" onkeypress="if(event.key==='Enter'){addDeptInline();event.preventDefault();}"><button type="button" class="inline-add-btn save" onclick="addDeptInline()"><i class="ph-duotone ph-check"></i></button><button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('dept')"><i class="ph-duotone ph-x"></i></button></div></div></div></div><div class="form-group" style="background:var(--bg);padding:14px;border-radius:10px;border:1px solid var(--border);"><label class="form-label" style="margin-bottom:10px;">Writing Language</label><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;"><div class="lang-toggle" id="editLangToggle"><button class="active" onclick="setEditLang('en')">English</button><button onclick="setEditLang('es')">Español</button></div><button type="button" class="translate-btn" id="autoTranslateBtn" onclick="autoTranslateSOP()"><i class="ph-duotone ph-translate"></i> <span id="translateBtnText">Auto-translate to Español</span></button><span style="font-size:11px;color:var(--text-light);">Creates both language versions</span></div></div><div class="form-row-3"><div class="form-group"><label class="form-label">Document Number</label><input type="text" class="form-input" id="sopDocNum" placeholder="SOP-001"></div><div class="form-group"><label class="form-label">Revision</label><input type="text" class="form-input" id="sopRevision" value="1.0"></div><div class="form-group"><label class="form-label">Status</label><select class="form-input" id="sopStatus"><option value="draft">Draft</option><option value="published">Published</option></select></div></div><div class="form-group"><label class="form-label">Description <button type="button" class="ai-improve-btn" onclick="aiImproveDescription()" title="AI Improve"><i class="ph-duotone ph-sparkle"></i> Improve</button></label><textarea class="form-input" id="sopDesc" placeholder="Brief description..."></textarea></div><div class="form-group"><label class="form-label">Tags</label><div id="editTagsList" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;"></div><div class="inline-add-field" id="inlineAddTag" style="display:none;margin-top:10px;"><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;"><input type="text" class="form-input" id="newTagInline" placeholder="New tag..." style="width:140px;" onkeypress="if(event.key==='Enter'){addTagInline();event.preventDefault();}"><div class="tag-color-picker-mini" id="inlineTagColors"></div><button type="button" class="inline-add-btn save" onclick="addTagInline()"><i class="ph-duotone ph-check"></i></button><button type="button" class="inline-add-btn cancel" onclick="hideInlineAdd('tag')"><i class="ph-duotone ph-x"></i></button></div></div></div><div class="steps-section"><div class="steps-header"><h3><i class="ph-duotone ph-list-numbers"></i> Steps</h3><div style="display:flex;gap:8px;"><button class="ai-improve-btn" id="aiImproveAllBtn" onclick="aiImproveAllSteps()" style="padding:6px 12px;"><i class="ph-duotone ph-sparkle"></i> AI Improve All</button><button class="header-btn" style="background:var(--bg);color:var(--text-muted);border:1px solid var(--border);" onclick="addStep()"><i class="ph-duotone ph-plus"></i> Add</button></div></div><div class="steps-list" id="stepsList"></div></div></div><div class="modal-footer"><button class="header-btn" onclick="closeModal('editModal')">Cancel</button><button class="header-btn" onclick="saveSOP('draft')"><i class="ph-duotone ph-floppy-disk"></i> Save Draft</button><button class="header-btn primary" onclick="saveSOP('published')"><i class="ph-duotone ph-check-circle"></i> Publish</button></div></div></div>
  <div class="modal" id="viewModal"><div class="modal-box wide"><div class="modal-header"><h2><i class="ph-duotone ph-eye"></i> View SOP</h2><div style="display:flex;align-items:center;gap:12px;"><div class="lang-toggle" id="viewLangToggle"><button class="active" onclick="setViewLang('en')">EN</button><button onclick="setViewLang('es')">ES</button></div><button class="modal-close" onclick="closeModal('viewModal')">&times;</button></div></div><div class="modal-body" id="viewModalBody"></div><div class="modal-footer"><button class="header-btn" onclick="closeModal('viewModal')">Close</button><button class="header-btn" onclick="openModal('pdfModal')"><i class="ph-duotone ph-file-pdf"></i> PDF</button><button class="header-btn primary" onclick="editCurrentSOP()"><i class="ph-duotone ph-pencil-simple"></i> Edit</button></div></div></div>
  <div class="modal" id="qrModal"><div class="modal-box small"><div class="modal-header"><h2><i class="ph-duotone ph-qr-code"></i> QR Code</h2><button class="modal-close" onclick="closeModal('qrModal')">&times;</button></div><div class="modal-body"><div class="qr-modal-content"><img id="qrImage" width="200" height="200" style="display:block;margin:0 auto;border-radius:8px;"><p style="margin-top:16px;color:var(--text-muted);font-size:13px;">Scan to view this SOP</p><div class="qr-url" id="qrUrl"></div></div></div><div class="modal-footer"><button class="header-btn" onclick="closeModal('qrModal')">Close</button><button class="header-btn primary" onclick="downloadQR()"><i class="ph-duotone ph-download"></i> Download</button></div></div></div>
  <div class="modal" id="pdfModal"><div class="modal-box small"><div class="modal-header"><h2><i class="ph-duotone ph-file-pdf"></i> Export PDF</h2><button class="modal-close" onclick="closeModal('pdfModal')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Layout</label><div class="pdf-layout-options"><label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="text"><div class="pdf-layout-card"><div class="pdf-layout-preview"><div class="line"></div><div class="line"></div><div class="line short"></div></div><span>Text Only</span></div></label><label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="2col" checked><div class="pdf-layout-card"><div class="pdf-layout-preview grid-preview cols-1"><div class="box"></div><div class="box"></div></div><span>2 Per Page</span></div></label><label class="pdf-layout-option"><input type="radio" name="pdfLayout" value="4col"><div class="pdf-layout-card"><div class="pdf-layout-preview grid-preview cols-2"><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div></div><span>4 Per Page</span></div></label></div></div><div class="form-group"><label class="form-label">Options</label><div style="display:flex;flex-direction:column;gap:8px;"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="pdfIncludeQR" checked> Include QR Code</label><label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="pdfBilingual"> Bilingual (EN + ES)</label></div></div><div class="form-group"><label class="form-label">Language</label><div style="display:flex;gap:8px;"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="radio" name="pdfLang" value="en" checked> English</label><label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="radio" name="pdfLang" value="es"> Español</label></div></div></div><div class="modal-footer"><button class="header-btn" onclick="closeModal('pdfModal')">Cancel</button><button class="header-btn primary" onclick="generatePDF()" id="generatePdfBtn"><i class="ph-duotone ph-file-pdf"></i> Generate PDF</button></div></div></div>
  <div class="modal" id="settingsModal"><div class="modal-box small"><div class="modal-header"><h2><i class="ph-duotone ph-gear"></i> Settings</h2><button class="modal-close" onclick="closeModal('settingsModal')">&times;</button></div><div class="modal-body"><div class="settings-section"><div class="settings-section-title"><i class="ph-duotone ph-sparkle"></i> AI Features</div><div class="settings-api-key"><label style="font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block;">Anthropic API Key</label><div style="display:flex;gap:8px;"><input type="password" id="apiKeyInput" class="form-input" placeholder="sk-ant-api03-..." style="flex:1;font-size:12px;" onchange="saveApiKey()"><button class="header-btn" onclick="toggleApiKeyVisibility()" style="padding:8px 12px;" title="Show/Hide"><i class="ph-duotone ph-eye" id="apiKeyEyeIcon"></i></button></div><div style="margin-top:10px;"><label style="font-size:12px;color:var(--text-muted);margin-bottom:6px;display:block;">Proxy URL (Google Apps Script Web App)</label><input type="text" id="proxyUrlInput" class="form-input" placeholder="https://script.google.com/macros/s/.../exec" style="font-size:12px;" onchange="saveProxyUrl()"></div><button class="header-btn primary" onclick="testApiConnection()" style="margin-top:12px;width:100%;"><i class="ph-duotone ph-plugs-connected"></i> Test Connection</button><div id="apiKeyStatus" style="margin-top:10px;font-size:12px;padding:10px;background:var(--bg);border-radius:6px;"></div><div class="settings-note" style="margin-top:8px;padding:10px;background:var(--green-dim);border-radius:6px;border-left:3px solid var(--green);"><i class="ph-duotone ph-check-circle" style="color:var(--green);"></i> <strong>AI Features Pre-Configured!</strong> API key and proxy are set up for team use. All AI features are ready to go.</div><div class="settings-note" style="margin-top:6px;">Override with your own key at <a href="https://console.anthropic.com" target="_blank" style="color:var(--gold);">console.anthropic.com</a></div></div></div><div class="settings-section"><div class="settings-section-title"><i class="ph-duotone ph-buildings"></i> Departments</div><div class="settings-list" id="settingsDeptList"></div><div class="settings-add-form"><input type="text" id="newDeptInput" placeholder="New department..." onkeypress="if(event.key==='Enter')addDepartment()"><button class="settings-add-btn" onclick="addDepartment()"><i class="ph-duotone ph-plus"></i></button></div><div class="settings-note">At least one department required</div></div><div class="settings-section"><div class="settings-section-title"><i class="ph-duotone ph-tag"></i> Tags</div><div class="settings-list" id="settingsTagList"></div><div class="settings-add-form"><input type="text" id="newTagInput" placeholder="New tag..." onkeypress="if(event.key==='Enter')addTag()"><div class="tag-color-picker"><div class="tag-color-option gold selected" data-color="gold" onclick="selectTagColor('gold')"></div><div class="tag-color-option green" data-color="green" onclick="selectTagColor('green')"></div><div class="tag-color-option sungrown" data-color="sungrown" onclick="selectTagColor('sungrown')"></div><div class="tag-color-option greenhouse" data-color="greenhouse" onclick="selectTagColor('greenhouse')"></div><div class="tag-color-option indoor" data-color="indoor" onclick="selectTagColor('indoor')"></div><div class="tag-color-option danger" data-color="danger" onclick="selectTagColor('danger')"></div></div><button class="settings-add-btn" onclick="addTag()"><i class="ph-duotone ph-plus"></i></button></div><div class="settings-note">At least one tag required</div></div></div><div class="modal-footer"><button class="header-btn primary" onclick="closeModal('settingsModal')"><i class="ph-duotone ph-check"></i> Done</button></div></div></div>

  <!-- AI Generate Modal -->
  <div class="modal" id="aiGenerateModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-robot"></i> AI Generate SOPs</h2>
        <button class="modal-close" onclick="closeModal('aiGenerateModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="aiGenStep1">
          <div class="form-group">
            <label class="form-label"><i class="ph-duotone ph-truck"></i> Equipment / Machine Name *</label>
            <input type="text" class="form-input" id="aiGenEquipment" placeholder="e.g., John Deere 7210R Tractor, Vitamix 5200 Blender, Twister T4">
            <div style="font-size:11px;color:var(--text-light);margin-top:6px;">Enter make/model for best results. Claude will search for official documentation.</div>
          </div>
          
          <div class="form-group">
            <label class="form-label"><i class="ph-duotone ph-buildings"></i> Department</label>
            <select class="form-input" id="aiGenDept"></select>
          </div>
          
          <div class="form-group">
            <label class="form-label"><i class="ph-duotone ph-list-checks"></i> SOPs to Generate</label>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-top:8px;">
              <label class="ai-gen-checkbox"><input type="checkbox" id="aiGenDaily" checked><span><i class="ph-duotone ph-sun"></i> Daily Pre-Op Inspection</span></label>
              <label class="ai-gen-checkbox"><input type="checkbox" id="aiGenStartup" checked><span><i class="ph-duotone ph-power"></i> Startup & Shutdown</span></label>
              <label class="ai-gen-checkbox"><input type="checkbox" id="aiGenService" checked><span><i class="ph-duotone ph-wrench"></i> Scheduled Service</span></label>
              <label class="ai-gen-checkbox"><input type="checkbox" id="aiGenCleaning"><span><i class="ph-duotone ph-broom"></i> Cleaning Procedure</span></label>
              <label class="ai-gen-checkbox"><input type="checkbox" id="aiGenSafety"><span><i class="ph-duotone ph-warning"></i> Safety Procedures</span></label>
              <label class="ai-gen-checkbox"><input type="checkbox" id="aiGenTroubleshoot"><span><i class="ph-duotone ph-first-aid-kit"></i> Troubleshooting</span></label>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label"><i class="ph-duotone ph-note"></i> Additional Context (Optional)</label>
            <textarea class="form-input" id="aiGenContext" placeholder="Any specific details about your use case, environment, or special requirements..." rows="2"></textarea>
          </div>
          
          <div style="background:var(--gold-dim);border:1px solid var(--gold);border-radius:10px;padding:14px;margin-top:16px;">
            <div style="display:flex;align-items:flex-start;gap:12px;">
              <i class="ph-duotone ph-info" style="font-size:20px;color:var(--gold);flex-shrink:0;margin-top:2px;"></i>
              <div>
                <div style="font-weight:600;color:var(--gold);margin-bottom:4px;">How it works</div>
                <div style="font-size:12px;color:var(--text-muted);line-height:1.5;">Claude will search the web for official manuals, service guides, and documentation for your equipment, then generate comprehensive SOPs based on manufacturer recommendations. Estimated cost: ~$0.15-0.30 per equipment.</div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="aiGenStep2" style="display:none;">
          <div id="aiGenProgress" style="text-align:center;padding:40px 20px;">
            <div class="ai-gen-spinner"></div>
            <div style="margin-top:20px;font-weight:600;color:var(--gold);" id="aiGenProgressTitle">Searching for documentation...</div>
            <div style="margin-top:8px;font-size:13px;color:var(--text-muted);" id="aiGenProgressSub">This may take 30-60 seconds</div>
            <div style="margin-top:16px;font-size:12px;color:var(--text-light);" id="aiGenProgressLog"></div>
          </div>
        </div>
        
        <div id="aiGenStep3" style="display:none;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div style="font-weight:600;color:var(--green);"><i class="ph-duotone ph-check-circle"></i> Generated <span id="aiGenCount">0</span> SOPs</div>
            <div style="font-size:12px;color:var(--text-muted);">Review and select which to import</div>
          </div>
          <div id="aiGenResults" style="display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('aiGenerateModal')">Cancel</button>
        <button class="header-btn primary" id="aiGenStartBtn" onclick="startAIGenerate()"><i class="ph-duotone ph-sparkle"></i> Generate SOPs</button>
        <button class="header-btn primary" id="aiGenImportBtn" onclick="importGeneratedSOPs()" style="display:none;"><i class="ph-duotone ph-download"></i> Import Selected</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="requestsModal">
    <div class="modal-box wide">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-clipboard-text"></i> SOP Requests</h2>
        <button class="modal-close" onclick="closeModal('requestsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="requests-tabs">
          <button class="requests-tab active" onclick="setRequestTab('pending')" id="tabPending">Pending <span class="tab-count" id="pendingCount">0</span></button>
          <button class="requests-tab" onclick="setRequestTab('completed')" id="tabCompleted">Completed <span class="tab-count" id="completedCount">0</span></button>
        </div>
        
        <div class="add-request-form" id="addRequestForm">
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">New Request Title *</label>
            <input type="text" class="form-input" id="reqTitle" placeholder="e.g., Trimming Machine Cleaning Procedure">
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Department</label>
              <select class="form-input" id="reqDept"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Priority</label>
              <select class="form-input" id="reqPriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="margin-bottom:12px;">
            <div class="form-group">
              <label class="form-label">Assign To</label>
              <input type="text" class="form-input" id="reqAssignee" placeholder="Name or leave blank">
            </div>
            <div class="form-group">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-input" id="reqDueDate">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:12px;">
            <label class="form-label">Notes / Description</label>
            <textarea class="form-input" id="reqNotes" placeholder="What should this SOP cover?" rows="2"></textarea>
          </div>
          <button class="header-btn primary" onclick="addRequest()" style="width:100%;"><i class="ph-duotone ph-plus"></i> Add Request</button>
        </div>
        
        <div class="request-list" id="requestList"></div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('requestsModal')">Close</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="editRequestModal">
    <div class="modal-box small">
      <div class="modal-header">
        <h2><i class="ph-duotone ph-pencil-simple"></i> Edit Request</h2>
        <button class="modal-close" onclick="closeModal('editRequestModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="editReqTitle">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Department</label>
            <select class="form-input" id="editReqDept"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-input" id="editReqPriority">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Assign To</label>
            <input type="text" class="form-input" id="editReqAssignee">
          </div>
          <div class="form-group">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-input" id="editReqDueDate">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="editReqNotes" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="header-btn" onclick="closeModal('editRequestModal')">Cancel</button>
        <button class="header-btn primary" onclick="saveRequestEdit()"><i class="ph-duotone ph-check"></i> Save</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"><i class="ph-duotone ph-check-circle"></i><span id="toastMsg"></span></div>
  <script>
    // Default API configuration (for shared team use)
    const DEFAULT_API_KEY = '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';
    const DEFAULT_PROXY_URL = 'https://script.google.com/macros/s/AKfycbyyDNEHl78fewANzo_9j2zvMES_4HIFOdD8QbwE52kdhJOcWfwig7vcSV53cQal7bQj/exec';
    
    let sops=[], currentSopId=null, editingSteps=[], selectedTagColor='gold';
    let settings={departments:[{name:'Production',icon:'ph-factory'},{name:'Packaging',icon:'ph-package'},{name:'Quality',icon:'ph-seal-check'},{name:'Maintenance',icon:'ph-wrench'}],tags:[{name:'safety',color:'danger'},{name:'quality',color:'green'},{name:'critical',color:'gold'}]};
    let editLang='en', viewLang='en';
    let sopRequests=[], currentRequestTab='pending', editingRequestId=null;
    let appLang='en';
    
    // App UI Translations
    const i18n = {
      en: {
        // Header
        headerTitle: 'Standard Operating Procedures',
        dark: 'Dark',
        requests: 'Requests',
        newSop: 'New SOP',
        // Stats
        total: 'Total',
        published: 'Published',
        drafts: 'Drafts',
        requestsLabel: 'Requests',
        thisMonth: 'This Month',
        // Toolbar
        searchPlaceholder: 'Search SOPs...',
        allSops: 'All SOPs',
        publishedFilter: 'Published',
        draftsFilter: 'Drafts',
        allDepts: 'All Departments',
        allTags: 'All Tags',
        // Empty state
        noSopsFound: 'No SOPs Found',
        createFirst: 'Create your first SOP to get started.',
        createSop: 'Create SOP',
        // Edit Modal
        createNewSop: 'Create New SOP',
        editSop: 'Edit SOP',
        sopTitle: 'SOP Title',
        sopTitlePlaceholder: 'e.g., Trimming Machine Setup',
        department: 'Department',
        writingLanguage: 'Writing Language',
        autoTranslateTo: 'Auto-translate to',
        createsBoth: 'Creates both language versions',
        docNumber: 'Document Number',
        revision: 'Revision',
        status: 'Status',
        draft: 'Draft',
        description: 'Description',
        descPlaceholder: 'Brief description...',
        tags: 'Tags',
        steps: 'Steps',
        add: 'Add',
        aiImproveAll: 'AI Improve All',
        cancel: 'Cancel',
        saveDraft: 'Save Draft',
        publish: 'Publish',
        improve: 'Improve',
        // Steps
        stepTitlePlaceholder: 'Step title...',
        stepDescPlaceholder: 'Description...',
        tapToAdd: 'Tap to add',
        camera: 'Camera',
        gallery: 'Gallery',
        remove: 'Remove',
        // Tooltips
        tipCamera: 'Take a photo using your device camera',
        tipGallery: 'Choose an existing image from your photo library',
        tipRemove: 'Remove this image',
        tipAiStep: "Use AI to improve this step's title and description",
        tipDeleteStep: 'Delete this step',
        tipSafety: 'Mark as Safety Warning',
        tipQuality: 'Mark as Quality Checkpoint',
        // View Modal
        viewSop: 'View SOP',
        pdf: 'PDF',
        edit: 'Edit',
        close: 'Close',
        // Requests Modal
        sopRequests: 'SOP Requests',
        pending: 'Pending',
        completed: 'Completed',
        newRequestTitle: 'New Request Title',
        newRequestPlaceholder: 'e.g., Trimming Machine Cleaning Procedure',
        priority: 'Priority',
        low: 'Low',
        medium: 'Medium',
        high: 'High',
        assignTo: 'Assign To',
        assigneePlaceholder: 'Name or leave blank',
        dueDate: 'Due Date',
        notesDesc: 'Notes / Description',
        whatShouldCover: 'What should this SOP cover?',
        addRequest: 'Add Request',
        createSopBtn: 'Create SOP',
        done: 'Done',
        delete: 'Delete',
        overdue: 'OVERDUE',
        created: 'Created',
        noPending: 'No pending SOP requests',
        noCompleted: 'No completed requests',
        // Settings
        settings: 'Settings',
        aiFeatures: 'AI Features',
        apiKeyLabel: 'Anthropic API Key',
        apiKeyPlaceholder: 'sk-ant-api03-...',
        getKeyAt: 'Get your key at',
        apiConfigured: 'API key configured - AI features enabled',
        addApiKey: 'Add API key to enable AI features',
        departments: 'Departments',
        atLeastOneDept: 'At least one department required',
        atLeastOneTag: 'At least one tag required',
        // PDF Modal
        exportPdf: 'Export PDF',
        layout: 'Layout',
        textOnly: 'Text Only',
        perPage2: '2 Per Page',
        perPage4: '4 Per Page',
        options: 'Options',
        includeQr: 'Include QR Code',
        bilingual: 'Bilingual (EN + ES)',
        language: 'Language',
        generatePdf: 'Generate PDF',
        // QR Modal
        qrCode: 'QR Code',
        scanToView: 'Scan to view this SOP',
        download: 'Download',
        // Toasts
        saved: 'Saved!',
        publishedToast: 'Published!',
        deleted: 'Deleted',
        requestAdded: 'Request added',
        markedComplete: 'Marked complete',
        updated: 'Updated',
        enterTitle: 'Enter title',
        selectDept: 'Select dept',
        needOneStep: 'Need 1 step',
        enterTextFirst: 'Enter some text first',
        addApiKeyFirst: 'Add API key in Settings first',
        descImproved: 'Description improved!',
        titleImproved: 'Title improved!',
        stepImproved: 'Step improved!',
        allStepsImproved: 'All steps improved!',
        apiKeySaved: 'API key saved!',
        invalidApiKey: 'Invalid API key',
        aiUnavailable: 'AI service unavailable'
      },
      es: {
        // Header
        headerTitle: 'Procedimientos Operativos Estándar',
        dark: 'Oscuro',
        requests: 'Solicitudes',
        newSop: 'Nuevo SOP',
        // Stats
        total: 'Total',
        published: 'Publicados',
        drafts: 'Borradores',
        requestsLabel: 'Solicitudes',
        thisMonth: 'Este Mes',
        // Toolbar
        searchPlaceholder: 'Buscar SOPs...',
        allSops: 'Todos los SOPs',
        publishedFilter: 'Publicados',
        draftsFilter: 'Borradores',
        allDepts: 'Todos los Departamentos',
        allTags: 'Todas las Etiquetas',
        // Empty state
        noSopsFound: 'No se encontraron SOPs',
        createFirst: 'Crea tu primer SOP para comenzar.',
        createSop: 'Crear SOP',
        // Edit Modal
        createNewSop: 'Crear Nuevo SOP',
        editSop: 'Editar SOP',
        sopTitle: 'Título del SOP',
        sopTitlePlaceholder: 'ej., Configuración de Máquina de Recorte',
        department: 'Departamento',
        writingLanguage: 'Idioma de Escritura',
        autoTranslateTo: 'Auto-traducir a',
        createsBoth: 'Crea ambas versiones de idioma',
        docNumber: 'Número de Documento',
        revision: 'Revisión',
        status: 'Estado',
        draft: 'Borrador',
        description: 'Descripción',
        descPlaceholder: 'Descripción breve...',
        tags: 'Etiquetas',
        steps: 'Pasos',
        add: 'Agregar',
        aiImproveAll: 'IA Mejorar Todo',
        cancel: 'Cancelar',
        saveDraft: 'Guardar Borrador',
        publish: 'Publicar',
        improve: 'Mejorar',
        // Steps
        stepTitlePlaceholder: 'Título del paso...',
        stepDescPlaceholder: 'Descripción...',
        tapToAdd: 'Toca para agregar',
        camera: 'Cámara',
        gallery: 'Galería',
        remove: 'Eliminar',
        // Tooltips
        tipCamera: 'Toma una foto con la cámara de tu dispositivo',
        tipGallery: 'Elige una imagen de tu biblioteca de fotos',
        tipRemove: 'Eliminar esta imagen',
        tipAiStep: 'Usa IA para mejorar el título y descripción de este paso',
        tipDeleteStep: 'Eliminar este paso',
        tipSafety: 'Marcar como Advertencia de Seguridad',
        tipQuality: 'Marcar como Punto de Control de Calidad',
        // View Modal
        viewSop: 'Ver SOP',
        pdf: 'PDF',
        edit: 'Editar',
        close: 'Cerrar',
        // Requests Modal
        sopRequests: 'Solicitudes de SOP',
        pending: 'Pendientes',
        completed: 'Completados',
        newRequestTitle: 'Título de Nueva Solicitud',
        newRequestPlaceholder: 'ej., Procedimiento de Limpieza de Máquina',
        priority: 'Prioridad',
        low: 'Baja',
        medium: 'Media',
        high: 'Alta',
        assignTo: 'Asignar A',
        assigneePlaceholder: 'Nombre o dejar vacío',
        dueDate: 'Fecha Límite',
        notesDesc: 'Notas / Descripción',
        whatShouldCover: '¿Qué debe cubrir este SOP?',
        addRequest: 'Agregar Solicitud',
        createSopBtn: 'Crear SOP',
        done: 'Listo',
        delete: 'Eliminar',
        overdue: 'VENCIDO',
        created: 'Creado',
        noPending: 'No hay solicitudes pendientes',
        noCompleted: 'No hay solicitudes completadas',
        // Settings
        settings: 'Configuración',
        aiFeatures: 'Funciones de IA',
        apiKeyLabel: 'Clave API de Anthropic',
        apiKeyPlaceholder: 'sk-ant-api03-...',
        getKeyAt: 'Obtén tu clave en',
        apiConfigured: 'Clave API configurada - Funciones IA habilitadas',
        addApiKey: 'Agrega clave API para habilitar funciones IA',
        departments: 'Departamentos',
        atLeastOneDept: 'Se requiere al menos un departamento',
        atLeastOneTag: 'Se requiere al menos una etiqueta',
        // PDF Modal
        exportPdf: 'Exportar PDF',
        layout: 'Diseño',
        textOnly: 'Solo Texto',
        perPage2: '2 Por Página',
        perPage4: '4 Por Página',
        options: 'Opciones',
        includeQr: 'Incluir Código QR',
        bilingual: 'Bilingüe (EN + ES)',
        language: 'Idioma',
        generatePdf: 'Generar PDF',
        // QR Modal
        qrCode: 'Código QR',
        scanToView: 'Escanea para ver este SOP',
        download: 'Descargar',
        // Toasts
        saved: '¡Guardado!',
        publishedToast: '¡Publicado!',
        deleted: 'Eliminado',
        requestAdded: 'Solicitud agregada',
        markedComplete: 'Marcado completo',
        updated: 'Actualizado',
        enterTitle: 'Ingresa título',
        selectDept: 'Selecciona depto',
        needOneStep: 'Necesitas 1 paso',
        enterTextFirst: 'Ingresa texto primero',
        addApiKeyFirst: 'Agrega clave API en Configuración',
        descImproved: '¡Descripción mejorada!',
        titleImproved: '¡Título mejorado!',
        stepImproved: '¡Paso mejorado!',
        allStepsImproved: '¡Todos los pasos mejorados!',
        apiKeySaved: '¡Clave API guardada!',
        invalidApiKey: 'Clave API inválida',
        aiUnavailable: 'Servicio IA no disponible'
      }
    };
    
    function t(key) { return i18n[appLang][key] || i18n['en'][key] || key; }
    
    // Translation API (using LibreTranslate or MyMemory free API)
    async function translateText(text, from, to) {
      if (!text || text.trim() === '') return '';
      
      const apiKey = getApiKey();
      const proxyUrl = getProxyUrl();
      
      // If no API configured, fall back to free API
      if (!apiKey || !proxyUrl) {
        return translateTextFree(text, from, to);
      }
      
      const fromLang = from === 'en' ? 'English' : 'Spanish';
      const toLang = to === 'en' ? 'English' : 'Spanish';
      
      try {
        const response = await fetch(proxyUrl, {
          method: 'POST',
          body: JSON.stringify({
            apiKey: apiKey,
            body: {
              model: 'claude-3-5-haiku-20241022',
              max_tokens: 500,
              messages: [{ 
                role: 'user', 
                content: `Translate the following text from ${fromLang} to ${toLang}. This is for a cannabis production facility SOP, so use appropriate industry terminology. Only return the translation, nothing else.\n\nText: ${text}` 
              }]
            }
          })
        });
        
        const data = await response.json();
        if (data.content && data.content[0]) {
          return data.content[0].text.trim();
        }
        return translateTextFree(text, from, to); // fallback
      } catch (e) {
        console.error('Claude translation error:', e);
        return translateTextFree(text, from, to); // fallback
      }
    }
    
    // Fallback free translation API
    async function translateTextFree(text, from, to) {
      if (!text || text.trim() === '') return '';
      try {
        const langPair = from + '|' + to;
        const response = await fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=' + langPair);
        const data = await response.json();
        if (data.responseStatus === 200 && data.responseData) {
          return data.responseData.translatedText;
        }
        return text;
      } catch (e) {
        console.error('Translation error:', e);
        return text;
      }
    }
    
    function setEditLang(lang) {
      editLang = lang;
      document.querySelectorAll('#editLangToggle button').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(lang === 'en' ? 'eng' : 'esp')));
      document.getElementById('translateBtnText').textContent = lang === 'en' ? 'Auto-translate to Español' : 'Auto-traducir a English';
      document.getElementById('sopTitle').placeholder = lang === 'en' ? 'e.g., Trimming Machine Setup' : 'ej., Configuración de Máquina de Corte';
      document.getElementById('sopDesc').placeholder = lang === 'en' ? 'Brief description...' : 'Descripción breve...';
    }
    
    async function autoTranslateSOP() {
      const btn = document.getElementById('autoTranslateBtn');
      const btnText = document.getElementById('translateBtnText');
      const origText = btnText.textContent;
      btn.disabled = true;
      btnText.textContent = 'Translating...';
      
      const fromLang = editLang;
      const toLang = editLang === 'en' ? 'es' : 'en';
      
      try {
        // Get current values
        const title = document.getElementById('sopTitle').value;
        const desc = document.getElementById('sopDesc').value;
        
        // Translate title and description
        const [transTitle, transDesc] = await Promise.all([
          translateText(title, fromLang, toLang),
          translateText(desc, fromLang, toLang)
        ]);
        
        // Translate steps
        for (let i = 0; i < editingSteps.length; i++) {
          const step = editingSteps[i];
          if (step.title) {
            step['title_' + toLang] = await translateText(step.title, fromLang, toLang);
            step['title_' + fromLang] = step.title;
          }
          if (step.description) {
            step['desc_' + toLang] = await translateText(step.description, fromLang, toLang);
            step['desc_' + fromLang] = step.description;
          }
        }
        
        // Store translations in temp object
        window.sopTranslations = {
          ['title_' + fromLang]: title,
          ['title_' + toLang]: transTitle,
          ['desc_' + fromLang]: desc,
          ['desc_' + toLang]: transDesc
        };
        
        showToast('Translated! (' + fromLang.toUpperCase() + ' → ' + toLang.toUpperCase() + ')', 'success');
      } catch (e) {
        console.error('Translation failed:', e);
        showToast('Translation failed', 'error');
      }
      
      btn.disabled = false;
      btnText.textContent = origText;
    }
    
    async function setViewLang(lang) {
      viewLang = lang;
      document.querySelectorAll('#viewLangToggle button').forEach(b => b.classList.toggle('active', b.textContent === lang.toUpperCase()));
      const s = sops.find(x => x.id === currentSopId);
      if (!s) return;
      
      // If switching to Spanish and no saved translation, translate on-the-fly with Claude
      if (lang === 'es' && !s.title_es) {
        const esBtn = document.querySelector('#viewLangToggle button:last-child');
        esBtn.innerHTML = '<i class="ph-duotone ph-spinner" style="animation:spin 1s linear infinite;"></i>';
        esBtn.disabled = true;
        
        try {
          showToast('Translating with Claude AI...', 'success');
          s.title_es = await translateText(s.title, 'en', 'es');
          if (s.description) s.desc_es = await translateText(s.description, 'en', 'es');
          for (let step of s.steps) {
            if (step.title && !step.title_es) step.title_es = await translateText(step.title, 'en', 'es');
            if (step.description && !step.desc_es) step.desc_es = await translateText(step.description, 'en', 'es');
          }
          saveToStorage();
          showToast('Translation complete!', 'success');
        } catch (e) {
          console.error('Translation error:', e);
          showToast('Translation failed', 'error');
        }
        
        esBtn.innerHTML = 'ES';
        esBtn.disabled = false;
      }
      
      renderViewSOP(s);
    }
    
    function renderViewSOP(s) {
      if (!s) return;
      const lang = viewLang;
      const title = s['title_' + lang] || s.title;
      const desc = s['desc_' + lang] || s.description;
      const u = 'https://rogueff.github.io/rogue-origin-apps/sop-manager.html?view=' + s.id;
      
      const stepsHtml = s.steps.map((st, i) => {
        const stepTitle = st['title_' + lang] || st.title;
        const stepDesc = st['desc_' + lang] || st.description;
        return '<div class="view-step"><div class="view-step-number">' + (i + 1) + '</div><div class="view-step-content"><div class="view-step-title">' + esc(stepTitle) + (st.safety ? ' <i class="ph-duotone ph-warning icon safety"></i>' : '') + (st.quality ? ' <i class="ph-duotone ph-seal-check icon quality"></i>' : '') + '</div><div class="view-step-desc">' + esc(stepDesc) + '</div></div>' + (st.image ? '<div class="view-step-image"><img src="' + st.image + '"></div>' : '') + '</div>';
      }).join('');
      
      const hasApiKey = getApiKey() && getProxyUrl();
      const langNotice = (lang === 'es' && s.title_es) ? '<div class="translation-notice"><i class="ph-duotone ph-sparkle"></i> ' + (hasApiKey ? 'Translated by Claude AI' : 'Auto-translated') + '</div>' : '';
      
      document.getElementById('viewModalBody').innerHTML = langNotice + '<div class="view-sop-header"><div><div class="view-sop-title">' + esc(title) + '</div><div class="view-sop-meta"><div class="view-sop-meta-item"><i class="ph-duotone ph-folder"></i> ' + s.dept + '</div><div class="view-sop-meta-item"><i class="ph-duotone ph-hash"></i> ' + s.docNum + '</div><div class="view-sop-meta-item"><i class="ph-duotone ph-git-branch"></i> Rev ' + s.revision + '</div><div class="view-sop-meta-item"><i class="ph-duotone ph-calendar"></i> ' + fmtDate(s.updatedAt) + '</div></div>' + (desc ? '<p style="margin-top:12px;color:var(--text-muted)">' + esc(desc) + '</p>' : '') + '</div><div class="view-sop-qr"><img src="https://api.qrserver.com/v1/create-qr-code/?size=78x78&data=' + encodeURIComponent(u) + '" width="78" height="78"></div></div>' + stepsHtml;
    }
    document.addEventListener('DOMContentLoaded',function(){loadSettings();loadFromStorage();renderSOPs();updateStats();updateDropdowns();loadAppLang();if(localStorage.getItem('sopDarkMode')==='true')document.body.classList.add('dark-mode');const v=new URLSearchParams(window.location.search).get('view');if(v)setTimeout(()=>viewSOP(parseInt(v)),500);});
    function loadSettings(){const s=localStorage.getItem('sopSettings');if(s){const p=JSON.parse(s);if(p.departments)p.departments.filter(d=>!d.default).forEach(d=>{if(!settings.departments.find(x=>x.name===d.name))settings.departments.push(d);});if(p.tags)p.tags.filter(t=>!t.default).forEach(t=>{if(!settings.tags.find(x=>x.name===t.name))settings.tags.push(t);});}}
    function saveSettings(){localStorage.setItem('sopSettings',JSON.stringify(settings));updateDropdowns();}
    function updateDropdowns(){document.getElementById('deptFilter').innerHTML='<option value="">'+t('allDepts')+'</option>'+settings.departments.map(d=>'<option value="'+d.name+'">'+d.name+'</option>').join('');document.getElementById('sopDept').innerHTML='<option value="">'+t('selectDept')+'</option>'+settings.departments.map(d=>'<option value="'+d.name+'">'+d.name+'</option>').join('');document.getElementById('tagFilter').innerHTML='<option value="">'+t('allTags')+'</option>'+settings.tags.map(t=>'<option value="'+t.name+'">'+t.name.charAt(0).toUpperCase()+t.name.slice(1)+'</option>').join('');renderEditTags();}
    function renderEditTags(){document.getElementById('editTagsList').innerHTML=settings.tags.map(t=>'<div class="tag-item"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="tag_'+t.name+'"><span class="sop-tag '+t.color+'">'+t.name+'</span></label><button type="button" class="tag-delete" onclick="deleteTagInline(\''+t.name+'\')" title="Delete tag"><i class="ph-duotone ph-x"></i></button></div>').join('')+'<button type="button" class="add-tag-btn" onclick="showInlineAdd(\'tag\')"><i class="ph-duotone ph-plus"></i> Add</button>';renderInlineTagColors();}
    function openSettingsModal(){renderSettingsDepts();renderSettingsTags();loadApiKeyToInput();openModal('settingsModal');}
    function renderSettingsDepts(){document.getElementById('settingsDeptList').innerHTML=settings.departments.map(d=>'<div class="settings-item"><i class="ph-duotone '+(d.icon||'ph-folder')+'"></i><span>'+d.name+'</span><button class="item-delete" onclick="deleteDepartment(\''+d.name+'\')"><i class="ph-duotone ph-x"></i></button></div>').join('');}
    function renderSettingsTags(){document.getElementById('settingsTagList').innerHTML=settings.tags.map(t=>'<div class="settings-item"><span class="sop-tag '+t.color+'">'+t.name+'</span><button class="item-delete" onclick="deleteTag(\''+t.name+'\')"><i class="ph-duotone ph-x"></i></button></div>').join('');}
    function addDepartment(){const i=document.getElementById('newDeptInput'),n=i.value.trim();if(!n)return;if(settings.departments.find(d=>d.name.toLowerCase()===n.toLowerCase())){showToast('Exists','error');return;}settings.departments.push({name:n,icon:'ph-folder'});saveSettings();renderSettingsDepts();i.value='';showToast('Added','success');}
    function deleteDepartment(n){if(settings.departments.length<=1){showToast('Need at least 1','error');return;}settings.departments=settings.departments.filter(d=>d.name!==n);saveSettings();renderSettingsDepts();showToast('Deleted','success');}
    function selectTagColor(c){selectedTagColor=c;document.querySelectorAll('.tag-color-option').forEach(e=>e.classList.toggle('selected',e.dataset.color===c));}
    function addTag(){const i=document.getElementById('newTagInput'),n=i.value.trim().toLowerCase();if(!n)return;if(settings.tags.find(t=>t.name===n)){showToast('Exists','error');return;}settings.tags.push({name:n,color:selectedTagColor});saveSettings();renderSettingsTags();i.value='';showToast('Added','success');}
    function deleteTag(n){if(settings.tags.length<=1){showToast('Need at least 1','error');return;}settings.tags=settings.tags.filter(t=>t.name!==n);saveSettings();renderSettingsTags();showToast('Deleted','success');}
    function showInlineAdd(type){document.getElementById('inlineAdd'+(type==='dept'?'Dept':'Tag')).style.display='block';document.getElementById('new'+(type==='dept'?'Dept':'Tag')+'Inline').focus();}
    function hideInlineAdd(type){document.getElementById('inlineAdd'+(type==='dept'?'Dept':'Tag')).style.display='none';document.getElementById('new'+(type==='dept'?'Dept':'Tag')+'Inline').value='';}
    function addDeptInline(){const i=document.getElementById('newDeptInline'),n=i.value.trim();if(!n)return;if(settings.departments.find(d=>d.name.toLowerCase()===n.toLowerCase())){showToast('Exists','error');return;}settings.departments.push({name:n,icon:'ph-folder'});saveSettings();document.getElementById('sopDept').value=n;hideInlineAdd('dept');showToast('Added','success');}
    function deleteCurrentDept(){const sel=document.getElementById('sopDept'),n=sel.value;if(!n){showToast('Select a dept first','error');return;}if(settings.departments.length<=1){showToast('Need at least 1','error');return;}if(!confirm('Delete "'+n+'" department?'))return;settings.departments=settings.departments.filter(d=>d.name!==n);saveSettings();sel.value='';showToast('Deleted','success');}
    function addTagInline(){const i=document.getElementById('newTagInline'),n=i.value.trim().toLowerCase();if(!n)return;if(settings.tags.find(t=>t.name===n)){showToast('Exists','error');return;}settings.tags.push({name:n,color:inlineTagColor});saveSettings();renderEditTags();const c=document.getElementById('tag_'+n);if(c)c.checked=true;hideInlineAdd('tag');showToast('Added','success');}
    function deleteTagInline(n){if(settings.tags.length<=1){showToast('Need at least 1','error');return;}settings.tags=settings.tags.filter(t=>t.name!==n);saveSettings();renderEditTags();showToast('Deleted','success');}
    let inlineTagColor='gold';
    function renderInlineTagColors(){const c=document.getElementById('inlineTagColors');if(!c)return;c.innerHTML=['gold','green','sungrown','greenhouse','indoor','danger'].map(col=>'<div class="color-dot '+(col===inlineTagColor?'selected':'')+'" style="background:var(--'+col+')" onclick="setInlineTagColor(\''+col+'\')"></div>').join('');}
    function setInlineTagColor(c){inlineTagColor=c;renderInlineTagColors();}
    function loadFromStorage(){const s=localStorage.getItem('rogueOriginSOPs');if(s)sops=JSON.parse(s);else{sops=[{id:1,title:'Trimming Machine Daily Startup',dept:'Production',docNum:'SOP-PRD-001',revision:'2.1',status:'published',description:'Standard procedure for starting the trimming machine.',tags:['safety','critical'],steps:[{title:'Safety Check',description:'Verify all safety guards.',image:'',safety:true,quality:false},{title:'Power On',description:'Turn on main power.',image:'',safety:false,quality:false},{title:'Warm Up',description:'Wait 5 minutes.',image:'',safety:false,quality:true},{title:'Test Run',description:'Run empty 30 sec.',image:'',safety:false,quality:true}],createdAt:'2024-12-01',updatedAt:'2024-12-20'},{id:2,title:'Package Sealing Procedure',dept:'Packaging',docNum:'SOP-PKG-003',revision:'1.0',status:'published',description:'Proper sealing for shipping.',tags:['quality'],steps:[{title:'Prepare Package',description:'Check weight.',image:'',safety:false,quality:true},{title:'Apply Seal',description:'Heat 3 sec at 180C.',image:'',safety:true,quality:true}],createdAt:'2024-12-10',updatedAt:'2024-12-15'},{id:3,title:'Daily Equipment Cleaning',dept:'Maintenance',docNum:'SOP-MNT-002',revision:'1.2',status:'draft',description:'End of day cleaning.',tags:['safety'],steps:[{title:'Power Down',description:'Turn off equipment.',image:'',safety:true,quality:false},{title:'Wipe Down',description:'Use approved cleaner.',image:'',safety:false,quality:false}],createdAt:'2024-12-05',updatedAt:'2024-12-22'}];saveToStorage();}const r=localStorage.getItem('rogueOriginSOPRequests');if(r)sopRequests=JSON.parse(r);updateRequestBadge();}
    function saveToStorage(){localStorage.setItem('rogueOriginSOPs',JSON.stringify(sops));localStorage.setItem('rogueOriginSOPRequests',JSON.stringify(sopRequests));}
    function renderSOPs(){const se=document.getElementById('searchInput').value.toLowerCase(),st=document.getElementById('statusFilter').value,de=document.getElementById('deptFilter').value,ta=document.getElementById('tagFilter').value;let f=sops.filter(s=>{const ms=s.title.toLowerCase().includes(se)||s.description.toLowerCase().includes(se)||s.docNum.toLowerCase().includes(se);return ms&&(!st||s.status===st)&&(!de||s.dept===de)&&(!ta||s.tags.includes(ta));});const g=document.getElementById('sopGrid');if(f.length===0){g.innerHTML='';document.getElementById('emptyState').style.display='block';}else{document.getElementById('emptyState').style.display='none';g.innerHTML=f.map(s=>{const th=s.tags.map(t=>{const tc=settings.tags.find(x=>x.name===t)||{color:'gold'};return'<span class="sop-tag '+tc.color+'">'+t+'</span>';}).join('');return'<div class="sop-card" onclick="viewSOP('+s.id+')"><div class="sop-card-header"><div><div class="sop-card-title">'+esc(s.title)+'</div><div class="sop-card-dept"><i class="ph-duotone ph-folder"></i> '+s.dept+' • '+s.docNum+'</div></div><div class="sop-card-rev '+(s.status==='draft'?'draft':'')+'">'+(s.status==='draft'?'DRAFT':'v'+s.revision)+'</div></div><div class="sop-card-preview">'+(s.steps[0]?.image?'<img src="'+s.steps[0].image+'">':'<div class="sop-card-preview-empty"><i class="ph-duotone ph-image"></i>'+s.steps.length+' steps</div>')+'</div><div class="sop-card-meta"><div class="sop-card-steps"><i class="ph-duotone ph-list-numbers"></i> '+s.steps.length+'</div><div class="sop-card-tags">'+th+'</div></div><div class="sop-card-actions" onclick="event.stopPropagation()"><button onclick="viewSOP('+s.id+')"><i class="ph-duotone ph-eye"></i></button><button onclick="editSOP('+s.id+')"><i class="ph-duotone ph-pencil-simple"></i></button><button class="qr-btn" onclick="showQR('+s.id+')"><i class="ph-duotone ph-qr-code"></i></button><button class="del-btn" onclick="deleteSOP('+s.id+')"><i class="ph-duotone ph-trash"></i></button></div></div>';}).join('');}document.getElementById('sopTableBody').innerHTML=f.map(s=>'<tr onclick="viewSOP('+s.id+')"><td class="title-cell">'+esc(s.title)+'</td><td>'+s.dept+'</td><td>'+s.steps.length+'</td><td>'+(s.status==='draft'?'<span style="color:var(--gold)">Draft</span>':'<span style="color:var(--green)">Published</span>')+'</td><td>'+fmtDate(s.updatedAt)+'</td><td class="actions-cell" onclick="event.stopPropagation()"><button onclick="editSOP('+s.id+')"><i class="ph-duotone ph-pencil-simple"></i></button><button onclick="showQR('+s.id+')"><i class="ph-duotone ph-qr-code"></i></button><button onclick="deleteSOP('+s.id+')"><i class="ph-duotone ph-trash"></i></button></td></tr>').join('');}
    function updateStats(){const t=sops.length,p=sops.filter(s=>s.status==='published').length,d=t-p,m=sops.filter(s=>{const x=new Date(s.updatedAt),n=new Date();return x.getMonth()===n.getMonth()&&x.getFullYear()===n.getFullYear();}).length,r=sopRequests.filter(x=>!x.completed).length;document.getElementById('statTotal').textContent=t;document.getElementById('statPublished').textContent=p;document.getElementById('statDrafts').textContent=d;document.getElementById('statMonth').textContent=m;document.getElementById('statRequests').textContent=r;}
    function setView(v){document.getElementById('gridViewBtn').classList.toggle('active',v==='grid');document.getElementById('listViewBtn').classList.toggle('active',v==='list');document.getElementById('sopGrid').classList.toggle('hidden',v==='list');document.getElementById('sopList').classList.toggle('active',v==='list');}
    function filterSOPs(){renderSOPs();}
    function openModal(id){document.getElementById(id).classList.add('active');}
    function closeModal(id){document.getElementById(id).classList.remove('active');}
    function openCreateModal(){currentSopId=null;editingSteps=[{title:'',description:'',image:'',safety:false,quality:false}];window.sopTranslations=null;editLang='en';setEditLang('en');document.getElementById('modalTitle').innerHTML='<i class="ph-duotone ph-file-text"></i> Create New SOP';document.getElementById('sopTitle').value='';document.getElementById('sopDept').value='';document.getElementById('sopDocNum').value='SOP-'+String(sops.length+1).padStart(3,'0');document.getElementById('sopRevision').value='1.0';document.getElementById('sopStatus').value='draft';document.getElementById('sopDesc').value='';settings.tags.forEach(t=>{const c=document.getElementById('tag_'+t.name);if(c)c.checked=false;});renderSteps();openModal('editModal');}
    function editSOP(id){const s=sops.find(x=>x.id===id);if(!s)return;currentSopId=id;editingSteps=JSON.parse(JSON.stringify(s.steps));document.getElementById('modalTitle').innerHTML='<i class="ph-duotone ph-pencil-simple"></i> Edit SOP';document.getElementById('sopTitle').value=s.title;document.getElementById('sopDept').value=s.dept;document.getElementById('sopDocNum').value=s.docNum;document.getElementById('sopRevision').value=s.revision;document.getElementById('sopStatus').value=s.status;document.getElementById('sopDesc').value=s.description;settings.tags.forEach(t=>{const c=document.getElementById('tag_'+t.name);if(c)c.checked=s.tags.includes(t.name);});renderSteps();openModal('editModal');}
    function renderSteps(){document.getElementById('stepsList').innerHTML=editingSteps.map((s,i)=>'<div class="step-item"><div class="step-number">'+(i+1)+'</div><div class="step-content"><input type="text" class="step-title-input" placeholder="'+t('stepTitlePlaceholder')+'" value="'+esc(s.title)+'" onchange="updateStep('+i+',\'title\',this.value)"><textarea class="step-desc-input" placeholder="'+t('stepDescPlaceholder')+'" onchange="updateStep('+i+',\'description\',this.value)">'+esc(s.description)+'</textarea><div class="step-icons"><button class="step-icon-btn safety '+(s.safety?'active':'')+'" onclick="toggleIcon('+i+',\'safety\')" title="'+t('tipSafety')+'"><i class="ph-duotone ph-warning"></i></button><button class="step-icon-btn quality '+(s.quality?'active':'')+'" onclick="toggleIcon('+i+',\'quality\')" title="'+t('tipQuality')+'"><i class="ph-duotone ph-seal-check"></i></button></div></div><div class="step-image"><div class="step-image-preview">'+(s.image?'<img src="'+s.image+'" onclick="document.getElementById(\'sc'+i+'\').click()">':'<div class="placeholder" onclick="document.getElementById(\'sc'+i+'\').click()"><i class="ph-duotone ph-camera"></i>'+t('tapToAdd')+'</div>')+'<div class="step-image-actions"><button type="button" class="step-image-btn" onclick="document.getElementById(\'sc'+i+'\').click()" title="'+t('tipCamera')+'"><i class="ph-duotone ph-camera"></i> '+t('camera')+'</button><button type="button" class="step-image-btn" onclick="document.getElementById(\'si'+i+'\').click()" title="'+t('tipGallery')+'"><i class="ph-duotone ph-image"></i> '+t('gallery')+'</button>'+(s.image?'<button type="button" class="step-image-btn" onclick="clearStepImage('+i+')" title="'+t('tipRemove')+'"><i class="ph-duotone ph-trash"></i> '+t('remove')+'</button>':'')+'</div></div><input type="file" id="sc'+i+'" accept="image/*" capture="environment" style="display:none" onchange="handleImg('+i+',this)"><input type="file" id="si'+i+'" accept="image/*" style="display:none" onchange="handleImg('+i+',this)"></div><div class="step-actions"><button class="step-ai-btn" onclick="aiImproveStep('+i+')" title="'+t('tipAiStep')+'"><i class="ph-duotone ph-sparkle"></i></button><button class="step-action-btn delete" onclick="removeStep('+i+')" title="'+t('tipDeleteStep')+'"><i class="ph-duotone ph-trash"></i></button></div></div>').join('');}
    function addStep(){editingSteps.push({title:'',description:'',image:'',safety:false,quality:false});renderSteps();}
    function removeStep(i){if(editingSteps.length<=1){showToast('Need 1 step','error');return;}editingSteps.splice(i,1);renderSteps();}
    function updateStep(i,f,v){editingSteps[i][f]=v;}
    function toggleIcon(i,k){editingSteps[i][k]=!editingSteps[i][k];renderSteps();}
    function handleImg(i,inp){const f=inp.files[0];if(!f)return;
      // Resize image if too large (for storage efficiency)
      const maxSize = 800;
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          let w = img.width, h = img.height;
          if (w > maxSize || h > maxSize) {
            if (w > h) { h = h * (maxSize / w); w = maxSize; }
            else { w = w * (maxSize / h); h = maxSize; }
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          editingSteps[i].image = canvas.toDataURL('image/jpeg', 0.85);
          renderSteps();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(f);
    }
    function clearStepImage(i){editingSteps[i].image='';renderSteps();}
    function saveSOP(st){const ti=document.getElementById('sopTitle').value.trim(),de=document.getElementById('sopDept').value;if(!ti){showToast('Enter title','error');return;}if(!de){showToast('Select dept','error');return;}const tg=[];settings.tags.forEach(t=>{const c=document.getElementById('tag_'+t.name);if(c&&c.checked)tg.push(t.name);});const trans=window.sopTranslations||{};const d={title:ti,dept:de,docNum:document.getElementById('sopDocNum').value||'SOP-'+String(sops.length+1).padStart(3,'0'),revision:document.getElementById('sopRevision').value||'1.0',status:st,description:document.getElementById('sopDesc').value,tags:tg,steps:editingSteps.filter(s=>s.title||s.description),updatedAt:new Date().toISOString().split('T')[0],title_en:trans.title_en||ti,title_es:trans.title_es||'',desc_en:trans.desc_en||document.getElementById('sopDesc').value,desc_es:trans.desc_es||''};if(currentSopId){const i=sops.findIndex(s=>s.id===currentSopId);if(i!==-1){d.id=currentSopId;d.createdAt=sops[i].createdAt;sops[i]=d;}}else{d.id=Date.now();d.createdAt=d.updatedAt;sops.unshift(d);if(window.creatingFromRequestId){const r=sopRequests.find(x=>x.id===window.creatingFromRequestId);if(r){r.completed=true;r.completedAt=d.updatedAt;r.sopId=d.id;}window.creatingFromRequestId=null;updateRequestBadge();}}window.sopTranslations=null;saveToStorage();renderSOPs();updateStats();closeModal('editModal');showToast(st==='published'?'Published!':'Saved!','success');}
    function viewSOP(id){const s=sops.find(x=>x.id===id);if(!s)return;currentSopId=id;viewLang='en';document.querySelectorAll('#viewLangToggle button').forEach(b=>b.classList.toggle('active',b.textContent==='EN'));renderViewSOP(s);openModal('viewModal');}
    function editCurrentSOP(){closeModal('viewModal');editSOP(currentSopId);}
    function showQR(id){const s=sops.find(x=>x.id==id);if(!s)return;currentSopId=id;const u='https://rogueff.github.io/rogue-origin-apps/sop-manager.html?view='+id;document.getElementById('qrUrl').textContent=u;document.getElementById('qrImage').src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='+encodeURIComponent(u);openModal('qrModal');}
    function downloadQR(){const l=document.createElement('a');l.download='sop-qr-'+currentSopId+'.png';l.href=document.getElementById('qrImage').src;l.click();}
    function deleteSOP(id){if(!confirm('Delete?'))return;sops=sops.filter(s=>s.id!==id);saveToStorage();renderSOPs();updateStats();showToast('Deleted','success');}
    
    // SOP Requests Management
    function openRequestsModal(){
      updateReqDeptDropdown();
      renderRequests();
      openModal('requestsModal');
    }
    function updateReqDeptDropdown(){
      const html=settings.departments.map(d=>'<option value="'+d.name+'">'+d.name+'</option>').join('');
      document.getElementById('reqDept').innerHTML='<option value="">Any Department</option>'+html;
      document.getElementById('editReqDept').innerHTML='<option value="">Any Department</option>'+html;
    }
    function setRequestTab(tab){
      currentRequestTab=tab;
      document.querySelectorAll('.requests-tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(tab==='pending'?'tabPending':'tabCompleted').classList.add('active');
      document.getElementById('addRequestForm').style.display=tab==='pending'?'block':'none';
      renderRequests();
    }
    function renderRequests(){
      const pending=sopRequests.filter(r=>!r.completed);
      const completed=sopRequests.filter(r=>r.completed);
      document.getElementById('pendingCount').textContent=pending.length;
      document.getElementById('completedCount').textContent=completed.length;
      const list=currentRequestTab==='pending'?pending:completed;
      const container=document.getElementById('requestList');
      if(list.length===0){
        container.innerHTML='<div class="request-empty"><i class="ph-duotone ph-clipboard-text"></i><p>'+(currentRequestTab==='pending'?t('noPending'):t('noCompleted'))+'</p></div>';
        return;
      }
      container.innerHTML=list.sort((a,b)=>{
        const pOrder={high:0,medium:1,low:2};
        return pOrder[a.priority]-pOrder[b.priority];
      }).map(r=>{
        const isOverdue=r.dueDate&&new Date(r.dueDate)<new Date()&&!r.completed;
        const prioText = {high:t('high'),medium:t('medium'),low:t('low')}[r.priority];
        return '<div class="request-item '+(r.completed?'completed':'')+'">'+
          '<div class="request-item-header">'+
            '<div class="request-item-title">'+esc(r.title)+'</div>'+
            '<span class="request-item-priority '+r.priority+'">'+prioText+'</span>'+
          '</div>'+
          (r.notes?'<div class="request-item-desc">'+esc(r.notes)+'</div>':'')+
          '<div class="request-item-meta">'+
            (r.dept?'<span><i class="ph-duotone ph-folder"></i>'+r.dept+'</span>':'')+
            (r.assignee?'<span><i class="ph-duotone ph-user"></i>'+esc(r.assignee)+'</span>':'')+
            (r.dueDate?'<span style="'+(isOverdue?'color:var(--danger);font-weight:600;':'')+'"><i class="ph-duotone ph-calendar"></i>'+(isOverdue?t('overdue')+': ':'')+fmtDate(r.dueDate)+'</span>':'')+
            '<span><i class="ph-duotone ph-clock"></i>'+t('created')+' '+fmtDate(r.createdAt)+'</span>'+
            (r.completedAt?'<span style="color:var(--green);"><i class="ph-duotone ph-check-circle"></i>'+t('done')+' '+fmtDate(r.completedAt)+'</span>':'')+
          '</div>'+
          '<div class="request-item-actions">'+
            (r.completed?
              '<button class="request-action-delete" onclick="deleteRequest('+r.id+')"><i class="ph-duotone ph-trash"></i> '+t('delete')+'</button>':
              '<button class="request-action-create" onclick="createFromRequest('+r.id+')"><i class="ph-duotone ph-plus"></i> '+t('createSopBtn')+'</button>'+
              '<button class="request-action-complete" onclick="completeRequest('+r.id+')"><i class="ph-duotone ph-check"></i> '+t('done')+'</button>'+
              '<button class="request-action-edit" onclick="editRequest('+r.id+')"><i class="ph-duotone ph-pencil-simple"></i></button>'+
              '<button class="request-action-delete" onclick="deleteRequest('+r.id+')"><i class="ph-duotone ph-trash"></i></button>'
            )+
          '</div>'+
        '</div>';
      }).join('');
    }
    function addRequest(){
      const title=document.getElementById('reqTitle').value.trim();
      if(!title){showToast('Enter a title','error');return;}
      sopRequests.push({
        id:Date.now(),
        title:title,
        dept:document.getElementById('reqDept').value,
        priority:document.getElementById('reqPriority').value,
        assignee:document.getElementById('reqAssignee').value.trim(),
        dueDate:document.getElementById('reqDueDate').value,
        notes:document.getElementById('reqNotes').value.trim(),
        completed:false,
        createdAt:new Date().toISOString().split('T')[0]
      });
      saveToStorage();
      document.getElementById('reqTitle').value='';
      document.getElementById('reqAssignee').value='';
      document.getElementById('reqDueDate').value='';
      document.getElementById('reqNotes').value='';
      document.getElementById('reqPriority').value='medium';
      renderRequests();
      updateRequestBadge();
      showToast('Request added','success');
    }
    function completeRequest(id){
      const r=sopRequests.find(x=>x.id===id);
      if(r){r.completed=true;r.completedAt=new Date().toISOString().split('T')[0];}
      saveToStorage();renderRequests();updateRequestBadge();showToast('Marked complete','success');
    }
    function deleteRequest(id){
      if(!confirm('Delete this request?'))return;
      sopRequests=sopRequests.filter(r=>r.id!==id);
      saveToStorage();renderRequests();updateRequestBadge();showToast('Deleted','success');
    }
    function editRequest(id){
      const r=sopRequests.find(x=>x.id===id);
      if(!r)return;
      editingRequestId=id;
      document.getElementById('editReqTitle').value=r.title;
      document.getElementById('editReqDept').value=r.dept||'';
      document.getElementById('editReqPriority').value=r.priority;
      document.getElementById('editReqAssignee').value=r.assignee||'';
      document.getElementById('editReqDueDate').value=r.dueDate||'';
      document.getElementById('editReqNotes').value=r.notes||'';
      openModal('editRequestModal');
    }
    function saveRequestEdit(){
      const title=document.getElementById('editReqTitle').value.trim();
      if(!title){showToast('Enter a title','error');return;}
      const r=sopRequests.find(x=>x.id===editingRequestId);
      if(r){
        r.title=title;
        r.dept=document.getElementById('editReqDept').value;
        r.priority=document.getElementById('editReqPriority').value;
        r.assignee=document.getElementById('editReqAssignee').value.trim();
        r.dueDate=document.getElementById('editReqDueDate').value;
        r.notes=document.getElementById('editReqNotes').value.trim();
      }
      saveToStorage();
      closeModal('editRequestModal');
      renderRequests();
      showToast('Updated','success');
    }
    function createFromRequest(id){
      const r=sopRequests.find(x=>x.id===id);
      if(!r)return;
      closeModal('requestsModal');
      openCreateModal();
      document.getElementById('sopTitle').value=r.title;
      if(r.dept)document.getElementById('sopDept').value=r.dept;
      if(r.notes)document.getElementById('sopDesc').value=r.notes;
      // Mark request as the source
      window.creatingFromRequestId=id;
    }
    function updateRequestBadge(){
      const pending=sopRequests.filter(r=>!r.completed).length;
      const badge=document.getElementById('requestBadge');
      const stat=document.getElementById('statRequests');
      if(pending>0){badge.textContent=pending;badge.style.display='inline';}
      else{badge.style.display='none';}
      if(stat)stat.textContent=pending;
    }
    
    async function generatePDF(){
      const s=sops.find(x=>x.id===currentSopId);if(!s)return;
      const layout=document.querySelector('input[name="pdfLayout"]:checked')?.value||'2col';
      const includeQR=document.getElementById('pdfIncludeQR')?.checked;
      const bilingual=document.getElementById('pdfBilingual')?.checked;
      const pdfLang=document.querySelector('input[name="pdfLang"]:checked')?.value||'en';
      closeModal('pdfModal');showToast('Creating PDF...','success');
      
      try{
        const{jsPDF}=window.jspdf;
        const p=new jsPDF('p','mm','letter');
        const W=215.9,H=279.4,M=15;
        const green=[102,137,113],gold=[228,170,79],darkText=[45,58,46],mutedText=[90,107,95],lightBg=[250,248,244];
        
        // Load QR code if needed
        let qrData=null;
        if(includeQR){
          const qrUrl='https://rogueff.github.io/rogue-origin-apps/sop-manager.html?view='+s.id;
          try{
            const qrResp=await fetch('https://api.qrserver.com/v1/create-qr-code/?size=150x150&data='+encodeURIComponent(qrUrl));
            const qrBlob=await qrResp.blob();
            qrData=await new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(qrBlob);});
          }catch(e){console.log('QR fetch failed');}
        }
        
        // Helper: Add header to page
        function addHeader(pageNum,totalPages){
          // Green header bar
          p.setFillColor(...green);p.rect(0,0,W,30,'F');
          // Gold accent line
          p.setFillColor(...gold);p.rect(0,30,W,2,'F');
          // Header text
          p.setTextColor(255,255,255);p.setFontSize(11);p.setFont('helvetica','bold');
          p.text('ROGUE ORIGIN',M,13);
          p.setFontSize(18);p.text('STANDARD OPERATING PROCEDURE',M,24);
          // QR code in header (page 1 only)
          const hasQR=qrData&&pageNum===1;
          const textRightX=hasQR?W-M-30:W-M;
          // Doc info right side
          p.setFontSize(10);p.setFont('helvetica','normal');
          p.text(s.docNum+' | Rev '+s.revision,textRightX,13,{align:'right'});
          p.text(s.dept+(bilingual?' | EN/ES':''),textRightX,22,{align:'right'});
          // QR code
          if(hasQR){
            try{p.addImage(qrData,'PNG',W-M-24,4,24,24);}catch(e){}
            p.setFontSize(7);p.text('SCAN',W-M-12,29,{align:'center'});
          }
        }
        
        // Helper: Add footer
        function addFooter(pageNum,totalPages){
          p.setFillColor(...green);p.rect(0,H-14,W,14,'F');
          p.setTextColor(255,255,255);p.setFontSize(10);p.setFont('helvetica','normal');
          p.text(s.docNum,M,H-5);
          p.text('Page '+pageNum+' of '+totalPages,W/2,H-5,{align:'center'});
          p.text(new Date().toLocaleDateString(),W-M,H-5,{align:'right'});
        }
        
        // Calculate total pages first (rough estimate)
        let estPages=1;
        if(layout==='text')estPages=Math.ceil(s.steps.length/5)+1;
        else if(layout==='2col')estPages=Math.ceil(s.steps.length/2)+1;
        else estPages=Math.ceil(s.steps.length/3)+1;
        
        // PAGE 1: Cover/Title
        addHeader(1,estPages);
        let y=44;
        
        // Title section
        p.setTextColor(...darkText);p.setFontSize(24);p.setFont('helvetica','bold');
        const mainTitle=s.title;
        p.text(mainTitle,M,y);
        if(bilingual&&s.title_es){
          y+=9;p.setFontSize(18);p.setTextColor(...mutedText);p.setFont('helvetica','italic');
          p.text(s.title_es,M,y);
        }
        y+=14;
        
        // Description box
        if(s.description||s.desc_es){
          p.setFillColor(...lightBg);p.roundedRect(M,y,W-M*2,bilingual?40:26,3,3,'F');
          p.setFillColor(...green);p.rect(M,y,3,bilingual?40:26,'F');
          y+=6;
          if(s.description){
            p.setTextColor(...darkText);p.setFontSize(12);p.setFont('helvetica','normal');
            const descLines=p.splitTextToSize(s.description,W-M*2-12);
            p.text(descLines.slice(0,2),M+10,y+5);
            y+=descLines.slice(0,2).length*6;
          }
          if(bilingual&&s.desc_es){
            p.setTextColor(...mutedText);p.setFontSize(11);p.setFont('helvetica','italic');
            const descEsLines=p.splitTextToSize(s.desc_es,W-M*2-12);
            p.text(descEsLines.slice(0,2),M+10,y+7);
          }
          y+=bilingual?22:14;
        }
        y+=10;
        
        // STEPS header
        p.setFillColor(...gold);p.roundedRect(M,y,60,10,2,2,'F');
        p.setTextColor(...darkText);p.setFontSize(13);p.setFont('helvetica','bold');
        p.text(bilingual?'STEPS / PASOS':'STEPS',M+5,y+7);
        y+=18;
        
        let pageNum=1;
        
        // LAYOUT: TEXT ONLY - Compact list with images
        if(layout==='text'){
          for(let i=0;i<s.steps.length;i++){
            const st=s.steps[i];
            const hasImg=st.image&&st.image.startsWith('data:');
            const blockH=hasImg?55:(bilingual?35:24);
            
            if(y+blockH>H-20){
              addFooter(pageNum,estPages);p.addPage();pageNum++;addHeader(pageNum,estPages);y=40;
            }
            
            // Step number circle
            p.setFillColor(...green);p.circle(M+8,y+8,8,'F');
            p.setTextColor(255,255,255);p.setFontSize(14);p.setFont('helvetica','bold');
            p.text(String(i+1),i<9?M+5:M+3,y+11);
            
            // Title
            const titleEn=st.title||'Step '+(i+1);
            const titleEs=st.title_es||'';
            p.setTextColor(...darkText);p.setFontSize(14);p.setFont('helvetica','bold');
            p.text(titleEn,M+22,y+11);
            
            let textX=M+22,textY=y+20;
            
            // Image on right if exists
            if(hasImg){
              try{p.addImage(st.image,'JPEG',W-M-40,y-2,36,36);}catch(e){}
              textX=M+22;
            }
            
            // Description EN
            if(st.description){
              p.setFontSize(11);p.setFont('helvetica','normal');p.setTextColor(...mutedText);
              const maxW=hasImg?W-M*2-60:W-M*2-26;
              const lines=p.splitTextToSize(st.description,maxW);
              p.text(lines.slice(0,2),textX,textY);
              textY+=lines.slice(0,2).length*5+3;
            }
            
            // Description ES (bilingual)
            if(bilingual&&st.desc_es){
              p.setFontSize(10);p.setFont('helvetica','italic');p.setTextColor(120,130,125);
              const maxW=hasImg?W-M*2-60:W-M*2-26;
              const linesEs=p.splitTextToSize(st.desc_es,maxW);
              p.text(linesEs.slice(0,2),textX,textY);
            }
            
            y+=blockH;
            
            // Separator line
            if(i<s.steps.length-1){
              p.setDrawColor(220,215,205);p.setLineWidth(0.3);
              p.line(M+22,y-4,W-M,y-4);
            }
          }
        }
        
        // LAYOUT: 2 PER PAGE - Large cards with images
        else if(layout==='2col'){
          const cardH=118;
          for(let i=0;i<s.steps.length;i++){
            if(y+cardH>H-20){
              addFooter(pageNum,estPages);p.addPage();pageNum++;addHeader(pageNum,estPages);y=40;
            }
            
            const st=s.steps[i];
            const hasImg=st.image&&st.image.startsWith('data:');
            
            // Card background
            p.setFillColor(...lightBg);p.roundedRect(M,y,W-M*2,cardH-8,4,4,'F');
            
            // Step number badge
            p.setFillColor(...green);p.roundedRect(M,y,32,32,4,0,'F');
            p.setTextColor(255,255,255);p.setFontSize(22);p.setFont('helvetica','bold');
            p.text(String(i+1),i<9?M+11:M+6,y+22);
            
            // Title EN
            const titleEn=st.title||'Step '+(i+1);
            p.setTextColor(...darkText);p.setFontSize(16);p.setFont('helvetica','bold');
            p.text(titleEn.substring(0,40),M+38,y+14);
            
            // Title ES
            if(bilingual&&st.title_es){
              p.setTextColor(...mutedText);p.setFontSize(13);p.setFont('helvetica','italic');
              p.text(st.title_es.substring(0,45),M+38,y+24);
            }
            
            let descY=y+(bilingual?34:26);
            const imgW=hasImg?50:0;
            const descMaxW=W-M*2-48-imgW;
            
            // Image
            if(hasImg){
              try{p.addImage(st.image,'JPEG',W-M-48,y+6,44,44);}catch(e){}
            }
            
            // Description EN
            if(st.description){
              p.setFontSize(12);p.setFont('helvetica','normal');p.setTextColor(...darkText);
              const lines=p.splitTextToSize(st.description,descMaxW);
              p.text(lines.slice(0,3),M+38,descY);
              descY+=lines.slice(0,3).length*5+5;
            }
            
            // Description ES
            if(bilingual&&st.desc_es){
              p.setFontSize(11);p.setFont('helvetica','italic');p.setTextColor(100,115,105);
              const linesEs=p.splitTextToSize(st.desc_es,descMaxW);
              p.text(linesEs.slice(0,3),M+38,descY);
            }
            
            // Gold accent on left
            p.setFillColor(...gold);p.rect(M,y+32,3,cardH-40,'F');
            
            y+=cardH;
          }
        }
        
        // LAYOUT: 4 PER PAGE - Compact grid
        else if(layout==='4col'){
          const cols=2,cardW=(W-M*2-8)/2,cardH=68;
          let col=0,startY=y;
          
          for(let i=0;i<s.steps.length;i++){
            const x=M+col*(cardW+8);
            const yPos=y;
            
            if(yPos+cardH>H-20){
              addFooter(pageNum,estPages);p.addPage();pageNum++;addHeader(pageNum,estPages);
              y=40;startY=40;col=0;
            }
            
            const st=s.steps[i];
            const hasImg=st.image&&st.image.startsWith('data:');
            
            // Card
            p.setFillColor(...lightBg);p.roundedRect(x,y,cardW,cardH-4,3,3,'F');
            
            // Number
            p.setFillColor(...green);p.circle(x+12,y+12,9,'F');
            p.setTextColor(255,255,255);p.setFontSize(14);p.setFont('helvetica','bold');
            p.text(String(i+1),i<9?x+9:x+6,y+16);
            
            // Title
            const titleEn=(st.title||'Step '+(i+1)).substring(0,20);
            p.setTextColor(...darkText);p.setFontSize(12);p.setFont('helvetica','bold');
            p.text(titleEn,x+26,y+14);
            
            // Image thumbnail
            if(hasImg){
              try{p.addImage(st.image,'JPEG',x+cardW-30,y+4,26,26);}catch(e){}
            }
            
            // Description (compact)
            let descY=y+24;
            const descW=hasImg?cardW-42:cardW-14;
            if(st.description){
              p.setFontSize(9);p.setFont('helvetica','normal');p.setTextColor(...mutedText);
              const lines=p.splitTextToSize(st.description,descW);
              p.text(lines.slice(0,bilingual?2:3),x+8,descY);
              descY+=lines.slice(0,bilingual?2:3).length*4+3;
            }
            if(bilingual&&st.desc_es){
              p.setFontSize(8);p.setFont('helvetica','italic');p.setTextColor(120,130,125);
              const linesEs=p.splitTextToSize(st.desc_es,descW);
              p.text(linesEs.slice(0,2),x+8,descY);
            }
            
            col++;
            if(col>=cols){col=0;y+=cardH;}
          }
          if(col>0)y+=cardH; // Finish partial row
        }
        
        // Final footer
        addFooter(pageNum,estPages);
        
        // Update actual page count
        const actualPages=p.internal.getNumberOfPages();
        for(let pg=1;pg<=actualPages;pg++){
          p.setPage(pg);
          // Redraw footer with correct total
          p.setFillColor(...green);p.rect(0,H-14,W,14,'F');
          p.setTextColor(255,255,255);p.setFontSize(10);
          p.text(s.docNum,M,H-5);
          p.text('Page '+pg+' of '+actualPages,W/2,H-5,{align:'center'});
          p.text(new Date().toLocaleDateString(),W-M,H-5,{align:'right'});
        }
        
        p.save(s.docNum.replace(/[^a-z0-9]/gi,'-')+'.pdf');
        showToast('PDF saved!','success');
      }catch(e){console.error(e);showToast('PDF error: '+e.message,'error');}
    }
    // API Key Management
    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (key) {
        localStorage.setItem('sopAnthropicApiKey', key);
        showToast('API key saved!', 'success');
      } else {
        localStorage.removeItem('sopAnthropicApiKey');
      }
      updateApiKeyStatus(!!key && !!getProxyUrl());
    }
    
    function loadApiKeyToInput() {
      const key = getApiKey();
      const proxyUrl = getProxyUrl();
      document.getElementById('apiKeyInput').value = key;
      document.getElementById('proxyUrlInput').value = proxyUrl;
      updateApiKeyStatus(!!key && !!proxyUrl);
    }
    
    function updateApiKeyStatus(ready) {
      const status = document.getElementById('apiKeyStatus');
      const usingDefaults = getApiKey() === DEFAULT_API_KEY && getProxyUrl() === DEFAULT_PROXY_URL;
      if (ready && usingDefaults) {
        status.innerHTML = '<span style="color:var(--green);"><i class="ph-duotone ph-check-circle"></i> Using team API - ready to go!</span>';
      } else if (ready) {
        status.innerHTML = '<span style="color:var(--green);"><i class="ph-duotone ph-check-circle"></i> Custom API configured</span>';
      } else if (getApiKey() && !getProxyUrl()) {
        status.innerHTML = '<span style="color:var(--gold);"><i class="ph-duotone ph-info"></i> Add Proxy URL to enable AI</span>';
      } else if (!getApiKey() && getProxyUrl()) {
        status.innerHTML = '<span style="color:var(--gold);"><i class="ph-duotone ph-info"></i> Add API Key to enable AI</span>';
      } else {
        status.innerHTML = '<span style="color:var(--text-light);"><i class="ph-duotone ph-info"></i> Rule-based improve active. Add API + Proxy for AI.</span>';
      }
    }
    
    function toggleApiKeyVisibility() {
      const input = document.getElementById('apiKeyInput');
      const icon = document.getElementById('apiKeyEyeIcon');
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'ph-duotone ph-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'ph-duotone ph-eye';
      }
    }
    
    function getApiKey() {
      return localStorage.getItem('sopAnthropicApiKey') || DEFAULT_API_KEY;
    }
    
    function getProxyUrl() {
      return localStorage.getItem('sopProxyUrl') || DEFAULT_PROXY_URL;
    }
    
    function saveProxyUrl() {
      const url = document.getElementById('proxyUrlInput').value.trim();
      if (url) {
        localStorage.setItem('sopProxyUrl', url);
        showToast('Proxy URL saved!', 'success');
      } else {
        localStorage.removeItem('sopProxyUrl');
      }
      updateApiKeyStatus(!!getApiKey() && !!url);
    }
    
    async function testApiConnection() {
      const apiKey = getApiKey();
      const proxyUrl = getProxyUrl();
      
      if (!apiKey) {
        showToast('Enter API key first', 'error');
        return;
      }
      
      if (!proxyUrl) {
        showToast('Enter Proxy URL first', 'error');
        return;
      }
      
      const statusEl = document.getElementById('apiKeyStatus');
      statusEl.innerHTML = '<span style="color:var(--gold);"><i class="ph-duotone ph-spinner"></i> Testing connection...</span>';
      
      try {
        const response = await fetch(proxyUrl, {
          method: 'POST',
          body: JSON.stringify({
            apiKey: apiKey,
            body: {
              model: 'claude-3-5-haiku-20241022',
              max_tokens: 10,
              messages: [{ role: 'user', content: 'Say OK' }]
            }
          })
        });
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.content && data.content[0]) {
          statusEl.innerHTML = '<span style="color:var(--green);"><i class="ph-duotone ph-check-circle"></i> Connection successful! AI features ready.</span>';
          showToast('API connected!', 'success');
        } else if (data.error) {
          const errMsg = typeof data.error === 'string' ? data.error : (data.error.message || JSON.stringify(data.error));
          statusEl.innerHTML = '<span style="color:var(--danger);"><i class="ph-duotone ph-x-circle"></i> Error: ' + errMsg + '</span>';
          console.error('API Error:', data.error);
        } else {
          statusEl.innerHTML = '<span style="color:var(--danger);"><i class="ph-duotone ph-x-circle"></i> Unexpected response - check console</span>';
          console.log('Full response:', data);
        }
      } catch (e) {
        console.error('Connection test error:', e);
        statusEl.innerHTML = '<span style="color:var(--danger);"><i class="ph-duotone ph-x-circle"></i> Connection failed: ' + e.message + '</span>';
      }
    }
    
    // AI Improve Functions
    async function aiImproveText(text, type) {
      const apiKey = getApiKey();
      
      if (!text || text.trim().length < 3) {
        showToast(t('enterTextFirst'), 'error');
        return null;
      }
      
      // Try API first if key exists
      if (apiKey) {
        const result = await tryApiImprove(text, type, apiKey);
        if (result) return result;
      }
      
      // Fallback to rule-based improvement
      return ruleBasedImprove(text, type);
    }
    
    function ruleBasedImprove(text, type) {
      let improved = text.trim();
      
      // Common abbreviations to expand
      const abbrevs = {
        'temp': 'temperature', 'temps': 'temperatures',
        'min': 'minutes', 'mins': 'minutes', 
        'sec': 'seconds', 'secs': 'seconds',
        'hr': 'hour', 'hrs': 'hours',
        'approx': 'approximately', 'approx.': 'approximately',
        'eq': 'equipment', 'equip': 'equipment',
        'maint': 'maintenance', 'mfg': 'manufacturing',
        'qty': 'quantity', 'amt': 'amount',
        'req': 'required', 'reqd': 'required',
        'std': 'standard', 'spec': 'specification',
        'info': 'information', 'config': 'configuration',
        'auth': 'authorized', 'cert': 'certified',
        'dept': 'department', 'mgr': 'manager',
        'pls': 'please', 'thru': 'through',
        'w/': 'with', 'w/o': 'without',
        '&': 'and', 'vs': 'versus'
      };
      
      // Action verbs for step titles
      const actionVerbs = ['Verify', 'Check', 'Inspect', 'Confirm', 'Ensure', 'Review', 
        'Prepare', 'Set up', 'Configure', 'Adjust', 'Clean', 'Sanitize', 
        'Start', 'Activate', 'Power on', 'Initialize', 'Begin',
        'Stop', 'Shut down', 'Power off', 'Deactivate', 'Complete',
        'Record', 'Document', 'Log', 'Note', 'Enter',
        'Apply', 'Install', 'Attach', 'Connect', 'Secure',
        'Remove', 'Detach', 'Disconnect', 'Release'];
      
      // Expand abbreviations (case-insensitive word boundaries)
      Object.entries(abbrevs).forEach(([abbr, full]) => {
        const regex = new RegExp('\\b' + abbr.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
        improved = improved.replace(regex, full);
      });
      
      // Type-specific improvements
      if (type === 'title' || type === 'stepTitle') {
        // Title Case
        improved = improved.split(' ').map((word, i) => {
          const lower = word.toLowerCase();
          // Keep small words lowercase unless first word
          if (i > 0 && ['a', 'an', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with'].includes(lower)) {
            return lower;
          }
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }).join(' ');
        
        // For step titles, ensure it starts with action verb if it doesn't
        if (type === 'stepTitle') {
          const firstWord = improved.split(' ')[0].toLowerCase();
          const hasActionVerb = actionVerbs.some(v => v.toLowerCase() === firstWord);
          if (!hasActionVerb && improved.length > 0) {
            // Try to infer an action verb
            const lowerText = improved.toLowerCase();
            if (lowerText.includes('check') || lowerText.includes('verify') || lowerText.includes('inspect')) {
              improved = 'Verify ' + improved.charAt(0).toLowerCase() + improved.slice(1);
            } else if (lowerText.includes('clean') || lowerText.includes('sanitize') || lowerText.includes('wash')) {
              improved = 'Clean ' + improved.charAt(0).toLowerCase() + improved.slice(1);
            } else if (lowerText.includes('start') || lowerText.includes('begin') || lowerText.includes('power')) {
              improved = 'Start ' + improved.charAt(0).toLowerCase() + improved.slice(1);
            }
          }
        }
        
        // Remove trailing period from titles
        improved = improved.replace(/\.$/, '');
        
      } else if (type === 'description' || type === 'stepDescription') {
        // Capitalize first letter
        improved = improved.charAt(0).toUpperCase() + improved.slice(1);
        
        // Ensure ends with period
        if (!/[.!?]$/.test(improved)) {
          improved += '.';
        }
        
        // Fix double spaces
        improved = improved.replace(/\s+/g, ' ');
        
        // Capitalize after periods
        improved = improved.replace(/\.\s+([a-z])/g, (m, c) => '. ' + c.toUpperCase());
      }
      
      return improved;
    }
    
    async function tryApiImprove(text, type, apiKey) {
      const proxyUrl = getProxyUrl();
      if (!proxyUrl) {
        return null; // No proxy, fall back to rule-based
      }
      
      const prompts = {
        title: `You are an expert technical writer for Standard Operating Procedures (SOPs) in a cannabis production facility. Improve this SOP title to be clear, professional, and descriptive. Use title case. Keep it under 10 words. Only return the improved title, nothing else.

Original: ${text}`,
        description: `You are an expert technical writer for Standard Operating Procedures (SOPs) in a cannabis production facility. Improve this SOP description to be clear, professional, and actionable. Keep it concise (2-3 sentences max). Only return the improved text, nothing else.

Original: ${text}`,
        stepTitle: `You are an expert technical writer for SOPs. Improve this step title to be clear, concise, and action-oriented (start with a verb). Keep it under 8 words. Only return the improved title, nothing else.

Original: ${text}`,
        stepDescription: `You are an expert technical writer for SOPs in a cannabis production facility. Improve this step description to be clear, specific, and actionable. Include any relevant safety or quality notes if implied. Keep it to 1-2 sentences. Only return the improved text, nothing else.

Original: ${text}`
      };
      
      try {
        const response = await fetch(proxyUrl, {
          method: 'POST',
          body: JSON.stringify({
            apiKey: apiKey,
            body: {
              model: 'claude-3-5-haiku-20241022',
              max_tokens: 200,
              messages: [{ role: 'user', content: prompts[type] }]
            }
          })
        });
        
        if (!response.ok) {
          console.error('API error:', response.status);
          return null;
        }
        
        const data = await response.json();
        return data.content?.[0]?.text?.trim() || null;
      } catch (e) {
        console.error('AI API error:', e);
        return null;
      }
    }
    
    async function aiImproveDescription() {
      const textarea = document.getElementById('sopDesc');
      const btn = textarea.parentElement.querySelector('.ai-improve-btn');
      const originalText = textarea.value.trim();
      
      if (!originalText) {
        showToast('Enter a description first', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.classList.add('loading');
      btn.innerHTML = '<i class="ph-duotone ph-spinner"></i> Improving...';
      
      const improved = await aiImproveText(originalText, 'description');
      
      if (improved) {
        textarea.value = improved;
        showToast('Description improved!', 'success');
      }
      
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.innerHTML = '<i class="ph-duotone ph-sparkle"></i> Improve';
    }
    
    async function aiImproveTitle() {
      const input = document.getElementById('sopTitle');
      const btn = input.parentElement.querySelector('.ai-improve-btn');
      const originalText = input.value.trim();
      
      if (!originalText) {
        showToast('Enter a title first', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.classList.add('loading');
      btn.innerHTML = '<i class="ph-duotone ph-spinner"></i> Improving...';
      
      const improved = await aiImproveText(originalText, 'title');
      
      if (improved) {
        input.value = improved;
        showToast('Title improved!', 'success');
      }
      
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.innerHTML = '<i class="ph-duotone ph-sparkle"></i> Improve';
    }
    
    async function aiImproveStep(index) {
      const step = editingSteps[index];
      if (!step) return;
      
      const btn = document.querySelectorAll('.step-ai-btn')[index];
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="ph-duotone ph-spinner"></i>';
      }
      
      let improved = false;
      
      // Improve title if exists
      if (step.title && step.title.trim()) {
        const improvedTitle = await aiImproveText(step.title, 'stepTitle');
        if (improvedTitle) {
          editingSteps[index].title = improvedTitle;
          improved = true;
        }
      }
      
      // Improve description if exists
      if (step.description && step.description.trim()) {
        const improvedDesc = await aiImproveText(step.description, 'stepDescription');
        if (improvedDesc) {
          editingSteps[index].description = improvedDesc;
          improved = true;
        }
      }
      
      if (improved) {
        renderSteps();
        showToast('Step improved!', 'success');
      } else {
        showToast('Enter title or description first', 'error');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="ph-duotone ph-sparkle"></i>';
        }
      }
    }
    
    async function aiImproveAllSteps() {
      const btn = document.getElementById('aiImproveAllBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="ph-duotone ph-spinner"></i> Improving...';
      }
      
      for (let i = 0; i < editingSteps.length; i++) {
        await aiImproveStep(i);
      }
      
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<i class="ph-duotone ph-sparkle"></i> AI Improve All';
      }
      showToast('All steps improved!', 'success');
    }
    
    function toggleDarkMode(){document.body.classList.toggle('dark-mode');localStorage.setItem('sopDarkMode',document.body.classList.contains('dark-mode'));}
    
    function toggleAppLang(){
      appLang = appLang === 'en' ? 'es' : 'en';
      localStorage.setItem('sopAppLang', appLang);
      applyTranslations();
      updateDropdowns();
      renderSOPs();
      updateStats();
      renderSteps();
    }
    
    function applyTranslations(){
      document.getElementById('appLangLabel').textContent = appLang.toUpperCase();
      document.querySelector('.header-title').textContent = t('headerTitle');
      
      // Header buttons
      document.querySelector('[data-i18n="dark"]').textContent = t('dark');
      document.querySelector('[data-i18n="requests"]').textContent = t('requests');
      document.querySelector('[data-i18n="newSop"]').textContent = t('newSop');
      
      // Stats
      document.querySelectorAll('.stat-card-label')[0].textContent = t('total');
      document.querySelectorAll('.stat-card-label')[1].textContent = t('published');
      document.querySelectorAll('.stat-card-label')[2].textContent = t('drafts');
      document.querySelectorAll('.stat-card-label')[3].textContent = t('requestsLabel');
      document.querySelectorAll('.stat-card-label')[4].textContent = t('thisMonth');
      
      // Toolbar
      document.getElementById('searchInput').placeholder = t('searchPlaceholder');
      const statusFilter = document.getElementById('statusFilter');
      statusFilter.options[0].text = t('allSops');
      statusFilter.options[1].text = t('publishedFilter');
      statusFilter.options[2].text = t('draftsFilter');
      
      // Empty state
      const emptyH3 = document.querySelector('#emptyState h3');
      const emptyP = document.querySelector('#emptyState p');
      const emptyBtn = document.querySelector('#emptyState button');
      if(emptyH3) emptyH3.textContent = t('noSopsFound');
      if(emptyP) emptyP.textContent = t('createFirst');
      if(emptyBtn) emptyBtn.innerHTML = '<i class="ph-duotone ph-plus"></i> ' + t('createSop');
    }
    
    function loadAppLang(){
      appLang = localStorage.getItem('sopAppLang') || 'en';
      applyTranslations();
    }
    function showToast(m,t){const e=document.getElementById('toast');document.getElementById('toastMsg').textContent=m;e.className='toast show '+t;e.querySelector('i').className=t==='success'?'ph-duotone ph-check-circle':'ph-duotone ph-warning-circle';setTimeout(()=>e.classList.remove('show'),3000);}
    function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
    function fmtDate(s){if(!s)return'';return new Date(s).toLocaleDateString(appLang==='es'?'es-ES':'en-US',{month:'short',day:'numeric',year:'numeric'});}
    
    // ============================================
    // AI Generate SOPs Feature
    // ============================================
    let generatedSOPs = [];
    
    function openAIGenerateModal() {
      // API is pre-configured with defaults, so no need to check
      
      // Reset modal state
      document.getElementById('aiGenStep1').style.display = 'block';
      document.getElementById('aiGenStep2').style.display = 'none';
      document.getElementById('aiGenStep3').style.display = 'none';
      document.getElementById('aiGenStartBtn').style.display = 'inline-flex';
      document.getElementById('aiGenImportBtn').style.display = 'none';
      document.getElementById('aiGenEquipment').value = '';
      document.getElementById('aiGenContext').value = '';
      document.getElementById('aiGenResults').innerHTML = '';
      generatedSOPs = [];
      
      // Populate department dropdown
      const deptSelect = document.getElementById('aiGenDept');
      deptSelect.innerHTML = settings.departments.map(d => 
        `<option value="${d.name}">${d.name}</option>`
      ).join('');
      // Default to Equipment if exists, else first
      const equipDept = settings.departments.find(d => d.name === 'Equipment');
      if (equipDept) deptSelect.value = 'Equipment';
      
      openModal('aiGenerateModal');
    }
    
    async function startAIGenerate() {
      const equipment = document.getElementById('aiGenEquipment').value.trim();
      if (!equipment) {
        showToast('Please enter equipment name', 'error');
        return;
      }
      
      const dept = document.getElementById('aiGenDept').value;
      const context = document.getElementById('aiGenContext').value.trim();
      
      // Get selected SOP types
      const sopTypes = [];
      if (document.getElementById('aiGenDaily').checked) sopTypes.push('daily_inspection');
      if (document.getElementById('aiGenStartup').checked) sopTypes.push('startup_shutdown');
      if (document.getElementById('aiGenService').checked) sopTypes.push('scheduled_service');
      if (document.getElementById('aiGenCleaning').checked) sopTypes.push('cleaning');
      if (document.getElementById('aiGenSafety').checked) sopTypes.push('safety');
      if (document.getElementById('aiGenTroubleshoot').checked) sopTypes.push('troubleshooting');
      
      if (sopTypes.length === 0) {
        showToast('Select at least one SOP type', 'error');
        return;
      }
      
      // Show progress
      document.getElementById('aiGenStep1').style.display = 'none';
      document.getElementById('aiGenStep2').style.display = 'block';
      document.getElementById('aiGenStartBtn').style.display = 'none';
      
      try {
        updateAIGenProgress('Searching for documentation...', `Finding manuals and specs for ${equipment}`);
        
        const apiKey = getApiKey();
        const proxyUrl = getProxyUrl();
        
        // Build the prompt
        const sopTypeDescriptions = {
          'daily_inspection': 'Daily Pre-Operation Inspection - checks before each use',
          'startup_shutdown': 'Safe Startup and Shutdown Procedures',
          'scheduled_service': 'Scheduled Maintenance/Service intervals (include part numbers if found)',
          'cleaning': 'Cleaning and Sanitation Procedures',
          'safety': 'Safety Procedures and Hazard Awareness',
          'troubleshooting': 'Common Issues and Troubleshooting Guide'
        };
        
        const selectedDescriptions = sopTypes.map(t => sopTypeDescriptions[t]).join('\n- ');
        
        const systemPrompt = `You are an expert technical writer creating Standard Operating Procedures (SOPs) for equipment maintenance and operation. 

Your task is to search for official documentation, manuals, and service guides for the specified equipment, then create comprehensive SOPs based on manufacturer recommendations.

IMPORTANT: You must output ONLY valid JSON - no markdown, no explanation, no code blocks. Just the raw JSON array.

Output format - a JSON array of SOP objects:
[
  {
    "title": "Equipment Name - SOP Type",
    "docNum": "EQ-XXX-001",
    "description": "Brief 1-2 sentence description",
    "tags": ["tag1", "tag2"],
    "steps": [
      {"title": "Step Title (action verb)", "description": "Detailed step description with specifics", "safety": true/false, "quality": true/false}
    ]
  }
]

Guidelines:
- Include specific part numbers, fluid capacities, torque specs when found
- Mark steps as safety:true if they involve hazards, PPE, or safety checks
- Mark steps as quality:true if they're quality control checkpoints
- Each SOP should have 8-15 detailed steps
- Step titles should start with action verbs
- Include manufacturer-specific terminology and recommendations`;

        const userPrompt = `Search for official documentation for: ${equipment}

Create SOPs for the following types:
- ${selectedDescriptions}

Department: ${dept}
${context ? `Additional context: ${context}` : ''}

Search for:
1. Official operator's manual / owner's manual
2. Service/maintenance manual
3. Parts diagrams with part numbers
4. Safety guidelines
5. Maintenance schedules and intervals

Then generate comprehensive SOPs based on what you find. Include specific details like:
- Fluid types and capacities
- Filter part numbers
- Service intervals (hours or time-based)
- Safety warnings from the manual
- Torque specifications
- Step-by-step procedures

Output ONLY the JSON array, nothing else.`;

        updateAIGenProgress('Generating SOPs...', 'Claude is researching and writing procedures');
        
        // Call Claude API with web search
        const response = await fetch(proxyUrl, {
          method: 'POST',
          body: JSON.stringify({
            apiKey: apiKey,
            body: {
              model: 'claude-sonnet-4-20250514',
              max_tokens: 8000,
              tools: [{ type: 'web_search_20250305', name: 'web_search' }],
              system: systemPrompt,
              messages: [{ role: 'user', content: userPrompt }]
            }
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message || 'API error');
        }
        
        // Extract text from response (may have multiple content blocks due to tool use)
        let responseText = '';
        if (data.content) {
          for (const block of data.content) {
            if (block.type === 'text') {
              responseText += block.text;
            }
          }
        }
        
        // Parse the JSON response
        let sopsArray;
        try {
          // Try to extract JSON from the response (handle markdown code blocks)
          let jsonStr = responseText;
          const jsonMatch = responseText.match(/\[[\s\S]*\]/);
          if (jsonMatch) {
            jsonStr = jsonMatch[0];
          }
          sopsArray = JSON.parse(jsonStr);
        } catch (parseError) {
          console.error('Parse error:', parseError, responseText);
          throw new Error('Failed to parse AI response. Please try again.');
        }
        
        if (!Array.isArray(sopsArray) || sopsArray.length === 0) {
          throw new Error('No SOPs generated. Try a different equipment name.');
        }
        
        // Process and store generated SOPs
        generatedSOPs = sopsArray.map((sop, idx) => ({
          id: Date.now() + idx,
          title: sop.title || `${equipment} SOP ${idx + 1}`,
          dept: dept,
          docNum: sop.docNum || `EQ-GEN-${String(idx + 1).padStart(3, '0')}`,
          revision: '1.0',
          status: 'draft',
          description: sop.description || '',
          tags: sop.tags || ['generated'],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          steps: (sop.steps || []).map(step => ({
            title: step.title || 'Step',
            description: step.description || '',
            image: '',
            safety: step.safety || false,
            quality: step.quality || false
          })),
          selected: true
        }));
        
        // Show results
        showAIGenResults();
        
      } catch (error) {
        console.error('AI Generate error:', error);
        showToast(error.message || 'Failed to generate SOPs', 'error');
        // Go back to step 1
        document.getElementById('aiGenStep1').style.display = 'block';
        document.getElementById('aiGenStep2').style.display = 'none';
        document.getElementById('aiGenStartBtn').style.display = 'inline-flex';
      }
    }
    
    function updateAIGenProgress(title, sub, log) {
      document.getElementById('aiGenProgressTitle').textContent = title;
      document.getElementById('aiGenProgressSub').textContent = sub;
      if (log) document.getElementById('aiGenProgressLog').textContent = log;
    }
    
    function showAIGenResults() {
      document.getElementById('aiGenStep2').style.display = 'none';
      document.getElementById('aiGenStep3').style.display = 'block';
      document.getElementById('aiGenImportBtn').style.display = 'inline-flex';
      document.getElementById('aiGenCount').textContent = generatedSOPs.length;
      
      const resultsDiv = document.getElementById('aiGenResults');
      resultsDiv.innerHTML = generatedSOPs.map((sop, idx) => `
        <div class="ai-gen-result ${sop.selected ? 'selected' : ''}" onclick="toggleAIGenSOP(${idx})">
          <div class="ai-gen-result-header">
            <input type="checkbox" ${sop.selected ? 'checked' : ''} onclick="event.stopPropagation(); toggleAIGenSOP(${idx})">
            <div>
              <div class="ai-gen-result-title">${esc(sop.title)}</div>
              <div class="ai-gen-result-meta">${esc(sop.docNum)} • ${sop.steps.length} steps</div>
              ${sop.description ? `<div class="ai-gen-result-meta" style="margin-top:4px;">${esc(sop.description)}</div>` : ''}
            </div>
          </div>
          <div class="ai-gen-result-steps">
            <strong>Steps:</strong> ${sop.steps.slice(0, 5).map(s => esc(s.title)).join(' → ')}${sop.steps.length > 5 ? ' → ...' : ''}
          </div>
        </div>
      `).join('');
    }
    
    function toggleAIGenSOP(idx) {
      generatedSOPs[idx].selected = !generatedSOPs[idx].selected;
      showAIGenResults();
    }
    
    function importGeneratedSOPs() {
      const toImport = generatedSOPs.filter(s => s.selected);
      if (toImport.length === 0) {
        showToast('Select at least one SOP to import', 'error');
        return;
      }
      
      // Clean up the SOPs for import (remove 'selected' flag)
      const cleanSOPs = toImport.map(sop => {
        const { selected, ...clean } = sop;
        return clean;
      });
      
      // Add to existing SOPs
      sops.push(...cleanSOPs);
      saveToStorage();
      renderSOPs();
      updateStats();
      
      closeModal('aiGenerateModal');
      showToast(`Imported ${cleanSOPs.length} SOPs successfully!`, 'success');
    }
  </script>
</body>
</html>
