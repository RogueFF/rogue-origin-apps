<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rogue Origin - Operations Hub</title>
  <!-- Fonts: Inter (existing) + DM Serif Display, JetBrains Mono, Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- Muuri.js for drag-and-drop (replacing Sortable.js) -->
  <script src="https://cdn.jsdelivr.net/npm/muuri@0.9.5/dist/muuri.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web-animations-js@2.3.2/web-animations.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    /* ========================================
       CSS VARIABLES - HYBRID THEME SYSTEM
       ======================================== */
    :root {
      /* ===== TYPOGRAPHY ===== */
      --font-display: 'DM Serif Display', serif;
      --font-mono: 'JetBrains Mono', monospace;
      --font-ui: 'Outfit', 'Inter', sans-serif;

      /* Type Scale */
      --text-hero: 96px;
      --text-hero-mobile: 64px;
      --text-display: 48px;
      --text-display-sm: 36px;
      --text-h1: 28px;
      --text-h2: 22px;
      --text-h3: 18px;
      --text-h4: 16px;
      --text-body: 14px;
      --text-sm: 13px;
      --text-xs: 11px;
      --text-xxs: 10px;
      --text-mono-lg: 18px;
      --text-mono-md: 14px;
      --text-mono-sm: 12px;

      /* Line Heights */
      --leading-tight: 1.1;
      --leading-snug: 1.25;
      --leading-normal: 1.5;
      --leading-relaxed: 1.625;

      /* Letter Spacing */
      --tracking-tight: -0.02em;
      --tracking-normal: 0;
      --tracking-wide: 0.05em;
      --tracking-wider: 0.08em;
      --tracking-widest: 0.1em;

      /* ===== COLORS ===== */
      /* Brand */
      --ro-green: #668971;
      --ro-gold: #e4aa4f;

      /* Green Family */
      --green-50: #f4f7f5;
      --green-100: #e8efe9;
      --green-200: #d1dfd4;
      --green-300: #a8c4ad;
      --green-400: #8ba896;
      --green-500: #668971;
      --green-600: #4a6b54;
      --green-700: #3d5243;
      --green-800: #2d3a32;
      --green-900: #1a1f16;

      /* Gold Family */
      --gold-50: #fef9f0;
      --gold-100: #fdf0d8;
      --gold-200: #f8ddb0;
      --gold-300: #f0cb60;
      --gold-400: #e4aa4f;
      --gold-500: #d4993f;
      --gold-600: #c08832;
      --gold-700: #a67428;
      --gold-800: #8c5f1f;
      --gold-warm: #e8b05d;

      /* Legacy aliases */
      --gold: #e4aa4f;
      --gold-light: #f0cb60;
      --gold-glow: #f0cb60;
      --gold-dim: rgba(228,170,79,0.15);
      --green: #668971;
      --green-dim: rgba(102,137,113,0.15);
      --green-dark: #4a6b54;
      --ro-green-dark: #3d5243;
      --ro-green-glow: rgba(102, 137, 113, 0.4);

      /* Semantic */
      --success: #668971;
      --success-light: rgba(102, 137, 113, 0.15);
      --warning: #e4aa4f;
      --warning-light: rgba(228, 170, 79, 0.15);
      --danger: #c45c4a;
      --danger-light: rgba(196, 92, 74, 0.15);
      --info: #62758d;
      --info-light: rgba(98, 117, 141, 0.15);

      /* Cultivation */
      --sungrown: #bf8e4e;
      --sungrown-dim: rgba(191,142,78,0.15);
      --sungrown-light: rgba(191,142,78,0.15);
      --greenhouse: #8f9263;
      --greenhouse-dim: rgba(143,146,99,0.15);
      --greenhouse-light: rgba(143,146,99,0.15);
      --indoor: #62758d;
      --indoor-dim: rgba(98,117,141,0.15);
      --indoor-light: rgba(98,117,141,0.15);

      /* Special */
      --hemp-fiber: #b8a88a;
      --parchment: #faf8f5;
      --candlelight: rgba(228, 170, 79, 0.08);

      /* Light Theme */
      --bg: #faf8f5;
      --bg-card: #ffffff;
      --bg-dark: #faf8f5;
      --sidebar-bg: #1a1f16;
      --glass: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(102,137,113,0.15);
      --border: rgba(102,137,113,0.2);
      --border-light: rgba(102,137,113,0.1);
      --text: #2d3a32;
      --text-primary: #2d3a32;
      --text-secondary: #5a6b5f;
      --text-muted: #5a6b5f;
      --text-light: #8a9a8e;

      /* ===== LAYOUT ===== */
      --sidebar-width: 240px;
      --sidebar-collapsed: 68px;

      /* ===== SPACING ===== */
      --space-0: 0;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 32px;
      --space-8: 40px;
      --space-9: 48px;
      --space-10: 64px;
      --space-11: 80px;
      --space-12: 96px;
      --space-xs: 8px;
      --space-sm: 16px;
      --space-md: 24px;
      --space-lg: 40px;
      --space-xl: 64px;

      /* ===== BORDER RADIUS ===== */
      --radius-xs: 4px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --radius-full: 9999px;
      --radius-organic-sm: 8px 12px 10px 14px;
      --radius-organic-md: 12px 16px 14px 18px;
      --radius-organic-lg: 16px 20px 18px 22px;
      --radius-organic-xl: 20px 24px 22px 26px;

      /* ===== SHADOWS ===== */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.12);
      --shadow-elevated:
        0 2px 4px rgba(0, 0, 0, 0.04),
        0 8px 16px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(102, 137, 113, 0.05);
      --shadow-dramatic: 0 2px 8px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.04);
      --shadow-dramatic-hover: 0 4px 12px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08);

      /* Glow Effects */
      --glow-gold-sm: 0 0 8px rgba(228, 170, 79, 0.3);
      --glow-gold-md: 0 0 16px rgba(228, 170, 79, 0.4);
      --glow-gold-lg: 0 0 32px rgba(228, 170, 79, 0.5);
      --glow-gold-xl: 0 0 48px rgba(228, 170, 79, 0.6);
      --glow-green-sm: 0 0 8px rgba(102, 137, 113, 0.3);
      --glow-green-md: 0 0 16px rgba(102, 137, 113, 0.4);
      --glow-green-lg: 0 0 32px rgba(102, 137, 113, 0.5);

      /* ===== ANIMATIONS ===== */
      --duration-instant: 0ms;
      --duration-fast: 150ms;
      --duration-normal: 300ms;
      --duration-slow: 500ms;
      --duration-slower: 800ms;
      --duration-slowest: 1200ms;

      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out-expo: cubic-bezier(0.87, 0, 0.13, 1);
      --ease-out: cubic-bezier(0.33, 1, 0.68, 1);
      --ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);
      --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);

      --transition-fast: 150ms var(--ease-out);
      --transition-normal: 300ms var(--ease-spring);
      --transition-slow: 500ms var(--ease-spring);
      --transition-colors: 200ms ease;
      --transition-transform: 300ms var(--ease-spring);
      --transition-all: 300ms var(--ease-spring);

      /* Legacy */
      --spring: cubic-bezier(0.34, 1.56, 0.64, 1);

      /* ===== CHARTS ===== */
      --chart-grid: rgba(0,0,0,0.06);
      --chart-text: #666;
    }

    /* ========================================
       DARK THEME - ORGANIC INDUSTRIAL
       ======================================== */
    :root[data-theme="dark"] {
      /* Earth Tones */
      --earth-900: #0f110e;
      --earth-800: #12150f;
      --earth-700: #1a1f16;
      --earth-600: #252b22;
      --earth-500: #2d3a32;
      --earth-400: #4a5a4e;
      --earth-300: #6b7a6f;
      --earth-200: #8a9a8e;
      --earth-100: #b8c4ba;
      --earth-50: #f5f2ed;

      /* Legacy Earth Tones */
      --soil: #2d2419;
      --clay: #4a3f35;
      --hemp-fiber: #b8a88a;
      --leaf-green: #8ba896;
      --sage: #9ca89a;
      --mist: rgba(102, 137, 113, 0.08);

      /* Dark Backgrounds */
      --bg: #0f110e;
      --bg-dark: #0f110e;
      --bg-card: rgba(26, 31, 22, 0.8);
      --sidebar-bg: #12150f;
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --border: rgba(228,170,79,0.2);
      --border-light: rgba(228,170,79,0.1);

      /* Dark Text */
      --text: #f5f2ed;
      --text-primary: #f5f2ed;
      --text-secondary: #b8a88a;
      --text-muted: #7a7366;
      --text-light: #6b7a6f;

      /* Adjusted Colors */
      --gold: #e8b05d;
      --gold-dim: rgba(232,176,93,0.2);
      --green-dim: rgba(102,137,113,0.2);
      --sungrown-dim: rgba(191,142,78,0.2);
      --sungrown-light: rgba(191,142,78,0.2);
      --greenhouse-dim: rgba(143,146,99,0.2);
      --greenhouse-light: rgba(143,146,99,0.2);
      --indoor-dim: rgba(98,117,141,0.2);
      --indoor-light: rgba(98,117,141,0.2);
      --success-light: rgba(102,137,113,0.2);
      --warning-light: rgba(232,176,93,0.2);
      --danger-light: rgba(196,92,74,0.2);
      --info-light: rgba(98,117,141,0.2);

      /* Charts Dark */
      --chart-grid: rgba(255,255,255,0.1);
      --chart-text: #a8b5a9;

      /* Dramatic Shadows (4-layer) */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-sm:
        0 2px 4px rgba(0, 0, 0, 0.2),
        0 4px 8px rgba(0, 0, 0, 0.15);
      --shadow-md:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 16px rgba(0, 0, 0, 0.15),
        0 16px 32px rgba(0, 0, 0, 0.2),
        0 0 24px rgba(228, 170, 79, 0.05);
      --shadow-lg:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 16px rgba(0, 0, 0, 0.15),
        0 16px 32px rgba(0, 0, 0, 0.2),
        0 32px 64px rgba(0, 0, 0, 0.25);
      --shadow-xl:
        0 4px 8px rgba(0, 0, 0, 0.1),
        0 16px 32px rgba(0, 0, 0, 0.2),
        0 32px 64px rgba(0, 0, 0, 0.25),
        0 48px 96px rgba(0, 0, 0, 0.3),
        0 0 40px rgba(102, 137, 113, 0.1);
      --shadow-gold:
        0 4px 8px rgba(0, 0, 0, 0.1),
        0 8px 16px rgba(0, 0, 0, 0.1),
        0 0 32px rgba(228, 170, 79, 0.3);
      --shadow-dramatic:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 16px rgba(0, 0, 0, 0.15),
        0 16px 32px rgba(0, 0, 0, 0.2),
        0 32px 64px rgba(0, 0, 0, 0.25);
      --shadow-dramatic-hover:
        0 4px 8px rgba(0, 0, 0, 0.1),
        0 16px 32px rgba(0, 0, 0, 0.2),
        0 32px 64px rgba(0, 0, 0, 0.25),
        0 48px 96px rgba(0, 0, 0, 0.3),
        0 0 40px rgba(102, 137, 113, 0.3);
    }

    /* Dark Theme Component Overrides */
    :root[data-theme="dark"] .kpi-card,
    :root[data-theme="dark"] .chart-card,
    :root[data-theme="dark"] .widget-card,
    :root[data-theme="dark"] .integration-card,
    :root[data-theme="dark"] .current-production,
    :root[data-theme="dark"] .progress-hero {
      background: var(--bg-card);
      border-color: var(--border);
    }

    :root[data-theme="dark"] .header,
    :root[data-theme="dark"] .settings-panel,
    :root[data-theme="dark"] .ai-chat-panel {
      background: var(--bg-card);
      border-color: var(--border);
      backdrop-filter: blur(20px);
    }

    :root[data-theme="dark"] .date-picker-dropdown,
    :root[data-theme="dark"] .compare-dropdown {
      background: var(--bg-card);
      border-color: var(--border);
    }

    :root[data-theme="dark"] .date-chip {
      background: var(--bg);
      border-color: var(--border);
      color: var(--text-muted);
    }

    :root[data-theme="dark"] .date-chip:hover,
    :root[data-theme="dark"] .date-chip.active {
      background: var(--gold);
      color: #1a1f16;
    }

    :root[data-theme="dark"] input[type="date"] {
      background: var(--bg);
      border-color: var(--border);
      color: var(--text);
    }

    :root[data-theme="dark"] .widget-toggle,
    :root[data-theme="dark"] .perf-table div {
      border-color: var(--border);
    }

    :root[data-theme="dark"] .strain-item {
      background: var(--bg);
    }

    :root[data-theme="dark"] .fab-item-btn,
    :root[data-theme="dark"] .fab-item-label {
      background: var(--bg-card);
      border-color: var(--border);
    }

    :root[data-theme="dark"] .logo-loader {
      background: var(--bg);
    }

    :root[data-theme="dark"] .logo-loader img {
      animation: logoPulseDark 1.6s ease-in-out infinite;
    }

    @keyframes logoPulseDark {
      0%, 100% { opacity: 0.4; filter: drop-shadow(0 0 0 transparent) brightness(1.1); transform: scale(0.98); }
      50% { opacity: 1; filter: drop-shadow(0 0 30px rgba(201, 166, 90, 0.6)) drop-shadow(0 0 60px rgba(201, 166, 90, 0.35)) brightness(1.2); transform: scale(1); }
    }

    :root[data-theme="dark"] .logo-loader-bar {
      animation: barPulseDark 1.6s ease-in-out infinite;
    }

    @keyframes barPulseDark {
      0%, 100% { width: 80px; opacity: 0.4; }
      50% { width: 130px; opacity: 0.85; }
    }

    :root[data-theme="dark"] .skeleton {
      background: linear-gradient(90deg, var(--border) 25%, #3a4035 50%, var(--border) 75%);
      background-size: 200% 100%;
    }

    /* Hemp Fiber Woven Texture Pattern (Dark Mode - 12% opacity) */
    :root[data-theme="dark"] body::before {
      background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='fiber' x='0' y='0' width='40' height='40' patternUnits='userSpaceOnUse'%3E%3Cg opacity='0.12'%3E%3C!-- Diagonal woven fibers --%3E%3Cline x1='0' y1='0' x2='40' y2='40' stroke='%23e4aa4f' stroke-width='0.5' stroke-linecap='round'/%3E%3Cline x1='0' y1='10' x2='40' y2='50' stroke='%23f0cb60' stroke-width='0.3' stroke-linecap='round'/%3E%3Cline x1='0' y1='20' x2='40' y2='60' stroke='%23e4aa4f' stroke-width='0.5' stroke-linecap='round'/%3E%3Cline x1='0' y1='30' x2='40' y2='70' stroke='%23f0cb60' stroke-width='0.3' stroke-linecap='round'/%3E%3Cline x1='0' y1='-10' x2='40' y2='30' stroke='%23f0cb60' stroke-width='0.3' stroke-linecap='round'/%3E%3C!-- Cross-hatching --%3E%3Cline x1='0' y1='40' x2='40' y2='0' stroke='%23f0cb60' stroke-width='0.25' stroke-linecap='round' opacity='0.5'/%3E%3Cline x1='0' y1='50' x2='40' y2='10' stroke='%23e4aa4f' stroke-width='0.25' stroke-linecap='round' opacity='0.5'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect width='80' height='80' fill='url(%23fiber)'/%3E%3C/svg%3E");
      background-size: 100px;
      animation: driftPattern 120s linear infinite;
    }

    /* Light mode hemp fiber texture (6% opacity) */
    body::before {
      background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='fiber' x='0' y='0' width='40' height='40' patternUnits='userSpaceOnUse'%3E%3Cg opacity='0.06'%3E%3C!-- Diagonal woven fibers --%3E%3Cline x1='0' y1='0' x2='40' y2='40' stroke='%23e4aa4f' stroke-width='0.5' stroke-linecap='round'/%3E%3Cline x1='0' y1='10' x2='40' y2='50' stroke='%23f0cb60' stroke-width='0.3' stroke-linecap='round'/%3E%3Cline x1='0' y1='20' x2='40' y2='60' stroke='%23e4aa4f' stroke-width='0.5' stroke-linecap='round'/%3E%3Cline x1='0' y1='30' x2='40' y2='70' stroke='%23f0cb60' stroke-width='0.3' stroke-linecap='round'/%3E%3Cline x1='0' y1='-10' x2='40' y2='30' stroke='%23f0cb60' stroke-width='0.3' stroke-linecap='round'/%3E%3C!-- Cross-hatching --%3E%3Cline x1='0' y1='40' x2='40' y2='0' stroke='%23f0cb60' stroke-width='0.25' stroke-linecap='round' opacity='0.5'/%3E%3Cline x1='0' y1='50' x2='40' y2='10' stroke='%23e4aa4f' stroke-width='0.25' stroke-linecap='round' opacity='0.5'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect width='80' height='80' fill='url(%23fiber)'/%3E%3C/svg%3E");
      background-size: 100px;
    }

    @keyframes driftPattern {
      0% { background-position: 0 0; }
      100% { background-position: 120px 120px; }
    }

    :root[data-theme="dark"] body::after {
      opacity: 0.04;
    }

    /* Theme Toggle Button */
    .theme-toggle {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .theme-toggle span {
      font-size: 14px;
    }

    :root[data-theme="dark"] .theme-toggle {
      background: var(--gold-dim);
      border-color: var(--gold);
      color: var(--gold);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }
    body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"); opacity: 0.03; pointer-events: none; z-index: 0; }
    body.dark-mode::before { opacity: 0.04; }
    
    /* ========================================
       BOTANICAL LUXURY ANIMATIONS
       ======================================== */

    /* Page Load Sequence */
    @keyframes backgroundFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes headerSlideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes sidebarSlideIn {
      from {
        opacity: 0;
        transform: translateX(-40px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes heroReveal {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes heroNumberGlow {
      from {
        text-shadow: 0 0 0 rgba(228, 170, 79, 0);
      }
      to {
        text-shadow:
          0 0 40px rgba(228, 170, 79, 0.4),
          0 0 80px rgba(228, 170, 79, 0.2);
      }
    }

    @keyframes widgetPopIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes fabBounceIn {
      0% {
        opacity: 0;
        transform: scale(0) translateY(20px);
      }
      60% {
        opacity: 1;
        transform: scale(1.15) translateY(-5px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Number count-up animation */
    @keyframes countUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Interaction Animations */
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(228, 170, 79, 0);
      }
      50% {
        box-shadow: 0 0 24px 4px rgba(228, 170, 79, 0.4);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-4px);
      }
    }

    @keyframes skeletonShimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .animate-value { animation: countUp 0.4s ease-out forwards; }

    /* Apply page load animations */
    body { animation: backgroundFadeIn 800ms ease-out forwards; }
    .header { animation: headerSlideDown 400ms var(--ease-spring) 200ms backwards; }
    .sidebar { animation: sidebarSlideIn 500ms var(--ease-spring) 300ms backwards; }

    /* Sidebar */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--sidebar-bg); 
      padding: 16px 12px; 
      display: flex; 
      flex-direction: column; 
      position: fixed; 
      height: 100vh; 
      overflow-y: auto; 
      z-index: 50; 
      transition: width 0.3s ease, padding 0.3s ease;
    }
    .sidebar.collapsed { width: var(--sidebar-collapsed); padding: 16px 8px; }
    .sidebar.collapsed .brand h1,
    .sidebar.collapsed .nav-item span:not(.icon),
    .sidebar.collapsed .nav-section,
    .sidebar.collapsed .user-details,
    .sidebar.collapsed .sidebar-toggle-label { display: none; }
    .sidebar.collapsed .brand { justify-content: center; padding: 0; }
    .sidebar.collapsed .nav-item { justify-content: center; padding: 11px; }
    .sidebar.collapsed .nav-item .icon { margin: 0; width: auto; }
    .sidebar.collapsed .user-info { justify-content: center; }
    .sidebar.collapsed .sidebar-toggle { justify-content: center; }
    
    .sidebar-toggle { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      padding: 10px 14px; 
      color: #6b7280; 
      cursor: pointer; 
      border-radius: 8px; 
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    .sidebar-toggle:hover { background: #2a3026; color: #fff; }
    .sidebar-toggle svg { width: 18px; height: 18px; flex-shrink: 0; }
    .sidebar-toggle-label { font-size: 11px; font-weight: 500; }

    .brand { display: flex; align-items: center; gap: 12px; padding: 0 12px; margin-bottom: 20px; }
    .logo { width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0; }
    .brand h1 { font-size: 15px; font-weight: 600; color: #fff; white-space: nowrap; }
    .nav-section { margin-top: 16px; margin-bottom: 8px; padding: 0 14px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #6b7280; font-weight: 600; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 11px 14px; border-radius: 10px; color: #9ca3af; text-decoration: none; margin-bottom: 4px; transition: all 0.2s; font-size: 13px; font-weight: 500; cursor: pointer; }
    .nav-item:hover { background: #2a3026; color: #fff; }
    .nav-item.active { background: var(--gold); color: var(--sidebar-bg); }
    .nav-item .icon { width: 22px; text-align: center; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .nav-item.disabled { opacity: 0.4; pointer-events: none; }
    .sidebar-footer { margin-top: auto; padding: 14px 0; border-top: 1px solid #2a3026; }
    .user-info { display: flex; align-items: center; gap: 10px; padding: 0 8px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--gold); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; color: var(--sidebar-bg); flex-shrink: 0; }
    .user-details h4 { font-size: 13px; color: #fff; font-weight: 500; }
    .user-details p { font-size: 11px; color: #6b7280; }

    /* Main Content */
    .main { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; transition: margin-left 0.3s ease; }
    body.sidebar-collapsed .main { margin-left: var(--sidebar-collapsed); }

    /* Header */
    .header { background: var(--bg-card); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-light); position: sticky; top: 0; z-index: 40; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .page-title { font-size: 16px; font-weight: 600; color: var(--text); }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .header-time { text-align: right; margin-right: 6px; }
    .header-time .time { font-size: 14px; font-weight: 600; color: var(--text); }
    .header-time .date { font-size: 10px; color: var(--text-light); }
    
    .header-btn { background: var(--bg); color: var(--text-muted); border: 1px solid var(--border-light); padding: 6px 10px; border-radius: 8px; font-weight: 500; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
    .header-btn:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }
    .header-btn.primary { background: var(--gold); color: var(--sidebar-bg); border-color: var(--gold); }
    .header-btn.primary:hover { background: var(--gold-light); }
    .header-btn.active { background: var(--green); color: #fff; border-color: var(--green); }
    .header-btn svg { width: 14px; height: 14px; }
    
    /* Header Logo */
    .header-logo { height: 28px; width: auto; }
    
    /* Welcome Greeting */
    .welcome-section { margin-bottom: 20px; }
    .welcome-greeting { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .welcome-date { font-size: 13px; color: var(--text-muted); }
    
    /* Last Updated Indicator */
    .last-updated { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-light); }
    .last-updated-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success); animation: pulse-dot 2s ease-in-out infinite; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .last-updated.stale .last-updated-dot { background: var(--warning); }
    
    /* Daily Progress Ring Hero */
    .progress-hero { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 16px; padding: 20px 24px; margin-bottom: 20px; display: flex; align-items: center; gap: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .progress-ring-container { position: relative; width: 100px; height: 100px; flex-shrink: 0; }
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: var(--border); stroke-width: 8; }
    .progress-ring-fill { fill: none; stroke: var(--gold); stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
    .progress-ring-fill.complete { stroke: var(--success); }
    .progress-percent { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700; color: var(--text); }
    .progress-info { flex: 1; }
    .progress-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-light); margin-bottom: 6px; font-weight: 500; }
    .progress-value { font-size: 32px; font-weight: 700; color: var(--text); line-height: 1.1; }
    .progress-value span { font-size: 16px; font-weight: 500; color: var(--text-muted); }
    .progress-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .progress-stats { display: flex; gap: 24px; margin-left: auto; }
    .progress-stat { text-align: center; }
    .progress-stat-value { font-size: 18px; font-weight: 600; color: var(--text); }
    .progress-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-top: 2px; }
    @media (max-width: 768px) {
      .progress-hero { flex-direction: column; text-align: center; }
      .progress-stats { margin-left: 0; margin-top: 16px; }
    }
    
    /* Floating Action Button - Botanical Luxury */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
    }

    .fab-main {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-400) 0%, var(--gold-300) 100%);
      border: none;
      color: var(--earth-900);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(228,170,79,0.4);
      transition: all 300ms var(--ease-spring);

      /* Bounce entrance animation */
      animation: fabBounceIn 500ms var(--ease-spring) 1200ms backwards;
    }

    .fab-main:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 24px rgba(228,170,79,0.5),
                  var(--glow-gold-md);
    }

    .fab-main:active {
      transform: scale(0.95);
    }

    .fab-main.open {
      transform: rotate(45deg);
    }

    /* Settings FAB (secondary, slightly delayed) */
    .fab-settings .fab-main {
      width: 48px;
      height: 48px;
      background: var(--green-500);
      box-shadow: 0 4px 16px rgba(102, 137, 113, 0.4);
      animation-delay: 1350ms;
    }

    .fab-settings .fab-main:hover {
      box-shadow: 0 6px 24px rgba(102, 137, 113, 0.5),
                  var(--glow-green-md);
    }

    /* Mobile safe area */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .fab {
        bottom: calc(24px + env(safe-area-inset-bottom));
      }
    }
    .fab-menu { position: absolute; bottom: 64px; right: 0; display: flex; flex-direction: column; gap: 10px; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.3s; }
    .fab-menu.open { opacity: 1; visibility: visible; transform: translateY(0); }
    .fab-item { display: flex; align-items: center; gap: 10px; white-space: nowrap; }
    .fab-item-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border); color: var(--text); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s; }
    .fab-item-btn:hover { background: var(--green); color: #fff; border-color: var(--green); }
    .fab-item-label { background: var(--bg-card); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-light); }
    
    /* Empty State */
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; color: var(--text-light); }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
    .empty-state-text { font-size: 13px; }

    /* Date Picker */
    .date-picker-wrapper { position: relative; }
    .date-picker-trigger { background: var(--bg); border: 1px solid var(--border-light); color: var(--text); padding: 6px 10px; border-radius: 8px; font-size: 11px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px; min-width: 130px; }
    .date-picker-trigger:hover { border-color: var(--green); }
    .date-picker-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: var(--bg-card); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 14px; min-width: 280px; z-index: 200; display: none; border: 1px solid var(--border-light); }
    .date-picker-dropdown.open { display: block; }
    .date-presets { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .date-chip { padding: 5px 10px; border-radius: 16px; font-size: 11px; font-weight: 500; background: var(--bg); border: 1px solid var(--border-light); color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
    .date-chip:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }
    .date-chip.active { background: var(--green); color: #fff; border-color: var(--green); }
    .date-custom { border-top: 1px solid var(--border-light); padding-top: 12px; }
    .date-custom-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 6px; font-weight: 500; }
    .date-inputs { display: flex; gap: 6px; align-items: center; }
    .date-input { flex: 1; padding: 8px 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; font-size: 12px; font-family: inherit; }
    .date-input:focus { outline: none; border-color: var(--green); }
    .date-apply-btn { padding: 8px 14px; background: var(--green); color: #fff; border: none; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; margin-top: 10px; width: 100%; }

    /* Compare Dropdown */
    .compare-selector { position: relative; }
    .compare-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: var(--bg-card); border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 6px; min-width: 180px; z-index: 200; display: none; border: 1px solid var(--border-light); }
    .compare-dropdown.open { display: block; }
    .compare-option { padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .compare-option:hover { background: var(--bg); }

    /* Dashboard Content */
    .dashboard { padding: 16px 20px; flex: 1; display: none; }
    .dashboard.active { display: block; }
    
    /* Compare Banner */
    .compare-banner { background: linear-gradient(135deg, var(--indoor) 0%, #4a5a6d 100%); border-radius: 10px; padding: 10px 16px; margin-bottom: 16px; display: none; align-items: center; justify-content: space-between; color: #fff; }
    .compare-banner.active { display: flex; }
    .compare-banner-left { display: flex; align-items: center; gap: 12px; }
    .compare-badge { background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .compare-periods { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .compare-dot { width: 6px; height: 6px; border-radius: 50%; }
    .compare-dot.current { background: var(--gold); }
    .compare-dot.previous { background: rgba(255,255,255,0.5); }
    .compare-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px; }

    /* Toolbar */
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
    .toolbar-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .date-display { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 8px; padding: 8px 12px; font-size: 12px; color: var(--text-muted); }
    .date-display strong { color: var(--green); font-weight: 600; }
    .toolbar-right { display: flex; gap: 6px; }
    .tool-btn { background: var(--bg-card); border: 1px solid var(--border-light); color: var(--text-muted); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
    .tool-btn:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }
    .tool-btn.active { background: var(--green); color: #fff; border-color: var(--green); }

    /* KPI Row */
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .kpi-card { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 12px; padding: 14px; position: relative; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.03); transition: all 0.2s; }
    .kpi-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); transform: translateY(-1px); }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .kpi-card.gold::before { background: var(--gold); }
    .kpi-card.green::before { background: var(--green); }
    .kpi-card.sungrown::before { background: var(--sungrown); }
    .kpi-card.greenhouse::before { background: var(--greenhouse); }
    .kpi-card.indoor::before { background: var(--indoor); }
    .kpi-card[data-hidden="true"] { display: none; }
    .kpi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
    .kpi-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .kpi-card.gold .kpi-icon { background: var(--gold-dim); color: var(--gold); }
    .kpi-card.green .kpi-icon { background: var(--green-dim); color: var(--green); }
    .kpi-card.sungrown .kpi-icon { background: var(--sungrown-dim); color: var(--sungrown); }
    .kpi-card.greenhouse .kpi-icon { background: var(--greenhouse-dim); color: var(--greenhouse); }
    .kpi-card.indoor .kpi-icon { background: var(--indoor-dim); color: var(--indoor); }
    .kpi-delta { padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 600; display: none; }
    .kpi-delta.up { background: rgba(102,137,113,0.15); color: var(--green); }
    .kpi-delta.down { background: rgba(196,92,74,0.15); color: var(--danger); }
    .kpi-delta.neutral { background: var(--bg); color: var(--text-light); }
    .compare-mode .kpi-delta { display: inline-block; }
    .kpi-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-light); margin-bottom: 3px; font-weight: 500; }
    .kpi-values { display: flex; align-items: baseline; gap: 6px; }
    /* KPI Values - Botanical Luxury with DM Serif Display */
    .kpi-value {
      font-family: var(--font-display);
      font-size: 32px;
      font-weight: 400;
      color: var(--text);
      line-height: var(--leading-tight);
      letter-spacing: var(--tracking-tight);
    }

    /* Gold highlight for important KPIs */
    .kpi-card.gold .kpi-value {
      color: var(--gold-400);
      text-shadow: 0 0 16px rgba(228, 170, 79, 0.3);
    }

    /* Smaller KPI values use mono font */
    .kpi-card.small .kpi-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
    }
    .kpi-value-compare { font-size: 12px; font-weight: 500; color: var(--text-light); display: none; }
    .compare-mode .kpi-value-compare { display: inline; }
    .kpi-unit { font-size: 11px; font-weight: 500; color: var(--text-muted); }
    .kpi-sub { font-size: 9px; color: var(--text-light); margin-top: 3px; }

    /* ========================================
       MUURI WIDGET SYSTEM
       ======================================== */
    /* Widget Item - Muuri Container */
    .widget-item {
      position: absolute;
      width: calc(33.333% - 12px); /* 3-column default */
      margin: 6px;
      z-index: 1;
      transition: all var(--transition-normal);
    }

    /* Widget Size Classes - 12 Column Grid System */
    .widget-item.size-small { width: calc(25% - 12px); }      /* 3 cols = 1/4 */
    .widget-item.size-medium { width: calc(33.333% - 12px); } /* 4 cols = 1/3 */
    .widget-item.size-large { width: calc(50% - 12px); }      /* 6 cols = 1/2 */
    .widget-item.size-xl { width: calc(66.666% - 12px); }     /* 8 cols = 2/3 */
    .widget-item.size-full { width: calc(100% - 12px); }      /* 12 cols = Full */

    /* Responsive Widget Sizes */
    @media (max-width: 1400px) {
      .widget-item.size-small { width: calc(33.333% - 12px); }  /* 4 cols */
      .widget-item.size-medium { width: calc(50% - 12px); }     /* 6 cols */
      .widget-item.size-large { width: calc(50% - 12px); }      /* 6 cols */
      .widget-item.size-xl { width: calc(100% - 12px); }        /* 12 cols */
    }

    @media (max-width: 1000px) {
      .widget-item.size-small,
      .widget-item.size-medium { width: calc(50% - 12px); }     /* 6 cols */
      .widget-item.size-large { width: calc(50% - 12px); }      /* 6 cols */
      .widget-item.size-xl,
      .widget-item.size-full { width: calc(100% - 12px); }      /* 12 cols */
    }

    @media (max-width: 768px) {
      .widget-item { width: calc(100% - 12px) !important; }     /* Full width on mobile */
    }

    /* Muuri Drag States */
    .widget-item.muuri-item-dragging {
      z-index: 1000;
      box-shadow: var(--shadow-dramatic-hover, 0 20px 60px rgba(0,0,0,0.3));
      transform: scale(1.05);
      cursor: grabbing;
      opacity: 0.9;
    }

    .widget-item.muuri-item-releasing {
      z-index: 1000;
    }

    .widget-item.muuri-item-hidden {
      z-index: 0;
      opacity: 0;
      pointer-events: none;
    }

    /* Dragging placeholder - shows where item will land */
    .widget-item.muuri-item-placeholder {
      z-index: 2;
      opacity: 0;
    }

    /* Pop-in Animation */
    @keyframes popIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .widget-item {
      animation: popIn 0.4s var(--spring) backwards;
    }

    /* Responsive Widget Sizes */
    @media (max-width: 1200px) {
      .widget-item.size-small,
      .widget-item.size-medium { width: calc(50% - 18px); }
      .widget-item.size-large { width: calc(50% - 18px); }
      .widget-item.size-xl { width: calc(100% - 24px); }
    }

    @media (max-width: 768px) {
      .widget-item,
      .widget-item.size-small,
      .widget-item.size-medium,
      .widget-item.size-large,
      .widget-item.size-xl,
      .widget-item.size-full {
        width: calc(100% - 24px) !important;
      }
    }

    /* Widget Cards - Botanical Luxury */
    .widget-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-organic-lg); /* Organic asymmetric: 16px 20px 18px 22px */
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 0; /* Muuri handles spacing */
      height: 100%;
      position: relative;
      overflow: hidden;
      transition:
        transform 300ms var(--ease-spring),
        box-shadow 300ms ease,
        border-color 200ms ease;
    }

    /* Hemp Fiber Texture Overlay */
    .widget-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 10h20M10 0v20' stroke='%23668971' stroke-width='0.5' opacity='0.1'/%3E%3Cpath d='M0 0l20 20M20 0l-20 20' stroke='%23668971' stroke-width='0.3' opacity='0.05'/%3E%3C/svg%3E");
      background-size: 20px;
      opacity: 0.04;
      pointer-events: none;
      border-radius: inherit;
    }

    .widget-card:hover::before {
      opacity: 0.06;
    }

    :root[data-theme="dark"] .widget-card {
      background: rgba(26, 31, 22, 0.8);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-md);
    }

    :root[data-theme="dark"] .widget-card::before {
      opacity: 0.08;
    }

    .widget-card:hover {
      transform: translateY(-4px) scale(1.005);
      box-shadow: var(--shadow-lg);
      border-color: rgba(228, 170, 79, 0.3);
    }

    :root[data-theme="dark"] .widget-card:hover {
      box-shadow:
        var(--shadow-lg),
        0 0 32px rgba(228, 170, 79, 0.08);
    }

    .widget-card.collapsed .widget-content {
      display: none;
    }

    .widget-card[data-hidden="true"] { display: none; }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .widget-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      font-family: var(--font-display);
    }

    .widget-subtitle { font-size: 10px; color: var(--text-light); margin-top: 2px; }

    /* Widget Action Buttons */
    .widget-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .widget-card:hover .widget-actions {
      opacity: 1;
    }

    .widget-resize,
    .widget-collapse,
    .widget-drag-handle,
    .widget-hide {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
      line-height: 1;
      transition: all 0.2s;
      border-radius: 4px;
    }

    .widget-resize:hover {
      color: var(--gold);
      background: var(--gold-dim);
      transform: scale(1.2);
    }

    .widget-collapse:hover {
      color: var(--green);
      background: var(--green-dim);
      transform: scale(1.2);
    }

    .widget-drag-handle {
      cursor: grab;
      user-select: none;
      -webkit-user-select: none;
    }

    .widget-drag-handle:hover {
      color: var(--green);
      background: var(--green-dim);
      transform: scale(1.2);
    }

    .widget-drag-handle:active,
    .muuri-item-dragging .widget-drag-handle {
      cursor: grabbing;
    }

    .widget-hide:hover {
      color: var(--danger);
      background: rgba(196, 92, 74, 0.15);
      transform: scale(1.2);
    }

    @media (max-width: 768px) {
      .widget-drag-handle {
        display: none;
      }
    }

    .widget-legend { display: flex; gap: 8px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 4px; font-size: 9px; color: var(--text-muted); }
    .legend-dot { width: 6px; height: 6px; border-radius: 50%; }
    .legend-line { width: 12px; height: 2px; border-radius: 2px; }

    /* ========================================
       ANIMATED TIMELINE WIDGET
       ======================================== */
    .timeline-svg {
      width: 100%;
      height: 200px;
      overflow: visible;
    }

    .timeline-path {
      fill: none;
      stroke: var(--green);
      stroke-width: 2;
      opacity: 0.3;
    }

    .timeline-dot {
      transition: all 0.3s var(--spring);
      cursor: pointer;
    }

    .timeline-dot.past {
      fill: var(--green);
      opacity: 0.9;
    }

    .timeline-dot.current {
      fill: var(--gold);
      animation: pulseDot 2s ease-in-out infinite;
    }

    .timeline-dot.future {
      fill: none;
      stroke: var(--text-muted);
      stroke-width: 1;
      opacity: 0.5;
    }

    .timeline-dot:hover {
      transform: scale(1.3);
      opacity: 1;
    }

    @keyframes pulseDot {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }

    /* Current Production Card */
    .current-card { background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%); border-radius: 12px; padding: 16px; position: relative; overflow: hidden; margin-bottom: 16px; color: #fff; }
    .current-card[data-hidden="true"] { display: none; }
    .current-card::before { content: ''; position: absolute; top: -50%; right: -20%; width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); pointer-events: none; }
    .current-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; position: relative; }
    .current-strain { font-size: 18px; font-weight: 700; color: var(--gold-light); }
    .current-time { font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 3px; }
    .status-badge { padding: 4px 10px; border-radius: 16px; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-badge.in-progress { background: rgba(240,203,96,0.3); color: var(--gold-light); border: 1px solid rgba(240,203,96,0.5); }
    .status-badge.completed { background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
    .status-badge.idle { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.2); }
    .current-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; position: relative; }
    .current-stat { text-align: center; }
    .current-stat-value { font-size: 20px; font-weight: 700; color: #fff; }
    .current-stat-value.highlight { color: var(--gold-light); }
    .current-stat-label { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.7); margin-top: 3px; }

    /* Charts */
    .chart-card { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    .chart-card[data-hidden="true"] { display: none; }
    .chart-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .chart-title { font-size: 13px; font-weight: 600; color: var(--text); }
    .chart-subtitle { font-size: 10px; color: var(--text-light); margin-top: 2px; }
    .chart-container { position: relative; height: 180px; }

    /* Widgets Container (main sortable grid) */
    /* Muuri Grid Container - Structured Grid Layout */
    .widgets-container {
      position: relative;
      margin-top: 16px;
      min-height: 400px;
      padding: 8px;
    }

    /* Widget Cards */
    .widget-card { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    .sparkline-metrics { display: flex; gap: 20px; margin-bottom: 12px; }
    .sparkline-metric { text-align: center; }
    .sparkline-metric-value { font-size: 20px; font-weight: 700; }
    .sparkline-metric-value.current { color: var(--green); }
    .sparkline-metric-value.best { color: var(--gold); }
    .sparkline-metric-value.avg { color: var(--indoor); }
    .sparkline-metric-label { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-top: 3px; }
    .sparkline-bars { display: flex; align-items: flex-end; gap: 2px; height: 60px; padding: 6px; background: var(--bg); border-radius: 8px; }
    .spark-bar { flex: 1; border-radius: 2px 2px 0 0; min-height: 3px; transition: all 0.3s; }
    .spark-bar.good { background: var(--green); }
    .spark-bar.avg { background: var(--greenhouse); }
    .spark-bar.below { background: var(--danger); opacity: 0.7; }
    .spark-bar.best { background: var(--gold); box-shadow: 0 0 8px var(--gold-dim); }
    .strain-list { display: flex; flex-direction: column; gap: 5px; max-height: 160px; overflow-y: auto; }
    .strain-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--bg); border-radius: 6px; }
    .strain-name { font-size: 11px; font-weight: 500; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .strain-stats { display: flex; gap: 8px; font-size: 10px; }
    .strain-tops { color: var(--green); font-weight: 600; }
    .strain-smalls { color: var(--sungrown); font-weight: 600; }

    /* Performance Tables */
    .perf-table { display: flex; flex-direction: column; gap: 5px; }
    .perf-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg); border-radius: 6px; }
    .perf-label { font-size: 10px; color: var(--text-muted); }
    .perf-value { font-size: 12px; font-weight: 600; color: var(--text); }
    .perf-compare { display: flex; align-items: center; gap: 5px; }
    .perf-prev { font-size: 10px; color: var(--text-light); display: none; }
    .compare-mode .perf-prev { display: inline; }

    /* Integration Cards */
    .integration-card[data-hidden="true"] { display: none; }
    .integration-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .integration-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .integration-icon.kanban { background: var(--green-dim); color: var(--green); }
    .integration-icon.scoreboard { background: var(--gold-dim); color: var(--gold); }
    .integration-icon.sop { background: var(--indoor-dim); color: var(--indoor); }
    .integration-icon.bags { background: var(--sungrown-dim); color: var(--sungrown); }
    .integration-title { font-size: 12px; font-weight: 600; color: var(--text); }
    .integration-stats { display: flex; flex-direction: column; gap: 6px; }
    .integration-stat { display: flex; justify-content: space-between; align-items: center; }
    .integration-stat-label { font-size: 10px; color: var(--text-muted); }
    .integration-stat-value { font-size: 13px; font-weight: 600; color: var(--text); }
    .integration-stat-value.alert { color: var(--danger); }
    .integration-stat-value.good { color: var(--green); }

    /* Settings Panel */
    .settings-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; display: none; }
    .settings-overlay.open { display: block; }
    .settings-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 320px; background: var(--bg-card); box-shadow: -4px 0 20px rgba(0,0,0,0.1); z-index: 301; transform: translateX(100%); transition: transform 0.3s ease; overflow-y: auto; }
    .settings-panel.open { transform: translateX(0); }
    .settings-header { padding: 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-card); }
    .settings-title { font-size: 14px; font-weight: 600; }
    .settings-close { background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; }
    .settings-section { padding: 16px; border-bottom: 1px solid var(--border-light); }
    .settings-section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-light); margin-bottom: 10px; font-weight: 600; }
    .widget-toggle { display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 5px; }
    .widget-toggle-info { display: flex; align-items: center; gap: 8px; }
    .widget-toggle-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .widget-toggle-icon.gold { background: var(--gold-dim); color: var(--gold); }
    .widget-toggle-icon.green { background: var(--green-dim); color: var(--green); }
    .widget-toggle-icon.sungrown { background: var(--sungrown-dim); color: var(--sungrown); }
    .widget-toggle-icon.greenhouse { background: var(--greenhouse-dim); color: var(--greenhouse); }
    .widget-toggle-icon.indoor { background: var(--indoor-dim); color: var(--indoor); }
    .widget-toggle-name { font-size: 11px; font-weight: 500; }
    .toggle-switch { position: relative; width: 36px; height: 20px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--border); border-radius: 20px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch input:checked + .toggle-slider { background: var(--green); }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(16px); }

    /* ========================================
       FLOATING ACTION BUTTONS (FABs)
       ======================================== */
    .settings-fab,
    .ai-chat-fab {
      position: fixed;
      bottom: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: var(--shadow-dramatic);
      transition: all var(--transition-normal);
      z-index: 999;
    }

    .settings-fab {
      right: 96px;
      background: linear-gradient(135deg, var(--green), var(--green-dark));
      color: white;
      animation: bounceFAB 1.2s ease-out 1.5s;
    }

    .ai-chat-fab {
      right: 24px;
      background: linear-gradient(135deg, var(--gold), var(--gold-glow));
      color: white;
      animation: bounceFAB 1.2s ease-out 1.8s;
    }

    .settings-fab:hover,
    .ai-chat-fab:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-dramatic-hover);
    }

    @keyframes bounceFAB {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* ========================================
       AI CHAT PANEL
       ======================================== */
    .ai-chat-panel {
      position: fixed;
      top: 0; /* Full height from top */
      right: -400px;
      bottom: 0; /* Full height to bottom */
      width: 400px;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      z-index: 1002;
      display: flex;
      flex-direction: column;
      transition: right var(--transition-slow);
      max-height: 100vh; /* Constrain to viewport height */
    }

    .ai-chat-panel.open {
      right: 0;
    }

    .ai-chat-header {
      padding: var(--space-sm);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0; /* Prevent header from shrinking */
      background: var(--bg-card); /* Ensure it's visible */
    }

    .ai-chat-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), var(--gold-glow));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .ai-chat-header-text h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      font-family: var(--font-display);
      margin: 0;
    }

    .ai-chat-header-text span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-sm);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .ai-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .ai-message.user {
      align-self: flex-end;
      background: var(--green);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .ai-message.assistant {
      align-self: flex-start;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .ai-typing {
      display: flex;
      gap: 4px;
      padding: var(--space-sm);
    }

    .ai-typing span {
      width: 8px;
      height: 8px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: aiBounce 1.4s infinite ease-in-out;
    }

    .ai-typing span:nth-child(1) { animation-delay: -0.32s; }
    .ai-typing span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes aiBounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .ai-chat-input-area {
      padding: var(--space-sm);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 8px;
      flex-shrink: 0; /* Prevent input area from shrinking */
      background: var(--bg-card); /* Ensure it's visible */
    }

    .ai-chat-input {
      flex: 1;
      padding: 12px 16px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      color: var(--text);
      font-size: 14px;
      font-family: var(--font-ui);
      outline: none;
      transition: border-color 0.2s;
    }

    .ai-chat-input:focus {
      border-color: var(--gold);
    }

    .ai-chat-input::placeholder {
      color: var(--text-muted);
    }

    .ai-chat-send {
      width: 40px;
      height: 40px;
      background: var(--gold);
      border: none;
      border-radius: var(--radius-md);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-chat-send:hover {
      background: var(--gold-light);
      transform: scale(1.05);
    }

    .ai-chat-send:disabled {
      background: var(--border);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    @media (max-width: 768px) {
      .ai-chat-panel {
        width: 100%;
        right: -100%;
      }

      .settings-fab {
        bottom: 96px;
        right: 24px;
      }
    }

    /* Iframe App View */
    .app-view { display: none; flex-direction: column; height: calc(100vh - 52px); }
    .app-view.active { display: flex; }
    .app-iframe-container { flex: 1; position: relative; }
    .app-iframe { width: 100%; height: 100%; border: none; }
    .app-expand-btn { position: absolute; top: 6px; right: 6px; background: rgba(45,58,46,0.7); color: #fff; border: none; width: 28px; height: 28px; border-radius: 6px; font-size: 14px; cursor: pointer; opacity: 0; transition: opacity 0.2s, background 0.2s; z-index: 10; display: flex; align-items: center; justify-content: center; }
    .app-expand-btn:hover { background: var(--gold); }
    .app-iframe-container:hover .app-expand-btn { opacity: 0.7; }
    .app-iframe-container .app-expand-btn:hover { opacity: 1; }

    /* Loading */
    .logo-loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; gap: 20px; }
    .logo-loader.hidden { opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
    .logo-loader img { width: 320px; height: auto; animation: logoPulse 1.6s ease-in-out infinite; }
    @keyframes logoPulse { 0%, 100% { opacity: 0.35; filter: drop-shadow(0 0 0 transparent); transform: scale(0.98); } 50% { opacity: 1; filter: drop-shadow(0 0 25px rgba(201, 166, 90, 0.5)) drop-shadow(0 0 50px rgba(201, 166, 90, 0.25)); transform: scale(1); } }
    .logo-loader-bar { width: 80px; height: 2px; background: var(--gold); border-radius: 2px; opacity: 0.3; animation: barPulse 1.6s ease-in-out infinite; }
    @keyframes barPulse { 0%, 100% { width: 80px; opacity: 0.3; } 50% { width: 130px; opacity: 0.7; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinning { animation: spin 1s linear infinite; }
    
    /* Skeleton Loading */
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .skeleton { background: linear-gradient(90deg, var(--border) 25%, #f5f3f0 50%, var(--border) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
    .skeleton-icon { width: 32px; height: 32px; border-radius: 8px; }
    .skeleton-text { height: 12px; margin-bottom: 6px; }
    .skeleton-text.sm { width: 60%; }
    .skeleton-text.md { width: 80%; }
    .skeleton-text.lg { width: 100%; }
    .skeleton-value { height: 28px; width: 70%; margin-bottom: 4px; }
    .skeleton-bar { height: 3px; width: 100%; margin-top: 8px; }
    .skeleton-chart { height: 200px; width: 100%; border-radius: 8px; }
    .skeleton-stat { height: 48px; border-radius: 8px; }
    .kpi-card.loading .kpi-value, .kpi-card.loading .kpi-label, .kpi-card.loading .kpi-sub, 
    .kpi-card.loading .kpi-delta, .kpi-card.loading .kpi-value-compare { display: none; }
    .kpi-card.loading .skeleton-content { display: block; }
    .kpi-card .skeleton-content { display: none; }

    /* Responsive */
    @media (max-width: 900px) { 
      .sidebar { transform: translateX(-100%); }
      .sidebar.mobile-open { transform: translateX(0); }
      .main { margin-left: 0 !important; }
      .current-stats { grid-template-columns: repeat(3, 1fr); }
      .mobile-menu-btn { display: flex !important; }
    }
    @media (max-width: 600px) {
      .kpi-row { grid-template-columns: 1fr 1fr; }
      .header { flex-wrap: wrap; gap: 8px; }
      .settings-panel { width: 100%; left: 0; right: 0; }
      .header-btn { padding: 10px 14px; font-size: 12px; min-height: 44px; }
      .header-btn svg { width: 16px; height: 16px; }
      .nav-item { padding: 14px 16px; min-height: 48px; }
      .date-chip { padding: 8px 14px; min-height: 40px; }
      .toolbar { flex-wrap: wrap; gap: 8px; }
      .toolbar-btn { padding: 10px 14px; min-height: 44px; }
    }

    @media (max-width: 400px) {
      .kpi-row { grid-template-columns: 1fr; }
      .header-right { width: 100%; justify-content: flex-end; }
      .welcome { font-size: 18px; }
    }
    
    .mobile-menu-btn { display: none; background: none; border: none; color: var(--text); cursor: pointer; padding: 4px; }
    
    /* Edit/Rearrange Mode */
    .edit-mode .draggable-widget,
    .edit-mode .kpi-card { cursor: grab; animation: wiggle 0.3s ease-in-out infinite; outline: 2px dashed var(--gold); outline-offset: 2px; }
    .edit-mode .draggable-widget:active,
    .edit-mode .kpi-card:active { cursor: grabbing; animation: none; }
    .edit-mode [data-hidden="true"] { display: none !important; }
    .sortable-ghost { opacity: 0.4; }
    .sortable-chosen { box-shadow: 0 8px 25px rgba(228,170,79,0.4); transform: scale(1.02); z-index: 100; animation: none !important; }
    .sortable-drag { opacity: 0.9; }
    @keyframes wiggle { 0%, 100% { transform: rotate(-0.3deg); } 50% { transform: rotate(0.3deg); } }
    
    /* Draggable widget wrapper */
    .draggable-widget { transition: box-shadow 0.2s, transform 0.2s; }
    

    /* Toast notifications */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 10000; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 12px 20px; border-radius: 8px; color: #fff; font-weight: 500; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: toastSlideIn 0.3s ease; max-width: 360px; display: flex; align-items: center; gap: 10px; }
    .toast.error { background: var(--danger, #c45c4a); }
    .toast.success { background: var(--success, #668971); }
    .toast.warning { background: var(--warning, #e4aa4f); color: #1a1f16; }
    .toast.info { background: var(--green, #668971); }
    .toast.hiding { animation: toastSlideOut 0.3s ease forwards; }
    @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

    /* ===== MOBILE ENHANCEMENTS ===== */
    /* Ensure 44px minimum touch targets per MOBILE_DESIGN.md specifications */

    @media (max-width: 768px) {
      /* Widget action buttons - increase touch target size */
      .widget-resize,
      .widget-collapse,
      .widget-hide {
        padding: 12px;
        font-size: 16px;
        min-width: 44px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* FAB menu items */
      .fab-item-btn {
        width: 48px;
        height: 48px;
        font-size: 18px;
      }

      /* Compare close button */
      .compare-close {
        width: 44px;
        height: 44px;
        font-size: 14px;
      }

      /* Tool buttons */
      .tool-btn {
        padding: 12px 14px;
        min-height: 44px;
        font-size: 12px;
      }

      /* Date apply button */
      .date-apply-btn {
        padding: 12px 16px;
        min-height: 44px;
        font-size: 13px;
      }

      /* Settings panel action buttons */
      .reset-layout-btn,
      .close-settings-btn {
        min-height: 44px;
        padding: 12px 16px;
      }

      /* Responsive typography scaling */
      :root {
        --text-hero: 64px;
        --text-display: 40px;
        --text-display-sm: 32px;
        --text-h1: 28px;
        --text-h2: 24px;
        --text-h3: 20px;
      }

      /* Increased tap spacing for mobile */
      .widget-actions {
        gap: 8px;
      }

      .toolbar-right {
        gap: 10px;
      }

      /* Panel close buttons */
      .panel-close {
        min-width: 44px;
        min-height: 44px;
        padding: 12px;
      }

      /* Ensure adequate spacing between interactive elements */
      .kpi-row {
        gap: 16px;
      }

      .widget-grid {
        gap: 16px;
      }
    }

    /* Extra small mobile devices */
    @media (max-width: 480px) {
      /* Further scale down hero text */
      :root {
        --text-hero: 48px;
        --text-display: 32px;
      }

      /* Full-width panels on very small screens */
      .ai-chat-panel,
      .settings-panel {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="logo-loader" id="loadingOverlay">
    <img src="https://i.imgur.com/UYEbNiI.png" alt="Rogue Origin">
    <span class="logo-loader-bar"></span>
  </div>

  <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header"><span class="settings-title">Customize Dashboard</span><button class="settings-close" onclick="closeSettings()">&times;</button></div>
    <div class="settings-section">
      <div class="settings-section-title">Production Target</div>
      <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Daily target shown as line on charts</p>
      <div style="display: flex; align-items: center; gap: 8px;">
        <input type="number" id="targetInput" value="200" min="50" max="500" step="10" style="flex: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--bg); color: var(--text);">
        <span style="color: var(--text-muted); font-size: 12px;">lbs/day</span>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">KPI Cards</div>
      <div id="kpiToggles"></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Widgets</div>
      <div id="widgetToggles"></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">Layout</div>
      <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 10px;">Drag KPI cards to reorder. Settings save automatically.</p>
      <button class="tool-btn" onclick="resetLayout()" style="width: 100%; justify-content: center;">Reset to Default</button>
    </div>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-toggle" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/></svg>
      <span class="sidebar-toggle-label">Collapse</span>
    </div>
    <div class="brand">
      <img src="https://i.imgur.com/PvrTPb2.png" alt="Rogue Origin" class="logo">
      <h1>Rogue Origin</h1>
    </div>
    <div class="nav-item active" data-view="dashboard" onclick="switchView('dashboard')"><span class="icon"><i class="ph-duotone ph-chart-pie-slice"></i></span><span>Dashboard</span></div>
    <div class="nav-item" data-view="kanban" onclick="switchView('kanban')"><span class="icon"><i class="ph-duotone ph-package"></i></span><span>Supply Kanban</span></div>
    <div class="nav-item" data-view="scoreboard" onclick="switchView('scoreboard')"><span class="icon"><i class="ph-duotone ph-gauge"></i></span><span>Scoreboard</span></div>
    <div class="nav-item" data-view="barcode" onclick="switchView('barcode')"><span class="icon"><i class="ph-duotone ph-barcode"></i></span><span>Barcode Printer</span></div>
    <div class="nav-item" data-view="sop" onclick="switchView('sop')"><span class="icon"><i class="ph-duotone ph-book-open-text"></i></span><span>SOP Manager</span></div>
    <div class="nav-item" data-view="orders" onclick="switchView('orders')"><span class="icon"><i class="ph-duotone ph-clipboard-text"></i></span><span>Orders</span></div>
    <div class="nav-section">Coming Soon</div>
    <div class="nav-item disabled"><span class="icon"><i class="ph-duotone ph-users-three"></i></span><span>Staff</span></div>
    <div class="nav-item disabled"><span class="icon"><i class="ph-duotone ph-chart-line-up"></i></span><span>Reports</span></div>
    <div class="nav-item disabled"><span class="icon"><i class="ph-duotone ph-gear"></i></span><span>Settings</span></div>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">RO</div>
        <div class="user-details"><h4>Rogue Origin</h4><p>Administrator</p></div>
      </div>
    </div>
  </aside>

  <main class="main">
    <header class="header">
      <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <img src="https://i.imgur.com/UYEbNiI.png" alt="Rogue Origin" class="header-logo">
      </div>
      <div class="header-right" id="dashboardControls">
        <div class="date-picker-wrapper">
          <button class="date-picker-trigger" onclick="toggleDatePicker()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <span id="datePickerLabel">Today</span>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="date-picker-dropdown" id="datePickerDropdown">
            <div class="date-presets">
              <button class="date-chip active" data-range="today">Today</button>
              <button class="date-chip" data-range="yesterday">Yesterday</button>
              <button class="date-chip" data-range="week">Last 7 Days</button>
              <button class="date-chip" data-range="month">Last 30 Days</button>
            </div>
            <div class="date-custom">
              <div class="date-custom-label">Custom Range</div>
              <div class="date-inputs">
                <input type="date" class="date-input" id="startDate">
                <span style="color: var(--text-light);"></span>
                <input type="date" class="date-input" id="endDate">
              </div>
              <button class="date-apply-btn" onclick="applyCustomRange()">Apply</button>
            </div>
          </div>
        </div>
        <div class="compare-selector">
          <button class="header-btn" id="compareBtn" onclick="toggleCompareDropdown()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
            Compare
          </button>
          <div class="compare-dropdown" id="compareDropdown">
            <div class="compare-option" onclick="setCompare('yesterday')">Today vs Yesterday</div>
            <div class="compare-option" onclick="setCompare('lastWeek')">This Week vs Last</div>
            <div class="compare-option" onclick="setCompare('lastMonth')">This Month vs Last</div>
          </div>
        </div>
        <div class="header-time"><div class="time" id="clock">--:--</div><div class="date" id="dateDisplay">Loading...</div></div>
        <button class="theme-toggle header-btn" onclick="toggleTheme()" title="Toggle theme">
          <span id="themeIcon"></span>
          <span id="themeLabel">Dark</span>
        </button>
        <button class="header-btn" onclick="openSettings()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
        <button class="header-btn primary" id="refreshBtn" onclick="refreshData()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>Refresh</button>
      </div>
    </header>

    <!-- Dashboard View -->
    <div class="dashboard active" id="dashboardView">
      <div class="compare-banner" id="compareBanner">
        <div class="compare-banner-left">
          <span class="compare-badge">Comparing</span>
          <div class="compare-periods">
            <div style="display:flex;align-items:center;gap:4px;"><div class="compare-dot current"></div><span id="compareCurrent">Today</span></div>
            <span style="opacity: 0.5;">vs</span>
            <div style="display:flex;align-items:center;gap:4px;"><div class="compare-dot previous"></div><span id="comparePrevious">Yesterday</span></div>
          </div>
        </div>
        <button class="compare-close" onclick="clearCompare()">&times;</button>
      </div>

      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-greeting" id="welcomeGreeting">Good morning</div>
        <div class="welcome-date" id="welcomeDate">Loading...</div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left"><div class="date-display" id="dateRangeDisplay">Showing data for <strong>Today</strong></div></div>
        <div class="toolbar-right"><button class="tool-btn" id="editModeBtn" onclick="toggleEditMode()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Rearrange</button></div>
      </div>

      <div class="kpi-row" id="kpiRow"></div>

      <!-- All Widgets Container (Muuri Grid) -->
      <div class="widgets-container" id="widgetsContainer">

        <!-- Integration Widgets (Medium Size) -->
        <div class="widget-item" data-widget-id="widget-kanban" data-size="medium">
          <div class="widget-card integration-card" onclick="switchView('kanban')" style="cursor:pointer;">
            <div class="widget-header integration-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="integration-icon kanban"><i class="ph-duotone ph-package"></i></div>
                <div class="integration-title widget-title">Supply Kanban</div>
              </div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="event.stopPropagation();cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="event.stopPropagation();toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="event.stopPropagation();hideWidget('widget-kanban')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content integration-stats">
              <div class="integration-stat"><span class="integration-stat-label">Total Items</span><span class="integration-stat-value" id="kanbanTotal"></span></div>
              <div class="integration-stat"><span class="integration-stat-label">Need Reorder</span><span class="integration-stat-value alert" id="kanbanReorder"></span></div>
              <div class="integration-stat"><span class="integration-stat-label">In Stock</span><span class="integration-stat-value good" id="kanbanInStock"></span></div>
            </div>
          </div>
        </div>

        <div class="widget-item" data-widget-id="widget-scoreboard" data-size="medium">
          <div class="widget-card integration-card" onclick="switchView('scoreboard')" style="cursor:pointer;">
            <div class="widget-header integration-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="integration-icon scoreboard"><i class="ph-duotone ph-gauge"></i></div>
                <div class="integration-title widget-title">Live Scoreboard</div>
              </div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="event.stopPropagation();cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="event.stopPropagation();toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="event.stopPropagation();hideWidget('widget-scoreboard')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content integration-stats">
              <div class="integration-stat"><span class="integration-stat-label">Current Status</span><span class="integration-stat-value" id="scoreboardStatus"></span></div>
              <div class="integration-stat"><span class="integration-stat-label">Today's Lbs</span><span class="integration-stat-value" id="scoreboardLbs"></span></div>
              <div class="integration-stat"><span class="integration-stat-label">vs Target</span><span class="integration-stat-value" id="scoreboardTarget"></span></div>
            </div>
          </div>
        </div>

        <div class="widget-item" data-widget-id="widget-bags" data-size="medium">
          <div class="widget-card integration-card">
            <div class="widget-header integration-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="integration-icon bags"><i class="ph-duotone ph-timer"></i></div>
                <div class="integration-title widget-title">5KG Bag Timer</div>
              </div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-bags')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content integration-stats">
              <div class="integration-stat"><span class="integration-stat-label">Bags Today</span><span class="integration-stat-value" id="bagsToday"></span></div>
              <div class="integration-stat"><span class="integration-stat-label">Avg Time</span><span class="integration-stat-value" id="bagsAvgTime"></span></div>
              <div class="integration-stat"><span class="integration-stat-label">vs Target</span><span class="integration-stat-value" id="bagsVsTarget"></span></div>
            </div>
          </div>
        </div>

        <div class="widget-item" data-widget-id="widget-sop" data-size="medium">
          <div class="widget-card integration-card" onclick="switchView('sop')" style="cursor:pointer;">
            <div class="widget-header integration-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="integration-icon sop"><i class="ph-duotone ph-book-open-text"></i></div>
                <div class="integration-title widget-title">SOP Manager</div>
              </div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="event.stopPropagation();cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="event.stopPropagation();toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="event.stopPropagation();hideWidget('widget-sop')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content integration-stats">
              <div class="integration-stat"><span class="integration-stat-label">Status</span><span class="integration-stat-value good">Active</span></div>
              <div class="integration-stat"><span class="integration-stat-label">Feature</span><span class="integration-stat-value">EN/ES</span></div>
              <div class="integration-stat"><span class="integration-stat-label">Export</span><span class="integration-stat-value">PDF</span></div>
            </div>
          </div>
        </div>

        <!-- Last Hour Production -->
        <div class="widget-item" data-widget-id="widget-current" data-size="large">
          <div class="widget-card current-card">
            <div class="widget-header current-header">
              <div><div class="current-strain" id="currentStrain">No Data</div><div class="current-time" id="currentTime"></div></div>
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="status-badge idle" id="statusBadge">Last Hour</div>
                <div class="widget-actions">
                  <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                  <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                  <button class="widget-drag-handle" title="Drag to reorder"></button>
                  <button class="widget-hide" onclick="hideWidget('widget-current')" title="Hide"></button>
                </div>
              </div>
            </div>
            <div class="widget-content current-stats">
              <div class="current-stat"><div class="current-stat-value highlight" id="currentTops">0</div><div class="current-stat-label">Tops (lbs)</div></div>
              <div class="current-stat"><div class="current-stat-value" id="currentSmalls">0</div><div class="current-stat-label">Smalls (lbs)</div></div>
              <div class="current-stat"><div class="current-stat-value" id="currentTrimmers">0</div><div class="current-stat-label">Trimmers</div></div>
              <div class="current-stat"><div class="current-stat-value" id="currentBuckers">0</div><div class="current-stat-label">Buckers</div></div>
              <div class="current-stat"><div class="current-stat-value highlight" id="currentRate">0.00</div><div class="current-stat-label">Lbs/Trimmer</div></div>
              <div class="current-stat"><div class="current-stat-value" id="currentTotal">0</div><div class="current-stat-label">Total Lbs</div></div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="widget-item" data-widget-id="widget-hourlyChart" data-size="large">
          <div class="widget-card chart-card">
            <div class="widget-header chart-header">
              <div><div class="chart-title widget-title">Hourly Production</div><div class="chart-subtitle">Tops vs Smalls</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-hourlyChart')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content chart-container"><canvas id="hourlyChart"></canvas></div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-rateChart" data-size="large">
          <div class="widget-card chart-card">
            <div class="widget-header chart-header">
              <div><div class="chart-title widget-title">Efficiency Trend</div><div class="chart-subtitle">Lbs/Trimmer/Hr</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-rateChart')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content chart-container"><canvas id="rateChart"></canvas></div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-dailyChart" data-size="large">
          <div class="widget-card chart-card">
            <div class="widget-header chart-header">
              <div><div class="chart-title widget-title">Daily Production</div><div class="chart-subtitle">Multi-day view</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-dailyChart')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content chart-container"><canvas id="dailyChart"></canvas></div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-dailyRateChart" data-size="large">
          <div class="widget-card chart-card">
            <div class="widget-header chart-header">
              <div><div class="chart-title widget-title" id="efficiencyChartTitle">Daily Efficiency</div><div class="chart-subtitle" id="efficiencyChartSubtitle">With 7-day MA</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-dailyRateChart')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content chart-container"><canvas id="dailyRateChart"></canvas></div>
          </div>
        </div>

        <!-- Trimmers Chart -->
        <div class="widget-item" data-widget-id="widget-trimmersChart" data-size="large">
          <div class="widget-card chart-card">
            <div class="widget-header chart-header">
              <div><div class="chart-title widget-title">Trimmers on Line</div><div class="chart-subtitle" id="trimmersChartSubtitle">By Hour</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-trimmersChart')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content chart-container"><canvas id="trimmersChart"></canvas></div>
          </div>
        </div>

        <!-- Bottom Widgets -->
        <div class="widget-item" data-widget-id="widget-productivity" data-size="xl">
          <div class="widget-card wide">
            <div class="widget-header">
              <div><div class="widget-title">Trimmer Productivity</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-productivity')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content">
              <div class="sparkline-metrics">
                <div class="sparkline-metric"><div class="sparkline-metric-value current" id="sparkCurrent"></div><div class="sparkline-metric-label">Last Hour</div></div>
                <div class="sparkline-metric"><div class="sparkline-metric-value best" id="sparkBest"></div><div class="sparkline-metric-label">Best Hour</div></div>
                <div class="sparkline-metric"><div class="sparkline-metric-value avg" id="sparkAvg"></div><div class="sparkline-metric-label">Avg Rate</div></div>
              </div>
              <div class="sparkline-bars" id="sparklineBars"></div>
            </div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-strains" data-size="medium">
          <div class="widget-card narrow">
            <div class="widget-header">
              <div><div class="widget-title">Strain Breakdown</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-strains')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content strain-list" id="strainList"><div style="color:#8a9a8e;text-align:center;padding:16px;">No data</div></div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-performance" data-size="medium">
          <div class="widget-card third">
            <div class="widget-header">
              <div><div class="widget-title">Performance</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-performance')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content perf-table" id="perfTable"></div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-cost" data-size="medium">
          <div class="widget-card third">
            <div class="widget-header">
              <div><div class="widget-title">Cost Analysis</div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-cost')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content perf-table" id="costTable"></div>
          </div>
        </div>
        <div class="widget-item" data-widget-id="widget-period" data-size="medium">
          <div class="widget-card third">
            <div class="widget-header">
              <div><div class="widget-title">Period Summary</div><div class="widget-subtitle" id="periodLabel"></div></div>
              <div class="widget-actions">
                <button class="widget-resize" onclick="cycleWidgetSize(this)" title="Resize"></button>
                <button class="widget-collapse" onclick="toggleWidgetCollapse(this)" title="Collapse"></button>
                <button class="widget-drag-handle" title="Drag to reorder"></button>
                <button class="widget-hide" onclick="hideWidget('widget-period')" title="Hide"></button>
              </div>
            </div>
            <div class="widget-content perf-table" id="periodTable"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- App Views (iframes) -->
    <div class="app-view" id="kanbanView">
      <div class="app-iframe-container">
        <button class="app-expand-btn" onclick="openAppNewTab('kanban')" title="Open in new tab"><i class="ph ph-arrow-square-out"></i></button>
        <iframe class="app-iframe" id="kanbanFrame" data-src="https://rogueff.github.io/rogue-origin-apps/kanban.html"></iframe>
      </div>
    </div>

    <div class="app-view" id="scoreboardView">
      <div class="app-iframe-container">
        <button class="app-expand-btn" onclick="openAppNewTab('scoreboard')" title="Open in new tab"><i class="ph ph-arrow-square-out"></i></button>
        <iframe class="app-iframe" id="scoreboardFrame" data-src="https://rogueff.github.io/rogue-origin-apps/scoreboard.html"></iframe>
      </div>
    </div>

    <div class="app-view" id="barcodeView">
      <div class="app-iframe-container">
        <button class="app-expand-btn" onclick="openAppNewTab('barcode')" title="Open in new tab"><i class="ph ph-arrow-square-out"></i></button>
        <iframe class="app-iframe" id="barcodeFrame" data-src="https://rogueff.github.io/rogue-origin-apps/barcode.html"></iframe>
      </div>
    </div>

    <div class="app-view" id="ordersView">
      <div class="app-iframe-container">
        <button class="app-expand-btn" onclick="openAppNewTab('orders')" title="Open in new tab"><i class="ph ph-arrow-square-out"></i></button>
        <iframe class="app-iframe" id="ordersFrame" data-src="https://rogueff.github.io/rogue-origin-apps/orders.html"></iframe>
      </div>
    </div>

    <div class="app-view" id="sopView">
      <div class="app-iframe-container">
        <button class="app-expand-btn" onclick="openAppNewTab('sop')" title="Open in new tab"><i class="ph ph-arrow-square-out"></i></button>
        <iframe class="app-iframe" id="sopFrame" data-src="https://rogueff.github.io/rogue-origin-apps/sop-manager.html"></iframe>
      </div>
    </div>
  </main>

  <script>
    // KPI Definitions with Phosphor duotone icons
    var kpiDefinitions = [
      { id: 'totalTops', label: 'Total Tops', icon: 'ph-duotone ph-plant', color: 'gold', default: true, format: 'lbs' },
      { id: 'totalSmalls', label: 'Total Smalls', icon: 'ph-duotone ph-tree', color: 'sungrown', default: true, format: 'lbs' },
      { id: 'avgRate', label: 'Lbs/Trimmer/Hr', icon: 'ph-duotone ph-lightning', color: 'green', default: true, format: 'rate' },
      { id: 'crew', label: 'Current Crew', icon: 'ph-duotone ph-users-three', color: 'greenhouse', default: true, format: 'num' },
      { id: 'operatorHours', label: 'Operator Hours', icon: 'ph-duotone ph-clock', color: 'indoor', default: true, format: 'hrs' },
      { id: 'costPerLb', label: 'Cost/Lb', icon: 'ph-duotone ph-currency-dollar', color: 'gold', default: true, format: 'dollar' },
      { id: 'totalLbs', label: 'Total Lbs', icon: 'ph-duotone ph-scales', color: 'green', default: false, format: 'lbs' },
      { id: 'maxRate', label: 'Best Rate', icon: 'ph-duotone ph-trophy', color: 'gold', default: false, format: 'rate' },
      { id: 'trimmerHours', label: 'Trimmer Hours', icon: 'ph-duotone ph-scissors', color: 'greenhouse', default: false, format: 'hrs' },
      { id: 'laborCost', label: 'Total Labor', icon: 'ph-duotone ph-wallet', color: 'sungrown', default: false, format: 'dollar' }
    ];

    // Widget Definitions
    // Widget Definitions with Phosphor duotone icons
    var widgetDefinitions = [
      { id: 'kanban', label: 'Supply Kanban', icon: 'ph-duotone ph-package', color: 'green', default: true },
      { id: 'scoreboard', label: 'Live Scoreboard', icon: 'ph-duotone ph-gauge', color: 'gold', default: true },
      { id: 'bags', label: '5KG Bag Timer', icon: 'ph-duotone ph-timer', color: 'sungrown', default: true },
      { id: 'sop', label: 'SOP Manager', icon: 'ph-duotone ph-book-open-text', color: 'indoor', default: true },
      { id: 'current', label: 'Current Production', icon: 'ph-duotone ph-pulse', color: 'green', default: true },
      { id: 'hourlyChart', label: 'Hourly Chart', icon: 'ph-duotone ph-chart-bar', color: 'indoor', default: true },
      { id: 'rateChart', label: 'Rate Chart', icon: 'ph-duotone ph-trend-up', color: 'indoor', default: true },
      { id: 'dailyChart', label: 'Daily Chart', icon: 'ph-duotone ph-chart-bar-horizontal', color: 'indoor', default: true },
      { id: 'dailyRateChart', label: 'Daily Rate Chart', icon: 'ph-duotone ph-chart-line-up', color: 'indoor', default: true },
      { id: 'trimmersChart', label: 'Trimmers on Line', icon: 'ph-duotone ph-users', color: 'greenhouse', default: true },
      { id: 'productivity', label: 'Productivity Sparkline', icon: 'ph-duotone ph-lightning', color: 'green', default: true },
      { id: 'strains', label: 'Strain Breakdown', icon: 'ph-duotone ph-leaf', color: 'greenhouse', default: true },
      { id: 'performance', label: 'Performance Table', icon: 'ph-duotone ph-list-checks', color: 'indoor', default: true },
      { id: 'cost', label: 'Cost Analysis', icon: 'ph-duotone ph-currency-dollar', color: 'gold', default: true },
      { id: 'period', label: 'Period Summary', icon: 'ph-duotone ph-calendar', color: 'sungrown', default: true }
    ];

    var appUrls = {
      kanban: 'https://rogueff.github.io/rogue-origin-apps/kanban.html',
      scoreboard: 'https://rogueff.github.io/rogue-origin-apps/scoreboard.html',
      barcode: 'https://rogueff.github.io/rogue-origin-apps/barcode.html',
      sop: 'https://rogueff.github.io/rogue-origin-apps/sop-manager.html',
      orders: 'https://rogueff.github.io/rogue-origin-apps/orders.html'
    };

    var brandColors = { green: '#668971', greenLight: 'rgba(102,137,113,0.2)', gold: '#e4aa4f', sungrown: '#bf8e4e', indoor: '#62758d', indoorLight: 'rgba(98,117,141,0.3)' };
    var hourlyChart, rateChart, dailyChart, dailyRateChart, trimmersChart;
    var data = null, compareData = null;
    var currentRange = 'today', customStartDate = null, customEndDate = null;
    var compareMode = null;
    var editMode = false, kpiSortable, widgetSortable;
    var currentView = 'dashboard';
    var sidebarCollapsed = false;
    var darkMode = false;
    var dailyTarget = 200; // Daily production target in lbs
    
    // API Configuration for GitHub Pages
    var API_URL = 'https://script.google.com/macros/s/AKfycbxDAHSFl9cedGS49L3Lf5ztqy-SSToYigyA30ZtsdpmWNAR9H61X_Mm48JOOTGqqr-Z/exec';
    
    // Detect environment: Apps Script or GitHub Pages
    var isAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
    
    // Chart.js Botanical Styling
    Chart.defaults.font.family = getComputedStyle(document.documentElement).getPropertyValue('--font-ui').trim() || 'Outfit, Inter, system-ui, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.borderColor = 'rgba(102, 137, 113, 0.1)';
    Chart.defaults.plugins.tooltip = {
      backgroundColor: 'rgba(26, 31, 22, 0.95)',
      titleColor: '#f5f2ed',
      bodyColor: '#a8b5a9',
      borderColor: 'rgba(228, 170, 79, 0.3)',
      borderWidth: 1,
      cornerRadius: 8,
      padding: 12,
      titleFont: { family: getComputedStyle(document.documentElement).getPropertyValue('--font-display').trim(), size: 14, weight: '400' },
      bodyFont: { family: getComputedStyle(document.documentElement).getPropertyValue('--font-mono').trim(), size: 12 },
      displayColors: true,
      boxWidth: 8,
      boxHeight: 8,
      boxPadding: 6
    };
    Chart.defaults.animation = {
      duration: 800,
      easing: 'easeOutQuart'
    };

    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      initTheme(); // Initialize theme system
      initTargetInput();
      renderKPICards();
      renderKPIToggles();
      renderWidgetToggles();
      initCharts();
      initSortable();
      updateClock();
      setInterval(updateClock, 1000);
      updateWelcome();
      
      var today = new Date();
      document.getElementById('endDate').value = formatDateInput(today);
      document.getElementById('startDate').value = formatDateInput(today);
      
      document.querySelectorAll('.date-chip').forEach(function(c) {
        c.addEventListener('click', function() { setDateRange(this.dataset.range); });
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.date-picker-wrapper')) document.getElementById('datePickerDropdown').classList.remove('open');
        if (!e.target.closest('.compare-selector')) document.getElementById('compareDropdown').classList.remove('open');
      });
      
      loadData();
      setInterval(function() { if (currentRange === 'today' && !compareMode && currentView === 'dashboard') loadData(); }, 30000);
    });
    
    function initTargetInput() {
      var input = document.getElementById('targetInput');
      if (!input) return;
      input.value = dailyTarget;
      input.addEventListener('change', function() {
        dailyTarget = parseInt(this.value) || 200;
        saveSettings();
        if (data) renderCharts();
      });
    }

    // Sidebar toggle
    function toggleSidebar() {
      sidebarCollapsed = !sidebarCollapsed;
      document.getElementById('sidebar').classList.toggle('collapsed', sidebarCollapsed);
      document.body.classList.toggle('sidebar-collapsed', sidebarCollapsed);
      saveSettings();
    }

    function toggleMobileSidebar() {
      document.getElementById('sidebar').classList.toggle('mobile-open');
    }
    
    // ===== THEME TOGGLE SYSTEM =====
    function toggleTheme() {
      const root = document.documentElement;
      const currentTheme = root.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      // Set theme attribute
      root.setAttribute('data-theme', newTheme);

      // Update UI
      updateThemeUI(newTheme);

      // Save to localStorage
      localStorage.setItem('theme', newTheme);

      // Update charts with new theme colors
      updateChartTheme(newTheme);

      // Re-render charts if data exists
      if (data) renderCharts();
      if (data) renderTrimmersChart();
    }

    function updateThemeUI(theme) {
      const icon = document.getElementById('themeIcon');
      const label = document.getElementById('themeLabel');

      if (theme === 'dark') {
        icon.textContent = '';
        label.textContent = 'Light';
      } else {
        icon.textContent = '';
        label.textContent = 'Dark';
      }
    }

    function updateChartTheme(theme) {
      // Update chart.js default colors based on theme
      if (typeof Chart !== 'undefined') {
        // Botanical color palette
        Chart.defaults.color = theme === 'dark' ? '#a8b5a9' : '#5a6b5f';
        Chart.defaults.borderColor = theme === 'dark' ? 'rgba(168, 181, 169, 0.1)' : 'rgba(102, 137, 113, 0.08)';

        // Update tooltip colors for theme
        Chart.defaults.plugins.tooltip.backgroundColor = theme === 'dark' ? 'rgba(26, 31, 22, 0.95)' : 'rgba(255, 255, 255, 0.95)';
        Chart.defaults.plugins.tooltip.titleColor = theme === 'dark' ? '#f5f2ed' : '#1a1f16';
        Chart.defaults.plugins.tooltip.bodyColor = theme === 'dark' ? '#a8b5a9' : '#5a6b5f';
        Chart.defaults.plugins.tooltip.borderColor = theme === 'dark' ? 'rgba(228, 170, 79, 0.3)' : 'rgba(228, 170, 79, 0.5)';
      }
    }

    function initTheme() {
      // Load theme from localStorage or default to light
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeUI(savedTheme);
      updateChartTheme(savedTheme);
    }

    // Legacy support: keep toggleDarkMode for backwards compatibility
    function toggleDarkMode() {
      toggleTheme();
    }

    // View switching
    function switchView(view) {
      currentView = view;

      // Update nav items
      document.querySelectorAll('.nav-item[data-view]').forEach(function(item) {
        item.classList.toggle('active', item.dataset.view === view);
      });

      // Show/hide views
      document.getElementById('dashboardView').classList.toggle('active', view === 'dashboard');
      document.getElementById('kanbanView').classList.toggle('active', view === 'kanban');
      document.getElementById('scoreboardView').classList.toggle('active', view === 'scoreboard');
      document.getElementById('barcodeView').classList.toggle('active', view === 'barcode');
      document.getElementById('sopView').classList.toggle('active', view === 'sop');
      document.getElementById('ordersView').classList.toggle('active', view === 'orders');

      // Show/hide dashboard controls
      document.getElementById('dashboardControls').style.display = view === 'dashboard' ? 'flex' : 'none';

      // Hide AI chat when viewing iframe apps (they have their own UI elements)
      var aiWidget = document.querySelector('.ai-chat-widget');
      if (aiWidget) {
        aiWidget.style.display = (view === 'dashboard' || view === 'orders') ? 'block' : 'none';
        // Also close the chat panel if open
        if (view !== 'dashboard' && view !== 'orders') {
          var panel = document.querySelector('.ai-chat-panel');
          if (panel) panel.classList.remove('open');
        }
      }

      // Update page title
      var titles = { dashboard: 'Operations Dashboard', kanban: 'Supply Kanban', scoreboard: 'Scoreboard / Bag Timer', barcode: 'Barcode Printer', sop: 'SOP Manager', orders: 'Order Management' };
      // pageTitle removed - using header logo instead
      document.title = 'Rogue Origin - ' + (titles[view] || 'Operations Hub');

      // Lazy load iframes
      if (view !== 'dashboard') {
        var frameId = view + 'Frame';
        var frame = document.getElementById(frameId);
        if (frame && !frame.src && frame.dataset.src) {
          frame.src = frame.dataset.src;
        }
      }

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('mobile-open');
    }

    function openAppNewTab(app) {
      window.open(appUrls[app], '_blank');
    }

    // Settings
    function loadSettings() {
      try {
        var s = JSON.parse(localStorage.getItem('roHubSettingsV2') || '{}');
        kpiDefinitions.forEach(function(k) {
          k.visible = s.kpiVisibility && s.kpiVisibility[k.id] !== undefined ? s.kpiVisibility[k.id] : k.default;
        });
        if (s.kpiOrder) {
          kpiDefinitions.sort(function(a,b) {
            var ai = s.kpiOrder.indexOf(a.id), bi = s.kpiOrder.indexOf(b.id);
            return (ai===-1?999:ai)-(bi===-1?999:bi);
          });
        }
        widgetDefinitions.forEach(function(w) {
          w.visible = s.widgetVisibility && s.widgetVisibility[w.id] !== undefined ? s.widgetVisibility[w.id] : w.default;
        });
        if (s.sidebarCollapsed) {
          sidebarCollapsed = true;
          document.getElementById('sidebar').classList.add('collapsed');
          document.body.classList.add('sidebar-collapsed');
        }
        if (s.darkMode !== undefined) {
          darkMode = s.darkMode;
        }
        if (s.dailyTarget !== undefined) {
          dailyTarget = s.dailyTarget;
        }
      } catch(e) {
        kpiDefinitions.forEach(function(k) { k.visible = k.default; });
        widgetDefinitions.forEach(function(w) { w.visible = w.default; });
      }
      applyWidgetVisibility();
    }
    
    function applyDarkMode() {
      document.body.classList.toggle('dark-mode', darkMode);
      updateDarkModeUI();
    }

    function saveSettings() {
      var s = { kpiVisibility: {}, kpiOrder: [], widgetVisibility: {}, sidebarCollapsed: sidebarCollapsed, darkMode: darkMode, dailyTarget: dailyTarget };
      kpiDefinitions.forEach(function(k) {
        s.kpiVisibility[k.id] = k.visible;
        s.kpiOrder.push(k.id);
      });
      widgetDefinitions.forEach(function(w) {
        s.widgetVisibility[w.id] = w.visible;
      });
      localStorage.setItem('roHubSettingsV2', JSON.stringify(s));
    }

    function resetLayout() {
      localStorage.removeItem('roHubSettingsV2');
      localStorage.removeItem('roHubWidgetOrder');
      location.reload();
    }

    function applyWidgetVisibility() {
      widgetDefinitions.forEach(function(w) {
        var el = document.getElementById('widget-' + w.id);
        if (el) el.dataset.hidden = !w.visible;
      });
    }

    function renderKPICards() {
      var c = document.getElementById('kpiRow');
      c.innerHTML = '';
      kpiDefinitions.forEach(function(k) {
        var card = document.createElement('div');
        card.className = 'kpi-card ' + k.color + ' loading';
        card.dataset.kpi = k.id;
        card.dataset.hidden = !k.visible;
        card.innerHTML = '<div class="kpi-header"><div class="kpi-icon"><i class="' + k.icon + '"></i></div><span class="kpi-delta" id="delta_' + k.id + '"></span></div>' +
          '<div class="kpi-label">' + k.label + '</div>' +
          '<div class="kpi-values"><span class="kpi-value" id="kpi_' + k.id + '"></span><span class="kpi-value-compare" id="kpiCmp_' + k.id + '"></span></div>' +
          '<div class="kpi-sub" id="kpiSub_' + k.id + '"></div>' +
          '<div class="skeleton-content"><div class="skeleton skeleton-value"></div><div class="skeleton skeleton-bar"></div></div>';
        c.appendChild(card);
      });
    }

    function renderKPIToggles() {
      var c = document.getElementById('kpiToggles');
      c.innerHTML = '';
      kpiDefinitions.forEach(function(k) {
        var t = document.createElement('div');
        t.className = 'widget-toggle';
        t.innerHTML = '<div class="widget-toggle-info"><div class="widget-toggle-icon ' + k.color + '"><i class="' + k.icon + '"></i></div><span class="widget-toggle-name">' + k.label + '</span></div><label class="toggle-switch"><input type="checkbox" ' + (k.visible ? 'checked' : '') + ' onchange="toggleKPI(\'' + k.id + '\', this.checked)"><span class="toggle-slider"></span></label>';
        c.appendChild(t);
      });
    }

    function renderWidgetToggles() {
      var c = document.getElementById('widgetToggles');
      c.innerHTML = '';
      widgetDefinitions.forEach(function(w) {
        // Check actual widget visibility in DOM
        var widgetElement = document.querySelector('[data-widget-id="widget-' + w.id + '"]');
        var isVisible = true; // Default to visible

        if (widgetElement) {
          // Widget is visible if it doesn't have the muuri-item-hidden class
          isVisible = !widgetElement.classList.contains('muuri-item-hidden');
        }

        var t = document.createElement('div');
        t.className = 'widget-toggle';
        t.innerHTML = '<div class="widget-toggle-info"><div class="widget-toggle-icon ' + w.color + '"><i class="' + w.icon + '"></i></div><span class="widget-toggle-name">' + w.label + '</span></div><label class="toggle-switch"><input type="checkbox" ' + (isVisible ? 'checked' : '') + ' onchange="toggleWidget(\'' + w.id + '\', this.checked)"><span class="toggle-slider"></span></label>';
        c.appendChild(t);
      });
    }

    function toggleKPI(id, v) {
      var k = kpiDefinitions.find(function(x) { return x.id === id; });
      if (k) k.visible = v;
      var card = document.querySelector('.kpi-card[data-kpi="' + id + '"]');
      if (card) card.dataset.hidden = !v;
      saveSettings();
    }

    function toggleWidget(id, v) {
      var w = widgetDefinitions.find(function(x) { return x.id === id; });
      if (w) w.visible = v;

      // Use Muuri show/hide functions
      var widgetId = 'widget-' + id;
      if (v) {
        showWidget(widgetId);
      } else {
        hideWidget(widgetId);
      }
    }

    // ===== MUURI GRID SYSTEM =====
    var muuriGrid = null;

    function initMuuriGrid() {
      var container = document.getElementById('widgetsContainer');
      if (!container || typeof Muuri === 'undefined') {
        console.warn('Muuri not available or container not found');
        return;
      }

      muuriGrid = new Muuri(container, {
        dragEnabled: true,
        dragHandle: '.widget-drag-handle',
        dragSortPredicate: {
          threshold: 50,
          action: 'move',
          migrateAction: 'move'
        },
        dragSortHeuristics: {
          sortInterval: 50,        // Sort every 50ms during drag
          minDragDistance: 10,
          minBounceBackAngle: 1
        },
        layout: {
          fillGaps: true,          // Fill gaps in the grid
          horizontal: false,       // Vertical flow (top to bottom)
          alignRight: false,       // Align left
          alignBottom: false,      // Align top
          rounding: true          // Round positions to avoid subpixels
        },
        layoutDuration: 300,
        layoutEasing: 'ease-out',
        dragStartPredicate: {
          distance: 0,             // Start immediately (no distance threshold)
          delay: 0                 // No delay - instant drag start
        },
        dragRelease: {
          duration: 300,
          easing: 'ease-out'
        },
        dragPlaceholder: {
          enabled: true,
          duration: 300,
          easing: 'ease-out',
          createElement: null
        }
      });

      // Initial layout to position all items
      muuriGrid.refreshItems();
      muuriGrid.layout(true);

      // Save layout on drag end
      muuriGrid.on('dragEnd', function() {
        saveLayout();
      });

      // Load saved layout after a brief delay to ensure DOM is ready
      setTimeout(function() {
        loadLayout();
      }, 100);
    }

    function cycleWidgetSize(btn) {
      var item = btn.closest('.widget-item');
      if (!item) return;

      var sizes = ['small', 'medium', 'large', 'xl', 'full'];
      var current = item.dataset.size || 'medium';
      var currentIndex = sizes.indexOf(current);
      var nextIndex = (currentIndex + 1) % sizes.length;
      var newSize = sizes[nextIndex];

      // Remove all size classes
      sizes.forEach(function(s) { item.classList.remove('size-' + s); });

      // Add new size class
      item.classList.add('size-' + newSize);
      item.dataset.size = newSize;

      // Wait for browser to repaint before calculating new layout
      if (muuriGrid) {
        requestAnimationFrame(function() {
          // Refresh ALL items to recalculate dimensions after repaint
          muuriGrid.refreshItems();
          muuriGrid.layout(true); // Force synchronous layout

          // Double-check layout after another frame
          requestAnimationFrame(function() {
            muuriGrid.refreshItems();
            muuriGrid.layout(true);
            saveLayout();
          });
        });
      }
    }

    function toggleWidgetCollapse(btn) {
      var widget = btn.closest('.widget-card');
      if (!widget) return;

      var isCollapsed = widget.classList.toggle('collapsed');
      btn.textContent = isCollapsed ? '+' : '';

      // Refresh ALL items and reflow the entire grid
      if (muuriGrid) {
        muuriGrid.refreshItems(); // Refresh all items, not just this one
        muuriGrid.layout(true);   // Force synchronous layout
      }

      saveLayout();
    }

    function hideWidget(widgetId) {
      if (!muuriGrid) return;

      var element = document.querySelector('[data-widget-id="' + widgetId + '"]');
      if (!element) {
        console.warn('hideWidget: Element not found for widgetId:', widgetId);
        return;
      }

      // Find the Muuri item that corresponds to this element
      var items = muuriGrid.getItems();
      var targetItem = items.find(function(item) {
        return item.getElement() === element;
      });

      if (!targetItem) {
        console.warn('hideWidget: Muuri item not found for widgetId:', widgetId);
        return;
      }

      // Hide the widget with animation
      muuriGrid.hide([targetItem], {instant: false, onFinish: function() {
        // Refresh all items and trigger layout after hiding
        muuriGrid.refreshItems();
        muuriGrid.layout(true); // Force synchronous layout

        // Additional layout pass to ensure everything settles
        setTimeout(function() {
          muuriGrid.layout(true);
        }, 50);

        // Save layout after hide animation completes
        saveLayout();
      }});
    }

    function showWidget(widgetId) {
      if (!muuriGrid) return;

      var element = document.querySelector('[data-widget-id="' + widgetId + '"]');
      if (!element) {
        console.warn('showWidget: Element not found for widgetId:', widgetId);
        return;
      }

      // Find the Muuri item that corresponds to this element
      var items = muuriGrid.getItems();
      var targetItem = items.find(function(item) {
        return item.getElement() === element;
      });

      if (!targetItem) {
        console.warn('showWidget: Muuri item not found for widgetId:', widgetId);
        return;
      }

      // Show the widget with animation
      muuriGrid.show([targetItem], {instant: false, onFinish: function() {
        // Refresh all items and trigger layout after showing
        muuriGrid.refreshItems();
        muuriGrid.layout(true); // Force synchronous layout

        // Additional layout pass to ensure everything settles
        setTimeout(function() {
          muuriGrid.layout(true);
        }, 50);

        // Save layout after show animation completes
        saveLayout();
      }});
    }

    function saveLayout() {
      if (!muuriGrid) return;

      var layout = {
        theme: document.documentElement.getAttribute('data-theme'),
        widgets: []
      };

      muuriGrid.getItems().forEach(function(item, index) {
        var el = item.getElement();
        var widget = el.querySelector('.widget-card');

        // Check if item is visible (not hidden by Muuri)
        var isVisible = !el.classList.contains('muuri-item-hidden');

        layout.widgets.push({
          id: el.dataset.widgetId,
          visible: isVisible,
          position: index,
          size: el.dataset.size || 'medium',
          collapsed: widget ? widget.classList.contains('collapsed') : false
        });
      });

      localStorage.setItem('dashboardLayout', JSON.stringify(layout));
    }

    function setDefaultWidgetVisibility() {
      // Default visible widgets (only the essentials)
      var defaultVisible = [
        'widget-current',      // Current production card
        'widget-hourlyChart',  // Hourly production chart
        'widget-scoreboard'    // Scoreboard integration
      ];

      var itemsToHide = [];
      muuriGrid.getItems().forEach(function(item) {
        var el = item.getElement();
        var widgetId = el.dataset.widgetId;

        if (!defaultVisible.includes(widgetId)) {
          itemsToHide.push(item);
        }
      });

      if (itemsToHide.length > 0) {
        muuriGrid.hide(itemsToHide, {instant: true});
      }

      // Force refresh and layout
      muuriGrid.refreshItems();
      muuriGrid.layout(true); // Force synchronous layout
    }

    function loadLayout() {
      if (!muuriGrid) return;

      try {
        var saved = localStorage.getItem('dashboardLayout');
        if (!saved) {
          // No saved layout - set default visibility (only show key widgets)
          setDefaultWidgetVisibility();
          return;
        }

        var layout = JSON.parse(saved);

        // Restore theme
        if (layout.theme) {
          document.documentElement.setAttribute('data-theme', layout.theme);
          updateThemeUI(layout.theme);
        }

        // Restore widget order, sizes, collapsed states
        if (layout.widgets && layout.widgets.length > 0) {
          // Sort items by saved position
          var sortedItems = [];
          layout.widgets.forEach(function(w) {
            var item = muuriGrid.getItems().find(function(i) {
              return i.getElement().dataset.widgetId === w.id;
            });
            if (item) {
              var el = item.getElement();

              // Restore size
              if (w.size) {
                ['small', 'medium', 'large', 'xl', 'full'].forEach(function(s) {
                  el.classList.remove('size-' + s);
                });
                el.classList.add('size-' + w.size);
                el.dataset.size = w.size;
              }

              // Restore collapsed state
              var widget = el.querySelector('.widget-card');
              var collapseBtn = el.querySelector('.widget-collapse');
              if (widget && collapseBtn) {
                if (w.collapsed) {
                  widget.classList.add('collapsed');
                  collapseBtn.textContent = '+';
                } else {
                  widget.classList.remove('collapsed');
                  collapseBtn.textContent = '';
                }
              }

              sortedItems.push(item);
            }
          });

          // Apply order
          if (sortedItems.length > 0) {
            muuriGrid.sort(sortedItems, {layout: false});
          }

          // Hide widgets that should be hidden
          var itemsToHide = [];
          layout.widgets.forEach(function(w) {
            if (!w.visible) {
              var item = muuriGrid.getItems().find(function(i) {
                return i.getElement().dataset.widgetId === w.id;
              });
              if (item) itemsToHide.push(item);
            }
          });
          if (itemsToHide.length > 0) {
            muuriGrid.hide(itemsToHide, {instant: true});
          }

          // Refresh and layout - force synchronous layout
          muuriGrid.refreshItems();
          muuriGrid.layout(true);
        }
      } catch(e) {
        console.error('Error loading layout:', e);
      }
    }

    function resetLayout() {
      localStorage.removeItem('dashboardLayout');
      location.reload();
    }

    // Legacy Sortable compatibility (for KPI cards)
    function initSortable() {
      // KPI cards remain with simple drag-drop (optional upgrade later)
      // For now, just initialize Muuri for widgets
      initMuuriGrid();
    }

    function restoreWidgetOrder() {
      // Handled by loadLayout() in Muuri system
    }

    function toggleEditMode() {
      editMode = !editMode;
      document.getElementById('editModeBtn').classList.toggle('active', editMode);
      document.getElementById('kpiRow').classList.toggle('edit-mode', editMode);
      document.getElementById('widgetsContainer').classList.toggle('edit-mode', editMode);
      kpiSortable.option('disabled', !editMode);
      widgetSortable.option('disabled', !editMode);
    }

    // Date & Compare functions
    function toggleDatePicker() { document.getElementById('datePickerDropdown').classList.toggle('open'); }
    function toggleCompareDropdown() { document.getElementById('compareDropdown').classList.toggle('open'); }

    function setDateRange(range) {
      currentRange = range;
      document.querySelectorAll('.date-chip').forEach(function(c) { c.classList.toggle('active', c.dataset.range === range); });
      var today = new Date(), start, end, label;
      if (range === 'today') { start = end = formatDateInput(today); label = 'Today'; }
      else if (range === 'yesterday') { var y = new Date(today); y.setDate(y.getDate()-1); start = end = formatDateInput(y); label = 'Yesterday'; }
      else if (range === 'week') { var w = new Date(today); w.setDate(w.getDate()-6); start = formatDateInput(w); end = formatDateInput(today); label = 'Last 7 Days'; }
      else if (range === 'month') { var m = new Date(today); m.setDate(m.getDate()-29); start = formatDateInput(m); end = formatDateInput(today); label = 'Last 30 Days'; }
      document.getElementById('startDate').value = start;
      document.getElementById('endDate').value = end;
      document.getElementById('datePickerLabel').textContent = label;
      customStartDate = start; customEndDate = end;
      document.getElementById('datePickerDropdown').classList.remove('open');
      data = null; // Reset data to show skeletons for new date range
      if (compareMode) loadCompareData(); else loadData();
    }

    function applyCustomRange() {
      currentRange = 'custom';
      document.querySelectorAll('.date-chip').forEach(function(c) { c.classList.remove('active'); });
      customStartDate = document.getElementById('startDate').value;
      customEndDate = document.getElementById('endDate').value;
      if (!customStartDate || !customEndDate) { alert('Select both dates'); return; }
      document.getElementById('datePickerLabel').textContent = formatDateShort(customStartDate) + ' - ' + formatDateShort(customEndDate);
      document.getElementById('datePickerDropdown').classList.remove('open');
      data = null; // Reset data to show skeletons for new date range
      if (compareMode) loadCompareData(); else loadData();
    }

    function setCompare(mode) {
      compareMode = mode;
      document.getElementById('compareDropdown').classList.remove('open');
      document.getElementById('compareBtn').classList.add('active');
      document.body.classList.add('compare-mode');
      var today = new Date(), currentLabel, prevLabel;
      if (mode === 'yesterday') { currentLabel = 'Today'; prevLabel = 'Yesterday'; customStartDate = customEndDate = formatDateInput(today); }
      else if (mode === 'lastWeek') { var ws = new Date(today); ws.setDate(today.getDate()-today.getDay()); currentLabel = 'This Week'; prevLabel = 'Last Week'; customStartDate = formatDateInput(ws); customEndDate = formatDateInput(today); }
      else if (mode === 'lastMonth') { var ms = new Date(today.getFullYear(), today.getMonth(), 1); currentLabel = 'This Month'; prevLabel = 'Last Month'; customStartDate = formatDateInput(ms); customEndDate = formatDateInput(today); }
      document.getElementById('compareCurrent').textContent = currentLabel;
      document.getElementById('comparePrevious').textContent = prevLabel;
      document.getElementById('compareBanner').classList.add('active');
      document.getElementById('datePickerLabel').textContent = currentLabel + ' vs ' + prevLabel;
      data = null; // Reset data to show skeletons for compare mode
      loadCompareData();
    }

    function clearCompare() {
      compareMode = null; compareData = null;
      document.getElementById('compareBtn').classList.remove('active');
      document.body.classList.remove('compare-mode');
      document.getElementById('compareBanner').classList.remove('active');
      document.getElementById('datePickerLabel').textContent = currentRange === 'today' ? 'Today' : formatDateShort(customStartDate) + ' - ' + formatDateShort(customEndDate);
      loadData(); renderCharts();
    }

    function loadCompareData() {
      // Only show skeletons on initial load (no existing data)
      if (!data) {
        showSkeletons(true);
      }
      var today = new Date();
      var cs, ce, ps, pe;
      if (compareMode === 'yesterday') {
        cs = ce = formatDateInput(today);
        var y = new Date(today); y.setDate(y.getDate()-1);
        ps = pe = formatDateInput(y);
      } else if (compareMode === 'lastWeek') {
        var ws = new Date(today); ws.setDate(today.getDate()-today.getDay());
        cs = formatDateInput(ws); ce = formatDateInput(today);
        var pws = new Date(ws); pws.setDate(pws.getDate()-7);
        var pwe = new Date(pws); pwe.setDate(pwe.getDate()+6);
        ps = formatDateInput(pws); pe = formatDateInput(pwe);
      } else if (compareMode === 'lastMonth') {
        var ms = new Date(today.getFullYear(), today.getMonth(), 1);
        cs = formatDateInput(ms); ce = formatDateInput(today);
        var pms = new Date(today.getFullYear(), today.getMonth()-1, 1);
        var pme = new Date(today.getFullYear(), today.getMonth(), 0);
        ps = formatDateInput(pms); pe = formatDateInput(pme);
      }
      
      if (isAppsScript) {
        // Apps Script mode
        google.script.run.withSuccessHandler(function(r) {
        google.script.run.withSuccessHandler(function(pr) {
          document.getElementById('loadingOverlay').classList.add('hidden');
          showSkeletons(false);
          
          // Only re-render if data actually changed
          var newDataStr = JSON.stringify(r) + JSON.stringify(pr);
          var oldDataStr = (data ? JSON.stringify(data) : '') + (compareData ? JSON.stringify(compareData) : '');
          
          if (newDataStr !== oldDataStr) {
            data = r;
            compareData = pr;
            renderAll();
          }
        }).withFailureHandler(onError).getProductionDashboardData(ps, pe);
      }).withFailureHandler(onError).getProductionDashboardData(cs, ce);
      } else {
        // GitHub Pages mode - use fetch helper
        loadCompareDataFetch(cs, ce, ps, pe);
      }
    }
    
    // Helper for GitHub Pages compare mode
    function loadCompareDataFetch(cs, ce, ps, pe) {
      Promise.all([
        fetch(API_URL + '?action=dashboard&start=' + encodeURIComponent(cs) + '&end=' + encodeURIComponent(ce)).then(function(r) { return r.json(); }),
        fetch(API_URL + '?action=dashboard&start=' + encodeURIComponent(ps) + '&end=' + encodeURIComponent(pe)).then(function(r) { return r.json(); })
      ]).then(function(results) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        showSkeletons(false);
        
        var currentResult = results[0].success ? results[0].data : null;
        var prevResult = results[1].success ? results[1].data : null;
        
        var newDataStr = JSON.stringify(currentResult) + JSON.stringify(prevResult);
        var oldDataStr = (data ? JSON.stringify(data) : '') + (compareData ? JSON.stringify(compareData) : '');
        
        if (newDataStr !== oldDataStr) {
          data = currentResult;
          compareData = prevResult;
          renderAll();
        }
      }).catch(function(error) { onError(error); });
    }

    // Utility functions
    function formatDateInput(d) { 
      var year = d.getFullYear();
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var day = String(d.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }
    function formatDateShort(s) { 
      var parts = s.split('-');
      var d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); 
    }
    function updateClock() {
      var n = new Date();
      document.getElementById('clock').textContent = (n.getHours()%12||12) + ':' + n.getMinutes().toString().padStart(2,'0') + ' ' + (n.getHours()>=12?'PM':'AM');
      document.getElementById('dateDisplay').textContent = n.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    
    // Welcome greeting based on time of day
    function updateWelcome() {
      var h = new Date().getHours();
      var greeting = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
      document.getElementById('welcomeGreeting').textContent = greeting;
      var opts = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
      document.getElementById('welcomeDate').textContent = new Date().toLocaleDateString('en-US', opts);
    }
    
    // Animate number values
    function animateValue(id, start, end, duration) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.add('animate-value');
      var startTime = null;
      var isDecimal = String(end).includes('.') || end % 1 !== 0;
      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        var progress = Math.min((timestamp - startTime) / duration, 1);
        var current = start + (end - start) * progress;
        el.textContent = isDecimal ? current.toFixed(2) : Math.floor(current);
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    
    // ===== SETTINGS PANEL =====
    function toggleSettings() {
      var panel = document.getElementById('settingsPanel');
      var aiChat = document.getElementById('aiChatPanel');

      // Close AI chat if open
      if (aiChat && aiChat.classList.contains('open')) {
        aiChat.classList.remove('open');
      }

      // Refresh widget toggles to reflect current visibility
      renderWidgetToggles();
      renderKPIToggles();

      // Toggle settings
      if (panel) {
        panel.classList.toggle('open');
      }
    }

    function openSettings() {
      // Refresh widget toggles to reflect current visibility
      renderWidgetToggles();
      renderKPIToggles();

      var panel = document.getElementById('settingsPanel');
      if (panel) panel.classList.add('open');
    }

    function closeSettings() {
      var panel = document.getElementById('settingsPanel');
      if (panel) panel.classList.remove('open');
    }

    // ===== AI CHAT PANEL =====
    function toggleAIChat() {
      var panel = document.getElementById('aiChatPanel');
      var settings = document.getElementById('settingsPanel');

      // Close settings if open
      if (settings && settings.classList.contains('open')) {
        settings.classList.remove('open');
      }

      // Toggle AI chat
      if (panel) {
        panel.classList.toggle('open');

        // Auto-focus input when opening
        if (panel.classList.contains('open')) {
          var input = document.getElementById('aiInput');
          if (input) setTimeout(function() { input.focus(); }, 300);
        }
      }
    }

    function sendAIMessage() {
      var input = document.getElementById('aiInput');
      var messagesContainer = document.getElementById('aiMessages');
      if (!input || !messagesContainer) return;

      var message = input.value.trim();
      if (!message) return;

      // Add user message
      var userMsg = document.createElement('div');
      userMsg.className = 'ai-message user';
      userMsg.textContent = message;
      messagesContainer.appendChild(userMsg);

      // Clear input
      input.value = '';

      // Show typing indicator
      var typingDiv = document.createElement('div');
      typingDiv.className = 'ai-typing';
      typingDiv.innerHTML = '<span></span><span></span><span></span>';
      messagesContainer.appendChild(typingDiv);

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Send to backend
      var requestData = {
        message: message,
        context: {
          date: new Date().toISOString(),
          data: data || {}
        }
      };

      // Call API (Apps Script or Web App)
      if (isAppsScript) {
        google.script.run
          .withSuccessHandler(function(response) {
            typingDiv.remove();
            var assistantMsg = document.createElement('div');
            assistantMsg.className = 'ai-message assistant';
            assistantMsg.textContent = response.message || response;
            messagesContainer.appendChild(assistantMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          })
          .withFailureHandler(function(error) {
            typingDiv.remove();
            var errorMsg = document.createElement('div');
            errorMsg.className = 'ai-message assistant';
            errorMsg.textContent = 'Sorry, I\'m having trouble connecting right now. Please try again.';
            messagesContainer.appendChild(errorMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          })
          .handleChatRequest(requestData);
      } else {
        fetch(API_URL + '?action=chat', {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(requestData)
        })
        .then(function(r) { return r.json(); })
        .then(function(response) {
          typingDiv.remove();
          var assistantMsg = document.createElement('div');
          assistantMsg.className = 'ai-message assistant';
          assistantMsg.textContent = response.message || 'I received your message!';
          messagesContainer.appendChild(assistantMsg);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(function(error) {
          typingDiv.remove();
          var errorMsg = document.createElement('div');
          errorMsg.className = 'ai-message assistant';
          errorMsg.textContent = 'Sorry, I\'m having trouble connecting right now. Please try again.';
          messagesContainer.appendChild(errorMsg);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
      }
    }

    // Charts
    function initCharts() {
      // Register datalabels plugin
      Chart.register(ChartDataLabels);

      // Get chart colors based on current theme
      function getChartColors() {
        const theme = document.documentElement.getAttribute('data-theme') || 'light';
        return {
          grid: theme === 'dark' ? 'rgba(168, 181, 169, 0.08)' : 'rgba(102, 137, 113, 0.06)',
          text: theme === 'dark' ? '#a8b5a9' : '#5a6b5f',
          labelBg: theme === 'dark' ? '#252b22' : '#fff',
          // Botanical color gradients
          greenGradient: ['#668971', '#8ba896'],
          goldGradient: ['#e4aa4f', '#f0cb60']
        };
      }

      // Botanical grid configuration (hemp fiber dashed lines)
      var botanicalGrid = {
        color: function() { return getChartColors().grid; },
        borderDash: [3, 3],
        lineWidth: 1,
        drawBorder: false,
        drawTicks: false
      };

      // Botanical scale configuration
      var botanicalScale = {
        grid: botanicalGrid,
        ticks: {
          font: { size: 11, family: 'JetBrains Mono, monospace' },
          color: function() { return getChartColors().text; },
          padding: 8
        }
      };
      
      // Common datalabels config for bar charts
      var barDataLabels = {
        display: function(ctx) { return ctx.dataset.data[ctx.dataIndex] > 0; },
        color: '#fff',
        font: { weight: 'bold', size: 11 },
        anchor: 'center',
        align: 'center',
        formatter: function(value) { return value > 0 ? value.toFixed(1) : ''; }
      };
      
      // Common legend config
      var legendConfig = { display: true, position: 'top', align: 'end', labels: { boxWidth: 12, boxHeight: 12, padding: 12, font: { size: 12, weight: '500' }, usePointStyle: true, pointStyle: 'circle' } };
      
      // Target line dataset (for daily production)
      var targetLineDataset = {
        label: 'Target',
        data: [],
        borderColor: '#c45c4a',
        borderDash: [8, 4],
        borderWidth: 2,
        type: 'line',
        fill: false,
        pointRadius: 0,
        order: 0,
        datalabels: { display: false }
      };
      
      hourlyChart = new Chart(document.getElementById('hourlyChart').getContext('2d'), {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: 'Tops', data: [], backgroundColor: brandColors.green, borderRadius: 4, borderWidth: 0 },
          { label: 'Smalls', data: [], backgroundColor: brandColors.sungrown, borderRadius: 4, borderWidth: 0 }
        ] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: legendConfig, datalabels: barDataLabels },
          scales: {
            x: { grid: { display: false }, ticks: botanicalScale.ticks },
            y: Object.assign({ beginAtZero: true }, botanicalScale)
          }
        }
      });
      
      rateChart = new Chart(document.getElementById('rateChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
          {
            label: 'Rate',
            data: [],
            borderColor: brandColors.green,
            backgroundColor: brandColors.greenLight,
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
            pointBackgroundColor: brandColors.green,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          },
          {
            label: 'Prev',
            data: [],
            borderColor: brandColors.indoor,
            borderDash: [5, 5],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 0,
            hidden: true
          }
        ] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, datalabels: { display: false } },
          scales: {
            y: Object.assign({ beginAtZero: true }, botanicalScale),
            x: { grid: { display: false }, ticks: botanicalScale.ticks }
          }
        }
      });
      
      dailyChart = new Chart(document.getElementById('dailyChart').getContext('2d'), {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: 'Tops', data: [], backgroundColor: brandColors.green, borderRadius: 4, borderWidth: 0 },
          { label: 'Smalls', data: [], backgroundColor: brandColors.sungrown, borderRadius: 4, borderWidth: 0 },
          {
            label: 'Target (' + dailyTarget + ' lbs)',
            data: [],
            borderColor: '#c45c4a',
            borderDash: [8, 4],
            borderWidth: 2,
            type: 'line',
            fill: false,
            pointRadius: 0,
            order: 0,
            tension: 0.4,
            datalabels: { display: false }
          }
        ] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: legendConfig, datalabels: barDataLabels },
          scales: {
            x: { grid: { display: false }, ticks: botanicalScale.ticks },
            y: Object.assign({ beginAtZero: true }, botanicalScale)
          }
        }
      });
      
      dailyRateChart = new Chart(document.getElementById('dailyRateChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
          {
            label: 'Rate',
            data: [],
            borderColor: brandColors.green,
            backgroundColor: brandColors.greenLight,
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
            pointBackgroundColor: brandColors.green,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          },
          {
            label: '7d MA',
            data: [],
            borderColor: brandColors.gold,
            borderDash: [5, 5],
            fill: false,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
            pointBackgroundColor: brandColors.gold,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }
        ] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: legendConfig, datalabels: { display: false } },
          scales: {
            y: Object.assign({ beginAtZero: true }, botanicalScale),
            x: { grid: { display: false }, ticks: botanicalScale.ticks }
          }
        }
      });
      
      // Trimmers on Line chart
      trimmersChart = new Chart(document.getElementById('trimmersChart').getContext('2d'), {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: 'Trimmers', data: [], backgroundColor: brandColors.green, borderRadius: 4, borderWidth: 0, order: 2 },
          {
            label: 'Average',
            data: [],
            borderColor: brandColors.gold,
            borderDash: [6, 4],
            borderWidth: 2,
            type: 'line',
            fill: false,
            pointRadius: 0,
            order: 1,
            tension: 0.4
          }
        ] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: legendConfig,
            datalabels: {
              display: function(ctx) { return ctx.datasetIndex === 0 && ctx.dataset.data[ctx.dataIndex] > 0; },
              color: '#fff',
              font: { weight: 'bold', size: 11 },
              anchor: 'center',
              align: 'center',
              formatter: function(value) { return value > 0 ? Math.round(value) : ''; }
            }
          },
          scales: {
            y: Object.assign({
              beginAtZero: true,
              title: { display: true, text: 'Trimmers', font: { size: 10, family: 'JetBrains Mono, monospace' } }
            }, botanicalScale),
            x: { grid: { display: false }, ticks: botanicalScale.ticks }
          }
        }
      });
    }

    // Data loading
    function loadData() {
      var s = customStartDate || document.getElementById('startDate').value;
      var e = customEndDate || document.getElementById('endDate').value;
      // Only show skeletons on initial load (no existing data)
      if (!data) {
        showSkeletons(true);
      }
      
      if (isAppsScript) {
        // Apps Script mode
        google.script.run.withSuccessHandler(onDataLoaded).withFailureHandler(onError).getProductionDashboardData(s, e);
      } else {
        // GitHub Pages mode - use API
        fetch(API_URL + '?action=dashboard&start=' + encodeURIComponent(s) + '&end=' + encodeURIComponent(e))
          .then(function(response) { return response.json(); })
          .then(function(result) {
            if (result.success && result.data) {
              onDataLoaded(result.data);
            } else {
              onError(result.error || 'Unknown error');
            }
          })
          .catch(function(error) { onError(error); });
      }
    }

    function refreshData() {
      // Just trigger load - no visual feedback until data changes
      if (compareMode) loadCompareData(); else loadData();
    }

    function onDataLoaded(r) {
      document.getElementById('loadingOverlay').classList.add('hidden');
      showSkeletons(false);
      
      // Only re-render if data actually changed
      var newDataStr = JSON.stringify(r);
      var oldDataStr = data ? JSON.stringify(data) : '';
      
      if (newDataStr !== oldDataStr) {
        data = r;
        renderAll();
      }
    }

    function onError(e) {
      console.error(e);
      document.getElementById('loadingOverlay').classList.add('hidden');
      showSkeletons(false);
      showToast('Error loading data: ' + (e.message || e), 'error');
    }

    // Toast notification system
    function showToast(message, type, duration) {
      type = type || 'info';
      duration = duration || 4000;
      var container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(function() {
        toast.classList.add('hiding');
        setTimeout(function() { toast.remove(); }, 300);
      }, duration);
    }

    function showSkeletons(show) {
      // KPI cards
      document.querySelectorAll('.kpi-card').forEach(function(card) {
        if (show) card.classList.add('loading');
        else card.classList.remove('loading');
      });
      // Chart containers
      document.querySelectorAll('.chart-container').forEach(function(c) {
        if (show) {
          c.style.opacity = '0.4';
        } else {
          c.style.opacity = '1';
        }
      });
      // Current production stats
      document.querySelectorAll('.current-stat-value').forEach(function(v) {
        if (show) {
          v.dataset.originalText = v.textContent;
          v.innerHTML = '<span class="skeleton" style="display:inline-block;width:50px;height:24px;border-radius:4px"></span>';
        } else if (v.dataset.originalText) {
          v.textContent = v.dataset.originalText;
        }
      });
      // Integration stat values
      document.querySelectorAll('.integration-stat-value').forEach(function(v) {
        if (show) {
          v.dataset.originalText = v.textContent;
          v.innerHTML = '<span class="skeleton" style="display:inline-block;width:30px;height:14px;border-radius:3px"></span>';
        } else if (v.dataset.originalText) {
          v.textContent = v.dataset.originalText;
        }
      });
      // Strain list
      var strainList = document.getElementById('strainList');
      if (strainList && show) {
        strainList.innerHTML = '<div class="skeleton" style="height:24px;margin-bottom:6px"></div><div class="skeleton" style="height:24px;margin-bottom:6px"></div><div class="skeleton" style="height:24px;margin-bottom:6px"></div><div class="skeleton" style="height:24px"></div>';
      }
      // Tables
      ['perfTable', 'costTable', 'periodTable'].forEach(function(id) {
        var tbl = document.getElementById(id);
        if (tbl && show) {
          tbl.innerHTML = '<div class="skeleton" style="height:20px;margin-bottom:8px"></div><div class="skeleton" style="height:20px;margin-bottom:8px"></div><div class="skeleton" style="height:20px"></div>';
        }
      });
    }

    function renderAll() {
      renderDateDisplay();
      renderKPIs();
      renderCurrentProduction();
      renderCharts();
      renderTrimmersChart();
      renderSparkline();
      renderStrainList();
      renderTables();
      renderIntegrationWidgets();
    }

    function renderDateDisplay() {
      if (!data || !data.dateRange) return;
      var d = document.getElementById('dateRangeDisplay'), s = data.dateRange.start, e = data.dateRange.end;
      if (compareMode) {
        d.innerHTML = 'Comparing <strong>' + document.getElementById('compareCurrent').textContent + '</strong> vs <strong>' + document.getElementById('comparePrevious').textContent + '</strong>';
      } else if (s === e) {
        d.innerHTML = 'Showing data for <strong>' + formatDateShort(s) + '</strong>';
      } else {
        d.innerHTML = 'Showing <strong>' + formatDateShort(s) + '</strong> to <strong>' + formatDateShort(e) + '</strong>';
      }
    }

    function renderKPIs() {
      if (!data || !data.today) return;
      var t = data.today, p = compareData && compareData.today ? compareData.today : null;
      setKPI('totalTops', t.totalTops, p ? p.totalTops : null, 'lbs');
      setKPI('totalSmalls', t.totalSmalls, p ? p.totalSmalls : null, 'lbs');
      setKPI('avgRate', t.avgRate, p ? p.avgRate : null, 'rate');
      setKPI('crew', (t.trimmers||0)+(t.buckers||0), p ? (p.trimmers||0)+(p.buckers||0) : null, 'num');
      document.getElementById('kpiSub_crew').textContent = t.trimmers + ' Trim + ' + t.buckers + ' Buck';
      setKPI('operatorHours', t.totalOperatorHours, p ? p.totalOperatorHours : null, 'hrs');
      setKPI('costPerLb', t.costPerLb, p ? p.costPerLb : null, 'dollar', true);
      setKPI('totalLbs', t.totalLbs, p ? p.totalLbs : null, 'lbs');
      setKPI('maxRate', t.maxRate, p ? p.maxRate : null, 'rate');
      setKPI('trimmerHours', t.totalTrimmerHours, p ? p.totalTrimmerHours : null, 'hrs');
      setKPI('laborCost', t.totalLaborCost, p ? p.totalLaborCost : null, 'dollar', true);
    }

    function setKPI(id, val, prevVal, fmt, invertDelta) {
      var el = document.getElementById('kpi_'+id), cmpEl = document.getElementById('kpiCmp_'+id), deltaEl = document.getElementById('delta_'+id);
      if (!el) return;
      el.innerHTML = formatValue(val, fmt);
      if (prevVal !== null && compareMode) {
        cmpEl.textContent = 'vs ' + formatValuePlain(prevVal, fmt);
        var pct = prevVal !== 0 ? ((val-prevVal)/prevVal*100) : 0;
        var isUp = invertDelta ? pct < 0 : pct > 0;
        if (Math.abs(pct) < 1) { deltaEl.className = 'kpi-delta neutral'; deltaEl.textContent = '~0%'; }
        else if (isUp) { deltaEl.className = 'kpi-delta up'; deltaEl.textContent = ''+Math.abs(pct).toFixed(0)+'%'; }
        else { deltaEl.className = 'kpi-delta down'; deltaEl.textContent = ''+Math.abs(pct).toFixed(0)+'%'; }
      }
    }

    function formatValue(v, fmt) {
      if (fmt==='lbs') return (v||0).toFixed(1)+' <span class="kpi-unit">lbs</span>';
      if (fmt==='rate') return (v||0).toFixed(2);
      if (fmt==='hrs') return (v||0).toFixed(1)+' <span class="kpi-unit">hrs</span>';
      if (fmt==='dollar') return '$'+(v||0).toFixed(2);
      if (fmt==='num') return (v||0).toString();
      return v;
    }

    function formatValuePlain(v, fmt) {
      if (fmt==='lbs') return (v||0).toFixed(1);
      if (fmt==='rate') return (v||0).toFixed(2);
      if (fmt==='hrs') return (v||0).toFixed(1);
      if (fmt==='dollar') return '$'+(v||0).toFixed(2);
      if (fmt==='num') return (v||0).toString();
      return v;
    }

    function renderCurrentProduction() {
      // Prioritize lastCompleted (previous hour) since data is entered at end of each hour
      var d = data ? data.lastCompleted : null;
      if (!d) {
        document.getElementById('currentStrain').textContent = 'No Data';
        document.getElementById('currentTime').textContent = '';
        document.getElementById('statusBadge').className = 'status-badge idle';
        document.getElementById('statusBadge').textContent = 'No Data';
        document.getElementById('currentTops').textContent = '0';
        document.getElementById('currentSmalls').textContent = '0';
        document.getElementById('currentTrimmers').textContent = '0';
        document.getElementById('currentBuckers').textContent = '0';
        document.getElementById('currentRate').textContent = '0.00';
        document.getElementById('currentTotal').textContent = '0';
        return;
      }
      document.getElementById('currentStrain').textContent = d.strain || 'Unknown';
      document.getElementById('currentTime').textContent = d.timeSlot || '';
      document.getElementById('currentTops').textContent = (d.tops||0).toFixed(1);
      document.getElementById('currentSmalls').textContent = (d.smalls||0).toFixed(1);
      document.getElementById('currentTrimmers').textContent = d.trimmers||0;
      document.getElementById('currentBuckers').textContent = d.buckers||0;
      document.getElementById('currentRate').textContent = (d.rate||0).toFixed(2);
      document.getElementById('currentTotal').textContent = ((d.tops||0) + (d.smalls||0)).toFixed(1);
      document.getElementById('statusBadge').className = 'status-badge completed';
      document.getElementById('statusBadge').textContent = 'Last Hour';
    }

    function renderCharts() {
      if (!data) return;
      
      try {
        // Update chart colors for dark mode
        var chartTextColor = darkMode ? '#a8b5a9' : '#5a6b5f';
        var chartGridColor = darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.06)';
        
        [hourlyChart, rateChart, dailyChart, dailyRateChart, trimmersChart].forEach(function(chart) {
          if (chart && chart.options && chart.options.scales) {
            if (chart.options.scales.x) {
              chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
              chart.options.scales.x.ticks.color = chartTextColor;
            }
            if (chart.options.scales.y) {
              chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
              chart.options.scales.y.ticks.color = chartTextColor;
              chart.options.scales.y.grid = chart.options.scales.y.grid || {};
              chart.options.scales.y.grid.color = chartGridColor;
            }
          }
          if (chart && chart.options && chart.options.plugins && chart.options.plugins.legend) {
            chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
            chart.options.plugins.legend.labels.color = chartTextColor;
          }
        });
      } catch(e) { console.error('Chart color update error:', e); }
      
      try {
        if (data.hourly && data.hourly.length > 0 && hourlyChart) {
          hourlyChart.data.labels = data.hourly.map(function(h){return h.label;});
          hourlyChart.data.datasets[0].data = data.hourly.map(function(h){return h.tops;});
          hourlyChart.data.datasets[1].data = data.hourly.map(function(h){return h.smalls;});
          hourlyChart.update();
        }
      } catch(e) { console.error('Hourly chart error:', e); }
      
      try {
        if (data.hourly && data.hourly.length > 0) {
          rateChart.data.labels = data.hourly.map(function(h){return h.label;});
          rateChart.data.datasets[0].data = data.hourly.map(function(h){return h.rate;});
          if (compareMode && compareData && compareData.hourly) {
            rateChart.data.datasets[1].data = compareData.hourly.map(function(h){return h.rate;});
            rateChart.data.datasets[1].hidden = false;
          } else {
            rateChart.data.datasets[1].hidden = true;
          }
          rateChart.update('none');
        }
      } catch(e) { console.error('Rate chart error:', e); }
      
      try {
        if (data.daily && data.daily.length > 0) {
          dailyChart.data.labels = data.daily.map(function(d){return d.label;});
          dailyChart.data.datasets[0].data = data.daily.map(function(d){return d.totalTops;});
          dailyChart.data.datasets[1].data = data.daily.map(function(d){return d.totalSmalls;});
          // Daily target line
          if (dailyChart.data.datasets[2]) {
            dailyChart.data.datasets[2].data = data.daily.map(function(){return dailyTarget;});
            dailyChart.data.datasets[2].label = 'Target (' + dailyTarget + ' lbs)';
          }
          dailyChart.update('none');
        }
      } catch(e) { console.error('Daily chart error:', e); }
      
      try {
        renderEfficiencyChart();
      } catch(e) { console.error('Efficiency chart error:', e); }
    }
    
    // Adaptive Efficiency Chart - switches between hourly/daily based on date range
    function renderEfficiencyChart() {
      if (!data) return;
      
      var numDays = data.daily ? data.daily.length : 0;
      var titleEl = document.getElementById('efficiencyChartTitle');
      var subtitleEl = document.getElementById('efficiencyChartSubtitle');
      
      // Determine chart mode based on date range
      if (numDays <= 1) {
        // SINGLE DAY: Show hourly efficiency (lbs/trimmer per hour)
        titleEl.textContent = 'Hourly Efficiency';
        subtitleEl.textContent = 'lbs/trimmer by hour';
        
        if (!data.hourly || data.hourly.length === 0) {
          dailyRateChart.data.labels = [];
          dailyRateChart.data.datasets[0].data = [];
          dailyRateChart.data.datasets[1].data = [];
          dailyRateChart.update('none');
          return;
        }
        
        var labels = data.hourly.map(function(h) { return h.label; });
        var rates = data.hourly.map(function(h) { return h.rate || 0; });
        
        // Calculate average for reference line
        var validRates = rates.filter(function(r) { return r > 0; });
        var avgRate = validRates.length > 0 ? validRates.reduce(function(a, b) { return a + b; }, 0) / validRates.length : 0;
        var avgLine = rates.map(function() { return avgRate; });
        
        dailyRateChart.data.labels = labels;
        dailyRateChart.data.datasets[0].data = rates;
        dailyRateChart.data.datasets[0].label = 'Rate';
        dailyRateChart.data.datasets[1].data = avgLine;
        dailyRateChart.data.datasets[1].label = 'Avg (' + avgRate.toFixed(2) + ')';
        dailyRateChart.update('none');
        
      } else if (numDays < 7) {
        // 2-6 DAYS: Show daily efficiency without MA (not enough data for meaningful MA)
        titleEl.textContent = 'Daily Efficiency';
        subtitleEl.textContent = 'lbs/trimmer by day';
        
        var rates = data.daily.map(function(d) { return d.avgRate; });
        
        // Calculate average for reference line
        var validRates = rates.filter(function(r) { return r > 0; });
        var avgRate = validRates.length > 0 ? validRates.reduce(function(a, b) { return a + b; }, 0) / validRates.length : 0;
        var avgLine = rates.map(function() { return avgRate; });
        
        dailyRateChart.data.labels = data.daily.map(function(d) { return d.label; });
        dailyRateChart.data.datasets[0].data = rates;
        dailyRateChart.data.datasets[0].label = 'Rate';
        dailyRateChart.data.datasets[1].data = avgLine;
        dailyRateChart.data.datasets[1].label = 'Avg (' + avgRate.toFixed(2) + ')';
        dailyRateChart.update('none');
        
      } else {
        // 7+ DAYS: Show daily efficiency with 7-day moving average
        titleEl.textContent = 'Daily Efficiency';
        subtitleEl.textContent = 'With 7-day MA';
        
        var rates = data.daily.map(function(d) { return d.avgRate; });
        
        dailyRateChart.data.labels = data.daily.map(function(d) { return d.label; });
        dailyRateChart.data.datasets[0].data = rates;
        dailyRateChart.data.datasets[0].label = 'Rate';
        dailyRateChart.data.datasets[1].data = calcMA(rates, 7);
        dailyRateChart.data.datasets[1].label = '7d MA';
        dailyRateChart.update('none');
      }
    }

    function calcMA(arr, p) {
      var r = [];
      for (var i=0; i<arr.length; i++) {
        if (i<p-1) r.push(null);
        else { var s=0; for (var j=i-p+1; j<=i; j++) s+=arr[j]; r.push(s/p); }
      }
      return r;
    }

    function renderTrimmersChart() {
      if (!data) return;
      
      var labels = [];
      var trimmerData = [];
      var isMultiDay = data.daily && data.daily.length > 1;
      
      if (isMultiDay && data.daily && data.daily.length > 0) {
        // Multi-day view: show average trimmers per day
        document.getElementById('trimmersChartSubtitle').textContent = 'By Day (Avg)';
        labels = data.daily.map(function(d) { return d.label; });
        trimmerData = data.daily.map(function(d) { 
          // Use avgTrimmers if available, otherwise calculate
          return d.avgTrimmers || (d.hoursWorked > 0 ? d.trimmerHours / d.hoursWorked : 0); 
        });
      } else if (data.hourly && data.hourly.length > 0) {
        // Single day view: show trimmers by hour
        document.getElementById('trimmersChartSubtitle').textContent = 'By Hour';
        labels = data.hourly.map(function(h) { return h.label; });
        trimmerData = data.hourly.map(function(h) { return h.trimmers || 0; });
      } else {
        return;
      }
      
      // Calculate average for dotted line
      var validData = trimmerData.filter(function(t) { return t > 0; });
      var avg = validData.length > 0 ? validData.reduce(function(a, b) { return a + b; }, 0) / validData.length : 0;
      var avgLine = trimmerData.map(function() { return avg; });
      
      trimmersChart.data.labels = labels;
      trimmersChart.data.datasets[0].data = trimmerData;
      trimmersChart.data.datasets[1].data = avgLine;
      trimmersChart.update('none');
    }

    function renderSparkline() {
      if (!data || !data.today) return;
      document.getElementById('sparkCurrent').textContent = data.today.currentRate > 0 ? data.today.currentRate.toFixed(2) : '';
      document.getElementById('sparkBest').textContent = data.today.maxRate > 0 ? data.today.maxRate.toFixed(2) : '';
      document.getElementById('sparkAvg').textContent = data.today.avgRate > 0 ? data.today.avgRate.toFixed(2) : '';
      var c = document.getElementById('sparklineBars');
      c.innerHTML = '';
      if (!data.hourly) return;
      var rates = data.hourly.filter(function(h){return h.rate>0;}).map(function(h){return h.rate;});
      if (rates.length===0) return;
      var max = Math.max.apply(null, rates), min = Math.min.apply(null, rates), avg = data.today.avgRate, rng = max-min||1;
      data.hourly.forEach(function(h) {
        if (!h.rate || h.rate<=0) return;
        var b = document.createElement('div');
        b.className = 'spark-bar';
        b.style.height = (20+((h.rate-min)/rng)*50)+'%';
        if (h.rate===max) b.classList.add('best');
        else if (h.rate>=avg*1.05) b.classList.add('good');
        else if (h.rate<avg*0.85) b.classList.add('below');
        else b.classList.add('avg');
        b.title = h.label+': '+h.rate.toFixed(2);
        c.appendChild(b);
      });
    }

    function renderStrainList() {
      var c = document.getElementById('strainList');
      if (!data || !data.strains || data.strains.length===0) {
        c.innerHTML = '<div style="color:#8a9a8e;text-align:center;padding:16px;">No strains</div>';
        return;
      }
      c.innerHTML = data.strains.map(function(s) {
        return '<div class="strain-item"><span class="strain-name">'+s.name+'</span><div class="strain-stats"><span class="strain-tops">'+s.tops.toFixed(1)+'</span><span class="strain-smalls">'+s.smalls.toFixed(1)+'</span></div></div>';
      }).join('');
    }

    function renderTables() {
      var t = data && data.today ? data.today : {}, p = compareData && compareData.today ? compareData.today : null, w = data && data.weekly ? data.weekly : {};
      document.getElementById('perfTable').innerHTML = perfRow('Hours Logged', t.hoursWorked, p?p.hoursWorked:null, 'hrs') + perfRow('Trimmer Hrs', t.totalTrimmerHours, p?p.totalTrimmerHours:null, 'num') + perfRow('Lbs/Hour', t.lbsPerHour, p?p.lbsPerHour:null, 'rate');
      document.getElementById('costTable').innerHTML = perfRow('Cost/Top', t.avgCostPerTop, p?p.avgCostPerTop:null, '$') + perfRow('Cost/Small', t.avgCostPerSmall, p?p.avgCostPerSmall:null, '$') + perfRow('Cost/Lb', t.costPerLb, p?p.costPerLb:null, '$');
      document.getElementById('periodLabel').textContent = (w.totalDays||0)+' day summary';
      document.getElementById('periodTable').innerHTML = perfRow('Total Tops', w.totalTops, null, 'lbs') + perfRow('Total Smalls', w.totalSmalls, null, 'lbs') + perfRow('Best Rate', w.bestRate, null, 'rate');
    }

    function perfRow(label, val, prev, fmt) {
      var v = val||0;
      var display;
      if (fmt==='hrs') display = v+' hrs';
      else if (fmt==='rate') display = v.toFixed(2);
      else if (fmt==='num') display = v.toFixed(1);
      else if (fmt==='$') display = '$'+v.toFixed(2);
      else if (fmt==='lbs') display = v.toFixed(1)+' lbs';
      else display = v;
      var prevHtml = '';
      if (prev !== null && compareMode) {
        var pv = prev||0;
        var pDisplay = fmt==='$' ? '$'+pv.toFixed(2) : pv.toFixed(fmt==='rate'?2:1);
        prevHtml = '<span class="perf-prev">('+pDisplay+')</span>';
      }
      return '<div class="perf-row"><span class="perf-label">'+label+'</span><div class="perf-compare"><span class="perf-value">'+display+'</span>'+prevHtml+'</div></div>';
    }

    function renderIntegrationWidgets() {
      // Scoreboard data from production
      if (data && data.today) {
        document.getElementById('scoreboardStatus').textContent = data.current ? 'Active' : 'Idle';
        document.getElementById('scoreboardStatus').className = 'integration-stat-value ' + (data.current ? 'good' : '');
        document.getElementById('scoreboardLbs').textContent = data.today.totalLbs.toFixed(1);
        var target = data.today.trimmers * 1.5 * data.today.hoursWorked;
        var pct = target > 0 ? ((data.today.totalTops / target) * 100).toFixed(0) + '%' : '';
        document.getElementById('scoreboardTarget').textContent = pct;
        document.getElementById('scoreboardTarget').className = 'integration-stat-value ' + (data.today.totalTops >= target ? 'good' : '');
      }
      
      // Kanban data from backend
      if (data && data.kanban) {
        document.getElementById('kanbanTotal').textContent = data.kanban.total;
        document.getElementById('kanbanReorder').textContent = data.kanban.needReorder;
        document.getElementById('kanbanReorder').className = 'integration-stat-value ' + (data.kanban.needReorder > 0 ? 'alert' : 'good');
        document.getElementById('kanbanInStock').textContent = data.kanban.inStock;
        document.getElementById('kanbanInStock').className = 'integration-stat-value good';
      } else {
        document.getElementById('kanbanTotal').textContent = '';
        document.getElementById('kanbanReorder').textContent = '';
        document.getElementById('kanbanInStock').textContent = '';
      }
      
      // Bag Timer data from backend
      if (data && data.bagTimer) {
        document.getElementById('bagsToday').textContent = data.bagTimer.bagsToday;
        document.getElementById('bagsAvgTime').textContent = data.bagTimer.avgTime;
        document.getElementById('bagsVsTarget').textContent = data.bagTimer.vsTarget;
        var avgMin = data.bagTimer.avgMinutes || 0;
        document.getElementById('bagsVsTarget').className = 'integration-stat-value ' + (avgMin > 0 && avgMin <= 45 ? 'good' : (avgMin > 45 ? 'alert' : ''));
      } else {
        document.getElementById('bagsToday').textContent = '';
        document.getElementById('bagsAvgTime').textContent = '';
        document.getElementById('bagsVsTarget').textContent = '';
      }
    }
  </script>

<!-- ========================================== -->
<!-- AI CHAT WIDGET - Rogue Origin Assistant   -->
<!-- ========================================== -->
<style>
  .ai-chat-widget {
    position: static; /* Remove fixed positioning to let panel position itself */
    z-index: 9999;
    font-family: 'Inter', system-ui, sans-serif;
  }
  .ai-chat-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--green);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background 0.2s;
  }
  .ai-chat-toggle:hover {
    transform: scale(1.05);
    background: var(--green-dark);
  }
  .ai-chat-toggle svg {
    width: 28px;
    height: 28px;
    fill: white;
  }
  /* AI chat panel styles moved to main CSS section (line 929) */
  .ai-chat-header {
    background: var(--green);
    color: white;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .ai-chat-header-icon {
    width: 32px;
    height: 32px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  .ai-chat-header-text {
    flex: 1;
  }
  .ai-chat-header-text h3 {
    font-size: 15px;
    font-weight: 600;
    margin: 0;
  }
  .ai-chat-header-text span {
    font-size: 11px;
    opacity: 0.8;
  }
  .ai-voice-mode-toggle {
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 20px;
    padding: 6px 12px;
    color: white;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
  }
  .ai-voice-mode-toggle:hover {
    background: rgba(255,255,255,0.3);
  }
  .ai-voice-mode-toggle.active {
    background: rgba(255,255,255,0.9);
    color: var(--green);
  }
  .ai-voice-mode-toggle .icon {
    font-size: 14px;
  }
  .ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: var(--bg);
  }
  .ai-message {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
  }
  .ai-message.user {
    background: var(--green);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }
  .ai-message.assistant {
    background: var(--bg-card);
    color: var(--text);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border: 1px solid var(--border-light);
  }
  .ai-message.assistant .ai-feedback {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-light);
  }
  .ai-feedback-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--text-muted);
    transition: all 0.2s;
  }
  .ai-feedback-btn:hover {
    border-color: var(--green);
    color: var(--green);
  }
  .ai-feedback-btn.selected {
    background: var(--green);
    border-color: var(--green);
    color: white;
  }
  .ai-feedback-btn.selected-bad {
    background: var(--danger, #c45c4a);
    border-color: var(--danger, #c45c4a);
    color: white;
  }
  .ai-message .data-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
  }
  .ai-message .data-card h4 {
    font-size: 12px;
    color: var(--green);
    margin: 0 0 8px 0;
    font-weight: 600;
  }
  .ai-message .data-card .metric {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 13px;
    border-bottom: 1px solid var(--border-light);
  }
  .ai-message .data-card .metric:last-child { border-bottom: none; }
  .ai-message .data-card .metric-label { color: var(--text-muted); }
  .ai-message .data-card .metric-value { font-weight: 600; color: var(--text); }
  .ai-typing {
    display: flex;
    gap: 4px;
    padding: 12px 14px;
  }
  .ai-typing span {
    width: 8px;
    height: 8px;
    background: var(--text-light);
    border-radius: 50%;
    animation: aiBounce 1.4s infinite ease-in-out;
  }
  .ai-typing span:nth-child(1) { animation-delay: -0.32s; }
  .ai-typing span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes aiBounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }
  .ai-quick-actions {
    padding: 8px 12px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-light);
  }
  .ai-quick-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 5px 10px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-muted);
  }
  .ai-quick-btn:hover {
    background: var(--green);
    color: white;
    border-color: var(--green);
  }
  .ai-chat-input-area {
    padding: 12px;
    background: var(--bg-card);
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: 8px;
  }
  .ai-chat-input {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 10px 14px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
    background: var(--bg);
    color: var(--text);
  }
  .ai-chat-input:focus { border-color: var(--green); }
  .ai-chat-input::placeholder { color: var(--text-light); }
  .ai-chat-send {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--green);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .ai-chat-send:hover { background: var(--green-dark); }
  .ai-chat-send:disabled { background: var(--text-light); cursor: not-allowed; }
  .ai-chat-send svg { width: 16px; height: 16px; fill: white; }

  /* Voice button styles */
  .ai-voice-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--bg);
    border: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 16px;
  }
  .ai-voice-btn:hover { border-color: var(--green); background: var(--bg-card); }
  .ai-voice-btn.listening {
    background: var(--danger);
    border-color: var(--danger);
    animation: pulse-voice 1.5s infinite;
  }
  .ai-voice-btn.not-supported { opacity: 0.4; cursor: not-allowed; }
  @keyframes pulse-voice {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  /* Voice mode toggle in header */
  .ai-chat-header-text { flex: 1; }
  .ai-voice-mode-toggle {
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 20px;
    padding: 6px 12px;
    color: white;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
  }
  .ai-voice-mode-toggle:hover { background: rgba(255,255,255,0.3); }
  .ai-voice-mode-toggle.active {
    background: rgba(255,255,255,0.9);
    color: var(--green);
  }
  .ai-voice-mode-toggle .icon { font-size: 14px; }

  /* Speak button on messages */
  .ai-speak-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 11px;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s;
  }
  .ai-speak-btn:hover { background: var(--bg); border-color: var(--green); color: var(--green); }
  .ai-speak-btn.speaking { background: var(--green); color: white; border-color: var(--green); }

  /* Voice status indicator */
  .ai-voice-status {
    text-align: center;
    font-size: 11px;
    color: var(--text-muted);
    padding: 4px;
    display: none;
  }
  .ai-voice-status.active { display: block; color: var(--danger); }

  /* Mobile improvements */
  @media (max-width: 480px) {
    .ai-chat-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      max-height: 100vh;
      border-radius: 0;
      border: none;
    }
    .ai-chat-toggle { width: 54px; height: 54px; }
    .ai-chat-header { padding: 16px; }
    .ai-chat-header-text h3 { font-size: 16px; }
    .ai-voice-mode-toggle { padding: 8px 14px; }
    .ai-quick-actions { padding: 12px; gap: 8px; }
    .ai-quick-btn { padding: 10px 14px; font-size: 13px; min-height: 44px; }
    .ai-chat-messages { padding: 12px; }
    .ai-chat-input-area { padding: 12px; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
    .ai-chat-input { padding: 14px 16px; font-size: 16px; } /* Prevents iOS zoom */
    .ai-voice-btn { width: 44px; height: 44px; }
    .ai-chat-send { width: 44px; height: 44px; }
  }
</style>

<div class="ai-chat-widget">
  <div class="ai-chat-panel" id="aiChatPanel">
    <div class="ai-chat-header">
      <div class="ai-chat-header-icon"></div>
      <div class="ai-chat-header-text">
        <h3>Rogue Origin Assistant</h3>
        <span>Ask about production, bags, crew</span>
      </div>
      <button class="ai-voice-mode-toggle active" id="aiVoiceModeToggle" onclick="aiToggleVoiceMode()" title="Toggle voice responses">
        <span class="icon"></span>
        <span class="label">Voice</span>
      </button>
    </div>
    <div class="ai-quick-actions">
      <button class="ai-quick-btn" onclick="aiAskQuestion('How are we doing today?')"> Status</button>
      <button class="ai-quick-btn" onclick="aiAskQuestion('How many bags completed?')"> Bags</button>
      <button class="ai-quick-btn" onclick="aiAskQuestion('What is our current rate?')"> Rate</button>
      <button class="ai-quick-btn" onclick="aiAskQuestion('How many people working?')"> Crew</button>
    </div>
    <div class="ai-chat-messages" id="aiMessages">
      <div class="ai-message assistant">
        Hi! I can help with production status, bag counts, crew info, and more. What would you like to know?
      </div>
    </div>
    <div class="ai-voice-status" id="aiVoiceStatus"> Listening...</div>
    <div class="ai-chat-input-area">
      <input type="text" class="ai-chat-input" id="aiInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter')aiSendMessage()" aria-label="Chat input">
      <button class="ai-voice-btn" id="aiVoiceBtn" onclick="aiToggleVoice()" title="Voice input" aria-label="Voice input"></button>
      <button class="ai-chat-send" onclick="aiSendMessage()" aria-label="Send message">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
  <!-- Old ai-chat-toggle button removed - using ai-chat-fab instead -->
</div>

<script>
(function() {
  const AI_API_URL = 'https://script.google.com/macros/s/AKfycbxDAHSFl9cedGS49L3Lf5ztqy-SSToYigyA30ZtsdpmWNAR9H61X_Mm48JOOTGqqr-Z/exec';
  let aiHistory = [];
  let lastQuestion = '';  // Track for feedback

  // ============================================
  // VOICE MODE (Auto-speak responses)
  // ============================================
  // Default to ON - user can toggle off for text-only
  let voiceModeEnabled = localStorage.getItem('ro_voice_mode') !== 'false';

  // Initialize toggle button state on load
  setTimeout(() => {
    const toggle = document.getElementById('aiVoiceModeToggle');
    if (toggle) updateVoiceModeButton(toggle);
  }, 0);

  function updateVoiceModeButton(toggle) {
    if (voiceModeEnabled) {
      toggle.classList.add('active');
      toggle.querySelector('.icon').textContent = '';
      toggle.querySelector('.label').textContent = 'Voice';
      toggle.title = 'Voice mode ON - click to switch to text only';
    } else {
      toggle.classList.remove('active');
      toggle.querySelector('.icon').textContent = '';
      toggle.querySelector('.label').textContent = 'Text';
      toggle.title = 'Text mode - click to enable voice responses';
    }
  }

  window.aiToggleVoiceMode = function() {
    voiceModeEnabled = !voiceModeEnabled;
    localStorage.setItem('ro_voice_mode', voiceModeEnabled ? 'true' : 'false');
    const toggle = document.getElementById('aiVoiceModeToggle');
    if (toggle) updateVoiceModeButton(toggle);
    // Stop any playing audio when switching to text mode
    if (!voiceModeEnabled) {
      if (typeof stopSpeaking === 'function') stopSpeaking();
      if (speechSynthesis.speaking) speechSynthesis.cancel();
    }
  };

  // ============================================
  // VOICE INPUT (Web Speech API)
  // ============================================
  let recognition = null;
  let isListening = false;
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = localStorage.getItem('ro_language') === 'es' ? 'es-ES' : 'en-US';

    recognition.onstart = function() {
      isListening = true;
      const btn = document.getElementById('aiVoiceBtn');
      const status = document.getElementById('aiVoiceStatus');
      if (btn) { btn.classList.add('listening'); btn.textContent = ''; }
      if (status) { status.classList.add('active'); status.textContent = ' Listening... (tap to stop)'; }
    };

    recognition.onend = function() {
      isListening = false;
      const btn = document.getElementById('aiVoiceBtn');
      const status = document.getElementById('aiVoiceStatus');
      if (btn) { btn.classList.remove('listening'); btn.textContent = ''; }
      if (status) status.classList.remove('active');
    };

    recognition.onresult = function(event) {
      const input = document.getElementById('aiInput');
      let finalTranscript = '';
      let interimTranscript = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          finalTranscript += transcript;
        } else {
          interimTranscript += transcript;
        }
      }

      if (finalTranscript) {
        input.value = finalTranscript;
        setTimeout(() => { if (input.value.trim()) aiSendMessage(); }, 300);
      } else if (interimTranscript) {
        input.value = interimTranscript;
      }
    };

    recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      isListening = false;
      const btn = document.getElementById('aiVoiceBtn');
      const status = document.getElementById('aiVoiceStatus');
      if (btn) { btn.classList.remove('listening'); btn.textContent = ''; }
      if (status) { status.classList.remove('active'); }
    };
  } else {
    setTimeout(() => {
      const btn = document.getElementById('aiVoiceBtn');
      if (btn) { btn.classList.add('not-supported'); btn.title = 'Voice input not supported in this browser'; }
    }, 100);
  }

  window.aiToggleVoice = function() {
    if (!recognition) return;
    if (isListening) {
      recognition.stop();
    } else {
      recognition.lang = localStorage.getItem('ro_language') === 'es' ? 'es-ES' : 'en-US';
      recognition.start();
    }
  };

  // ============================================
  // TEXT-TO-SPEECH (Puter.js with OpenAI TTS)
  // ============================================
  let currentAudio = null;
  let isSpeaking = false;

  // Stop any currently playing audio
  function stopSpeaking() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
    isSpeaking = false;
    document.querySelectorAll('.ai-speak-btn.speaking').forEach(btn => {
      btn.classList.remove('speaking');
      btn.textContent = ' Speak';
    });
  }

  window.aiSpeak = async function(contentId, buttonEl) {
    const content = document.getElementById(contentId);
    if (!content) return;

    // If currently speaking this one, stop it
    if (isSpeaking && buttonEl.classList.contains('speaking')) {
      stopSpeaking();
      return;
    }

    // Stop any other audio playing
    stopSpeaking();

    const text = content.textContent || content.innerText;
    if (!text.trim()) return;

    // Show speaking state
    buttonEl.classList.add('speaking');
    buttonEl.textContent = ' Loading...';
    isSpeaking = true;

    try {
      const isSpanish = localStorage.getItem('ro_language') === 'es';

      // Use OpenAI TTS via Puter.js for natural-sounding voice
      // 'nova' is warm and natural, 'alloy' is neutral, 'shimmer' is expressive
      const audio = await puter.ai.txt2speech(text, {
        provider: 'openai',
        model: 'gpt-4o-mini-tts',
        voice: 'nova', // Natural, warm female voice
        response_format: 'mp3',
        instructions: isSpanish
          ? 'Habla en espaol de manera clara y amigable, como un asistente profesional.'
          : 'Speak clearly and warmly, like a friendly professional assistant. Be conversational but concise.'
      });

      currentAudio = audio;
      buttonEl.textContent = ' Stop';

      audio.onended = function() {
        buttonEl.classList.remove('speaking');
        buttonEl.textContent = ' Speak';
        isSpeaking = false;
        currentAudio = null;
      };

      audio.onerror = function() {
        console.error('Audio playback error');
        buttonEl.classList.remove('speaking');
        buttonEl.textContent = ' Speak';
        isSpeaking = false;
        currentAudio = null;
      };

      audio.play();

    } catch (error) {
      console.error('TTS Error:', error);
      buttonEl.classList.remove('speaking');
      buttonEl.textContent = ' Speak';
      isSpeaking = false;

      // Fallback to browser TTS if Puter.js fails
      try {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = localStorage.getItem('ro_language') === 'es' ? 'es-ES' : 'en-US';
        utterance.onend = () => {
          buttonEl.classList.remove('speaking');
          buttonEl.textContent = ' Speak';
        };
        buttonEl.classList.add('speaking');
        buttonEl.textContent = ' Stop';
        speechSynthesis.speak(utterance);
      } catch (fallbackError) {
        console.error('Fallback TTS also failed:', fallbackError);
      }
    }
  };

  window.aiToggleChat = function() {
    stopSpeaking(); // Stop Puter.js audio
    if (speechSynthesis.speaking) speechSynthesis.cancel(); // Stop fallback TTS
    if (isListening && recognition) recognition.stop();

    const panel = document.getElementById('aiChatPanel');
    const chatIcon = document.getElementById('aiChatIcon');
    const closeIcon = document.getElementById('aiCloseIcon');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
      chatIcon.style.display = 'none';
      closeIcon.style.display = 'block';
      document.getElementById('aiInput').focus();
    } else {
      chatIcon.style.display = 'block';
      closeIcon.style.display = 'none';
    }
  };

  window.aiAskQuestion = function(q) {
    document.getElementById('aiInput').value = q;
    aiSendMessage();
  };

  window.aiSendMessage = async function() {
    const input = document.getElementById('aiInput');
    const messages = document.getElementById('aiMessages');
    const msg = input.value.trim();
    if (!msg) return;

    lastQuestion = msg;  // Track for feedback

    // Add user message
    const userEl = document.createElement('div');
    userEl.className = 'ai-message user';
    userEl.textContent = msg;
    messages.appendChild(userEl);
    input.value = '';
    messages.scrollTop = messages.scrollHeight;

    // Typing indicator
    const typingEl = document.createElement('div');
    typingEl.className = 'ai-message assistant';
    typingEl.innerHTML = '<div class="ai-typing"><span></span><span></span><span></span></div>';
    messages.appendChild(typingEl);
    messages.scrollTop = messages.scrollHeight;

    try {
      aiHistory.push({ role: 'user', content: msg });
      
      const payload = JSON.stringify({
        action: 'chat',
        message: msg,
        history: aiHistory.slice(-10)
      });
      
      const response = await fetch(AI_API_URL + '?action=chat', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: payload,
        redirect: 'follow'
      });
      
      const data = await response.json();
      typingEl.remove();
      
      if (data.success && data.response) {
        aiHistory.push({ role: 'assistant', content: data.response });
        const assistEl = document.createElement('div');
        assistEl.className = 'ai-message assistant';

        // Add response content + speak button + feedback buttons
        const responseId = 'resp-' + Date.now();
        assistEl.innerHTML = `
          <div class="ai-response-content" id="content-${responseId}">${data.response}</div>
          <div class="ai-feedback" id="${responseId}">
            <button class="ai-speak-btn" id="speak-${responseId}" onclick="aiSpeak('content-${responseId}', this)" title="Read aloud"> Speak</button>
            <button class="ai-feedback-btn" onclick="aiFeedback('${responseId}', 'good', '${encodeURIComponent(lastQuestion)}')"> Helpful</button>
            <button class="ai-feedback-btn" onclick="aiFeedback('${responseId}', 'bad', '${encodeURIComponent(lastQuestion)}')"> Not quite</button>
          </div>
        `;
        messages.appendChild(assistEl);

        // Auto-speak response if voice mode is enabled
        if (voiceModeEnabled) {
          setTimeout(() => {
            const speakBtn = document.getElementById('speak-' + responseId);
            if (speakBtn) aiSpeak('content-' + responseId, speakBtn);
          }, 100);
        }
      } else {
        throw new Error(data.error || 'Unknown error');
      }
    } catch (err) {
      typingEl.remove();
      const errEl = document.createElement('div');
      errEl.className = 'ai-message assistant';
      errEl.textContent = 'Sorry, something went wrong. ' + (err.message || '');
      messages.appendChild(errEl);
      console.error('AI Error:', err);
    }
    messages.scrollTop = messages.scrollHeight;
  };

  // Feedback handler
  window.aiFeedback = async function(responseId, rating, encodedQuestion) {
    const feedbackDiv = document.getElementById(responseId);
    if (!feedbackDiv) return;
    
    const question = decodeURIComponent(encodedQuestion);
    
    // Update UI
    const buttons = feedbackDiv.querySelectorAll('.ai-feedback-btn');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.5';
    });
    
    const selectedBtn = rating === 'good' ? buttons[0] : buttons[1];
    selectedBtn.classList.add(rating === 'good' ? 'selected' : 'selected-bad');
    selectedBtn.style.opacity = '1';
    
    // If negative feedback, prompt for correction
    if (rating === 'bad') {
      setTimeout(() => {
        feedbackDiv.innerHTML = `
          <span style="font-size:11px;color:var(--text-muted);"> Logged. Want to correct me?</span>
          <button class="ai-feedback-btn" onclick="aiPromptCorrection()">Add correction</button>
        `;
      }, 500);
    } else {
      setTimeout(() => {
        feedbackDiv.innerHTML = '<span style="font-size:11px;color:var(--green);"> Thanks!</span>';
      }, 500);
    }
    
    // Log feedback to server
    try {
      await fetch(AI_API_URL + '?action=chat', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
          feedback: {
            question: question,
            rating: rating,
            timestamp: new Date().toISOString()
          }
        }),
        redirect: 'follow'
      });
    } catch (e) {
      console.log('Feedback logging error:', e);
    }
  };
  
  // Prompt user to add a correction
  window.aiPromptCorrection = function() {
    const input = document.getElementById('aiInput');
    input.value = 'Actually, ';
    input.focus();
    input.setSelectionRange(input.value.length, input.value.length);
  };
})();
</script>

<!-- Floating Action Buttons -->
<button class="settings-fab" onclick="toggleSettings()" title="Settings"></button>
<button class="ai-chat-fab" onclick="toggleAIChat()" title="AI Assistant"></button>

<!-- AI Chat Panel -->
<div class="ai-chat-panel" id="aiChatPanel">
  <div class="ai-chat-header">
    <div class="ai-chat-header-icon"></div>
    <div class="ai-chat-header-text">
      <h3>Rogue Origin Assistant</h3>
      <span>Ask me about production</span>
    </div>
  </div>
  <div class="ai-chat-messages" id="aiMessages">
    <div class="ai-message assistant">
      Hi! I'm your Rogue Origin assistant. Ask me about today's production, crew performance, or any metrics you'd like to know.
    </div>
  </div>
  <div class="ai-chat-input-area">
    <input
      type="text"
      class="ai-chat-input"
      id="aiInput"
      placeholder="Ask about production..."
      onkeypress="if(event.key==='Enter') sendAIMessage()"
    >
    <button class="ai-chat-send" onclick="sendAIMessage()" id="aiSendBtn">
      <span></span>
    </button>
  </div>
</div>

</body>
</html>
